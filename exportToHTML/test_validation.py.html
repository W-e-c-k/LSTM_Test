<html>
<head>
<title>test_validation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_validation.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Tests for input validation functions&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">numbers</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">itertools </span><span class="s2">import </span><span class="s1">product</span>
<span class="s2">from </span><span class="s1">operator </span><span class="s2">import </span><span class="s1">itemgetter</span>
<span class="s2">from </span><span class="s1">tempfile </span><span class="s2">import </span><span class="s1">NamedTemporaryFile</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse </span><span class="s2">as </span><span class="s1">sp</span>
<span class="s2">from </span><span class="s1">pytest </span><span class="s2">import </span><span class="s1">importorskip</span>

<span class="s2">import </span><span class="s1">sklearn</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">_config </span><span class="s2">import </span><span class="s1">config_context</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">_min_dependencies </span><span class="s2">import </span><span class="s1">dependent_packages</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">base </span><span class="s2">import </span><span class="s1">BaseEstimator</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets </span><span class="s2">import </span><span class="s1">make_blobs</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">ensemble </span><span class="s2">import </span><span class="s1">RandomForestRegressor</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">PositiveSpectrumWarning</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">linear_model </span><span class="s2">import </span><span class="s1">ARDRegression</span>

<span class="s4"># TODO: add this estimator into the _mocking module in a further refactoring</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">tests</span><span class="s3">.</span><span class="s1">test_score_objects </span><span class="s2">import </span><span class="s1">EstimatorWithFit</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">neighbors </span><span class="s2">import </span><span class="s1">KNeighborsClassifier</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">random_projection </span><span class="s2">import </span><span class="s1">_sparse_random_matrix</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">svm </span><span class="s2">import </span><span class="s1">SVR</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">_safe_indexing</span><span class="s3">,</span>
    <span class="s1">as_float_array</span><span class="s3">,</span>
    <span class="s1">check_array</span><span class="s3">,</span>
    <span class="s1">check_symmetric</span><span class="s3">,</span>
    <span class="s1">check_X_y</span><span class="s3">,</span>
    <span class="s1">deprecated</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_mocking </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">MockDataFrame</span><span class="s3">,</span>
    <span class="s1">_MockEstimatorOnOffPrediction</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">SkipTest</span><span class="s3">,</span>
    <span class="s1">TempMemmap</span><span class="s3">,</span>
    <span class="s1">_convert_container</span><span class="s3">,</span>
    <span class="s1">assert_allclose</span><span class="s3">,</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">,</span>
    <span class="s1">assert_array_equal</span><span class="s3">,</span>
    <span class="s1">assert_no_warnings</span><span class="s3">,</span>
    <span class="s1">create_memmap_backed_data</span><span class="s3">,</span>
    <span class="s1">ignore_warnings</span><span class="s3">,</span>
    <span class="s1">skip_if_array_api_compat_not_configured</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">estimator_checks </span><span class="s2">import </span><span class="s1">_NotAnArray</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">fixes </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">COO_CONTAINERS</span><span class="s3">,</span>
    <span class="s1">CSC_CONTAINERS</span><span class="s3">,</span>
    <span class="s1">CSR_CONTAINERS</span><span class="s3">,</span>
    <span class="s1">DIA_CONTAINERS</span><span class="s3">,</span>
    <span class="s1">DOK_CONTAINERS</span><span class="s3">,</span>
    <span class="s1">parse_version</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">validation </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">FLOAT_DTYPES</span><span class="s3">,</span>
    <span class="s1">_allclose_dense_sparse</span><span class="s3">,</span>
    <span class="s1">_check_feature_names_in</span><span class="s3">,</span>
    <span class="s1">_check_method_params</span><span class="s3">,</span>
    <span class="s1">_check_psd_eigenvalues</span><span class="s3">,</span>
    <span class="s1">_check_response_method</span><span class="s3">,</span>
    <span class="s1">_check_sample_weight</span><span class="s3">,</span>
    <span class="s1">_check_y</span><span class="s3">,</span>
    <span class="s1">_deprecate_positional_args</span><span class="s3">,</span>
    <span class="s1">_get_feature_names</span><span class="s3">,</span>
    <span class="s1">_is_fitted</span><span class="s3">,</span>
    <span class="s1">_is_pandas_df</span><span class="s3">,</span>
    <span class="s1">_is_polars_df</span><span class="s3">,</span>
    <span class="s1">_num_features</span><span class="s3">,</span>
    <span class="s1">_num_samples</span><span class="s3">,</span>
    <span class="s1">_to_object_array</span><span class="s3">,</span>
    <span class="s1">assert_all_finite</span><span class="s3">,</span>
    <span class="s1">check_consistent_length</span><span class="s3">,</span>
    <span class="s1">check_is_fitted</span><span class="s3">,</span>
    <span class="s1">check_memory</span><span class="s3">,</span>
    <span class="s1">check_non_negative</span><span class="s3">,</span>
    <span class="s1">check_random_state</span><span class="s3">,</span>
    <span class="s1">check_scalar</span><span class="s3">,</span>
    <span class="s1">column_or_1d</span><span class="s3">,</span>
    <span class="s1">has_fit_parameter</span><span class="s3">,</span>
<span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_make_rng</span><span class="s3">():</span>
    <span class="s4"># Check the check_random_state utility function behavior</span>
    <span class="s2">assert </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s2">None</span><span class="s3">) </span><span class="s2">is </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">mtrand</span><span class="s3">.</span><span class="s1">_rand</span>
    <span class="s2">assert </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">) </span><span class="s2">is </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">mtrand</span><span class="s3">.</span><span class="s1">_rand</span>

    <span class="s1">rng_42 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">42</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s5">42</span><span class="s3">).</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">100</span><span class="s3">) == </span><span class="s1">rng_42</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>

    <span class="s1">rng_42 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">42</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s1">rng_42</span><span class="s3">) </span><span class="s2">is </span><span class="s1">rng_42</span>

    <span class="s1">rng_42 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">42</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s5">43</span><span class="s3">).</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">100</span><span class="s3">) != </span><span class="s1">rng_42</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">check_random_state</span><span class="s3">(</span><span class="s6">&quot;some invalid seed&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_as_float_array</span><span class="s3">():</span>
    <span class="s4"># Test function for as_float_array</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">10</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
    <span class="s1">X2 </span><span class="s3">= </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
    <span class="s4"># Another test</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
    <span class="s1">X2 </span><span class="s3">= </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4"># Checking that the array wasn't overwritten</span>
    <span class="s2">assert </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s2">assert </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>
    <span class="s4"># Test int dtypes &lt;= 32bit</span>
    <span class="s1">tested_dtypes </span><span class="s3">= [</span><span class="s1">bool</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">uint8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">uint16</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">uint32</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">tested_dtypes</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>

    <span class="s4"># Test object dtype</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">object</span><span class="s3">)</span>
    <span class="s1">X2 </span><span class="s3">= </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>

    <span class="s4"># Here, X is of the right type, it shouldn't be modified</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">is </span><span class="s1">X</span>
    <span class="s4"># Test that if X is fortran ordered it stays</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asfortranarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfortran</span><span class="s3">(</span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">))</span>

    <span class="s4"># Test the copy parameter with some matrices</span>
    <span class="s1">matrices </span><span class="s3">= [</span>
        <span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)).</span><span class="s1">toarray</span><span class="s3">(),</span>
        <span class="s1">_sparse_random_matrix</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s5">0.10</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">(),</span>
    <span class="s3">]</span>
    <span class="s2">for </span><span class="s1">M </span><span class="s2">in </span><span class="s1">matrices</span><span class="s3">:</span>
        <span class="s1">N </span><span class="s3">= </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">M</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">N</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
        <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">M</span><span class="s3">).</span><span class="s1">any</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;X&quot;</span><span class="s3">, [(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">10</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))), (</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">2</span><span class="s3">).</span><span class="s1">tocsr</span><span class="s3">())])</span>
<span class="s2">def </span><span class="s1">test_as_float_array_nan</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s5">6</span><span class="s3">, </span><span class="s5">1</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
    <span class="s1">X_converted </span><span class="s3">= </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s6">&quot;allow-nan&quot;</span><span class="s3">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">X_converted</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_np_matrix</span><span class="s3">():</span>
    <span class="s4"># Confirm that input validation code does not return np.matrix</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">12</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>

    <span class="s2">assert not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">matrix</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">matrix</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_memmap</span><span class="s3">():</span>
    <span class="s4"># Confirm that input validation code doesn't copy memory mapped arrays</span>

    <span class="s1">asflt </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">as_float_array</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">NamedTemporaryFile</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">=</span><span class="s6">&quot;sklearn-test&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">tmp</span><span class="s3">:</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">memmap</span><span class="s3">(</span><span class="s1">tmp</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">M</span><span class="s3">[:] = </span><span class="s5">0</span>

        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s3">(</span><span class="s1">check_array</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">, </span><span class="s1">asflt</span><span class="s3">):</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">M</span><span class="s3">)</span>
            <span class="s1">X</span><span class="s3">[:] = </span><span class="s5">1</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">M</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">())</span>
            <span class="s1">X</span><span class="s3">[:] = </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">test_ordering</span><span class="s3">():</span>
    <span class="s4"># Check that ordering is enforced correctly by validation utilities.</span>
    <span class="s4"># We need to check each validation utility, because a 'copy' without</span>
    <span class="s4"># 'order=K' will kill the ordering.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">))</span>
    <span class="s2">for </span><span class="s1">A </span><span class="s2">in </span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">copy </span><span class="s2">in </span><span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">):</span>
            <span class="s1">B </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s1">copy</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">B</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
            <span class="s1">B </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s6">&quot;F&quot;</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s1">copy</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">B</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;F_CONTIGUOUS&quot;</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">copy</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s1">A </span><span class="s2">is not </span><span class="s1">B</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[::-</span><span class="s5">1</span><span class="s3">]</span>
    <span class="s2">assert not </span><span class="s1">X</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;value, force_all_finite&quot;</span><span class="s3">, [(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s2">False</span><span class="s3">), (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s6">&quot;allow-nan&quot;</span><span class="s3">), (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)]</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;retype&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">, </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_array_force_all_finite_valid</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">, </span><span class="s1">retype</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">retype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">4</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">float</span><span class="s3">))</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] = </span><span class="s1">value</span>
    <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s1">force_all_finite</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_checked</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;value, input_name, force_all_finite, match_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s6">&quot;Input contains infinity&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">&quot;X&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s6">&quot;Input X contains infinity&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s6">&quot;Input sample_weight contains infinity&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">&quot;X&quot;</span><span class="s3">, </span><span class="s6">&quot;allow-nan&quot;</span><span class="s3">, </span><span class="s6">&quot;Input X contains infinity&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s6">&quot;Input contains NaN&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s6">&quot;X&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s6">&quot;Input X contains NaN&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s6">&quot;y&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s6">&quot;Input y contains NaN&quot;</span><span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">,</span>
            <span class="s6">&quot;&quot;</span><span class="s3">,</span>
            <span class="s6">&quot;allow-inf&quot;</span><span class="s3">,</span>
            <span class="s6">'force_all_finite should be a bool or &quot;allow-nan&quot;'</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s6">&quot;Input contains NaN&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;retype&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">, </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_array_force_all_finiteinvalid</span><span class="s3">(</span>
    <span class="s1">value</span><span class="s3">, </span><span class="s1">input_name</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">, </span><span class="s1">match_msg</span><span class="s3">, </span><span class="s1">retype</span>
<span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">retype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">4</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">))</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] = </span><span class="s1">value</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match_msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">input_name</span><span class="s3">=</span><span class="s1">input_name</span><span class="s3">,</span>
            <span class="s1">force_all_finite</span><span class="s3">=</span><span class="s1">force_all_finite</span><span class="s3">,</span>
            <span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;input_name&quot;</span><span class="s3">, [</span><span class="s6">&quot;X&quot;</span><span class="s3">, </span><span class="s6">&quot;y&quot;</span><span class="s3">, </span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;retype&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">, </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_array_links_to_imputer_doc_only_for_X</span><span class="s3">(</span><span class="s1">input_name</span><span class="s3">, </span><span class="s1">retype</span><span class="s3">):</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">retype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">4</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">))</span>
    <span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">SVR</span><span class="s3">()</span>
    <span class="s1">extended_msg </span><span class="s3">= (</span>
        <span class="s6">f&quot;</span><span class="s2">\n{</span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">} </span><span class="s6">does not accept missing values&quot;</span>
        <span class="s6">&quot; encoded as NaN natively. For supervised learning, you might want&quot;</span>
        <span class="s6">&quot; to consider sklearn.ensemble.HistGradientBoostingClassifier and Regressor&quot;</span>
        <span class="s6">&quot; which accept missing values encoded as NaNs natively.&quot;</span>
        <span class="s6">&quot; Alternatively, it is possible to preprocess the&quot;</span>
        <span class="s6">&quot; data, for instance by using an imputer transformer in a pipeline&quot;</span>
        <span class="s6">&quot; or drop samples with missing values. See&quot;</span>
        <span class="s6">&quot; https://scikit-learn.org/stable/modules/impute.html&quot;</span>
        <span class="s6">&quot; You can find a list of all estimators that handle NaN values&quot;</span>
        <span class="s6">&quot; at the following page:&quot;</span>
        <span class="s6">&quot; https://scikit-learn.org/stable/modules/impute.html&quot;</span>
        <span class="s6">&quot;#estimators-that-handle-nan-values&quot;</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">f&quot;Input </span><span class="s2">{</span><span class="s1">input_name</span><span class="s2">} </span><span class="s6">contains NaN&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">ctx</span><span class="s3">:</span>
        <span class="s1">check_array</span><span class="s3">(</span>
            <span class="s1">data</span><span class="s3">,</span>
            <span class="s1">estimator</span><span class="s3">=</span><span class="s1">estimator</span><span class="s3">,</span>
            <span class="s1">input_name</span><span class="s3">=</span><span class="s1">input_name</span><span class="s3">,</span>
            <span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">input_name </span><span class="s3">== </span><span class="s6">&quot;X&quot;</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">extended_msg </span><span class="s2">in </span><span class="s1">ctx</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">extended_msg </span><span class="s2">not in </span><span class="s1">ctx</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

    <span class="s2">if </span><span class="s1">input_name </span><span class="s3">== </span><span class="s6">&quot;X&quot;</span><span class="s3">:</span>
        <span class="s4"># Veriy that _validate_data is automatically called with the right argument</span>
        <span class="s4"># to generate the same exception:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">f&quot;Input </span><span class="s2">{</span><span class="s1">input_name</span><span class="s2">} </span><span class="s6">contains NaN&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">ctx</span><span class="s3">:</span>
            <span class="s1">SVR</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]))</span>
        <span class="s2">assert </span><span class="s1">extended_msg </span><span class="s2">in </span><span class="s1">ctx</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">test_check_array_force_all_finite_object</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">).</span><span class="s1">T</span>

    <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s6">&quot;allow-nan&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X </span><span class="s2">is </span><span class="s1">X_checked</span>

    <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X </span><span class="s2">is </span><span class="s1">X_checked</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Input contains NaN&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;X, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]]),</span>
            <span class="s6">&quot;Input contains NaN.&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]]),</span>
            <span class="s6">&quot;Input contains NaN.&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]]),</span>
            <span class="s6">&quot;Input contains infinity or a value too large for.*int&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">), </span><span class="s6">&quot;cannot convert float NaN to integer&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;force_all_finite&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_array_force_all_finite_object_unsafe_casting</span><span class="s3">(</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">, </span><span class="s1">force_all_finite</span>
<span class="s3">):</span>
    <span class="s4"># casting a float array containing NaN or inf to int dtype should</span>
    <span class="s4"># raise an error irrespective of the force_all_finite parameter.</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s1">force_all_finite</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_array_series_err_msg</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot; 
    Check that we raise a proper error message when passing a Series and we expect a 
    2-dimensional container. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/27498 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">ser </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;Expected a 2-dimensional container but got </span><span class="s2">{</span><span class="s1">type</span><span class="s3">(</span><span class="s1">ser</span><span class="s3">)</span><span class="s2">} </span><span class="s6">instead.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">ser</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">ignore_warnings</span>
<span class="s2">def </span><span class="s1">test_check_array</span><span class="s3">():</span>
    <span class="s4"># accept_sparse == False</span>
    <span class="s4"># raise error on sparse inputs</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]]</span>
    <span class="s1">X_csr </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">)</span>

    <span class="s4"># ensure_2d=False</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_array</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">== </span><span class="s5">1</span>
    <span class="s4"># ensure_2d=True with 1d array</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Expected 2D array, got 1D array instead&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s4"># ensure_2d=True with scalar array</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Expected 2D array, got scalar array instead&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s4"># ensure_2d=True with 1d sparse array</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">, </span><span class="s6">&quot;csr_array&quot;</span><span class="s3">):</span>
        <span class="s1">sparse_row </span><span class="s3">= </span><span class="s1">next</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)))</span>
        <span class="s2">if </span><span class="s1">sparse_row</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">== </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s4"># In scipy 1.14 and later, sparse row is 1D while it was 2D before.</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Expected 2D input, got&quot;</span><span class="s3">):</span>
                <span class="s1">check_array</span><span class="s3">(</span><span class="s1">sparse_row</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s4"># don't allow ndim &gt; 3</span>
    <span class="s1">X_ndim </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">8</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_ndim</span><span class="s3">)</span>
    <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_ndim</span><span class="s3">, </span><span class="s1">allow_nd</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)  </span><span class="s4"># doesn't raise</span>

    <span class="s4"># dtype and order enforcement.</span>
    <span class="s1">X_C </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">4</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">).</span><span class="s1">copy</span><span class="s3">(</span><span class="s6">&quot;C&quot;</span><span class="s3">)</span>
    <span class="s1">X_F </span><span class="s3">= </span><span class="s1">X_C</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s6">&quot;F&quot;</span><span class="s3">)</span>
    <span class="s1">X_int </span><span class="s3">= </span><span class="s1">X_C</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">)</span>
    <span class="s1">X_float </span><span class="s3">= </span><span class="s1">X_C</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">float</span><span class="s3">)</span>
    <span class="s1">Xs </span><span class="s3">= [</span><span class="s1">X_C</span><span class="s3">, </span><span class="s1">X_F</span><span class="s3">, </span><span class="s1">X_int</span><span class="s3">, </span><span class="s1">X_float</span><span class="s3">]</span>
    <span class="s1">dtypes </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">float</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">, </span><span class="s1">object</span><span class="s3">]</span>
    <span class="s1">orders </span><span class="s3">= [</span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s6">&quot;F&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]</span>
    <span class="s1">copys </span><span class="s3">= [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">order</span><span class="s3">, </span><span class="s1">copy </span><span class="s2">in </span><span class="s1">product</span><span class="s3">(</span><span class="s1">Xs</span><span class="s3">, </span><span class="s1">dtypes</span><span class="s3">, </span><span class="s1">orders</span><span class="s3">, </span><span class="s1">copys</span><span class="s3">):</span>
        <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s1">order</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s1">copy</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">dtype </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">dtype</span>
        <span class="s2">if </span><span class="s1">order </span><span class="s3">== </span><span class="s6">&quot;C&quot;</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
            <span class="s2">assert not </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;F_CONTIGUOUS&quot;</span><span class="s3">]</span>
        <span class="s2">elif </span><span class="s1">order </span><span class="s3">== </span><span class="s6">&quot;F&quot;</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;F_CONTIGUOUS&quot;</span><span class="s3">]</span>
            <span class="s2">assert not </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">copy</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">X </span><span class="s2">is not </span><span class="s1">X_checked</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s4"># doesn't copy if it was already good</span>
            <span class="s2">if </span><span class="s3">(</span>
                <span class="s1">X</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype</span>
                <span class="s2">and </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">] == </span><span class="s1">X</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
                <span class="s2">and </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;F_CONTIGUOUS&quot;</span><span class="s3">] == </span><span class="s1">X</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;F_CONTIGUOUS&quot;</span><span class="s3">]</span>
            <span class="s3">):</span>
                <span class="s2">assert </span><span class="s1">X </span><span class="s2">is </span><span class="s1">X_checked</span>

    <span class="s4"># allowed sparse != None</span>

    <span class="s4"># try different type of sparse format</span>
    <span class="s1">Xs </span><span class="s3">= []</span>
    <span class="s1">Xs</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X_C</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">sparse_container </span><span class="s2">in </span><span class="s1">CSR_CONTAINERS</span>
            <span class="s3">+ </span><span class="s1">CSC_CONTAINERS</span>
            <span class="s3">+ </span><span class="s1">COO_CONTAINERS</span>
            <span class="s3">+ </span><span class="s1">DOK_CONTAINERS</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">Xs</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">([</span><span class="s1">Xs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">), </span><span class="s1">Xs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)])</span>

    <span class="s1">accept_sparses </span><span class="s3">= [[</span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;coo&quot;</span><span class="s3">], [</span><span class="s6">&quot;coo&quot;</span><span class="s3">, </span><span class="s6">&quot;dok&quot;</span><span class="s3">]]</span>
    <span class="s4"># scipy sparse matrices do not support the object dtype so</span>
    <span class="s4"># this dtype is skipped in this loop</span>
    <span class="s1">non_object_dtypes </span><span class="s3">= [</span><span class="s1">dt </span><span class="s2">for </span><span class="s1">dt </span><span class="s2">in </span><span class="s1">dtypes </span><span class="s2">if </span><span class="s1">dt </span><span class="s2">is not </span><span class="s1">object</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">, </span><span class="s1">copy </span><span class="s2">in </span><span class="s1">product</span><span class="s3">(</span>
        <span class="s1">Xs</span><span class="s3">, </span><span class="s1">non_object_dtypes</span><span class="s3">, </span><span class="s1">accept_sparses</span><span class="s3">, </span><span class="s1">copys</span>
    <span class="s3">):</span>
        <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s1">accept_sparse</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s1">copy</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">dtype </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">dtype</span>
        <span class="s2">if </span><span class="s1">X</span><span class="s3">.</span><span class="s1">format </span><span class="s2">in </span><span class="s1">accept_sparse</span><span class="s3">:</span>
            <span class="s4"># no change if allowed</span>
            <span class="s2">assert </span><span class="s1">X</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">format</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s4"># got converted</span>
            <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s1">accept_sparse</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">copy</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">X </span><span class="s2">is not </span><span class="s1">X_checked</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s4"># doesn't copy if it was already good</span>
            <span class="s2">if </span><span class="s1">X</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s2">and </span><span class="s1">X</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">format</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s1">X </span><span class="s2">is </span><span class="s1">X_checked</span>

    <span class="s4"># other input formats</span>
    <span class="s4"># convert lists to arrays</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]])</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s4"># raise on too deep lists</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_ndim</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">())</span>
    <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_ndim</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">(), </span><span class="s1">allow_nd</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)  </span><span class="s4"># doesn't raise</span>

    <span class="s4"># convert weird stuff to arrays</span>
    <span class="s1">X_no_array </span><span class="s3">= </span><span class="s1">_NotAnArray</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_no_array</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;X&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">[[</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">], [</span><span class="s6">&quot;3&quot;</span><span class="s3">, </span><span class="s6">&quot;4&quot;</span><span class="s3">]],</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">], [</span><span class="s6">&quot;3&quot;</span><span class="s3">, </span><span class="s6">&quot;4&quot;</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;U&quot;</span><span class="s3">),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">], [</span><span class="s6">&quot;3&quot;</span><span class="s3">, </span><span class="s6">&quot;4&quot;</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;S&quot;</span><span class="s3">),</span>
        <span class="s3">[[</span><span class="s7">b&quot;1&quot;</span><span class="s3">, </span><span class="s7">b&quot;2&quot;</span><span class="s3">], [</span><span class="s7">b&quot;3&quot;</span><span class="s3">, </span><span class="s7">b&quot;4&quot;</span><span class="s3">]],</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s7">b&quot;1&quot;</span><span class="s3">, </span><span class="s7">b&quot;2&quot;</span><span class="s3">], [</span><span class="s7">b&quot;3&quot;</span><span class="s3">, </span><span class="s7">b&quot;4&quot;</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;V1&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_array_numeric_error</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that check_array errors when it receives an array of bytes/string 
    while a numeric dtype is required.&quot;&quot;&quot;</span>
    <span class="s1">expected_msg </span><span class="s3">= </span><span class="s6">r&quot;dtype='numeric' is not compatible with arrays of bytes/strings&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">expected_msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;numeric&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;pd_dtype&quot;</span><span class="s3">, [</span><span class="s6">&quot;Int8&quot;</span><span class="s3">, </span><span class="s6">&quot;Int16&quot;</span><span class="s3">, </span><span class="s6">&quot;UInt8&quot;</span><span class="s3">, </span><span class="s6">&quot;UInt16&quot;</span><span class="s3">, </span><span class="s6">&quot;Float32&quot;</span><span class="s3">, </span><span class="s6">&quot;Float64&quot;</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;dtype, expected_dtype&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;numeric&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_array_pandas_na_support</span><span class="s3">(</span><span class="s1">pd_dtype</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">expected_dtype</span><span class="s3">):</span>
    <span class="s4"># Test pandas numerical extension arrays with pd.NA</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">pd_dtype </span><span class="s2">in </span><span class="s3">{</span><span class="s6">&quot;Float32&quot;</span><span class="s3">, </span><span class="s6">&quot;Float64&quot;</span><span class="s3">}:</span>
        <span class="s4"># Extension dtypes with Floats was added in 1.2</span>
        <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">, </span><span class="s1">minversion</span><span class="s3">=</span><span class="s6">&quot;1.2&quot;</span><span class="s3">)</span>

    <span class="s1">X_np </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">], [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]]</span>
    <span class="s3">).</span><span class="s1">T</span>

    <span class="s4"># Creates dataframe with numerical extension arrays with pd.NA</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X_np</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">pd_dtype</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">])</span>
    <span class="s4"># column c has no nans</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s6">&quot;c&quot;</span><span class="s3">] = </span><span class="s1">X</span><span class="s3">[</span><span class="s6">&quot;c&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;float&quot;</span><span class="s3">)</span>
    <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s6">&quot;allow-nan&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_checked</span><span class="s3">, </span><span class="s1">X_np</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">expected_dtype</span>

    <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_checked</span><span class="s3">, </span><span class="s1">X_np</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">expected_dtype</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Input contains NaN&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_array_panadas_na_support_series</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check check_array is correct with pd.NA in a series.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X_int64 </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">NA</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;Int64&quot;</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Input contains NaN&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_int64</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">X_out </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_int64</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_out</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">X_out</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>

    <span class="s1">X_out </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span>
        <span class="s1">X_int64</span><span class="s3">, </span><span class="s1">force_all_finite</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
    <span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_out</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">X_out</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>


<span class="s2">def </span><span class="s1">test_check_array_pandas_dtype_casting</span><span class="s3">():</span>
    <span class="s4"># test that data-frames with homogeneous dtype are not upcast</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">9</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">FLOAT_DTYPES</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">({</span><span class="s5">0</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float16</span><span class="s3">})</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">dtypes</span><span class="s3">, (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float16</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">FLOAT_DTYPES</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">({</span><span class="s5">0</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span><span class="s3">})</span>
    <span class="s4"># float16, int16, float32 casts to float32</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">FLOAT_DTYPES</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">({</span><span class="s5">2</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float16</span><span class="s3">})</span>
    <span class="s4"># float16, int16, float16 casts to float32</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">FLOAT_DTYPES</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>

    <span class="s1">X_df </span><span class="s3">= </span><span class="s1">X_df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span>
    <span class="s4"># we're not using upcasting rules for determining</span>
    <span class="s4"># the target type yet, so we cast to the default of float64</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">FLOAT_DTYPES</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>

    <span class="s4"># check that we handle pandas dtypes in a semi-reasonable way</span>
    <span class="s4"># this is actually tricky because we can't really know that this</span>
    <span class="s4"># should be integer ahead of converting it.</span>
    <span class="s1">cat_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;cat_col&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Categorical</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])})</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">cat_df</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">cat_df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">FLOAT_DTYPES</span><span class="s3">).</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>


<span class="s2">def </span><span class="s1">test_check_array_on_mock_dataframe</span><span class="s3">():</span>
    <span class="s1">arr </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">], [</span><span class="s5">0.6</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">], [</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">], [</span><span class="s5">0.7</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">]])</span>
    <span class="s1">mock_df </span><span class="s3">= </span><span class="s1">MockDataFrame</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">)</span>
    <span class="s1">checked_arr </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">mock_df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">checked_arr</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">arr</span><span class="s3">.</span><span class="s1">dtype</span>
    <span class="s1">checked_arr </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">mock_df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">checked_arr</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_array_dtype_stability</span><span class="s3">():</span>
    <span class="s4"># test that lists with ints don't get converted to floats</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">9</span><span class="s3">]]</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s6">&quot;i&quot;</span>
    <span class="s2">assert </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s6">&quot;i&quot;</span>


<span class="s2">def </span><span class="s1">test_check_array_dtype_warning</span><span class="s3">():</span>
    <span class="s1">X_int_list </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">9</span><span class="s3">]]</span>
    <span class="s1">X_float32 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X_int_list</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s1">X_int64 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X_int_list</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
    <span class="s1">X_csr_float32 </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">X_float32</span><span class="s3">)</span>
    <span class="s1">X_csc_float32 </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">(</span><span class="s1">X_float32</span><span class="s3">)</span>
    <span class="s1">X_csc_int32 </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">(</span><span class="s1">X_int64</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
    <span class="s1">integer_data </span><span class="s3">= [</span><span class="s1">X_int64</span><span class="s3">, </span><span class="s1">X_csc_int32</span><span class="s3">]</span>
    <span class="s1">float32_data </span><span class="s3">= [</span><span class="s1">X_float32</span><span class="s3">, </span><span class="s1">X_csr_float32</span><span class="s3">, </span><span class="s1">X_csc_float32</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s1">integer_data</span><span class="s3">:</span>
        <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">assert_no_warnings</span><span class="s3">(</span>
            <span class="s1">check_array</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>

    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s1">float32_data</span><span class="s3">:</span>
        <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">assert_no_warnings</span><span class="s3">(</span>
            <span class="s1">check_array</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">], </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
        <span class="s2">assert </span><span class="s1">X_checked </span><span class="s2">is </span><span class="s1">X</span>

        <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">assert_no_warnings</span><span class="s3">(</span>
            <span class="s1">check_array</span><span class="s3">,</span>
            <span class="s1">X</span><span class="s3">,</span>
            <span class="s1">dtype</span><span class="s3">=[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">],</span>
            <span class="s1">accept_sparse</span><span class="s3">=[</span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;dok&quot;</span><span class="s3">],</span>
            <span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
        <span class="s2">assert </span><span class="s1">X_checked </span><span class="s2">is not </span><span class="s1">X</span>

    <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">assert_no_warnings</span><span class="s3">(</span>
        <span class="s1">check_array</span><span class="s3">,</span>
        <span class="s1">X_csc_float32</span><span class="s3">,</span>
        <span class="s1">dtype</span><span class="s3">=[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">],</span>
        <span class="s1">accept_sparse</span><span class="s3">=[</span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;dok&quot;</span><span class="s3">],</span>
        <span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>
    <span class="s2">assert </span><span class="s1">X_checked </span><span class="s2">is not </span><span class="s1">X_csc_float32</span>
    <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s6">&quot;csr&quot;</span>


<span class="s2">def </span><span class="s1">test_check_array_accept_sparse_type_exception</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]]</span>
    <span class="s1">X_csr </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">invalid_type </span><span class="s3">= </span><span class="s1">SVR</span><span class="s3">()</span>

    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s6">&quot;Sparse data was passed, but dense data is required. &quot;</span>
        <span class="s6">r&quot;Use '.toarray\(\)' to convert to a dense numpy array.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s6">&quot;Parameter 'accept_sparse' should be a string, &quot;</span>
        <span class="s6">&quot;boolean or list of strings. You provided 'accept_sparse=.*'.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s1">invalid_type</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s6">&quot;When providing 'accept_sparse' as a tuple or list, &quot;</span>
        <span class="s6">&quot;it must contain at least one string value.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=[])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=())</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;SVR&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=[</span><span class="s1">invalid_type</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_check_array_accept_sparse_no_exception</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]]</span>
    <span class="s1">X_csr </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s6">&quot;csr&quot;</span><span class="s3">)</span>
    <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=[</span><span class="s6">&quot;csr&quot;</span><span class="s3">])</span>
    <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=(</span><span class="s6">&quot;csr&quot;</span><span class="s3">,))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">params</span><span class="s3">=[</span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;csc&quot;</span><span class="s3">, </span><span class="s6">&quot;coo&quot;</span><span class="s3">, </span><span class="s6">&quot;bsr&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">X_64bit</span><span class="s3">(</span><span class="s1">request</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s1">request</span><span class="s3">.</span><span class="s1">param</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">request</span><span class="s3">.</span><span class="s1">param </span><span class="s3">== </span><span class="s6">&quot;coo&quot;</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;coords&quot;</span><span class="s3">):</span>
            <span class="s4"># for scipy &gt;= 1.13 .coords is a new attribute and is a tuple. The</span>
            <span class="s4"># .col and .row attributes do not seem to be able to change the</span>
            <span class="s4"># dtype, for more details see https://github.com/scipy/scipy/pull/18530/</span>
            <span class="s4"># and https://github.com/scipy/scipy/pull/20003 where .indices was</span>
            <span class="s4"># renamed to .coords</span>
            <span class="s1">X</span><span class="s3">.</span><span class="s1">coords </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;int64&quot;</span><span class="s3">) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">X</span><span class="s3">.</span><span class="s1">coords</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s4"># scipy &lt; 1.13</span>
            <span class="s1">X</span><span class="s3">.</span><span class="s1">row </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">row</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;int64&quot;</span><span class="s3">)</span>
            <span class="s1">X</span><span class="s3">.</span><span class="s1">col </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">col</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;int64&quot;</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">X</span><span class="s3">.</span><span class="s1">indices </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">indices</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;int64&quot;</span><span class="s3">)</span>
        <span class="s1">X</span><span class="s3">.</span><span class="s1">indptr </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;int64&quot;</span><span class="s3">)</span>

    <span class="s2">yield </span><span class="s1">X</span>


<span class="s2">def </span><span class="s1">test_check_array_accept_large_sparse_no_exception</span><span class="s3">(</span><span class="s1">X_64bit</span><span class="s3">):</span>
    <span class="s4"># When large sparse are allowed</span>
    <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_64bit</span><span class="s3">, </span><span class="s1">accept_large_sparse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_array_accept_large_sparse_raise_exception</span><span class="s3">(</span><span class="s1">X_64bit</span><span class="s3">):</span>
    <span class="s4"># When large sparse are not allowed</span>
    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s6">&quot;Only sparse matrices with 32-bit integer indices &quot;</span>
        <span class="s6">&quot;are accepted. Got int64 indices. Please do report&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_64bit</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">accept_large_sparse</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_array_min_samples_and_features_messages</span><span class="s3">():</span>
    <span class="s4"># empty list is considered 2D by default:</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">r&quot;0 feature\(s\) \(shape=\(1, 0\)\) while a minimum of 1 is&quot; &quot; required.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">([[]])</span>

    <span class="s4"># If considered a 1D collection when ensure_2d=False, then the minimum</span>
    <span class="s4"># number of samples will break:</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">r&quot;0 sample\(s\) \(shape=\(0,\)\) while a minimum of 1 is required.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">([], </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s4"># Invalid edge case when checking the default minimum sample of a scalar</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">r&quot;Singleton array array\(42\) cannot be considered a valid&quot; &quot; collection.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s5">42</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s4"># Simulate a model that would need at least 2 samples to be well defined</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">r&quot;1 sample\(s\) \(shape=\(1, 10\)\) while a minimum of 2 is&quot; &quot; required.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_X_y</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">ensure_min_samples</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s4"># The same message is raised if the data has 2 dimensions even if this is</span>
    <span class="s4"># not mandatory</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_X_y</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">ensure_min_samples</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s4"># Simulate a model that would require at least 3 features (e.g. SelectKBest</span>
    <span class="s4"># with k=3)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">10</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">r&quot;2 feature\(s\) \(shape=\(10, 2\)\) while a minimum of 3 is&quot; &quot; required.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_X_y</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">ensure_min_features</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>

    <span class="s4"># Only the feature check is enabled whenever the number of dimensions is 2</span>
    <span class="s4"># even if allow_nd is enabled:</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_X_y</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">ensure_min_features</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">allow_nd</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s4"># Simulate a case where a pipeline stage as trimmed all the features of a</span>
    <span class="s4"># 2D dataset.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s5">0</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">r&quot;0 feature\(s\) \(shape=\(10, 0\)\) while a minimum of 1 is&quot; &quot; required.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_X_y</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s4"># nd-data is not checked for any minimum number of features by default:</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">10</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">28</span><span class="s3">, </span><span class="s5">28</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
    <span class="s1">X_checked</span><span class="s3">, </span><span class="s1">y_checked </span><span class="s3">= </span><span class="s1">check_X_y</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">allow_nd</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_checked</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y_checked</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_array_complex_data_error</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">2j</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">+ </span><span class="s5">4j</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">], [</span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">3j</span><span class="s3">, </span><span class="s5">4 </span><span class="s3">+ </span><span class="s5">5j</span><span class="s3">, </span><span class="s5">6 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">]])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Complex data not supported&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># list of lists</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">2j</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">+ </span><span class="s5">4j</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">], [</span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">3j</span><span class="s3">, </span><span class="s5">4 </span><span class="s3">+ </span><span class="s5">5j</span><span class="s3">, </span><span class="s5">6 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">]]</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Complex data not supported&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># tuple of tuples</span>
    <span class="s1">X </span><span class="s3">= ((</span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">2j</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">+ </span><span class="s5">4j</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">), (</span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">3j</span><span class="s3">, </span><span class="s5">4 </span><span class="s3">+ </span><span class="s5">5j</span><span class="s3">, </span><span class="s5">6 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">))</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Complex data not supported&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># list of np arrays</span>
    <span class="s1">X </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">2j</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">+ </span><span class="s5">4j</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">3j</span><span class="s3">, </span><span class="s5">4 </span><span class="s3">+ </span><span class="s5">5j</span><span class="s3">, </span><span class="s5">6 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">])]</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Complex data not supported&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># tuple of np arrays</span>
    <span class="s1">X </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">2j</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">+ </span><span class="s5">4j</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">3j</span><span class="s3">, </span><span class="s5">4 </span><span class="s3">+ </span><span class="s5">5j</span><span class="s3">, </span><span class="s5">6 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">]))</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Complex data not supported&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># dataframe</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">MockDataFrame</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">2j</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">+ </span><span class="s5">4j</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">], [</span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">3j</span><span class="s3">, </span><span class="s5">4 </span><span class="s3">+ </span><span class="s5">5j</span><span class="s3">, </span><span class="s5">6 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">]]))</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Complex data not supported&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># sparse matrix</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">coo_matrix</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">2j</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Complex data not supported&quot;</span><span class="s3">):</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># target variable does not always go through check_array but should</span>
    <span class="s4"># never accept complex data either.</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1 </span><span class="s3">+ </span><span class="s5">2j</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">+ </span><span class="s5">4j</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">, </span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">3j</span><span class="s3">, </span><span class="s5">4 </span><span class="s3">+ </span><span class="s5">5j</span><span class="s3">, </span><span class="s5">6 </span><span class="s3">+ </span><span class="s5">7j</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Complex data not supported&quot;</span><span class="s3">):</span>
        <span class="s1">_check_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_has_fit_parameter</span><span class="s3">():</span>
    <span class="s2">assert not </span><span class="s1">has_fit_parameter</span><span class="s3">(</span><span class="s1">KNeighborsClassifier</span><span class="s3">, </span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">has_fit_parameter</span><span class="s3">(</span><span class="s1">RandomForestRegressor</span><span class="s3">, </span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">has_fit_parameter</span><span class="s3">(</span><span class="s1">SVR</span><span class="s3">, </span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">has_fit_parameter</span><span class="s3">(</span><span class="s1">SVR</span><span class="s3">(), </span><span class="s6">&quot;sample_weight&quot;</span><span class="s3">)</span>

    <span class="s2">class </span><span class="s1">TestClassWithDeprecatedFitMethod</span><span class="s3">:</span>
        <span class="s3">@</span><span class="s1">deprecated</span><span class="s3">(</span><span class="s6">&quot;Deprecated for the purpose of testing has_fit_parameter&quot;</span><span class="s3">)</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">pass</span>

    <span class="s2">assert </span><span class="s1">has_fit_parameter</span><span class="s3">(</span>
        <span class="s1">TestClassWithDeprecatedFitMethod</span><span class="s3">, </span><span class="s6">&quot;sample_weight&quot;</span>
    <span class="s3">), </span><span class="s6">&quot;has_fit_parameter fails for class with deprecated fit method.&quot;</span>


<span class="s2">def </span><span class="s1">test_check_symmetric</span><span class="s3">():</span>
    <span class="s1">arr_sym </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>
    <span class="s1">arr_bad </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">arr_asym </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>

    <span class="s1">test_arrays </span><span class="s3">= {</span>
        <span class="s6">&quot;dense&quot;</span><span class="s3">: </span><span class="s1">arr_asym</span><span class="s3">,</span>
        <span class="s6">&quot;dok&quot;</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">dok_matrix</span><span class="s3">(</span><span class="s1">arr_asym</span><span class="s3">),</span>
        <span class="s6">&quot;csr&quot;</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">arr_asym</span><span class="s3">),</span>
        <span class="s6">&quot;csc&quot;</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">(</span><span class="s1">arr_asym</span><span class="s3">),</span>
        <span class="s6">&quot;coo&quot;</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">coo_matrix</span><span class="s3">(</span><span class="s1">arr_asym</span><span class="s3">),</span>
        <span class="s6">&quot;lil&quot;</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">lil_matrix</span><span class="s3">(</span><span class="s1">arr_asym</span><span class="s3">),</span>
        <span class="s6">&quot;bsr&quot;</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">bsr_matrix</span><span class="s3">(</span><span class="s1">arr_asym</span><span class="s3">),</span>
    <span class="s3">}</span>

    <span class="s4"># check error for bad inputs</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">check_symmetric</span><span class="s3">(</span><span class="s1">arr_bad</span><span class="s3">)</span>

    <span class="s4"># check that asymmetric arrays are properly symmetrized</span>
    <span class="s2">for </span><span class="s1">arr_format</span><span class="s3">, </span><span class="s1">arr </span><span class="s2">in </span><span class="s1">test_arrays</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s4"># Check for warnings and errors</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">):</span>
            <span class="s1">check_symmetric</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">check_symmetric</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">raise_exception</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">output </span><span class="s3">= </span><span class="s1">check_symmetric</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">raise_warning</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">output</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">output</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s1">arr_format</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">output</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">arr_sym</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">output</span><span class="s3">, </span><span class="s1">arr_sym</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_is_fitted_with_is_fitted</span><span class="s3">():</span>
    <span class="s2">class </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_is_fitted </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">return </span><span class="s1">self</span>

        <span class="s2">def </span><span class="s1">__sklearn_is_fitted__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s6">&quot;_is_fitted&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_fitted</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">Estimator</span><span class="s3">())</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">Estimator</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_check_is_fitted</span><span class="s3">():</span>
    <span class="s4"># Check is TypeError raised when non estimator instance passed</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">ARDRegression</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s6">&quot;SVR&quot;</span><span class="s3">)</span>

    <span class="s1">ard </span><span class="s3">= </span><span class="s1">ARDRegression</span><span class="s3">()</span>
    <span class="s1">svr </span><span class="s3">= </span><span class="s1">SVR</span><span class="s3">()</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
            <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">ard</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
            <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">svr</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
        <span class="s2">assert False</span><span class="s3">, </span><span class="s6">&quot;check_is_fitted failed with ValueError&quot;</span>

    <span class="s4"># NotFittedError is a subclass of both ValueError and AttributeError</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Random message %(name)s, %(name)s&quot;</span>
    <span class="s1">match </span><span class="s3">= </span><span class="s6">&quot;Random message ARDRegression, ARDRegression&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">ard</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Another message %(name)s, %(name)s&quot;</span>
    <span class="s1">match </span><span class="s3">= </span><span class="s6">&quot;Another message SVR, SVR&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">svr</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s1">ard</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(*</span><span class="s1">make_blobs</span><span class="s3">())</span>
    <span class="s1">svr</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(*</span><span class="s1">make_blobs</span><span class="s3">())</span>

    <span class="s2">assert </span><span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">ard</span><span class="s3">) </span><span class="s2">is None</span>
    <span class="s2">assert </span><span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">svr</span><span class="s3">) </span><span class="s2">is None</span>


<span class="s2">def </span><span class="s1">test_check_is_fitted_attributes</span><span class="s3">():</span>
    <span class="s2">class </span><span class="s1">MyEstimator</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;not fitted&quot;</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">MyEstimator</span><span class="s3">()</span>

    <span class="s2">assert not </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">])</span>
    <span class="s2">assert not </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">all</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">all</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">any</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">any</span><span class="s3">)</span>

    <span class="s1">est</span><span class="s3">.</span><span class="s1">a_ </span><span class="s3">= </span><span class="s6">&quot;a&quot;</span>
    <span class="s2">assert not </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">])</span>
    <span class="s2">assert not </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">all</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">all</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">any</span><span class="s3">)</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">any</span><span class="s3">)</span>

    <span class="s1">est</span><span class="s3">.</span><span class="s1">b_ </span><span class="s3">= </span><span class="s6">&quot;b&quot;</span>
    <span class="s2">assert </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">])</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">all</span><span class="s3">)</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">all</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">any</span><span class="s3">)</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">attributes</span><span class="s3">=[</span><span class="s6">&quot;a_&quot;</span><span class="s3">, </span><span class="s6">&quot;b_&quot;</span><span class="s3">], </span><span class="s1">all_or_any</span><span class="s3">=</span><span class="s1">any</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;wrap&quot;</span><span class="s3">, [</span><span class="s1">itemgetter</span><span class="s3">(</span><span class="s5">0</span><span class="s3">), </span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">], </span><span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;single&quot;</span><span class="s3">, </span><span class="s6">&quot;list&quot;</span><span class="s3">, </span><span class="s6">&quot;tuple&quot;</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_is_fitted_with_attributes</span><span class="s3">(</span><span class="s1">wrap</span><span class="s3">):</span>
    <span class="s1">ard </span><span class="s3">= </span><span class="s1">ARDRegression</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;is not fitted yet&quot;</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">ard</span><span class="s3">, </span><span class="s1">wrap</span><span class="s3">([</span><span class="s6">&quot;coef_&quot;</span><span class="s3">]))</span>

    <span class="s1">ard</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(*</span><span class="s1">make_blobs</span><span class="s3">())</span>

    <span class="s4"># Does not raise</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">ard</span><span class="s3">, </span><span class="s1">wrap</span><span class="s3">([</span><span class="s6">&quot;coef_&quot;</span><span class="s3">]))</span>

    <span class="s4"># Raises when using attribute that is not defined</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;is not fitted yet&quot;</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">ard</span><span class="s3">, </span><span class="s1">wrap</span><span class="s3">([</span><span class="s6">&quot;coef_bad_&quot;</span><span class="s3">]))</span>


<span class="s2">def </span><span class="s1">test_check_consistent_length</span><span class="s3">():</span>
    <span class="s1">check_consistent_length</span><span class="s3">([</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">])</span>
    <span class="s1">check_consistent_length</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]]], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">])</span>
    <span class="s1">check_consistent_length</span><span class="s3">([</span><span class="s5">1</span><span class="s3">], (</span><span class="s5">2</span><span class="s3">,), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">3</span><span class="s3">]), </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">((</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)))</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;inconsistent numbers of samples&quot;</span><span class="s3">):</span>
        <span class="s1">check_consistent_length</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;got &lt;\w+ 'int'&gt;&quot;</span><span class="s3">):</span>
        <span class="s1">check_consistent_length</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;got &lt;\w+ 'object'&gt;&quot;</span><span class="s3">):</span>
        <span class="s1">check_consistent_length</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">object</span><span class="s3">())</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
        <span class="s1">check_consistent_length</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">))</span>

    <span class="s4"># Despite ensembles having __len__ they must raise TypeError</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Expected sequence or array-like&quot;</span><span class="s3">):</span>
        <span class="s1">check_consistent_length</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">RandomForestRegressor</span><span class="s3">())</span>
    <span class="s4"># XXX: We should have a test with a string, but what is correct behaviour?</span>


<span class="s2">def </span><span class="s1">test_check_dataframe_fit_attribute</span><span class="s3">():</span>
    <span class="s4"># check pandas dataframe with 'fit' column does not raise error</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/8415</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>

        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">9</span><span class="s3">]])</span>
        <span class="s1">X_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;fit&quot;</span><span class="s3">])</span>
        <span class="s1">check_consistent_length</span><span class="s3">(</span><span class="s1">X_df</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">SkipTest</span><span class="s3">(</span><span class="s6">&quot;Pandas not found&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_suppress_validation</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">assert_all_finite</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">sklearn</span><span class="s3">.</span><span class="s1">set_config</span><span class="s3">(</span><span class="s1">assume_finite</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">assert_all_finite</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">sklearn</span><span class="s3">.</span><span class="s1">set_config</span><span class="s3">(</span><span class="s1">assume_finite</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">assert_all_finite</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_array_series</span><span class="s3">():</span>
    <span class="s4"># regression test that check_array works on pandas Series</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]), </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]))</span>

    <span class="s4"># with categorical dtype (not a numpy dtype) (GH12699)</span>
    <span class="s1">s </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">]).</span><span class="s1">astype</span><span class="s3">(</span><span class="s6">&quot;category&quot;</span><span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;dtype&quot;</span><span class="s3">, ((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s6">&quot;numeric&quot;</span><span class="s3">)</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;bool_dtype&quot;</span><span class="s3">, (</span><span class="s6">&quot;bool&quot;</span><span class="s3">, </span><span class="s6">&quot;boolean&quot;</span><span class="s3">))</span>
<span class="s2">def </span><span class="s1">test_check_dataframe_mixed_float_dtypes</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">bool_dtype</span><span class="s3">):</span>
    <span class="s4"># pandas dataframe will coerce a boolean into a object, this is a mismatch</span>
    <span class="s4"># with np.result_type which will return a float</span>
    <span class="s4"># check_array needs to explicitly check for bool dtype in a dataframe for</span>
    <span class="s4"># this situation</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/15787</span>

    <span class="s2">if </span><span class="s1">bool_dtype </span><span class="s3">== </span><span class="s6">&quot;boolean&quot;</span><span class="s3">:</span>
        <span class="s4"># boolean extension arrays was introduced in 1.0</span>
        <span class="s1">pd </span><span class="s3">= </span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">, </span><span class="s1">minversion</span><span class="s3">=</span><span class="s6">&quot;1.0&quot;</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">pd </span><span class="s3">= </span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s6">&quot;int&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s6">&quot;float&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">2.1</span><span class="s3">],</span>
            <span class="s6">&quot;bool&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool_dtype</span><span class="s3">),</span>
        <span class="s3">},</span>
        <span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;int&quot;</span><span class="s3">, </span><span class="s6">&quot;float&quot;</span><span class="s3">, </span><span class="s6">&quot;bool&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>

    <span class="s1">array </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">array</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>
    <span class="s1">expected_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">], [</span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">], [</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2.1</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span>
    <span class="s3">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">array</span><span class="s3">, </span><span class="s1">expected_array</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_dataframe_with_only_bool</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that dataframe with bool return a boolean arrays.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;bool&quot;</span><span class="s3">: [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]})</span>

    <span class="s1">array </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">array</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">bool_</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">array</span><span class="s3">, [[</span><span class="s2">True</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">], [</span><span class="s2">True</span><span class="s3">]])</span>

    <span class="s4"># common dtype is int for bool + int</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span><span class="s6">&quot;bool&quot;</span><span class="s3">: [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">], </span><span class="s6">&quot;int&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]},</span>
        <span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;bool&quot;</span><span class="s3">, </span><span class="s6">&quot;int&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s1">array </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;numeric&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">array</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">array</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]])</span>


<span class="s2">def </span><span class="s1">test_check_dataframe_with_only_boolean</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that dataframe with boolean return a float array with dtype=None&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">, </span><span class="s1">minversion</span><span class="s3">=</span><span class="s6">&quot;1.0&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;bool&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;boolean&quot;</span><span class="s3">)})</span>

    <span class="s1">array </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">array</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">array</span><span class="s3">, [[</span><span class="s2">True</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">], [</span><span class="s2">True</span><span class="s3">]])</span>


<span class="s2">class </span><span class="s1">DummyMemory</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">cache</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">func</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">func</span>


<span class="s2">class </span><span class="s1">WrongDummyMemory</span><span class="s3">:</span>
    <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">test_check_memory</span><span class="s3">():</span>
    <span class="s1">memory </span><span class="s3">= </span><span class="s1">check_memory</span><span class="s3">(</span><span class="s6">&quot;cache_directory&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">memory</span><span class="s3">.</span><span class="s1">location </span><span class="s3">== </span><span class="s6">&quot;cache_directory&quot;</span>

    <span class="s1">memory </span><span class="s3">= </span><span class="s1">check_memory</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">memory</span><span class="s3">.</span><span class="s1">location </span><span class="s2">is None</span>

    <span class="s1">dummy </span><span class="s3">= </span><span class="s1">DummyMemory</span><span class="s3">()</span>
    <span class="s1">memory </span><span class="s3">= </span><span class="s1">check_memory</span><span class="s3">(</span><span class="s1">dummy</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">memory </span><span class="s2">is </span><span class="s1">dummy</span>

    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s6">&quot;'memory' should be None, a string or have the same interface as&quot;</span>
        <span class="s6">&quot; joblib.Memory. Got memory='1' instead.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_memory</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">dummy </span><span class="s3">= </span><span class="s1">WrongDummyMemory</span><span class="s3">()</span>
    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s6">&quot;'memory' should be None, a string or have the same interface as&quot;</span>
        <span class="s6">&quot; joblib.Memory. Got memory='{}' instead.&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">dummy</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_memory</span><span class="s3">(</span><span class="s1">dummy</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;copy&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_array_memmap</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">))</span>
    <span class="s2">with </span><span class="s1">TempMemmap</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mmap_mode</span><span class="s3">=</span><span class="s6">&quot;r&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">X_memmap</span><span class="s3">:</span>
        <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_memmap</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s1">copy</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">may_share_memory</span><span class="s3">(</span><span class="s1">X_memmap</span><span class="s3">, </span><span class="s1">X_checked</span><span class="s3">) == (</span><span class="s2">not </span><span class="s1">copy</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;WRITEABLE&quot;</span><span class="s3">] == </span><span class="s1">copy</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;retype&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">,</span>
        <span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">,</span>
        <span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">,</span>
        <span class="s1">sp</span><span class="s3">.</span><span class="s1">coo_matrix</span><span class="s3">,</span>
        <span class="s1">sp</span><span class="s3">.</span><span class="s1">lil_matrix</span><span class="s3">,</span>
        <span class="s1">sp</span><span class="s3">.</span><span class="s1">bsr_matrix</span><span class="s3">,</span>
        <span class="s1">sp</span><span class="s3">.</span><span class="s1">dok_matrix</span><span class="s3">,</span>
        <span class="s1">sp</span><span class="s3">.</span><span class="s1">dia_matrix</span><span class="s3">,</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_non_negative</span><span class="s3">(</span><span class="s1">retype</span><span class="s3">):</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">retype</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
    <span class="s1">check_non_negative</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">retype</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>
    <span class="s1">check_non_negative</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">)</span>

    <span class="s1">A</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] = -</span><span class="s5">1</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">retype</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Negative &quot;</span><span class="s3">):</span>
        <span class="s1">check_non_negative</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_X_y_informative_error</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;estimator requires y to be passed, but the target y is None&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_X_y</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;RandomForestRegressor requires y to be passed, but the target y is None&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_X_y</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">estimator</span><span class="s3">=</span><span class="s1">RandomForestRegressor</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_retrieve_samples_from_non_standard_shape</span><span class="s3">():</span>
    <span class="s2">class </span><span class="s1">TestNonNumericShape</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">= (</span><span class="s6">&quot;not numeric&quot;</span><span class="s3">,)</span>

        <span class="s2">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">len</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">TestNonNumericShape</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># check that it gives a good error if there's no __len__</span>
    <span class="s2">class </span><span class="s1">TestNoLenWeirdShape</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">= (</span><span class="s6">&quot;not numeric&quot;</span><span class="s3">,)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Expected sequence or array-like&quot;</span><span class="s3">):</span>
        <span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">TestNoLenWeirdShape</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;x&quot;</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_scalar_valid</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that check_scalar returns no error/warning if valid inputs are 
    provided&quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s6">&quot;error&quot;</span><span class="s3">)</span>
        <span class="s1">scalar </span><span class="s3">= </span><span class="s1">check_scalar</span><span class="s3">(</span>
            <span class="s1">x</span><span class="s3">,</span>
            <span class="s6">&quot;test_name&quot;</span><span class="s3">,</span>
            <span class="s1">target_type</span><span class="s3">=</span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">Real</span><span class="s3">,</span>
            <span class="s1">min_val</span><span class="s3">=</span><span class="s5">2</span><span class="s3">,</span>
            <span class="s1">max_val</span><span class="s3">=</span><span class="s5">5</span><span class="s3">,</span>
            <span class="s1">include_boundaries</span><span class="s3">=</span><span class="s6">&quot;both&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">scalar </span><span class="s3">== </span><span class="s1">x</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;x, target_name, target_type, min_val, max_val, include_boundaries, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s5">1</span><span class="s3">,</span>
            <span class="s6">&quot;test_name1&quot;</span><span class="s3">,</span>
            <span class="s1">float</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;neither&quot;</span><span class="s3">,</span>
            <span class="s1">TypeError</span><span class="s3">(</span><span class="s6">&quot;test_name1 must be an instance of float, not int.&quot;</span><span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s6">&quot;test_name1&quot;</span><span class="s3">,</span>
            <span class="s1">numbers</span><span class="s3">.</span><span class="s1">Real</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;neither&quot;</span><span class="s3">,</span>
            <span class="s1">TypeError</span><span class="s3">(</span><span class="s6">&quot;test_name1 must be an instance of float, not NoneType.&quot;</span><span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s6">&quot;test_name1&quot;</span><span class="s3">,</span>
            <span class="s1">numbers</span><span class="s3">.</span><span class="s1">Integral</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;neither&quot;</span><span class="s3">,</span>
            <span class="s1">TypeError</span><span class="s3">(</span><span class="s6">&quot;test_name1 must be an instance of int, not NoneType.&quot;</span><span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">1</span><span class="s3">,</span>
            <span class="s6">&quot;test_name1&quot;</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">float</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">),</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;neither&quot;</span><span class="s3">,</span>
            <span class="s1">TypeError</span><span class="s3">(</span><span class="s6">&quot;test_name1 must be an instance of {float, bool}, not int.&quot;</span><span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">1</span><span class="s3">,</span>
            <span class="s6">&quot;test_name2&quot;</span><span class="s3">,</span>
            <span class="s1">int</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;neither&quot;</span><span class="s3">,</span>
            <span class="s1">ValueError</span><span class="s3">(</span><span class="s6">&quot;test_name2 == 1, must be &gt; 2.&quot;</span><span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">5</span><span class="s3">,</span>
            <span class="s6">&quot;test_name3&quot;</span><span class="s3">,</span>
            <span class="s1">int</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;neither&quot;</span><span class="s3">,</span>
            <span class="s1">ValueError</span><span class="s3">(</span><span class="s6">&quot;test_name3 == 5, must be &lt; 4.&quot;</span><span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s6">&quot;test_name4&quot;</span><span class="s3">,</span>
            <span class="s1">int</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;right&quot;</span><span class="s3">,</span>
            <span class="s1">ValueError</span><span class="s3">(</span><span class="s6">&quot;test_name4 == 2, must be &gt; 2.&quot;</span><span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;test_name5&quot;</span><span class="s3">,</span>
            <span class="s1">int</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;left&quot;</span><span class="s3">,</span>
            <span class="s1">ValueError</span><span class="s3">(</span><span class="s6">&quot;test_name5 == 4, must be &lt; 4.&quot;</span><span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;test_name6&quot;</span><span class="s3">,</span>
            <span class="s1">int</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;bad parameter value&quot;</span><span class="s3">,</span>
            <span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s6">&quot;Unknown value for `include_boundaries`: 'bad parameter value'. &quot;</span>
                <span class="s6">&quot;Possible values are: ('left', 'right', 'both', 'neither').&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;test_name7&quot;</span><span class="s3">,</span>
            <span class="s1">int</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;left&quot;</span><span class="s3">,</span>
            <span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s6">&quot;`include_boundaries`='left' without specifying explicitly `min_val` &quot;</span>
                <span class="s6">&quot;is inconsistent.&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s5">4</span><span class="s3">,</span>
            <span class="s6">&quot;test_name8&quot;</span><span class="s3">,</span>
            <span class="s1">int</span><span class="s3">,</span>
            <span class="s5">2</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s6">&quot;right&quot;</span><span class="s3">,</span>
            <span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s6">&quot;`include_boundaries`='right' without specifying explicitly `max_val` &quot;</span>
                <span class="s6">&quot;is inconsistent.&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_scalar_invalid</span><span class="s3">(</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">target_name</span><span class="s3">, </span><span class="s1">target_type</span><span class="s3">, </span><span class="s1">min_val</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">, </span><span class="s1">include_boundaries</span><span class="s3">, </span><span class="s1">err_msg</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that check_scalar returns the right error if a wrong input is 
    given&quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">) </span><span class="s2">as </span><span class="s1">raised_error</span><span class="s3">:</span>
        <span class="s1">check_scalar</span><span class="s3">(</span>
            <span class="s1">x</span><span class="s3">,</span>
            <span class="s1">target_name</span><span class="s3">,</span>
            <span class="s1">target_type</span><span class="s3">=</span><span class="s1">target_type</span><span class="s3">,</span>
            <span class="s1">min_val</span><span class="s3">=</span><span class="s1">min_val</span><span class="s3">,</span>
            <span class="s1">max_val</span><span class="s3">=</span><span class="s1">max_val</span><span class="s3">,</span>
            <span class="s1">include_boundaries</span><span class="s3">=</span><span class="s1">include_boundaries</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">str</span><span class="s3">(</span><span class="s1">raised_error</span><span class="s3">.</span><span class="s1">value</span><span class="s3">) == </span><span class="s1">str</span><span class="s3">(</span><span class="s1">err_msg</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">raised_error</span><span class="s3">.</span><span class="s1">value</span><span class="s3">, </span><span class="s1">type</span><span class="s3">(</span><span class="s1">err_msg</span><span class="s3">))</span>


<span class="s1">_psd_cases_valid </span><span class="s3">= {</span>
    <span class="s6">&quot;nominal&quot;</span><span class="s3">: ((</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]), </span><span class="s2">None</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;nominal_np_array&quot;</span><span class="s3">: (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]), </span><span class="s2">None</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;insignificant_imag&quot;</span><span class="s3">: (</span>
        <span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5e-5j</span><span class="s3">),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]),</span>
        <span class="s1">PositiveSpectrumWarning</span><span class="s3">,</span>
        <span class="s6">&quot;There are imaginary parts in eigenvalues </span><span class="s2">\\</span><span class="s6">(1e</span><span class="s2">\\</span><span class="s6">-05 of the maximum real part&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
    <span class="s6">&quot;insignificant neg&quot;</span><span class="s3">: ((</span><span class="s5">5</span><span class="s3">, -</span><span class="s5">5e-5</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]), </span><span class="s1">PositiveSpectrumWarning</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;insignificant neg float32&quot;</span><span class="s3">: (</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1e-6</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">),</span>
        <span class="s1">PositiveSpectrumWarning</span><span class="s3">,</span>
        <span class="s6">&quot;There are negative eigenvalues </span><span class="s2">\\</span><span class="s6">(1e</span><span class="s2">\\</span><span class="s6">-06 of the maximum positive&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
    <span class="s6">&quot;insignificant neg float64&quot;</span><span class="s3">: (</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1e-10</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
        <span class="s1">PositiveSpectrumWarning</span><span class="s3">,</span>
        <span class="s6">&quot;There are negative eigenvalues </span><span class="s2">\\</span><span class="s6">(1e</span><span class="s2">\\</span><span class="s6">-10 of the maximum positive&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
    <span class="s6">&quot;insignificant pos&quot;</span><span class="s3">: (</span>
        <span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">4e-12</span><span class="s3">),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]),</span>
        <span class="s1">PositiveSpectrumWarning</span><span class="s3">,</span>
        <span class="s6">&quot;the largest eigenvalue is more than 1e</span><span class="s2">\\</span><span class="s6">+12 times the smallest&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
<span class="s3">}</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;lambdas, expected_lambdas, w_type, w_msg&quot;</span><span class="s3">,</span>
    <span class="s1">list</span><span class="s3">(</span><span class="s1">_psd_cases_valid</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()),</span>
    <span class="s1">ids</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s1">_psd_cases_valid</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()),</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;enable_warnings&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_psd_eigenvalues_valid</span><span class="s3">(</span>
    <span class="s1">lambdas</span><span class="s3">, </span><span class="s1">expected_lambdas</span><span class="s3">, </span><span class="s1">w_type</span><span class="s3">, </span><span class="s1">w_msg</span><span class="s3">, </span><span class="s1">enable_warnings</span>
<span class="s3">):</span>
    <span class="s4"># Test that ``_check_psd_eigenvalues`` returns the right output for valid</span>
    <span class="s4"># input, possibly raising the right warning</span>

    <span class="s2">if not </span><span class="s1">enable_warnings</span><span class="s3">:</span>
        <span class="s1">w_type </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">if </span><span class="s1">w_type </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s6">&quot;error&quot;</span><span class="s3">, </span><span class="s1">PositiveSpectrumWarning</span><span class="s3">)</span>
            <span class="s1">lambdas_fixed </span><span class="s3">= </span><span class="s1">_check_psd_eigenvalues</span><span class="s3">(</span>
                <span class="s1">lambdas</span><span class="s3">, </span><span class="s1">enable_warnings</span><span class="s3">=</span><span class="s1">enable_warnings</span>
            <span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">w_type</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">w_msg</span><span class="s3">):</span>
            <span class="s1">lambdas_fixed </span><span class="s3">= </span><span class="s1">_check_psd_eigenvalues</span><span class="s3">(</span>
                <span class="s1">lambdas</span><span class="s3">, </span><span class="s1">enable_warnings</span><span class="s3">=</span><span class="s1">enable_warnings</span>
            <span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">expected_lambdas</span><span class="s3">, </span><span class="s1">lambdas_fixed</span><span class="s3">)</span>


<span class="s1">_psd_cases_invalid </span><span class="s3">= {</span>
    <span class="s6">&quot;significant_imag&quot;</span><span class="s3">: (</span>
        <span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5j</span><span class="s3">),</span>
        <span class="s1">ValueError</span><span class="s3">,</span>
        <span class="s6">&quot;There are significant imaginary parts in eigenv&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
    <span class="s6">&quot;all negative&quot;</span><span class="s3">: (</span>
        <span class="s3">(-</span><span class="s5">5</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">),</span>
        <span class="s1">ValueError</span><span class="s3">,</span>
        <span class="s6">&quot;All eigenvalues are negative </span><span class="s2">\\</span><span class="s6">(maximum is -1&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
    <span class="s6">&quot;significant neg&quot;</span><span class="s3">: (</span>
        <span class="s3">(</span><span class="s5">5</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">),</span>
        <span class="s1">ValueError</span><span class="s3">,</span>
        <span class="s6">&quot;There are significant negative eigenvalues&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
    <span class="s6">&quot;significant neg float32&quot;</span><span class="s3">: (</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">3e-4</span><span class="s3">, -</span><span class="s5">2e-6</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">),</span>
        <span class="s1">ValueError</span><span class="s3">,</span>
        <span class="s6">&quot;There are significant negative eigenvalues&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
    <span class="s6">&quot;significant neg float64&quot;</span><span class="s3">: (</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1e-5</span><span class="s3">, -</span><span class="s5">2e-10</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
        <span class="s1">ValueError</span><span class="s3">,</span>
        <span class="s6">&quot;There are significant negative eigenvalues&quot;</span><span class="s3">,</span>
    <span class="s3">),</span>
<span class="s3">}</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;lambdas, err_type, err_msg&quot;</span><span class="s3">,</span>
    <span class="s1">list</span><span class="s3">(</span><span class="s1">_psd_cases_invalid</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()),</span>
    <span class="s1">ids</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s1">_psd_cases_invalid</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()),</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_psd_eigenvalues_invalid</span><span class="s3">(</span><span class="s1">lambdas</span><span class="s3">, </span><span class="s1">err_type</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">):</span>
    <span class="s4"># Test that ``_check_psd_eigenvalues`` raises the right error for invalid</span>
    <span class="s4"># input</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">err_type</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">_check_psd_eigenvalues</span><span class="s3">(</span><span class="s1">lambdas</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_sample_weight</span><span class="s3">():</span>
    <span class="s4"># check array order</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)[::</span><span class="s5">2</span><span class="s3">]</span>
    <span class="s2">assert not </span><span class="s1">sample_weight</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">_check_sample_weight</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)))</span>
    <span class="s2">assert </span><span class="s1">sample_weight</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>

    <span class="s4"># check None input</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">_check_sample_weight</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))</span>

    <span class="s4"># check numbers input</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">_check_sample_weight</span><span class="s3">(</span><span class="s5">2.0</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s5">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))</span>

    <span class="s4"># check wrong number of dimensions</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Sample weights must be 1D array or scalar&quot;</span><span class="s3">):</span>
        <span class="s1">_check_sample_weight</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)), </span><span class="s1">X</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)))</span>

    <span class="s4"># check incorrect n_samples</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">r&quot;sample_weight.shape == \(4,\), expected \(2,\)!&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">_check_sample_weight</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">4</span><span class="s3">), </span><span class="s1">X</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)))</span>

    <span class="s4"># float32 dtype is preserved</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">_check_sample_weight</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">sample_weight</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span>

    <span class="s4"># int dtype will be converted to float64 instead</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">)</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">_check_sample_weight</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">X</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">sample_weight</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>

    <span class="s4"># check negative weight when only_non_negative=True</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">sample_weight</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] = -</span><span class="s5">10</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">&quot;Negative values in data passed to `sample_weight`&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">_check_sample_weight</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">only_non_negative</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;toarray&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">, </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">, </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_allclose_dense_sparse_equals</span><span class="s3">(</span><span class="s1">toarray</span><span class="s3">):</span>
    <span class="s1">base </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">9</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">base</span><span class="s3">), </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;toarray&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">, </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">, </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_allclose_dense_sparse_not_equals</span><span class="s3">(</span><span class="s1">toarray</span><span class="s3">):</span>
    <span class="s1">base </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">9</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">base</span><span class="s3">), </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">base </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;toarray&quot;</span><span class="s3">, [</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">, </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_allclose_dense_sparse_raise</span><span class="s3">(</span><span class="s1">toarray</span><span class="s3">):</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">9</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">x </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Can only compare two sparse matrices, not a sparse matrix and an array&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_deprecate_positional_args_warns_for_function</span><span class="s3">():</span>
    <span class="s3">@</span><span class="s1">_deprecate_positional_args</span>
    <span class="s2">def </span><span class="s1">f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, *, </span><span class="s1">c</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">1</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;Pass c=3 as keyword args&quot;</span><span class="s3">):</span>
        <span class="s1">f1</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;Pass c=3, d=4 as keyword args&quot;</span><span class="s3">):</span>
        <span class="s1">f1</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">_deprecate_positional_args</span>
    <span class="s2">def </span><span class="s1">f2</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, *, </span><span class="s1">b</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">c</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">1</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;Pass b=2 as keyword args&quot;</span><span class="s3">):</span>
        <span class="s1">f2</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s4"># The * is place before a keyword only argument without a default value</span>
    <span class="s3">@</span><span class="s1">_deprecate_positional_args</span>
    <span class="s2">def </span><span class="s1">f3</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, *, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">c</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">1</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;Pass b=2 as keyword args&quot;</span><span class="s3">):</span>
        <span class="s1">f3</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_deprecate_positional_args_warns_for_function_version</span><span class="s3">():</span>
    <span class="s3">@</span><span class="s1">_deprecate_positional_args</span><span class="s3">(</span><span class="s1">version</span><span class="s3">=</span><span class="s6">&quot;1.1&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">f1</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, *, </span><span class="s1">b</span><span class="s3">):</span>
        <span class="s2">pass</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span>
        <span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;From version 1.1 passing these as positional&quot;</span>
    <span class="s3">):</span>
        <span class="s1">f1</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_deprecate_positional_args_warns_for_class</span><span class="s3">():</span>
    <span class="s2">class </span><span class="s1">A1</span><span class="s3">:</span>
        <span class="s3">@</span><span class="s1">_deprecate_positional_args</span>
        <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, *, </span><span class="s1">c</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">1</span><span class="s3">):</span>
            <span class="s2">pass</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;Pass c=3 as keyword args&quot;</span><span class="s3">):</span>
        <span class="s1">A1</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;Pass c=3, d=4 as keyword args&quot;</span><span class="s3">):</span>
        <span class="s1">A1</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>

    <span class="s2">class </span><span class="s1">A2</span><span class="s3">:</span>
        <span class="s3">@</span><span class="s1">_deprecate_positional_args</span>
        <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">a</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, *, </span><span class="s1">c</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">d</span><span class="s3">=</span><span class="s5">1</span><span class="s3">):</span>
            <span class="s2">pass</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;Pass c=3 as keyword args&quot;</span><span class="s3">):</span>
        <span class="s1">A2</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;Pass c=3, d=4 as keyword args&quot;</span><span class="s3">):</span>
        <span class="s1">A2</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;indices&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]])</span>
<span class="s2">def </span><span class="s1">test_check_method_params</span><span class="s3">(</span><span class="s1">indices</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">_params </span><span class="s3">= {</span>
        <span class="s6">&quot;list&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
        <span class="s6">&quot;array&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]),</span>
        <span class="s6">&quot;sparse-col&quot;</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]).</span><span class="s1">T</span><span class="s3">,</span>
        <span class="s6">&quot;sparse-row&quot;</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">csc_matrix</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]),</span>
        <span class="s6">&quot;scalar-int&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">,</span>
        <span class="s6">&quot;scalar-str&quot;</span><span class="s3">: </span><span class="s6">&quot;xxx&quot;</span><span class="s3">,</span>
        <span class="s6">&quot;None&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">_check_method_params</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">params</span><span class="s3">=</span><span class="s1">_params</span><span class="s3">, </span><span class="s1">indices</span><span class="s3">=</span><span class="s1">indices</span><span class="s3">)</span>
    <span class="s1">indices_ </span><span class="s3">= </span><span class="s1">indices </span><span class="s2">if </span><span class="s1">indices </span><span class="s2">is not None else </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]))</span>

    <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;sparse-row&quot;</span><span class="s3">, </span><span class="s6">&quot;scalar-int&quot;</span><span class="s3">, </span><span class="s6">&quot;scalar-str&quot;</span><span class="s3">, </span><span class="s6">&quot;None&quot;</span><span class="s3">]:</span>
        <span class="s2">assert </span><span class="s1">result</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] </span><span class="s2">is </span><span class="s1">_params</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>

    <span class="s2">assert </span><span class="s1">result</span><span class="s3">[</span><span class="s6">&quot;list&quot;</span><span class="s3">] == </span><span class="s1">_safe_indexing</span><span class="s3">(</span><span class="s1">_params</span><span class="s3">[</span><span class="s6">&quot;list&quot;</span><span class="s3">], </span><span class="s1">indices_</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">[</span><span class="s6">&quot;array&quot;</span><span class="s3">], </span><span class="s1">_safe_indexing</span><span class="s3">(</span><span class="s1">_params</span><span class="s3">[</span><span class="s6">&quot;array&quot;</span><span class="s3">], </span><span class="s1">indices_</span><span class="s3">))</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span>
        <span class="s1">result</span><span class="s3">[</span><span class="s6">&quot;sparse-col&quot;</span><span class="s3">], </span><span class="s1">_safe_indexing</span><span class="s3">(</span><span class="s1">_params</span><span class="s3">[</span><span class="s6">&quot;sparse-col&quot;</span><span class="s3">], </span><span class="s1">indices_</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;sp_format&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;csc&quot;</span><span class="s3">, </span><span class="s6">&quot;coo&quot;</span><span class="s3">, </span><span class="s6">&quot;bsr&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_sparse_pandas_sp_format</span><span class="s3">(</span><span class="s1">sp_format</span><span class="s3">):</span>
    <span class="s4"># check_array converts pandas dataframe with only sparse arrays into</span>
    <span class="s4"># sparse matrix</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">sp_mat </span><span class="s3">= </span><span class="s1">_sparse_random_matrix</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>

    <span class="s1">sdf </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">.</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">from_spmatrix</span><span class="s3">(</span><span class="s1">sp_mat</span><span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">sdf</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s1">sp_format</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">sp_format </span><span class="s2">is True</span><span class="s3">:</span>
        <span class="s4"># by default pandas converts to coo when accept_sparse is True</span>
        <span class="s1">sp_format </span><span class="s3">= </span><span class="s6">&quot;coo&quot;</span>

    <span class="s2">assert </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">result</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">result</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s1">sp_format</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">sp_mat</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;ntype1, ntype2&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s6">&quot;longdouble&quot;</span><span class="s3">, </span><span class="s6">&quot;float16&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;float16&quot;</span><span class="s3">, </span><span class="s6">&quot;float32&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;float32&quot;</span><span class="s3">, </span><span class="s6">&quot;double&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;int16&quot;</span><span class="s3">, </span><span class="s6">&quot;int32&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;int32&quot;</span><span class="s3">, </span><span class="s6">&quot;long&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;byte&quot;</span><span class="s3">, </span><span class="s6">&quot;uint16&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;ushort&quot;</span><span class="s3">, </span><span class="s6">&quot;uint32&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;uint32&quot;</span><span class="s3">, </span><span class="s6">&quot;uint64&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;uint8&quot;</span><span class="s3">, </span><span class="s6">&quot;int8&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_pandas_sparse_invalid</span><span class="s3">(</span><span class="s1">ntype1</span><span class="s3">, </span><span class="s1">ntype2</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;check that we raise an error with dataframe having 
    sparse extension arrays with unsupported mixed dtype 
    and pandas version below 1.1. pandas versions 1.1 and 
    above fixed this issue so no error will be raised.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s6">&quot;col1&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">arrays</span><span class="s3">.</span><span class="s1">SparseArray</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">ntype1</span><span class="s3">, </span><span class="s1">fill_value</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
            <span class="s6">&quot;col2&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">arrays</span><span class="s3">.</span><span class="s1">SparseArray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">ntype2</span><span class="s3">, </span><span class="s1">fill_value</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
        <span class="s3">}</span>
    <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">parse_version</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &lt; </span><span class="s1">parse_version</span><span class="s3">(</span><span class="s6">&quot;1.1&quot;</span><span class="s3">):</span>
        <span class="s1">err_msg </span><span class="s3">= </span><span class="s6">&quot;Pandas DataFrame with mixed sparse extension arrays&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
            <span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=[</span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;csc&quot;</span><span class="s3">])</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s4"># pandas fixed this issue at 1.1 so from here on,</span>
        <span class="s4"># no error will be raised.</span>
        <span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=[</span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;csc&quot;</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;ntype1, ntype2, expected_subtype&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s6">&quot;double&quot;</span><span class="s3">, </span><span class="s6">&quot;longdouble&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;single&quot;</span><span class="s3">, </span><span class="s6">&quot;float32&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;double&quot;</span><span class="s3">, </span><span class="s6">&quot;float64&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;int8&quot;</span><span class="s3">, </span><span class="s6">&quot;byte&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;short&quot;</span><span class="s3">, </span><span class="s6">&quot;int16&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;intc&quot;</span><span class="s3">, </span><span class="s6">&quot;int32&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;intp&quot;</span><span class="s3">, </span><span class="s6">&quot;long&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;int&quot;</span><span class="s3">, </span><span class="s6">&quot;long&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;int64&quot;</span><span class="s3">, </span><span class="s6">&quot;longlong&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;int_&quot;</span><span class="s3">, </span><span class="s6">&quot;intp&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;ubyte&quot;</span><span class="s3">, </span><span class="s6">&quot;uint8&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unsignedinteger</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;uint16&quot;</span><span class="s3">, </span><span class="s6">&quot;ushort&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unsignedinteger</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;uintc&quot;</span><span class="s3">, </span><span class="s6">&quot;uint32&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unsignedinteger</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;uint&quot;</span><span class="s3">, </span><span class="s6">&quot;uint64&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unsignedinteger</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;uintp&quot;</span><span class="s3">, </span><span class="s6">&quot;ulonglong&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unsignedinteger</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_pandas_sparse_valid</span><span class="s3">(</span><span class="s1">ntype1</span><span class="s3">, </span><span class="s1">ntype2</span><span class="s3">, </span><span class="s1">expected_subtype</span><span class="s3">):</span>
    <span class="s4"># check that we support the conversion of sparse dataframe with mixed</span>
    <span class="s4"># type which can be converted safely.</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s6">&quot;col1&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">arrays</span><span class="s3">.</span><span class="s1">SparseArray</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">ntype1</span><span class="s3">, </span><span class="s1">fill_value</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
            <span class="s6">&quot;col2&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">arrays</span><span class="s3">.</span><span class="s1">SparseArray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">ntype2</span><span class="s3">, </span><span class="s1">fill_value</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">arr </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=[</span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;csc&quot;</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">expected_subtype</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;constructor_name&quot;</span><span class="s3">,</span>
    <span class="s3">[</span><span class="s6">&quot;list&quot;</span><span class="s3">, </span><span class="s6">&quot;tuple&quot;</span><span class="s3">, </span><span class="s6">&quot;array&quot;</span><span class="s3">, </span><span class="s6">&quot;dataframe&quot;</span><span class="s3">, </span><span class="s6">&quot;sparse_csr&quot;</span><span class="s3">, </span><span class="s6">&quot;sparse_csc&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_num_features</span><span class="s3">(</span><span class="s1">constructor_name</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check _num_features for array-likes.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]]</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">constructor_name</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">_num_features</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) == </span><span class="s5">3</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;X&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">3.4</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">],</span>
        <span class="s3">[{</span><span class="s6">&quot;a&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">}, {</span><span class="s6">&quot;b&quot;</span><span class="s3">: </span><span class="s5">2</span><span class="s3">}, {</span><span class="s6">&quot;c&quot;</span><span class="s3">: </span><span class="s5">3</span><span class="s3">}],</span>
    <span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;int&quot;</span><span class="s3">, </span><span class="s6">&quot;str&quot;</span><span class="s3">, </span><span class="s6">&quot;bool&quot;</span><span class="s3">, </span><span class="s6">&quot;float&quot;</span><span class="s3">, </span><span class="s6">&quot;dict&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;constructor_name&quot;</span><span class="s3">, [</span><span class="s6">&quot;list&quot;</span><span class="s3">, </span><span class="s6">&quot;tuple&quot;</span><span class="s3">, </span><span class="s6">&quot;array&quot;</span><span class="s3">, </span><span class="s6">&quot;series&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_num_features_errors_1d_containers</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">constructor_name</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">constructor_name</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">constructor_name </span><span class="s3">== </span><span class="s6">&quot;array&quot;</span><span class="s3">:</span>
        <span class="s1">expected_type_name </span><span class="s3">= </span><span class="s6">&quot;numpy.ndarray&quot;</span>
    <span class="s2">elif </span><span class="s1">constructor_name </span><span class="s3">== </span><span class="s6">&quot;series&quot;</span><span class="s3">:</span>
        <span class="s1">expected_type_name </span><span class="s3">= </span><span class="s6">&quot;pandas.core.series.Series&quot;</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">expected_type_name </span><span class="s3">= </span><span class="s1">constructor_name</span>
    <span class="s1">message </span><span class="s3">= (</span>
        <span class="s6">f&quot;Unable to find the number of features from X of type </span><span class="s2">{</span><span class="s1">expected_type_name</span><span class="s2">}</span><span class="s6">&quot;</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;shape&quot;</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">+= </span><span class="s6">&quot; with shape (3,)&quot;</span>
    <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">+= </span><span class="s6">&quot; where the samples are of type str&quot;</span>
    <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">dict</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">+= </span><span class="s6">&quot; where the samples are of type dict&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s1">message</span><span class="s3">)):</span>
        <span class="s1">_num_features</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;X&quot;</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">], </span><span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;int&quot;</span><span class="s3">, </span><span class="s6">&quot;str&quot;</span><span class="s3">, </span><span class="s6">&quot;bool&quot;</span><span class="s3">, </span><span class="s6">&quot;float&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_num_features_errors_scalars</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;Unable to find the number of features from X of type </span><span class="s2">{</span><span class="s1">type</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">__qualname__</span><span class="s2">}</span><span class="s6">&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">_num_features</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;names&quot;</span><span class="s3">,</span>
    <span class="s3">[</span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)), </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s2">None</span><span class="s3">, [[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">], [</span><span class="s6">&quot;c&quot;</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">]]],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;list-int&quot;</span><span class="s3">, </span><span class="s6">&quot;range&quot;</span><span class="s3">, </span><span class="s6">&quot;default&quot;</span><span class="s3">, </span><span class="s6">&quot;MultiIndex&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_get_feature_names_pandas_with_ints_no_warning</span><span class="s3">(</span><span class="s1">names</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Get feature names with pandas dataframes without warning. 
 
    Column names with consistent dtypes will not warn, such as int or MultiIndex. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">names</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s6">&quot;error&quot;</span><span class="s3">, </span><span class="s1">FutureWarning</span><span class="s3">)</span>
        <span class="s1">names </span><span class="s3">= </span><span class="s1">_get_feature_names</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">names </span><span class="s2">is None</span>


<span class="s2">def </span><span class="s1">test_get_feature_names_pandas</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Get feature names with pandas dataframes.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">columns </span><span class="s3">= [</span><span class="s6">f&quot;col_</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s6">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)]</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">columns</span><span class="s3">)</span>
    <span class="s1">feature_names </span><span class="s3">= </span><span class="s1">_get_feature_names</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">feature_names</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;constructor_name, minversion&quot;</span><span class="s3">,</span>
    <span class="s3">[(</span><span class="s6">&quot;pyarrow&quot;</span><span class="s3">, </span><span class="s6">&quot;12.0.0&quot;</span><span class="s3">), (</span><span class="s6">&quot;dataframe&quot;</span><span class="s3">, </span><span class="s6">&quot;1.5.0&quot;</span><span class="s3">), (</span><span class="s6">&quot;polars&quot;</span><span class="s3">, </span><span class="s6">&quot;0.18.2&quot;</span><span class="s3">)],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_get_feature_names_dataframe_protocol</span><span class="s3">(</span><span class="s1">constructor_name</span><span class="s3">, </span><span class="s1">minversion</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Uses the dataframe exchange protocol to get feature names.&quot;&quot;&quot;</span>
    <span class="s1">data </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]]</span>
    <span class="s1">columns </span><span class="s3">= [</span><span class="s6">&quot;col_0&quot;</span><span class="s3">, </span><span class="s6">&quot;col_1&quot;</span><span class="s3">, </span><span class="s6">&quot;col_2&quot;</span><span class="s3">]</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">(</span>
        <span class="s1">data</span><span class="s3">, </span><span class="s1">constructor_name</span><span class="s3">, </span><span class="s1">columns_name</span><span class="s3">=</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">minversion</span><span class="s3">=</span><span class="s1">minversion</span>
    <span class="s3">)</span>
    <span class="s1">feature_names </span><span class="s3">= </span><span class="s1">_get_feature_names</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">feature_names</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;constructor_name&quot;</span><span class="s3">, [</span><span class="s6">&quot;pyarrow&quot;</span><span class="s3">, </span><span class="s6">&quot;dataframe&quot;</span><span class="s3">, </span><span class="s6">&quot;polars&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_is_pandas_df_other_libraries</span><span class="s3">(</span><span class="s1">constructor_name</span><span class="s3">):</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]], </span><span class="s1">constructor_name</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">constructor_name </span><span class="s2">in </span><span class="s3">(</span><span class="s6">&quot;pyarrow&quot;</span><span class="s3">, </span><span class="s6">&quot;polars&quot;</span><span class="s3">):</span>
        <span class="s2">assert not </span><span class="s1">_is_pandas_df</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">_is_pandas_df</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_is_pandas_df</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check behavior of is_pandas_df when pandas is installed.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]])</span>
    <span class="s2">assert </span><span class="s1">_is_pandas_df</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">_is_pandas_df</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]))</span>
    <span class="s2">assert not </span><span class="s1">_is_pandas_df</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_is_pandas_df_pandas_not_installed</span><span class="s3">(</span><span class="s1">hide_available_pandas</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check _is_pandas_df when pandas is not installed.&quot;&quot;&quot;</span>

    <span class="s2">assert not </span><span class="s1">_is_pandas_df</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]))</span>
    <span class="s2">assert not </span><span class="s1">_is_pandas_df</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;constructor_name, minversion&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s6">&quot;pyarrow&quot;</span><span class="s3">, </span><span class="s1">dependent_packages</span><span class="s3">[</span><span class="s6">&quot;pyarrow&quot;</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s6">&quot;dataframe&quot;</span><span class="s3">, </span><span class="s1">dependent_packages</span><span class="s3">[</span><span class="s6">&quot;pandas&quot;</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s6">&quot;polars&quot;</span><span class="s3">, </span><span class="s1">dependent_packages</span><span class="s3">[</span><span class="s6">&quot;polars&quot;</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_is_polars_df_other_libraries</span><span class="s3">(</span><span class="s1">constructor_name</span><span class="s3">, </span><span class="s1">minversion</span><span class="s3">):</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]],</span>
        <span class="s1">constructor_name</span><span class="s3">,</span>
        <span class="s1">minversion</span><span class="s3">=</span><span class="s1">minversion</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">constructor_name </span><span class="s2">in </span><span class="s3">(</span><span class="s6">&quot;pyarrow&quot;</span><span class="s3">, </span><span class="s6">&quot;dataframe&quot;</span><span class="s3">):</span>
        <span class="s2">assert not </span><span class="s1">_is_polars_df</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">_is_polars_df</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_is_polars_df_for_duck_typed_polars_dataframe</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check _is_polars_df for object that looks like a polars dataframe&quot;&quot;&quot;</span>

    <span class="s2">class </span><span class="s1">NotAPolarsDataFrame</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">schema </span><span class="s3">= </span><span class="s6">&quot;my_schema&quot;</span>

    <span class="s1">not_a_polars_df </span><span class="s3">= </span><span class="s1">NotAPolarsDataFrame</span><span class="s3">()</span>
    <span class="s2">assert not </span><span class="s1">_is_polars_df</span><span class="s3">(</span><span class="s1">not_a_polars_df</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_get_feature_names_numpy</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Get feature names return None for numpy arrays.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]])</span>
    <span class="s1">names </span><span class="s3">= </span><span class="s1">_get_feature_names</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">names </span><span class="s2">is None</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;names, dtypes&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">([</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s6">&quot;['int', 'str']&quot;</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s6">&quot;pizza&quot;</span><span class="s3">, [</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">]], </span><span class="s6">&quot;['list', 'str']&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;int-str&quot;</span><span class="s3">, </span><span class="s6">&quot;list-str&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_get_feature_names_invalid_dtypes</span><span class="s3">(</span><span class="s1">names</span><span class="s3">, </span><span class="s1">dtypes</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Get feature names errors when the feature names have mixed dtypes&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">names</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s6">&quot;Feature names are only supported if all input features have string names, &quot;</span>
        <span class="s6">f&quot;but your input has </span><span class="s2">{</span><span class="s1">dtypes</span><span class="s2">} </span><span class="s6">as feature name / column name types. &quot;</span>
        <span class="s6">&quot;If you want feature names to be stored and validated, you must convert &quot;</span>
        <span class="s6">&quot;them all to strings, by using X.columns = X.columns.astype(str) for &quot;</span>
        <span class="s6">&quot;example. Otherwise you can remove feature / column names from your input &quot;</span>
        <span class="s6">&quot;data, or convert them all to a non-string data type.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">names </span><span class="s3">= </span><span class="s1">_get_feature_names</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">PassthroughTransformer</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_validate_data</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">reset</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">X</span>

    <span class="s2">def </span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">input_features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">_check_feature_names_in</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">input_features</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_feature_names_in</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check behavior of check_feature_names_in for arrays.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]])</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">PassthroughTransformer</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">names </span><span class="s3">= </span><span class="s1">est</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">names</span><span class="s3">, [</span><span class="s6">&quot;x0&quot;</span><span class="s3">, </span><span class="s6">&quot;x1&quot;</span><span class="s3">, </span><span class="s6">&quot;x2&quot;</span><span class="s3">])</span>

    <span class="s1">incorrect_len_names </span><span class="s3">= [</span><span class="s6">&quot;x10&quot;</span><span class="s3">, </span><span class="s6">&quot;x1&quot;</span><span class="s3">]</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;input_features should have length equal to&quot;</span><span class="s3">):</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">incorrect_len_names</span><span class="s3">)</span>

    <span class="s4"># remove n_feature_in_</span>
    <span class="s2">del </span><span class="s1">est</span><span class="s3">.</span><span class="s1">n_features_in_</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Unable to generate feature names&quot;</span><span class="s3">):</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_check_feature_names_in_pandas</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check behavior of check_feature_names_in for pandas dataframes.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">names </span><span class="s3">= [</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">]</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">names</span><span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">PassthroughTransformer</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">names </span><span class="s3">= </span><span class="s1">est</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">names</span><span class="s3">, [</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">])</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;input_features is not equal to&quot;</span><span class="s3">):</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s6">&quot;x1&quot;</span><span class="s3">, </span><span class="s6">&quot;x2&quot;</span><span class="s3">, </span><span class="s6">&quot;x3&quot;</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_check_response_method_unknown_method</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the error message when passing an unknown response method.&quot;&quot;&quot;</span>
    <span class="s1">err_msg </span><span class="s3">= (</span>
        <span class="s6">&quot;RandomForestRegressor has none of the following attributes: unknown_method.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">_check_response_method</span><span class="s3">(</span><span class="s1">RandomForestRegressor</span><span class="s3">(), </span><span class="s6">&quot;unknown_method&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;response_method&quot;</span><span class="s3">, [</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict&quot;</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_check_response_method_not_supported_response_method</span><span class="s3">(</span><span class="s1">response_method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the error message when a response method is not supported by the 
    estimator.&quot;&quot;&quot;</span>
    <span class="s1">err_msg </span><span class="s3">= (</span>
        <span class="s6">f&quot;EstimatorWithFit has none of the following attributes: </span><span class="s2">{</span><span class="s1">response_method</span><span class="s2">}</span><span class="s6">.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">_check_response_method</span><span class="s3">(</span><span class="s1">EstimatorWithFit</span><span class="s3">(), </span><span class="s1">response_method</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_response_method_list_str</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that we can pass a list of ordered method.&quot;&quot;&quot;</span>
    <span class="s1">method_implemented </span><span class="s3">= [</span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">]</span>
    <span class="s1">my_estimator </span><span class="s3">= </span><span class="s1">_MockEstimatorOnOffPrediction</span><span class="s3">(</span><span class="s1">method_implemented</span><span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s6">&quot;mocking_data&quot;</span>

    <span class="s4"># raise an error when no methods are defined</span>
    <span class="s1">response_method </span><span class="s3">= [</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict&quot;</span><span class="s3">]</span>
    <span class="s1">err_msg </span><span class="s3">= (</span>
        <span class="s6">&quot;_MockEstimatorOnOffPrediction has none of the following attributes: &quot;</span>
        <span class="s6">f&quot;</span><span class="s2">{</span><span class="s6">', '</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">response_method</span><span class="s3">)</span><span class="s2">}</span><span class="s6">.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">_check_response_method</span><span class="s3">(</span><span class="s1">my_estimator</span><span class="s3">, </span><span class="s1">response_method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s4"># check that we don't get issue when one of the method is defined</span>
    <span class="s1">response_method </span><span class="s3">= [</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">]</span>
    <span class="s1">method_name_predicting </span><span class="s3">= </span><span class="s1">_check_response_method</span><span class="s3">(</span><span class="s1">my_estimator</span><span class="s3">, </span><span class="s1">response_method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">method_name_predicting </span><span class="s3">== </span><span class="s6">&quot;predict_proba&quot;</span>

    <span class="s4"># check the order of the methods returned</span>
    <span class="s1">method_implemented </span><span class="s3">= [</span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s6">&quot;predict&quot;</span><span class="s3">]</span>
    <span class="s1">my_estimator </span><span class="s3">= </span><span class="s1">_MockEstimatorOnOffPrediction</span><span class="s3">(</span><span class="s1">method_implemented</span><span class="s3">)</span>
    <span class="s1">response_method </span><span class="s3">= [</span><span class="s6">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s6">&quot;predict&quot;</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">]</span>
    <span class="s1">method_name_predicting </span><span class="s3">= </span><span class="s1">_check_response_method</span><span class="s3">(</span><span class="s1">my_estimator</span><span class="s3">, </span><span class="s1">response_method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">method_name_predicting </span><span class="s3">== </span><span class="s6">&quot;predict&quot;</span>


<span class="s2">def </span><span class="s1">test_boolean_series_remains_boolean</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Regression test for gh-25145&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]), </span><span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>

    <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">dtype</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;input_values&quot;</span><span class="s3">, [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]])</span>
<span class="s2">def </span><span class="s1">test_pandas_array_returns_ndarray</span><span class="s3">(</span><span class="s1">input_values</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check pandas array with extensions dtypes returns a numeric ndarray. 
 
    Non-regression test for gh-25637. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">input_series </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">input_values</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;Int32&quot;</span><span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span>
        <span class="s1">input_series</span><span class="s3">,</span>
        <span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">ensure_2d</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">allow_nd</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">force_all_finite</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">input_values</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_if_array_api_compat_not_configured</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;array_namespace&quot;</span><span class="s3">, [</span><span class="s6">&quot;array_api_strict&quot;</span><span class="s3">, </span><span class="s6">&quot;cupy.array_api&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_array_array_api_has_non_finite</span><span class="s3">(</span><span class="s1">array_namespace</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Checks that Array API arrays checks non-finite correctly.&quot;&quot;&quot;</span>
    <span class="s1">xp </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s1">array_namespace</span><span class="s3">)</span>

    <span class="s1">X_nan </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">config_context</span><span class="s3">(</span><span class="s1">array_api_dispatch</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Input contains NaN.&quot;</span><span class="s3">):</span>
            <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_nan</span><span class="s3">)</span>

    <span class="s1">X_inf </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">config_context</span><span class="s3">(</span><span class="s1">array_api_dispatch</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;infinity or a value too large&quot;</span><span class="s3">):</span>
            <span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_inf</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;extension_dtype, regular_dtype&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s6">&quot;boolean&quot;</span><span class="s3">, </span><span class="s6">&quot;bool&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;Int64&quot;</span><span class="s3">, </span><span class="s6">&quot;int64&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;Float64&quot;</span><span class="s3">, </span><span class="s6">&quot;float64&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;category&quot;</span><span class="s3">, </span><span class="s6">&quot;object&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;include_object&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_array_multiple_extensions</span><span class="s3">(</span>
    <span class="s1">extension_dtype</span><span class="s3">, </span><span class="s1">regular_dtype</span><span class="s3">, </span><span class="s1">include_object</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check pandas extension arrays give the same result as non-extension arrays.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X_regular </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s6">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">regular_dtype</span><span class="s3">),</span>
            <span class="s6">&quot;c&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">9</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;int64&quot;</span><span class="s3">),</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">include_object</span><span class="s3">:</span>
        <span class="s1">X_regular</span><span class="s3">[</span><span class="s6">&quot;b&quot;</span><span class="s3">] = </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;object&quot;</span><span class="s3">)</span>

    <span class="s1">X_extension </span><span class="s3">= </span><span class="s1">X_regular</span><span class="s3">.</span><span class="s1">assign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">=</span><span class="s1">X_regular</span><span class="s3">[</span><span class="s6">&quot;a&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">extension_dtype</span><span class="s3">))</span>

    <span class="s1">X_regular_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_regular</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">X_extension_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X_extension</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_regular_checked</span><span class="s3">, </span><span class="s1">X_extension_checked</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_num_samples_dataframe_protocol</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Use the DataFrame interchange protocol to get n_samples from polars.&quot;&quot;&quot;</span>
    <span class="s1">pl </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;polars&quot;</span><span class="s3">)</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">pl</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s6">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]})</span>
    <span class="s2">assert </span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">df</span><span class="s3">) == </span><span class="s5">3</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;sparse_container&quot;</span><span class="s3">,</span>
    <span class="s1">CSR_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">COO_CONTAINERS </span><span class="s3">+ </span><span class="s1">DIA_CONTAINERS</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;output_format&quot;</span><span class="s3">, [</span><span class="s6">&quot;csr&quot;</span><span class="s3">, </span><span class="s6">&quot;csc&quot;</span><span class="s3">, </span><span class="s6">&quot;coo&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_check_array_dia_to_int32_indexed_csr_csc_coo</span><span class="s3">(</span><span class="s1">sparse_container</span><span class="s3">, </span><span class="s1">output_format</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the consistency of the indices dtype with sparse matrices/arrays.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s4"># Explicitly set the dtype of the indexing arrays</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;offsets&quot;</span><span class="s3">):  </span><span class="s4"># DIA matrix</span>
        <span class="s1">X</span><span class="s3">.</span><span class="s1">offsets </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">offsets</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;row&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;col&quot;</span><span class="s3">):  </span><span class="s4"># COO matrix</span>
        <span class="s1">X</span><span class="s3">.</span><span class="s1">row </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">row</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;indices&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s6">&quot;indptr&quot;</span><span class="s3">):  </span><span class="s4"># CSR or CSC matrix</span>
        <span class="s1">X</span><span class="s3">.</span><span class="s1">indices </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">indices</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
        <span class="s1">X</span><span class="s3">.</span><span class="s1">indptr </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>

    <span class="s1">X_checked </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">accept_sparse</span><span class="s3">=</span><span class="s1">output_format</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">output_format </span><span class="s3">== </span><span class="s6">&quot;coo&quot;</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">row</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span>
        <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">col</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span>
    <span class="s2">else</span><span class="s3">:  </span><span class="s4"># output_format in [&quot;csr&quot;, &quot;csc&quot;]</span>
        <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">indices</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span>
        <span class="s2">assert </span><span class="s1">X_checked</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;sequence&quot;</span><span class="s3">, [[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)], [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]]])</span>
<span class="s2">def </span><span class="s1">test_to_object_array</span><span class="s3">(</span><span class="s1">sequence</span><span class="s3">):</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">_to_object_array</span><span class="s3">(</span><span class="s1">sequence</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s6">&quot;O&quot;</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">== </span><span class="s5">1</span>


<span class="s2">def </span><span class="s1">test_column_or_1d</span><span class="s3">():</span>
    <span class="s1">EXAMPLES </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s6">&quot;binary&quot;</span><span class="s3">, [</span><span class="s6">&quot;spam&quot;</span><span class="s3">, </span><span class="s6">&quot;egg&quot;</span><span class="s3">, </span><span class="s6">&quot;spam&quot;</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s6">&quot;binary&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s6">&quot;continuous&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10</span><span class="s3">) / </span><span class="s5">20.0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">&quot;multiclass&quot;</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s6">&quot;multiclass&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]),</span>
        <span class="s3">(</span><span class="s6">&quot;multiclass&quot;</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s3">(</span><span class="s6">&quot;multilabel-indicator&quot;</span><span class="s3">, [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]),</span>
        <span class="s3">(</span><span class="s6">&quot;multiclass-multioutput&quot;</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s3">(</span><span class="s6">&quot;multiclass-multioutput&quot;</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]),</span>
        <span class="s3">(</span><span class="s6">&quot;multiclass-multioutput&quot;</span><span class="s3">, [[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]),</span>
        <span class="s3">(</span><span class="s6">&quot;multiclass-multioutput&quot;</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s3">(</span><span class="s6">&quot;continuous-multioutput&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">30</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">((-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))),</span>
    <span class="s3">]</span>

    <span class="s2">for </span><span class="s1">y_type</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">EXAMPLES</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">y_type </span><span class="s2">in </span><span class="s3">[</span><span class="s6">&quot;binary&quot;</span><span class="s3">, </span><span class="s6">&quot;multiclass&quot;</span><span class="s3">, </span><span class="s6">&quot;continuous&quot;</span><span class="s3">]:</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">column_or_1d</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(</span><span class="s1">y</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
                <span class="s1">column_or_1d</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test__is_polars_df</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that _is_polars_df return False for non-dataframe objects.&quot;&quot;&quot;</span>

    <span class="s2">class </span><span class="s1">LooksLikePolars</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">schema </span><span class="s3">= [</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">]</span>

    <span class="s2">assert not </span><span class="s1">_is_polars_df</span><span class="s3">(</span><span class="s1">LooksLikePolars</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_check_array_writeable_np</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the behavior of check_array when a writeable array is requested 
    without copy if possible, on numpy arrays. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">))</span>

    <span class="s1">out </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">force_writeable</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4"># X is already writeable, no copy is needed</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">may_share_memory</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">writeable</span>

    <span class="s1">X</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">writeable </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s1">out </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">force_writeable</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4"># X is not writeable, a copy is made</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">may_share_memory</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">writeable</span>


<span class="s2">def </span><span class="s1">test_check_array_writeable_mmap</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the behavior of check_array when a writeable array is requested 
    without copy if possible, on a memory-map. 
 
    A common situation is when a meta-estimators run in parallel using multiprocessing 
    with joblib, which creates read-only memory-maps of large arrays. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">))</span>

    <span class="s1">mmap </span><span class="s3">= </span><span class="s1">create_memmap_backed_data</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mmap_mode</span><span class="s3">=</span><span class="s6">&quot;w+&quot;</span><span class="s3">)</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">mmap</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">force_writeable</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4"># mmap is already writeable, no copy is needed</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">may_share_memory</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">writeable</span>

    <span class="s1">mmap </span><span class="s3">= </span><span class="s1">create_memmap_backed_data</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mmap_mode</span><span class="s3">=</span><span class="s6">&quot;r&quot;</span><span class="s3">)</span>
    <span class="s1">out </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">mmap</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">force_writeable</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4"># mmap is read-only, a copy is made</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">may_share_memory</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">mmap</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">writeable</span>


<span class="s2">def </span><span class="s1">test_check_array_writeable_df</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the behavior of check_array when a writeable array is requested 
    without copy if possible, on a dataframe. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s6">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">))</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">out </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">force_writeable</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4"># df is backed by a writeable array, no copy is needed</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">may_share_memory</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">writeable</span>

    <span class="s1">X</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">writeable </span><span class="s3">= </span><span class="s2">False</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">out </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">force_writeable</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s4"># df is backed by a read-only array, a copy is made</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">may_share_memory</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">writeable</span>
</pre>
</body>
</html>