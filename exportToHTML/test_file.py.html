<html>
<head>
<title>test_file.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #a5c261;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_file.py</font>
</center></td></tr></table>
<pre><span class="s0"># This file is part of h5py, a Python interface to the HDF5 library.</span>
<span class="s0">#</span>
<span class="s0"># http://www.h5py.org</span>
<span class="s0">#</span>
<span class="s0"># Copyright 2008-2013 Andrew Collette and contributors</span>
<span class="s0">#</span>
<span class="s0"># License:  Standard 3-clause BSD; see &quot;license.txt&quot; for full license terms</span>
<span class="s0">#           and contributor agreement.</span>

<span class="s2">&quot;&quot;&quot; 
    File object test module. 
 
    Tests all aspects of File objects, including their creation. 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">pytest</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">stat</span>
<span class="s3">import </span><span class="s1">pickle</span>
<span class="s3">import </span><span class="s1">tempfile</span>
<span class="s3">import </span><span class="s1">subprocess</span>
<span class="s3">import </span><span class="s1">sys</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">common </span><span class="s3">import </span><span class="s1">ut</span><span class="s4">, </span><span class="s1">TestCase</span><span class="s4">, </span><span class="s1">UNICODE_FILENAMES</span><span class="s4">, </span><span class="s1">closed_tempfile</span>
<span class="s3">from </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">files </span><span class="s3">import </span><span class="s1">direct_vfd</span>
<span class="s3">from </span><span class="s1">h5py </span><span class="s3">import </span><span class="s1">File</span>
<span class="s3">import </span><span class="s1">h5py</span>
<span class="s3">from </span><span class="s4">.. </span><span class="s3">import </span><span class="s1">h5</span>
<span class="s3">import </span><span class="s1">pathlib</span>


<span class="s3">class </span><span class="s1">TestFileOpen</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Opening files with Python-style modes. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_default</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Default semantics in the presence or absence of a file &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>

        <span class="s0"># No existing file; error</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">FileNotFoundError</span><span class="s4">):</span>
            <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">):</span>
                <span class="s3">pass</span>

        <span class="s0"># Existing readonly file; open read-only</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">):</span>
            <span class="s3">pass</span>
        <span class="s1">os</span><span class="s4">.</span><span class="s1">chmod</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">stat</span><span class="s4">.</span><span class="s1">S_IREAD</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">mode</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">os</span><span class="s4">.</span><span class="s1">chmod</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">stat</span><span class="s4">.</span><span class="s1">S_IWRITE</span><span class="s4">)</span>

        <span class="s0"># File exists but is not HDF5; raise OSError</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'wb'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s6">b'</span><span class="s3">\x00</span><span class="s6">'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Mode 'w' opens file in overwrite mode &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_create_exclusive</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Mode 'w-' opens file in exclusive mode &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w-'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">FileExistsError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w-'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Mode 'a' opens file in append/readwrite mode, creating if necessary &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s5">'foo' </span><span class="s3">in </span><span class="s1">fid</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s5">'foo' </span><span class="s3">in </span><span class="s1">fid</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s5">'bar' </span><span class="s3">in </span><span class="s1">fid</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">os</span><span class="s4">.</span><span class="s1">chmod</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">stat</span><span class="s4">.</span><span class="s1">S_IREAD</span><span class="s4">)  </span><span class="s0"># Make file read-only</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">PermissionError</span><span class="s4">):</span>
                <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s0"># Make it writable again so it can be deleted on Windows</span>
            <span class="s1">os</span><span class="s4">.</span><span class="s1">chmod</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">stat</span><span class="s4">.</span><span class="s1">S_IREAD </span><span class="s4">| </span><span class="s1">stat</span><span class="s4">.</span><span class="s1">S_IWRITE</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_readonly</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Mode 'r' opens file in readonly mode &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_readwrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Mode 'r+' opens existing file in readwrite mode &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r+'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s5">'foo' </span><span class="s3">in </span><span class="s1">fid</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s5">'bar' </span><span class="s3">in </span><span class="s1">fid</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_nonexistent_file</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Modes 'r' and 'r+' do not create files &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">FileNotFoundError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">FileNotFoundError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r+'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_invalid_mode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Invalid modes raise ValueError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'mongoose'</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestSpaceStrategy</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Create file with specified file space strategy 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create_with_space_strategy</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create file with file space strategy &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">&quot;page&quot;</span><span class="s4">,</span>
                   <span class="s1">fs_persist</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">fs_threshold</span><span class="s4">=</span><span class="s7">100</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s0"># Unable to set file space strategy of an existing file</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">&quot;page&quot;</span><span class="s4">)</span>
        <span class="s0"># Invalid file space strategy type</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">&quot;invalid&quot;</span><span class="s4">)</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s7">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'uint8'</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s7">1</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, (</span><span class="s7">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'uint8'</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s7">1</span>
        <span class="s3">del </span><span class="s1">fid</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s1">plist </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_create_plist</span><span class="s4">()</span>
        <span class="s1">fs_strat </span><span class="s4">= </span><span class="s1">plist</span><span class="s4">.</span><span class="s1">get_file_space_strategy</span><span class="s4">()</span>
        <span class="s3">assert</span><span class="s4">(</span><span class="s1">fs_strat</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] == </span><span class="s7">1</span><span class="s4">)</span>
        <span class="s3">assert</span><span class="s4">(</span><span class="s1">fs_strat</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] == </span><span class="s3">True</span><span class="s4">)</span>
        <span class="s3">assert</span><span class="s4">(</span><span class="s1">fs_strat</span><span class="s4">[</span><span class="s7">2</span><span class="s4">] == </span><span class="s7">100</span><span class="s4">)</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo2'</span><span class="s4">, (</span><span class="s7">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'uint8'</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s7">1</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">mpi_skip</span>
<span class="s3">class </span><span class="s1">TestPageBuffering</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
        Feature: Use page buffering 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_only_with_page_strategy</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Allow page buffering only with fs_strategy=&quot;page&quot;. 
        &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">'page'</span><span class="s4">, </span><span class="s1">page_buf_size</span><span class="s4">=</span><span class="s7">16</span><span class="s4">*</span><span class="s7">1024</span><span class="s4">):</span>
            <span class="s3">pass</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">page_buf_size</span><span class="s4">=</span><span class="s7">16</span><span class="s4">*</span><span class="s7">1024</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">'fsm'</span><span class="s4">, </span><span class="s1">page_buf_size</span><span class="s4">=</span><span class="s7">16</span><span class="s4">*</span><span class="s7">1024</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">'aggregate'</span><span class="s4">, </span><span class="s1">page_buf_size</span><span class="s4">=</span><span class="s7">16</span><span class="s4">*</span><span class="s7">1024</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_check_page_buf_size</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Verify set page buffer size, and minimum meta and raw eviction criteria.&quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">pbs </span><span class="s4">= </span><span class="s7">16 </span><span class="s4">* </span><span class="s7">1024</span>
        <span class="s1">mm </span><span class="s4">= </span><span class="s7">19</span>
        <span class="s1">mr </span><span class="s4">= </span><span class="s7">67</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">'page'</span><span class="s4">,</span>
                  <span class="s1">page_buf_size</span><span class="s4">=</span><span class="s1">pbs</span><span class="s4">, </span><span class="s1">min_meta_keep</span><span class="s4">=</span><span class="s1">mm</span><span class="s4">, </span><span class="s1">min_raw_keep</span><span class="s4">=</span><span class="s1">mr</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">fapl </span><span class="s4">= </span><span class="s1">f</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fapl</span><span class="s4">.</span><span class="s1">get_page_buffer_size</span><span class="s4">(), (</span><span class="s1">pbs</span><span class="s4">, </span><span class="s1">mm</span><span class="s4">, </span><span class="s1">mr</span><span class="s4">))</span>

    <span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&gt; (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">14</span><span class="s4">, </span><span class="s7">3</span><span class="s4">),</span>
                        <span class="s1">reason</span><span class="s4">=</span><span class="s5">'Requires HDF5 &lt;= 1.14.3'</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_too_small_pbs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Page buffer size must be greater than file space page size.&quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fsp </span><span class="s4">= </span><span class="s7">16 </span><span class="s4">* </span><span class="s7">1024</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">'page'</span><span class="s4">, </span><span class="s1">fs_page_size</span><span class="s4">=</span><span class="s1">fsp</span><span class="s4">):</span>
            <span class="s3">pass</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;r&quot;</span><span class="s4">, </span><span class="s1">page_buf_size</span><span class="s4">=</span><span class="s1">fsp</span><span class="s4">-</span><span class="s7">1</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&lt; (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">14</span><span class="s4">, </span><span class="s7">4</span><span class="s4">),</span>
                        <span class="s1">reason</span><span class="s4">=</span><span class="s5">'Requires HDF5 &gt;= 1.14.4'</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_open_nonpage_pbs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Open non-PAGE file with page buffer set.&quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fsp </span><span class="s4">= </span><span class="s7">16 </span><span class="s4">* </span><span class="s7">1024</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">):</span>
            <span class="s3">pass</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'r'</span><span class="s4">, </span><span class="s1">page_buf_size</span><span class="s4">=</span><span class="s1">fsp</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">fapl </span><span class="s4">= </span><span class="s1">f</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">()</span>
            <span class="s3">assert </span><span class="s1">fapl</span><span class="s4">.</span><span class="s1">get_page_buffer_size</span><span class="s4">()[</span><span class="s7">0</span><span class="s4">] == </span><span class="s7">0</span>

    <span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&lt; (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">14</span><span class="s4">, </span><span class="s7">4</span><span class="s4">),</span>
                    <span class="s1">reason</span><span class="s4">=</span><span class="s5">'Requires HDF5 &gt;= 1.14.4'</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_smaller_pbs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Adjust page buffer size automatically when smaller than file page.&quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fsp </span><span class="s4">= </span><span class="s7">16 </span><span class="s4">* </span><span class="s7">1024</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">'page'</span><span class="s4">, </span><span class="s1">fs_page_size</span><span class="s4">=</span><span class="s1">fsp</span><span class="s4">):</span>
            <span class="s3">pass</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'r'</span><span class="s4">, </span><span class="s1">page_buf_size</span><span class="s4">=</span><span class="s1">fsp</span><span class="s4">-</span><span class="s7">100</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">fapl </span><span class="s4">= </span><span class="s1">f</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">()</span>
            <span class="s3">assert </span><span class="s1">fapl</span><span class="s4">.</span><span class="s1">get_page_buffer_size</span><span class="s4">()[</span><span class="s7">0</span><span class="s4">] == </span><span class="s1">fsp</span>

    <span class="s3">def </span><span class="s1">test_actual_pbs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Verify actual page buffer size.&quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fsp </span><span class="s4">= </span><span class="s7">16 </span><span class="s4">* </span><span class="s7">1024</span>
        <span class="s1">pbs </span><span class="s4">= </span><span class="s7">2 </span><span class="s4">* </span><span class="s1">fsp</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">fs_strategy</span><span class="s4">=</span><span class="s5">'page'</span><span class="s4">, </span><span class="s1">fs_page_size</span><span class="s4">=</span><span class="s1">fsp</span><span class="s4">):</span>
            <span class="s3">pass</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">'r'</span><span class="s4">, </span><span class="s1">page_buf_size</span><span class="s4">=</span><span class="s1">pbs</span><span class="s4">-</span><span class="s7">1</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">fapl </span><span class="s4">= </span><span class="s1">f</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fapl</span><span class="s4">.</span><span class="s1">get_page_buffer_size</span><span class="s4">()[</span><span class="s7">0</span><span class="s4">], </span><span class="s1">fsp</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestModes</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: File mode can be retrieved via file.mode 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_mode_attr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Mode equivalent can be retrieved via property &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">mode</span><span class="s4">, </span><span class="s5">'r+'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">mode</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_mode_external</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Mode property works for files opened via external links 
 
        Issue 190. 
        &quot;&quot;&quot;</span>
        <span class="s1">fname1 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fname2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>

        <span class="s1">f1 </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname1</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">f1</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">f2 </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname2</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">f2</span><span class="s4">[</span><span class="s5">'External'</span><span class="s4">] = </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">fname1</span><span class="s4">, </span><span class="s5">'/'</span><span class="s4">)</span>
            <span class="s1">f3 </span><span class="s4">= </span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'External'</span><span class="s4">].</span><span class="s1">file</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f3</span><span class="s4">.</span><span class="s1">mode</span><span class="s4">, </span><span class="s5">'r+'</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">f2</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
            <span class="s1">f3</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">f2 </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname2</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">f3 </span><span class="s4">= </span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'External'</span><span class="s4">].</span><span class="s1">file</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f3</span><span class="s4">.</span><span class="s1">mode</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">f2</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
            <span class="s1">f3</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestDrivers</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Files can be opened with low-level HDF5 drivers. Does not 
        include MPI drivers (see bottom). 
    &quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipUnless</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">name </span><span class="s4">== </span><span class="s5">'posix'</span><span class="s4">, </span><span class="s5">&quot;Stdio driver is supported on posix&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_stdio</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Stdio driver is supported on posix &quot;&quot;&quot;</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'stdio'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'stdio'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s0"># Testing creation with append flag</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'stdio'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'stdio'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipUnless</span><span class="s4">(</span><span class="s1">direct_vfd</span><span class="s4">,</span>
                   <span class="s5">&quot;DIRECT driver is supported on Linux if hdf5 is &quot;</span>
                   <span class="s5">&quot;built with the appriorate flags.&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_direct</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; DIRECT driver is supported on Linux&quot;&quot;&quot;</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'direct'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'direct'</span><span class="s4">)</span>
        <span class="s1">default_fapl </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_fapl_direct</span><span class="s4">()</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s0"># Testing creation with append flag</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'direct'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'direct'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s0"># 2022/02/26: hnmaarrfk</span>
        <span class="s0"># I'm actually not too sure of the restriction on the</span>
        <span class="s0"># different valid block_sizes and cbuf_sizes on different hardware</span>
        <span class="s0"># platforms.</span>
        <span class="s0">#</span>
        <span class="s0"># I've learned a few things:</span>
        <span class="s0">#    * cbuf_size: Copy buffer size must be a multiple of block size</span>
        <span class="s0"># The alignment (on my platform x86-64bit with an NVMe SSD</span>
        <span class="s0"># could be an integer multiple of 512</span>
        <span class="s0">#</span>
        <span class="s0"># To allow HDF5 to do the heavy lifting for different platform,</span>
        <span class="s0"># We didn't provide any arguments to the first call</span>
        <span class="s0"># and obtained HDF5's default values there.</span>

        <span class="s0"># Testing creation with a few different property lists</span>
        <span class="s3">for </span><span class="s1">alignment</span><span class="s4">, </span><span class="s1">block_size</span><span class="s4">, </span><span class="s1">cbuf_size </span><span class="s3">in </span><span class="s4">[</span>
                <span class="s1">default_fapl</span><span class="s4">,</span>
                <span class="s4">(</span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">0</span><span class="s4">], </span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">1</span><span class="s4">], </span><span class="s7">3 </span><span class="s4">* </span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]),</span>
                <span class="s4">(</span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] * </span><span class="s7">2</span><span class="s4">, </span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">1</span><span class="s4">], </span><span class="s7">3 </span><span class="s4">* </span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]),</span>
                <span class="s4">(</span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">0</span><span class="s4">], </span><span class="s7">2 </span><span class="s4">* </span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">1</span><span class="s4">], </span><span class="s7">6 </span><span class="s4">* </span><span class="s1">default_fapl</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]),</span>
                <span class="s4">]:</span>
            <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'direct'</span><span class="s4">,</span>
                      <span class="s1">alignment</span><span class="s4">=</span><span class="s1">alignment</span><span class="s4">,</span>
                      <span class="s1">block_size</span><span class="s4">=</span><span class="s1">block_size</span><span class="s4">,</span>
                      <span class="s1">cbuf_size</span><span class="s4">=</span><span class="s1">cbuf_size</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fid</span><span class="s4">:</span>
                <span class="s1">actual_fapl </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_fapl_direct</span><span class="s4">()</span>
                <span class="s1">actual_alignment </span><span class="s4">= </span><span class="s1">actual_fapl</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]</span>
                <span class="s1">actual_block_size </span><span class="s4">= </span><span class="s1">actual_fapl</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]</span>
                <span class="s1">actual_cbuf_size </span><span class="s4">= </span><span class="s1">actual_fapl</span><span class="s4">[</span><span class="s7">2</span><span class="s4">]</span>
                <span class="s3">assert </span><span class="s1">actual_alignment </span><span class="s4">== </span><span class="s1">alignment</span>
                <span class="s3">assert </span><span class="s1">actual_block_size </span><span class="s4">== </span><span class="s1">block_size</span>
                <span class="s3">assert </span><span class="s1">actual_cbuf_size </span><span class="s4">== </span><span class="s1">actual_cbuf_size</span>

    <span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipUnless</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">name </span><span class="s4">== </span><span class="s5">'posix'</span><span class="s4">, </span><span class="s5">&quot;Sec2 driver is supported on posix&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_sec2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Sec2 driver is supported on posix &quot;&quot;&quot;</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'sec2'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'sec2'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s0"># Testing creation with append flag</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'sec2'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'sec2'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_core</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Core driver is supported (no backing store) &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'core'</span><span class="s4">, </span><span class="s1">backing_store</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'core'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">))</span>

        <span class="s0"># Testing creation with append flag</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'core'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'core'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_backing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Core driver saves to file when backing store used &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'core'</span><span class="s4">, </span><span class="s1">backing_store</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s5">'foo' </span><span class="s3">in </span><span class="s1">fid</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s0"># keywords for other drivers are invalid when using the default driver</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">backing_store</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_readonly</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Core driver can be used to open existing files &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'core'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s5">'foo' </span><span class="s3">in </span><span class="s1">fid</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_blocksize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Core driver supports variable block size &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'core'</span><span class="s4">, </span><span class="s1">block_size</span><span class="s4">=</span><span class="s7">1024</span><span class="s4">,</span>
                   <span class="s1">backing_store</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_split</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Split stores metadata in a separate file &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'split'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">(</span><span class="s1">fname </span><span class="s4">+ </span><span class="s5">'-m.h5'</span><span class="s4">))</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'split'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_fileobj</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Python file object driver is supported &quot;&quot;&quot;</span>
        <span class="s1">tf </span><span class="s4">= </span><span class="s1">tempfile</span><span class="s4">.</span><span class="s1">TemporaryFile</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">tf</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'fileobj'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">driver</span><span class="s4">, </span><span class="s5">'fileobj'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s0"># Driver must be 'fileobj' for file-like object if specified</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">tf</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'core'</span><span class="s4">)</span>

    <span class="s0"># TODO: family driver tests</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] % </span><span class="s7">2 </span><span class="s4">!= </span><span class="s7">0 </span><span class="s4">,</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">'Not HDF5 release version'</span>
<span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestNewLibver</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: File format compatibility bounds can be specified when 
        opening a file. 
    &quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">setUpClass</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">setUpClass</span><span class="s4">()</span>

        <span class="s0"># Current latest library bound label</span>
        <span class="s3">if </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&lt; (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">11</span><span class="s4">, </span><span class="s7">4</span><span class="s4">):</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">latest </span><span class="s4">= </span><span class="s5">'v110'</span>
        <span class="s3">elif </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&lt; (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">13</span><span class="s4">, </span><span class="s7">0</span><span class="s4">):</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">latest </span><span class="s4">= </span><span class="s5">'v112'</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">latest </span><span class="s4">= </span><span class="s5">'v114'</span>

    <span class="s3">def </span><span class="s1">test_default</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening with no libver arg &quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">libver</span><span class="s4">, (</span><span class="s5">'earliest'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">latest</span><span class="s4">))</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_single</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening with single libver arg &quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">libver</span><span class="s4">=</span><span class="s5">'latest'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">libver</span><span class="s4">, (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">latest</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">latest</span><span class="s4">))</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_single_v108</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening with &quot;v108&quot; libver arg &quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">libver</span><span class="s4">=</span><span class="s5">'v108'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">libver</span><span class="s4">, (</span><span class="s5">'v108'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">latest</span><span class="s4">))</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_single_v110</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening with &quot;v110&quot; libver arg &quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">libver</span><span class="s4">=</span><span class="s5">'v110'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">libver</span><span class="s4">, (</span><span class="s5">'v110'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">latest</span><span class="s4">))</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&lt; (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">11</span><span class="s4">, </span><span class="s7">4</span><span class="s4">),</span>
               <span class="s5">'Requires HDF5 1.11.4 or later'</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_single_v112</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening with &quot;v112&quot; libver arg &quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">libver</span><span class="s4">=</span><span class="s5">'v112'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">libver</span><span class="s4">, (</span><span class="s5">'v112'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">latest</span><span class="s4">))</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_multiple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening with two libver args &quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">libver</span><span class="s4">=(</span><span class="s5">'earliest'</span><span class="s4">, </span><span class="s5">'v108'</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">libver</span><span class="s4">, (</span><span class="s5">'earliest'</span><span class="s4">, </span><span class="s5">'v108'</span><span class="s4">))</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_none</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Omitting libver arg results in maximum compatibility &quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">libver</span><span class="s4">, (</span><span class="s5">'earliest'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">latest</span><span class="s4">))</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestUserblock</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Files can be create with user blocks 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create_blocksize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; User blocks created with w, w-, x and properties work correctly &quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w-'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">userblock_size</span><span class="s4">, </span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'x'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">userblock_size</span><span class="s4">, </span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">userblock_size</span><span class="s4">, </span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s0"># User block size must be an integer</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s5">'non'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_write_only</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; User block only allowed for write &quot;&quot;&quot;</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">512</span><span class="s4">)</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'r+'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">512</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_match_existing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; User block size must match that of file when opening for append &quot;&quot;&quot;</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">512</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">1024</span><span class="s4">)</span>

        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">userblock_size</span><span class="s4">, </span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_power_of_two</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; User block size must be a power of 2 and at least 512 &quot;&quot;&quot;</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">128</span><span class="s4">)</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">513</span><span class="s4">)</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">1023</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_write_block</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Test that writing to a user block does not destroy the file &quot;&quot;&quot;</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>

        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">userblock_size</span><span class="s4">=</span><span class="s7">512</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;Foobar&quot;</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">pyfile </span><span class="s4">= </span><span class="s1">open</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'r+b'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">pyfile</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s6">b'X' </span><span class="s4">* </span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">pyfile</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s5">&quot;Foobar&quot; </span><span class="s3">in </span><span class="s1">f</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">pyfile </span><span class="s4">= </span><span class="s1">open</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'rb'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">pyfile</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s7">512</span><span class="s4">), </span><span class="s6">b'X' </span><span class="s4">* </span><span class="s7">512</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">pyfile</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestContextManager</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: File objects can be used as context managers 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_context_manager</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; File objects can be used in with statements &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fid</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s3">not </span><span class="s1">fid</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s3">not </span><span class="s1">UNICODE_FILENAMES</span><span class="s4">, </span><span class="s5">&quot;Filesystem unicode support required&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestUnicode</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Unicode filenames are supported 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_unicode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Unicode filenames can be used, and retrieved properly via .filename 
        &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(</span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">chr</span><span class="s4">(</span><span class="s7">0x201a</span><span class="s4">))</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">fname</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">str</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_unicode_hdf5_python_consistent</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Unicode filenames can be used, and seen correctly from python 
        &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(</span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">chr</span><span class="s4">(</span><span class="s7">0x201a</span><span class="s4">))</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_nonexistent_file_unicode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; 
        Modes 'r' and 'r+' do not create files even when given unicode names 
        &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(</span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">chr</span><span class="s4">(</span><span class="s7">0x201a</span><span class="s4">))</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
            <span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r+'</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestFileProperty</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: A File object can be retrieved from any child object, 
        via the .file property 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_property</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; File object can be retrieved from subgroup &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">hfile </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">hfile2 </span><span class="s4">= </span><span class="s1">hfile</span><span class="s4">[</span><span class="s5">'/'</span><span class="s4">].</span><span class="s1">file</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">hfile</span><span class="s4">, </span><span class="s1">hfile2</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">hfile</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_close</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; All retrieved File objects are closed at the same time &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">hfile </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">hfile</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">hfile2 </span><span class="s4">= </span><span class="s1">grp</span><span class="s4">.</span><span class="s1">file</span>
        <span class="s1">hfile3 </span><span class="s4">= </span><span class="s1">hfile</span><span class="s4">[</span><span class="s5">'/'</span><span class="s4">].</span><span class="s1">file</span>
        <span class="s1">hfile2</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">hfile</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">hfile2</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">hfile3</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_mode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Retrieved File objects have a meaningful mode attribute &quot;&quot;&quot;</span>
        <span class="s1">hfile </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">grp </span><span class="s4">= </span><span class="s1">hfile</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">.</span><span class="s1">file</span><span class="s4">.</span><span class="s1">mode</span><span class="s4">, </span><span class="s1">hfile</span><span class="s4">.</span><span class="s1">mode</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">hfile</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestClose</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Files can be closed 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_close</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Close file via .close method &quot;&quot;&quot;</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_closed_file</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Trying to modify closed file raises ValueError &quot;&quot;&quot;</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_close_multiple_default_driver</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;test&quot;</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestFlush</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Files can be flushed 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_flush</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Flush via .flush method &quot;&quot;&quot;</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">flush</span><span class="s4">()</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestRepr</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: File objects provide a helpful __repr__ string 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_repr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; __repr__ behaves itself when files are open and closed &quot;&quot;&quot;</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestFilename</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: The name of a File object can be retrieved via .filename 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_filename</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; .filename behaves properly for string data &quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">fname</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">fid</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">str</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestCloseInvalidatesOpenObjectIDs</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Ensure that closing a file invalidates object IDs, as appropriate 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_close</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Closing a file invalidates any of the file's open objects &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f1</span><span class="s4">:</span>
            <span class="s1">g1 </span><span class="s4">= </span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">id</span><span class="s4">))</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">g1</span><span class="s4">.</span><span class="s1">id</span><span class="s4">))</span>
            <span class="s1">f1</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">id</span><span class="s4">))</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">g1</span><span class="s4">.</span><span class="s1">id</span><span class="s4">))</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f2</span><span class="s4">:</span>
            <span class="s1">g2 </span><span class="s4">= </span><span class="s1">f2</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">f2</span><span class="s4">.</span><span class="s1">id</span><span class="s4">))</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">g2</span><span class="s4">.</span><span class="s1">id</span><span class="s4">))</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">id</span><span class="s4">))</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">g1</span><span class="s4">.</span><span class="s1">id</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_close_one_handle</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>

        <span class="s1">f1 </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">)</span>
        <span class="s1">f2 </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">)</span>
        <span class="s1">g1 </span><span class="s4">= </span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s1">g2 </span><span class="s4">= </span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s3">assert </span><span class="s1">g1</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">valid</span>
        <span class="s3">assert </span><span class="s1">g2</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">valid</span>
        <span class="s1">f1</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s3">assert not </span><span class="s1">g1</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">valid</span>
        <span class="s0"># Closing f1 shouldn't close f2 or objects belonging to it</span>
        <span class="s3">assert </span><span class="s1">f2</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">valid</span>
        <span class="s3">assert </span><span class="s1">g2</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">valid</span>

        <span class="s1">f2</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s3">assert not </span><span class="s1">f2</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">valid</span>
        <span class="s3">assert not </span><span class="s1">g2</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">valid</span>


<span class="s3">class </span><span class="s1">TestPathlibSupport</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Check that h5py doesn't break on pathlib 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">test_pathlib_accepted_file</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Check that pathlib is accepted by h5py.File &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">closed_tempfile</span><span class="s4">() </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">path </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
            <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">path</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f2</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_pathlib_name_match</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Check that using pathlib does not affect naming &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">closed_tempfile</span><span class="s4">() </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">path </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
            <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">path</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">h5f1</span><span class="s4">:</span>
                <span class="s1">pathlib_name </span><span class="s4">= </span><span class="s1">h5f1</span><span class="s4">.</span><span class="s1">filename</span>
            <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">h5f2</span><span class="s4">:</span>
                <span class="s1">normal_name </span><span class="s4">= </span><span class="s1">h5f2</span><span class="s4">.</span><span class="s1">filename</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">pathlib_name</span><span class="s4">, </span><span class="s1">normal_name</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestPickle</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Check that h5py.File can't be pickled&quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">test_dump_error</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f1</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
                <span class="s1">pickle</span><span class="s4">.</span><span class="s1">dumps</span><span class="s4">(</span><span class="s1">f1</span><span class="s4">)</span>


<span class="s0"># unittest doesn't work with pytest fixtures (and possibly other features),</span>
<span class="s0"># hence no subclassing TestCase</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">mpi</span>
<span class="s3">class </span><span class="s1">TestMPI</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">test_mpio</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mpi_file_name</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; MPIO driver and options &quot;&quot;&quot;</span>
        <span class="s3">from </span><span class="s1">mpi4py </span><span class="s3">import </span><span class="s1">MPI</span>

        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">mpi_file_name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'mpio'</span><span class="s4">, </span><span class="s1">comm</span><span class="s4">=</span><span class="s1">MPI</span><span class="s4">.</span><span class="s1">COMM_WORLD</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">f</span>
            <span class="s3">assert </span><span class="s1">f</span><span class="s4">.</span><span class="s1">driver </span><span class="s4">== </span><span class="s5">'mpio'</span>

    <span class="s3">def </span><span class="s1">test_mpio_append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mpi_file_name</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Testing creation of file with append &quot;&quot;&quot;</span>
        <span class="s3">from </span><span class="s1">mpi4py </span><span class="s3">import </span><span class="s1">MPI</span>

        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">mpi_file_name</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'mpio'</span><span class="s4">, </span><span class="s1">comm</span><span class="s4">=</span><span class="s1">MPI</span><span class="s4">.</span><span class="s1">COMM_WORLD</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">f</span>
            <span class="s3">assert </span><span class="s1">f</span><span class="s4">.</span><span class="s1">driver </span><span class="s4">== </span><span class="s5">'mpio'</span>

    <span class="s3">def </span><span class="s1">test_mpi_atomic</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mpi_file_name</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Enable atomic mode for MPIO driver &quot;&quot;&quot;</span>
        <span class="s3">from </span><span class="s1">mpi4py </span><span class="s3">import </span><span class="s1">MPI</span>

        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">mpi_file_name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'mpio'</span><span class="s4">, </span><span class="s1">comm</span><span class="s4">=</span><span class="s1">MPI</span><span class="s4">.</span><span class="s1">COMM_WORLD</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s3">assert not </span><span class="s1">f</span><span class="s4">.</span><span class="s1">atomic</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">atomic </span><span class="s4">= </span><span class="s3">True</span>
            <span class="s3">assert </span><span class="s1">f</span><span class="s4">.</span><span class="s1">atomic</span>

    <span class="s3">def </span><span class="s1">test_close_multiple_mpio_driver</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">mpi_file_name</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; MPIO driver and options &quot;&quot;&quot;</span>
        <span class="s3">from </span><span class="s1">mpi4py </span><span class="s3">import </span><span class="s1">MPI</span>

        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">mpi_file_name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">driver</span><span class="s4">=</span><span class="s5">'mpio'</span><span class="s4">, </span><span class="s1">comm</span><span class="s4">=</span><span class="s1">MPI</span><span class="s4">.</span><span class="s1">COMM_WORLD</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;test&quot;</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestSWMRMode</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Create file that switches on SWMR mode 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_file_mode_generalizes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">libver</span><span class="s4">=</span><span class="s5">'latest'</span><span class="s4">)</span>
        <span class="s1">g </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s0"># fid and group member file attribute should have the same mode</span>
        <span class="s3">assert </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">mode </span><span class="s4">== </span><span class="s1">g</span><span class="s4">.</span><span class="s1">file</span><span class="s4">.</span><span class="s1">mode </span><span class="s4">== </span><span class="s5">'r+'</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">swmr_mode </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s0"># fid and group member file attribute should still be 'r+'</span>
        <span class="s0"># even though file intent has changed</span>
        <span class="s3">assert </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">mode </span><span class="s4">== </span><span class="s1">g</span><span class="s4">.</span><span class="s1">file</span><span class="s4">.</span><span class="s1">mode </span><span class="s4">== </span><span class="s5">'r+'</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_swmr_mode_consistency</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">fid </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">, </span><span class="s1">libver</span><span class="s4">=</span><span class="s5">'latest'</span><span class="s4">)</span>
        <span class="s1">g </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">swmr_mode </span><span class="s4">== </span><span class="s1">g</span><span class="s4">.</span><span class="s1">file</span><span class="s4">.</span><span class="s1">swmr_mode </span><span class="s4">== </span><span class="s3">False</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">swmr_mode </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s0"># This setter should affect both fid and group member file attribute</span>
        <span class="s3">assert </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">swmr_mode </span><span class="s4">== </span><span class="s1">g</span><span class="s4">.</span><span class="s1">file</span><span class="s4">.</span><span class="s1">swmr_mode </span><span class="s4">== </span><span class="s3">True</span>
        <span class="s1">fid</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span>
    <span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&lt; (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">12</span><span class="s4">, </span><span class="s7">1</span><span class="s4">) </span><span class="s3">and </span><span class="s4">(</span>
    <span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple</span><span class="s4">[:</span><span class="s7">2</span><span class="s4">] != (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">10</span><span class="s4">) </span><span class="s3">or </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple</span><span class="s4">[</span><span class="s7">2</span><span class="s4">] &lt; </span><span class="s7">7</span><span class="s4">),</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Requires HDF5 &gt;= 1.12.1 or 1.10.x &gt;= 1.10.7&quot;</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">skipif</span><span class="s4">(</span><span class="s5">&quot;HDF5_USE_FILE_LOCKING&quot; </span><span class="s3">in </span><span class="s1">os</span><span class="s4">.</span><span class="s1">environ</span><span class="s4">,</span>
                    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;HDF5_USE_FILE_LOCKING env. var. is set&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestFileLocking</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Test h5py.File file locking option&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_reopen</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">tmp_path</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Test file locking when opening twice the same file&quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">tmp_path </span><span class="s4">/ </span><span class="s5">&quot;test.h5&quot;</span>

        <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;w&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s3">True</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">.</span><span class="s1">flush</span><span class="s4">()</span>

            <span class="s0"># Opening same file in same process without locking is expected to fail</span>
            <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
                <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;r&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s3">False</span><span class="s4">) </span><span class="s3">as </span><span class="s1">h5f_read</span><span class="s4">:</span>
                    <span class="s3">pass</span>

            <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;r&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s3">True</span><span class="s4">) </span><span class="s3">as </span><span class="s1">h5f_read</span><span class="s4">:</span>
                <span class="s3">pass</span>

            <span class="s3">if </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&lt; (</span><span class="s7">1</span><span class="s4">, </span><span class="s7">14</span><span class="s4">, </span><span class="s7">4</span><span class="s4">):</span>
                <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;r&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s5">'best-effort'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">h5f_read</span><span class="s4">:</span>
                    <span class="s3">pass</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">OSError</span><span class="s4">):</span>
                    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;r&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s5">'best-effort'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">h5f_read</span><span class="s4">:</span>
                        <span class="s3">pass</span>


    <span class="s3">def </span><span class="s1">test_unsupported_locking</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">tmp_path</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Test with erroneous file locking value&quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">tmp_path </span><span class="s4">/ </span><span class="s5">&quot;test.h5&quot;</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;r&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s5">'unsupported-value'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">h5f_read</span><span class="s4">:</span>
                <span class="s3">pass</span>

    <span class="s3">def </span><span class="s1">test_multiprocess</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">tmp_path</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Test file locking option from different concurrent processes&quot;&quot;&quot;</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">tmp_path </span><span class="s4">/ </span><span class="s5">&quot;test.h5&quot;</span>

        <span class="s3">def </span><span class="s1">open_in_subprocess</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">):</span>
            <span class="s2">&quot;&quot;&quot;Open HDF5 file in a subprocess and return True on success&quot;&quot;&quot;</span>
            <span class="s1">h5py_import_dir </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">__file__</span><span class="s4">).</span><span class="s1">parent</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">)</span>

            <span class="s1">process </span><span class="s4">= </span><span class="s1">subprocess</span><span class="s4">.</span><span class="s1">run</span><span class="s4">(</span>
                <span class="s4">[</span>
                    <span class="s1">sys</span><span class="s4">.</span><span class="s1">executable</span><span class="s4">,</span>
                    <span class="s5">&quot;-c&quot;</span><span class="s4">,</span>
                    <span class="s5">f&quot;&quot;&quot;</span>
<span class="s5">import sys</span>
<span class="s5">sys.path.insert(0, </span><span class="s3">{</span><span class="s1">h5py_import_dir</span><span class="s3">!r}</span><span class="s5">)</span>
<span class="s5">import h5py</span>
<span class="s5">f = h5py.File(</span><span class="s3">{</span><span class="s1">str</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span><span class="s3">!r}</span><span class="s5">, mode=</span><span class="s3">{</span><span class="s1">mode</span><span class="s3">!r}</span><span class="s5">, locking=</span><span class="s3">{</span><span class="s1">locking</span><span class="s3">}</span><span class="s5">)</span>
                    <span class="s5">&quot;&quot;&quot;</span><span class="s4">,</span>
                <span class="s4">],</span>
                <span class="s1">capture_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">process</span><span class="s4">.</span><span class="s1">returncode </span><span class="s4">== </span><span class="s7">0 </span><span class="s3">and not </span><span class="s1">process</span><span class="s4">.</span><span class="s1">stderr</span>

        <span class="s0"># Create test file</span>
        <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;w&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s3">True</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">f</span><span class="s4">[</span><span class="s5">&quot;data&quot;</span><span class="s4">] = </span><span class="s7">1</span>

        <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;r&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s3">False</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s0"># Opening in write mode with locking is expected to work</span>
            <span class="s3">assert </span><span class="s1">open_in_subprocess</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s5">&quot;w&quot;</span><span class="s4">, </span><span class="s1">locking</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_close_gc</span><span class="s4">(</span><span class="s1">writable_file</span><span class="s4">):</span>
    <span class="s0"># https://github.com/h5py/h5py/issues/1852</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s7">100</span><span class="s4">):</span>
        <span class="s1">writable_file</span><span class="s4">[</span><span class="s1">str</span><span class="s4">(</span><span class="s1">i</span><span class="s4">)] = []</span>

    <span class="s1">filename </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">filename</span>
    <span class="s1">writable_file</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s0"># Ensure that Python's garbage collection doesn't interfere with closing</span>
    <span class="s0"># a file. Try a few times - the problem is not 100% consistent, but</span>
    <span class="s0"># normally showed up on the 1st or 2nd iteration for me. -TAK, 2021</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s7">10</span><span class="s4">):</span>
        <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">refs </span><span class="s4">= [</span><span class="s1">d</span><span class="s4">.</span><span class="s1">id </span><span class="s3">for </span><span class="s1">d </span><span class="s3">in </span><span class="s1">f</span><span class="s4">.</span><span class="s1">values</span><span class="s4">()]</span>
            <span class="s1">refs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">refs</span><span class="s4">)   </span><span class="s0"># Make a reference cycle so GC is involved</span>
            <span class="s3">del </span><span class="s1">refs  </span><span class="s0"># GC is likely to fire while closing the file</span>
</pre>
</body>
</html>