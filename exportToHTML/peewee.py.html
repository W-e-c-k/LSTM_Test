<html>
<head>
<title>peewee.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
peewee.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">bisect </span><span class="s0">import </span><span class="s1">bisect_left</span>
<span class="s0">from </span><span class="s1">bisect </span><span class="s0">import </span><span class="s1">bisect_right</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">contextmanager</span>
<span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">deepcopy</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">wraps</span>
<span class="s0">from </span><span class="s1">inspect </span><span class="s0">import </span><span class="s1">isclass</span>
<span class="s0">import </span><span class="s1">calendar</span>
<span class="s0">import </span><span class="s1">collections</span>
<span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">decimal</span>
<span class="s0">import </span><span class="s1">hashlib</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">logging</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">socket</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">uuid</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">Mapping</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">Mapping</span>

<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">pysqlite3 </span><span class="s0">import </span><span class="s1">dbapi2 </span><span class="s0">as </span><span class="s1">pysq3</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">pysqlite2 </span><span class="s0">import </span><span class="s1">dbapi2 </span><span class="s0">as </span><span class="s1">pysq3</span>
    <span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
        <span class="s1">pysq3 </span><span class="s2">= </span><span class="s0">None</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">sqlite3</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">sqlite3 </span><span class="s2">= </span><span class="s1">pysq3</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">if </span><span class="s1">pysq3 </span><span class="s0">and </span><span class="s1">pysq3</span><span class="s2">.</span><span class="s1">sqlite_version_info </span><span class="s2">&gt;= </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">sqlite_version_info</span><span class="s2">:</span>
        <span class="s1">sqlite3 </span><span class="s2">= </span><span class="s1">pysq3</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">psycopg2cffi </span><span class="s0">import </span><span class="s1">compat</span>
    <span class="s1">compat</span><span class="s2">.</span><span class="s1">register</span><span class="s2">()</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s0">pass</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">psycopg2</span>
    <span class="s0">from </span><span class="s1">psycopg2 </span><span class="s0">import </span><span class="s1">extensions </span><span class="s0">as </span><span class="s1">pg_extensions</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">psycopg2 </span><span class="s0">import </span><span class="s1">errors </span><span class="s0">as </span><span class="s1">pg_errors</span>
    <span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
        <span class="s1">pg_errors </span><span class="s2">= </span><span class="s0">None</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">psycopg2 </span><span class="s2">= </span><span class="s1">pg_errors </span><span class="s2">= </span><span class="s0">None</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">psycopg2</span><span class="s2">.</span><span class="s1">extras </span><span class="s0">import </span><span class="s1">register_uuid </span><span class="s0">as </span><span class="s1">pg_register_uuid</span>
    <span class="s1">pg_register_uuid</span><span class="s2">()</span>
<span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
    <span class="s0">pass</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">psycopg </span><span class="s0">import </span><span class="s1">errors </span><span class="s0">as </span><span class="s1">pg3_errors</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">pg3_errors </span><span class="s2">= </span><span class="s0">None</span>

<span class="s1">mysql_passwd </span><span class="s2">= </span><span class="s0">False</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">pymysql </span><span class="s0">as </span><span class="s1">mysql</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">import </span><span class="s1">MySQLdb </span><span class="s0">as </span><span class="s1">mysql</span>
        <span class="s1">mysql_passwd </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
        <span class="s1">mysql </span><span class="s2">= </span><span class="s0">None</span>


<span class="s1">__version__ </span><span class="s2">= </span><span class="s3">'3.17.6'</span>
<span class="s1">__all__ </span><span class="s2">= [</span>
    <span class="s3">'AnyField'</span><span class="s2">,</span>
    <span class="s3">'AsIs'</span><span class="s2">,</span>
    <span class="s3">'AutoField'</span><span class="s2">,</span>
    <span class="s3">'BareField'</span><span class="s2">,</span>
    <span class="s3">'BigAutoField'</span><span class="s2">,</span>
    <span class="s3">'BigBitField'</span><span class="s2">,</span>
    <span class="s3">'BigIntegerField'</span><span class="s2">,</span>
    <span class="s3">'BinaryUUIDField'</span><span class="s2">,</span>
    <span class="s3">'BitField'</span><span class="s2">,</span>
    <span class="s3">'BlobField'</span><span class="s2">,</span>
    <span class="s3">'BooleanField'</span><span class="s2">,</span>
    <span class="s3">'Case'</span><span class="s2">,</span>
    <span class="s3">'Cast'</span><span class="s2">,</span>
    <span class="s3">'CharField'</span><span class="s2">,</span>
    <span class="s3">'Check'</span><span class="s2">,</span>
    <span class="s3">'chunked'</span><span class="s2">,</span>
    <span class="s3">'Column'</span><span class="s2">,</span>
    <span class="s3">'CompositeKey'</span><span class="s2">,</span>
    <span class="s3">'Context'</span><span class="s2">,</span>
    <span class="s3">'Database'</span><span class="s2">,</span>
    <span class="s3">'DatabaseError'</span><span class="s2">,</span>
    <span class="s3">'DatabaseProxy'</span><span class="s2">,</span>
    <span class="s3">'DataError'</span><span class="s2">,</span>
    <span class="s3">'DateField'</span><span class="s2">,</span>
    <span class="s3">'DateTimeField'</span><span class="s2">,</span>
    <span class="s3">'DecimalField'</span><span class="s2">,</span>
    <span class="s3">'DeferredForeignKey'</span><span class="s2">,</span>
    <span class="s3">'DeferredThroughModel'</span><span class="s2">,</span>
    <span class="s3">'DJANGO_MAP'</span><span class="s2">,</span>
    <span class="s3">'DoesNotExist'</span><span class="s2">,</span>
    <span class="s3">'DoubleField'</span><span class="s2">,</span>
    <span class="s3">'DQ'</span><span class="s2">,</span>
    <span class="s3">'EXCLUDED'</span><span class="s2">,</span>
    <span class="s3">'Field'</span><span class="s2">,</span>
    <span class="s3">'FixedCharField'</span><span class="s2">,</span>
    <span class="s3">'FloatField'</span><span class="s2">,</span>
    <span class="s3">'fn'</span><span class="s2">,</span>
    <span class="s3">'ForeignKeyField'</span><span class="s2">,</span>
    <span class="s3">'IdentityField'</span><span class="s2">,</span>
    <span class="s3">'ImproperlyConfigured'</span><span class="s2">,</span>
    <span class="s3">'Index'</span><span class="s2">,</span>
    <span class="s3">'IntegerField'</span><span class="s2">,</span>
    <span class="s3">'IntegrityError'</span><span class="s2">,</span>
    <span class="s3">'InterfaceError'</span><span class="s2">,</span>
    <span class="s3">'InternalError'</span><span class="s2">,</span>
    <span class="s3">'IPField'</span><span class="s2">,</span>
    <span class="s3">'JOIN'</span><span class="s2">,</span>
    <span class="s3">'ManyToManyField'</span><span class="s2">,</span>
    <span class="s3">'Model'</span><span class="s2">,</span>
    <span class="s3">'ModelIndex'</span><span class="s2">,</span>
    <span class="s3">'MySQLDatabase'</span><span class="s2">,</span>
    <span class="s3">'NotSupportedError'</span><span class="s2">,</span>
    <span class="s3">'OP'</span><span class="s2">,</span>
    <span class="s3">'OperationalError'</span><span class="s2">,</span>
    <span class="s3">'PostgresqlDatabase'</span><span class="s2">,</span>
    <span class="s3">'PrimaryKeyField'</span><span class="s2">,  </span><span class="s4"># XXX: Deprecated, change to AutoField.</span>
    <span class="s3">'prefetch'</span><span class="s2">,</span>
    <span class="s3">'PREFETCH_TYPE'</span><span class="s2">,</span>
    <span class="s3">'ProgrammingError'</span><span class="s2">,</span>
    <span class="s3">'Proxy'</span><span class="s2">,</span>
    <span class="s3">'QualifiedNames'</span><span class="s2">,</span>
    <span class="s3">'SchemaManager'</span><span class="s2">,</span>
    <span class="s3">'SmallIntegerField'</span><span class="s2">,</span>
    <span class="s3">'Select'</span><span class="s2">,</span>
    <span class="s3">'SQL'</span><span class="s2">,</span>
    <span class="s3">'SqliteDatabase'</span><span class="s2">,</span>
    <span class="s3">'Table'</span><span class="s2">,</span>
    <span class="s3">'TextField'</span><span class="s2">,</span>
    <span class="s3">'TimeField'</span><span class="s2">,</span>
    <span class="s3">'TimestampField'</span><span class="s2">,</span>
    <span class="s3">'Tuple'</span><span class="s2">,</span>
    <span class="s3">'UUIDField'</span><span class="s2">,</span>
    <span class="s3">'Value'</span><span class="s2">,</span>
    <span class="s3">'ValuesList'</span><span class="s2">,</span>
    <span class="s3">'Window'</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s0">try</span><span class="s2">:  </span><span class="s4"># Python 2.7+</span>
    <span class="s0">from </span><span class="s1">logging </span><span class="s0">import </span><span class="s1">NullHandler</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s0">class </span><span class="s1">NullHandler</span><span class="s2">(</span><span class="s1">logging</span><span class="s2">.</span><span class="s1">Handler</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">emit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">record</span><span class="s2">):</span>
            <span class="s0">pass</span>

<span class="s1">logger </span><span class="s2">= </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s3">'peewee'</span><span class="s2">)</span>
<span class="s1">logger</span><span class="s2">.</span><span class="s1">addHandler</span><span class="s2">(</span><span class="s1">NullHandler</span><span class="s2">())</span>


<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s5">2</span><span class="s2">:</span>
    <span class="s1">text_type </span><span class="s2">= </span><span class="s1">unicode</span>
    <span class="s1">bytes_type </span><span class="s2">= </span><span class="s1">str</span>
    <span class="s1">buffer_type </span><span class="s2">= </span><span class="s1">buffer</span>
    <span class="s1">izip_longest </span><span class="s2">= </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">izip_longest</span>
    <span class="s1">callable_ </span><span class="s2">= </span><span class="s1">callable</span>
    <span class="s1">multi_types </span><span class="s2">= (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">frozenset</span><span class="s2">, </span><span class="s1">set</span><span class="s2">)</span>
    <span class="s1">exec</span><span class="s2">(</span><span class="s3">'def reraise(tp, value, tb=None): raise tp, value, tb'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">print_</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">)</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">builtins</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">Callable</span>
    <span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">Callable</span>
    <span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">reduce</span>
    <span class="s1">callable_ </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">c</span><span class="s2">: </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">Callable</span><span class="s2">)</span>
    <span class="s1">text_type </span><span class="s2">= </span><span class="s1">str</span>
    <span class="s1">bytes_type </span><span class="s2">= </span><span class="s1">bytes</span>
    <span class="s1">buffer_type </span><span class="s2">= </span><span class="s1">memoryview</span>
    <span class="s1">basestring </span><span class="s2">= </span><span class="s1">str</span>
    <span class="s1">long </span><span class="s2">= </span><span class="s1">int</span>
    <span class="s1">multi_types </span><span class="s2">= (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">frozenset</span><span class="s2">, </span><span class="s1">set</span><span class="s2">, </span><span class="s1">range</span><span class="s2">)</span>
    <span class="s1">print_ </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">builtins</span><span class="s2">, </span><span class="s3">'print'</span><span class="s2">)</span>
    <span class="s1">izip_longest </span><span class="s2">= </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">zip_longest</span>
    <span class="s0">def </span><span class="s1">reraise</span><span class="s2">(</span><span class="s1">tp</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">tb</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value</span><span class="s2">.</span><span class="s1">__traceback__ </span><span class="s0">is not </span><span class="s1">tb</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">value</span><span class="s2">.</span><span class="s1">with_traceback</span><span class="s2">(</span><span class="s1">tb</span><span class="s2">)</span>
        <span class="s0">raise </span><span class="s1">value</span>

<span class="s4"># Other compat issues.</span>
<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">12</span><span class="s2">):</span>
    <span class="s1">utcfromtimestamp </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">utcfromtimestamp</span>
    <span class="s1">utcnow </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">utcnow</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">utcfromtimestamp</span><span class="s2">(</span><span class="s1">ts</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span>
                <span class="s2">.</span><span class="s1">fromtimestamp</span><span class="s2">(</span><span class="s1">ts</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">timezone</span><span class="s2">.</span><span class="s1">utc</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">tzinfo</span><span class="s2">=</span><span class="s0">None</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">utcnow</span><span class="s2">():</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span>
                <span class="s2">.</span><span class="s1">now</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">timezone</span><span class="s2">.</span><span class="s1">utc</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">tzinfo</span><span class="s2">=</span><span class="s0">None</span><span class="s2">))</span>


<span class="s0">if </span><span class="s1">sqlite3</span><span class="s2">:</span>
    <span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">register_adapter</span><span class="s2">(</span><span class="s1">decimal</span><span class="s2">.</span><span class="s1">Decimal</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
    <span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">register_adapter</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">date</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
    <span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">register_adapter</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">time</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">12</span><span class="s2">):</span>
        <span class="s4"># We need to register datetime adapters as these are deprecated.</span>
        <span class="s0">def </span><span class="s1">datetime_adapter</span><span class="s2">(</span><span class="s1">d</span><span class="s2">): </span><span class="s0">return </span><span class="s1">d</span><span class="s2">.</span><span class="s1">isoformat</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">convert_date</span><span class="s2">(</span><span class="s1">d</span><span class="s2">): </span><span class="s0">return </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">date</span><span class="s2">(*</span><span class="s1">map</span><span class="s2">(</span><span class="s1">int</span><span class="s2">, </span><span class="s1">d</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">b'-'</span><span class="s2">)))</span>
        <span class="s0">def </span><span class="s1">convert_timestamp</span><span class="s2">(</span><span class="s1">t</span><span class="s2">):</span>
            <span class="s1">date</span><span class="s2">, </span><span class="s1">time </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">b' '</span><span class="s2">)</span>
            <span class="s1">y</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">d </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">int</span><span class="s2">, </span><span class="s1">date</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">b'-'</span><span class="s2">))</span>
            <span class="s1">t_full </span><span class="s2">= </span><span class="s1">time</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">b'.'</span><span class="s2">)</span>
            <span class="s1">hour</span><span class="s2">, </span><span class="s1">minute</span><span class="s2">, </span><span class="s1">second </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">int</span><span class="s2">, </span><span class="s1">t_full</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s6">b':'</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">t_full</span><span class="s2">) == </span><span class="s5">2</span><span class="s2">:</span>
                <span class="s1">usec </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s3">'{:0&lt;6.6}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">t_full</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">decode</span><span class="s2">()))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">usec </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s0">return </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">hour</span><span class="s2">, </span><span class="s1">minute</span><span class="s2">, </span><span class="s1">second</span><span class="s2">, </span><span class="s1">usec</span><span class="s2">)</span>
        <span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">register_adapter</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">, </span><span class="s1">datetime_adapter</span><span class="s2">)</span>
        <span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">register_converter</span><span class="s2">(</span><span class="s3">'date'</span><span class="s2">, </span><span class="s1">convert_date</span><span class="s2">)</span>
        <span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">register_converter</span><span class="s2">(</span><span class="s3">'timestamp'</span><span class="s2">, </span><span class="s1">convert_timestamp</span><span class="s2">)</span>

    <span class="s1">__sqlite_version__ </span><span class="s2">= </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">sqlite_version_info</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s1">__sqlite_version__ </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>


<span class="s1">__date_parts__ </span><span class="s2">= </span><span class="s1">set</span><span class="s2">((</span><span class="s3">'year'</span><span class="s2">, </span><span class="s3">'month'</span><span class="s2">, </span><span class="s3">'day'</span><span class="s2">, </span><span class="s3">'hour'</span><span class="s2">, </span><span class="s3">'minute'</span><span class="s2">, </span><span class="s3">'second'</span><span class="s2">))</span>

<span class="s4"># Sqlite does not support the `date_part` SQL function, so we will define an</span>
<span class="s4"># implementation in python.</span>
<span class="s1">__sqlite_datetime_formats__ </span><span class="s2">= (</span>
    <span class="s3">'%Y-%m-%d %H:%M:%S'</span><span class="s2">,</span>
    <span class="s3">'%Y-%m-%d %H:%M:%S.%f'</span><span class="s2">,</span>
    <span class="s3">'%Y-%m-%d'</span><span class="s2">,</span>
    <span class="s3">'%H:%M:%S'</span><span class="s2">,</span>
    <span class="s3">'%H:%M:%S.%f'</span><span class="s2">,</span>
    <span class="s3">'%H:%M'</span><span class="s2">)</span>

<span class="s1">__sqlite_date_trunc__ </span><span class="s2">= {</span>
    <span class="s3">'year'</span><span class="s2">: </span><span class="s3">'%Y-01-01 00:00:00'</span><span class="s2">,</span>
    <span class="s3">'month'</span><span class="s2">: </span><span class="s3">'%Y-%m-01 00:00:00'</span><span class="s2">,</span>
    <span class="s3">'day'</span><span class="s2">: </span><span class="s3">'%Y-%m-%d 00:00:00'</span><span class="s2">,</span>
    <span class="s3">'hour'</span><span class="s2">: </span><span class="s3">'%Y-%m-%d %H:00:00'</span><span class="s2">,</span>
    <span class="s3">'minute'</span><span class="s2">: </span><span class="s3">'%Y-%m-%d %H:%M:00'</span><span class="s2">,</span>
    <span class="s3">'second'</span><span class="s2">: </span><span class="s3">'%Y-%m-%d %H:%M:%S'</span><span class="s2">}</span>

<span class="s1">__mysql_date_trunc__ </span><span class="s2">= </span><span class="s1">__sqlite_date_trunc__</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
<span class="s1">__mysql_date_trunc__</span><span class="s2">[</span><span class="s3">'minute'</span><span class="s2">] = </span><span class="s3">'%Y-%m-%d %H:%i:00'</span>
<span class="s1">__mysql_date_trunc__</span><span class="s2">[</span><span class="s3">'second'</span><span class="s2">] = </span><span class="s3">'%Y-%m-%d %H:%i:%S'</span>

<span class="s0">def </span><span class="s1">_sqlite_date_part</span><span class="s2">(</span><span class="s1">lookup_type</span><span class="s2">, </span><span class="s1">datetime_string</span><span class="s2">):</span>
    <span class="s0">assert </span><span class="s1">lookup_type </span><span class="s0">in </span><span class="s1">__date_parts__</span>
    <span class="s0">if not </span><span class="s1">datetime_string</span><span class="s2">:</span>
        <span class="s0">return</span>
    <span class="s1">dt </span><span class="s2">= </span><span class="s1">format_date_time</span><span class="s2">(</span><span class="s1">datetime_string</span><span class="s2">, </span><span class="s1">__sqlite_datetime_formats__</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">lookup_type</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">_sqlite_date_trunc</span><span class="s2">(</span><span class="s1">lookup_type</span><span class="s2">, </span><span class="s1">datetime_string</span><span class="s2">):</span>
    <span class="s0">assert </span><span class="s1">lookup_type </span><span class="s0">in </span><span class="s1">__sqlite_date_trunc__</span>
    <span class="s0">if not </span><span class="s1">datetime_string</span><span class="s2">:</span>
        <span class="s0">return</span>
    <span class="s1">dt </span><span class="s2">= </span><span class="s1">format_date_time</span><span class="s2">(</span><span class="s1">datetime_string</span><span class="s2">, </span><span class="s1">__sqlite_datetime_formats__</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s1">__sqlite_date_trunc__</span><span class="s2">[</span><span class="s1">lookup_type</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">__deprecated__</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
    <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">DeprecationWarning</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">attrdict</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value</span><span class="s2">): </span><span class="s1">self</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">] = </span><span class="s1">value</span>
    <span class="s0">def </span><span class="s1">__iadd__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">): </span><span class="s1">self</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span><span class="s1">; </span><span class="s0">return </span><span class="s1">self</span>
    <span class="s0">def </span><span class="s1">__add__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">): </span><span class="s1">d </span><span class="s2">= </span><span class="s1">attrdict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s1">; d</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span><span class="s1">; </span><span class="s0">return </span><span class="s1">d</span>

<span class="s1">SENTINEL </span><span class="s2">= </span><span class="s1">object</span><span class="s2">()</span>

<span class="s4">#: Operations for use in SQL expressions.</span>
<span class="s1">OP </span><span class="s2">= </span><span class="s1">attrdict</span><span class="s2">(</span>
    <span class="s1">AND</span><span class="s2">=</span><span class="s3">'AND'</span><span class="s2">,</span>
    <span class="s1">OR</span><span class="s2">=</span><span class="s3">'OR'</span><span class="s2">,</span>
    <span class="s1">ADD</span><span class="s2">=</span><span class="s3">'+'</span><span class="s2">,</span>
    <span class="s1">SUB</span><span class="s2">=</span><span class="s3">'-'</span><span class="s2">,</span>
    <span class="s1">MUL</span><span class="s2">=</span><span class="s3">'*'</span><span class="s2">,</span>
    <span class="s1">DIV</span><span class="s2">=</span><span class="s3">'/'</span><span class="s2">,</span>
    <span class="s1">BIN_AND</span><span class="s2">=</span><span class="s3">'&amp;'</span><span class="s2">,</span>
    <span class="s1">BIN_OR</span><span class="s2">=</span><span class="s3">'|'</span><span class="s2">,</span>
    <span class="s1">XOR</span><span class="s2">=</span><span class="s3">'#'</span><span class="s2">,</span>
    <span class="s1">MOD</span><span class="s2">=</span><span class="s3">'%'</span><span class="s2">,</span>
    <span class="s1">EQ</span><span class="s2">=</span><span class="s3">'='</span><span class="s2">,</span>
    <span class="s1">LT</span><span class="s2">=</span><span class="s3">'&lt;'</span><span class="s2">,</span>
    <span class="s1">LTE</span><span class="s2">=</span><span class="s3">'&lt;='</span><span class="s2">,</span>
    <span class="s1">GT</span><span class="s2">=</span><span class="s3">'&gt;'</span><span class="s2">,</span>
    <span class="s1">GTE</span><span class="s2">=</span><span class="s3">'&gt;='</span><span class="s2">,</span>
    <span class="s1">NE</span><span class="s2">=</span><span class="s3">'!='</span><span class="s2">,</span>
    <span class="s1">IN</span><span class="s2">=</span><span class="s3">'IN'</span><span class="s2">,</span>
    <span class="s1">NOT_IN</span><span class="s2">=</span><span class="s3">'NOT IN'</span><span class="s2">,</span>
    <span class="s1">IS</span><span class="s2">=</span><span class="s3">'IS'</span><span class="s2">,</span>
    <span class="s1">IS_NOT</span><span class="s2">=</span><span class="s3">'IS NOT'</span><span class="s2">,</span>
    <span class="s1">LIKE</span><span class="s2">=</span><span class="s3">'LIKE'</span><span class="s2">,</span>
    <span class="s1">ILIKE</span><span class="s2">=</span><span class="s3">'ILIKE'</span><span class="s2">,</span>
    <span class="s1">BETWEEN</span><span class="s2">=</span><span class="s3">'BETWEEN'</span><span class="s2">,</span>
    <span class="s1">REGEXP</span><span class="s2">=</span><span class="s3">'REGEXP'</span><span class="s2">,</span>
    <span class="s1">IREGEXP</span><span class="s2">=</span><span class="s3">'IREGEXP'</span><span class="s2">,</span>
    <span class="s1">CONCAT</span><span class="s2">=</span><span class="s3">'||'</span><span class="s2">,</span>
    <span class="s1">BITWISE_NEGATION</span><span class="s2">=</span><span class="s3">'~'</span><span class="s2">)</span>

<span class="s4"># To support &quot;django-style&quot; double-underscore filters, create a mapping between</span>
<span class="s4"># operation name and operation code, e.g. &quot;__eq&quot; == OP.EQ.</span>
<span class="s1">DJANGO_MAP </span><span class="s2">= </span><span class="s1">attrdict</span><span class="s2">({</span>
    <span class="s3">'eq'</span><span class="s2">: </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">eq</span><span class="s2">,</span>
    <span class="s3">'lt'</span><span class="s2">: </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">lt</span><span class="s2">,</span>
    <span class="s3">'lte'</span><span class="s2">: </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">le</span><span class="s2">,</span>
    <span class="s3">'gt'</span><span class="s2">: </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">gt</span><span class="s2">,</span>
    <span class="s3">'gte'</span><span class="s2">: </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ge</span><span class="s2">,</span>
    <span class="s3">'ne'</span><span class="s2">: </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ne</span><span class="s2">,</span>
    <span class="s3">'in'</span><span class="s2">: </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">lshift</span><span class="s2">,</span>
    <span class="s3">'is'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">l</span><span class="s2">, </span><span class="s1">r</span><span class="s2">: </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IS</span><span class="s2">, </span><span class="s1">r</span><span class="s2">),</span>
    <span class="s3">'like'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">l</span><span class="s2">, </span><span class="s1">r</span><span class="s2">: </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">LIKE</span><span class="s2">, </span><span class="s1">r</span><span class="s2">),</span>
    <span class="s3">'ilike'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">l</span><span class="s2">, </span><span class="s1">r</span><span class="s2">: </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">ILIKE</span><span class="s2">, </span><span class="s1">r</span><span class="s2">),</span>
    <span class="s3">'regexp'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">l</span><span class="s2">, </span><span class="s1">r</span><span class="s2">: </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">REGEXP</span><span class="s2">, </span><span class="s1">r</span><span class="s2">),</span>
<span class="s2">})</span>

<span class="s4">#: Mapping of field type to the data-type supported by the database. Databases</span>
<span class="s4">#: may override or add to this list.</span>
<span class="s1">FIELD </span><span class="s2">= </span><span class="s1">attrdict</span><span class="s2">(</span>
    <span class="s1">AUTO</span><span class="s2">=</span><span class="s3">'INTEGER'</span><span class="s2">,</span>
    <span class="s1">BIGAUTO</span><span class="s2">=</span><span class="s3">'BIGINT'</span><span class="s2">,</span>
    <span class="s1">BIGINT</span><span class="s2">=</span><span class="s3">'BIGINT'</span><span class="s2">,</span>
    <span class="s1">BLOB</span><span class="s2">=</span><span class="s3">'BLOB'</span><span class="s2">,</span>
    <span class="s1">BOOL</span><span class="s2">=</span><span class="s3">'SMALLINT'</span><span class="s2">,</span>
    <span class="s1">CHAR</span><span class="s2">=</span><span class="s3">'CHAR'</span><span class="s2">,</span>
    <span class="s1">DATE</span><span class="s2">=</span><span class="s3">'DATE'</span><span class="s2">,</span>
    <span class="s1">DATETIME</span><span class="s2">=</span><span class="s3">'DATETIME'</span><span class="s2">,</span>
    <span class="s1">DECIMAL</span><span class="s2">=</span><span class="s3">'DECIMAL'</span><span class="s2">,</span>
    <span class="s1">DEFAULT</span><span class="s2">=</span><span class="s3">''</span><span class="s2">,</span>
    <span class="s1">DOUBLE</span><span class="s2">=</span><span class="s3">'REAL'</span><span class="s2">,</span>
    <span class="s1">FLOAT</span><span class="s2">=</span><span class="s3">'REAL'</span><span class="s2">,</span>
    <span class="s1">INT</span><span class="s2">=</span><span class="s3">'INTEGER'</span><span class="s2">,</span>
    <span class="s1">SMALLINT</span><span class="s2">=</span><span class="s3">'SMALLINT'</span><span class="s2">,</span>
    <span class="s1">TEXT</span><span class="s2">=</span><span class="s3">'TEXT'</span><span class="s2">,</span>
    <span class="s1">TIME</span><span class="s2">=</span><span class="s3">'TIME'</span><span class="s2">,</span>
    <span class="s1">UUID</span><span class="s2">=</span><span class="s3">'TEXT'</span><span class="s2">,</span>
    <span class="s1">UUIDB</span><span class="s2">=</span><span class="s3">'BLOB'</span><span class="s2">,</span>
    <span class="s1">VARCHAR</span><span class="s2">=</span><span class="s3">'VARCHAR'</span><span class="s2">)</span>

<span class="s4">#: Join helpers (for convenience) -- all join types are supported, this object</span>
<span class="s4">#: is just to help avoid introducing errors by using strings everywhere.</span>
<span class="s1">JOIN </span><span class="s2">= </span><span class="s1">attrdict</span><span class="s2">(</span>
    <span class="s1">INNER</span><span class="s2">=</span><span class="s3">'INNER JOIN'</span><span class="s2">,</span>
    <span class="s1">LEFT_OUTER</span><span class="s2">=</span><span class="s3">'LEFT OUTER JOIN'</span><span class="s2">,</span>
    <span class="s1">RIGHT_OUTER</span><span class="s2">=</span><span class="s3">'RIGHT OUTER JOIN'</span><span class="s2">,</span>
    <span class="s1">FULL</span><span class="s2">=</span><span class="s3">'FULL JOIN'</span><span class="s2">,</span>
    <span class="s1">FULL_OUTER</span><span class="s2">=</span><span class="s3">'FULL OUTER JOIN'</span><span class="s2">,</span>
    <span class="s1">CROSS</span><span class="s2">=</span><span class="s3">'CROSS JOIN'</span><span class="s2">,</span>
    <span class="s1">NATURAL</span><span class="s2">=</span><span class="s3">'NATURAL JOIN'</span><span class="s2">,</span>
    <span class="s1">LATERAL</span><span class="s2">=</span><span class="s3">'LATERAL'</span><span class="s2">,</span>
    <span class="s1">LEFT_LATERAL</span><span class="s2">=</span><span class="s3">'LEFT JOIN LATERAL'</span><span class="s2">)</span>

<span class="s4"># Row representations.</span>
<span class="s1">ROW </span><span class="s2">= </span><span class="s1">attrdict</span><span class="s2">(</span>
    <span class="s1">TUPLE</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
    <span class="s1">DICT</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
    <span class="s1">NAMED_TUPLE</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
    <span class="s1">CONSTRUCTOR</span><span class="s2">=</span><span class="s5">4</span><span class="s2">,</span>
    <span class="s1">MODEL</span><span class="s2">=</span><span class="s5">5</span><span class="s2">)</span>

<span class="s4"># Query type to use with prefetch</span>
<span class="s1">PREFETCH_TYPE </span><span class="s2">= </span><span class="s1">attrdict</span><span class="s2">(</span>
    <span class="s1">WHERE</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
    <span class="s1">JOIN</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>

<span class="s1">SCOPE_NORMAL </span><span class="s2">= </span><span class="s5">1</span>
<span class="s1">SCOPE_SOURCE </span><span class="s2">= </span><span class="s5">2</span>
<span class="s1">SCOPE_VALUES </span><span class="s2">= </span><span class="s5">4</span>
<span class="s1">SCOPE_CTE </span><span class="s2">= </span><span class="s5">8</span>
<span class="s1">SCOPE_COLUMN </span><span class="s2">= </span><span class="s5">16</span>

<span class="s4"># Rules for parentheses around subqueries in compound select.</span>
<span class="s1">CSQ_PARENTHESES_NEVER </span><span class="s2">= </span><span class="s5">0</span>
<span class="s1">CSQ_PARENTHESES_ALWAYS </span><span class="s2">= </span><span class="s5">1</span>
<span class="s1">CSQ_PARENTHESES_UNNESTED </span><span class="s2">= </span><span class="s5">2</span>

<span class="s4"># Regular expressions used to convert class names to snake-case table names.</span>
<span class="s4"># First regex handles acronym followed by word or initial lower-word followed</span>
<span class="s4"># by a capitalized word. e.g. APIResponse -&gt; API_Response / fooBar -&gt; foo_Bar.</span>
<span class="s4"># Second regex handles the normal case of two title-cased words.</span>
<span class="s1">SNAKE_CASE_STEP1 </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s3">'(.)_*([A-Z][a-z]+)'</span><span class="s2">)</span>
<span class="s1">SNAKE_CASE_STEP2 </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s3">'([a-z0-9])_*([A-Z])'</span><span class="s2">)</span>

<span class="s4"># Helper functions that are used in various parts of the codebase.</span>
<span class="s1">MODEL_BASE </span><span class="s2">= </span><span class="s3">'_metaclass_helper_'</span>

<span class="s0">def </span><span class="s1">with_metaclass</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">, </span><span class="s1">base</span><span class="s2">=</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">meta</span><span class="s2">(</span><span class="s1">MODEL_BASE</span><span class="s2">, (</span><span class="s1">base</span><span class="s2">,), {})</span>

<span class="s0">def </span><span class="s1">merge_dict</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">overrides</span><span class="s2">):</span>
    <span class="s1">merged </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">overrides</span><span class="s2">:</span>
        <span class="s1">merged</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">overrides</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">merged</span>

<span class="s0">def </span><span class="s1">quote</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">quote_chars</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) == </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">path</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">join</span><span class="s2">(</span><span class="s1">quote_chars</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s3">'.'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s1">part</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">quote_chars</span><span class="s2">) </span><span class="s0">for </span><span class="s1">part </span><span class="s0">in </span><span class="s1">path</span><span class="s2">])</span>

<span class="s1">is_model </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">o</span><span class="s2">: </span><span class="s1">isclass</span><span class="s2">(</span><span class="s1">o</span><span class="s2">) </span><span class="s0">and </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">o</span><span class="s2">, </span><span class="s1">Model</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">value </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)) </span><span class="s0">else </span><span class="s2">(</span><span class="s1">value</span><span class="s2">,)</span>

<span class="s0">def </span><span class="s1">ensure_entity</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">value </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">) </span><span class="s0">else </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">make_snake_case</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
    <span class="s1">first </span><span class="s2">= </span><span class="s1">SNAKE_CASE_STEP1</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span><span class="s3">r'\1_\2'</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">SNAKE_CASE_STEP2</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span><span class="s3">r'\1_\2'</span><span class="s2">, </span><span class="s1">first</span><span class="s2">).</span><span class="s1">lower</span><span class="s2">()</span>

<span class="s0">def </span><span class="s1">chunked</span><span class="s2">(</span><span class="s1">it</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
    <span class="s1">marker </span><span class="s2">= </span><span class="s1">object</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">group </span><span class="s0">in </span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">g</span><span class="s2">) </span><span class="s0">for </span><span class="s1">g </span><span class="s0">in </span><span class="s1">izip_longest</span><span class="s2">(*[</span><span class="s1">iter</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)] * </span><span class="s1">n</span><span class="s2">,</span>
                                                <span class="s1">fillvalue</span><span class="s2">=</span><span class="s1">marker</span><span class="s2">)):</span>
        <span class="s0">if </span><span class="s1">group</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] </span><span class="s0">is </span><span class="s1">marker</span><span class="s2">:</span>
            <span class="s0">del </span><span class="s1">group</span><span class="s2">[</span><span class="s1">group</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">marker</span><span class="s2">):]</span>
        <span class="s0">yield </span><span class="s1">group</span>


<span class="s0">class </span><span class="s1">_callable_context_manager</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>


<span class="s0">class </span><span class="s1">Proxy</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot; 
    Create a proxy or placeholder for another object. 
    &quot;&quot;&quot;</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'obj'</span><span class="s2">, </span><span class="s3">'_callbacks'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_callbacks </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">initialize</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">initialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">obj </span><span class="s2">= </span><span class="s1">obj</span>
        <span class="s0">for </span><span class="s1">callback </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_callbacks</span><span class="s2">:</span>
            <span class="s1">callback</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">attach_callback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_callbacks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">callback</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">callback</span>

    <span class="s0">def </span><span class="s1">passthrough</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'Cannot use uninitialized Proxy.'</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>

    <span class="s4"># Allow proxy to be used as a context-manager.</span>
    <span class="s1">__enter__ </span><span class="s2">= </span><span class="s1">passthrough</span><span class="s2">(</span><span class="s3">'__enter__'</span><span class="s2">)</span>
    <span class="s1">__exit__ </span><span class="s2">= </span><span class="s1">passthrough</span><span class="s2">(</span><span class="s3">'__exit__'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'Cannot use uninitialized Proxy.'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">attr </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__slots__</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'Cannot set attribute on proxy.'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">Proxy</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DatabaseProxy</span><span class="s2">(</span><span class="s1">Proxy</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot; 
    Proxy implementation specifically for proxying `Database` objects. 
    &quot;&quot;&quot;</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'obj'</span><span class="s2">, </span><span class="s3">'_callbacks'</span><span class="s2">, </span><span class="s3">'_Model'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">connection_context</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ConnectionContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">atomic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_atomic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">manual_commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_manual</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">savepoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_savepoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">Model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'_Model'</span><span class="s2">):</span>
            <span class="s0">class </span><span class="s1">Meta</span><span class="s2">: </span><span class="s1">database </span><span class="s2">= </span><span class="s1">self</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_Model </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s3">'BaseModel'</span><span class="s2">, (</span><span class="s1">Model</span><span class="s2">,), {</span><span class="s3">'Meta'</span><span class="s2">: </span><span class="s1">Meta</span><span class="s2">})</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_Model</span>


<span class="s0">class </span><span class="s1">ModelDescriptor</span><span class="s2">(</span><span class="s1">object</span><span class="s2">): </span><span class="s0">pass</span>


<span class="s4"># SQL Generation.</span>


<span class="s0">class </span><span class="s1">AliasManager</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'_counter'</span><span class="s2">, </span><span class="s3">'_current_index'</span><span class="s2">, </span><span class="s3">'_mapping'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># A list of dictionaries containing mappings at various depths.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_counter </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_current_index </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_mapping </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">mapping</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mapping</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_current_index </span><span class="s2">- </span><span class="s5">1</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">source </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mapping</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_counter </span><span class="s2">+= </span><span class="s5">1</span>
            <span class="s1">self</span><span class="s2">[</span><span class="s1">source</span><span class="s2">] = </span><span class="s3">'t%d' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_counter</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mapping</span><span class="s2">[</span><span class="s1">source</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">any_depth</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">any_depth</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_current_index</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s1">source </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mapping</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]:</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mapping</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">][</span><span class="s1">source</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">source</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">source</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">mapping</span><span class="s2">[</span><span class="s1">source</span><span class="s2">] = </span><span class="s1">alias</span>

    <span class="s0">def </span><span class="s1">push</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_current_index </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_current_index </span><span class="s2">&gt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mapping</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_mapping</span><span class="s2">.</span><span class="s1">append</span><span class="s2">({})</span>

    <span class="s0">def </span><span class="s1">pop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_current_index </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot pop() from empty alias manager.'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_current_index </span><span class="s2">-= </span><span class="s5">1</span>


<span class="s0">class </span><span class="s1">State</span><span class="s2">(</span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'_State'</span><span class="s2">, (</span><span class="s3">'scope'</span><span class="s2">, </span><span class="s3">'parentheses'</span><span class="s2">,</span>
                                              <span class="s3">'settings'</span><span class="s2">))):</span>
    <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">=</span><span class="s1">SCOPE_NORMAL</span><span class="s2">, </span><span class="s1">parentheses</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">State</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">).</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">, </span><span class="s1">parentheses</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">parentheses</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4"># Scope and settings are &quot;inherited&quot; (parentheses is not, however).</span>
        <span class="s1">scope </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope </span><span class="s0">if </span><span class="s1">scope </span><span class="s0">is None else </span><span class="s1">scope</span>

        <span class="s4"># Try to avoid unnecessary dict copying.</span>
        <span class="s0">if </span><span class="s1">kwargs </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">settings</span><span class="s2">:</span>
            <span class="s1">settings </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">settings</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()  </span><span class="s4"># Copy original settings dict.</span>
            <span class="s1">settings</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">)  </span><span class="s4"># Update copy with overrides.</span>
        <span class="s0">elif </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">settings </span><span class="s2">= </span><span class="s1">kwargs</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">settings </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">settings</span>
        <span class="s0">return </span><span class="s1">State</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">parentheses</span><span class="s2">, **</span><span class="s1">settings</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr_name</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">settings</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">attr_name</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">__scope_context__</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">scope</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">yield </span><span class="s1">self</span>
    <span class="s0">return </span><span class="s1">inner</span>


<span class="s0">class </span><span class="s1">Context</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'stack'</span><span class="s2">, </span><span class="s3">'_sql'</span><span class="s2">, </span><span class="s3">'_values'</span><span class="s2">, </span><span class="s3">'alias_manager'</span><span class="s2">, </span><span class="s3">'state'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">settings</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">stack </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_sql </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_values </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">alias_manager </span><span class="s2">= </span><span class="s1">AliasManager</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">State</span><span class="s2">(**</span><span class="s1">settings</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">as_new</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Context</span><span class="s2">(**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">settings</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">column_sort_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">item</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">scope</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">scope</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">parentheses</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">parentheses</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">subquery</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">subquery</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">overrides</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">overrides </span><span class="s0">and </span><span class="s1">overrides</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'scope'</span><span class="s2">) == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">:</span>
            <span class="s0">del </span><span class="s1">overrides</span><span class="s2">[</span><span class="s3">'scope'</span><span class="s2">]</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">(**</span><span class="s1">overrides</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s1">scope_normal </span><span class="s2">= </span><span class="s1">__scope_context__</span><span class="s2">(</span><span class="s1">SCOPE_NORMAL</span><span class="s2">)</span>
    <span class="s1">scope_source </span><span class="s2">= </span><span class="s1">__scope_context__</span><span class="s2">(</span><span class="s1">SCOPE_SOURCE</span><span class="s2">)</span>
    <span class="s1">scope_values </span><span class="s2">= </span><span class="s1">__scope_context__</span><span class="s2">(</span><span class="s1">SCOPE_VALUES</span><span class="s2">)</span>
    <span class="s1">scope_cte </span><span class="s2">= </span><span class="s1">__scope_context__</span><span class="s2">(</span><span class="s1">SCOPE_CTE</span><span class="s2">)</span>
    <span class="s1">scope_column </span><span class="s2">= </span><span class="s1">__scope_context__</span><span class="s2">(</span><span class="s1">SCOPE_COLUMN</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parentheses</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'('</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parentheses</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">')'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">contextmanager</span>
    <span class="s0">def </span><span class="s1">push_alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">.</span><span class="s1">push</span><span class="s2">()</span>
        <span class="s0">yield</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, (</span><span class="s1">Node</span><span class="s2">, </span><span class="s1">Context</span><span class="s2">)):</span>
            <span class="s0">return </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Value</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">keyword</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_sql</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">keyword</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">add_param</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">converter</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">converter</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">converter </span><span class="s0">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">:</span>
            <span class="s4"># Explicitly check for None so that &quot;False&quot; can be used to signify</span>
            <span class="s4"># that no conversion should be applied.</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">(</span><span class="s1">converter</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
            <span class="s4"># Under certain circumstances, we could end-up treating a model-</span>
            <span class="s4"># class itself as a value. This check ensures that we drop the</span>
            <span class="s4"># table alias into the query instead of trying to parameterize a</span>
            <span class="s4"># model (for instance, passing a model as a function argument).</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope_column</span><span class="s2">():</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">value_literals</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">_query_val_transform</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">param </span><span class="s0">or </span><span class="s3">'?'</span><span class="s2">) </span><span class="s0">if </span><span class="s1">add_param </span><span class="s0">else </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">_sql</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sql</span><span class="s2">)</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">_values</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_values</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>

    <span class="s0">def </span><span class="s1">parse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">node</span><span class="s2">).</span><span class="s1">query</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">query</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">''</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sql</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_values</span>


<span class="s0">def </span><span class="s1">query_to_string</span><span class="s2">(</span><span class="s1">query</span><span class="s2">):</span>
    <span class="s4"># NOTE: this function is not exported by default as it might be misused --</span>
    <span class="s4"># and this misuse could lead to sql injection vulnerabilities. This</span>
    <span class="s4"># function is intended for debugging or logging purposes ONLY.</span>
    <span class="s1">db </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s3">'_database'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">db </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">db</span><span class="s2">.</span><span class="s1">get_sql_context</span><span class="s2">()</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">Context</span><span class="s2">()</span>

    <span class="s1">sql</span><span class="s2">, </span><span class="s1">params </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">).</span><span class="s1">query</span><span class="s2">()</span>
    <span class="s0">if not </span><span class="s1">params</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">sql</span>

    <span class="s1">param </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">param </span><span class="s0">or </span><span class="s3">'?'</span>
    <span class="s0">if </span><span class="s1">param </span><span class="s2">== </span><span class="s3">'?'</span><span class="s2">:</span>
        <span class="s1">sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'?'</span><span class="s2">, </span><span class="s3">'%s'</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">sql </span><span class="s2">% </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">_query_val_transform</span><span class="s2">, </span><span class="s1">params</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">_query_val_transform</span><span class="s2">(</span><span class="s1">v</span><span class="s2">):</span>
    <span class="s4"># Interpolate parameters.</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, (</span><span class="s1">text_type</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">date</span><span class="s2">,</span>
                      <span class="s1">datetime</span><span class="s2">.</span><span class="s1">time</span><span class="s2">)):</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s3">&quot;'%s'&quot; </span><span class="s2">% </span><span class="s1">v</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">bytes_type</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">'utf8'</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">UnicodeDecodeError</span><span class="s2">:</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">'raw_unicode_escape'</span><span class="s2">)</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s3">&quot;'%s'&quot; </span><span class="s2">% </span><span class="s1">v</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s3">'%s' </span><span class="s2">% </span><span class="s1">int</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)  </span><span class="s4"># Also handles booleans -&gt; 1 or 0.</span>
    <span class="s0">elif </span><span class="s1">v </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s3">'NULL'</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">v</span>


<span class="s4"># AST.</span>


<span class="s0">class </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">_coerce </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">__isabstractmethod__ </span><span class="s2">= </span><span class="s0">False  </span><span class="s4"># Avoid issue w/abc and __getattr__, eg fn.X</span>

    <span class="s0">def </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">)</span>
        <span class="s1">obj</span><span class="s2">.</span><span class="s1">__dict__ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">obj</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">clone </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">()</span>
            <span class="s1">method</span><span class="s2">(</span><span class="s1">clone</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">clone</span>
        <span class="s0">return </span><span class="s1">inner</span>

    <span class="s0">def </span><span class="s1">coerce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_coerce</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">_coerce </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_coerce</span><span class="s2">:</span>
            <span class="s1">clone </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">()</span>
            <span class="s1">clone</span><span class="s2">.</span><span class="s1">_coerce </span><span class="s2">= </span><span class="s1">_coerce</span>
            <span class="s0">return </span><span class="s1">clone</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">is_alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">unwrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span>


<span class="s0">class </span><span class="s1">ColumnFactory</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'node'</span><span class="s2">,)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">node </span><span class="s2">= </span><span class="s1">node</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>
    <span class="s1">__getitem__ </span><span class="s2">= </span><span class="s1">__getattr__</span>


<span class="s0">class </span><span class="s1">_DynamicColumn</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= ()</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ColumnFactory</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">)  </span><span class="s4"># Implements __getattr__().</span>
        <span class="s0">return </span><span class="s1">self</span>


<span class="s0">class </span><span class="s1">_ExplicitColumn</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= ()</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span>
                <span class="s3">'%s specifies columns explicitly, and does not support '</span>
                <span class="s3">'dynamic column lookups.' </span><span class="s2">% </span><span class="s1">instance</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span>


<span class="s0">class </span><span class="s1">Star</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">source </span><span class="s2">= </span><span class="s1">source</span>
    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">QualifiedNames</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">)).</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'.*'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Source</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">_DynamicColumn</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Source</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">alias</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">name</span>

    <span class="s0">def </span><span class="s1">select</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s1">columns </span><span class="s2">= (</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'*'</span><span class="s2">),)</span>
        <span class="s0">return </span><span class="s1">Select</span><span class="s2">((</span><span class="s1">self</span><span class="s2">,), </span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">__star__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Star</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">=</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">INNER</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">, </span><span class="s1">on</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">left_outer_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">LEFT_OUTER</span><span class="s2">, </span><span class="s1">on</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">cte</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">recursive</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">materialized</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">CTE</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">recursive</span><span class="s2">=</span><span class="s1">recursive</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">,</span>
                   <span class="s1">materialized</span><span class="s2">=</span><span class="s1">materialized</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">,)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">],)</span>

    <span class="s0">def </span><span class="s1">apply_alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s4"># If we are defining the source, include the &quot;AS alias&quot; declaration. An</span>
        <span class="s4"># alias is created for the source if one is not already defined.</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' AS '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">]))</span>
        <span class="s0">return </span><span class="s1">ctx</span>

    <span class="s0">def </span><span class="s1">apply_column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">]))</span>


<span class="s0">class </span><span class="s1">_HashableSource</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">_HashableSource</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_hash</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_hash</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_update_hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_hash </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_hash</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_get_hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_path</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_hash</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">_HashableSource</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_hash </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_hash</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">EQ</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">_HashableSource</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_hash </span><span class="s2">!= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_hash</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">NE</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">op</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>
    <span class="s1">__lt__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">LT</span><span class="s2">)</span>
    <span class="s1">__le__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">LTE</span><span class="s2">)</span>
    <span class="s1">__gt__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">GT</span><span class="s2">)</span>
    <span class="s1">__ge__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">GTE</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">__bind_database__</span><span class="s2">(</span><span class="s1">meth</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">meth</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">meth</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">result</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">result</span>
    <span class="s0">return </span><span class="s1">inner</span>


<span class="s0">def </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">join_type</span><span class="s2">=</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">INNER</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">inverted</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">other </span><span class="s2">= </span><span class="s1">other</span><span class="s2">, </span><span class="s1">self</span>
        <span class="s0">return </span><span class="s1">Join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">=</span><span class="s1">join_type</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">method</span>


<span class="s0">class </span><span class="s1">BaseTable</span><span class="s2">(</span><span class="s1">Source</span><span class="s2">):</span>
    <span class="s1">__and__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">INNER</span><span class="s2">)</span>
    <span class="s1">__add__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">LEFT_OUTER</span><span class="s2">)</span>
    <span class="s1">__sub__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">RIGHT_OUTER</span><span class="s2">)</span>
    <span class="s1">__or__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">FULL_OUTER</span><span class="s2">)</span>
    <span class="s1">__mul__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">CROSS</span><span class="s2">)</span>
    <span class="s1">__rand__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">INNER</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__radd__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">LEFT_OUTER</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rsub__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">RIGHT_OUTER</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__ror__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">FULL_OUTER</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rmul__ </span><span class="s2">= </span><span class="s1">__join__</span><span class="s2">(</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">CROSS</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_BoundTableContext</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">table </span><span class="s2">= </span><span class="s1">table</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database </span><span class="s2">= </span><span class="s1">database</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">_BoundTableContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_database </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_database</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_model </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_model</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_database</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_model </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_model</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_database</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Table</span><span class="s2">(</span><span class="s1">_HashableSource</span><span class="s2">, </span><span class="s1">BaseTable</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">primary_key</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">_model</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">_database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_columns </span><span class="s2">= </span><span class="s1">columns</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_primary_key </span><span class="s2">= </span><span class="s1">primary_key</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_schema </span><span class="s2">= </span><span class="s1">schema</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_path </span><span class="s2">= (</span><span class="s1">schema</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) </span><span class="s0">if </span><span class="s1">schema </span><span class="s0">else </span><span class="s2">(</span><span class="s1">name</span><span class="s2">,)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_model </span><span class="s2">= </span><span class="s1">_model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s2">= </span><span class="s1">_database</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Table</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">=</span><span class="s1">alias</span><span class="s2">)</span>

        <span class="s4"># Allow tables to restrict what columns are available.</span>
        <span class="s0">if </span><span class="s1">columns </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">c </span><span class="s2">= </span><span class="s1">_ExplicitColumn</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">:</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">column</span><span class="s2">, </span><span class="s1">Column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">column</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">primary_key</span><span class="s2">:</span>
            <span class="s1">col_src </span><span class="s2">= </span><span class="s1">self </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns </span><span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">col_src</span><span class="s2">, </span><span class="s1">primary_key</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Ensure a deep copy of the column instances.</span>
        <span class="s0">return </span><span class="s1">Table</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">,</span>
            <span class="s1">primary_key</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_primary_key</span><span class="s2">,</span>
            <span class="s1">schema</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">,</span>
            <span class="s1">alias</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">,</span>
            <span class="s1">_model</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_model</span><span class="s2">,</span>
            <span class="s1">_database</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s2">= </span><span class="s1">database</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">bind_ctx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_BoundTableContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_path</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_model</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">__bind_database__</span>
    <span class="s0">def </span><span class="s1">select</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">columns </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">:</span>
            <span class="s1">columns </span><span class="s2">= [</span><span class="s1">Column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">column</span><span class="s2">) </span><span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">Select</span><span class="s2">((</span><span class="s1">self</span><span class="s2">,), </span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">__bind_database__</span>
    <span class="s0">def </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">insert </span><span class="s2">= {} </span><span class="s0">if </span><span class="s1">insert </span><span class="s0">is None else </span><span class="s1">insert</span>
            <span class="s1">src </span><span class="s2">= </span><span class="s1">self </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns </span><span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c</span>
            <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s1">insert</span><span class="s2">[</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)] = </span><span class="s1">value</span>
        <span class="s0">return </span><span class="s1">Insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">=</span><span class="s1">insert</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">__bind_database__</span>
    <span class="s0">def </span><span class="s1">replace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span>
                <span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">insert</span><span class="s2">=</span><span class="s1">insert</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">on_conflict</span><span class="s2">(</span><span class="s3">'REPLACE'</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">__bind_database__</span>
    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">update</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">update </span><span class="s2">= {} </span><span class="s0">if </span><span class="s1">update </span><span class="s0">is None else </span><span class="s1">update</span>
            <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s1">src </span><span class="s2">= </span><span class="s1">self </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns </span><span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c</span>
                <span class="s1">update</span><span class="s2">[</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)] = </span><span class="s1">value</span>
        <span class="s0">return </span><span class="s1">Update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">update</span><span class="s2">=</span><span class="s1">update</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">__bind_database__</span>
    <span class="s0">def </span><span class="s1">delete</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Delete</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_VALUES</span><span class="s2">:</span>
            <span class="s4"># Return the quoted table name.</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_path</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span>

        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE</span><span class="s2">:</span>
            <span class="s4"># Define the table and its alias.</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_alias</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_path</span><span class="s2">)))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># Refer to the table using the alias.</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_column</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Join</span><span class="s2">(</span><span class="s1">BaseTable</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">=</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">INNER</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Join</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">=</span><span class="s1">alias</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lhs </span><span class="s2">= </span><span class="s1">lhs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">rhs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">join_type </span><span class="s2">= </span><span class="s1">join_type</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on </span><span class="s2">= </span><span class="s1">on</span>

    <span class="s0">def </span><span class="s1">on</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">predicate</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on </span><span class="s2">= </span><span class="s1">predicate</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s2">(</span><span class="s1">ctx</span>
         <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">)</span>
         <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' %s ' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">join_type</span><span class="s2">)</span>
         <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' ON '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">class </span><span class="s1">ValuesList</span><span class="s2">(</span><span class="s1">_HashableSource</span><span class="s2">, </span><span class="s1">BaseTable</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_values </span><span class="s2">= </span><span class="s1">values</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_columns </span><span class="s2">= </span><span class="s1">columns</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ValuesList</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">=</span><span class="s1">alias</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_values</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">names</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_columns </span><span class="s2">= </span><span class="s1">names</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span>

        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE </span><span class="s0">or </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_NORMAL</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s0">not </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">parentheses</span><span class="s2">):</span>
                <span class="s1">ctx </span><span class="s2">= (</span><span class="s1">ctx</span>
                       <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'VALUES '</span><span class="s2">)</span>
                       <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">([</span>
                           <span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">row</span><span class="s2">) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_values</span><span class="s2">])))</span>

            <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' AS '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">]))</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">:</span>
                    <span class="s1">entities </span><span class="s2">= [</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">]</span>
                    <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">entities</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">]))</span>

        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">class </span><span class="s1">CTE</span><span class="s2">(</span><span class="s1">_HashableSource</span><span class="s2">, </span><span class="s1">Source</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">query</span><span class="s2">, </span><span class="s1">recursive</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">materialized</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_query </span><span class="s2">= </span><span class="s1">query</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_recursive </span><span class="s2">= </span><span class="s1">recursive</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_materialized </span><span class="s2">= </span><span class="s1">materialized</span>
        <span class="s0">if </span><span class="s1">columns </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">columns </span><span class="s2">= [</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">) </span><span class="s0">else </span><span class="s1">c</span>
                       <span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_columns </span><span class="s2">= </span><span class="s1">columns</span>
        <span class="s1">query</span><span class="s2">.</span><span class="s1">_cte_list </span><span class="s2">= ()</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">CTE</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">alias</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">select_from</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'select_from() must specify one or more columns '</span>
                             <span class="s3">'from the CTE to select.'</span><span class="s2">)</span>

        <span class="s1">query </span><span class="s2">= (</span><span class="s1">Select</span><span class="s2">((</span><span class="s1">self</span><span class="s2">,), </span><span class="s1">columns</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">with_cte</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_query</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">))</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">query </span><span class="s2">= </span><span class="s1">query</span><span class="s2">.</span><span class="s1">objects</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_query</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">query</span>

    <span class="s0">def </span><span class="s1">_get_hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">, </span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_query</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">union_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s1">clone </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_query</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">CTE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">, </span><span class="s1">clone </span><span class="s2">+ </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_recursive</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">)</span>
    <span class="s1">__add__ </span><span class="s2">= </span><span class="s1">union_all</span>

    <span class="s0">def </span><span class="s1">union</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s1">clone </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_query</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">CTE</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">, </span><span class="s1">clone </span><span class="s2">| </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_recursive</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">)</span>
    <span class="s1">__or__ </span><span class="s2">= </span><span class="s1">union</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">!= </span><span class="s1">SCOPE_CTE</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">push_alias</span><span class="s2">():</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">))</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">))</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' AS '</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_materialized</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'MATERIALIZED '</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_materialized </span><span class="s0">is False</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'NOT MATERIALIZED '</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_normal</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_query</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">class </span><span class="s1">ColumnBase</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s1">_converter </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">converter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_converter </span><span class="s2">= </span><span class="s1">converter</span>

    <span class="s0">def </span><span class="s1">alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">alias</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">Alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">unalias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">bind_to</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">BindTo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">as_type</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Cast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">as_type</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">asc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Asc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s1">collation</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">=</span><span class="s1">nulls</span><span class="s2">)</span>
    <span class="s1">__pos__ </span><span class="s2">= </span><span class="s1">asc</span>

    <span class="s0">def </span><span class="s1">desc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Desc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s1">collation</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">=</span><span class="s1">nulls</span><span class="s2">)</span>
    <span class="s1">__neg__ </span><span class="s2">= </span><span class="s1">desc</span>

    <span class="s0">def </span><span class="s1">__invert__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Negated</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">op</span><span class="s2">, </span><span class="s1">inv</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s7">&quot;&quot;&quot; 
        Lightweight factory which returns a method that builds an Expression 
        consisting of the left-hand and right-hand operands, using `op`. 
        &quot;&quot;&quot;</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">inv</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>
    <span class="s1">__and__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">AND</span><span class="s2">)</span>
    <span class="s1">__or__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">OR</span><span class="s2">)</span>

    <span class="s1">__add__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">ADD</span><span class="s2">)</span>
    <span class="s1">__sub__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">SUB</span><span class="s2">)</span>
    <span class="s1">__mul__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">MUL</span><span class="s2">)</span>
    <span class="s1">__div__ </span><span class="s2">= </span><span class="s1">__truediv__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">DIV</span><span class="s2">)</span>
    <span class="s1">__xor__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">XOR</span><span class="s2">)</span>
    <span class="s1">__radd__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">ADD</span><span class="s2">, </span><span class="s1">inv</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rsub__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">SUB</span><span class="s2">, </span><span class="s1">inv</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rmul__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">MUL</span><span class="s2">, </span><span class="s1">inv</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rdiv__ </span><span class="s2">= </span><span class="s1">__rtruediv__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">DIV</span><span class="s2">, </span><span class="s1">inv</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rand__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">AND</span><span class="s2">, </span><span class="s1">inv</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__ror__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">OR</span><span class="s2">, </span><span class="s1">inv</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rxor__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">XOR</span><span class="s2">, </span><span class="s1">inv</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IS </span><span class="s0">if </span><span class="s1">rhs </span><span class="s0">is None else </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">EQ</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IS_NOT </span><span class="s0">if </span><span class="s1">rhs </span><span class="s0">is None else </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">NE</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>

    <span class="s1">__lt__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">LT</span><span class="s2">)</span>
    <span class="s1">__le__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">LTE</span><span class="s2">)</span>
    <span class="s1">__gt__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">GT</span><span class="s2">)</span>
    <span class="s1">__ge__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">GTE</span><span class="s2">)</span>
    <span class="s1">__lshift__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IN</span><span class="s2">)</span>
    <span class="s1">__rshift__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IS</span><span class="s2">)</span>
    <span class="s1">__mod__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">LIKE</span><span class="s2">)</span>
    <span class="s1">__pow__ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">ILIKE</span><span class="s2">)</span>

    <span class="s1">like </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">LIKE</span><span class="s2">)</span>
    <span class="s1">ilike </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">ILIKE</span><span class="s2">)</span>

    <span class="s1">bin_and </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">BIN_AND</span><span class="s2">)</span>
    <span class="s1">bin_or </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">BIN_OR</span><span class="s2">)</span>
    <span class="s1">in_ </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IN</span><span class="s2">)</span>
    <span class="s1">not_in </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">NOT_IN</span><span class="s2">)</span>
    <span class="s1">regexp </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">REGEXP</span><span class="s2">)</span>
    <span class="s1">iregexp </span><span class="s2">= </span><span class="s1">_e</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IREGEXP</span><span class="s2">)</span>

    <span class="s4"># Special expressions.</span>
    <span class="s0">def </span><span class="s1">is_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">is_null</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IS </span><span class="s0">if </span><span class="s1">is_null </span><span class="s0">else </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IS_NOT</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_escape_like_expr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">template</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">s</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'_'</span><span class="s2">) &gt;= </span><span class="s5">0 </span><span class="s0">or </span><span class="s1">s</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'%'</span><span class="s2">) &gt;= </span><span class="s5">0 </span><span class="s0">or </span><span class="s1">s</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\\</span><span class="s3">'</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">s </span><span class="s2">= </span><span class="s1">s</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\\</span><span class="s3">'</span><span class="s2">, </span><span class="s3">'</span><span class="s0">\\\\</span><span class="s3">'</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'_'</span><span class="s2">, </span><span class="s3">'</span><span class="s0">\\</span><span class="s3">_'</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'%'</span><span class="s2">, </span><span class="s3">'</span><span class="s0">\\</span><span class="s3">%'</span><span class="s2">)</span>
            <span class="s4"># Pass the expression and escape string as unconverted values, to</span>
            <span class="s4"># avoid (e.g.) a Json field converter turning the escaped LIKE</span>
            <span class="s4"># pattern into a Json-quoted string.</span>
            <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">((</span>
                <span class="s1">Value</span><span class="s2">(</span><span class="s1">template </span><span class="s2">% </span><span class="s1">s</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
                <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ESCAPE'</span><span class="s2">),</span>
                <span class="s1">Value</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\\</span><span class="s3">'</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)))</span>
        <span class="s0">return </span><span class="s1">template </span><span class="s2">% </span><span class="s1">s</span>
    <span class="s0">def </span><span class="s1">contains</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">Expression</span><span class="s2">(</span><span class="s3">'%'</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">CONCAT</span><span class="s2">,</span>
                             <span class="s1">Expression</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">CONCAT</span><span class="s2">, </span><span class="s3">'%'</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_escape_like_expr</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s3">'%%%s%%'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">ILIKE</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">CONCAT</span><span class="s2">, </span><span class="s3">'%'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_escape_like_expr</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s3">'%s%%'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">ILIKE</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">Expression</span><span class="s2">(</span><span class="s3">'%'</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">CONCAT</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_escape_like_expr</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s3">'%%%s'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">ILIKE</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">between</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lo</span><span class="s2">, </span><span class="s1">hi</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">BETWEEN</span><span class="s2">, </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">lo</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'AND'</span><span class="s2">), </span><span class="s1">hi</span><span class="s2">)))</span>
    <span class="s0">def </span><span class="s1">concat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">StringExpression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">CONCAT</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">item</span><span class="s2">.</span><span class="s1">start </span><span class="s0">is None or </span><span class="s1">item</span><span class="s2">.</span><span class="s1">stop </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'BETWEEN range must have both a start- and '</span>
                                 <span class="s3">'end-point.'</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">between</span><span class="s2">(</span><span class="s1">item</span><span class="s2">.</span><span class="s1">start</span><span class="s2">, </span><span class="s1">item</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self </span><span class="s2">== </span><span class="s1">item</span>
    <span class="s1">__iter__ </span><span class="s2">= </span><span class="s0">None  </span><span class="s4"># Prevent infinite loop.</span>

    <span class="s0">def </span><span class="s1">distinct</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'DISTINCT'</span><span class="s2">), </span><span class="s1">self</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">collate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">self</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'COLLATE %s' </span><span class="s2">% </span><span class="s1">collation</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">Column</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">source </span><span class="s2">= </span><span class="s1">source</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>

    <span class="s0">def </span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_VALUES</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">.</span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">) + (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,)</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_VALUES</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_column</span><span class="s2">():</span>
                <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">).</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">WrappedNode</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">node </span><span class="s2">= </span><span class="s1">node</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_coerce </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s3">'_coerce'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_converter </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s3">'_converter'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">is_alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">is_alias</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">unwrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">EntityFactory</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'node'</span><span class="s2">,)</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">node </span><span class="s2">= </span><span class="s1">node</span>
    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_DynamicEntity</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= ()</span>
    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">EntityFactory</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">)  </span><span class="s4"># Implements __getattr__().</span>
        <span class="s0">return </span><span class="s1">self</span>


<span class="s0">class </span><span class="s1">Alias</span><span class="s2">(</span><span class="s1">WrappedNode</span><span class="s2">):</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">_DynamicEntity</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Alias</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">alias</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span>
    <span class="s2">@</span><span class="s1">name</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">alias </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">Alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">unalias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span>

    <span class="s0">def </span><span class="s1">is_alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">ctx</span>
                    <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' AS '</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">)))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">BindTo</span><span class="s2">(</span><span class="s1">WrappedNode</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BindTo</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dest </span><span class="s2">= </span><span class="s1">dest</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Negated</span><span class="s2">(</span><span class="s1">WrappedNode</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__invert__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'NOT '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BitwiseMixin</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__and__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bin_and</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__or__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bin_or</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sub__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bin_and</span><span class="s2">(</span><span class="s1">other</span><span class="s2">.</span><span class="s1">bin_negated</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">__invert__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">BitwiseNegated</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BitwiseNegated</span><span class="s2">(</span><span class="s1">BitwiseMixin</span><span class="s2">, </span><span class="s1">WrappedNode</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__invert__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">operations</span><span class="s2">:</span>
            <span class="s1">op_sql </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">operations</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">op</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">op_sql </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">op_sql</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">unpack</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">converter </span><span class="s2">= </span><span class="s1">converter</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">multi </span><span class="s2">= </span><span class="s1">unpack </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">multi_types</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multi</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">values </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Value</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">multi</span><span class="s2">:</span>
            <span class="s4"># For multi-part values (e.g. lists of IDs).</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">values</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ValueLiterals</span><span class="s2">(</span><span class="s1">WrappedNode</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(</span><span class="s1">value_literals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">AsIs</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">unpack</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Cast</span><span class="s2">(</span><span class="s1">WrappedNode</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">cast</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Cast</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cast </span><span class="s2">= </span><span class="s1">cast</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_coerce </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">ctx</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'CAST('</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' AS %s)' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cast</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">Ordering</span><span class="s2">(</span><span class="s1">WrappedNode</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Ordering</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">direction </span><span class="s2">= </span><span class="s1">direction</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">collation </span><span class="s2">= </span><span class="s1">collation</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nulls </span><span class="s2">= </span><span class="s1">nulls</span>
        <span class="s0">if </span><span class="s1">nulls </span><span class="s0">and </span><span class="s1">nulls</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">'first'</span><span class="s2">, </span><span class="s3">'last'</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Ordering nulls= parameter must be &quot;first&quot; or '</span>
                             <span class="s3">'&quot;last&quot;, got: %s' </span><span class="s2">% </span><span class="s1">nulls</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">collate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Ordering</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direction</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_null_ordering_case</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">nulls</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() == </span><span class="s3">'last'</span><span class="s2">:</span>
            <span class="s1">ifnull</span><span class="s2">, </span><span class="s1">notnull </span><span class="s2">= </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span>
        <span class="s0">elif </span><span class="s1">nulls</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() == </span><span class="s3">'first'</span><span class="s2">:</span>
            <span class="s1">ifnull</span><span class="s2">, </span><span class="s1">notnull </span><span class="s2">= </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'unsupported value for nulls= ordering.'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">Case</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, ((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">is_null</span><span class="s2">(), </span><span class="s1">ifnull</span><span class="s2">),), </span><span class="s1">notnull</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nulls </span><span class="s0">and not </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">nulls_ordering</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_null_ordering_case</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nulls</span><span class="s2">)).</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">', '</span><span class="s2">)</span>

        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">).</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">direction</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collation</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' COLLATE %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collation</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nulls </span><span class="s0">and </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">nulls_ordering</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' NULLS %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nulls</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">def </span><span class="s1">Asc</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">Ordering</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s3">'ASC'</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">Desc</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">Ordering</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s3">'DESC'</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">, </span><span class="s1">nulls</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Expression</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">flat</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lhs </span><span class="s2">= </span><span class="s1">lhs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">= </span><span class="s1">op</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">rhs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">flat </span><span class="s2">= </span><span class="s1">flat</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">overrides </span><span class="s2">= {</span><span class="s3">'parentheses'</span><span class="s2">: </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">, </span><span class="s3">'in_expr'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>

        <span class="s4"># First attempt to unwrap the node on the left-hand-side, so that we</span>
        <span class="s4"># can get at the underlying Field if one is present.</span>
        <span class="s1">node </span><span class="s2">= </span><span class="s1">raw_node </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">raw_node</span><span class="s2">, </span><span class="s1">WrappedNode</span><span class="s2">):</span>
            <span class="s1">node </span><span class="s2">= </span><span class="s1">raw_node</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>

        <span class="s4"># Set up the appropriate converter if we have a field on the left side.</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">) </span><span class="s0">and </span><span class="s1">raw_node</span><span class="s2">.</span><span class="s1">_coerce</span><span class="s2">:</span>
            <span class="s1">overrides</span><span class="s2">[</span><span class="s3">'converter'</span><span class="s2">] = </span><span class="s1">node</span><span class="s2">.</span><span class="s1">db_value</span>
            <span class="s1">overrides</span><span class="s2">[</span><span class="s3">'is_fk_expr'</span><span class="s2">] = </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">overrides</span><span class="s2">[</span><span class="s3">'converter'</span><span class="s2">] = </span><span class="s0">None</span>

        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">operations</span><span class="s2">:</span>
            <span class="s1">op_sql </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">operations</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">op</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">op_sql </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op</span>

        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(**</span><span class="s1">overrides</span><span class="s2">):</span>
            <span class="s4"># Postgresql reports an error for IN/NOT IN (), so convert to</span>
            <span class="s4"># the equivalent boolean expression.</span>
            <span class="s1">op_in </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IN </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">NOT_IN</span>
            <span class="s0">if </span><span class="s1">op_in </span><span class="s0">and </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">as_new</span><span class="s2">().</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">] == </span><span class="s3">'()'</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'0 = 1' </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IN </span><span class="s0">else </span><span class="s3">'1 = 1'</span><span class="s2">)</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rhs</span>
            <span class="s0">if </span><span class="s1">rhs </span><span class="s0">is None and </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IS </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">== </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">IS_NOT</span><span class="s2">):</span>
                <span class="s1">rhs </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'NULL'</span><span class="s2">)</span>

            <span class="s0">return </span><span class="s2">(</span><span class="s1">ctx</span>
                    <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' %s ' </span><span class="s2">% </span><span class="s1">op_sql</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">StringExpression</span><span class="s2">(</span><span class="s1">Expression</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__add__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__radd__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">StringExpression</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">CONCAT</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_path </span><span class="s2">= [</span><span class="s1">part</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">'&quot;'</span><span class="s2">, </span><span class="s3">'&quot;&quot;'</span><span class="s2">) </span><span class="s0">for </span><span class="s1">part </span><span class="s0">in </span><span class="s1">path </span><span class="s0">if </span><span class="s1">part</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Entity</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_path </span><span class="s2">+ [</span><span class="s1">attr</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_path</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">quote</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_path</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">quote </span><span class="s0">or </span><span class="s3">'&quot;&quot;'</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sql </span><span class="s2">= </span><span class="s1">sql</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">params </span><span class="s2">= </span><span class="s1">params</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">params</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">param </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">params</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">value</span><span class="s2">(</span><span class="s1">param</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">add_param</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">def </span><span class="s1">Check</span><span class="s2">(</span><span class="s1">constraint</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s1">check </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'CHECK (%s)' </span><span class="s2">% </span><span class="s1">constraint</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">name</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">check</span>
    <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'CONSTRAINT'</span><span class="s2">), </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">name</span><span class="s2">), </span><span class="s1">check</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">Function</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s1">no_coerce_functions </span><span class="s2">= </span><span class="s1">set</span><span class="s2">((</span><span class="s3">'sum'</span><span class="s2">, </span><span class="s3">'count'</span><span class="s2">, </span><span class="s3">'avg'</span><span class="s2">, </span><span class="s3">'cast'</span><span class="s2">, </span><span class="s3">'array_agg'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">arguments</span><span class="s2">, </span><span class="s1">coerce</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">python_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">arguments </span><span class="s2">= </span><span class="s1">arguments</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_filter </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_python_value </span><span class="s2">= </span><span class="s1">python_value</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">and </span><span class="s1">name</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">no_coerce_functions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_coerce </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_coerce </span><span class="s2">= </span><span class="s1">coerce</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">Function</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_filter </span><span class="s2">= </span><span class="s1">where</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">order_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">ordering</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by </span><span class="s2">= </span><span class="s1">ordering</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_python_value </span><span class="s2">= </span><span class="s1">func</span>

    <span class="s0">def </span><span class="s1">over</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">partition_by</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">order_by</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">end</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
             <span class="s1">frame_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">exclude</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">partition_by</span><span class="s2">, </span><span class="s1">Window</span><span class="s2">) </span><span class="s0">and </span><span class="s1">window </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">window </span><span class="s2">= </span><span class="s1">partition_by</span>

        <span class="s0">if </span><span class="s1">window </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">node </span><span class="s2">= </span><span class="s1">WindowAlias</span><span class="s2">(</span><span class="s1">window</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">node </span><span class="s2">= </span><span class="s1">Window</span><span class="s2">(</span><span class="s1">partition_by</span><span class="s2">=</span><span class="s1">partition_by</span><span class="s2">, </span><span class="s1">order_by</span><span class="s2">=</span><span class="s1">order_by</span><span class="s2">,</span>
                          <span class="s1">start</span><span class="s2">=</span><span class="s1">start</span><span class="s2">, </span><span class="s1">end</span><span class="s2">=</span><span class="s1">end</span><span class="s2">, </span><span class="s1">frame_type</span><span class="s2">=</span><span class="s1">frame_type</span><span class="s2">,</span>
                          <span class="s1">exclude</span><span class="s2">=</span><span class="s1">exclude</span><span class="s2">, </span><span class="s1">_inline</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">self</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'OVER'</span><span class="s2">), </span><span class="s1">node</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arguments</span><span class="s2">):</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'()'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">arguments</span>

            <span class="s4"># If this is an ordered aggregate, then we will modify the last</span>
            <span class="s4"># argument to append the ORDER BY ... clause. We do this to avoid</span>
            <span class="s4"># double-wrapping any expression args in parentheses, as NodeList</span>
            <span class="s4"># has a special check (hack) in place to work around this.</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by</span><span class="s2">:</span>
                <span class="s1">args </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
                <span class="s1">args</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">args</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ORDER BY'</span><span class="s2">),</span>
                                     <span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by</span><span class="s2">)))</span>

            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(</span><span class="s1">in_function</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">function_arg_count</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">arguments</span><span class="s2">)):</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">([</span>
                    <span class="s2">(</span><span class="s1">arg </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">) </span><span class="s0">else </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s0">False</span><span class="s2">))</span>
                    <span class="s0">for </span><span class="s1">arg </span><span class="s0">in </span><span class="s1">args</span><span class="s2">]))</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_filter</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' FILTER (WHERE '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_filter</span><span class="s2">).</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">')'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s1">fn </span><span class="s2">= </span><span class="s1">Function</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Window</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s4"># Frame start/end and frame exclusion.</span>
    <span class="s1">CURRENT_ROW </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'CURRENT ROW'</span><span class="s2">)</span>
    <span class="s1">GROUP </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'GROUP'</span><span class="s2">)</span>
    <span class="s1">TIES </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'TIES'</span><span class="s2">)</span>
    <span class="s1">NO_OTHERS </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'NO OTHERS'</span><span class="s2">)</span>

    <span class="s4"># Frame types.</span>
    <span class="s1">GROUPS </span><span class="s2">= </span><span class="s3">'GROUPS'</span>
    <span class="s1">RANGE </span><span class="s2">= </span><span class="s3">'RANGE'</span>
    <span class="s1">ROWS </span><span class="s2">= </span><span class="s3">'ROWS'</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">partition_by</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">order_by</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">end</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">frame_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">extends</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">exclude</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">_inline</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Window</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">start </span><span class="s0">is not None and not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">start</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">):</span>
            <span class="s1">start </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">start</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">end </span><span class="s0">is not None and not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">end</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">):</span>
            <span class="s1">end </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">end</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">partition_by </span><span class="s2">= </span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">partition_by</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">order_by </span><span class="s2">= </span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">order_by</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">start </span><span class="s2">= </span><span class="s1">start</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">end </span><span class="s2">= </span><span class="s1">end</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start </span><span class="s0">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">end </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot specify WINDOW end without start.'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">alias </span><span class="s0">or </span><span class="s3">'w'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_inline </span><span class="s2">= </span><span class="s1">_inline</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">frame_type </span><span class="s2">= </span><span class="s1">frame_type</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_extends </span><span class="s2">= </span><span class="s1">extends</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_exclude </span><span class="s2">= </span><span class="s1">exclude</span>

    <span class="s0">def </span><span class="s1">alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">alias </span><span class="s0">or </span><span class="s3">'w'</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">as_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">frame_type </span><span class="s2">= </span><span class="s1">Window</span><span class="s2">.</span><span class="s1">RANGE</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">as_rows</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">frame_type </span><span class="s2">= </span><span class="s1">Window</span><span class="s2">.</span><span class="s1">ROWS</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">as_groups</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">frame_type </span><span class="s2">= </span><span class="s1">Window</span><span class="s2">.</span><span class="s1">GROUPS</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">extends</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">window</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_extends </span><span class="s2">= </span><span class="s1">window</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">exclude</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">frame_exclusion</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">frame_exclusion</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
            <span class="s1">frame_exclusion </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">frame_exclusion</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_exclude </span><span class="s2">= </span><span class="s1">frame_exclusion</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">following</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'UNBOUNDED FOLLOWING'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'%d FOLLOWING' </span><span class="s2">% </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">preceding</span><span class="s2">(</span><span class="s1">value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'UNBOUNDED PRECEDING'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'%d PRECEDING' </span><span class="s2">% </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">!= </span><span class="s1">SCOPE_SOURCE </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_inline</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">)</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' AS '</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s1">parts </span><span class="s2">= []</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_extends </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">ext </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_extends</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">, </span><span class="s1">Window</span><span class="s2">):</span>
                    <span class="s1">ext </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">.</span><span class="s1">_alias</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                    <span class="s1">ext </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">)</span>
                <span class="s1">parts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">partition_by</span><span class="s2">:</span>
                <span class="s1">parts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span>
                    <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'PARTITION BY'</span><span class="s2">),</span>
                    <span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">partition_by</span><span class="s2">)))</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">order_by</span><span class="s2">:</span>
                <span class="s1">parts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span>
                    <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ORDER BY'</span><span class="s2">),</span>
                    <span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">order_by</span><span class="s2">)))</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">end </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">frame </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">frame_type </span><span class="s0">or </span><span class="s3">'ROWS'</span>
                <span class="s1">parts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span>
                    <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'%s BETWEEN' </span><span class="s2">% </span><span class="s1">frame</span><span class="s2">),</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">start</span><span class="s2">,</span>
                    <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'AND'</span><span class="s2">),</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">end</span><span class="s2">))</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">parts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">frame_type </span><span class="s0">or </span><span class="s3">'ROWS'</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start</span><span class="s2">))</span>
            <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">frame_type </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">parts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'%s UNBOUNDED PRECEDING' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">frame_type</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_exclude </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">parts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'EXCLUDE'</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_exclude</span><span class="s2">))</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">parts</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">class </span><span class="s1">WindowAlias</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">window</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window </span><span class="s2">= </span><span class="s1">window</span>

    <span class="s0">def </span><span class="s1">alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">window_alias</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">_alias </span><span class="s2">= </span><span class="s1">window_alias</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">_alias </span><span class="s0">or </span><span class="s3">'w'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_InFunction</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">in_function</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">node </span><span class="s2">= </span><span class="s1">node</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">in_function </span><span class="s2">= </span><span class="s1">in_function</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(</span><span class="s1">in_function</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_function</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Case</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">predicate</span><span class="s2">, </span><span class="s1">expression_tuples</span><span class="s2">, </span><span class="s1">default</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">predicate </span><span class="s2">= </span><span class="s1">predicate</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expression_tuples </span><span class="s2">= </span><span class="s1">expression_tuples</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">default </span><span class="s2">= </span><span class="s1">default</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">clauses </span><span class="s2">= [</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'CASE'</span><span class="s2">)]</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">predicate </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">clauses</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">predicate</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">expression_tuples</span><span class="s2">:</span>
            <span class="s1">clauses</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'WHEN'</span><span class="s2">), </span><span class="s1">expr</span><span class="s2">,</span>
                            <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'THEN'</span><span class="s2">), </span><span class="s1">_InFunction</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">default </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">clauses</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ELSE'</span><span class="s2">), </span><span class="s1">_InFunction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">default</span><span class="s2">)))</span>
        <span class="s1">clauses</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'END'</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(</span><span class="s1">in_function</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">clauses</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">ForUpdate</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">, </span><span class="s1">of</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nowait</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">expr </span><span class="s2">= </span><span class="s3">'FOR UPDATE' </span><span class="s0">if </span><span class="s1">expr </span><span class="s0">is True else </span><span class="s1">expr</span>
        <span class="s0">if </span><span class="s1">expr</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">().</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'nowait'</span><span class="s2">):</span>
            <span class="s1">expr </span><span class="s2">= </span><span class="s1">expr</span><span class="s2">[:-</span><span class="s5">7</span><span class="s2">]  </span><span class="s4"># Strip off the &quot;nowait&quot; bit.</span>
            <span class="s1">nowait </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_expr </span><span class="s2">= </span><span class="s1">expr</span>
        <span class="s0">if </span><span class="s1">of </span><span class="s0">is not None and not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">of</span><span class="s2">, (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">set</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)):</span>
            <span class="s1">of </span><span class="s2">= (</span><span class="s1">of</span><span class="s2">,)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_of </span><span class="s2">= </span><span class="s1">of</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_nowait </span><span class="s2">= </span><span class="s1">nowait</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_expr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_of </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' OF '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_of</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_nowait</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' NOWAIT'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">class </span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nodes</span><span class="s2">, </span><span class="s1">glue</span><span class="s2">=</span><span class="s3">' '</span><span class="s2">, </span><span class="s1">parens</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nodes </span><span class="s2">= </span><span class="s1">nodes</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">glue </span><span class="s2">= </span><span class="s1">glue</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">parens </span><span class="s2">= </span><span class="s1">parens</span>
        <span class="s0">if </span><span class="s1">parens </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">) == </span><span class="s5">1 </span><span class="s0">and </span><span class="s1">\</span>
           <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">Expression</span><span class="s2">) </span><span class="s0">and </span><span class="s1">\</span>
           <span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">flat</span><span class="s2">:</span>
            <span class="s4"># Hack to avoid double-parentheses.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">nodes </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">clone</span><span class="s2">(),)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">flat </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">n_nodes </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">n_nodes </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'()'</span><span class="s2">) </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parens </span><span class="s0">else </span><span class="s1">ctx</span>
        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">parens</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_nodes </span><span class="s2">- </span><span class="s5">1</span><span class="s2">):</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">glue</span><span class="s2">)</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nodes</span><span class="s2">[</span><span class="s1">n_nodes </span><span class="s2">- </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">def </span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">, </span><span class="s3">', '</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">nodes</span><span class="s2">, </span><span class="s3">', '</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_Namespace</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'_name'</span><span class="s2">,)</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_name </span><span class="s2">= </span><span class="s1">name</span>
    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">NamespaceAttribute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>
    <span class="s1">__getitem__ </span><span class="s2">= </span><span class="s1">__getattr__</span>

<span class="s0">class </span><span class="s1">NamespaceAttribute</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">namespace</span><span class="s2">, </span><span class="s1">attribute</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_namespace </span><span class="s2">= </span><span class="s1">namespace</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_attribute </span><span class="s2">= </span><span class="s1">attribute</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">ctx</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_namespace</span><span class="s2">.</span><span class="s1">_name </span><span class="s2">+ </span><span class="s3">'.'</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attribute</span><span class="s2">)))</span>

<span class="s1">EXCLUDED </span><span class="s2">= </span><span class="s1">_Namespace</span><span class="s2">(</span><span class="s3">'EXCLUDED'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DQ</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">query</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">DQ</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">query </span><span class="s2">= </span><span class="s1">query</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_negated </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">__invert__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_negated </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_negated</span>

    <span class="s0">def </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">node </span><span class="s2">= </span><span class="s1">DQ</span><span class="s2">(**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">query</span><span class="s2">)</span>
        <span class="s1">node</span><span class="s2">.</span><span class="s1">_negated </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_negated</span>
        <span class="s0">return </span><span class="s1">node</span>

<span class="s4">#: Represent a row tuple.</span>
<span class="s1">Tuple </span><span class="s2">= </span><span class="s0">lambda </span><span class="s2">*</span><span class="s1">a</span><span class="s2">: </span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">QualifiedNames</span><span class="s2">(</span><span class="s1">WrappedNode</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_column</span><span class="s2">():</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">qualify_names</span><span class="s2">(</span><span class="s1">node</span><span class="s2">):</span>
    <span class="s4"># Search a node heirarchy to ensure that any column-like objects are</span>
    <span class="s4"># referenced using fully-qualified names.</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">Expression</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">node</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">(</span><span class="s1">qualify_names</span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">), </span><span class="s1">node</span><span class="s2">.</span><span class="s1">op</span><span class="s2">,</span>
                              <span class="s1">qualify_names</span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">), </span><span class="s1">node</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">ColumnBase</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">QualifiedNames</span><span class="s2">(</span><span class="s1">node</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">node</span>


<span class="s0">class </span><span class="s1">OnConflict</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">action</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">update</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">preserve</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">conflict_target</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">conflict_where</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">conflict_constraint</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_action </span><span class="s2">= </span><span class="s1">action</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update </span><span class="s2">= </span><span class="s1">update</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_preserve </span><span class="s2">= </span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">preserve</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s2">= </span><span class="s1">where</span>
        <span class="s0">if </span><span class="s1">conflict_target </span><span class="s0">is not None and </span><span class="s1">conflict_constraint </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'only one of &quot;conflict_target&quot; and '</span>
                             <span class="s3">'&quot;conflict_constraint&quot; may be specified.'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_target </span><span class="s2">= </span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">conflict_target</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_where </span><span class="s2">= </span><span class="s1">conflict_where</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_constraint </span><span class="s2">= </span><span class="s1">conflict_constraint</span>

    <span class="s0">def </span><span class="s1">get_conflict_statement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">conflict_statement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">query</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_conflict_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">conflict_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">query</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">preserve</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_preserve </span><span class="s2">= </span><span class="s1">columns</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_data</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">_data </span><span class="s0">and </span><span class="s1">kwargs </span><span class="s0">and not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">_data</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot mix data with keyword arguments in the '</span>
                             <span class="s3">'OnConflict update method.'</span><span class="s2">)</span>
        <span class="s1">_data </span><span class="s2">= </span><span class="s1">_data </span><span class="s0">or </span><span class="s2">{}</span>
        <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">_data</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update </span><span class="s2">= </span><span class="s1">_data</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">expressions</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">expressions </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">,) + </span><span class="s1">expressions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, </span><span class="s1">expressions</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">conflict_target</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">constraints</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_constraint </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_target </span><span class="s2">= </span><span class="s1">constraints</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">conflict_where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">expressions</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_where </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">expressions </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_where</span><span class="s2">,) + </span><span class="s1">expressions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_where </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, </span><span class="s1">expressions</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">conflict_constraint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">constraint</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_constraint </span><span class="s2">= </span><span class="s1">constraint</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conflict_target </span><span class="s2">= </span><span class="s0">None</span>


<span class="s0">def </span><span class="s1">database_required</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">method</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">database </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s0">if </span><span class="s1">database </span><span class="s0">is None else </span><span class="s1">database</span>
        <span class="s0">if not </span><span class="s1">database</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">InterfaceError</span><span class="s2">(</span><span class="s3">'Query must be bound to a database in order '</span>
                                 <span class="s3">'to call &quot;%s&quot;.' </span><span class="s2">% </span><span class="s1">method</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">inner</span>

<span class="s4"># BASE QUERY INTERFACE.</span>

<span class="s0">class </span><span class="s1">BaseQuery</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s1">default_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">DICT</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s2">= </span><span class="s1">_database</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BaseQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s2">= </span><span class="s1">database</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">BaseQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">clone</span><span class="s2">()</span>
        <span class="s1">query</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">return </span><span class="s1">query</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">dicts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">as_dict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">DICT </span><span class="s0">if </span><span class="s1">as_dict </span><span class="s0">else None</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">tuples</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">as_tuple</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">TUPLE </span><span class="s0">if </span><span class="s1">as_tuple </span><span class="s0">else None</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">namedtuples</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">as_namedtuple</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">NAMED_TUPLE </span><span class="s0">if </span><span class="s1">as_namedtuple </span><span class="s0">else None</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">objects</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">constructor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">CONSTRUCTOR </span><span class="s0">if </span><span class="s1">constructor </span><span class="s0">else None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor </span><span class="s2">= </span><span class="s1">constructor</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">_get_cursor_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s1">row_type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">default_row_type</span>

        <span class="s0">if </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">DICT</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">DictCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">TUPLE</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">CursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">NAMED_TUPLE</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">NamedTupleCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">CONSTRUCTOR</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ObjectCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Unrecognized row type: &quot;%s&quot;.' </span><span class="s2">% </span><span class="s1">row_type</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">:</span>
            <span class="s1">context </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">.</span><span class="s1">get_sql_context</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">context </span><span class="s2">= </span><span class="s1">Context</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">context</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_execute</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">iterator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">database</span><span class="s2">).</span><span class="s1">iterator</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_ensure_execution</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Query has not been executed.'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ensure_execution</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ensure_execution</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">):</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">stop</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s0">if </span><span class="s1">index </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">index </span><span class="s2">= </span><span class="s1">index </span><span class="s2">+ </span><span class="s5">1 </span><span class="s0">if </span><span class="s1">index </span><span class="s2">&gt;= </span><span class="s5">0 </span><span class="s0">else </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span><span class="s2">.</span><span class="s1">fill_cache</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span><span class="s2">.</span><span class="s1">row_cache</span><span class="s2">[</span><span class="s1">value</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_ensure_execution</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">query_to_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">RawQuery</span><span class="s2">(</span><span class="s1">BaseQuery</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">RawQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_sql </span><span class="s2">= </span><span class="s1">sql</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_params </span><span class="s2">= </span><span class="s1">params</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sql</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_params</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">param </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_params</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">value</span><span class="s2">(</span><span class="s1">param</span><span class="s2">, </span><span class="s1">add_param</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>

    <span class="s0">def </span><span class="s1">_execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">cursor </span><span class="s2">= </span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_cursor_wrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span>


<span class="s0">class </span><span class="s1">Query</span><span class="s2">(</span><span class="s1">BaseQuery</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">order_by</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">limit</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Query</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s2">= </span><span class="s1">where</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by </span><span class="s2">= </span><span class="s1">order_by</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_limit </span><span class="s2">= </span><span class="s1">limit</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">= </span><span class="s1">offset</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cte_list </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">with_cte</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">cte_list</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cte_list </span><span class="s2">= </span><span class="s1">cte_list</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">expressions</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">expressions </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">,) + </span><span class="s1">expressions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, </span><span class="s1">expressions</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">orwhere</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">expressions</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">expressions </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">,) + </span><span class="s1">expressions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">or_</span><span class="s2">, </span><span class="s1">expressions</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">order_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by </span><span class="s2">= </span><span class="s1">values</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">order_by_extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by </span><span class="s2">= ((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by </span><span class="s0">or </span><span class="s2">()) + </span><span class="s1">values</span><span class="s2">) </span><span class="s0">or None</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">limit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_limit </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">offset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">paginate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">page</span><span class="s2">, </span><span class="s1">paginate_by</span><span class="s2">=</span><span class="s5">20</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">page </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">page </span><span class="s2">-= </span><span class="s5">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_limit </span><span class="s2">= </span><span class="s1">paginate_by</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">= </span><span class="s1">page </span><span class="s2">* </span><span class="s1">paginate_by</span>

    <span class="s0">def </span><span class="s1">_apply_ordering</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by</span><span class="s2">:</span>
            <span class="s2">(</span><span class="s1">ctx</span>
             <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' ORDER BY '</span><span class="s2">)</span>
             <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_order_by</span><span class="s2">)))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_limit </span><span class="s0">is not None or </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_offset </span><span class="s0">is not None and</span>
                                       <span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">limit_max</span><span class="s2">):</span>
            <span class="s1">limit </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">limit_max </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_limit </span><span class="s0">is None else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_limit</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' LIMIT '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">limit</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_offset </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' OFFSET '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_offset</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cte_list</span><span class="s2">:</span>
            <span class="s4"># The CTE scope is only used at the very beginning of the query,</span>
            <span class="s4"># when we are describing the various CTEs we will be using.</span>
            <span class="s1">recursive </span><span class="s2">= </span><span class="s1">any</span><span class="s2">(</span><span class="s1">cte</span><span class="s2">.</span><span class="s1">_recursive </span><span class="s0">for </span><span class="s1">cte </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cte_list</span><span class="s2">)</span>

            <span class="s4"># Explicitly disable the &quot;subquery&quot; flag here, so as to avoid</span>
            <span class="s4"># unnecessary parentheses around subsequent selects.</span>
            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_cte</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                <span class="s2">(</span><span class="s1">ctx</span>
                 <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'WITH RECURSIVE ' </span><span class="s0">if </span><span class="s1">recursive </span><span class="s0">else </span><span class="s3">'WITH '</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cte_list</span><span class="s2">))</span>
                 <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">def </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s1">operation</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">__bind_database__</span>
    <span class="s0">def </span><span class="s1">method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">inverted</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">other </span><span class="s2">= </span><span class="s1">other</span><span class="s2">, </span><span class="s1">self</span>
        <span class="s0">return </span><span class="s1">CompoundSelectQuery</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">operation</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">method</span>


<span class="s0">class </span><span class="s1">SelectQuery</span><span class="s2">(</span><span class="s1">Query</span><span class="s2">):</span>
    <span class="s1">union_all </span><span class="s2">= </span><span class="s1">__add__ </span><span class="s2">= </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s3">'UNION ALL'</span><span class="s2">)</span>
    <span class="s1">union </span><span class="s2">= </span><span class="s1">__or__ </span><span class="s2">= </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s3">'UNION'</span><span class="s2">)</span>
    <span class="s1">intersect </span><span class="s2">= </span><span class="s1">__and__ </span><span class="s2">= </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s3">'INTERSECT'</span><span class="s2">)</span>
    <span class="s1">except_ </span><span class="s2">= </span><span class="s1">__sub__ </span><span class="s2">= </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s3">'EXCEPT'</span><span class="s2">)</span>
    <span class="s1">__radd__ </span><span class="s2">= </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s3">'UNION ALL'</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__ror__ </span><span class="s2">= </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s3">'UNION'</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rand__ </span><span class="s2">= </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s3">'INTERSECT'</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">__rsub__ </span><span class="s2">= </span><span class="s1">__compound_select__</span><span class="s2">(</span><span class="s3">'EXCEPT'</span><span class="s2">, </span><span class="s1">inverted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">select_from</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'select_from() must specify one or more columns.'</span><span class="s2">)</span>

        <span class="s1">query </span><span class="s2">= (</span><span class="s1">Select</span><span class="s2">((</span><span class="s1">self</span><span class="s2">,), </span><span class="s1">columns</span><span class="s2">)</span>
                 <span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'model'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s4"># Bind to the sub-select's model type, if defined.</span>
            <span class="s1">query </span><span class="s2">= </span><span class="s1">query</span><span class="s2">.</span><span class="s1">objects</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">query</span>


<span class="s0">class </span><span class="s1">SelectBase</span><span class="s2">(</span><span class="s1">_HashableSource</span><span class="s2">, </span><span class="s1">Source</span><span class="s2">, </span><span class="s1">SelectQuery</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_get_hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s0">or </span><span class="s1">id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">_execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">cursor </span><span class="s2">= </span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_cursor_wrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">peek</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s1">rows </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)[:</span><span class="s1">n</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">rows</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">rows</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">n </span><span class="s2">== </span><span class="s5">1 </span><span class="s0">else </span><span class="s1">rows</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">first</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_limit </span><span class="s2">!= </span><span class="s1">n</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_limit </span><span class="s2">= </span><span class="s1">n</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">peek</span><span class="s2">(</span><span class="s1">database</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">as_tuple</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">as_dict</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">as_dict</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dicts</span><span class="s2">().</span><span class="s1">peek</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s1">row </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tuples</span><span class="s2">().</span><span class="s1">peek</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">row</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">row </span><span class="s0">and not </span><span class="s1">as_tuple </span><span class="s0">else </span><span class="s1">row</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">scalars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tuples</span><span class="s2">().</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">database</span><span class="s2">):</span>
            <span class="s0">yield </span><span class="s1">row</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">count</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">clear_limit</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">clone </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">order_by</span><span class="s2">().</span><span class="s1">alias</span><span class="s2">(</span><span class="s3">'_wrapped'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">clear_limit</span><span class="s2">:</span>
            <span class="s1">clone</span><span class="s2">.</span><span class="s1">_limit </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">_having </span><span class="s0">is None and </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">_group_by </span><span class="s0">is None and </span><span class="s1">\</span>
               <span class="s1">clone</span><span class="s2">.</span><span class="s1">_windows </span><span class="s0">is None and </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">_distinct </span><span class="s0">is None and </span><span class="s1">\</span>
               <span class="s1">clone</span><span class="s2">.</span><span class="s1">_simple_distinct </span><span class="s0">is not True</span><span class="s2">:</span>
                <span class="s1">clone </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'1'</span><span class="s2">))</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">Select</span><span class="s2">([</span><span class="s1">clone</span><span class="s2">], [</span><span class="s1">fn</span><span class="s2">.</span><span class="s1">COUNT</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'1'</span><span class="s2">))]).</span><span class="s1">scalar</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s1">clone </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'1'</span><span class="s2">))</span>
        <span class="s1">clone</span><span class="s2">.</span><span class="s1">_limit </span><span class="s2">= </span><span class="s5">1</span>
        <span class="s1">clone</span><span class="s2">.</span><span class="s1">_offset </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">clone</span><span class="s2">.</span><span class="s1">scalar</span><span class="s2">())</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s0">pass</span>


<span class="s4"># QUERY IMPLEMENTATIONS.</span>


<span class="s0">class </span><span class="s1">CompoundSelectQuery</span><span class="s2">(</span><span class="s1">SelectBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">CompoundSelectQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lhs </span><span class="s2">= </span><span class="s1">lhs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">op </span><span class="s2">= </span><span class="s1">op</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">rhs</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">_returning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">_returning</span>

    <span class="s2">@</span><span class="s1">database_required</span>
    <span class="s0">def </span><span class="s1">exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s1">Select</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit</span><span class="s2">(</span><span class="s5">1</span><span class="s2">),), (</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'1'</span><span class="s2">),)).</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">query</span><span class="s2">.</span><span class="s1">scalar</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_get_query_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">get_query_key</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">.</span><span class="s1">get_query_key</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">_wrap_parens</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">subq</span><span class="s2">):</span>
        <span class="s1">csq_setting </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">compound_select_parentheses</span>

        <span class="s0">if not </span><span class="s1">csq_setting </span><span class="s0">or </span><span class="s1">csq_setting </span><span class="s2">== </span><span class="s1">CSQ_PARENTHESES_NEVER</span><span class="s2">:</span>
            <span class="s0">return False</span>
        <span class="s0">elif </span><span class="s1">csq_setting </span><span class="s2">== </span><span class="s1">CSQ_PARENTHESES_ALWAYS</span><span class="s2">:</span>
            <span class="s0">return True</span>
        <span class="s0">elif </span><span class="s1">csq_setting </span><span class="s2">== </span><span class="s1">CSQ_PARENTHESES_UNNESTED</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">in_expr </span><span class="s0">or </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">in_function</span><span class="s2">:</span>
                <span class="s4"># If this compound select query is being used inside an</span>
                <span class="s4"># expression, e.g., an IN or EXISTS().</span>
                <span class="s0">return False</span>

            <span class="s4"># If the query on the left or right is itself a compound select</span>
            <span class="s4"># query, then we do not apply parentheses. However, if it is a</span>
            <span class="s4"># regular SELECT query, we will apply parentheses.</span>
            <span class="s0">return not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">subq</span><span class="s2">, </span><span class="s1">CompoundSelectQuery</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_COLUMN</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_column</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

        <span class="s4"># Call parent method to handle any CTEs.</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">CompoundSelectQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

        <span class="s1">outer_parens </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">subquery </span><span class="s0">or </span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s1">outer_parens</span><span class="s2">):</span>
            <span class="s4"># Should the left-hand query be wrapped in parentheses?</span>
            <span class="s1">lhs_parens </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_wrap_parens</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_normal</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s1">lhs_parens</span><span class="s2">, </span><span class="s1">subquery</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">)</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' %s ' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">op</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">push_alias</span><span class="s2">():</span>
                <span class="s4"># Should the right-hand query be wrapped in parentheses?</span>
                <span class="s1">rhs_parens </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_wrap_parens</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">)</span>
                <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_normal</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s1">rhs_parens</span><span class="s2">, </span><span class="s1">subquery</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">)</span>

            <span class="s4"># Apply ORDER BY, LIMIT, OFFSET. We use the &quot;values&quot; scope so that</span>
            <span class="s4"># entity names are not fully-qualified. This is a bit of a hack, as</span>
            <span class="s4"># we're relying on the logic in Column.__sql__() to not fully</span>
            <span class="s4"># qualify column names.</span>
            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_values</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_apply_ordering</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_alias</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Select</span><span class="s2">(</span><span class="s1">SelectBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">from_list</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">group_by</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">having</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">distinct</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">windows</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">for_update</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">for_update_of</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nowait</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">lateral</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Select</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list </span><span class="s2">= (</span><span class="s1">list</span><span class="s2">(</span><span class="s1">from_list</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">from_list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
                           <span class="s0">else </span><span class="s1">from_list</span><span class="s2">) </span><span class="s0">or </span><span class="s2">[]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= </span><span class="s1">columns</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_group_by </span><span class="s2">= </span><span class="s1">group_by</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_having </span><span class="s2">= </span><span class="s1">having</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_windows </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update </span><span class="s2">= </span><span class="s1">for_update  </span><span class="s4"># XXX: consider reorganizing.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update_of </span><span class="s2">= </span><span class="s1">for_update_of</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update_nowait </span><span class="s2">= </span><span class="s1">nowait</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_lateral </span><span class="s2">= </span><span class="s1">lateral</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_distinct </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_distinct </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">distinct</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">distinct</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_distinct </span><span class="s2">= </span><span class="s1">distinct</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_distinct </span><span class="s2">= </span><span class="s1">distinct</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">clone </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">Select</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">clone</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">:</span>
            <span class="s1">clone</span><span class="s2">.</span><span class="s1">_from_list </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">clone</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">clone</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= </span><span class="s1">columns</span>
    <span class="s1">select </span><span class="s2">= </span><span class="s1">columns</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">select_extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">) + </span><span class="s1">columns</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">selected_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span>
    <span class="s2">@</span><span class="s1">selected_columns</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">selected_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">from_</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">sources</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">sources</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">=</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">INNER</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'No sources to join on.'</span><span class="s2">)</span>
        <span class="s1">item </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Join</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">, </span><span class="s1">on</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">left_outer_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">LEFT_OUTER</span><span class="s2">, </span><span class="s1">on</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">group_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s1">grouping </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">Table</span><span class="s2">):</span>
                <span class="s0">if not </span><span class="s1">column</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot pass a table to group_by() that '</span>
                                     <span class="s3">'does not have columns explicitly '</span>
                                     <span class="s3">'declared.'</span><span class="s2">)</span>
                <span class="s1">grouping</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">col_name</span><span class="s2">)</span>
                                 <span class="s0">for </span><span class="s1">col_name </span><span class="s0">in </span><span class="s1">column</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">grouping</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_group_by </span><span class="s2">= </span><span class="s1">grouping</span>

    <span class="s0">def </span><span class="s1">group_by_extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">values</span><span class="s2">):</span>
        <span class="s7">&quot;&quot;&quot;@Node.copy used from group_by() call&quot;&quot;&quot;</span>
        <span class="s1">group_by </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_group_by </span><span class="s0">or </span><span class="s2">()) + </span><span class="s1">values</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">group_by</span><span class="s2">(*</span><span class="s1">group_by</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">having</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">expressions</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_having </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">expressions </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_having</span><span class="s2">,) + </span><span class="s1">expressions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_having </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, </span><span class="s1">expressions</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">distinct</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">) == </span><span class="s5">1 </span><span class="s0">and </span><span class="s2">(</span><span class="s1">columns</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is True or </span><span class="s1">columns</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is False</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_distinct </span><span class="s2">= </span><span class="s1">columns</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_distinct </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_distinct </span><span class="s2">= </span><span class="s1">columns</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">window</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">windows</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_windows </span><span class="s2">= </span><span class="s1">windows </span><span class="s0">if </span><span class="s1">windows </span><span class="s0">else None</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">for_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">for_update</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">of</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">nowait</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">for_update </span><span class="s0">and </span><span class="s2">(</span><span class="s1">of </span><span class="s0">is not None or </span><span class="s1">nowait</span><span class="s2">):</span>
            <span class="s1">for_update </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update </span><span class="s2">= </span><span class="s1">for_update</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update_of </span><span class="s2">= </span><span class="s1">of</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update_nowait </span><span class="s2">= </span><span class="s1">nowait</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">lateral</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lateral</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_lateral </span><span class="s2">= </span><span class="s1">lateral</span>

    <span class="s0">def </span><span class="s1">_get_query_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_alias</span>

    <span class="s0">def </span><span class="s1">__sql_selection__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">is_subquery</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_COLUMN</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_column</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lateral </span><span class="s0">and </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'LATERAL '</span><span class="s2">)</span>

        <span class="s1">is_subquery </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">subquery</span>
        <span class="s1">state </span><span class="s2">= {</span>
            <span class="s3">'converter'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
            <span class="s3">'in_function'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
            <span class="s3">'parentheses'</span><span class="s2">: </span><span class="s1">is_subquery </span><span class="s0">or </span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE</span><span class="s2">),</span>
            <span class="s3">'subquery'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">in_function </span><span class="s0">and </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">function_arg_count </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">state</span><span class="s2">[</span><span class="s3">'parentheses'</span><span class="s2">] = </span><span class="s0">False</span>

        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_normal</span><span class="s2">(**</span><span class="s1">state</span><span class="s2">):</span>
            <span class="s4"># Defer calling parent SQL until here. This ensures that any CTEs</span>
            <span class="s4"># for this query will be properly nested if this query is a</span>
            <span class="s4"># sub-select or is used in an expression. See GH#1809 for example.</span>
            <span class="s1">super</span><span class="s2">(</span><span class="s1">Select</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'SELECT '</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_distinct </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_distinct </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'DISTINCT '</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_distinct</span><span class="s2">:</span>
                    <span class="s2">(</span><span class="s1">ctx</span>
                     <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'ON '</span><span class="s2">)</span>
                     <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_distinct</span><span class="s2">))</span>
                     <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">))</span>

            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_source</span><span class="s2">():</span>
                <span class="s1">ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__sql_selection__</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">is_subquery</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_source</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' FROM '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">))</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' WHERE '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_group_by</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' GROUP BY '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_group_by</span><span class="s2">))</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_having </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' HAVING '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_having</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_windows </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' WINDOW '</span><span class="s2">)</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_windows</span><span class="s2">))</span>

            <span class="s4"># Apply ORDER BY, LIMIT, OFFSET.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_apply_ordering</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">for_update</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'FOR UPDATE specified but not supported '</span>
                                     <span class="s3">'by database.'</span><span class="s2">)</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">)</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">ForUpdate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update_of</span><span class="s2">,</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">_for_update_nowait</span><span class="s2">))</span>

        <span class="s4"># If the subquery is inside a function -or- we are evaluating a</span>
        <span class="s4"># subquery on either side of an expression w/o an explicit alias, do</span>
        <span class="s4"># not generate an alias + AS clause.</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">in_function </span><span class="s0">or </span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">in_expr </span><span class="s0">and</span>
                                     <span class="s1">self</span><span class="s2">.</span><span class="s1">_alias </span><span class="s0">is None</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">ctx</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_alias</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_WriteQuery</span><span class="s2">(</span><span class="s1">Query</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">returning</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">table </span><span class="s2">= </span><span class="s1">table</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= </span><span class="s1">returning</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_return_cursor </span><span class="s2">= </span><span class="s0">True if </span><span class="s1">returning </span><span class="s0">else False</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">_WriteQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">cte</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">recursive</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">materialized</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">CTE</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">recursive</span><span class="s2">=</span><span class="s1">recursive</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">,</span>
                   <span class="s1">materialized</span><span class="s2">=</span><span class="s1">materialized</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">returning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">returning</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= </span><span class="s1">returning</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_return_cursor </span><span class="s2">= </span><span class="s0">True if </span><span class="s1">returning </span><span class="s0">else False</span>

    <span class="s0">def </span><span class="s1">apply_returning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_source</span><span class="s2">():</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' RETURNING '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">ctx</span>

    <span class="s0">def </span><span class="s1">_execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">:</span>
            <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_returning</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">cursor </span><span class="s2">= </span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handle_result</span><span class="s2">(</span><span class="s1">database</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">execute_returning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">cursor </span><span class="s2">= </span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_cursor_wrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span>

    <span class="s0">def </span><span class="s1">handle_result</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_return_cursor</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cursor</span>
        <span class="s0">return </span><span class="s1">database</span><span class="s2">.</span><span class="s1">rows_affected</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_set_table_alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">__name__</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">_WriteQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
        <span class="s4"># We explicitly set the table alias to the table's name, which ensures</span>
        <span class="s4"># that if a sub-select references a column on the outer table, we won't</span>
        <span class="s4"># assign it a new alias (e.g. t2) but will refer to it as table.column.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_set_table_alias</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">class </span><span class="s1">Update</span><span class="s2">(</span><span class="s1">_WriteQuery</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">update</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Update</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update </span><span class="s2">= </span><span class="s1">update</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_from </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">from_</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">sources</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_from </span><span class="s2">= </span><span class="s1">sources</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Update</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_values</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'UPDATE '</span><span class="s2">)</span>

            <span class="s1">expressions </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update</span><span class="s2">.</span><span class="s1">items</span><span class="s2">(), </span><span class="s1">key</span><span class="s2">=</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">column_sort_key</span><span class="s2">):</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                        <span class="s1">v </span><span class="s2">= </span><span class="s1">k</span><span class="s2">.</span><span class="s1">to_value</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">v </span><span class="s2">= </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">unpack</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Model</span><span class="s2">) </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">):</span>
                    <span class="s4"># NB: we want to ensure that when passed a model instance</span>
                    <span class="s4"># in the context of a foreign-key, we apply the fk-specific</span>
                    <span class="s4"># adaptation of the model.</span>
                    <span class="s1">v </span><span class="s2">= </span><span class="s1">k</span><span class="s2">.</span><span class="s1">to_value</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>

                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Value</span><span class="s2">):</span>
                    <span class="s1">v </span><span class="s2">= </span><span class="s1">qualify_names</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>

                <span class="s1">expressions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">k</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">), </span><span class="s1">v</span><span class="s2">)))</span>

            <span class="s2">(</span><span class="s1">ctx</span>
             <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">)</span>
             <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' SET '</span><span class="s2">)</span>
             <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">expressions</span><span class="s2">)))</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_source</span><span class="s2">(</span><span class="s1">parentheses</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' FROM '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from</span><span class="s2">))</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_normal</span><span class="s2">():</span>
                    <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' WHERE '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_apply_ordering</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_returning</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Insert</span><span class="s2">(</span><span class="s1">_WriteQuery</span><span class="s2">):</span>
    <span class="s1">SIMPLE </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">QUERY </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">MULTI </span><span class="s2">= </span><span class="s5">2</span>
    <span class="s0">class </span><span class="s1">DefaultValuesException</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">): </span><span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">on_conflict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Insert</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_insert </span><span class="s2">= </span><span class="s1">insert</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_columns </span><span class="s2">= </span><span class="s1">columns</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on_conflict </span><span class="s2">= </span><span class="s1">on_conflict</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_query_type </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_as_rowcount </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">expressions</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s3">'INSERT queries cannot have a WHERE clause.'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">as_rowcount</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_as_rowcount</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_as_rowcount </span><span class="s2">= </span><span class="s1">_as_rowcount</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">on_conflict_ignore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ignore</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on_conflict </span><span class="s2">= </span><span class="s1">OnConflict</span><span class="s2">(</span><span class="s3">'IGNORE'</span><span class="s2">) </span><span class="s0">if </span><span class="s1">ignore </span><span class="s0">else None</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">on_conflict_replace</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on_conflict </span><span class="s2">= </span><span class="s1">OnConflict</span><span class="s2">(</span><span class="s3">'REPLACE'</span><span class="s2">) </span><span class="s0">if </span><span class="s1">replace </span><span class="s0">else None</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">on_conflict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on_conflict </span><span class="s2">= (</span><span class="s1">OnConflict</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">) </span><span class="s0">if </span><span class="s2">(</span><span class="s1">args </span><span class="s0">or </span><span class="s1">kwargs</span><span class="s2">)</span>
                             <span class="s0">else None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_simple_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_insert</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DefaultValuesException</span><span class="s2">(</span><span class="s3">'Error: no data to insert.'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_generate_insert</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_insert</span><span class="s2">,), </span><span class="s1">ctx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_default_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{}</span>

    <span class="s0">def </span><span class="s1">get_default_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">[</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">, </span><span class="s1">col</span><span class="s2">) </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_columns</span>
                    <span class="s0">if </span><span class="s1">col </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_primary_key</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">_generate_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">rows_iter </span><span class="s2">= </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">insert</span><span class="s2">)</span>
        <span class="s1">columns </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span>

        <span class="s4"># Load and organize column defaults (if provided).</span>
        <span class="s1">defaults </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_default_data</span><span class="s2">()</span>

        <span class="s4"># First figure out what columns are being inserted (if they weren't</span>
        <span class="s4"># specified explicitly). Resulting columns are normalized and ordered.</span>
        <span class="s0">if not </span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">row </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">rows_iter</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DefaultValuesException</span><span class="s2">(</span><span class="s3">'Error: no rows to insert.'</span><span class="s2">)</span>

            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">Mapping</span><span class="s2">):</span>
                <span class="s1">columns </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_default_columns</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">columns </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Bulk insert must specify columns.'</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s4"># Infer column names from the dict of data being inserted.</span>
                <span class="s1">accum </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">row</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                        <span class="s1">column </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">, </span><span class="s1">column</span><span class="s2">)</span>
                    <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)</span>

                <span class="s4"># Add any columns present in the default data that are not</span>
                <span class="s4"># accounted for by the dictionary of row data.</span>
                <span class="s1">column_set </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">accum</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">defaults</span><span class="s2">) - </span><span class="s1">column_set</span><span class="s2">):</span>
                    <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">col</span><span class="s2">)</span>

                <span class="s1">columns </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">accum</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">obj</span><span class="s2">: </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">))</span>
            <span class="s1">rows_iter </span><span class="s2">= </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">chain</span><span class="s2">(</span><span class="s1">iter</span><span class="s2">((</span><span class="s1">row</span><span class="s2">,)), </span><span class="s1">rows_iter</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">clean_columns </span><span class="s2">= []</span>
            <span class="s1">seen </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                    <span class="s1">column_obj </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">, </span><span class="s1">column</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">column_obj </span><span class="s2">= </span><span class="s1">column</span>
                <span class="s1">clean_columns</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">column_obj</span><span class="s2">)</span>
                <span class="s1">seen</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">column_obj</span><span class="s2">)</span>

            <span class="s1">columns </span><span class="s2">= </span><span class="s1">clean_columns</span>
            <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">defaults</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">obj</span><span class="s2">: </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s1">col </span><span class="s0">not in </span><span class="s1">seen</span><span class="s2">:</span>
                    <span class="s1">columns</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">col</span><span class="s2">)</span>

        <span class="s1">fk_fields </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">nullable_columns </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">value_lookups </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s1">lookups </span><span class="s2">= [</span><span class="s1">column</span><span class="s2">, </span><span class="s1">column</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">column</span><span class="s2">.</span><span class="s1">name </span><span class="s2">!= </span><span class="s1">column</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">:</span>
                    <span class="s1">lookups</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">column</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">column</span><span class="s2">.</span><span class="s1">null</span><span class="s2">:</span>
                    <span class="s1">nullable_columns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">):</span>
                    <span class="s1">fk_fields</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)</span>
            <span class="s1">value_lookups</span><span class="s2">[</span><span class="s1">column</span><span class="s2">] = </span><span class="s1">lookups</span>

        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">)).</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' VALUES '</span><span class="s2">)</span>
        <span class="s1">columns_converters </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">column</span><span class="s2">.</span><span class="s1">db_value </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">) </span><span class="s0">else None</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">]</span>

        <span class="s1">all_values </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">rows_iter</span><span class="s2">:</span>
            <span class="s1">values </span><span class="s2">= []</span>
            <span class="s1">is_dict </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">row</span><span class="s2">, </span><span class="s1">Mapping</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">column</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">columns_converters</span><span class="s2">):</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">is_dict</span><span class="s2">:</span>
                        <span class="s4"># The logic is a bit convoluted, but in order to be</span>
                        <span class="s4"># flexible in what we accept (dict keyed by</span>
                        <span class="s4"># column/field, field name, or underlying column name),</span>
                        <span class="s4"># we try accessing the row data dict using each</span>
                        <span class="s4"># possible key. If no match is found, throw an error.</span>
                        <span class="s0">for </span><span class="s1">lookup </span><span class="s0">in </span><span class="s1">value_lookups</span><span class="s2">[</span><span class="s1">column</span><span class="s2">]:</span>
                            <span class="s0">try</span><span class="s2">:</span>
                                <span class="s1">val </span><span class="s2">= </span><span class="s1">row</span><span class="s2">[</span><span class="s1">lookup</span><span class="s2">]</span>
                            <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">: </span><span class="s0">pass</span>
                            <span class="s0">else</span><span class="s2">: </span><span class="s0">break</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s0">raise </span><span class="s1">KeyError</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">val </span><span class="s2">= </span><span class="s1">row</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s0">except </span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">IndexError</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">column </span><span class="s0">in </span><span class="s1">defaults</span><span class="s2">:</span>
                        <span class="s1">val </span><span class="s2">= </span><span class="s1">defaults</span><span class="s2">[</span><span class="s1">column</span><span class="s2">]</span>
                        <span class="s0">if </span><span class="s1">callable_</span><span class="s2">(</span><span class="s1">val</span><span class="s2">):</span>
                            <span class="s1">val </span><span class="s2">= </span><span class="s1">val</span><span class="s2">()</span>
                    <span class="s0">elif </span><span class="s1">column </span><span class="s0">in </span><span class="s1">nullable_columns</span><span class="s2">:</span>
                        <span class="s1">val </span><span class="s2">= </span><span class="s0">None</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Missing value for %s.' </span><span class="s2">% </span><span class="s1">column</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">) </span><span class="s0">or </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">Model</span><span class="s2">) </span><span class="s0">and</span>
                                                 <span class="s1">column </span><span class="s0">in </span><span class="s1">fk_fields</span><span class="s2">):</span>
                    <span class="s1">val </span><span class="s2">= </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s1">converter</span><span class="s2">, </span><span class="s1">unpack</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>

            <span class="s1">all_values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">values</span><span class="s2">))</span>

        <span class="s0">if not </span><span class="s1">all_values</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DefaultValuesException</span><span class="s2">(</span><span class="s3">'Error: no data to insert.'</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_values</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">all_values</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_query_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">ctx</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">))</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_insert</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_default_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'DEFAULT VALUES'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">.</span><span class="s1">default_values_insert</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Insert</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_values</span><span class="s2">():</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_conflict </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">stmt </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_conflict</span><span class="s2">.</span><span class="s1">get_conflict_statement</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>

            <span class="s2">(</span><span class="s1">ctx</span>
             <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">stmt </span><span class="s0">or </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'INSERT'</span><span class="s2">))</span>
             <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' INTO '</span><span class="s2">)</span>
             <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">)</span>
             <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">))</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_insert</span><span class="s2">, </span><span class="s1">Mapping</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_simple_insert</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DefaultValuesException</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_values</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_query_type </span><span class="s2">= </span><span class="s1">Insert</span><span class="s2">.</span><span class="s1">SIMPLE</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_insert</span><span class="s2">, (</span><span class="s1">SelectQuery</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">)):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_query_insert</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_query_type </span><span class="s2">= </span><span class="s1">Insert</span><span class="s2">.</span><span class="s1">QUERY</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_generate_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_insert</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_query_type </span><span class="s2">= </span><span class="s1">Insert</span><span class="s2">.</span><span class="s1">MULTI</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_conflict </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">update </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_conflict</span><span class="s2">.</span><span class="s1">get_conflict_update</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">update </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">update</span><span class="s2">)</span>

            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_returning</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s0">is None and </span><span class="s1">database</span><span class="s2">.</span><span class="s1">returning_clause \</span>
           <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_primary_key</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">_primary_key</span><span class="s2">,)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">Insert</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">_execute</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DefaultValuesException</span><span class="s2">:</span>
            <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">handle_result</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_return_cursor</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cursor</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_as_rowcount</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">database</span><span class="s2">.</span><span class="s1">rows_affected</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">database</span><span class="s2">.</span><span class="s1">last_insert_id</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_query_type</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Delete</span><span class="s2">(</span><span class="s1">_WriteQuery</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">Delete</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_values</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'DELETE FROM '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_normal</span><span class="s2">():</span>
                    <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' WHERE '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_apply_ordering</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">apply_returning</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Index</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">expressions</span><span class="s2">, </span><span class="s1">unique</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                 <span class="s1">where</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">using</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_table </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">table</span><span class="s2">) </span><span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">Table</span><span class="s2">) </span><span class="s0">else </span><span class="s1">table</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_expressions </span><span class="s2">= </span><span class="s1">expressions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s2">= </span><span class="s1">where</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_unique </span><span class="s2">= </span><span class="s1">unique</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_safe </span><span class="s2">= </span><span class="s1">safe</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_using </span><span class="s2">= </span><span class="s1">using</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">safe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_safe </span><span class="s2">= </span><span class="s1">_safe</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">expressions</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">expressions </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">,) + </span><span class="s1">expressions</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, </span><span class="s1">expressions</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">using</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_using</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_using </span><span class="s2">= </span><span class="s1">_using</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">statement </span><span class="s2">= </span><span class="s3">'CREATE UNIQUE INDEX ' </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_unique </span><span class="s0">else </span><span class="s3">'CREATE INDEX '</span>
        <span class="s0">with </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope_values</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">statement</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_safe</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'IF NOT EXISTS '</span><span class="s2">)</span>

            <span class="s4"># Sqlite uses CREATE INDEX &lt;schema&gt;.&lt;name&gt; ON &lt;table&gt;, whereas most</span>
            <span class="s4"># others use: CREATE INDEX &lt;name&gt; ON &lt;schema&gt;.&lt;table&gt;.</span>
            <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">index_schema_prefix </span><span class="s0">and </span><span class="s1">\</span>
               <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table</span><span class="s2">, </span><span class="s1">Table</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">:</span>
                <span class="s1">index_name </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">)</span>
                <span class="s1">table_name </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">index_name </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">)</span>
                <span class="s1">table_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table</span>

            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">index_name</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_using </span><span class="s0">is not None and </span><span class="s1">\</span>
               <span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">index_using_precedes_table</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' USING %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_using</span><span class="s2">)  </span><span class="s4"># MySQL style.</span>

            <span class="s2">(</span><span class="s1">ctx</span>
             <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' ON '</span><span class="s2">)</span>
             <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">)</span>
             <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">))</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_using </span><span class="s0">is not None and not </span><span class="s1">\</span>
               <span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">index_using_precedes_table</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'USING %s ' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_using</span><span class="s2">)  </span><span class="s4"># Postgres/default.</span>

            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">([</span>
                <span class="s1">SQL</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">) </span><span class="s0">else </span><span class="s1">expr</span>
                <span class="s0">for </span><span class="s1">expr </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_expressions</span><span class="s2">]))</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' WHERE '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">ctx</span>


<span class="s0">class </span><span class="s1">ModelIndex</span><span class="s2">(</span><span class="s1">Index</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">, </span><span class="s1">unique</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">using</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_generate_name_from_fields</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">using </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">) </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s3">'index_type'</span><span class="s2">):</span>
                    <span class="s1">using </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">index_type</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ModelIndex</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
            <span class="s1">table</span><span class="s2">=</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table</span><span class="s2">,</span>
            <span class="s1">expressions</span><span class="s2">=</span><span class="s1">fields</span><span class="s2">,</span>
            <span class="s1">unique</span><span class="s2">=</span><span class="s1">unique</span><span class="s2">,</span>
            <span class="s1">safe</span><span class="s2">=</span><span class="s1">safe</span><span class="s2">,</span>
            <span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">,</span>
            <span class="s1">using</span><span class="s2">=</span><span class="s1">using</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_generate_name_from_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">):</span>
        <span class="s1">accum </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                    <span class="s1">field </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                    <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">accum</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Unable to generate a name for the index, please '</span>
                             <span class="s3">'explicitly specify a name.'</span><span class="s2">)</span>

        <span class="s1">clean_field_names </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span><span class="s3">r'[^\w]+'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, </span><span class="s3">'_'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">accum</span><span class="s2">))</span>
        <span class="s1">meta </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span>
        <span class="s1">prefix </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">name </span><span class="s0">if </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">legacy_table_names </span><span class="s0">else </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">table_name</span>
        <span class="s0">return </span><span class="s1">_truncate_constraint_name</span><span class="s2">(</span><span class="s3">'_'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">((</span><span class="s1">prefix</span><span class="s2">, </span><span class="s1">clean_field_names</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">_truncate_constraint_name</span><span class="s2">(</span><span class="s1">constraint</span><span class="s2">, </span><span class="s1">maxlen</span><span class="s2">=</span><span class="s5">64</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">constraint</span><span class="s2">) &gt; </span><span class="s1">maxlen</span><span class="s2">:</span>
        <span class="s1">name_hash </span><span class="s2">= </span><span class="s1">hashlib</span><span class="s2">.</span><span class="s1">md5</span><span class="s2">(</span><span class="s1">constraint</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">)).</span><span class="s1">hexdigest</span><span class="s2">()</span>
        <span class="s1">constraint </span><span class="s2">= </span><span class="s3">'%s_%s' </span><span class="s2">% (</span><span class="s1">constraint</span><span class="s2">[:(</span><span class="s1">maxlen </span><span class="s2">- </span><span class="s5">8</span><span class="s2">)], </span><span class="s1">name_hash</span><span class="s2">[:</span><span class="s5">7</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">constraint</span>


<span class="s4"># DB-API 2.0 EXCEPTIONS.</span>


<span class="s0">class </span><span class="s1">PeeweeException</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">args </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">Exception</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">orig</span><span class="s2">, </span><span class="s1">args </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">args</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">PeeweeException</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">ImproperlyConfigured</span><span class="s2">(</span><span class="s1">PeeweeException</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">DatabaseError</span><span class="s2">(</span><span class="s1">PeeweeException</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">DataError</span><span class="s2">(</span><span class="s1">DatabaseError</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">IntegrityError</span><span class="s2">(</span><span class="s1">DatabaseError</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">InterfaceError</span><span class="s2">(</span><span class="s1">PeeweeException</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">InternalError</span><span class="s2">(</span><span class="s1">DatabaseError</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">NotSupportedError</span><span class="s2">(</span><span class="s1">DatabaseError</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">OperationalError</span><span class="s2">(</span><span class="s1">DatabaseError</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">ProgrammingError</span><span class="s2">(</span><span class="s1">DatabaseError</span><span class="s2">): </span><span class="s0">pass</span>


<span class="s0">class </span><span class="s1">ExceptionWrapper</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'exceptions'</span><span class="s2">,)</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exceptions</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s2">= </span><span class="s1">exceptions</span>
    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">): </span><span class="s0">pass</span>
    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">traceback</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">exc_type </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s4"># psycopg shits out a million cute error types. Try to catch em all.</span>
        <span class="s0">if </span><span class="s1">pg_errors </span><span class="s0">is not None and </span><span class="s1">exc_type</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exceptions \</span>
           <span class="s0">and </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">pg_errors</span><span class="s2">.</span><span class="s1">Error</span><span class="s2">):</span>
            <span class="s1">exc_type </span><span class="s2">= </span><span class="s1">exc_type</span><span class="s2">.</span><span class="s1">__bases__</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">pg3_errors </span><span class="s0">is not None and </span><span class="s1">\</span>
           <span class="s1">exc_type</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exceptions \</span>
           <span class="s0">and </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">pg3_errors</span><span class="s2">.</span><span class="s1">Error</span><span class="s2">):</span>
            <span class="s1">exc_type </span><span class="s2">= </span><span class="s1">exc_type</span><span class="s2">.</span><span class="s1">__bases__</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">exc_type</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">:</span>
            <span class="s1">new_type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s1">exc_type</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">]</span>
            <span class="s1">exc_args </span><span class="s2">= </span><span class="s1">exc_value</span><span class="s2">.</span><span class="s1">args</span>
            <span class="s1">reraise</span><span class="s2">(</span><span class="s1">new_type</span><span class="s2">, </span><span class="s1">new_type</span><span class="s2">(</span><span class="s1">exc_value</span><span class="s2">, *</span><span class="s1">exc_args</span><span class="s2">), </span><span class="s1">traceback</span><span class="s2">)</span>


<span class="s1">EXCEPTIONS </span><span class="s2">= {</span>
    <span class="s3">'ConstraintError'</span><span class="s2">: </span><span class="s1">IntegrityError</span><span class="s2">,</span>
    <span class="s3">'DatabaseError'</span><span class="s2">: </span><span class="s1">DatabaseError</span><span class="s2">,</span>
    <span class="s3">'DataError'</span><span class="s2">: </span><span class="s1">DataError</span><span class="s2">,</span>
    <span class="s3">'IntegrityError'</span><span class="s2">: </span><span class="s1">IntegrityError</span><span class="s2">,</span>
    <span class="s3">'InterfaceError'</span><span class="s2">: </span><span class="s1">InterfaceError</span><span class="s2">,</span>
    <span class="s3">'InternalError'</span><span class="s2">: </span><span class="s1">InternalError</span><span class="s2">,</span>
    <span class="s3">'NotSupportedError'</span><span class="s2">: </span><span class="s1">NotSupportedError</span><span class="s2">,</span>
    <span class="s3">'OperationalError'</span><span class="s2">: </span><span class="s1">OperationalError</span><span class="s2">,</span>
    <span class="s3">'ProgrammingError'</span><span class="s2">: </span><span class="s1">ProgrammingError</span><span class="s2">,</span>
    <span class="s3">'TransactionRollbackError'</span><span class="s2">: </span><span class="s1">OperationalError</span><span class="s2">,</span>
    <span class="s3">'UndefinedFunction'</span><span class="s2">: </span><span class="s1">ProgrammingError</span><span class="s2">,</span>
    <span class="s3">'UniqueViolation'</span><span class="s2">: </span><span class="s1">IntegrityError</span><span class="s2">}</span>

<span class="s1">__exception_wrapper__ </span><span class="s2">= </span><span class="s1">ExceptionWrapper</span><span class="s2">(</span><span class="s1">EXCEPTIONS</span><span class="s2">)</span>


<span class="s4"># DATABASE INTERFACE AND CONNECTION MANAGEMENT.</span>


<span class="s1">IndexMetadata </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span>
    <span class="s3">'IndexMetadata'</span><span class="s2">,</span>
    <span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s3">'sql'</span><span class="s2">, </span><span class="s3">'columns'</span><span class="s2">, </span><span class="s3">'unique'</span><span class="s2">, </span><span class="s3">'table'</span><span class="s2">))</span>
<span class="s1">ColumnMetadata </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span>
    <span class="s3">'ColumnMetadata'</span><span class="s2">,</span>
    <span class="s2">(</span><span class="s3">'name'</span><span class="s2">, </span><span class="s3">'data_type'</span><span class="s2">, </span><span class="s3">'null'</span><span class="s2">, </span><span class="s3">'primary_key'</span><span class="s2">, </span><span class="s3">'table'</span><span class="s2">, </span><span class="s3">'default'</span><span class="s2">))</span>
<span class="s1">ForeignKeyMetadata </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span>
    <span class="s3">'ForeignKeyMetadata'</span><span class="s2">,</span>
    <span class="s2">(</span><span class="s3">'column'</span><span class="s2">, </span><span class="s3">'dest_table'</span><span class="s2">, </span><span class="s3">'dest_column'</span><span class="s2">, </span><span class="s3">'table'</span><span class="s2">))</span>
<span class="s1">ViewMetadata </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'ViewMetadata'</span><span class="s2">, (</span><span class="s3">'name'</span><span class="s2">, </span><span class="s3">'sql'</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">_ConnectionState</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">_ConnectionState</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">reset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">closed </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">conn </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ctx </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transactions </span><span class="s2">= []</span>

    <span class="s0">def </span><span class="s1">set_connection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">conn </span><span class="s2">= </span><span class="s1">conn</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">closed </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ctx </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transactions </span><span class="s2">= []</span>


<span class="s0">class </span><span class="s1">_ConnectionLocal</span><span class="s2">(</span><span class="s1">_ConnectionState</span><span class="s2">, </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">local</span><span class="s2">): </span><span class="s0">pass</span>
<span class="s0">class </span><span class="s1">_NoopLock</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= ()</span>
    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">): </span><span class="s0">return </span><span class="s1">self</span>
    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">): </span><span class="s0">pass</span>


<span class="s0">class </span><span class="s1">ConnectionContext</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'db'</span><span class="s2">,)</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db</span><span class="s2">): </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db </span><span class="s2">= </span><span class="s1">db</span>
    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">()</span>
    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">): </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">ConnectionContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>


<span class="s0">class </span><span class="s1">Database</span><span class="s2">(</span><span class="s1">_callable_context_manager</span><span class="s2">):</span>
    <span class="s1">context_class </span><span class="s2">= </span><span class="s1">Context</span>
    <span class="s1">field_types </span><span class="s2">= {}</span>
    <span class="s1">operations </span><span class="s2">= {}</span>
    <span class="s1">param </span><span class="s2">= </span><span class="s3">'?'</span>
    <span class="s1">quote </span><span class="s2">= </span><span class="s3">'&quot;&quot;'</span>
    <span class="s1">server_version </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s4"># Feature toggles.</span>
    <span class="s1">compound_select_parentheses </span><span class="s2">= </span><span class="s1">CSQ_PARENTHESES_NEVER</span>
    <span class="s1">for_update </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">index_schema_prefix </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">index_using_precedes_table </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">limit_max </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">nulls_ordering </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">returning_clause </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">safe_create_index </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">safe_drop_index </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">sequences </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">truncate_table </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">thread_safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">autorollback</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                 <span class="s1">field_types</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">operations</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">autocommit</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">autoconnect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_field_types </span><span class="s2">= </span><span class="s1">merge_dict</span><span class="s2">(</span><span class="s1">FIELD</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_types</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_operations </span><span class="s2">= </span><span class="s1">merge_dict</span><span class="s2">(</span><span class="s1">OP</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">operations</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">field_types</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_field_types</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">field_types</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">operations</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_operations</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">operations</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">autoconnect </span><span class="s2">= </span><span class="s1">autoconnect</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">thread_safe </span><span class="s2">= </span><span class="s1">thread_safe</span>
        <span class="s0">if </span><span class="s1">thread_safe</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_state </span><span class="s2">= </span><span class="s1">_ConnectionLocal</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_lock </span><span class="s2">= </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Lock</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_state </span><span class="s2">= </span><span class="s1">_ConnectionState</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_lock </span><span class="s2">= </span><span class="s1">_NoopLock</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">autorollback</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'Peewee no longer uses the &quot;autorollback&quot; option, '</span>
                           <span class="s3">'as we always run in autocommit-mode now. This '</span>
                           <span class="s3">'changes psycopg2</span><span class="s0">\'</span><span class="s3">s semantics so that the conn '</span>
                           <span class="s3">'is not left in a transaction-aborted state.'</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">autocommit </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'Peewee no longer uses the &quot;autocommit&quot; option, as '</span>
                           <span class="s3">'the semantics now require it to always be True. '</span>
                           <span class="s3">'Because some database-drivers also use the '</span>
                           <span class="s3">'&quot;autocommit&quot; parameter, you are receiving a '</span>
                           <span class="s3">'warning so you may update your code and remove '</span>
                           <span class="s3">'the parameter, as in the future, specifying '</span>
                           <span class="s3">'autocommit could impact the behavior of the '</span>
                           <span class="s3">'database driver you are using.'</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">connect_params </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">init</span><span class="s2">(</span><span class="s1">database</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database </span><span class="s2">= </span><span class="s1">database</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connect_params</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">deferred </span><span class="s2">= </span><span class="s0">not </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">()</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">__enter__</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">):</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">)</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">ctx</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">connection_context</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ConnectionContext</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reuse_if_open</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lock</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deferred</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">InterfaceError</span><span class="s2">(</span><span class="s3">'Error, database must be initialized '</span>
                                     <span class="s3">'before opening a connection.'</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">closed</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">reuse_if_open</span><span class="s2">:</span>
                    <span class="s0">return False</span>
                <span class="s0">raise </span><span class="s1">OperationalError</span><span class="s2">(</span><span class="s3">'Connection already opened.'</span><span class="s2">)</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
            <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">set_connection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_connect</span><span class="s2">())</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_set_server_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_initialize_connection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">_initialize_connection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">_set_server_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lock</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deferred</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">InterfaceError</span><span class="s2">(</span><span class="s3">'Error, database must be initialized '</span>
                                     <span class="s3">'before opening a connection.'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_transaction</span><span class="s2">():</span>
                <span class="s0">raise </span><span class="s1">OperationalError</span><span class="s2">(</span><span class="s3">'Attempting to close database while '</span>
                                       <span class="s3">'transaction is open.'</span><span class="s2">)</span>
            <span class="s1">is_open </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">closed</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">is_open</span><span class="s2">:</span>
                    <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">)</span>
            <span class="s0">finally</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">is_open</span>

    <span class="s0">def </span><span class="s1">_close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">is_closed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">closed</span>

    <span class="s0">def </span><span class="s1">is_connection_usable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">closed</span>

    <span class="s0">def </span><span class="s1">connection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span>

    <span class="s0">def </span><span class="s1">cursor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">commit</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">named_cursor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">commit </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;commit&quot; has been deprecated and is a no-op.'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">autoconnect</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">InterfaceError</span><span class="s2">(</span><span class="s3">'Error, database connection not opened.'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">commit</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">commit </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;commit&quot; has been deprecated and is a no-op.'</span><span class="s2">)</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">((</span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
            <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params </span><span class="s0">or </span><span class="s2">())</span>
        <span class="s0">return </span><span class="s1">cursor</span>

    <span class="s0">def </span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">query</span><span class="s2">, </span><span class="s1">commit</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">context_options</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">commit </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;commit&quot; has been deprecated and is a no-op.'</span><span class="s2">)</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_sql_context</span><span class="s2">(**</span><span class="s1">context_options</span><span class="s2">)</span>
        <span class="s1">sql</span><span class="s2">, </span><span class="s1">params </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">).</span><span class="s1">query</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_context_options</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span>
            <span class="s3">'field_types'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_field_types</span><span class="s2">,</span>
            <span class="s3">'operations'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_operations</span><span class="s2">,</span>
            <span class="s3">'param'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param</span><span class="s2">,</span>
            <span class="s3">'quote'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">quote</span><span class="s2">,</span>
            <span class="s3">'compound_select_parentheses'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">compound_select_parentheses</span><span class="s2">,</span>
            <span class="s3">'conflict_statement'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">conflict_statement</span><span class="s2">,</span>
            <span class="s3">'conflict_update'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">conflict_update</span><span class="s2">,</span>
            <span class="s3">'for_update'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">for_update</span><span class="s2">,</span>
            <span class="s3">'index_schema_prefix'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index_schema_prefix</span><span class="s2">,</span>
            <span class="s3">'index_using_precedes_table'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index_using_precedes_table</span><span class="s2">,</span>
            <span class="s3">'limit_max'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">limit_max</span><span class="s2">,</span>
            <span class="s3">'nulls_ordering'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">nulls_ordering</span><span class="s2">,</span>
        <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">get_sql_context</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">context_options</span><span class="s2">):</span>
        <span class="s1">context </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_context_options</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">context_options</span><span class="s2">:</span>
            <span class="s1">context</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">context_options</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">context_class</span><span class="s2">(**</span><span class="s1">context</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">conflict_statement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_conflict</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">conflict_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_conflict</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">_build_on_conflict_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_conflict</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_conflict_target</span><span class="s2">:</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ON CONFLICT'</span><span class="s2">)</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">EnclosedNodeList</span><span class="s2">([</span>
                <span class="s1">Entity</span><span class="s2">(</span><span class="s1">col</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">) </span><span class="s0">else </span><span class="s1">col</span>
                <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_conflict_target</span><span class="s2">])</span>
            <span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_conflict_where </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">target </span><span class="s2">= </span><span class="s1">NodeList</span><span class="s2">([</span><span class="s1">target</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'WHERE'</span><span class="s2">),</span>
                                   <span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_conflict_where</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ON CONFLICT ON CONSTRAINT'</span><span class="s2">)</span>
            <span class="s1">target </span><span class="s2">= </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_conflict_constraint</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                <span class="s1">target </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)</span>

        <span class="s1">updates </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_preserve</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_preserve</span><span class="s2">:</span>
                <span class="s1">excluded </span><span class="s2">= </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'EXCLUDED'</span><span class="s2">), </span><span class="s1">ensure_entity</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)),</span>
                                    <span class="s1">glue</span><span class="s2">=</span><span class="s3">'.'</span><span class="s2">)</span>
                <span class="s1">expression </span><span class="s2">= </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">ensure_entity</span><span class="s2">(</span><span class="s1">column</span><span class="s2">), </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">),</span>
                                       <span class="s1">excluded</span><span class="s2">))</span>
                <span class="s1">updates</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">expression</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_update</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_update</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                    <span class="s4"># Attempt to resolve string field-names to their respective</span>
                    <span class="s4"># field object, to apply data-type conversions.</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                        <span class="s1">k </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">query</span><span class="s2">.</span><span class="s1">table</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                        <span class="s1">v </span><span class="s2">= </span><span class="s1">k</span><span class="s2">.</span><span class="s1">to_value</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">v </span><span class="s2">= </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">unpack</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">v </span><span class="s2">= </span><span class="s1">QualifiedNames</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
                <span class="s1">updates</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">ensure_entity</span><span class="s2">(</span><span class="s1">k</span><span class="s2">), </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">), </span><span class="s1">v</span><span class="s2">)))</span>

        <span class="s1">parts </span><span class="s2">= [</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'DO UPDATE SET'</span><span class="s2">), </span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">updates</span><span class="s2">)]</span>
        <span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">:</span>
            <span class="s1">parts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'WHERE'</span><span class="s2">), </span><span class="s1">QualifiedNames</span><span class="s2">(</span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">)))</span>

        <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">parts</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">last_insert_id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">query_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">lastrowid</span>

    <span class="s0">def </span><span class="s1">rows_affected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">rowcount</span>

    <span class="s0">def </span><span class="s1">default_values_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'DEFAULT VALUES'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">session_start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">transaction</span><span class="s2">().</span><span class="s1">__enter__</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">session_commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">txn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pop_transaction</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s0">return False</span>
        <span class="s1">txn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">(</span><span class="s1">begin</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_transaction</span><span class="s2">())</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">session_rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">txn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pop_transaction</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s0">return False</span>
        <span class="s1">txn</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">(</span><span class="s1">begin</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_transaction</span><span class="s2">())</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">in_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">transactions</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">push_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">transaction</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">transactions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">transaction</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">pop_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">transactions</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">transaction_depth</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">transactions</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">top_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">transactions</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">transactions</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">atomic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_atomic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">manual_commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_manual</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">savepoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_savepoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">begin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">().</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'BEGIN'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">().</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'ROLLBACK'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">().</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'COMMIT'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">batch_commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">it</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">group </span><span class="s0">in </span><span class="s1">chunked</span><span class="s2">(</span><span class="s1">it</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">():</span>
                <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">group</span><span class="s2">:</span>
                    <span class="s0">yield </span><span class="s1">obj</span>

    <span class="s0">def </span><span class="s1">table_exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table_name</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">):</span>
            <span class="s1">model </span><span class="s2">= </span><span class="s1">table_name</span>
            <span class="s1">table_name </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table_name</span>
            <span class="s1">schema </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">schema</span>
        <span class="s0">return </span><span class="s1">table_name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_tables</span><span class="s2">(</span><span class="s1">schema</span><span class="s2">=</span><span class="s1">schema</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_tables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">get_indexes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">get_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">get_primary_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">get_foreign_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">sequence_exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">seq</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">create_tables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">models</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">sort_models</span><span class="s2">(</span><span class="s1">models</span><span class="s2">):</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">create_table</span><span class="s2">(**</span><span class="s1">options</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">drop_tables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">models</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">sort_models</span><span class="s2">(</span><span class="s1">models</span><span class="s2">)):</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">extract_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">truncate_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">from_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">models</span><span class="s2">, </span><span class="s1">bind_refs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">bind_backrefs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">models</span><span class="s2">:</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bind_refs</span><span class="s2">=</span><span class="s1">bind_refs</span><span class="s2">, </span><span class="s1">bind_backrefs</span><span class="s2">=</span><span class="s1">bind_backrefs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">bind_ctx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">models</span><span class="s2">, </span><span class="s1">bind_refs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">bind_backrefs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_BoundModelsContext</span><span class="s2">(</span><span class="s1">models</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">bind_refs</span><span class="s2">, </span><span class="s1">bind_backrefs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_noop_select</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Select</span><span class="s2">().</span><span class="s1">columns</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'0'</span><span class="s2">)).</span><span class="s1">where</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'0'</span><span class="s2">)))</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">Model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'_Model'</span><span class="s2">):</span>
            <span class="s0">class </span><span class="s1">Meta</span><span class="s2">: </span><span class="s1">database </span><span class="s2">= </span><span class="s1">self</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_Model </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s3">'BaseModel'</span><span class="s2">, (</span><span class="s1">Model</span><span class="s2">,), {</span><span class="s3">'Meta'</span><span class="s2">: </span><span class="s1">Meta</span><span class="s2">})</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_Model</span>


<span class="s0">def </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pragma</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pragma</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">property</span><span class="s2">(</span><span class="s1">__get__</span><span class="s2">, </span><span class="s1">__set__</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SqliteDatabase</span><span class="s2">(</span><span class="s1">Database</span><span class="s2">):</span>
    <span class="s1">field_types </span><span class="s2">= {</span>
        <span class="s3">'BIGAUTO'</span><span class="s2">: </span><span class="s1">FIELD</span><span class="s2">.</span><span class="s1">AUTO</span><span class="s2">,</span>
        <span class="s3">'BIGINT'</span><span class="s2">: </span><span class="s1">FIELD</span><span class="s2">.</span><span class="s1">INT</span><span class="s2">,</span>
        <span class="s3">'BOOL'</span><span class="s2">: </span><span class="s1">FIELD</span><span class="s2">.</span><span class="s1">INT</span><span class="s2">,</span>
        <span class="s3">'DOUBLE'</span><span class="s2">: </span><span class="s1">FIELD</span><span class="s2">.</span><span class="s1">FLOAT</span><span class="s2">,</span>
        <span class="s3">'SMALLINT'</span><span class="s2">: </span><span class="s1">FIELD</span><span class="s2">.</span><span class="s1">INT</span><span class="s2">,</span>
        <span class="s3">'UUID'</span><span class="s2">: </span><span class="s1">FIELD</span><span class="s2">.</span><span class="s1">TEXT</span><span class="s2">}</span>
    <span class="s1">operations </span><span class="s2">= {</span>
        <span class="s3">'LIKE'</span><span class="s2">: </span><span class="s3">'GLOB'</span><span class="s2">,</span>
        <span class="s3">'ILIKE'</span><span class="s2">: </span><span class="s3">'LIKE'</span><span class="s2">}</span>
    <span class="s1">index_schema_prefix </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">limit_max </span><span class="s2">= -</span><span class="s5">1</span>
    <span class="s1">server_version </span><span class="s2">= </span><span class="s1">__sqlite_version__</span>
    <span class="s1">truncate_table </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'pragmas'</span><span class="s2">, ())</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">SqliteDatabase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">database</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_aggregates </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_collations </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_functions </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_window_functions </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_table_functions </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_extensions </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_attached </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">register_function</span><span class="s2">(</span><span class="s1">_sqlite_date_part</span><span class="s2">, </span><span class="s3">'date_part'</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">register_function</span><span class="s2">(</span><span class="s1">_sqlite_date_trunc</span><span class="s2">, </span><span class="s3">'date_trunc'</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nulls_ordering </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">pragmas</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s5">5</span><span class="s2">, </span><span class="s1">returning_clause</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
             <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">pragmas </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas </span><span class="s2">= </span><span class="s1">pragmas</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">returning_clause </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">__sqlite_version__ </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">35</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s3">'RETURNING clause requires Sqlite 3.35 or newer'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">returning_clause </span><span class="s2">= </span><span class="s1">returning_clause</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timeout </span><span class="s2">= </span><span class="s1">timeout</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">SqliteDatabase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">init</span><span class="s2">(</span><span class="s1">database</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_set_server_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">_connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">sqlite3 </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ImproperlyConfigured</span><span class="s2">(</span><span class="s3">'SQLite driver not installed!'</span><span class="s2">)</span>
        <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_timeout</span><span class="s2">,</span>
                               <span class="s1">isolation_level</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">self</span><span class="s2">.</span><span class="s1">connect_params</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_add_conn_hooks</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s0">raise</span>
        <span class="s0">return </span><span class="s1">conn</span>

    <span class="s0">def </span><span class="s1">_add_conn_hooks</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attached</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_attach_databases</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_set_pragmas</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_aggregates</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_collations</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_functions</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">25</span><span class="s2">, </span><span class="s5">0</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_window_functions</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table_functions</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">table_function </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table_functions</span><span class="s2">:</span>
                <span class="s1">table_function</span><span class="s2">.</span><span class="s1">register</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_extensions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_extensions</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_set_pragmas</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">pragma</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas</span><span class="s2">:</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'PRAGMA %s = %s;' </span><span class="s2">% (</span><span class="s1">pragma</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>
        <span class="s1">cursor</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_attach_databases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">db </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attached</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">cursor</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'ATTACH DATABASE &quot;%s&quot; AS &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">db</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>
        <span class="s1">cursor</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">pragma</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">SENTINEL</span><span class="s2">, </span><span class="s1">permanent</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">schema </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s3">'&quot;%s&quot;.%s' </span><span class="s2">% (</span><span class="s1">schema</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)</span>
        <span class="s1">sql </span><span class="s2">= </span><span class="s3">'PRAGMA %s' </span><span class="s2">% </span><span class="s1">key</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is not </span><span class="s1">SENTINEL</span><span class="s2">:</span>
            <span class="s1">sql </span><span class="s2">+= </span><span class="s3">' = %s' </span><span class="s2">% (</span><span class="s1">value </span><span class="s0">or </span><span class="s5">0</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">permanent</span><span class="s2">:</span>
                <span class="s1">pragmas </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas </span><span class="s0">or </span><span class="s2">())</span>
                <span class="s1">pragmas</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">value</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_pragmas </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">pragmas</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">permanent</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot specify a permanent pragma without value'</span><span class="s2">)</span>
        <span class="s1">row </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">).</span><span class="s1">fetchone</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">row</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">row</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s1">cache_size </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'cache_size'</span><span class="s2">)</span>
    <span class="s1">foreign_keys </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'foreign_keys'</span><span class="s2">)</span>
    <span class="s1">journal_mode </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'journal_mode'</span><span class="s2">)</span>
    <span class="s1">journal_size_limit </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'journal_size_limit'</span><span class="s2">)</span>
    <span class="s1">mmap_size </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'mmap_size'</span><span class="s2">)</span>
    <span class="s1">page_size </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'page_size'</span><span class="s2">)</span>
    <span class="s1">read_uncommitted </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'read_uncommitted'</span><span class="s2">)</span>
    <span class="s1">synchronous </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'synchronous'</span><span class="s2">)</span>
    <span class="s1">wal_autocheckpoint </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'wal_autocheckpoint'</span><span class="s2">)</span>
    <span class="s1">application_id </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'application_id'</span><span class="s2">)</span>
    <span class="s1">user_version </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'user_version'</span><span class="s2">)</span>
    <span class="s1">data_version </span><span class="s2">= </span><span class="s1">__pragma__</span><span class="s2">(</span><span class="s3">'data_version'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">timeout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_timeout</span>

    <span class="s2">@</span><span class="s1">timeout</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">timeout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">seconds</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_timeout </span><span class="s2">== </span><span class="s1">seconds</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timeout </span><span class="s2">= </span><span class="s1">seconds</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s4"># PySQLite multiplies user timeout by 1000, but the unit of the</span>
            <span class="s4"># timeout PRAGMA is actually milliseconds.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'PRAGMA busy_timeout=%d;' </span><span class="s2">% (</span><span class="s1">seconds </span><span class="s2">* </span><span class="s5">1000</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_load_aggregates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, (</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">) </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_aggregates</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">create_aggregate</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">, </span><span class="s1">klass</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_load_collations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">fn </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_collations</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">create_collation</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_load_functions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, (</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">n_params</span><span class="s2">, </span><span class="s1">deterministic</span><span class="s2">) </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_functions</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">kwargs </span><span class="s2">= {</span><span class="s3">'deterministic'</span><span class="s2">: </span><span class="s1">deterministic</span><span class="s2">} </span><span class="s0">if </span><span class="s1">deterministic </span><span class="s0">else </span><span class="s2">{}</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">create_function</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">n_params</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_load_window_functions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, (</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">) </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_window_functions</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">create_window_function</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">, </span><span class="s1">klass</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">register_aggregate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">klass</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_aggregates</span><span class="s2">[</span><span class="s1">name </span><span class="s0">or </span><span class="s1">klass</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()] = (</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_aggregates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">connection</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">aggregate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">register_aggregate</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">klass</span>
        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s0">def </span><span class="s1">register_collation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">name </span><span class="s0">or </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">__name__</span>
        <span class="s0">def </span><span class="s1">_collation</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">):</span>
            <span class="s1">expressions </span><span class="s2">= </span><span class="s1">args </span><span class="s2">+ (</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'collate %s' </span><span class="s2">% </span><span class="s1">name</span><span class="s2">),)</span>
            <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">expressions</span><span class="s2">)</span>
        <span class="s1">fn</span><span class="s2">.</span><span class="s1">collation </span><span class="s2">= </span><span class="s1">_collation</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_collations</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">fn</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_collations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">connection</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">collation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">register_collation</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">fn</span>
        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s0">def </span><span class="s1">register_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">,</span>
                          <span class="s1">deterministic</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_functions</span><span class="s2">[</span><span class="s1">name </span><span class="s0">or </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">] = (</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">, </span><span class="s1">deterministic</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_functions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">connection</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">, </span><span class="s1">deterministic</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">register_function</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">, </span><span class="s1">deterministic</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">fn</span>
        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s0">def </span><span class="s1">register_window_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">klass</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">name </span><span class="s0">or </span><span class="s1">klass</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_window_functions</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = (</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_load_window_functions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">connection</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">window_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">register_window_function</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">num_params</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">klass</span>
        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s0">def </span><span class="s1">register_table_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">klass</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">klass</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_table_functions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">klass</span><span class="s2">.</span><span class="s1">register</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">connection</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">table_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">register_table_function</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">klass</span>
        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s0">def </span><span class="s1">unregister_aggregate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">del</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_aggregates</span><span class="s2">[</span><span class="s1">name</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">unregister_collation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">del</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_collations</span><span class="s2">[</span><span class="s1">name</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">unregister_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">del</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_functions</span><span class="s2">[</span><span class="s1">name</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">unregister_window_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">del</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_window_functions</span><span class="s2">[</span><span class="s1">name</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">unregister_table_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">klass </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table_functions</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">klass</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">name</span><span class="s2">:</span>
                <span class="s0">break</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_table_functions</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">_load_extensions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">enable_load_extension</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">extension </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_extensions</span><span class="s2">:</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">load_extension</span><span class="s2">(</span><span class="s1">extension</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">load_extension</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extension</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_extensions</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">extension</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">conn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connection</span><span class="s2">()</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">enable_load_extension</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">load_extension</span><span class="s2">(</span><span class="s1">extension</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">unload_extension</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extension</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_extensions</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">extension</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">attach</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attached</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attached</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] == </span><span class="s1">filename</span><span class="s2">:</span>
                <span class="s0">return False</span>
            <span class="s0">raise </span><span class="s1">OperationalError</span><span class="s2">(</span><span class="s3">'schema &quot;%s&quot; already attached.' </span><span class="s2">% </span><span class="s1">name</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_attached</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">filename</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'ATTACH DATABASE &quot;%s&quot; AS &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">detach</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attached</span><span class="s2">:</span>
            <span class="s0">return False</span>

        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attached</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'DETACH DATABASE &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">last_insert_id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">query_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">returning_clause</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">lastrowid</span>
        <span class="s0">elif </span><span class="s1">query_type </span><span class="s2">== </span><span class="s1">Insert</span><span class="s2">.</span><span class="s1">SIMPLE</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">cursor</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">]</span>
            <span class="s0">except </span><span class="s2">(</span><span class="s1">IndexError</span><span class="s2">, </span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">):</span>
                <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">cursor</span>

    <span class="s0">def </span><span class="s1">rows_affected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">rowcount</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">rowcount  </span><span class="s4"># This was a RETURNING query.</span>

    <span class="s0">def </span><span class="s1">begin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lock_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">statement </span><span class="s2">= </span><span class="s3">'BEGIN %s' </span><span class="s2">% </span><span class="s1">lock_type </span><span class="s0">if </span><span class="s1">lock_type </span><span class="s0">else </span><span class="s3">'BEGIN'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">statement</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">get_tables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">schema </span><span class="s2">= </span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'main'</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'SELECT name FROM &quot;%s&quot;.sqlite_master WHERE '</span>
                                  <span class="s3">'type=? ORDER BY name' </span><span class="s2">% </span><span class="s1">schema</span><span class="s2">, (</span><span class="s3">'table'</span><span class="s2">,))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">row </span><span class="s0">for </span><span class="s1">row</span><span class="s2">, </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_views</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">sql </span><span class="s2">= (</span><span class="s3">'SELECT name, sql FROM &quot;%s&quot;.sqlite_master WHERE type=? '</span>
               <span class="s3">'ORDER BY name'</span><span class="s2">) % (</span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'main'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">ViewMetadata</span><span class="s2">(*</span><span class="s1">row</span><span class="s2">) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">, (</span><span class="s3">'view'</span><span class="s2">,))]</span>

    <span class="s0">def </span><span class="s1">get_indexes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">schema </span><span class="s2">= </span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'main'</span>
        <span class="s1">query </span><span class="s2">= (</span><span class="s3">'SELECT name, sql FROM &quot;%s&quot;.sqlite_master '</span>
                 <span class="s3">'WHERE tbl_name = ? AND type = ? ORDER BY name'</span><span class="s2">) % </span><span class="s1">schema</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, (</span><span class="s1">table</span><span class="s2">, </span><span class="s3">'index'</span><span class="s2">))</span>
        <span class="s1">index_to_sql </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">())</span>

        <span class="s4"># Determine which indexes have a unique constraint.</span>
        <span class="s1">unique_indexes </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'PRAGMA &quot;%s&quot;.index_list(&quot;%s&quot;)' </span><span class="s2">%</span>
                                  <span class="s2">(</span><span class="s1">schema</span><span class="s2">, </span><span class="s1">table</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">():</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">row</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
            <span class="s1">is_unique </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]) == </span><span class="s5">1</span>
            <span class="s0">if </span><span class="s1">is_unique</span><span class="s2">:</span>
                <span class="s1">unique_indexes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s4"># Retrieve the indexed columns.</span>
        <span class="s1">index_columns </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">index_name </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">index_to_sql</span><span class="s2">):</span>
            <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'PRAGMA &quot;%s&quot;.index_info(&quot;%s&quot;)' </span><span class="s2">%</span>
                                      <span class="s2">(</span><span class="s1">schema</span><span class="s2">, </span><span class="s1">index_name</span><span class="s2">))</span>
            <span class="s1">index_columns</span><span class="s2">[</span><span class="s1">index_name</span><span class="s2">] = [</span><span class="s1">row</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

        <span class="s0">return </span><span class="s2">[</span>
            <span class="s1">IndexMetadata</span><span class="s2">(</span>
                <span class="s1">name</span><span class="s2">,</span>
                <span class="s1">index_to_sql</span><span class="s2">[</span><span class="s1">name</span><span class="s2">],</span>
                <span class="s1">index_columns</span><span class="s2">[</span><span class="s1">name</span><span class="s2">],</span>
                <span class="s1">name </span><span class="s0">in </span><span class="s1">unique_indexes</span><span class="s2">,</span>
                <span class="s1">table</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">index_to_sql</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">get_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'PRAGMA &quot;%s&quot;.table_info(&quot;%s&quot;)' </span><span class="s2">%</span>
                                  <span class="s2">(</span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'main'</span><span class="s2">, </span><span class="s1">table</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">ColumnMetadata</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">r</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s0">not </span><span class="s1">r</span><span class="s2">[</span><span class="s5">3</span><span class="s2">], </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s5">5</span><span class="s2">]), </span><span class="s1">table</span><span class="s2">, </span><span class="s1">r</span><span class="s2">[</span><span class="s5">4</span><span class="s2">])</span>
                <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_primary_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'PRAGMA &quot;%s&quot;.table_info(&quot;%s&quot;)' </span><span class="s2">%</span>
                                  <span class="s2">(</span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'main'</span><span class="s2">, </span><span class="s1">table</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">row</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">filter</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">r</span><span class="s2">: </span><span class="s1">r</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">())]</span>

    <span class="s0">def </span><span class="s1">get_foreign_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'PRAGMA &quot;%s&quot;.foreign_key_list(&quot;%s&quot;)' </span><span class="s2">%</span>
                                  <span class="s2">(</span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'main'</span><span class="s2">, </span><span class="s1">table</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">ForeignKeyMetadata</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s5">3</span><span class="s2">], </span><span class="s1">row</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">row</span><span class="s2">[</span><span class="s5">4</span><span class="s2">], </span><span class="s1">table</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_binary_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Binary</span>

    <span class="s0">def </span><span class="s1">conflict_statement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_conflict</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s1">action </span><span class="s2">= </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_action</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_action </span><span class="s0">else </span><span class="s3">''</span>
        <span class="s0">if </span><span class="s1">action </span><span class="s0">and </span><span class="s1">action </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">'nothing'</span><span class="s2">, </span><span class="s3">'update'</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'INSERT OR %s' </span><span class="s2">% </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_action</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">conflict_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">oc</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s4"># Sqlite prior to 3.24.0 does not support Postgres-style upsert.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">24</span><span class="s2">, </span><span class="s5">0</span><span class="s2">) </span><span class="s0">and </span><span class="s1">\</span>
           <span class="s1">any</span><span class="s2">((</span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_preserve</span><span class="s2">, </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_update</span><span class="s2">, </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_where</span><span class="s2">, </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_conflict_target</span><span class="s2">,</span>
                <span class="s1">oc</span><span class="s2">.</span><span class="s1">_conflict_constraint</span><span class="s2">)):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'SQLite does not support specifying which values '</span>
                             <span class="s3">'to preserve or update.'</span><span class="s2">)</span>

        <span class="s1">action </span><span class="s2">= </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_action</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">if </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_action </span><span class="s0">else </span><span class="s3">''</span>
        <span class="s0">if </span><span class="s1">action </span><span class="s0">and </span><span class="s1">action </span><span class="s0">not in </span><span class="s2">(</span><span class="s3">'nothing'</span><span class="s2">, </span><span class="s3">'update'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">):</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">action </span><span class="s2">== </span><span class="s3">'nothing'</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ON CONFLICT DO NOTHING'</span><span class="s2">)</span>
        <span class="s0">elif not </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_update </span><span class="s0">and not </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_preserve</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'If you are not performing any updates (or '</span>
                             <span class="s3">'preserving any INSERTed values), then the '</span>
                             <span class="s3">'conflict resolution action should be set to '</span>
                             <span class="s3">'&quot;NOTHING&quot;.'</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_conflict_constraint</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'SQLite does not support specifying named '</span>
                             <span class="s3">'constraints for conflict resolution.'</span><span class="s2">)</span>
        <span class="s0">elif not </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_conflict_target</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'SQLite requires that a conflict target be '</span>
                             <span class="s3">'specified when doing an upsert.'</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_build_on_conflict_update</span><span class="s2">(</span><span class="s1">oc</span><span class="s2">, </span><span class="s1">query</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">extract_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">date_part</span><span class="s2">(</span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">, </span><span class="s1">python_value</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">truncate_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">date_trunc</span><span class="s2">(</span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">,</span>
                             <span class="s1">python_value</span><span class="s2">=</span><span class="s1">simple_date_time</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s3">'%s'</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">).</span><span class="s1">cast</span><span class="s2">(</span><span class="s3">'integer'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">from_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s1">date_field</span><span class="s2">, </span><span class="s3">'unixepoch'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">PostgresqlDatabase</span><span class="s2">(</span><span class="s1">Database</span><span class="s2">):</span>
    <span class="s1">field_types </span><span class="s2">= {</span>
        <span class="s3">'AUTO'</span><span class="s2">: </span><span class="s3">'SERIAL'</span><span class="s2">,</span>
        <span class="s3">'BIGAUTO'</span><span class="s2">: </span><span class="s3">'BIGSERIAL'</span><span class="s2">,</span>
        <span class="s3">'BLOB'</span><span class="s2">: </span><span class="s3">'BYTEA'</span><span class="s2">,</span>
        <span class="s3">'BOOL'</span><span class="s2">: </span><span class="s3">'BOOLEAN'</span><span class="s2">,</span>
        <span class="s3">'DATETIME'</span><span class="s2">: </span><span class="s3">'TIMESTAMP'</span><span class="s2">,</span>
        <span class="s3">'DECIMAL'</span><span class="s2">: </span><span class="s3">'NUMERIC'</span><span class="s2">,</span>
        <span class="s3">'DOUBLE'</span><span class="s2">: </span><span class="s3">'DOUBLE PRECISION'</span><span class="s2">,</span>
        <span class="s3">'UUID'</span><span class="s2">: </span><span class="s3">'UUID'</span><span class="s2">,</span>
        <span class="s3">'UUIDB'</span><span class="s2">: </span><span class="s3">'BYTEA'</span><span class="s2">}</span>
    <span class="s1">operations </span><span class="s2">= {</span><span class="s3">'REGEXP'</span><span class="s2">: </span><span class="s3">'~'</span><span class="s2">, </span><span class="s3">'IREGEXP'</span><span class="s2">: </span><span class="s3">'~*'</span><span class="s2">}</span>
    <span class="s1">param </span><span class="s2">= </span><span class="s3">'%s'</span>

    <span class="s1">compound_select_parentheses </span><span class="s2">= </span><span class="s1">CSQ_PARENTHESES_ALWAYS</span>
    <span class="s1">for_update </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">nulls_ordering </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">returning_clause </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">safe_create_index </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">sequences </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">register_unicode</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
             <span class="s1">isolation_level</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_register_unicode </span><span class="s2">= </span><span class="s1">register_unicode</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_encoding </span><span class="s2">= </span><span class="s1">encoding</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_isolation_level </span><span class="s2">= </span><span class="s1">isolation_level</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">PostgresqlDatabase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">init</span><span class="s2">(</span><span class="s1">database</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">psycopg2 </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ImproperlyConfigured</span><span class="s2">(</span><span class="s3">'Postgres driver not installed!'</span><span class="s2">)</span>

        <span class="s4"># Handle connection-strings nicely, since psycopg2 will accept them,</span>
        <span class="s4"># and they may be easier when lots of parameters are specified.</span>
        <span class="s1">params </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connect_params</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'postgresql://'</span><span class="s2">):</span>
            <span class="s1">params</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'dsn'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">params</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'dbname'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">)</span>

        <span class="s1">conn </span><span class="s2">= </span><span class="s1">psycopg2</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(**</span><span class="s1">params</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_register_unicode</span><span class="s2">:</span>
            <span class="s1">pg_extensions</span><span class="s2">.</span><span class="s1">register_type</span><span class="s2">(</span><span class="s1">pg_extensions</span><span class="s2">.</span><span class="s1">UNICODE</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
            <span class="s1">pg_extensions</span><span class="s2">.</span><span class="s1">register_type</span><span class="s2">(</span><span class="s1">pg_extensions</span><span class="s2">.</span><span class="s1">UNICODEARRAY</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_encoding</span><span class="s2">:</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">set_client_encoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_encoding</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_isolation_level</span><span class="s2">:</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">set_isolation_level</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_isolation_level</span><span class="s2">)</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">autocommit </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">return </span><span class="s1">conn</span>

    <span class="s0">def </span><span class="s1">_set_server_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">server_version</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s2">&gt;= </span><span class="s5">90600</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">safe_create_index </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">is_connection_usable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">closed</span><span class="s2">:</span>
            <span class="s0">return False</span>

        <span class="s4"># Returns True if we are idle, running a command, or in an active</span>
        <span class="s4"># connection. If the connection is in an error state or the connection</span>
        <span class="s4"># is otherwise unusable, return False.</span>
        <span class="s1">txn_status </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">.</span><span class="s1">get_transaction_status</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">txn_status </span><span class="s2">&lt; </span><span class="s1">pg_extensions</span><span class="s2">.</span><span class="s1">TRANSACTION_STATUS_INERROR</span>

    <span class="s0">def </span><span class="s1">last_insert_id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">query_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cursor </span><span class="s0">if </span><span class="s1">query_type </span><span class="s2">!= </span><span class="s1">Insert</span><span class="s2">.</span><span class="s1">SIMPLE </span><span class="s0">else </span><span class="s1">cursor</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s2">(</span><span class="s1">IndexError</span><span class="s2">, </span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">rows_affected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">rowcount</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">rowcount</span>

    <span class="s0">def </span><span class="s1">begin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">isolation_level</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">isolation_level</span><span class="s2">:</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s3">'BEGIN TRANSACTION ISOLATION LEVEL %s' </span><span class="s2">% </span><span class="s1">isolation_level</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s3">'BEGIN'</span>
        <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">().</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_tables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= (</span><span class="s3">'SELECT tablename FROM pg_catalog.pg_tables '</span>
                 <span class="s3">'WHERE schemaname = %s ORDER BY tablename'</span><span class="s2">)</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, (</span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'public'</span><span class="s2">,))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">table </span><span class="s0">for </span><span class="s1">table</span><span class="s2">, </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_views</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= (</span><span class="s3">'SELECT viewname, definition FROM pg_catalog.pg_views '</span>
                 <span class="s3">'WHERE schemaname = %s ORDER BY viewname'</span><span class="s2">)</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, (</span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'public'</span><span class="s2">,))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">ViewMetadata</span><span class="s2">(</span><span class="s1">view_name</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s3">' </span><span class="s0">\t</span><span class="s3">;'</span><span class="s2">))</span>
                <span class="s0">for </span><span class="s2">(</span><span class="s1">view_name</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">) </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_indexes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
            SELECT 
                i.relname, idxs.indexdef, idx.indisunique, 
                array_to_string(ARRAY( 
                    SELECT pg_get_indexdef(idx.indexrelid, k + 1, TRUE) 
                    FROM generate_subscripts(idx.indkey, 1) AS k 
                    ORDER BY k), ',') 
            FROM pg_catalog.pg_class AS t 
            INNER JOIN pg_catalog.pg_index AS idx ON t.oid = idx.indrelid 
            INNER JOIN pg_catalog.pg_class AS i ON idx.indexrelid = i.oid 
            INNER JOIN pg_catalog.pg_indexes AS idxs ON 
                (idxs.tablename = t.relname AND idxs.indexname = i.relname) 
            WHERE t.relname = %s AND t.relkind = %s AND idxs.schemaname = %s 
            ORDER BY idx.indisunique DESC, i.relname;&quot;&quot;&quot;</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, (</span><span class="s1">table</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'public'</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">IndexMetadata</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s3">' ;'</span><span class="s2">), </span><span class="s1">columns</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">','</span><span class="s2">),</span>
                              <span class="s1">is_unique</span><span class="s2">, </span><span class="s1">table</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">, </span><span class="s1">is_unique</span><span class="s2">, </span><span class="s1">columns </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
            SELECT column_name, is_nullable, data_type, column_default 
            FROM information_schema.columns 
            WHERE table_name = %s AND table_schema = %s 
            ORDER BY ordinal_position&quot;&quot;&quot;</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, (</span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'public'</span><span class="s2">))</span>
        <span class="s1">pks </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_primary_keys</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">ColumnMetadata</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">null </span><span class="s2">== </span><span class="s3">'YES'</span><span class="s2">, </span><span class="s1">name </span><span class="s0">in </span><span class="s1">pks</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">null</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">df </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_primary_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
            SELECT kc.column_name 
            FROM information_schema.table_constraints AS tc 
            INNER JOIN information_schema.key_column_usage AS kc ON ( 
                tc.table_name = kc.table_name AND 
                tc.table_schema = kc.table_schema AND 
                tc.constraint_name = kc.constraint_name) 
            WHERE 
                tc.constraint_type = %s AND 
                tc.table_name = %s AND 
                tc.table_schema = %s&quot;&quot;&quot;</span>
        <span class="s1">ctype </span><span class="s2">= </span><span class="s3">'PRIMARY KEY'</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, (</span><span class="s1">ctype</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'public'</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">pk </span><span class="s0">for </span><span class="s1">pk</span><span class="s2">, </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_foreign_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">sql </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
            SELECT DISTINCT 
                kcu.column_name, ccu.table_name, ccu.column_name 
            FROM information_schema.table_constraints AS tc 
            JOIN information_schema.key_column_usage AS kcu 
                ON (tc.constraint_name = kcu.constraint_name AND 
                    tc.constraint_schema = kcu.constraint_schema AND 
                    tc.table_name = kcu.table_name AND 
                    tc.table_schema = kcu.table_schema) 
            JOIN information_schema.constraint_column_usage AS ccu 
                ON (ccu.constraint_name = tc.constraint_name AND 
                    ccu.constraint_schema = tc.constraint_schema) 
            WHERE 
                tc.constraint_type = 'FOREIGN KEY' AND 
                tc.table_name = %s AND 
                tc.table_schema = %s&quot;&quot;&quot;</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">, (</span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema </span><span class="s0">or </span><span class="s3">'public'</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">ForeignKeyMetadata</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">row</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">row</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">table</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">sequence_exists</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sequence</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot; 
            SELECT COUNT(*) FROM pg_class, pg_namespace 
            WHERE relkind='S' 
                AND pg_class.relnamespace = pg_namespace.oid 
                AND relname=%s&quot;&quot;&quot;</span><span class="s2">, (</span><span class="s1">sequence</span><span class="s2">,))</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fetchone</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">get_binary_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">psycopg2</span><span class="s2">.</span><span class="s1">Binary</span>

    <span class="s0">def </span><span class="s1">conflict_statement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_conflict</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s0">return</span>

    <span class="s0">def </span><span class="s1">conflict_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">oc</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s1">action </span><span class="s2">= </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_action</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">if </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_action </span><span class="s0">else </span><span class="s3">''</span>
        <span class="s0">if </span><span class="s1">action </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'ignore'</span><span class="s2">, </span><span class="s3">'nothing'</span><span class="s2">):</span>
            <span class="s1">parts </span><span class="s2">= [</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ON CONFLICT'</span><span class="s2">)]</span>
            <span class="s0">if </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_conflict_target</span><span class="s2">:</span>
                <span class="s1">parts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">([</span>
                    <span class="s1">Entity</span><span class="s2">(</span><span class="s1">col</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">) </span><span class="s0">else </span><span class="s1">col</span>
                    <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_conflict_target</span><span class="s2">]))</span>
            <span class="s1">parts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'DO NOTHING'</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">parts</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">action </span><span class="s0">and </span><span class="s1">action </span><span class="s2">!= </span><span class="s3">'update'</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'The only supported actions for conflict '</span>
                             <span class="s3">'resolution with Postgresql are &quot;ignore&quot; or '</span>
                             <span class="s3">'&quot;update&quot;.'</span><span class="s2">)</span>
        <span class="s0">elif not </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_update </span><span class="s0">and not </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_preserve</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'If you are not performing any updates (or '</span>
                             <span class="s3">'preserving any INSERTed values), then the '</span>
                             <span class="s3">'conflict resolution action should be set to '</span>
                             <span class="s3">'&quot;IGNORE&quot;.'</span><span class="s2">)</span>
        <span class="s0">elif not </span><span class="s2">(</span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_conflict_target </span><span class="s0">or </span><span class="s1">oc</span><span class="s2">.</span><span class="s1">_conflict_constraint</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Postgres requires that a conflict target be '</span>
                             <span class="s3">'specified when doing an upsert.'</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_build_on_conflict_update</span><span class="s2">(</span><span class="s1">oc</span><span class="s2">, </span><span class="s1">query</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">extract_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">EXTRACT</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'FROM'</span><span class="s2">), </span><span class="s1">date_field</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">truncate_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">DATE_TRUNC</span><span class="s2">(</span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extract_date</span><span class="s2">(</span><span class="s3">'EPOCH'</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">from_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s4"># Ironically, here, Postgres means &quot;to the Postgresql timestamp type&quot;.</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">date_field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_noop_select</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Select</span><span class="s2">().</span><span class="s1">columns</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'0'</span><span class="s2">)).</span><span class="s1">where</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'false'</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">set_time_zone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">timezone</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'set time zone &quot;%s&quot;;' </span><span class="s2">% </span><span class="s1">timezone</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">MySQLDatabase</span><span class="s2">(</span><span class="s1">Database</span><span class="s2">):</span>
    <span class="s1">field_types </span><span class="s2">= {</span>
        <span class="s3">'AUTO'</span><span class="s2">: </span><span class="s3">'INTEGER AUTO_INCREMENT'</span><span class="s2">,</span>
        <span class="s3">'BIGAUTO'</span><span class="s2">: </span><span class="s3">'BIGINT AUTO_INCREMENT'</span><span class="s2">,</span>
        <span class="s3">'BOOL'</span><span class="s2">: </span><span class="s3">'BOOL'</span><span class="s2">,</span>
        <span class="s3">'DECIMAL'</span><span class="s2">: </span><span class="s3">'NUMERIC'</span><span class="s2">,</span>
        <span class="s3">'DOUBLE'</span><span class="s2">: </span><span class="s3">'DOUBLE PRECISION'</span><span class="s2">,</span>
        <span class="s3">'FLOAT'</span><span class="s2">: </span><span class="s3">'FLOAT'</span><span class="s2">,</span>
        <span class="s3">'UUID'</span><span class="s2">: </span><span class="s3">'VARCHAR(40)'</span><span class="s2">,</span>
        <span class="s3">'UUIDB'</span><span class="s2">: </span><span class="s3">'VARBINARY(16)'</span><span class="s2">}</span>
    <span class="s1">operations </span><span class="s2">= {</span>
        <span class="s3">'LIKE'</span><span class="s2">: </span><span class="s3">'LIKE BINARY'</span><span class="s2">,</span>
        <span class="s3">'ILIKE'</span><span class="s2">: </span><span class="s3">'LIKE'</span><span class="s2">,</span>
        <span class="s3">'REGEXP'</span><span class="s2">: </span><span class="s3">'REGEXP BINARY'</span><span class="s2">,</span>
        <span class="s3">'IREGEXP'</span><span class="s2">: </span><span class="s3">'REGEXP'</span><span class="s2">,</span>
        <span class="s3">'XOR'</span><span class="s2">: </span><span class="s3">'XOR'</span><span class="s2">}</span>
    <span class="s1">param </span><span class="s2">= </span><span class="s3">'%s'</span>
    <span class="s1">quote </span><span class="s2">= </span><span class="s3">'``'</span>

    <span class="s1">compound_select_parentheses </span><span class="s2">= </span><span class="s1">CSQ_PARENTHESES_UNNESTED</span>
    <span class="s1">for_update </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">index_using_precedes_table </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">limit_max </span><span class="s2">= </span><span class="s5">2 </span><span class="s2">** </span><span class="s5">64 </span><span class="s2">- </span><span class="s5">1</span>
    <span class="s1">safe_create_index </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">safe_drop_index </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">sql_mode </span><span class="s2">= </span><span class="s3">'PIPES_AS_CONCAT'</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">params </span><span class="s2">= {</span>
            <span class="s3">'charset'</span><span class="s2">: </span><span class="s3">'utf8'</span><span class="s2">,</span>
            <span class="s3">'sql_mode'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sql_mode</span><span class="s2">,</span>
            <span class="s3">'use_unicode'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>
        <span class="s1">params</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s3">'password' </span><span class="s0">in </span><span class="s1">params </span><span class="s0">and </span><span class="s1">mysql_passwd</span><span class="s2">:</span>
            <span class="s1">params</span><span class="s2">[</span><span class="s3">'passwd'</span><span class="s2">] = </span><span class="s1">params</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'password'</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">MySQLDatabase</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">init</span><span class="s2">(</span><span class="s1">database</span><span class="s2">, **</span><span class="s1">params</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">mysql </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ImproperlyConfigured</span><span class="s2">(</span><span class="s3">'MySQL driver not installed!'</span><span class="s2">)</span>
        <span class="s1">conn </span><span class="s2">= </span><span class="s1">mysql</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">db</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">, </span><span class="s1">autocommit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                             <span class="s2">**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">connect_params</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">conn</span>

    <span class="s0">def </span><span class="s1">_set_server_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">version_raw </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">server_version</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s1">version_raw </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">get_server_info</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_extract_server_version</span><span class="s2">(</span><span class="s1">version_raw</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_extract_server_version</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">version </span><span class="s2">= </span><span class="s1">version</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s3">'maria' </span><span class="s0">in </span><span class="s1">version</span><span class="s2">:</span>
            <span class="s1">match_obj </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s3">r'(1\d\.\d+\.\d+)'</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">match_obj </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s3">r'(\d\.\d+\.\d+)'</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">match_obj </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">num</span><span class="s2">) </span><span class="s0">for </span><span class="s1">num </span><span class="s0">in </span><span class="s1">match_obj</span><span class="s2">.</span><span class="s1">groups</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">))</span>

        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s3">'Unable to determine MySQL version: &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">version</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)  </span><span class="s4"># Unable to determine version!</span>

    <span class="s0">def </span><span class="s1">is_connection_usable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">closed</span><span class="s2">:</span>
            <span class="s0">return False</span>

        <span class="s1">conn </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span><span class="s2">.</span><span class="s1">conn</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">'ping'</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">server_version</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s5">8</span><span class="s2">:</span>
                <span class="s1">args </span><span class="s2">= ()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">args </span><span class="s2">= (</span><span class="s0">False</span><span class="s2">,)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">conn</span><span class="s2">.</span><span class="s1">ping</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
                <span class="s0">return False</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">default_values_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'() VALUES ()'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">begin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">isolation_level</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_closed</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">__exception_wrapper__</span><span class="s2">:</span>
            <span class="s1">curs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">isolation_level</span><span class="s2">:</span>
                <span class="s1">curs</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'SET TRANSACTION ISOLATION LEVEL %s' </span><span class="s2">%</span>
                             <span class="s1">isolation_level</span><span class="s2">)</span>
            <span class="s1">curs</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'BEGIN'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_tables</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= (</span><span class="s3">'SELECT table_name FROM information_schema.tables '</span>
                 <span class="s3">'WHERE table_schema = DATABASE() AND table_type != %s '</span>
                 <span class="s3">'ORDER BY table_name'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">table </span><span class="s0">for </span><span class="s1">table</span><span class="s2">, </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, (</span><span class="s3">'VIEW'</span><span class="s2">,))]</span>

    <span class="s0">def </span><span class="s1">get_views</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= (</span><span class="s3">'SELECT table_name, view_definition '</span>
                 <span class="s3">'FROM information_schema.views '</span>
                 <span class="s3">'WHERE table_schema = DATABASE() ORDER BY table_name'</span><span class="s2">)</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">ViewMetadata</span><span class="s2">(*</span><span class="s1">row</span><span class="s2">) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_indexes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'SHOW INDEX FROM `%s`' </span><span class="s2">% </span><span class="s1">table</span><span class="s2">)</span>
        <span class="s1">unique </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">indexes </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">():</span>
            <span class="s0">if not </span><span class="s1">row</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]:</span>
                <span class="s1">unique</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s5">2</span><span class="s2">])</span>
            <span class="s1">indexes</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], [])</span>
            <span class="s1">indexes</span><span class="s2">[</span><span class="s1">row</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s5">4</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">IndexMetadata</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">indexes</span><span class="s2">[</span><span class="s1">name</span><span class="s2">], </span><span class="s1">name </span><span class="s0">in </span><span class="s1">unique</span><span class="s2">, </span><span class="s1">table</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">indexes</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">get_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">sql </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
            SELECT column_name, is_nullable, data_type, column_default 
            FROM information_schema.columns 
            WHERE table_name = %s AND table_schema = DATABASE() 
            ORDER BY ordinal_position&quot;&quot;&quot;</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">, (</span><span class="s1">table</span><span class="s2">,))</span>
        <span class="s1">pks </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_primary_keys</span><span class="s2">(</span><span class="s1">table</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">ColumnMetadata</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">null </span><span class="s2">== </span><span class="s3">'YES'</span><span class="s2">, </span><span class="s1">name </span><span class="s0">in </span><span class="s1">pks</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">null</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">df </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_primary_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'SHOW INDEX FROM `%s`' </span><span class="s2">% </span><span class="s1">table</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">row</span><span class="s2">[</span><span class="s5">4</span><span class="s2">] </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in</span>
                <span class="s1">filter</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">row</span><span class="s2">: </span><span class="s1">row</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] == </span><span class="s3">'PRIMARY'</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">())]</span>

    <span class="s0">def </span><span class="s1">get_foreign_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
            SELECT column_name, referenced_table_name, referenced_column_name 
            FROM information_schema.key_column_usage 
            WHERE table_name = %s 
                AND table_schema = DATABASE() 
                AND referenced_table_name IS NOT NULL 
                AND referenced_column_name IS NOT NULL&quot;&quot;&quot;</span>
        <span class="s1">cursor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, (</span><span class="s1">table</span><span class="s2">,))</span>
        <span class="s0">return </span><span class="s2">[</span>
            <span class="s1">ForeignKeyMetadata</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">dest_table</span><span class="s2">, </span><span class="s1">dest_column</span><span class="s2">, </span><span class="s1">table</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">column</span><span class="s2">, </span><span class="s1">dest_table</span><span class="s2">, </span><span class="s1">dest_column </span><span class="s0">in </span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">get_binary_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">mysql</span><span class="s2">.</span><span class="s1">Binary</span>

    <span class="s0">def </span><span class="s1">conflict_statement</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_conflict</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_action</span><span class="s2">: </span><span class="s0">return</span>

        <span class="s1">action </span><span class="s2">= </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_action</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">action </span><span class="s2">== </span><span class="s3">'replace'</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'REPLACE'</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">action </span><span class="s2">== </span><span class="s3">'ignore'</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'INSERT IGNORE'</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">action </span><span class="s2">!= </span><span class="s3">'update'</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Un-supported action for conflict resolution. '</span>
                             <span class="s3">'MySQL supports REPLACE, IGNORE and UPDATE.'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">conflict_update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">on_conflict</span><span class="s2">, </span><span class="s1">query</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_where </span><span class="s0">or </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_conflict_target </span><span class="s0">or </span><span class="s1">\</span>
           <span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_conflict_constraint</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'MySQL does not support the specification of '</span>
                             <span class="s3">'where clauses or conflict targets for conflict '</span>
                             <span class="s3">'resolution.'</span><span class="s2">)</span>

        <span class="s1">updates </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_preserve</span><span class="s2">:</span>
            <span class="s4"># Here we need to determine which function to use, which varies</span>
            <span class="s4"># depending on the MySQL server version. MySQL and MariaDB prior to</span>
            <span class="s4"># 10.3.3 use &quot;VALUES&quot;, while MariaDB 10.3.3+ use &quot;VALUE&quot;.</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">server_version </span><span class="s0">or </span><span class="s2">(</span><span class="s5">0</span><span class="s2">,)</span>
            <span class="s0">if </span><span class="s1">version</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s5">10 </span><span class="s0">and </span><span class="s1">version </span><span class="s2">&gt;= (</span><span class="s5">10</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">):</span>
                <span class="s1">VALUE_FN </span><span class="s2">= </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">VALUE</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">VALUE_FN </span><span class="s2">= </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">VALUES</span>

            <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_preserve</span><span class="s2">:</span>
                <span class="s1">entity </span><span class="s2">= </span><span class="s1">ensure_entity</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)</span>
                <span class="s1">expression </span><span class="s2">= </span><span class="s1">NodeList</span><span class="s2">((</span>
                    <span class="s1">ensure_entity</span><span class="s2">(</span><span class="s1">column</span><span class="s2">),</span>
                    <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">),</span>
                    <span class="s1">VALUE_FN</span><span class="s2">(</span><span class="s1">entity</span><span class="s2">)))</span>
                <span class="s1">updates</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">expression</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_update</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">on_conflict</span><span class="s2">.</span><span class="s1">_update</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                    <span class="s4"># Attempt to resolve string field-names to their respective</span>
                    <span class="s4"># field object, to apply data-type conversions.</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                        <span class="s1">k </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">query</span><span class="s2">.</span><span class="s1">table</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                        <span class="s1">v </span><span class="s2">= </span><span class="s1">k</span><span class="s2">.</span><span class="s1">to_value</span><span class="s2">(</span><span class="s1">v</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">v </span><span class="s2">= </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">unpack</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">updates</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">ensure_entity</span><span class="s2">(</span><span class="s1">k</span><span class="s2">), </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">), </span><span class="s1">v</span><span class="s2">)))</span>

        <span class="s0">if </span><span class="s1">updates</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ON DUPLICATE KEY UPDATE'</span><span class="s2">),</span>
                             <span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">updates</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">extract_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">EXTRACT</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">date_part</span><span class="s2">), </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'FROM'</span><span class="s2">), </span><span class="s1">date_field</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">truncate_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">DATE_FORMAT</span><span class="s2">(</span><span class="s1">date_field</span><span class="s2">, </span><span class="s1">__mysql_date_trunc__</span><span class="s2">[</span><span class="s1">date_part</span><span class="s2">],</span>
                              <span class="s1">python_value</span><span class="s2">=</span><span class="s1">simple_date_time</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">UNIX_TIMESTAMP</span><span class="s2">(</span><span class="s1">date_field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">from_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">date_field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">FROM_UNIXTIME</span><span class="s2">(</span><span class="s1">date_field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">get_noop_select</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'DO 0'</span><span class="s2">)</span>


<span class="s4"># TRANSACTION CONTROL.</span>


<span class="s0">class </span><span class="s1">_manual</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db </span><span class="s2">= </span><span class="s1">db</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">_manual</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">top_transaction</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">top </span><span class="s0">is not None and not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">top</span><span class="s2">, </span><span class="s1">_manual</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot enter manual commit block while a '</span>
                             <span class="s3">'transaction is active.'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">push_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">pop_transaction</span><span class="s2">() </span><span class="s0">is not </span><span class="s1">self</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Transaction stack corrupted while exiting '</span>
                             <span class="s3">'manual commit block.'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_atomic</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db </span><span class="s2">= </span><span class="s1">db</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_transaction_args </span><span class="s2">= (</span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_transaction_args</span>
            <span class="s0">with </span><span class="s1">_atomic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">, *</span><span class="s1">a</span><span class="s2">, **</span><span class="s1">k</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">transaction_depth</span><span class="s2">() == </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_transaction_args</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_helper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">transaction</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">top_transaction</span><span class="s2">(), </span><span class="s1">_manual</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot enter atomic commit block while in '</span>
                             <span class="s3">'manual commit mode.'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_helper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">savepoint</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_helper</span><span class="s2">.</span><span class="s1">__enter__</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_helper</span><span class="s2">.</span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_transaction</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db </span><span class="s2">= </span><span class="s1">db</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_begin_args </span><span class="s2">= (</span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_begin_args</span>
            <span class="s0">with </span><span class="s1">_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">, *</span><span class="s1">a</span><span class="s2">, **</span><span class="s1">k</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>

    <span class="s0">def </span><span class="s1">_begin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_begin_args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">begin</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">begin</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_begin</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">begin</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">begin</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_begin</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">transaction_depth</span><span class="s2">() == </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_begin</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">push_transaction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">):</span>
        <span class="s1">depth </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">transaction_depth</span><span class="s2">()</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">exc_type </span><span class="s0">and </span><span class="s1">depth </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">depth </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s0">except</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
                    <span class="s0">raise</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">pop_transaction</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">_savepoint</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">db</span><span class="s2">, </span><span class="s1">sid</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db </span><span class="s2">= </span><span class="s1">db</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sid </span><span class="s2">= </span><span class="s1">sid </span><span class="s0">or </span><span class="s3">'s' </span><span class="s2">+ </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">uuid4</span><span class="s2">().</span><span class="s1">hex</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">quoted_sid </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sid</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">quote</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">inner</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">_savepoint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inner</span>

    <span class="s0">def </span><span class="s1">_begin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'SAVEPOINT %s;' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">quoted_sid</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">begin</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'RELEASE SAVEPOINT %s;' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">quoted_sid</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">begin</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_begin</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">db</span><span class="s2">.</span><span class="s1">execute_sql</span><span class="s2">(</span><span class="s3">'ROLLBACK TO SAVEPOINT %s;' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">quoted_sid</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_begin</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">exc_type</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">(</span><span class="s1">begin</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">except</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
                <span class="s0">raise</span>


<span class="s4"># CURSOR REPRESENTATIONS.</span>


<span class="s0">class </span><span class="s1">CursorWrapper</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor </span><span class="s2">= </span><span class="s1">cursor</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">initialized </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">populated </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">row_cache </span><span class="s2">= []</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">populated</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">row_cache</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ResultIterator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">):</span>
            <span class="s1">stop </span><span class="s2">= </span><span class="s1">item</span><span class="s2">.</span><span class="s1">stop</span>
            <span class="s0">if </span><span class="s1">stop </span><span class="s0">is None or </span><span class="s1">stop </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">fill_cache</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">fill_cache</span><span class="s2">(</span><span class="s1">stop</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">row_cache</span><span class="s2">[</span><span class="s1">item</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fill_cache</span><span class="s2">(</span><span class="s1">item </span><span class="s0">if </span><span class="s1">item </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s5">0</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">row_cache</span><span class="s2">[</span><span class="s1">item</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'CursorWrapper only supports integer and slice '</span>
                             <span class="s3">'indexes.'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fill_cache</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">count</span>

    <span class="s0">def </span><span class="s1">initialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">iterate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cache</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">row </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">fetchone</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">row </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">populated </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s0">raise </span><span class="s1">StopIteration</span>
        <span class="s0">elif not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initialized</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">initialize</span><span class="s2">()  </span><span class="s4"># Lazy initialization.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">initialized </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">cache</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">row_cache</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">result</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">row</span>

    <span class="s0">def </span><span class="s1">iterator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s7">&quot;&quot;&quot;Efficient one-pass iteration over the result set.&quot;&quot;&quot;</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">iterate</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
                <span class="s0">return</span>

    <span class="s0">def </span><span class="s1">fill_cache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s5">0</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">n </span><span class="s0">or </span><span class="s1">float</span><span class="s2">(</span><span class="s3">'Inf'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">n </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Negative values are not supported.'</span><span class="s2">)</span>

        <span class="s1">iterator </span><span class="s2">= </span><span class="s1">ResultIterator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">iterator</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">count</span>
        <span class="s0">while not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">populated </span><span class="s0">and </span><span class="s2">(</span><span class="s1">n </span><span class="s2">&gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">count</span><span class="s2">):</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">iterator</span><span class="s2">.</span><span class="s1">next</span><span class="s2">()</span>
            <span class="s0">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
                <span class="s0">break</span>


<span class="s0">class </span><span class="s1">DictCursorWrapper</span><span class="s2">(</span><span class="s1">CursorWrapper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_initialize_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">description </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">description</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s1">t</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s1">t</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">rfind</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">) + </span><span class="s5">1</span><span class="s2">:].</span><span class="s1">strip</span><span class="s2">(</span><span class="s3">'()&quot;`'</span><span class="s2">)</span>
                        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">description</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ncols </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">description</span><span class="s2">)</span>

    <span class="s1">initialize </span><span class="s2">= </span><span class="s1">_initialize_columns</span>

    <span class="s0">def </span><span class="s1">_row_to_dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ncols</span><span class="s2">):</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">row</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])  </span><span class="s4"># Do not overwrite.</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s1">process_row </span><span class="s2">= </span><span class="s1">_row_to_dict</span>


<span class="s0">class </span><span class="s1">NamedTupleCursorWrapper</span><span class="s2">(</span><span class="s1">CursorWrapper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">initialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">description </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">description</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tuple_class </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'Row'</span><span class="s2">, [</span>
            <span class="s1">t</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s1">t</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">rfind</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">) + </span><span class="s5">1</span><span class="s2">:].</span><span class="s1">strip</span><span class="s2">(</span><span class="s3">'()&quot;`'</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">description</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tuple_class</span><span class="s2">(*</span><span class="s1">row</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ObjectCursorWrapper</span><span class="s2">(</span><span class="s1">DictCursorWrapper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">constructor</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ObjectCursorWrapper</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">constructor </span><span class="s2">= </span><span class="s1">constructor</span>

    <span class="s0">def </span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">row_dict </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_row_to_dict</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">constructor</span><span class="s2">(**</span><span class="s1">row_dict</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ResultIterator</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor_wrapper</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_wrapper </span><span class="s2">= </span><span class="s1">cursor_wrapper</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">next</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_wrapper</span><span class="s2">.</span><span class="s1">count</span><span class="s2">:</span>
            <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_wrapper</span><span class="s2">.</span><span class="s1">row_cache</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">]</span>
        <span class="s0">elif not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_wrapper</span><span class="s2">.</span><span class="s1">populated</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_wrapper</span><span class="s2">.</span><span class="s1">iterate</span><span class="s2">()</span>
            <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor_wrapper</span><span class="s2">.</span><span class="s1">row_cache</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">StopIteration</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s0">return </span><span class="s1">obj</span>

    <span class="s1">__next__ </span><span class="s2">= </span><span class="s1">next</span>

<span class="s4"># FIELDS</span>

<span class="s0">class </span><span class="s1">FieldAccessor</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">field </span><span class="s2">= </span><span class="s1">field</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span>

    <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s1">instance</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ForeignKeyAccessor</span><span class="s2">(</span><span class="s1">FieldAccessor</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ForeignKeyAccessor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model</span>

    <span class="s0">def </span><span class="s1">get_rel_instance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__ </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">lazy_load</span><span class="s2">:</span>
                <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_field </span><span class="s2">== </span><span class="s1">value</span><span class="s2">)</span>
                <span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">obj</span>
            <span class="s0">return </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">elif not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">null </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">lazy_load</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">DoesNotExist</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rel_instance</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span>

    <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">):</span>
            <span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">obj</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">fk_value </span><span class="s2">= </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">obj</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">obj </span><span class="s2">!= </span><span class="s1">fk_value </span><span class="s0">or </span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">) </span><span class="s0">and </span><span class="s1">\</span>
               <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">:</span>
                <span class="s0">del </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
        <span class="s1">instance</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BackrefAccessor</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">field </span><span class="s2">= </span><span class="s1">field</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">dest </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span>
                    <span class="s2">.</span><span class="s1">select</span><span class="s2">()</span>
                    <span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field </span><span class="s2">== </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">)))</span>
        <span class="s0">return </span><span class="s1">self</span>


<span class="s0">class </span><span class="s1">ObjectIdAccessor</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot;Gives direct access to the underlying id&quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">field </span><span class="s2">= </span><span class="s1">field</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s4"># Pull the object-id from the related object if it is not set.</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s0">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">:</span>
                <span class="s1">rel_obj </span><span class="s2">= </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">rel_obj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">value</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span>

    <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Field</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
    <span class="s1">_field_counter </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">_order </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">accessor_class </span><span class="s2">= </span><span class="s1">FieldAccessor</span>
    <span class="s1">auto_increment </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">default_index_type </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'DEFAULT'</span>
    <span class="s1">unpack </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">null</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">unique</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">column_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">default</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">primary_key</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">constraints</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">sequence</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">collation</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">unindexed</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">choices</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">help_text</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">verbose_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">index_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">db_column</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">_hidden</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">db_column </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;db_column&quot; has been deprecated in favor of '</span>
                           <span class="s3">'&quot;column_name&quot; for Field objects.'</span><span class="s2">)</span>
            <span class="s1">column_name </span><span class="s2">= </span><span class="s1">db_column</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">null </span><span class="s2">= </span><span class="s1">null</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">unique </span><span class="s2">= </span><span class="s1">unique</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">column_name </span><span class="s2">= </span><span class="s1">column_name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">default </span><span class="s2">= </span><span class="s1">default</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">= </span><span class="s1">primary_key</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">constraints </span><span class="s2">= </span><span class="s1">constraints  </span><span class="s4"># List of column constraints.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sequence </span><span class="s2">= </span><span class="s1">sequence  </span><span class="s4"># Name of sequence, e.g. foo_id_seq.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">collation </span><span class="s2">= </span><span class="s1">collation</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">unindexed </span><span class="s2">= </span><span class="s1">unindexed</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">choices </span><span class="s2">= </span><span class="s1">choices</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">help_text </span><span class="s2">= </span><span class="s1">help_text</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">verbose_name </span><span class="s2">= </span><span class="s1">verbose_name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index_type </span><span class="s2">= </span><span class="s1">index_type </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">default_index_type</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_hidden </span><span class="s2">= </span><span class="s1">_hidden</span>

        <span class="s4"># Used internally for recovering the order in which Fields were defined</span>
        <span class="s4"># on the Model class.</span>
        <span class="s1">Field</span><span class="s2">.</span><span class="s1">_field_counter </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_order </span><span class="s2">= </span><span class="s1">Field</span><span class="s2">.</span><span class="s1">_field_counter</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_sort_key </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s0">and </span><span class="s5">1 </span><span class="s0">or </span><span class="s5">2</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_order</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">'.' </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'model'</span><span class="s2">) </span><span class="s0">and </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s3">'name'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s3">'&lt;%s: %s.%s&gt;' </span><span class="s2">% (</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">).</span><span class="s1">__name__</span><span class="s2">,</span>
                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">,</span>
                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s3">'&lt;%s: (unbound)&gt;' </span><span class="s2">% </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">).</span><span class="s1">__name__</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">safe_name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">column_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">column_name </span><span class="s0">or </span><span class="s1">name</span>
        <span class="s0">if </span><span class="s1">set_attribute</span><span class="s2">:</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">accessor_class</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">value </span><span class="s0">if </span><span class="s1">value </span><span class="s0">is None else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">value </span><span class="s0">if </span><span class="s1">value </span><span class="s0">is None else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">to_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">db_value</span><span class="s2">, </span><span class="s1">unpack</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_sort_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sort_key</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">column</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_modifiers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">ddl_datatype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx </span><span class="s0">and </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">field_types</span><span class="s2">:</span>
            <span class="s1">column_type </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">field_types</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_type</span><span class="s2">,</span>
                                                    <span class="s1">self</span><span class="s2">.</span><span class="s1">field_type</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">column_type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_type</span>

        <span class="s1">modifiers </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_modifiers</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">column_type </span><span class="s0">and </span><span class="s1">modifiers</span><span class="s2">:</span>
            <span class="s1">modifier_literal </span><span class="s2">= </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s1">str</span><span class="s2">(</span><span class="s1">m</span><span class="s2">) </span><span class="s0">for </span><span class="s1">m </span><span class="s0">in </span><span class="s1">modifiers</span><span class="s2">])</span>
            <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'%s(%s)' </span><span class="s2">% (</span><span class="s1">column_type</span><span class="s2">, </span><span class="s1">modifier_literal</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">column_type</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">ddl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">accum </span><span class="s2">= [</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">)]</span>
        <span class="s1">data_type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ddl_datatype</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">data_type</span><span class="s2">:</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">data_type</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">unindexed</span><span class="s2">:</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'UNINDEXED'</span><span class="s2">))</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">null</span><span class="s2">:</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'NOT NULL'</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">:</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'PRIMARY KEY'</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">:</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">&quot;DEFAULT NEXTVAL('%s')&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">constraints</span><span class="s2">:</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">constraints</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collation</span><span class="s2">:</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'COLLATE %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">collation</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">accum</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">AnyField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'ANY'</span>


<span class="s0">class </span><span class="s1">IntegerField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'INT'</span>

    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">BigIntegerField</span><span class="s2">(</span><span class="s1">IntegerField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'BIGINT'</span>


<span class="s0">class </span><span class="s1">SmallIntegerField</span><span class="s2">(</span><span class="s1">IntegerField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'SMALLINT'</span>


<span class="s0">class </span><span class="s1">AutoField</span><span class="s2">(</span><span class="s1">IntegerField</span><span class="s2">):</span>
    <span class="s1">auto_increment </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'AUTO'</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'primary_key'</span><span class="s2">) </span><span class="s0">is False</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'%s must always be a primary key.' </span><span class="s2">% </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s3">'primary_key'</span><span class="s2">] = </span><span class="s0">True</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">AutoField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BigAutoField</span><span class="s2">(</span><span class="s1">AutoField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'BIGAUTO'</span>


<span class="s0">class </span><span class="s1">IdentityField</span><span class="s2">(</span><span class="s1">AutoField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'INT GENERATED BY DEFAULT AS IDENTITY'</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">generate_always</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">generate_always</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">field_type </span><span class="s2">= </span><span class="s3">'INT GENERATED ALWAYS AS IDENTITY'</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">IdentityField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">PrimaryKeyField</span><span class="s2">(</span><span class="s1">AutoField</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;PrimaryKeyField&quot; has been renamed to &quot;AutoField&quot;. '</span>
                       <span class="s3">'Please update your code accordingly as this will be '</span>
                       <span class="s3">'completely removed in a subsequent release.'</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">PrimaryKeyField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">FloatField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'FLOAT'</span>

    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">float</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">DoubleField</span><span class="s2">(</span><span class="s1">FloatField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'DOUBLE'</span>


<span class="s0">class </span><span class="s1">DecimalField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'DECIMAL'</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">max_digits</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">decimal_places</span><span class="s2">=</span><span class="s5">5</span><span class="s2">, </span><span class="s1">auto_round</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                 <span class="s1">rounding</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">max_digits </span><span class="s2">= </span><span class="s1">max_digits</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">decimal_places </span><span class="s2">= </span><span class="s1">decimal_places</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">auto_round </span><span class="s2">= </span><span class="s1">auto_round</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rounding </span><span class="s2">= </span><span class="s1">rounding </span><span class="s0">or </span><span class="s1">decimal</span><span class="s2">.</span><span class="s1">DefaultContext</span><span class="s2">.</span><span class="s1">rounding</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_exp </span><span class="s2">= </span><span class="s1">decimal</span><span class="s2">.</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) ** (-</span><span class="s1">self</span><span class="s2">.</span><span class="s1">decimal_places</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">DecimalField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_modifiers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_digits</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">decimal_places</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">D </span><span class="s2">= </span><span class="s1">decimal</span><span class="s2">.</span><span class="s1">Decimal</span>
        <span class="s0">if not </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">value </span><span class="s0">if </span><span class="s1">value </span><span class="s0">is None else </span><span class="s1">D</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_round</span><span class="s2">:</span>
            <span class="s1">decimal_value </span><span class="s2">= </span><span class="s1">D</span><span class="s2">(</span><span class="s1">text_type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">decimal_value</span><span class="s2">.</span><span class="s1">quantize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_exp</span><span class="s2">, </span><span class="s1">rounding</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rounding</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">.</span><span class="s1">Decimal</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">value</span>
            <span class="s0">return </span><span class="s1">decimal</span><span class="s2">.</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s1">text_type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">_StringField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">text_type</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">value</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes_type</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">value</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">text_type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__add__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">): </span><span class="s0">return </span><span class="s1">StringExpression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">CONCAT</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__radd__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">): </span><span class="s0">return </span><span class="s1">StringExpression</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">OP</span><span class="s2">.</span><span class="s1">CONCAT</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">CharField</span><span class="s2">(</span><span class="s1">_StringField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'VARCHAR'</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">max_length</span><span class="s2">=</span><span class="s5">255</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">max_length </span><span class="s2">= </span><span class="s1">max_length</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">CharField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_modifiers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_length </span><span class="s0">and </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_length</span><span class="s2">] </span><span class="s0">or None</span>


<span class="s0">class </span><span class="s1">FixedCharField</span><span class="s2">(</span><span class="s1">CharField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'CHAR'</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">FixedCharField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">TextField</span><span class="s2">(</span><span class="s1">_StringField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'TEXT'</span>


<span class="s0">class </span><span class="s1">BlobField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'BLOB'</span>

    <span class="s0">def </span><span class="s1">_db_hook</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">database </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor </span><span class="s2">= </span><span class="s1">bytearray</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor </span><span class="s2">= </span><span class="s1">database</span><span class="s2">.</span><span class="s1">get_binary_type</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor </span><span class="s2">= </span><span class="s1">bytearray</span>
        <span class="s0">if </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">, </span><span class="s1">Proxy</span><span class="s2">):</span>
                <span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">attach_callback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_db_hook</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_db_hook</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">)</span>

        <span class="s4"># Attach a hook to the model metadata; in the event the database is</span>
        <span class="s4"># changed or set at run-time, we will be sure to apply our callback and</span>
        <span class="s4"># use the proper data-type for our database driver.</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">_db_hooks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_db_hook</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">BlobField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">text_type</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'raw_unicode_escape'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes_type</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">BitField</span><span class="s2">(</span><span class="s1">BitwiseMixin</span><span class="s2">, </span><span class="s1">BigIntegerField</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">kwargs</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BitField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__current_flag </span><span class="s2">= </span><span class="s5">1</span>

    <span class="s0">def </span><span class="s1">flag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__current_flag</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__current_flag </span><span class="s2">&lt;&lt;= </span><span class="s5">1</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__current_flag </span><span class="s2">= </span><span class="s1">value </span><span class="s2">&lt;&lt; </span><span class="s5">1</span>

        <span class="s0">class </span><span class="s1">FlagDescriptor</span><span class="s2">(</span><span class="s1">ColumnBase</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_field </span><span class="s2">= </span><span class="s1">field</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_value </span><span class="s2">= </span><span class="s1">value</span>
                <span class="s1">super</span><span class="s2">(</span><span class="s1">FlagDescriptor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">()</span>
            <span class="s0">def </span><span class="s1">clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_field</span><span class="s2">.</span><span class="s1">bin_and</span><span class="s2">(~</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span><span class="s2">)</span>
            <span class="s0">def </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_field</span><span class="s2">.</span><span class="s1">bin_or</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span><span class="s2">)</span>
            <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">instance </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">self</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">or </span><span class="s5">0</span>
                <span class="s0">return </span><span class="s2">(</span><span class="s1">value </span><span class="s2">&amp; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span><span class="s2">) != </span><span class="s5">0</span>
            <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">is_set</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">is_set </span><span class="s0">not in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Value must be either True or False'</span><span class="s2">)</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">or </span><span class="s5">0</span>
                <span class="s0">if </span><span class="s1">is_set</span><span class="s2">:</span>
                    <span class="s1">value </span><span class="s2">|= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">value </span><span class="s2">&amp;= ~</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_field</span><span class="s2">.</span><span class="s1">bin_and</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_value</span><span class="s2">) != </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">FlagDescriptor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BigBitFieldData</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">instance </span><span class="s2">= </span><span class="s1">instance</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">()</span>
        <span class="s0">elif not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytearray</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_ensure_length</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">):</span>
        <span class="s1">byte_num</span><span class="s2">, </span><span class="s1">byte_offset </span><span class="s2">= </span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>
        <span class="s1">cur_size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">cur_size </span><span class="s2">&lt;= </span><span class="s1">byte_num</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s6">b'</span><span class="s0">\x00</span><span class="s6">' </span><span class="s2">* ((</span><span class="s1">byte_num </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) - </span><span class="s1">cur_size</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">byte_num</span><span class="s2">, </span><span class="s1">byte_offset</span>

    <span class="s0">def </span><span class="s1">set_bit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">):</span>
        <span class="s1">byte_num</span><span class="s2">, </span><span class="s1">byte_offset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ensure_length</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">[</span><span class="s1">byte_num</span><span class="s2">] |= (</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">byte_offset</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">clear_bit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">):</span>
        <span class="s1">byte_num</span><span class="s2">, </span><span class="s1">byte_offset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ensure_length</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">[</span><span class="s1">byte_num</span><span class="s2">] &amp;= ~(</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">byte_offset</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">toggle_bit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">):</span>
        <span class="s1">byte_num</span><span class="s2">, </span><span class="s1">byte_offset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_ensure_length</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">[</span><span class="s1">byte_num</span><span class="s2">] ^= (</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">byte_offset</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">[</span><span class="s1">byte_num</span><span class="s2">] &amp; (</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">byte_offset</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">is_set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">):</span>
        <span class="s1">byte_num</span><span class="s2">, </span><span class="s1">byte_offset </span><span class="s2">= </span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>
        <span class="s1">cur_size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">cur_size </span><span class="s2">&lt;= </span><span class="s1">byte_num</span><span class="s2">:</span>
            <span class="s0">return False</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">[</span><span class="s1">byte_num</span><span class="s2">] &amp; (</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">byte_offset</span><span class="s2">))</span>

    <span class="s1">__getitem__ </span><span class="s2">= </span><span class="s1">is_set</span>
    <span class="s0">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_bit</span><span class="s2">(</span><span class="s1">item</span><span class="s2">) </span><span class="s0">if </span><span class="s1">value </span><span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clear_bit</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
    <span class="s1">__delitem__ </span><span class="s2">= </span><span class="s1">clear_bit</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_compatible_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">BigBitFieldData</span><span class="s2">):</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_buffer</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, (</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">bytearray</span><span class="s2">, </span><span class="s1">memoryview</span><span class="s2">)):</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">other</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Incompatible data-type'</span><span class="s2">)</span>
        <span class="s1">diff </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) - </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">diff </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s6">b'</span><span class="s0">\x00</span><span class="s6">' </span><span class="s2">* </span><span class="s1">diff</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">_bitwise_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">BigBitFieldData</span><span class="s2">):</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_buffer</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, (</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">bytearray</span><span class="s2">, </span><span class="s1">memoryview</span><span class="s2">)):</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">other</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Incompatible data-type'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s6">b'</span><span class="s0">\x00</span><span class="s6">' </span><span class="s2">* </span><span class="s1">max</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)))</span>
        <span class="s1">it </span><span class="s2">= </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">zip_longest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">fillvalue</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">it</span><span class="s2">):</span>
            <span class="s1">buf</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">op</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">buf</span>

    <span class="s0">def </span><span class="s1">__and__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bitwise_op</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__or__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bitwise_op</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">or_</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__xor__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_bitwise_op</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">xor</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">8</span><span class="s2">):</span>
                <span class="s0">yield </span><span class="s5">1 </span><span class="s0">if </span><span class="s2">(</span><span class="s1">b </span><span class="s2">&amp; (</span><span class="s5">1 </span><span class="s2">&lt;&lt; </span><span class="s1">j</span><span class="s2">)) </span><span class="s0">else </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] &lt; </span><span class="s5">3</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">bytes_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__bytes__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">bytes_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BigBitFieldAccessor</span><span class="s2">(</span><span class="s1">FieldAccessor</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span>
        <span class="s0">return </span><span class="s1">BigBitFieldData</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">memoryview</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">tobytes</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">buffer_type</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytearray</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">bytes_type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">BigBitFieldData</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">bytes_type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">_buffer</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">text_type</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">'utf-8'</span><span class="s2">)</span>
        <span class="s0">elif not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes_type</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Value must be either a bytes, memoryview or '</span>
                             <span class="s3">'BigBitFieldData instance.'</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BigBitFieldAccessor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BigBitField</span><span class="s2">(</span><span class="s1">BlobField</span><span class="s2">):</span>
    <span class="s1">accessor_class </span><span class="s2">= </span><span class="s1">BigBitFieldAccessor</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">kwargs</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">, </span><span class="s1">bytes_type</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BigBitField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">bytes_type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) </span><span class="s0">if </span><span class="s1">value </span><span class="s0">is not None else </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">UUIDField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'UUID'</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">) </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) == </span><span class="s5">32</span><span class="s2">:</span>
            <span class="s4"># Hex string. No transformation is necessary.</span>
            <span class="s0">return </span><span class="s1">value</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">) </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) == </span><span class="s5">16</span><span class="s2">:</span>
            <span class="s4"># Allow raw binary representation.</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">=</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">value</span><span class="s2">.</span><span class="s1">hex</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">(</span><span class="s1">value</span><span class="s2">).</span><span class="s1">hex</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">value</span>
        <span class="s0">return </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) </span><span class="s0">if </span><span class="s1">value </span><span class="s0">is not None else None</span>


<span class="s0">class </span><span class="s1">BinaryUUIDField</span><span class="s2">(</span><span class="s1">BlobField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'UUIDB'</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">) </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) == </span><span class="s5">16</span><span class="s2">:</span>
            <span class="s4"># Raw binary value. No transformation is necessary.</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">) </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) == </span><span class="s5">32</span><span class="s2">:</span>
            <span class="s4"># Allow hex string representation.</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">(</span><span class="s1">hex</span><span class="s2">=</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">bytes</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'value for binary UUID field must be UUID(), '</span>
                             <span class="s3">'a hexadecimal string, or a bytes object.'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">value</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">memoryview</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">tobytes</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">value </span><span class="s0">and not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">UUID</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">=</span><span class="s1">value</span><span class="s2">) </span><span class="s0">if </span><span class="s1">value </span><span class="s0">is not None else None</span>


<span class="s0">def </span><span class="s1">_date_part</span><span class="s2">(</span><span class="s1">date_part</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">dec</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">extract_date</span><span class="s2">(</span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">dec</span>

<span class="s0">def </span><span class="s1">format_date_time</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">formats</span><span class="s2">, </span><span class="s1">post_process</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s1">post_process </span><span class="s2">= </span><span class="s1">post_process </span><span class="s0">or </span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">fmt </span><span class="s0">in </span><span class="s1">formats</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">post_process</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">))</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s0">pass</span>
    <span class="s0">return </span><span class="s1">value</span>

<span class="s0">def </span><span class="s1">simple_date_time</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s3">'%Y-%m-%d %H:%M:%S'</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">_BaseFormattedField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">formats </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">formats</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">formats </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">formats </span><span class="s2">= </span><span class="s1">formats</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">_BaseFormattedField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DateTimeField</span><span class="s2">(</span><span class="s1">_BaseFormattedField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'DATETIME'</span>
    <span class="s1">formats </span><span class="s2">= [</span>
        <span class="s3">'%Y-%m-%d %H:%M:%S.%f'</span><span class="s2">,</span>
        <span class="s3">'%Y-%m-%d %H:%M:%S'</span><span class="s2">,</span>
        <span class="s3">'%Y-%m-%d'</span><span class="s2">,</span>
    <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">format_date_time</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formats</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">truncate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">part</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">truncate_date</span><span class="s2">(</span><span class="s1">part</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>

    <span class="s1">year </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'year'</span><span class="s2">))</span>
    <span class="s1">month </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'month'</span><span class="s2">))</span>
    <span class="s1">day </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'day'</span><span class="s2">))</span>
    <span class="s1">hour </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'hour'</span><span class="s2">))</span>
    <span class="s1">minute </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'minute'</span><span class="s2">))</span>
    <span class="s1">second </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'second'</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">DateField</span><span class="s2">(</span><span class="s1">_BaseFormattedField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'DATE'</span>
    <span class="s1">formats </span><span class="s2">= [</span>
        <span class="s3">'%Y-%m-%d'</span><span class="s2">,</span>
        <span class="s3">'%Y-%m-%d %H:%M:%S'</span><span class="s2">,</span>
        <span class="s3">'%Y-%m-%d %H:%M:%S.%f'</span><span class="s2">,</span>
    <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
            <span class="s1">pp </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">date</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">format_date_time</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formats</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">value </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">value</span><span class="s2">.</span><span class="s1">date</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">truncate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">part</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">truncate_date</span><span class="s2">(</span><span class="s1">part</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>

    <span class="s1">year </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'year'</span><span class="s2">))</span>
    <span class="s1">month </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'month'</span><span class="s2">))</span>
    <span class="s1">day </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'day'</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TimeField</span><span class="s2">(</span><span class="s1">_BaseFormattedField</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'TIME'</span>
    <span class="s1">formats </span><span class="s2">= [</span>
        <span class="s3">'%H:%M:%S.%f'</span><span class="s2">,</span>
        <span class="s3">'%H:%M:%S'</span><span class="s2">,</span>
        <span class="s3">'%H:%M'</span><span class="s2">,</span>
        <span class="s3">'%Y-%m-%d %H:%M:%S.%f'</span><span class="s2">,</span>
        <span class="s3">'%Y-%m-%d %H:%M:%S'</span><span class="s2">,</span>
    <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                <span class="s1">pp </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">time</span><span class="s2">()</span>
                <span class="s0">return </span><span class="s1">format_date_time</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">formats</span><span class="s2">, </span><span class="s1">pp</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">value</span><span class="s2">.</span><span class="s1">time</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">timedelta</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">min </span><span class="s2">+ </span><span class="s1">value</span><span class="s2">).</span><span class="s1">time</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s1">hour </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'hour'</span><span class="s2">))</span>
    <span class="s1">minute </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'minute'</span><span class="s2">))</span>
    <span class="s1">second </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_date_part</span><span class="s2">(</span><span class="s3">'second'</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_timestamp_date_part</span><span class="s2">(</span><span class="s1">date_part</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">dec</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">db </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span>
        <span class="s1">expr </span><span class="s2">= ((</span><span class="s1">self </span><span class="s2">/ </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s2">&gt; </span><span class="s5">1 </span><span class="s0">else </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">db</span><span class="s2">.</span><span class="s1">extract_date</span><span class="s2">(</span><span class="s1">date_part</span><span class="s2">, </span><span class="s1">db</span><span class="s2">.</span><span class="s1">from_timestamp</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">dec</span>


<span class="s0">class </span><span class="s1">TimestampField</span><span class="s2">(</span><span class="s1">BigIntegerField</span><span class="s2">):</span>
    <span class="s4"># Support second -&gt; microsecond resolution.</span>
    <span class="s1">valid_resolutions </span><span class="s2">= [</span><span class="s5">10</span><span class="s2">**</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">7</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'resolution'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s2">= </span><span class="s5">1</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s2">= </span><span class="s5">10 </span><span class="s2">** </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">valid_resolutions</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'TimestampField resolution must be one of: %s' </span><span class="s2">%</span>
                             <span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">valid_resolutions</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ticks_to_microsecond </span><span class="s2">= </span><span class="s5">1000000 </span><span class="s2">// </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">utc </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'utc'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">or False</span>
        <span class="s1">dflt </span><span class="s2">= </span><span class="s1">utcnow </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">utc </span><span class="s0">else </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">now</span>
        <span class="s1">kwargs</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">, </span><span class="s1">dflt</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">TimestampField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">local_to_utc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s4"># Convert naive local datetime into naive UTC, e.g.:</span>
        <span class="s4"># 2019-03-01T12:00:00 (local=US/Central) -&gt; 2019-03-01T18:00:00.</span>
        <span class="s4"># 2019-05-01T12:00:00 (local=US/Central) -&gt; 2019-05-01T17:00:00.</span>
        <span class="s4"># 2019-03-01T12:00:00 (local=UTC)        -&gt; 2019-03-01T12:00:00.</span>
        <span class="s0">return </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(*</span><span class="s1">time</span><span class="s2">.</span><span class="s1">gmtime</span><span class="s2">(</span><span class="s1">time</span><span class="s2">.</span><span class="s1">mktime</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">timetuple</span><span class="s2">()))[:</span><span class="s5">6</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">utc_to_local</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s4"># Convert a naive UTC datetime into local time, e.g.:</span>
        <span class="s4"># 2019-03-01T18:00:00 (local=US/Central) -&gt; 2019-03-01T12:00:00.</span>
        <span class="s4"># 2019-05-01T17:00:00 (local=US/Central) -&gt; 2019-05-01T12:00:00.</span>
        <span class="s4"># 2019-03-01T12:00:00 (local=UTC)        -&gt; 2019-03-01T12:00:00.</span>
        <span class="s1">ts </span><span class="s2">= </span><span class="s1">calendar</span><span class="s2">.</span><span class="s1">timegm</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">utctimetuple</span><span class="s2">())</span>
        <span class="s0">return </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">fromtimestamp</span><span class="s2">(</span><span class="s1">ts</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">utc</span><span class="s2">:</span>
            <span class="s4"># If utc-mode is on, then we assume all naive datetimes are in UTC.</span>
            <span class="s0">return </span><span class="s1">calendar</span><span class="s2">.</span><span class="s1">timegm</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">utctimetuple</span><span class="s2">())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">time</span><span class="s2">.</span><span class="s1">mktime</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">timetuple</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">):</span>
            <span class="s0">pass</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">date</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">year</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">month</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">day</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">value </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">))</span>

        <span class="s1">timestamp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_timestamp</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">timestamp </span><span class="s2">+= (</span><span class="s1">value</span><span class="s2">.</span><span class="s1">microsecond </span><span class="s2">* </span><span class="s5">.000001</span><span class="s2">)</span>
            <span class="s1">timestamp </span><span class="s2">*= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution</span>
        <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">timestamp</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, (</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">long</span><span class="s2">)):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s1">value</span><span class="s2">, </span><span class="s1">ticks </span><span class="s2">= </span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">)</span>
                <span class="s1">microseconds </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">ticks </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ticks_to_microsecond</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">microseconds </span><span class="s2">= </span><span class="s5">0</span>

            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">utc</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">utcfromtimestamp</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">fromtimestamp</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">microseconds</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">microsecond</span><span class="s2">=</span><span class="s1">microseconds</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">from_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">expr </span><span class="s2">= ((</span><span class="s1">self </span><span class="s2">/ </span><span class="s1">Value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">resolution </span><span class="s2">&gt; </span><span class="s5">1 </span><span class="s0">else </span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">from_timestamp</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">)</span>

    <span class="s1">year </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_timestamp_date_part</span><span class="s2">(</span><span class="s3">'year'</span><span class="s2">))</span>
    <span class="s1">month </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_timestamp_date_part</span><span class="s2">(</span><span class="s3">'month'</span><span class="s2">))</span>
    <span class="s1">day </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_timestamp_date_part</span><span class="s2">(</span><span class="s3">'day'</span><span class="s2">))</span>
    <span class="s1">hour </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_timestamp_date_part</span><span class="s2">(</span><span class="s3">'hour'</span><span class="s2">))</span>
    <span class="s1">minute </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_timestamp_date_part</span><span class="s2">(</span><span class="s3">'minute'</span><span class="s2">))</span>
    <span class="s1">second </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">_timestamp_date_part</span><span class="s2">(</span><span class="s3">'second'</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">IPField</span><span class="s2">(</span><span class="s1">BigIntegerField</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">val </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'!I'</span><span class="s2">, </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">inet_aton</span><span class="s2">(</span><span class="s1">val</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">val </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">inet_ntoa</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'!I'</span><span class="s2">, </span><span class="s1">val</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">BooleanField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">field_type </span><span class="s2">= </span><span class="s3">'BOOL'</span>
    <span class="s1">adapt </span><span class="s2">= </span><span class="s1">bool</span>


<span class="s0">class </span><span class="s1">BareField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">adapt</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BareField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">adapt </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">adapt </span><span class="s2">= </span><span class="s1">adapt</span>

    <span class="s0">def </span><span class="s1">ddl_datatype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return</span>


<span class="s0">class </span><span class="s1">ForeignKeyField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">accessor_class </span><span class="s2">= </span><span class="s1">ForeignKeyAccessor</span>
    <span class="s1">backref_accessor_class </span><span class="s2">= </span><span class="s1">BackrefAccessor</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">backref</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">on_delete</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">on_update</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">deferrable</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">_deferred</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">rel_model</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">to_field</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">object_id_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">lazy_load</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">constraint_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">related_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s2">*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">kwargs</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'index'</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">super</span><span class="s2">(</span><span class="s1">ForeignKeyField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">rel_model </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;rel_model&quot; has been deprecated in favor of '</span>
                           <span class="s3">'&quot;model&quot; for ForeignKeyField objects.'</span><span class="s2">)</span>
            <span class="s1">model </span><span class="s2">= </span><span class="s1">rel_model</span>
        <span class="s0">if </span><span class="s1">to_field </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;to_field&quot; has been deprecated in favor of '</span>
                           <span class="s3">'&quot;field&quot; for ForeignKeyField objects.'</span><span class="s2">)</span>
            <span class="s1">field </span><span class="s2">= </span><span class="s1">to_field</span>
        <span class="s0">if </span><span class="s1">related_name </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;related_name&quot; has been deprecated in favor of '</span>
                           <span class="s3">'&quot;backref&quot; for Field objects.'</span><span class="s2">)</span>
            <span class="s1">backref </span><span class="s2">= </span><span class="s1">related_name</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_self_reference </span><span class="s2">= </span><span class="s1">model </span><span class="s2">== </span><span class="s3">'self'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field </span><span class="s2">= </span><span class="s1">field</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">declared_backref </span><span class="s2">= </span><span class="s1">backref</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">backref </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_delete </span><span class="s2">= </span><span class="s1">on_delete</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_update </span><span class="s2">= </span><span class="s1">on_update</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">deferrable </span><span class="s2">= </span><span class="s1">deferrable</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">deferred </span><span class="s2">= </span><span class="s1">_deferred</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">object_id_name </span><span class="s2">= </span><span class="s1">object_id_name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lazy_load </span><span class="s2">= </span><span class="s1">lazy_load</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">constraint_name </span><span class="s2">= </span><span class="s1">constraint_name</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">field_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">AutoField</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">field_type</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">BigAutoField</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">BigIntegerField</span><span class="s2">.</span><span class="s1">field_type</span>
        <span class="s0">return </span><span class="s1">IntegerField</span><span class="s2">.</span><span class="s1">field_type</span>

    <span class="s0">def </span><span class="s1">get_modifiers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">AutoField</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">get_modifiers</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ForeignKeyField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">get_modifiers</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">value</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">column_name </span><span class="s2">= </span><span class="s1">name </span><span class="s0">if </span><span class="s1">name</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'_id'</span><span class="s2">) </span><span class="s0">else </span><span class="s1">name </span><span class="s2">+ </span><span class="s3">'_id'</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id_name</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">object_id_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">column_name</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id_name </span><span class="s2">== </span><span class="s1">name</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">object_id_name </span><span class="s2">+= </span><span class="s3">'_id'</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id_name </span><span class="s2">== </span><span class="s1">name</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'ForeignKeyField &quot;%s&quot;.&quot;%s&quot; specifies an '</span>
                             <span class="s3">'object_id_name that conflicts with its field '</span>
                             <span class="s3">'name.' </span><span class="s2">% (</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_self_reference</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span>

        <span class="s4"># Bind field before assigning backref, so field is bound when</span>
        <span class="s4"># calling declared_backref() (if callable).</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ForeignKeyField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">safe_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id_name</span>

        <span class="s0">if </span><span class="s1">callable_</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">declared_backref</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">backref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">declared_backref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">backref</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">declared_backref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">declared_backref</span><span class="s2">, </span><span class="s0">None</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backref</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">backref </span><span class="s2">= </span><span class="s3">'%s_set' </span><span class="s2">% </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span>

        <span class="s0">if </span><span class="s1">set_attribute</span><span class="s2">:</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id_name</span><span class="s2">, </span><span class="s1">ObjectIdAccessor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backref </span><span class="s0">not in </span><span class="s3">'!+'</span><span class="s2">:</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backref</span><span class="s2">,</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">backref_accessor_class</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">foreign_key_constraint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">parts </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">constraint_name</span><span class="s2">:</span>
            <span class="s1">parts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'CONSTRAINT'</span><span class="s2">), </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">constraint_name</span><span class="s2">)))</span>
        <span class="s1">parts</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span>
            <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'FOREIGN KEY'</span><span class="s2">),</span>
            <span class="s1">EnclosedNodeList</span><span class="s2">((</span><span class="s1">self</span><span class="s2">,)),</span>
            <span class="s1">SQL</span><span class="s2">(</span><span class="s3">'REFERENCES'</span><span class="s2">),</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">,</span>
            <span class="s1">EnclosedNodeList</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">,))])</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_delete</span><span class="s2">:</span>
            <span class="s1">parts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ON DELETE %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_delete</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_update</span><span class="s2">:</span>
            <span class="s1">parts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'ON UPDATE %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_update</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deferrable</span><span class="s2">:</span>
            <span class="s1">parts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'DEFERRABLE %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deferrable</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">NodeList</span><span class="s2">(</span><span class="s1">parts</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'__'</span><span class="s2">):</span>
            <span class="s4"># Prevent recursion error when deep-copying.</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'Cannot look-up non-existant &quot;__&quot; methods.'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">attr </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">]</span>
        <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'Foreign-key has no attribute %s, nor is it a '</span>
                             <span class="s3">'valid field on the related model.' </span><span class="s2">% </span><span class="s1">attr</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DeferredForeignKey</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">_unresolved </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rel_model_name</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">field_kwargs </span><span class="s2">= </span><span class="s1">kwargs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model_name </span><span class="s2">= </span><span class="s1">rel_model_name</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
        <span class="s1">DeferredForeignKey</span><span class="s2">.</span><span class="s1">_unresolved</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">DeferredForeignKey</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">column_name</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'column_name'</span><span class="s2">),</span>
            <span class="s1">null</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'null'</span><span class="s2">),</span>
            <span class="s1">primary_key</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'primary_key'</span><span class="s2">))</span>

    <span class="s1">__hash__ </span><span class="s2">= </span><span class="s1">object</span><span class="s2">.</span><span class="s1">__hash__</span>

    <span class="s0">def </span><span class="s1">__deepcopy__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">memo</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">DeferredForeignKey</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model_name</span><span class="s2">, **</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">set_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rel_model</span><span class="s2">):</span>
        <span class="s1">field </span><span class="s2">= </span><span class="s1">ForeignKeyField</span><span class="s2">(</span><span class="s1">rel_model</span><span class="s2">, </span><span class="s1">_deferred</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">:</span>
            <span class="s4"># NOTE: this calls add_field() under-the-hood.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">set_primary_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">add_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">model_cls</span><span class="s2">):</span>
        <span class="s1">unresolved </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">DeferredForeignKey</span><span class="s2">.</span><span class="s1">_unresolved</span><span class="s2">,</span>
                            <span class="s1">key</span><span class="s2">=</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">attrgetter</span><span class="s2">(</span><span class="s3">'_order'</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">dr </span><span class="s0">in </span><span class="s1">unresolved</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">dr</span><span class="s2">.</span><span class="s1">rel_model_name </span><span class="s2">== </span><span class="s1">model_cls</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">():</span>
                <span class="s1">dr</span><span class="s2">.</span><span class="s1">set_model</span><span class="s2">(</span><span class="s1">model_cls</span><span class="s2">)</span>
                <span class="s1">DeferredForeignKey</span><span class="s2">.</span><span class="s1">_unresolved</span><span class="s2">.</span><span class="s1">discard</span><span class="s2">(</span><span class="s1">dr</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DeferredThroughModel</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_refs </span><span class="s2">= []</span>

    <span class="s0">def </span><span class="s1">set_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_refs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">set_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">through_model</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">src_model</span><span class="s2">, </span><span class="s1">m2mfield</span><span class="s2">, </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_refs</span><span class="s2">:</span>
            <span class="s1">m2mfield</span><span class="s2">.</span><span class="s1">through_model </span><span class="s2">= </span><span class="s1">through_model</span>
            <span class="s1">src_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">add_field</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">m2mfield</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">MetaField</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s1">column_name </span><span class="s2">= </span><span class="s1">default </span><span class="s2">= </span><span class="s1">model </span><span class="s2">= </span><span class="s1">name </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">primary_key </span><span class="s2">= </span><span class="s0">False</span>


<span class="s0">class </span><span class="s1">ManyToManyFieldAccessor</span><span class="s2">(</span><span class="s1">FieldAccessor</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ManyToManyFieldAccessor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">through_model </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">through_model</span>
        <span class="s1">src_fks </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">through_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model_refs</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">]</span>
        <span class="s1">dest_fks </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">through_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model_refs</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">]</span>
        <span class="s0">if not </span><span class="s1">src_fks</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot find foreign-key to &quot;%s&quot; on &quot;%s&quot; model.' </span><span class="s2">%</span>
                             <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">through_model</span><span class="s2">))</span>
        <span class="s0">elif not </span><span class="s1">dest_fks</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot find foreign-key to &quot;%s&quot; on &quot;%s&quot; model.' </span><span class="s2">%</span>
                             <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">through_model</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">src_fk </span><span class="s2">= </span><span class="s1">src_fks</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dest_fk </span><span class="s2">= </span><span class="s1">dest_fks</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">force_query</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">force_query </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_fk</span><span class="s2">.</span><span class="s1">backref </span><span class="s2">!= </span><span class="s3">'+'</span><span class="s2">:</span>
                <span class="s1">backref </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_fk</span><span class="s2">.</span><span class="s1">backref</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">backref</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
                    <span class="s0">return </span><span class="s2">[</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dest_fk</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">backref</span><span class="s2">]</span>

            <span class="s1">src_id </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_fk</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">src_id </span><span class="s0">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">_prevent_unsaved</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot get many-to-many &quot;%s&quot; for unsaved '</span>
                                 <span class="s3">'instance &quot;%s&quot;.' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">ManyToManyQuery</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">through_model</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_fk </span><span class="s2">== </span><span class="s1">src_id</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span>

    <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">src_id </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_fk</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">src_id </span><span class="s0">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">_prevent_unsaved</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot set many-to-many &quot;%s&quot; for unsaved '</span>
                             <span class="s3">'instance &quot;%s&quot;.' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">))</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">force_query</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">query</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">clear_existing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ManyToManyField</span><span class="s2">(</span><span class="s1">MetaField</span><span class="s2">):</span>
    <span class="s1">accessor_class </span><span class="s2">= </span><span class="s1">ManyToManyFieldAccessor</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">backref</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">through_model</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">on_delete</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">on_update</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">prevent_unsaved</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">_is_backref</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">through_model </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">through_model</span><span class="s2">, </span><span class="s1">DeferredThroughModel</span><span class="s2">) </span><span class="s0">or</span>
                    <span class="s1">is_model</span><span class="s2">(</span><span class="s1">through_model</span><span class="s2">)):</span>
                <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'Unexpected value for through_model. Expected '</span>
                                <span class="s3">'Model or DeferredThroughModel.'</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">_is_backref </span><span class="s0">and </span><span class="s2">(</span><span class="s1">on_delete </span><span class="s0">is not None or </span><span class="s1">on_update </span><span class="s0">is not None</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot specify on_delete or on_update when '</span>
                                 <span class="s3">'through_model is specified.'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">backref </span><span class="s2">= </span><span class="s1">backref</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_through_model </span><span class="s2">= </span><span class="s1">through_model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on_delete </span><span class="s2">= </span><span class="s1">on_delete</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on_update </span><span class="s2">= </span><span class="s1">on_update</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_prevent_unsaved </span><span class="s2">= </span><span class="s1">prevent_unsaved</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_backref </span><span class="s2">= </span><span class="s1">_is_backref</span>

    <span class="s0">def </span><span class="s1">_get_descriptor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ManyToManyFieldAccessor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_through_model</span><span class="s2">, </span><span class="s1">DeferredThroughModel</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_through_model</span><span class="s2">.</span><span class="s1">set_field</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">super</span><span class="s2">(</span><span class="s1">ManyToManyField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_backref</span><span class="s2">:</span>
            <span class="s1">many_to_many_field </span><span class="s2">= </span><span class="s1">ManyToManyField</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">,</span>
                <span class="s1">backref</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
                <span class="s1">through_model</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">through_model</span><span class="s2">,</span>
                <span class="s1">on_delete</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_delete</span><span class="s2">,</span>
                <span class="s1">on_update</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_update</span><span class="s2">,</span>
                <span class="s1">_is_backref</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">backref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">backref </span><span class="s0">or </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">'s'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">add_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">backref</span><span class="s2">, </span><span class="s1">many_to_many_field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_models</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">model </span><span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">model </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">((</span>
            <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_backref</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_backref</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">)))]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">through_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_through_model </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_through_model </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_through_model</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_through_model</span>

    <span class="s2">@</span><span class="s1">through_model</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">through_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_through_model </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">_create_through_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_models</span><span class="s2">()</span>
        <span class="s1">tables </span><span class="s2">= [</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table_name </span><span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)]</span>

        <span class="s0">class </span><span class="s1">Meta</span><span class="s2">:</span>
            <span class="s1">database </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span>
            <span class="s1">schema </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">schema</span>
            <span class="s1">table_name </span><span class="s2">= </span><span class="s3">'%s_%s_through' </span><span class="s2">% </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">tables</span><span class="s2">)</span>
            <span class="s1">indexes </span><span class="s2">= (</span>
                <span class="s2">((</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
                 <span class="s0">True</span><span class="s2">),)</span>

        <span class="s1">params </span><span class="s2">= {</span><span class="s3">'on_delete'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_delete</span><span class="s2">, </span><span class="s3">'on_update'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_update</span><span class="s2">}</span>
        <span class="s1">attrs </span><span class="s2">= {</span>
            <span class="s1">lhs</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span><span class="s2">: </span><span class="s1">ForeignKeyField</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, **</span><span class="s1">params</span><span class="s2">),</span>
            <span class="s1">rhs</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span><span class="s2">: </span><span class="s1">ForeignKeyField</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, **</span><span class="s1">params</span><span class="s2">),</span>
            <span class="s3">'Meta'</span><span class="s2">: </span><span class="s1">Meta</span><span class="s2">}</span>

        <span class="s1">klass_name </span><span class="s2">= </span><span class="s3">'%s%sThrough' </span><span class="s2">% (</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">type</span><span class="s2">(</span><span class="s1">klass_name</span><span class="s2">, (</span><span class="s1">Model</span><span class="s2">,), </span><span class="s1">attrs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_through_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># XXX: Deprecated. Just use the &quot;through_model&quot; property.</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">through_model</span>


<span class="s0">class </span><span class="s1">VirtualField</span><span class="s2">(</span><span class="s1">MetaField</span><span class="s2">):</span>
    <span class="s1">field_class </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field_class</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">Field </span><span class="s2">= </span><span class="s1">field_class </span><span class="s0">if </span><span class="s1">field_class </span><span class="s0">is not None else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_class</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">field_instance </span><span class="s2">= </span><span class="s1">Field</span><span class="s2">() </span><span class="s0">if </span><span class="s1">Field </span><span class="s0">is not None else None</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">VirtualField</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_instance</span><span class="s2">.</span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_instance</span><span class="s2">.</span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">column_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">safe_name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">accessor_class</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">CompositeKey</span><span class="s2">(</span><span class="s1">MetaField</span><span class="s2">):</span>
    <span class="s1">sequence </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">field_names</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">field_names </span><span class="s2">= </span><span class="s1">field_names</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_safe_field_names </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">safe_field_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_safe_field_names </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_names</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_safe_field_names </span><span class="s2">= [</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">f</span><span class="s2">].</span><span class="s1">safe_name</span>
                                      <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_safe_field_names</span>

    <span class="s0">def </span><span class="s1">__get__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">instance_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">instance </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">tuple</span><span class="s2">([</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">f</span><span class="s2">) </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">safe_field_names</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__set__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)):</span>
            <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">'A list or tuple must be used to set the value of '</span>
                            <span class="s3">'a composite primary key.'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) != </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'The length of the value must equal the number '</span>
                             <span class="s3">'of columns of the composite primary key.'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">field_value </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">], </span><span class="s1">field_value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s1">expressions </span><span class="s2">= [(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">field</span><span class="s2">] == </span><span class="s1">value</span><span class="s2">)</span>
                       <span class="s0">for </span><span class="s1">field</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)]</span>
        <span class="s0">return </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, </span><span class="s1">expressions</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">~(</span><span class="s1">self </span><span class="s2">== </span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s4"># If the composite PK is being selected, do not use parens. Elsewhere,</span>
        <span class="s4"># such as in an expression, we want to use parentheses and treat it as</span>
        <span class="s4"># a row value.</span>
        <span class="s1">parens </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">!= </span><span class="s1">SCOPE_SOURCE</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">([</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">field</span><span class="s2">]</span>
                                 <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">], </span><span class="s3">', '</span><span class="s2">, </span><span class="s1">parens</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">column_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">safe_name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_SortedFieldList</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">__slots__ </span><span class="s2">= (</span><span class="s3">'_keys'</span><span class="s2">, </span><span class="s3">'_items'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_keys </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_items </span><span class="s2">= []</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">i</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_items</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_items</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__contains__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">item</span><span class="s2">.</span><span class="s1">_sort_key</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">bisect_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_keys</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">j </span><span class="s2">= </span><span class="s1">bisect_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_keys</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">item </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_items</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:</span><span class="s1">j</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_keys</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">_sort_key</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">item</span><span class="s2">.</span><span class="s1">_sort_key</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">bisect_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_keys</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_keys</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_items</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">item</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
        <span class="s1">idx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_items</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_keys</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>


<span class="s4"># MODELS</span>


<span class="s0">class </span><span class="s1">SchemaManager</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">context_options</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s2">= </span><span class="s1">database</span>
        <span class="s1">context_options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'scope'</span><span class="s2">, </span><span class="s1">SCOPE_VALUES</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">context_options </span><span class="s2">= </span><span class="s1">context_options</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">database</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">db </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span>
        <span class="s0">if </span><span class="s1">db </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ImproperlyConfigured</span><span class="s2">(</span><span class="s3">'database attribute does not appear to '</span>
                                       <span class="s3">'be set on the model: %s' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">db</span>

    <span class="s2">@</span><span class="s1">database</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">database</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s2">= </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">_create_context</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">get_sql_context</span><span class="s2">(**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">context_options</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_create_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s1">is_temp </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'temporary'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_context</span><span class="s2">()</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'CREATE TEMPORARY TABLE ' </span><span class="s0">if </span><span class="s1">is_temp </span><span class="s0">else </span><span class="s3">'CREATE TABLE '</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">safe</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'IF NOT EXISTS '</span><span class="s2">)</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">).</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">)</span>

        <span class="s1">columns </span><span class="s2">= []</span>
        <span class="s1">constraints </span><span class="s2">= []</span>
        <span class="s1">meta </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span>
        <span class="s0">if </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">composite_key</span><span class="s2">:</span>
            <span class="s1">pk_columns </span><span class="s2">= [</span><span class="s1">meta</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">field_name</span><span class="s2">].</span><span class="s1">column</span>
                          <span class="s0">for </span><span class="s1">field_name </span><span class="s0">in </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">]</span>
            <span class="s1">constraints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s3">'PRIMARY KEY'</span><span class="s2">),</span>
                                         <span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">pk_columns</span><span class="s2">))))</span>

        <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">:</span>
            <span class="s1">columns</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">ddl</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">field</span><span class="s2">.</span><span class="s1">deferred</span><span class="s2">:</span>
                <span class="s1">constraints</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">foreign_key_constraint</span><span class="s2">())</span>

        <span class="s0">if </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">constraints</span><span class="s2">:</span>
            <span class="s1">constraints</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">.</span><span class="s1">constraints</span><span class="s2">)</span>

        <span class="s1">constraints</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_table_option_sql</span><span class="s2">(</span><span class="s1">options</span><span class="s2">))</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">EnclosedNodeList</span><span class="s2">(</span><span class="s1">columns </span><span class="s2">+ </span><span class="s1">constraints</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">table_settings </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">table_settings </span><span class="s2">= </span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">.</span><span class="s1">table_settings</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">setting </span><span class="s0">in </span><span class="s1">table_settings</span><span class="s2">:</span>
                <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">setting</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'table_settings must be strings'</span><span class="s2">)</span>
                <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">).</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">setting</span><span class="s2">)</span>

        <span class="s1">extra_opts </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">strict_tables</span><span class="s2">: </span><span class="s1">extra_opts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'STRICT'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">without_rowid</span><span class="s2">: </span><span class="s1">extra_opts</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s3">'WITHOUT ROWID'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">extra_opts</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' %s' </span><span class="s2">% </span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">extra_opts</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">ctx</span>

    <span class="s0">def </span><span class="s1">_create_table_option_sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">options</span><span class="s2">):</span>
        <span class="s1">accum </span><span class="s2">= []</span>
        <span class="s1">options </span><span class="s2">= </span><span class="s1">merge_dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">options </span><span class="s0">or </span><span class="s2">{}, </span><span class="s1">options</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">options</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">accum</span>

        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
                    <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">value </span><span class="s2">= </span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">NodeList</span><span class="s2">((</span><span class="s1">SQL</span><span class="s2">(</span><span class="s1">key</span><span class="s2">), </span><span class="s1">value</span><span class="s2">), </span><span class="s1">glue</span><span class="s2">=</span><span class="s3">'='</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">accum</span>

    <span class="s0">def </span><span class="s1">create_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_table</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">=</span><span class="s1">safe</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_create_table_as</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table_name</span><span class="s2">, </span><span class="s1">query</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">meta</span><span class="s2">):</span>
        <span class="s1">ctx </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_context</span><span class="s2">()</span>
               <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'CREATE TEMPORARY TABLE '</span>
                        <span class="s0">if </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'temporary'</span><span class="s2">) </span><span class="s0">else </span><span class="s3">'CREATE TABLE '</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">safe</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'IF NOT EXISTS '</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">ctx</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(*</span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">)))</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' AS '</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">query</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">create_table_as</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table_name</span><span class="s2">, </span><span class="s1">query</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">meta</span><span class="s2">):</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_table_as</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">, </span><span class="s1">query</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s1">safe</span><span class="s2">, **</span><span class="s1">meta</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_drop_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s1">ctx </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_context</span><span class="s2">()</span>
               <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'DROP TABLE IF EXISTS ' </span><span class="s0">if </span><span class="s1">safe </span><span class="s0">else </span><span class="s3">'DROP TABLE '</span><span class="s2">)</span>
               <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'cascade'</span><span class="s2">):</span>
            <span class="s1">ctx </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' CASCADE'</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'restrict'</span><span class="s2">):</span>
            <span class="s1">ctx </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' RESTRICT'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>

    <span class="s0">def </span><span class="s1">drop_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_drop_table</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">=</span><span class="s1">safe</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_truncate_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">restart_identity</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">cascade</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">db </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span>
        <span class="s0">if not </span><span class="s1">db</span><span class="s2">.</span><span class="s1">truncate_table</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_context</span><span class="s2">()</span>
                    <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'DELETE FROM '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">))</span>

        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_context</span><span class="s2">().</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'TRUNCATE TABLE '</span><span class="s2">).</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">restart_identity</span><span class="s2">:</span>
            <span class="s1">ctx </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' RESTART IDENTITY'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">cascade</span><span class="s2">:</span>
            <span class="s1">ctx </span><span class="s2">= </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' CASCADE'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ctx</span>

    <span class="s0">def </span><span class="s1">truncate_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">restart_identity</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">cascade</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_truncate_table</span><span class="s2">(</span><span class="s1">restart_identity</span><span class="s2">, </span><span class="s1">cascade</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_create_indexes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_index</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields_to_index</span><span class="s2">()]</span>

    <span class="s0">def </span><span class="s1">_create_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">Index</span><span class="s2">):</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">safe_create_index</span><span class="s2">:</span>
                <span class="s1">index </span><span class="s2">= </span><span class="s1">index</span><span class="s2">.</span><span class="s1">safe</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">index</span><span class="s2">.</span><span class="s1">_safe </span><span class="s2">!= </span><span class="s1">safe</span><span class="s2">:</span>
                <span class="s1">index </span><span class="s2">= </span><span class="s1">index</span><span class="s2">.</span><span class="s1">safe</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">, </span><span class="s1">SqliteDatabase</span><span class="s2">):</span>
                <span class="s4"># Ensure we do not use value placeholders with Sqlite, as they</span>
                <span class="s4"># are not supported.</span>
                <span class="s1">index </span><span class="s2">= </span><span class="s1">ValueLiterals</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_context</span><span class="s2">().</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">create_indexes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">query </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_indexes</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">=</span><span class="s1">safe</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">query</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_drop_indexes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_drop_index</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields_to_index</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">Index</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">_drop_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">):</span>
        <span class="s1">statement </span><span class="s2">= </span><span class="s3">'DROP INDEX '</span>
        <span class="s0">if </span><span class="s1">safe </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">safe_drop_index</span><span class="s2">:</span>
            <span class="s1">statement </span><span class="s2">+= </span><span class="s3">'IF EXISTS '</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index</span><span class="s2">.</span><span class="s1">_table</span><span class="s2">, </span><span class="s1">Table</span><span class="s2">) </span><span class="s0">and </span><span class="s1">index</span><span class="s2">.</span><span class="s1">_table</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">:</span>
            <span class="s1">index_name </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">index</span><span class="s2">.</span><span class="s1">_table</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">, </span><span class="s1">index</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">index_name </span><span class="s2">= </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">index</span><span class="s2">.</span><span class="s1">_name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span>
                <span class="s2">.</span><span class="s1">_create_context</span><span class="s2">()</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s1">statement</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">index_name</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">drop_indexes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">query </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_drop_indexes</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">=</span><span class="s1">safe</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">query</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_sequences</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">field</span><span class="s2">.</span><span class="s1">sequence </span><span class="s0">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">sequences</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Sequences are either not supported, or are not '</span>
                             <span class="s3">'defined for &quot;%s&quot;.' </span><span class="s2">% </span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_sequence_for_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_create_sequence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sequences</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">sequence_exists</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span>
                    <span class="s2">.</span><span class="s1">_create_context</span><span class="s2">()</span>
                    <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'CREATE SEQUENCE '</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sequence_for_field</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">create_sequence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">seq_ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_sequence</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">seq_ctx </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">seq_ctx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_drop_sequence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_sequences</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">sequence_exists</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span>
                    <span class="s2">.</span><span class="s1">_create_context</span><span class="s2">()</span>
                    <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'DROP SEQUENCE '</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sequence_for_field</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">drop_sequence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">seq_ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_drop_sequence</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">seq_ctx </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">seq_ctx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_create_foreign_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s3">'fk_%s_%s_refs_%s' </span><span class="s2">% (</span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table_name</span><span class="s2">,</span>
                                     <span class="s1">field</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">,</span>
                                     <span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table_name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span>
                <span class="s2">.</span><span class="s1">_create_context</span><span class="s2">()</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">'ALTER TABLE '</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' ADD CONSTRAINT '</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">_truncate_constraint_name</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)))</span>
                <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' '</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">foreign_key_constraint</span><span class="s2">()))</span>

    <span class="s0">def </span><span class="s1">create_foreign_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_create_foreign_key</span><span class="s2">(</span><span class="s1">field</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">create_sequences</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">sequences</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">create_sequence</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">create_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">table_options</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">create_sequences</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">create_table</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">, **</span><span class="s1">table_options</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">create_indexes</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">=</span><span class="s1">safe</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">drop_sequences</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">sequences</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">drop_sequence</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">drop_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop_sequences</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">drop_sequences</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">drop_sequences</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">Metadata</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">table_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">indexes</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">primary_key</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">constraints</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">only_save_dirty</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">depends_on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">options</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">db_table</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">table_function</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">table_settings</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">without_rowid</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">temporary</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">strict_tables</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">legacy_table_names</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">db_table </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;db_table&quot; has been deprecated in favor of '</span>
                           <span class="s3">'&quot;table_name&quot; for Models.'</span><span class="s2">)</span>
            <span class="s1">table_name </span><span class="s2">= </span><span class="s1">db_table</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database </span><span class="s2">= </span><span class="s1">database</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">fields </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">combined </span><span class="s2">= {}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_sorted_field_list </span><span class="s2">= </span><span class="s1">_SortedFieldList</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sorted_fields </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sorted_field_names </span><span class="s2">= []</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">defaults </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_by_name </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_dict </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_callables </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_callable_list </span><span class="s2">= []</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">table_function </span><span class="s2">= </span><span class="s1">table_function</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">legacy_table_names </span><span class="s2">= </span><span class="s1">legacy_table_names</span>
        <span class="s0">if not </span><span class="s1">table_name</span><span class="s2">:</span>
            <span class="s1">table_name </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table_function</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
                          <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table_function</span>
                          <span class="s0">else </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_table_name</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">table_name </span><span class="s2">= </span><span class="s1">table_name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_table </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">indexes </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">indexes</span><span class="s2">) </span><span class="s0">if </span><span class="s1">indexes </span><span class="s0">else </span><span class="s2">[]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">constraints </span><span class="s2">= </span><span class="s1">constraints</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_schema </span><span class="s2">= </span><span class="s1">schema</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">= </span><span class="s1">primary_key</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">composite_key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_increment </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">only_save_dirty </span><span class="s2">= </span><span class="s1">only_save_dirty</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">depends_on </span><span class="s2">= </span><span class="s1">depends_on</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">table_settings </span><span class="s2">= </span><span class="s1">table_settings</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">without_rowid </span><span class="s2">= </span><span class="s1">without_rowid</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">strict_tables </span><span class="s2">= </span><span class="s1">strict_tables</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">temporary </span><span class="s2">= </span><span class="s1">temporary</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">refs </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">backrefs </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model_refs </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">list</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model_backrefs </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">list</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">manytomany </span><span class="s2">= {}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">options </span><span class="s2">= </span><span class="s1">options </span><span class="s0">or </span><span class="s2">{}</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_additional_keys </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>

        <span class="s4"># Allow objects to register hooks that are called if the model is bound</span>
        <span class="s4"># to a different database. For example, BlobField uses a different</span>
        <span class="s4"># Python data-type depending on the db driver / python version. When</span>
        <span class="s4"># the database changes, we need to update any BlobField so they can use</span>
        <span class="s4"># the appropriate data-type.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_db_hooks </span><span class="s2">= []</span>

    <span class="s0">def </span><span class="s1">make_table_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">legacy_table_names</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">re</span><span class="s2">.</span><span class="s1">sub</span><span class="s2">(</span><span class="s3">r'[^\w]+'</span><span class="s2">, </span><span class="s3">'_'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">make_snake_case</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">model_graph</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">refs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">backrefs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">depth_first</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">refs </span><span class="s0">and not </span><span class="s1">backrefs</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'One of `refs` or `backrefs` must be True.'</span><span class="s2">)</span>

        <span class="s1">accum </span><span class="s2">= [(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
        <span class="s1">seen </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">queue </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">deque</span><span class="s2">((</span><span class="s1">self</span><span class="s2">,))</span>
        <span class="s1">method </span><span class="s2">= </span><span class="s1">queue</span><span class="s2">.</span><span class="s1">pop </span><span class="s0">if </span><span class="s1">depth_first </span><span class="s0">else </span><span class="s1">queue</span><span class="s2">.</span><span class="s1">popleft</span>

        <span class="s0">while </span><span class="s1">queue</span><span class="s2">:</span>
            <span class="s1">curr </span><span class="s2">= </span><span class="s1">method</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">curr </span><span class="s0">in </span><span class="s1">seen</span><span class="s2">: </span><span class="s0">continue</span>
            <span class="s1">seen</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">refs</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">fk</span><span class="s2">, </span><span class="s1">model </span><span class="s0">in </span><span class="s1">curr</span><span class="s2">.</span><span class="s1">refs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">fk</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s0">False</span><span class="s2">))</span>
                    <span class="s1">queue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">backrefs</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">fk</span><span class="s2">, </span><span class="s1">model </span><span class="s0">in </span><span class="s1">curr</span><span class="s2">.</span><span class="s1">backrefs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">fk</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s0">True</span><span class="s2">))</span>
                    <span class="s1">queue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">accum</span>

    <span class="s0">def </span><span class="s1">add_ref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">rel </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">refs</span><span class="s2">[</span><span class="s1">field</span><span class="s2">] = </span><span class="s1">rel</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model_refs</span><span class="s2">[</span><span class="s1">rel</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
        <span class="s1">rel</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">backrefs</span><span class="s2">[</span><span class="s1">field</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s1">rel</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model_backrefs</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove_ref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">rel </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">refs</span><span class="s2">[</span><span class="s1">field</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model_refs</span><span class="s2">[</span><span class="s1">rel</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
        <span class="s0">del </span><span class="s1">rel</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">backrefs</span><span class="s2">[</span><span class="s1">field</span><span class="s2">]</span>
        <span class="s1">rel</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model_backrefs</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">add_manytomany</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">manytomany</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">field</span>

    <span class="s0">def </span><span class="s1">remove_manytomany</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">manytomany</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_table </span><span class="s2">= </span><span class="s1">Table</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">table_name</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">column_name </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">],</span>
                <span class="s1">schema</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">,</span>
                <span class="s1">_model</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">,</span>
                <span class="s1">_database</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_table</span>

    <span class="s2">@</span><span class="s1">table</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'Cannot set the &quot;table&quot;.'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">table</span><span class="s2">.</span><span class="s1">deleter</span>
    <span class="s0">def </span><span class="s1">table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_table </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">schema</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_schema</span>

    <span class="s2">@</span><span class="s1">schema</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">schema</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_schema </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table_name</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">table_name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_update_sorted_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sorted_fields </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_sorted_field_list</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sorted_field_names </span><span class="s2">= [</span><span class="s1">f</span><span class="s2">.</span><span class="s1">name </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">get_rel_for_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">ModelAlias</span><span class="s2">):</span>
            <span class="s1">model </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s1">forwardrefs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model_refs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, [])</span>
        <span class="s1">backrefs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model_backrefs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, [])</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">forwardrefs</span><span class="s2">, </span><span class="s1">backrefs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">add_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field_name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">field_name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">remove_field</span><span class="s2">(</span><span class="s1">field_name</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">field_name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">manytomany</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">remove_manytomany</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">manytomany</span><span class="s2">[</span><span class="s1">field_name</span><span class="s2">])</span>

        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">MetaField</span><span class="s2">):</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span>
            <span class="s1">field</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">field_name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">field</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">] = </span><span class="s1">field</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">combined</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">field</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">combined</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">] = </span><span class="s1">field</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">_sorted_field_list</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_sorted_fields</span><span class="s2">()</span>

            <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">default </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s4"># This optimization helps speed up model instance construction.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">defaults</span><span class="s2">[</span><span class="s1">field</span><span class="s2">] = </span><span class="s1">field</span><span class="s2">.</span><span class="s1">default</span>
                <span class="s0">if </span><span class="s1">callable_</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">default</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_callables</span><span class="s2">[</span><span class="s1">field</span><span class="s2">] = </span><span class="s1">field</span><span class="s2">.</span><span class="s1">default</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_callable_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
                                                        <span class="s1">field</span><span class="s2">.</span><span class="s1">default</span><span class="s2">))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_dict</span><span class="s2">[</span><span class="s1">field</span><span class="s2">] = </span><span class="s1">field</span><span class="s2">.</span><span class="s1">default</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_by_name</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">field</span><span class="s2">.</span><span class="s1">default</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">field</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">field_name</span><span class="s2">, </span><span class="s1">set_attribute</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_ref</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">ManyToManyField</span><span class="s2">) </span><span class="s0">and </span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_manytomany</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field_name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">field_name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">field_name</span><span class="s2">)</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">original</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">]</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">combined</span><span class="s2">[</span><span class="s1">field_name</span><span class="s2">]</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">combined</span><span class="s2">[</span><span class="s1">original</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_sorted_field_list</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">original</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_sorted_fields</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">original</span><span class="s2">.</span><span class="s1">default </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">defaults</span><span class="s2">[</span><span class="s1">original</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_default_callables</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">original</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_default_callable_list</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s1">field_name</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_callable_list</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
                        <span class="s0">break</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_dict</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">original</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_default_by_name</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">original</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">original</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">remove_ref</span><span class="s2">(</span><span class="s1">original</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">set_primary_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">composite_key </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">CompositeKey</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">add_field</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">= </span><span class="s1">field</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">auto_increment </span><span class="s2">= (</span>
            <span class="s1">field</span><span class="s2">.</span><span class="s1">auto_increment </span><span class="s0">or</span>
            <span class="s1">bool</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">sequence</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">get_primary_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">composite_key</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">tuple</span><span class="s2">([</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">field_name</span><span class="s2">]</span>
                          <span class="s0">for </span><span class="s1">field_name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">,) </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s0">is not False else </span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">get_default_dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dd </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_default_by_name</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">field_name</span><span class="s2">, </span><span class="s1">default </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_default_callable_list</span><span class="s2">:</span>
            <span class="s1">dd</span><span class="s2">[</span><span class="s1">field_name</span><span class="s2">] = </span><span class="s1">default</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">dd</span>

    <span class="s0">def </span><span class="s1">fields_to_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">indexes </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">f</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s0">if </span><span class="s1">f</span><span class="s2">.</span><span class="s1">index </span><span class="s0">or </span><span class="s1">f</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">:</span>
                <span class="s1">indexes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ModelIndex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, (</span><span class="s1">f</span><span class="s2">,), </span><span class="s1">unique</span><span class="s2">=</span><span class="s1">f</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">,</span>
                                          <span class="s1">using</span><span class="s2">=</span><span class="s1">f</span><span class="s2">.</span><span class="s1">index_type</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">index_obj </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">indexes</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index_obj</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                <span class="s1">indexes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">index_obj</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">index_obj</span><span class="s2">, (</span><span class="s1">list</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)):</span>
                <span class="s1">index_parts</span><span class="s2">, </span><span class="s1">unique </span><span class="s2">= </span><span class="s1">index_obj</span>
                <span class="s1">fields </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">part </span><span class="s0">in </span><span class="s1">index_parts</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">part</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                        <span class="s1">fields</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">combined</span><span class="s2">[</span><span class="s1">part</span><span class="s2">])</span>
                    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">part</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                        <span class="s1">fields</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">part</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Expected either a field name or a '</span>
                                         <span class="s3">'subclass of Node. Got: %s' </span><span class="s2">% </span><span class="s1">part</span><span class="s2">)</span>
                <span class="s1">indexes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ModelIndex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">, </span><span class="s1">unique</span><span class="s2">=</span><span class="s1">unique</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s1">indexes</span>

    <span class="s0">def </span><span class="s1">set_database</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database </span><span class="s2">= </span><span class="s1">database</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">.</span><span class="s1">_database </span><span class="s2">= </span><span class="s1">database</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span>

        <span class="s4"># Apply any hooks that have been registered. If we have an</span>
        <span class="s4"># uninitialized proxy object, we will treat that as `None`.</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">database</span><span class="s2">, </span><span class="s1">Proxy</span><span class="s2">) </span><span class="s0">and </span><span class="s1">database</span><span class="s2">.</span><span class="s1">obj </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">database </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">for </span><span class="s1">hook </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_db_hooks</span><span class="s2">:</span>
            <span class="s1">hook</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">set_table_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table_name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">table_name </span><span class="s2">= </span><span class="s1">table_name</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">table</span>


<span class="s0">class </span><span class="s1">SubclassAwareMetadata</span><span class="s2">(</span><span class="s1">Metadata</span><span class="s2">):</span>
    <span class="s1">models </span><span class="s2">= []</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">SubclassAwareMetadata</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">map_models</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">models</span><span class="s2">:</span>
            <span class="s1">fn</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DoesNotExist</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">): </span><span class="s0">pass</span>


<span class="s0">class </span><span class="s1">ModelBase</span><span class="s2">(</span><span class="s1">type</span><span class="s2">):</span>
    <span class="s1">inheritable </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s3">'constraints'</span><span class="s2">, </span><span class="s3">'database'</span><span class="s2">, </span><span class="s3">'indexes'</span><span class="s2">, </span><span class="s3">'primary_key'</span><span class="s2">,</span>
                       <span class="s3">'options'</span><span class="s2">, </span><span class="s3">'schema'</span><span class="s2">, </span><span class="s3">'table_function'</span><span class="s2">, </span><span class="s3">'temporary'</span><span class="s2">,</span>
                       <span class="s3">'only_save_dirty'</span><span class="s2">, </span><span class="s3">'legacy_table_names'</span><span class="s2">,</span>
                       <span class="s3">'table_settings'</span><span class="s2">, </span><span class="s3">'strict_tables'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">bases</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s1">MODEL_BASE </span><span class="s0">or </span><span class="s1">bases</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">__name__ </span><span class="s2">== </span><span class="s1">MODEL_BASE</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ModelBase</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">).</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">bases</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">,</span>
                                                 <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">meta_options </span><span class="s2">= {}</span>
        <span class="s1">meta </span><span class="s2">= </span><span class="s1">attrs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'Meta'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">meta</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if not </span><span class="s1">k</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'_'</span><span class="s2">):</span>
                    <span class="s1">meta_options</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">v</span>

        <span class="s1">pk </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">meta</span><span class="s2">, </span><span class="s3">'primary_key'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">pk_name </span><span class="s2">= </span><span class="s1">parent_pk </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s4"># Inherit any field descriptors by deep copying the underlying field</span>
        <span class="s4"># into the attrs of the new model, additionally see if the bases define</span>
        <span class="s4"># inheritable model options and swipe them.</span>
        <span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">bases</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s3">'_meta'</span><span class="s2">):</span>
                <span class="s0">continue</span>

            <span class="s1">base_meta </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">_meta</span>
            <span class="s0">if </span><span class="s1">parent_pk </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">parent_pk </span><span class="s2">= </span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">base_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">)</span>
            <span class="s1">all_inheritable </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">inheritable </span><span class="s2">| </span><span class="s1">base_meta</span><span class="s2">.</span><span class="s1">_additional_keys</span>
            <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">base_meta</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">k </span><span class="s0">in </span><span class="s1">all_inheritable </span><span class="s0">and </span><span class="s1">k </span><span class="s0">not in </span><span class="s1">meta_options</span><span class="s2">:</span>
                    <span class="s1">meta_options</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">base_meta</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]</span>
            <span class="s1">meta_options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'database'</span><span class="s2">, </span><span class="s1">base_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">)</span>
            <span class="s1">meta_options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'schema'</span><span class="s2">, </span><span class="s1">base_meta</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">)</span>

            <span class="s0">for </span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">v</span><span class="s2">) </span><span class="s0">in </span><span class="s1">b</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">k </span><span class="s0">in </span><span class="s1">attrs</span><span class="s2">: </span><span class="s0">continue</span>

                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">FieldAccessor</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">v</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">:</span>
                    <span class="s1">attrs</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">field</span><span class="s2">)</span>

        <span class="s1">sopts </span><span class="s2">= </span><span class="s1">meta_options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'schema_options'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) </span><span class="s0">or </span><span class="s2">{}</span>
        <span class="s1">Meta </span><span class="s2">= </span><span class="s1">meta_options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'model_metadata_class'</span><span class="s2">, </span><span class="s1">Metadata</span><span class="s2">)</span>
        <span class="s1">Schema </span><span class="s2">= </span><span class="s1">meta_options</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'schema_manager_class'</span><span class="s2">, </span><span class="s1">SchemaManager</span><span class="s2">)</span>

        <span class="s4"># Construct the new class.</span>
        <span class="s1">cls </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ModelBase</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">).</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">bases</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">__data__ </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">__rel__ </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta </span><span class="s2">= </span><span class="s1">Meta</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, **</span><span class="s1">meta_options</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">_schema </span><span class="s2">= </span><span class="s1">Schema</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, **</span><span class="s1">sopts</span><span class="s2">)</span>

        <span class="s1">fields </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">value</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s0">and </span><span class="s1">pk</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'over-determined primary key %s.' </span><span class="s2">% </span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">value</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">:</span>
                    <span class="s1">pk</span><span class="s2">, </span><span class="s1">pk_name </span><span class="s2">= </span><span class="s1">value</span><span class="s2">, </span><span class="s1">key</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">fields</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">pk </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">parent_pk </span><span class="s0">is not False</span><span class="s2">:</span>
                <span class="s1">pk</span><span class="s2">, </span><span class="s1">pk_name </span><span class="s2">= ((</span><span class="s1">parent_pk</span><span class="s2">, </span><span class="s1">parent_pk</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                               <span class="s0">if </span><span class="s1">parent_pk </span><span class="s0">is not None else</span>
                               <span class="s2">(</span><span class="s1">AutoField</span><span class="s2">(), </span><span class="s3">'id'</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">pk </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">pk</span><span class="s2">, </span><span class="s1">CompositeKey</span><span class="s2">):</span>
            <span class="s1">pk_name </span><span class="s2">= </span><span class="s3">'__composite_key__'</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">composite_key </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s0">if </span><span class="s1">pk </span><span class="s0">is not False</span><span class="s2">:</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">set_primary_key</span><span class="s2">(</span><span class="s1">pk_name</span><span class="s2">, </span><span class="s1">pk</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">add_field</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">field</span><span class="s2">)</span>

        <span class="s4"># Create a repr and error class before finalizing.</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s3">'__str__'</span><span class="s2">) </span><span class="s0">and </span><span class="s3">'__repr__' </span><span class="s0">not in </span><span class="s1">attrs</span><span class="s2">:</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s3">'__repr__'</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s3">'&lt;%s: %s&gt;' </span><span class="s2">% (</span>
                <span class="s1">cls</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__str__</span><span class="s2">()))</span>

        <span class="s1">exc_name </span><span class="s2">= </span><span class="s3">'%sDoesNotExist' </span><span class="s2">% </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">__name__</span>
        <span class="s1">exc_attrs </span><span class="s2">= {</span><span class="s3">'__module__'</span><span class="s2">: </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">__module__</span><span class="s2">}</span>
        <span class="s1">exception_class </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">exc_name</span><span class="s2">, (</span><span class="s1">DoesNotExist</span><span class="s2">,), </span><span class="s1">exc_attrs</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">DoesNotExist </span><span class="s2">= </span><span class="s1">exception_class</span>

        <span class="s4"># Call validation hook, allowing additional model validation.</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">validate_model</span><span class="s2">()</span>
        <span class="s1">DeferredForeignKey</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">cls</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">'&lt;Model: %s&gt;' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__name__</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">select</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_by_id</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">set_by_id</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__delitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">delete_by_id</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__contains__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">get_by_id</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DoesNotExist</span><span class="s2">:</span>
            <span class="s0">return False</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">select</span><span class="s2">().</span><span class="s1">count</span><span class="s2">()</span>
    <span class="s0">def </span><span class="s1">__bool__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">): </span><span class="s0">return True</span>
    <span class="s1">__nonzero__ </span><span class="s2">= </span><span class="s1">__bool__  </span><span class="s4"># Python 2.</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_BoundModelsContext</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">models</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">bind_refs</span><span class="s2">, </span><span class="s1">bind_backrefs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">models </span><span class="s2">= </span><span class="s1">models</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">database </span><span class="s2">= </span><span class="s1">database</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bind_refs </span><span class="s2">= </span><span class="s1">bind_refs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bind_backrefs </span><span class="s2">= </span><span class="s1">bind_backrefs</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_database </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">models</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_database</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">)</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">database</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bind_refs</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bind_backrefs</span><span class="s2">,</span>
                       <span class="s1">_exclude</span><span class="s2">=</span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">models</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">models</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">model</span><span class="s2">, </span><span class="s1">db </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">models</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_database</span><span class="s2">):</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">db</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bind_refs</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bind_backrefs</span><span class="s2">,</span>
                       <span class="s1">_exclude</span><span class="s2">=</span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">models</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">Model</span><span class="s2">(</span><span class="s1">with_metaclass</span><span class="s2">(</span><span class="s1">ModelBase</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">)):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'__no_default__'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__data__ </span><span class="s2">= {}</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__data__ </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">get_default_dict</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_dirty </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__rel__ </span><span class="s2">= {}</span>

        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s1">k</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pk</span><span class="s2">) </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s0">is not False else </span><span class="s3">'n/a'</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">validate_model</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">alias</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelAlias</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">select</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, *</span><span class="s1">fields</span><span class="s2">):</span>
        <span class="s1">is_default </span><span class="s2">= </span><span class="s0">not </span><span class="s1">fields</span>
        <span class="s0">if not </span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s1">fields </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_fields</span>
        <span class="s0">return </span><span class="s1">ModelSelect</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">, </span><span class="s1">is_default</span><span class="s2">=</span><span class="s1">is_default</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">_normalize_data</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">normalized </span><span class="s2">= {}</span>
        <span class="s0">if </span><span class="s1">data</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Data cannot be mixed with keyword '</span>
                                     <span class="s3">'arguments: %s' </span><span class="s2">% </span><span class="s1">data</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">data</span>
            <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">data</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">field </span><span class="s2">= (</span><span class="s1">key </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">)</span>
                             <span class="s0">else </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">combined</span><span class="s2">[</span><span class="s1">key</span><span class="s2">])</span>
                <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
                    <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Unrecognized field name: &quot;%s&quot; in %s.'</span>
                                         <span class="s2">% (</span><span class="s1">key</span><span class="s2">, </span><span class="s1">data</span><span class="s2">))</span>
                    <span class="s1">field </span><span class="s2">= </span><span class="s1">key</span>
                <span class="s1">normalized</span><span class="s2">[</span><span class="s1">field</span><span class="s2">] = </span><span class="s1">data</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">normalized</span><span class="s2">[</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">combined</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]] = </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
                <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
                    <span class="s1">normalized</span><span class="s2">[</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)] = </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">normalized</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">__data</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">update</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelUpdate</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_normalize_data</span><span class="s2">(</span><span class="s1">__data</span><span class="s2">, </span><span class="s1">update</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">__data</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">insert</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelInsert</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_normalize_data</span><span class="s2">(</span><span class="s1">__data</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">insert_many</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelInsert</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">=</span><span class="s1">rows</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">fields</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">insert_from</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">query</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">):</span>
        <span class="s1">columns </span><span class="s2">= [</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">field</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">)</span>
                   <span class="s0">else </span><span class="s1">field </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">ModelInsert</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">=</span><span class="s1">query</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">replace</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">__data</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">insert</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">__data</span><span class="s2">, **</span><span class="s1">insert</span><span class="s2">).</span><span class="s1">on_conflict</span><span class="s2">(</span><span class="s3">'REPLACE'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">replace_many</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">cls</span>
                <span class="s2">.</span><span class="s1">insert_many</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">=</span><span class="s1">rows</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">=</span><span class="s1">fields</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">on_conflict</span><span class="s2">(</span><span class="s3">'REPLACE'</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">raw</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">, *</span><span class="s1">params</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelRaw</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">delete</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelDelete</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">create</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, **</span><span class="s1">query</span><span class="s2">):</span>
        <span class="s1">inst </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(**</span><span class="s1">query</span><span class="s2">)</span>
        <span class="s1">inst</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">force_insert</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">inst</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">bulk_create</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">model_list</span><span class="s2">, </span><span class="s1">batch_size</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">batch_size </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">batches </span><span class="s2">= </span><span class="s1">chunked</span><span class="s2">(</span><span class="s1">model_list</span><span class="s2">, </span><span class="s1">batch_size</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">batches </span><span class="s2">= [</span><span class="s1">model_list</span><span class="s2">]</span>

        <span class="s1">field_names </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_field_names</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">auto_increment</span><span class="s2">:</span>
            <span class="s1">pk_name </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s1">field_names</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">pk_name</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">returning_clause </span><span class="s0">and </span><span class="s1">\</span>
           <span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s0">is not False</span><span class="s2">:</span>
            <span class="s1">pk_fields </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">get_primary_keys</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">pk_fields </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">fields </span><span class="s2">= [</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">field_name</span><span class="s2">] </span><span class="s0">for </span><span class="s1">field_name </span><span class="s0">in </span><span class="s1">field_names</span><span class="s2">]</span>
        <span class="s1">attrs </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">):</span>
                <span class="s1">attrs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">object_id_name</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">attrs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">batch </span><span class="s0">in </span><span class="s1">batches</span><span class="s2">:</span>
            <span class="s1">accum </span><span class="s2">= ([</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">f</span><span class="s2">) </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">attrs</span><span class="s2">]</span>
                     <span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">batch</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">insert_many</span><span class="s2">(</span><span class="s1">accum</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">=</span><span class="s1">fields</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">pk_fields </span><span class="s0">and </span><span class="s1">res </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">row</span><span class="s2">, </span><span class="s1">model </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">):</span>
                    <span class="s0">for </span><span class="s2">(</span><span class="s1">pk_field</span><span class="s2">, </span><span class="s1">obj_id</span><span class="s2">) </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">pk_fields</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
                        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">pk_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">obj_id</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">bulk_update</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">model_list</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">, </span><span class="s1">batch_size</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">, </span><span class="s1">CompositeKey</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'bulk_update() is not supported for models with '</span>
                             <span class="s3">'a composite primary key.'</span><span class="s2">)</span>

        <span class="s4"># First normalize list of fields so all are field instances.</span>
        <span class="s1">fields </span><span class="s2">= [</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">f</span><span class="s2">] </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">) </span><span class="s0">else </span><span class="s1">f</span>
                  <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">]</span>
        <span class="s4"># Now collect list of attribute names to use for values.</span>
        <span class="s1">attrs </span><span class="s2">= [</span><span class="s1">field</span><span class="s2">.</span><span class="s1">object_id_name </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">)</span>
                 <span class="s0">else </span><span class="s1">field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">batch_size </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">batches </span><span class="s2">= </span><span class="s1">chunked</span><span class="s2">(</span><span class="s1">model_list</span><span class="s2">, </span><span class="s1">batch_size</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">batches </span><span class="s2">= [</span><span class="s1">model_list</span><span class="s2">]</span>

        <span class="s1">n </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">pk </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span>

        <span class="s0">for </span><span class="s1">batch </span><span class="s0">in </span><span class="s1">batches</span><span class="s2">:</span>
            <span class="s1">id_list </span><span class="s2">= [</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_pk </span><span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">batch</span><span class="s2">]</span>
            <span class="s1">update </span><span class="s2">= {}</span>
            <span class="s0">for </span><span class="s1">field</span><span class="s2">, </span><span class="s1">attr </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">fields</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
                <span class="s1">accum </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s1">batch</span><span class="s2">:</span>
                    <span class="s1">value </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>
                    <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                        <span class="s1">value </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">to_value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                    <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">pk</span><span class="s2">.</span><span class="s1">to_value</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_pk</span><span class="s2">), </span><span class="s1">value</span><span class="s2">))</span>
                <span class="s1">case </span><span class="s2">= </span><span class="s1">Case</span><span class="s2">(</span><span class="s1">pk</span><span class="s2">, </span><span class="s1">accum</span><span class="s2">)</span>
                <span class="s1">update</span><span class="s2">[</span><span class="s1">field</span><span class="s2">] = </span><span class="s1">case</span>

            <span class="s1">n </span><span class="s2">+= (</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">update</span><span class="s2">)</span>
                  <span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">.</span><span class="s1">in_</span><span class="s2">(</span><span class="s1">id_list</span><span class="s2">))</span>
                  <span class="s2">.</span><span class="s1">execute</span><span class="s2">())</span>
        <span class="s0">return </span><span class="s1">n</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">noop</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">NoopModelSelect</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, ())</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, *</span><span class="s1">query</span><span class="s2">, **</span><span class="s1">filters</span><span class="s2">):</span>
        <span class="s1">sq </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">select</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">query</span><span class="s2">:</span>
            <span class="s4"># Handle simple lookup using just the primary key.</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">query</span><span class="s2">) == </span><span class="s5">1 </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">query</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">int</span><span class="s2">):</span>
                <span class="s1">sq </span><span class="s2">= </span><span class="s1">sq</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">== </span><span class="s1">query</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">sq </span><span class="s2">= </span><span class="s1">sq</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(*</span><span class="s1">query</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">filters</span><span class="s2">:</span>
            <span class="s1">sq </span><span class="s2">= </span><span class="s1">sq</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(**</span><span class="s1">filters</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">sq</span><span class="s2">.</span><span class="s1">get</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">get_or_none</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, *</span><span class="s1">query</span><span class="s2">, **</span><span class="s1">filters</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(*</span><span class="s1">query</span><span class="s2">, **</span><span class="s1">filters</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">DoesNotExist</span><span class="s2">:</span>
            <span class="s0">pass</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">get_by_id</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">pk</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">== </span><span class="s1">pk</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">set_by_id</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">value</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">== </span><span class="s1">key</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">())</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">delete_by_id</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">pk</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">().</span><span class="s1">where</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">== </span><span class="s1">pk</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">get_or_create</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">defaults </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'defaults'</span><span class="s2">, {})</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">select</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">field</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">query </span><span class="s2">= </span><span class="s1">query</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">field</span><span class="s2">) == </span><span class="s1">value</span><span class="s2">)</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">query</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(), </span><span class="s0">False</span>
        <span class="s0">except </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">DoesNotExist</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">defaults</span><span class="s2">:</span>
                    <span class="s1">kwargs</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">defaults</span><span class="s2">)</span>
                <span class="s0">with </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">atomic</span><span class="s2">():</span>
                    <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">), </span><span class="s0">True</span>
            <span class="s0">except </span><span class="s1">IntegrityError </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">query</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(), </span><span class="s0">False</span>
                <span class="s0">except </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">DoesNotExist</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">exc</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, *</span><span class="s1">dq_nodes</span><span class="s2">, **</span><span class="s1">filters</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">select</span><span class="s2">().</span><span class="s1">filter</span><span class="s2">(*</span><span class="s1">dq_nodes</span><span class="s2">, **</span><span class="s1">filters</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Using getattr(self, pk-name) could accidentally trigger a query if</span>
        <span class="s4"># the primary-key is a foreign-key. So we use the safe_name attribute,</span>
        <span class="s4"># which defaults to the field-name, but will be the object_id_name for</span>
        <span class="s4"># foreign-key fields.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s0">is not False</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">.</span><span class="s1">safe_name</span><span class="s2">)</span>

    <span class="s1">_pk </span><span class="s2">= </span><span class="s1">property</span><span class="s2">(</span><span class="s1">get_id</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">_pk</span><span class="s2">.</span><span class="s1">setter</span>
    <span class="s0">def </span><span class="s1">_pk</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_pk_expr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pk</span>

    <span class="s0">def </span><span class="s1">_prune_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field_dict</span><span class="s2">, </span><span class="s1">only</span><span class="s2">):</span>
        <span class="s1">new_data </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">only</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">basestring</span><span class="s2">):</span>
                <span class="s1">field </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">combined</span><span class="s2">[</span><span class="s1">field</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">field_dict</span><span class="s2">:</span>
                <span class="s1">new_data</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">field_dict</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">new_data</span>

    <span class="s0">def </span><span class="s1">_populate_unsaved_relations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">field_dict</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">foreign_key_field </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">refs</span><span class="s2">:</span>
            <span class="s1">foreign_key </span><span class="s2">= </span><span class="s1">foreign_key_field</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s1">conditions </span><span class="s2">= (</span>
                <span class="s1">foreign_key </span><span class="s0">in </span><span class="s1">field_dict </span><span class="s0">and</span>
                <span class="s1">field_dict</span><span class="s2">[</span><span class="s1">foreign_key</span><span class="s2">] </span><span class="s0">is None and</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">__rel__</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">foreign_key</span><span class="s2">) </span><span class="s0">is not None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">conditions</span><span class="s2">:</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">foreign_key</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">foreign_key</span><span class="s2">))</span>
                <span class="s1">field_dict</span><span class="s2">[</span><span class="s1">foreign_key</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">foreign_key</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">save</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">force_insert</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">only</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">field_dict </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s0">is not False</span><span class="s2">:</span>
            <span class="s1">pk_field </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span>
            <span class="s1">pk_value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pk</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">pk_field </span><span class="s2">= </span><span class="s1">pk_value </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">only </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">field_dict </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prune_fields</span><span class="s2">(</span><span class="s1">field_dict</span><span class="s2">, </span><span class="s1">only</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">only_save_dirty </span><span class="s0">and not </span><span class="s1">force_insert</span><span class="s2">:</span>
            <span class="s1">field_dict </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_prune_fields</span><span class="s2">(</span><span class="s1">field_dict</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dirty_fields</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">field_dict</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
                <span class="s0">return False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_populate_unsaved_relations</span><span class="s2">(</span><span class="s1">field_dict</span><span class="s2">)</span>
        <span class="s1">rows </span><span class="s2">= </span><span class="s5">1</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">auto_increment </span><span class="s0">and </span><span class="s1">pk_value </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">field_dict</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">pk_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">pk_value </span><span class="s0">is not None and not </span><span class="s1">force_insert</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">composite_key</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">pk_part_name </span><span class="s0">in </span><span class="s1">pk_field</span><span class="s2">.</span><span class="s1">field_names</span><span class="s2">:</span>
                    <span class="s1">field_dict</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">pk_part_name</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">field_dict</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">pk_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">field_dict</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'no data to save!'</span><span class="s2">)</span>
            <span class="s1">rows </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(**</span><span class="s1">field_dict</span><span class="s2">).</span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pk_expr</span><span class="s2">()).</span><span class="s1">execute</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">pk_field </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">pk </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(**</span><span class="s1">field_dict</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">pk </span><span class="s0">is not None and </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">auto_increment </span><span class="s0">or</span>
                                   <span class="s1">pk_value </span><span class="s0">is None</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_pk </span><span class="s2">= </span><span class="s1">pk</span>
                <span class="s4"># Although we set the primary-key, do not mark it as dirty.</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">.</span><span class="s1">discard</span><span class="s2">(</span><span class="s1">pk_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(**</span><span class="s1">field_dict</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_dirty </span><span class="s2">-= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">field_dict</span><span class="s2">)  </span><span class="s4"># Remove any fields we saved.</span>
        <span class="s0">return </span><span class="s1">rows</span>

    <span class="s0">def </span><span class="s1">is_dirty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">dirty_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">f </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_fields </span><span class="s0">if </span><span class="s1">f</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">dependencies</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">search_nullable</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">model_class </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">stack </span><span class="s2">= [(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)]</span>
        <span class="s1">queries </span><span class="s2">= {}</span>
        <span class="s1">seen </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

        <span class="s0">while </span><span class="s1">stack</span><span class="s2">:</span>
            <span class="s1">klass</span><span class="s2">, </span><span class="s1">query </span><span class="s2">= </span><span class="s1">stack</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">klass </span><span class="s0">in </span><span class="s1">seen</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s1">seen</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">fk</span><span class="s2">, </span><span class="s1">rel_model </span><span class="s0">in </span><span class="s1">klass</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">backrefs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">rel_model </span><span class="s0">is </span><span class="s1">model_class </span><span class="s0">or </span><span class="s1">query </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s1">node </span><span class="s2">= (</span><span class="s1">fk </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">fk</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">])</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">node </span><span class="s2">= </span><span class="s1">fk </span><span class="s2">&lt;&lt; </span><span class="s1">query</span>
                <span class="s1">subquery </span><span class="s2">= (</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s1">rel_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">)</span>
                            <span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">node</span><span class="s2">))</span>
                <span class="s0">if not </span><span class="s1">fk</span><span class="s2">.</span><span class="s1">null </span><span class="s0">or </span><span class="s1">search_nullable</span><span class="s2">:</span>
                    <span class="s1">queries</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">rel_model</span><span class="s2">, []).</span><span class="s1">append</span><span class="s2">((</span><span class="s1">node</span><span class="s2">, </span><span class="s1">fk</span><span class="s2">))</span>
                    <span class="s1">stack</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">rel_model</span><span class="s2">, </span><span class="s1">subquery</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">m </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">sort_models</span><span class="s2">(</span><span class="s1">seen</span><span class="s2">)):</span>
            <span class="s0">for </span><span class="s1">sq</span><span class="s2">, </span><span class="s1">q </span><span class="s0">in </span><span class="s1">queries</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, ()):</span>
                <span class="s0">yield </span><span class="s1">sq</span><span class="s2">, </span><span class="s1">q</span>

    <span class="s0">def </span><span class="s1">delete_instance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">recursive</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">delete_nullable</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">recursive</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">query</span><span class="s2">, </span><span class="s1">fk </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dependencies</span><span class="s2">():</span>
                <span class="s1">model </span><span class="s2">= </span><span class="s1">fk</span><span class="s2">.</span><span class="s1">model</span>
                <span class="s0">if </span><span class="s1">fk</span><span class="s2">.</span><span class="s1">null </span><span class="s0">and not </span><span class="s1">delete_nullable</span><span class="s2">:</span>
                    <span class="s1">model</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(**{</span><span class="s1">fk</span><span class="s2">.</span><span class="s1">name</span><span class="s2">: </span><span class="s0">None</span><span class="s2">}).</span><span class="s1">where</span><span class="s2">(</span><span class="s1">query</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">model</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">().</span><span class="s1">where</span><span class="s2">(</span><span class="s1">query</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">).</span><span class="s1">delete</span><span class="s2">().</span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pk_expr</span><span class="s2">()).</span><span class="s1">execute</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pk</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s1">other</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s0">and</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_pk </span><span class="s0">is not None and</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_pk </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_pk</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return not </span><span class="s1">self </span><span class="s2">== </span><span class="s1">other</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s4"># NOTE: when comparing a foreign-key field whose related-field is not a</span>
        <span class="s4"># primary-key, then doing an equality test for the foreign-key with a</span>
        <span class="s4"># model instance will return the wrong value; since we would return</span>
        <span class="s4"># the primary key for a given model instance.</span>
        <span class="s4">#</span>
        <span class="s4"># This checks to see if we have a converter in the scope, and that we</span>
        <span class="s4"># are converting a foreign-key expression. If so, we hand the model</span>
        <span class="s4"># instance to the converter rather than blindly grabbing the primary-</span>
        <span class="s4"># key. In the event the provided converter fails to handle the model</span>
        <span class="s4"># instance, then we will return the primary-key.</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">converter </span><span class="s0">is not None and </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">is_fk_expr</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">converter</span><span class="s2">=</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">state</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">))</span>
            <span class="s0">except </span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s0">pass</span>

        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Value</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
                             <span class="s1">converter</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">.</span><span class="s1">db_value</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">bind</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">bind_refs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">bind_backrefs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">_exclude</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">is_different </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database </span><span class="s0">is not </span><span class="s1">database</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">set_database</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">bind_refs </span><span class="s0">or </span><span class="s1">bind_backrefs</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">_exclude </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">_exclude </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
            <span class="s1">G </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model_graph</span><span class="s2">(</span><span class="s1">refs</span><span class="s2">=</span><span class="s1">bind_refs</span><span class="s2">, </span><span class="s1">backrefs</span><span class="s2">=</span><span class="s1">bind_backrefs</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">is_backref </span><span class="s0">in </span><span class="s1">G</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">model </span><span class="s0">not in </span><span class="s1">_exclude</span><span class="s2">:</span>
                    <span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">set_database</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)</span>
                    <span class="s1">_exclude</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">is_different</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">bind_ctx</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">database</span><span class="s2">, </span><span class="s1">bind_refs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">bind_backrefs</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_BoundModelsContext</span><span class="s2">((</span><span class="s1">cls</span><span class="s2">,), </span><span class="s1">database</span><span class="s2">, </span><span class="s1">bind_refs</span><span class="s2">, </span><span class="s1">bind_backrefs</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">table_exists</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">M </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">table_exists</span><span class="s2">(</span><span class="s1">M</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">M</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">create_table</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s3">'fail_silently' </span><span class="s0">in </span><span class="s1">options</span><span class="s2">:</span>
            <span class="s1">__deprecated__</span><span class="s2">(</span><span class="s3">'&quot;fail_silently&quot; has been deprecated in favor of '</span>
                           <span class="s3">'&quot;safe&quot; for the create_table() method.'</span><span class="s2">)</span>
            <span class="s1">safe </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'fail_silently'</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">safe </span><span class="s0">and not </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">safe_create_index \</span>
           <span class="s0">and </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">table_exists</span><span class="s2">():</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">:</span>
            <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'temporary'</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">.</span><span class="s1">create_all</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">drop_table</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop_sequences</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">safe </span><span class="s0">and not </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">safe_drop_index \</span>
           <span class="s0">and not </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">table_exists</span><span class="s2">():</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">:</span>
            <span class="s1">options</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s3">'temporary'</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">temporary</span><span class="s2">)</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">.</span><span class="s1">drop_all</span><span class="s2">(</span><span class="s1">safe</span><span class="s2">, </span><span class="s1">drop_sequences</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">truncate_table</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">):</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">.</span><span class="s1">truncate_table</span><span class="s2">(**</span><span class="s1">options</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">index</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, *</span><span class="s1">fields</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelIndex</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">add_index</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, *</span><span class="s1">fields</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">fields</span><span class="s2">) == </span><span class="s5">1 </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fields</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], (</span><span class="s1">SQL</span><span class="s2">, </span><span class="s1">Index</span><span class="s2">)):</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">indexes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">fields</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">indexes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ModelIndex</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">ModelAlias</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot;Provide a separate reference to a model in a query.&quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">alias</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'model'</span><span class="s2">] = </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s3">'alias'</span><span class="s2">] = </span><span class="s1">alias</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s4"># Hack to work-around the fact that properties or other objects</span>
        <span class="s4"># implementing the descriptor protocol (on the model being aliased),</span>
        <span class="s4"># will not work correctly when we use getattr(). So we explicitly pass</span>
        <span class="s4"># the model alias to the descriptor's getter.</span>
        <span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">,) + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">__bases__</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">obj </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">ModelDescriptor</span><span class="s2">):</span>
                    <span class="s0">return </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__get__</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
                <span class="s0">continue</span>

        <span class="s1">model_attr </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">model_attr</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">] = </span><span class="s1">FieldAlias</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model_attr</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">model_attr</span>

    <span class="s0">def </span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'Cannot set attributes on model aliases.'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_field_aliases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_field_names</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">select</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">selection</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">selection</span><span class="s2">:</span>
            <span class="s1">selection </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_field_aliases</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">ModelSelect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">selection</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_VALUES</span><span class="s2">:</span>
            <span class="s4"># Return the quoted table name.</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">alias</span><span class="s2">:</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">alias</span>

        <span class="s0">if </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">== </span><span class="s1">SCOPE_SOURCE</span><span class="s2">:</span>
            <span class="s4"># Define the table and its alias.</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">ctx</span>
                    <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">entity</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">literal</span><span class="s2">(</span><span class="s3">' AS '</span><span class="s2">)</span>
                    <span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">])))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># Refer to the table using the alias.</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Entity</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">self</span><span class="s2">]))</span>


<span class="s0">class </span><span class="s1">FieldAlias</span><span class="s2">(</span><span class="s1">Field</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">source </span><span class="s2">= </span><span class="s1">source</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">source</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">field </span><span class="s2">= </span><span class="s1">field</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">create</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">source</span><span class="s2">, </span><span class="s1">field</span><span class="s2">):</span>
        <span class="s0">class </span><span class="s1">_FieldAlias</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">type</span><span class="s2">(</span><span class="s1">field</span><span class="s2">)):</span>
            <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">_FieldAlias</span><span class="s2">(</span><span class="s1">source</span><span class="s2">, </span><span class="s1">field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">FieldAlias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">): </span><span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">adapt</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">): </span><span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">): </span><span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">db_value</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">source </span><span class="s0">if </span><span class="s1">attr </span><span class="s2">== </span><span class="s3">'model' </span><span class="s0">else </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">Column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">source</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">sort_models</span><span class="s2">(</span><span class="s1">models</span><span class="s2">):</span>
    <span class="s1">models </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">models</span><span class="s2">)</span>
    <span class="s1">seen </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s1">ordering </span><span class="s2">= []</span>
    <span class="s0">def </span><span class="s1">dfs</span><span class="s2">(</span><span class="s1">model</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">model </span><span class="s0">in </span><span class="s1">models </span><span class="s0">and </span><span class="s1">model </span><span class="s0">not in </span><span class="s1">seen</span><span class="s2">:</span>
            <span class="s1">seen</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">foreign_key</span><span class="s2">, </span><span class="s1">rel_model </span><span class="s0">in </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">refs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s4"># Do not depth-first search deferred foreign-keys as this can</span>
                <span class="s4"># cause tables to be created in the incorrect order.</span>
                <span class="s0">if not </span><span class="s1">foreign_key</span><span class="s2">.</span><span class="s1">deferred</span><span class="s2">:</span>
                    <span class="s1">dfs</span><span class="s2">(</span><span class="s1">rel_model</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">depends_on</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">dependency </span><span class="s0">in </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">depends_on</span><span class="s2">:</span>
                    <span class="s1">dfs</span><span class="s2">(</span><span class="s1">dependency</span><span class="s2">)</span>
            <span class="s1">ordering</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>

    <span class="s1">names </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">m</span><span class="s2">: (</span><span class="s1">m</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table_name</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">m </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">models</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s1">names</span><span class="s2">):</span>
        <span class="s1">dfs</span><span class="s2">(</span><span class="s1">m</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ordering</span>


<span class="s0">class </span><span class="s1">_ModelQueryHelper</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">default_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">MODEL</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">_ModelQueryHelper</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_database</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_database </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">objects</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">constructor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">CONSTRUCTOR</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s0">if </span><span class="s1">constructor </span><span class="s0">is None else </span><span class="s1">constructor</span>

    <span class="s0">def </span><span class="s1">_get_cursor_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s1">row_type </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">default_row_type</span>
        <span class="s0">if </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">MODEL</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_model_cursor_wrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">DICT</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ModelDictCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">TUPLE</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ModelTupleCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">NAMED_TUPLE</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ModelNamedTupleCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">,</span>
                                                <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">row_type </span><span class="s2">== </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">CONSTRUCTOR</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ModelObjectCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">,</span>
                                            <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_constructor</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Unrecognized row type: &quot;%s&quot;.' </span><span class="s2">% </span><span class="s1">row_type</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_model_cursor_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelObjectCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, [], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ModelRaw</span><span class="s2">(</span><span class="s1">_ModelQueryHelper</span><span class="s2">, </span><span class="s1">RawQuery</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= ()</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ModelRaw</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">=</span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s1">params</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s1">sql</span><span class="s2">, </span><span class="s1">params </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">()</span>
            <span class="s0">raise </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">DoesNotExist</span><span class="s2">(</span><span class="s3">'%s instance matching query does '</span>
                                          <span class="s3">'not exist:</span><span class="s0">\n</span><span class="s3">SQL: %s</span><span class="s0">\n</span><span class="s3">Params: %s' </span><span class="s2">%</span>
                                          <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">BaseModelSelect</span><span class="s2">(</span><span class="s1">_ModelQueryHelper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">union_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelCompoundSelectQuery</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s3">'UNION ALL'</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s1">__add__ </span><span class="s2">= </span><span class="s1">union_all</span>

    <span class="s0">def </span><span class="s1">union</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelCompoundSelectQuery</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s3">'UNION'</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s1">__or__ </span><span class="s2">= </span><span class="s1">union</span>

    <span class="s0">def </span><span class="s1">intersect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelCompoundSelectQuery</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s3">'INTERSECT'</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s1">__and__ </span><span class="s2">= </span><span class="s1">intersect</span>

    <span class="s0">def </span><span class="s1">except_</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ModelCompoundSelectQuery</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s3">'EXCEPT'</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s1">__sub__ </span><span class="s2">= </span><span class="s1">except_</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cursor_wrapper</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">prefetch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">subqueries</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">prefetch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">subqueries</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">clone </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">paginate</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">clone</span><span class="s2">.</span><span class="s1">_cursor_wrapper </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">database</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
            <span class="s1">sql</span><span class="s2">, </span><span class="s1">params </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">()</span>
            <span class="s0">raise </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">DoesNotExist</span><span class="s2">(</span><span class="s3">'%s instance matching query does '</span>
                                          <span class="s3">'not exist:</span><span class="s0">\n</span><span class="s3">SQL: %s</span><span class="s0">\n</span><span class="s3">Params: %s' </span><span class="s2">%</span>
                                          <span class="s2">(</span><span class="s1">clone</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">sql</span><span class="s2">, </span><span class="s1">params</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">get_or_none</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">database</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">database</span><span class="s2">=</span><span class="s1">database</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">DoesNotExist</span><span class="s2">:</span>
            <span class="s0">pass</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">group_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s1">grouping </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">column </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">column</span><span class="s2">):</span>
                <span class="s1">grouping</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">column</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">Table</span><span class="s2">):</span>
                <span class="s0">if not </span><span class="s1">column</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot pass a table to group_by() that '</span>
                                     <span class="s3">'does not have columns explicitly '</span>
                                     <span class="s3">'declared.'</span><span class="s2">)</span>
                <span class="s1">grouping</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">column</span><span class="s2">, </span><span class="s1">col_name</span><span class="s2">)</span>
                                 <span class="s0">for </span><span class="s1">col_name </span><span class="s0">in </span><span class="s1">column</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">grouping</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_group_by </span><span class="s2">= </span><span class="s1">grouping</span>


<span class="s0">class </span><span class="s1">ModelCompoundSelectQuery</span><span class="s2">(</span><span class="s1">BaseModelSelect</span><span class="s2">, </span><span class="s1">CompoundSelectQuery</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ModelCompoundSelectQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_model_cursor_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">_get_model_cursor_wrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_normalize_model_select</span><span class="s2">(</span><span class="s1">fields_or_models</span><span class="s2">):</span>
    <span class="s1">fields </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">fm </span><span class="s0">in </span><span class="s1">fields_or_models</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">):</span>
            <span class="s1">fields</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">, </span><span class="s1">ModelAlias</span><span class="s2">):</span>
            <span class="s1">fields</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">get_field_aliases</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">, </span><span class="s1">Table</span><span class="s2">) </span><span class="s0">and </span><span class="s1">fm</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">:</span>
            <span class="s1">fields</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">, </span><span class="s1">col</span><span class="s2">) </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">fm</span><span class="s2">.</span><span class="s1">_columns</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">fields</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">fields</span>


<span class="s0">class </span><span class="s1">ModelSelect</span><span class="s2">(</span><span class="s1">BaseModelSelect</span><span class="s2">, </span><span class="s1">Select</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">fields_or_models</span><span class="s2">, </span><span class="s1">is_default</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_join_ctx </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_joins </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_default </span><span class="s2">= </span><span class="s1">is_default</span>
        <span class="s1">fields </span><span class="s2">= </span><span class="s1">_normalize_model_select</span><span class="s2">(</span><span class="s1">fields_or_models</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ModelSelect</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">([</span><span class="s1">model</span><span class="s2">], </span><span class="s1">fields</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">clone </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ModelSelect</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">clone</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">clone</span><span class="s2">.</span><span class="s1">_joins</span><span class="s2">:</span>
            <span class="s1">clone</span><span class="s2">.</span><span class="s1">_joins </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">clone</span><span class="s2">.</span><span class="s1">_joins</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">clone</span>

    <span class="s0">def </span><span class="s1">select</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">fields_or_models</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">fields_or_models </span><span class="s0">or not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_default</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_default </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">fields </span><span class="s2">= </span><span class="s1">_normalize_model_select</span><span class="s2">(</span><span class="s1">fields_or_models</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ModelSelect</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">select</span><span class="s2">(*</span><span class="s1">fields</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">select_extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_default </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">fields </span><span class="s2">= </span><span class="s1">_normalize_model_select</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ModelSelect</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">select_extend</span><span class="s2">(*</span><span class="s1">fields</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">switch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_join_ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s0">if </span><span class="s1">ctx </span><span class="s0">is None else </span><span class="s1">ctx</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">_get_model</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">src</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">src</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">src</span><span class="s2">, </span><span class="s0">True</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">Table</span><span class="s2">) </span><span class="s0">and </span><span class="s1">src</span><span class="s2">.</span><span class="s1">_model</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">src</span><span class="s2">.</span><span class="s1">_model</span><span class="s2">, </span><span class="s0">False</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">ModelAlias</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">src</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s0">False</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">ModelSelect</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">src</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s0">False</span>
        <span class="s0">return None</span><span class="s2">, </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">_normalize_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">src</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">on</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">):</span>
        <span class="s4"># Allow &quot;on&quot; expression to have an alias that determines the</span>
        <span class="s4"># destination attribute for the joined data.</span>
        <span class="s1">on_alias </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">on</span><span class="s2">, </span><span class="s1">Alias</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">on_alias</span><span class="s2">:</span>
            <span class="s1">attr </span><span class="s2">= </span><span class="s1">attr </span><span class="s0">or </span><span class="s1">on</span><span class="s2">.</span><span class="s1">_alias</span>
            <span class="s1">on </span><span class="s2">= </span><span class="s1">on</span><span class="s2">.</span><span class="s1">alias</span><span class="s2">()</span>

        <span class="s4"># Obtain references to the source and destination models being joined.</span>
        <span class="s1">src_model</span><span class="s2">, </span><span class="s1">src_is_model </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_model</span><span class="s2">(</span><span class="s1">src</span><span class="s2">)</span>
        <span class="s1">dest_model</span><span class="s2">, </span><span class="s1">dest_is_model </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_model</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">src_model </span><span class="s0">and </span><span class="s1">dest_model</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_join_ctx </span><span class="s2">= </span><span class="s1">dest</span>
            <span class="s1">constructor </span><span class="s2">= </span><span class="s1">dest_model</span>

            <span class="s4"># In the case where the &quot;on&quot; clause is a Column or Field, we will</span>
            <span class="s4"># convert that field into the appropriate predicate expression.</span>
            <span class="s0">if not </span><span class="s2">(</span><span class="s1">src_is_model </span><span class="s0">and </span><span class="s1">dest_is_model</span><span class="s2">) </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">on</span><span class="s2">, </span><span class="s1">Column</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">on</span><span class="s2">.</span><span class="s1">source </span><span class="s0">is </span><span class="s1">src</span><span class="s2">:</span>
                    <span class="s1">to_field </span><span class="s2">= </span><span class="s1">src_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">on</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                <span class="s0">elif </span><span class="s1">on</span><span class="s2">.</span><span class="s1">source </span><span class="s0">is </span><span class="s1">dest</span><span class="s2">:</span>
                    <span class="s1">to_field </span><span class="s2">= </span><span class="s1">dest_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">on</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'&quot;on&quot; clause Column %s does not '</span>
                                         <span class="s3">'belong to %s or %s.' </span><span class="s2">%</span>
                                         <span class="s2">(</span><span class="s1">on</span><span class="s2">, </span><span class="s1">src_model</span><span class="s2">, </span><span class="s1">dest_model</span><span class="s2">))</span>
                <span class="s1">on </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">on</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                <span class="s1">to_field </span><span class="s2">= </span><span class="s1">on</span>
                <span class="s1">on </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">to_field </span><span class="s2">= </span><span class="s0">None</span>

            <span class="s1">fk_field</span><span class="s2">, </span><span class="s1">is_backref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_generate_on_clause</span><span class="s2">(</span>
                <span class="s1">src_model</span><span class="s2">, </span><span class="s1">dest_model</span><span class="s2">, </span><span class="s1">to_field</span><span class="s2">, </span><span class="s1">on</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">on </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">src_attr </span><span class="s2">= </span><span class="s3">'name' </span><span class="s0">if </span><span class="s1">src_is_model </span><span class="s0">else </span><span class="s3">'column_name'</span>
                <span class="s1">dest_attr </span><span class="s2">= </span><span class="s3">'name' </span><span class="s0">if </span><span class="s1">dest_is_model </span><span class="s0">else </span><span class="s3">'column_name'</span>
                <span class="s0">if </span><span class="s1">is_backref</span><span class="s2">:</span>
                    <span class="s1">lhs </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">fk_field</span><span class="s2">, </span><span class="s1">dest_attr</span><span class="s2">))</span>
                    <span class="s1">rhs </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">fk_field</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">src_attr</span><span class="s2">))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">lhs </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">fk_field</span><span class="s2">, </span><span class="s1">src_attr</span><span class="s2">))</span>
                    <span class="s1">rhs </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">fk_field</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">dest_attr</span><span class="s2">))</span>
                <span class="s1">on </span><span class="s2">= (</span><span class="s1">lhs </span><span class="s2">== </span><span class="s1">rhs</span><span class="s2">)</span>

            <span class="s0">if not </span><span class="s1">attr</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">fk_field </span><span class="s0">is not None and not </span><span class="s1">is_backref</span><span class="s2">:</span>
                    <span class="s1">attr </span><span class="s2">= </span><span class="s1">fk_field</span><span class="s2">.</span><span class="s1">name</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">attr </span><span class="s2">= </span><span class="s1">dest_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s0">elif </span><span class="s1">on_alias </span><span class="s0">and </span><span class="s1">fk_field </span><span class="s0">is not None and </span><span class="s1">\</span>
                    <span class="s1">attr </span><span class="s2">== </span><span class="s1">fk_field</span><span class="s2">.</span><span class="s1">object_id_name </span><span class="s0">and not </span><span class="s1">is_backref</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot assign join alias to &quot;%s&quot;, as this '</span>
                                 <span class="s3">'attribute is the object_id_name for the '</span>
                                 <span class="s3">'foreign-key field &quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">attr</span><span class="s2">, </span><span class="s1">fk_field</span><span class="s2">))</span>

        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">Source</span><span class="s2">):</span>
            <span class="s1">constructor </span><span class="s2">= </span><span class="s1">dict</span>
            <span class="s1">attr </span><span class="s2">= </span><span class="s1">attr </span><span class="s0">or </span><span class="s1">dest</span><span class="s2">.</span><span class="s1">_alias</span>
            <span class="s0">if not </span><span class="s1">attr </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">Table</span><span class="s2">):</span>
                <span class="s1">attr </span><span class="s2">= </span><span class="s1">attr </span><span class="s0">or </span><span class="s1">dest</span><span class="s2">.</span><span class="s1">__name__</span>

        <span class="s0">return </span><span class="s2">(</span><span class="s1">on</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">constructor</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_generate_on_clause</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">src</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">to_field</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">meta </span><span class="s2">= </span><span class="s1">src</span><span class="s2">.</span><span class="s1">_meta</span>
        <span class="s1">is_backref </span><span class="s2">= </span><span class="s1">fk_fields </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s4"># Get all the foreign keys between source and dest, and determine if</span>
        <span class="s4"># the join is via a back-reference.</span>
        <span class="s0">if </span><span class="s1">dest </span><span class="s0">in </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">model_refs</span><span class="s2">:</span>
            <span class="s1">fk_fields </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">model_refs</span><span class="s2">[</span><span class="s1">dest</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">dest </span><span class="s0">in </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">model_backrefs</span><span class="s2">:</span>
            <span class="s1">fk_fields </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">model_backrefs</span><span class="s2">[</span><span class="s1">dest</span><span class="s2">]</span>
            <span class="s1">is_backref </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s0">if not </span><span class="s1">fk_fields</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">on </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">return None</span><span class="s2">, </span><span class="s0">False</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Unable to find foreign key between %s and %s. '</span>
                             <span class="s3">'Please specify an explicit join condition.' </span><span class="s2">%</span>
                             <span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">to_field </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s4"># If the foreign-key field was specified explicitly, remove all</span>
            <span class="s4"># other foreign-key fields from the list.</span>
            <span class="s1">target </span><span class="s2">= (</span><span class="s1">to_field</span><span class="s2">.</span><span class="s1">field </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">to_field</span><span class="s2">, </span><span class="s1">FieldAlias</span><span class="s2">)</span>
                      <span class="s0">else </span><span class="s1">to_field</span><span class="s2">)</span>
            <span class="s1">fk_fields </span><span class="s2">= [</span><span class="s1">f </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">fk_fields </span><span class="s0">if </span><span class="s2">(</span>
                         <span class="s2">(</span><span class="s1">f </span><span class="s0">is </span><span class="s1">target</span><span class="s2">) </span><span class="s0">or</span>
                         <span class="s2">(</span><span class="s1">is_backref </span><span class="s0">and </span><span class="s1">f</span><span class="s2">.</span><span class="s1">rel_field </span><span class="s0">is </span><span class="s1">to_field</span><span class="s2">))]</span>

        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">fk_fields</span><span class="s2">) == </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">fk_fields</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">is_backref</span>

        <span class="s0">if </span><span class="s1">on </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s4"># If multiple foreign-keys exist, try using the FK whose name</span>
            <span class="s4"># matches that of the related model. If not, raise an error as this</span>
            <span class="s4"># is ambiguous.</span>
            <span class="s0">for </span><span class="s1">fk </span><span class="s0">in </span><span class="s1">fk_fields</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">fk</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">dest</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">name</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">fk</span><span class="s2">, </span><span class="s1">is_backref</span>

            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'More than one foreign key between %s and %s.'</span>
                             <span class="s3">' Please specify which you are joining on.' </span><span class="s2">%</span>
                             <span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">))</span>

        <span class="s4"># If there are multiple foreign-keys to choose from and the join</span>
        <span class="s4"># predicate is an expression, we'll try to figure out which</span>
        <span class="s4"># foreign-key field we're joining on so that we can assign to the</span>
        <span class="s4"># correct attribute when resolving the model graph.</span>
        <span class="s1">to_field </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">on</span><span class="s2">, </span><span class="s1">Expression</span><span class="s2">):</span>
            <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs </span><span class="s2">= </span><span class="s1">on</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">on</span><span class="s2">.</span><span class="s1">rhs</span>
            <span class="s4"># Coerce to set() so that we force Python to compare using the</span>
            <span class="s4"># object's hash rather than equality test, which returns a</span>
            <span class="s4"># false-positive due to overriding __eq__.</span>
            <span class="s1">fk_set </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">fk_fields</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                <span class="s1">lhs_f </span><span class="s2">= </span><span class="s1">lhs</span><span class="s2">.</span><span class="s1">field </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">FieldAlias</span><span class="s2">) </span><span class="s0">else </span><span class="s1">lhs</span>
                <span class="s0">if </span><span class="s1">lhs_f </span><span class="s0">in </span><span class="s1">fk_set</span><span class="s2">:</span>
                    <span class="s1">to_field </span><span class="s2">= </span><span class="s1">lhs_f</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                <span class="s1">rhs_f </span><span class="s2">= </span><span class="s1">rhs</span><span class="s2">.</span><span class="s1">field </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">FieldAlias</span><span class="s2">) </span><span class="s0">else </span><span class="s1">rhs</span>
                <span class="s0">if </span><span class="s1">rhs_f </span><span class="s0">in </span><span class="s1">fk_set</span><span class="s2">:</span>
                    <span class="s1">to_field </span><span class="s2">= </span><span class="s1">rhs_f</span>

        <span class="s0">return </span><span class="s1">to_field</span><span class="s2">, </span><span class="s0">False</span>

    <span class="s2">@</span><span class="s1">Node</span><span class="s2">.</span><span class="s1">copy</span>
    <span class="s0">def </span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">=</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">INNER</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">src</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">src </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_join_ctx </span><span class="s0">if </span><span class="s1">src </span><span class="s0">is None else </span><span class="s1">src</span>

        <span class="s0">if </span><span class="s1">join_type </span><span class="s2">== </span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">LATERAL </span><span class="s0">or </span><span class="s1">join_type </span><span class="s2">== </span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">LEFT_LATERAL</span><span class="s2">:</span>
            <span class="s1">on </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">elif </span><span class="s1">join_type </span><span class="s2">!= </span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">CROSS</span><span class="s2">:</span>
            <span class="s1">on</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">constructor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_normalize_join</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">on</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">attr</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_joins</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, [])</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_joins</span><span class="s2">[</span><span class="s1">src</span><span class="s2">].</span><span class="s1">append</span><span class="s2">((</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">constructor</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">on </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Cannot specify on clause with cross join.'</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'No sources to join on.'</span><span class="s2">)</span>

        <span class="s1">item </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">Join</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">, </span><span class="s1">on</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">left_outer_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">src</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">LEFT_OUTER</span><span class="s2">, </span><span class="s1">on</span><span class="s2">, </span><span class="s1">src</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">join_from</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">src</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">=</span><span class="s1">JOIN</span><span class="s2">.</span><span class="s1">INNER</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">, </span><span class="s1">on</span><span class="s2">, </span><span class="s1">src</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_model_cursor_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">) == </span><span class="s5">1 </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joins</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ModelObjectCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">,</span>
                                            <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ModelCursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">,</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">_from_list</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joins</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">ensure_join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">lm</span><span class="s2">, </span><span class="s1">rm</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">join_kwargs</span><span class="s2">):</span>
        <span class="s1">join_ctx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_join_ctx</span>
        <span class="s0">for </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">constructor</span><span class="s2">, </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joins</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">lm</span><span class="s2">, []):</span>
            <span class="s0">if </span><span class="s1">dest </span><span class="s2">== </span><span class="s1">rm</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">self</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">switch</span><span class="s2">(</span><span class="s1">lm</span><span class="s2">).</span><span class="s1">join</span><span class="s2">(</span><span class="s1">rm</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s1">on</span><span class="s2">, **</span><span class="s1">join_kwargs</span><span class="s2">).</span><span class="s1">switch</span><span class="s2">(</span><span class="s1">join_ctx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">convert_dict_to_node</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">qdict</span><span class="s2">):</span>
        <span class="s1">accum </span><span class="s2">= []</span>
        <span class="s1">joins </span><span class="s2">= []</span>
        <span class="s1">fks </span><span class="s2">= (</span><span class="s1">ForeignKeyField</span><span class="s2">, </span><span class="s1">BackrefAccessor</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">qdict</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">curr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span>
            <span class="s0">if </span><span class="s3">'__' </span><span class="s0">in </span><span class="s1">key </span><span class="s0">and </span><span class="s1">key</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'__'</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">in </span><span class="s1">DJANGO_MAP</span><span class="s2">:</span>
                <span class="s1">key</span><span class="s2">, </span><span class="s1">op </span><span class="s2">= </span><span class="s1">key</span><span class="s2">.</span><span class="s1">rsplit</span><span class="s2">(</span><span class="s3">'__'</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
                <span class="s1">op </span><span class="s2">= </span><span class="s1">DJANGO_MAP</span><span class="s2">[</span><span class="s1">op</span><span class="s2">]</span>
            <span class="s0">elif </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">op </span><span class="s2">= </span><span class="s1">DJANGO_MAP</span><span class="s2">[</span><span class="s3">'is'</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">op </span><span class="s2">= </span><span class="s1">DJANGO_MAP</span><span class="s2">[</span><span class="s3">'eq'</span><span class="s2">]</span>

            <span class="s0">if </span><span class="s3">'__' </span><span class="s0">not in </span><span class="s1">key</span><span class="s2">:</span>
                <span class="s4"># Handle simplest case. This avoids joining over-eagerly when a</span>
                <span class="s4"># direct FK lookup is all that is required.</span>
                <span class="s1">model_attr </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">piece </span><span class="s0">in </span><span class="s1">key</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'__'</span><span class="s2">):</span>
                    <span class="s0">for </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_joins</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">, ()):</span>
                        <span class="s0">try</span><span class="s2">: </span><span class="s1">model_attr </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">, </span><span class="s1">piece</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                        <span class="s0">except</span><span class="s2">: </span><span class="s0">pass</span>
                        <span class="s0">if </span><span class="s1">attr </span><span class="s2">== </span><span class="s1">piece </span><span class="s0">or </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">ModelAlias</span><span class="s2">) </span><span class="s0">and</span>
                                             <span class="s1">dest</span><span class="s2">.</span><span class="s1">alias </span><span class="s2">== </span><span class="s1">piece</span><span class="s2">):</span>
                            <span class="s1">curr </span><span class="s2">= </span><span class="s1">dest</span>
                            <span class="s0">break</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">model_attr </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">, </span><span class="s1">piece</span><span class="s2">)</span>
                        <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">model_attr</span><span class="s2">, </span><span class="s1">fks</span><span class="s2">):</span>
                            <span class="s1">curr </span><span class="s2">= </span><span class="s1">model_attr</span><span class="s2">.</span><span class="s1">rel_model</span>
                            <span class="s1">joins</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">model_attr</span><span class="s2">)</span>
            <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">op</span><span class="s2">(</span><span class="s1">model_attr</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">accum</span><span class="s2">, </span><span class="s1">joins</span>

    <span class="s0">def </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s4"># normalize args and kwargs into a new expression</span>
        <span class="s0">if </span><span class="s1">args </span><span class="s0">and </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">dq_node </span><span class="s2">= (</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">() </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">args</span><span class="s2">]) &amp;</span>
                       <span class="s1">DQ</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">args</span><span class="s2">:</span>
            <span class="s1">dq_node </span><span class="s2">= (</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">() </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">args</span><span class="s2">]) &amp;</span>
                       <span class="s1">ColumnBase</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">dq_node </span><span class="s2">= </span><span class="s1">DQ</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">) &amp; </span><span class="s1">ColumnBase</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">()</span>

        <span class="s4"># dq_node should now be an Expression, lhs = Node(), rhs = ...</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">deque</span><span class="s2">([</span><span class="s1">dq_node</span><span class="s2">])</span>
        <span class="s1">dq_joins </span><span class="s2">= []</span>
        <span class="s1">seen_joins </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s0">while </span><span class="s1">q</span><span class="s2">:</span>
            <span class="s1">curr </span><span class="s2">= </span><span class="s1">q</span><span class="s2">.</span><span class="s1">popleft</span><span class="s2">()</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">, </span><span class="s1">Expression</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s0">for </span><span class="s1">side</span><span class="s2">, </span><span class="s1">piece </span><span class="s0">in </span><span class="s2">((</span><span class="s3">'lhs'</span><span class="s2">, </span><span class="s1">curr</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">), (</span><span class="s3">'rhs'</span><span class="s2">, </span><span class="s1">curr</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">piece</span><span class="s2">, </span><span class="s1">DQ</span><span class="s2">):</span>
                    <span class="s1">query</span><span class="s2">, </span><span class="s1">joins </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">convert_dict_to_node</span><span class="s2">(</span><span class="s1">piece</span><span class="s2">.</span><span class="s1">query</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">join </span><span class="s0">in </span><span class="s1">joins</span><span class="s2">:</span>
                        <span class="s0">if </span><span class="s1">join </span><span class="s0">not in </span><span class="s1">seen_joins</span><span class="s2">:</span>
                            <span class="s1">dq_joins</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">join</span><span class="s2">)</span>
                            <span class="s1">seen_joins</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">join</span><span class="s2">)</span>
                    <span class="s1">expression </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">and_</span><span class="s2">, </span><span class="s1">query</span><span class="s2">)</span>
                    <span class="s4"># Apply values from the DQ object.</span>
                    <span class="s0">if </span><span class="s1">piece</span><span class="s2">.</span><span class="s1">_negated</span><span class="s2">:</span>
                        <span class="s1">expression </span><span class="s2">= </span><span class="s1">Negated</span><span class="s2">(</span><span class="s1">expression</span><span class="s2">)</span>
                    <span class="s4">#expression._alias = piece._alias</span>
                    <span class="s1">setattr</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">, </span><span class="s1">side</span><span class="s2">, </span><span class="s1">expression</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">q</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">piece</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">args </span><span class="s0">or not </span><span class="s1">kwargs</span><span class="s2">:</span>
            <span class="s1">dq_node </span><span class="s2">= </span><span class="s1">dq_node</span><span class="s2">.</span><span class="s1">lhs</span>

        <span class="s1">query </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">clone</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">dq_joins</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">ForeignKeyField</span><span class="s2">):</span>
                <span class="s1">lm</span><span class="s2">, </span><span class="s1">rm </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model</span>
                <span class="s1">field_obj </span><span class="s2">= </span><span class="s1">field</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">BackrefAccessor</span><span class="s2">):</span>
                <span class="s1">lm</span><span class="s2">, </span><span class="s1">rm </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model</span>
                <span class="s1">field_obj </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">field</span>
            <span class="s1">query </span><span class="s2">= </span><span class="s1">query</span><span class="s2">.</span><span class="s1">ensure_join</span><span class="s2">(</span><span class="s1">lm</span><span class="s2">, </span><span class="s1">rm</span><span class="s2">, </span><span class="s1">field_obj</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">query</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">dq_node</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">create_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">meta</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_schema</span><span class="s2">.</span><span class="s1">create_table_as</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">, </span><span class="s1">safe</span><span class="s2">, **</span><span class="s1">meta</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__sql_selection__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">is_subquery</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_default </span><span class="s0">and </span><span class="s1">is_subquery </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">) &gt; </span><span class="s5">1 </span><span class="s0">and </span><span class="s1">\</span>
           <span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key </span><span class="s0">is not False</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">primary_key</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">ctx</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">(</span><span class="s1">CommaNodeList</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">NoopModelSelect</span><span class="s2">(</span><span class="s1">ModelSelect</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__sql__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">get_noop_select</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_cursor_wrapper</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">CursorWrapper</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_ModelWriteQueryHelper</span><span class="s2">(</span><span class="s1">_ModelQueryHelper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">_ModelWriteQueryHelper</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">model</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">returning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">returning</span><span class="s2">):</span>
        <span class="s1">accum </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">returning</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">item</span><span class="s2">):</span>
                <span class="s1">accum</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">item</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_fields</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">_ModelWriteQueryHelper</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">returning</span><span class="s2">(*</span><span class="s1">accum</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_set_table_alias</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ctx</span><span class="s2">):</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">alias_manager</span><span class="s2">[</span><span class="s1">table</span><span class="s2">] = </span><span class="s1">table</span><span class="s2">.</span><span class="s1">__name__</span>


<span class="s0">class </span><span class="s1">ModelUpdate</span><span class="s2">(</span><span class="s1">_ModelWriteQueryHelper</span><span class="s2">, </span><span class="s1">Update</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">ModelInsert</span><span class="s2">(</span><span class="s1">_ModelWriteQueryHelper</span><span class="s2">, </span><span class="s1">Insert</span><span class="s2">):</span>
    <span class="s1">default_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">TUPLE</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ModelInsert</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s0">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">database</span><span class="s2">.</span><span class="s1">returning_clause</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_returning </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">get_primary_keys</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">returning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">returning</span><span class="s2">):</span>
        <span class="s4"># By default ModelInsert will yield a `tuple` containing the</span>
        <span class="s4"># primary-key of the newly inserted row. But if we are explicitly</span>
        <span class="s4"># specifying a returning clause and have not set a row type, we will</span>
        <span class="s4"># default to returning model instances instead.</span>
        <span class="s0">if </span><span class="s1">returning </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_row_type </span><span class="s2">= </span><span class="s1">ROW</span><span class="s2">.</span><span class="s1">MODEL</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ModelInsert</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">returning</span><span class="s2">(*</span><span class="s1">returning</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_default_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">defaults</span>

    <span class="s0">def </span><span class="s1">get_default_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">fields </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">sorted_fields</span>
        <span class="s0">return </span><span class="s1">fields</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:] </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">auto_increment </span><span class="s0">else </span><span class="s1">fields</span>


<span class="s0">class </span><span class="s1">ModelDelete</span><span class="s2">(</span><span class="s1">_ModelWriteQueryHelper</span><span class="s2">, </span><span class="s1">Delete</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">ManyToManyQuery</span><span class="s2">(</span><span class="s1">ModelSelect</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">accessor</span><span class="s2">, </span><span class="s1">rel</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_instance </span><span class="s2">= </span><span class="s1">instance</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor </span><span class="s2">= </span><span class="s1">accessor</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_src_attr </span><span class="s2">= </span><span class="s1">accessor</span><span class="s2">.</span><span class="s1">src_fk</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_dest_attr </span><span class="s2">= </span><span class="s1">accessor</span><span class="s2">.</span><span class="s1">dest_fk</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ManyToManyQuery</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">rel</span><span class="s2">, (</span><span class="s1">rel</span><span class="s2">,), *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_id_list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">model_or_id_list</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">model_or_id_list</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">Model</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">[</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dest_attr</span><span class="s2">) </span><span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">model_or_id_list</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">model_or_id_list</span>

    <span class="s0">def </span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">clear_existing</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">clear_existing</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s1">accessor </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span>
        <span class="s1">src_id </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_src_attr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">SelectQuery</span><span class="s2">):</span>
            <span class="s1">query </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">(</span>
                <span class="s1">Value</span><span class="s2">(</span><span class="s1">src_id</span><span class="s2">),</span>
                <span class="s1">accessor</span><span class="s2">.</span><span class="s1">dest_fk</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">)</span>
            <span class="s1">accessor</span><span class="s2">.</span><span class="s1">through_model</span><span class="s2">.</span><span class="s1">insert_from</span><span class="s2">(</span>
                <span class="s1">fields</span><span class="s2">=[</span><span class="s1">accessor</span><span class="s2">.</span><span class="s1">src_fk</span><span class="s2">, </span><span class="s1">accessor</span><span class="s2">.</span><span class="s1">dest_fk</span><span class="s2">],</span>
                <span class="s1">query</span><span class="s2">=</span><span class="s1">query</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">value</span><span class="s2">: </span><span class="s0">return</span>

            <span class="s1">inserts </span><span class="s2">= [{</span>
                <span class="s1">accessor</span><span class="s2">.</span><span class="s1">src_fk</span><span class="s2">.</span><span class="s1">name</span><span class="s2">: </span><span class="s1">src_id</span><span class="s2">,</span>
                <span class="s1">accessor</span><span class="s2">.</span><span class="s1">dest_fk</span><span class="s2">.</span><span class="s1">name</span><span class="s2">: </span><span class="s1">rel_id</span><span class="s2">}</span>
                <span class="s0">for </span><span class="s1">rel_id </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_list</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)]</span>
            <span class="s1">accessor</span><span class="s2">.</span><span class="s1">through_model</span><span class="s2">.</span><span class="s1">insert_many</span><span class="s2">(</span><span class="s1">inserts</span><span class="s2">).</span><span class="s1">execute</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s1">src_id </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_src_attr</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">SelectQuery</span><span class="s2">):</span>
            <span class="s1">column </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">model</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dest_attr</span><span class="s2">)</span>
            <span class="s1">subquery </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span><span class="s2">.</span><span class="s1">through_model</span>
                    <span class="s2">.</span><span class="s1">delete</span><span class="s2">()</span>
                    <span class="s2">.</span><span class="s1">where</span><span class="s2">(</span>
                        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span><span class="s2">.</span><span class="s1">dest_fk </span><span class="s2">&lt;&lt; </span><span class="s1">subquery</span><span class="s2">) &amp;</span>
                        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span><span class="s2">.</span><span class="s1">src_fk </span><span class="s2">== </span><span class="s1">src_id</span><span class="s2">))</span>
                    <span class="s2">.</span><span class="s1">execute</span><span class="s2">())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">ensure_tuple</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">value</span><span class="s2">:</span>
                <span class="s0">return</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span><span class="s2">.</span><span class="s1">through_model</span>
                    <span class="s2">.</span><span class="s1">delete</span><span class="s2">()</span>
                    <span class="s2">.</span><span class="s1">where</span><span class="s2">(</span>
                        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span><span class="s2">.</span><span class="s1">dest_fk </span><span class="s2">&lt;&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_id_list</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)) &amp;</span>
                        <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span><span class="s2">.</span><span class="s1">src_fk </span><span class="s2">== </span><span class="s1">src_id</span><span class="s2">))</span>
                    <span class="s2">.</span><span class="s1">execute</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">clear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">src_id </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_instance</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_src_attr</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span><span class="s2">.</span><span class="s1">through_model</span>
                <span class="s2">.</span><span class="s1">delete</span><span class="s2">()</span>
                <span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_accessor</span><span class="s2">.</span><span class="s1">src_fk </span><span class="s2">== </span><span class="s1">src_id</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">execute</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">safe_python_value</span><span class="s2">(</span><span class="s1">conv_func</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">validate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">conv_func</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">value</span>
    <span class="s0">return </span><span class="s1">validate</span>


<span class="s0">class </span><span class="s1">BaseModelCursorWrapper</span><span class="s2">(</span><span class="s1">DictCursorWrapper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">BaseModelCursorWrapper</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">model</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">select </span><span class="s2">= </span><span class="s1">columns </span><span class="s0">or </span><span class="s2">[]</span>

    <span class="s0">def </span><span class="s1">_initialize_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">combined </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">combined</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">table</span>
        <span class="s1">description </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">description</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">ncols </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">.</span><span class="s1">description</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">converters </span><span class="s2">= </span><span class="s1">converters </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">] * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ncols</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fields </span><span class="s2">= </span><span class="s1">fields </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">] * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ncols</span>

        <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">description_item </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">description</span><span class="s2">):</span>
            <span class="s1">column </span><span class="s2">= </span><span class="s1">orig_column </span><span class="s2">= </span><span class="s1">description_item</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

            <span class="s4"># Try to clean-up messy column descriptions when people do not</span>
            <span class="s4"># provide an alias. The idea is that we take something like:</span>
            <span class="s4"># SUM(&quot;t1&quot;.&quot;price&quot;) -&gt; &quot;price&quot;) -&gt; price</span>
            <span class="s1">dot_index </span><span class="s2">= </span><span class="s1">column</span><span class="s2">.</span><span class="s1">rfind</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">dot_index </span><span class="s2">!= -</span><span class="s5">1</span><span class="s2">:</span>
                <span class="s1">column </span><span class="s2">= </span><span class="s1">column</span><span class="s2">[</span><span class="s1">dot_index </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">:]</span>
            <span class="s1">column </span><span class="s2">= </span><span class="s1">column</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s3">'()&quot;`'</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">column</span><span class="s2">)</span>

            <span class="s4"># Now we'll see what they selected and see if we can improve the</span>
            <span class="s4"># column-name being returned - e.g. by mapping it to the selected</span>
            <span class="s4"># field's name.</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">raw_node </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">select</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
            <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">column </span><span class="s0">in </span><span class="s1">combined</span><span class="s2">:</span>
                    <span class="s1">raw_node </span><span class="s2">= </span><span class="s1">node </span><span class="s2">= </span><span class="s1">combined</span><span class="s2">[</span><span class="s1">column</span><span class="s2">]</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">continue</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">raw_node</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>

            <span class="s4"># If this column was given an alias, then we will use whatever</span>
            <span class="s4"># alias was returned by the cursor.</span>
            <span class="s1">is_alias </span><span class="s2">= </span><span class="s1">raw_node</span><span class="s2">.</span><span class="s1">is_alias</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">is_alias</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">orig_column</span>

            <span class="s4"># Heuristics used to attempt to get the field associated with a</span>
            <span class="s4"># given SELECT column, so that we can accurately convert the value</span>
            <span class="s4"># returned by the database-cursor into a Python object.</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">raw_node</span><span class="s2">.</span><span class="s1">_coerce</span><span class="s2">:</span>
                    <span class="s1">converters</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">node</span><span class="s2">.</span><span class="s1">python_value</span>
                <span class="s1">fields</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">node</span>
                <span class="s0">if not </span><span class="s1">is_alias</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">node</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">ColumnBase</span><span class="s2">) </span><span class="s0">and </span><span class="s1">raw_node</span><span class="s2">.</span><span class="s1">_converter</span><span class="s2">:</span>
                <span class="s1">converters</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">raw_node</span><span class="s2">.</span><span class="s1">_converter</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">Function</span><span class="s2">) </span><span class="s0">and </span><span class="s1">node</span><span class="s2">.</span><span class="s1">_coerce</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">_python_value </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s1">converters</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">node</span><span class="s2">.</span><span class="s1">_python_value</span>
                <span class="s0">elif </span><span class="s1">node</span><span class="s2">.</span><span class="s1">arguments </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">arguments</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">Node</span><span class="s2">):</span>
                    <span class="s4"># If the first argument is a field or references a column</span>
                    <span class="s4"># on a Model, try using that field's conversion function.</span>
                    <span class="s4"># This usually works, but we use &quot;safe_python_value()&quot; so</span>
                    <span class="s4"># that if a TypeError or ValueError occurs during</span>
                    <span class="s4"># conversion we can just fall-back to the raw cursor value.</span>
                    <span class="s1">first </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">arguments</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">unwrap</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">first</span><span class="s2">, </span><span class="s1">Entity</span><span class="s2">):</span>
                        <span class="s1">path </span><span class="s2">= </span><span class="s1">first</span><span class="s2">.</span><span class="s1">_path</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]  </span><span class="s4"># Try to look-up by name.</span>
                        <span class="s1">first </span><span class="s2">= </span><span class="s1">combined</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">first</span><span class="s2">, </span><span class="s1">Field</span><span class="s2">):</span>
                        <span class="s1">converters</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">safe_python_value</span><span class="s2">(</span><span class="s1">first</span><span class="s2">.</span><span class="s1">python_value</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">column </span><span class="s0">in </span><span class="s1">combined</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">_coerce</span><span class="s2">:</span>
                    <span class="s1">converters</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">combined</span><span class="s2">[</span><span class="s1">column</span><span class="s2">].</span><span class="s1">python_value</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">Column</span><span class="s2">) </span><span class="s0">and </span><span class="s1">node</span><span class="s2">.</span><span class="s1">source </span><span class="s2">== </span><span class="s1">table</span><span class="s2">:</span>
                    <span class="s1">fields</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] = </span><span class="s1">combined</span><span class="s2">[</span><span class="s1">column</span><span class="s2">]</span>

    <span class="s1">initialize </span><span class="s2">= </span><span class="s1">_initialize_columns</span>

    <span class="s0">def </span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>


<span class="s0">class </span><span class="s1">ModelDictCursorWrapper</span><span class="s2">(</span><span class="s1">BaseModelCursorWrapper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= {}</span>
        <span class="s1">columns</span><span class="s2">, </span><span class="s1">converters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converters</span>
        <span class="s1">fields </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ncols</span><span class="s2">):</span>
            <span class="s1">attr </span><span class="s2">= </span><span class="s1">columns</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">attr </span><span class="s0">in </span><span class="s1">result</span><span class="s2">: </span><span class="s0">continue  </span><span class="s4"># Don't overwrite if we have dupes.</span>
            <span class="s0">if </span><span class="s1">converters</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">result</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">] = </span><span class="s1">converters</span><span class="s2">[</span><span class="s1">i</span><span class="s2">](</span><span class="s1">row</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">result</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">] = </span><span class="s1">row</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s0">return </span><span class="s1">result</span>


<span class="s0">class </span><span class="s1">ModelTupleCursorWrapper</span><span class="s2">(</span><span class="s1">ModelDictCursorWrapper</span><span class="s2">):</span>
    <span class="s1">constructor </span><span class="s2">= </span><span class="s1">tuple</span>

    <span class="s0">def </span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">columns</span><span class="s2">, </span><span class="s1">converters </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converters</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">constructor</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s1">converters</span><span class="s2">[</span><span class="s1">i</span><span class="s2">](</span><span class="s1">row</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) </span><span class="s0">if </span><span class="s1">converters</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] </span><span class="s0">is not None else </span><span class="s1">row</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ncols</span><span class="s2">)])</span>


<span class="s0">class </span><span class="s1">ModelNamedTupleCursorWrapper</span><span class="s2">(</span><span class="s1">ModelTupleCursorWrapper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">initialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_initialize_columns</span><span class="s2">()</span>
        <span class="s1">attributes </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ncols</span><span class="s2">):</span>
            <span class="s1">attributes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tuple_class </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'Row'</span><span class="s2">, </span><span class="s1">attributes</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">constructor </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">row</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tuple_class</span><span class="s2">(*</span><span class="s1">row</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ModelObjectCursorWrapper</span><span class="s2">(</span><span class="s1">ModelDictCursorWrapper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">select</span><span class="s2">, </span><span class="s1">constructor</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">constructor </span><span class="s2">= </span><span class="s1">constructor</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_model </span><span class="s2">= </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">constructor</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ModelObjectCursorWrapper</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">select</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">super</span><span class="s2">(</span><span class="s1">ModelObjectCursorWrapper</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_model</span><span class="s2">:</span>
            <span class="s4"># Clear out any dirty fields before returning to the user.</span>
            <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">constructor</span><span class="s2">(</span><span class="s1">__no_default__</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, **</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s1">obj</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
            <span class="s0">return </span><span class="s1">obj</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">constructor</span><span class="s2">(**</span><span class="s1">data</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ModelCursorWrapper</span><span class="s2">(</span><span class="s1">BaseModelCursorWrapper</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">select</span><span class="s2">, </span><span class="s1">from_list</span><span class="s2">, </span><span class="s1">joins</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">ModelCursorWrapper</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">cursor</span><span class="s2">, </span><span class="s1">model</span><span class="s2">, </span><span class="s1">select</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">from_list </span><span class="s2">= </span><span class="s1">from_list</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">joins </span><span class="s2">= </span><span class="s1">joins</span>

    <span class="s0">def </span><span class="s1">initialize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_initialize_columns</span><span class="s2">()</span>
        <span class="s1">selected_src </span><span class="s2">= </span><span class="s1">set</span><span class="s2">([</span><span class="s1">field</span><span class="s2">.</span><span class="s1">model </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span>
                            <span class="s0">if </span><span class="s1">field </span><span class="s0">is not None</span><span class="s2">])</span>
        <span class="s1">select</span><span class="s2">, </span><span class="s1">columns </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">select</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">key_to_constructor </span><span class="s2">= {</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">src_is_dest </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">src_to_dest </span><span class="s2">= []</span>
        <span class="s1">accum </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">deque</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">from_list</span><span class="s2">)</span>
        <span class="s1">dests </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

        <span class="s0">while </span><span class="s1">accum</span><span class="s2">:</span>
            <span class="s1">curr </span><span class="s2">= </span><span class="s1">accum</span><span class="s2">.</span><span class="s1">popleft</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">, </span><span class="s1">Join</span><span class="s2">):</span>
                <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">.</span><span class="s1">lhs</span><span class="s2">)</span>
                <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">.</span><span class="s1">rhs</span><span class="s2">)</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">curr </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">joins</span><span class="s2">:</span>
                <span class="s0">continue</span>

            <span class="s1">is_dict </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">curr</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">constructor</span><span class="s2">, </span><span class="s1">join_type </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">joins</span><span class="s2">[</span><span class="s1">curr</span><span class="s2">]:</span>
                <span class="s0">if </span><span class="s1">key </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_to_constructor</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">key_to_constructor</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">constructor</span>

                    <span class="s4"># (src, attr, dest, is_dict, join_type).</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">src_to_dest</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">curr</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">is_dict</span><span class="s2">,</span>
                                             <span class="s1">join_type</span><span class="s2">))</span>
                    <span class="s1">dests</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
                    <span class="s1">accum</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

        <span class="s4"># Ensure that we accommodate everything selected.</span>
        <span class="s0">for </span><span class="s1">src </span><span class="s0">in </span><span class="s1">selected_src</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">src </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_to_constructor</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">src</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">key_to_constructor</span><span class="s2">[</span><span class="s1">src</span><span class="s2">] = </span><span class="s1">src</span>
                <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">ModelAlias</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">key_to_constructor</span><span class="s2">[</span><span class="s1">src</span><span class="s2">] = </span><span class="s1">src</span><span class="s2">.</span><span class="s1">model</span>

        <span class="s4"># Indicate which sources are also dests.</span>
        <span class="s0">for </span><span class="s1">src</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_to_dest</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">src_is_dest</span><span class="s2">[</span><span class="s1">src</span><span class="s2">] = </span><span class="s1">src </span><span class="s0">in </span><span class="s1">dests </span><span class="s0">and </span><span class="s2">(</span><span class="s1">dest </span><span class="s0">in </span><span class="s1">selected_src</span>
                                                      <span class="s0">or </span><span class="s1">src </span><span class="s0">in </span><span class="s1">selected_src</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">column_keys </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">node </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">select</span><span class="s2">):</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span>
            <span class="s1">field </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">field </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">FieldAlias</span><span class="s2">):</span>
                    <span class="s1">key </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">source</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">key </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">model</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">BindTo</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">dest </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_to_constructor</span><span class="s2">:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'%s specifies bind-to %s, but %s is not '</span>
                                     <span class="s3">'among the selected sources.' </span><span class="s2">%</span>
                                     <span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">(), </span><span class="s1">node</span><span class="s2">.</span><span class="s1">dest</span><span class="s2">, </span><span class="s1">node</span><span class="s2">.</span><span class="s1">dest</span><span class="s2">))</span>
                <span class="s1">key </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">dest</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
                    <span class="s1">node </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">node</span><span class="s2">, </span><span class="s1">Column</span><span class="s2">):</span>
                    <span class="s1">key </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">source</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">column_keys</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">process_row</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">objects </span><span class="s2">= {}</span>
        <span class="s1">object_list </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">constructor </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_to_constructor</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">objects</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">constructor</span><span class="s2">(</span><span class="s1">__no_default__</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">object_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">objects</span><span class="s2">[</span><span class="s1">key</span><span class="s2">])</span>

        <span class="s1">default_instance </span><span class="s2">= </span><span class="s1">objects</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">]</span>

        <span class="s1">set_keys </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">key </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">column_keys</span><span class="s2">):</span>
            <span class="s4"># Get the instance corresponding to the selected column/value,</span>
            <span class="s4"># falling back to the &quot;root&quot; model instance.</span>
            <span class="s1">instance </span><span class="s2">= </span><span class="s1">objects</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">default_instance</span><span class="s2">)</span>
            <span class="s1">column </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">row</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">set_keys</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converters</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converters</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">](</span><span class="s1">value</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
                <span class="s1">instance</span><span class="s2">[</span><span class="s1">column</span><span class="s2">] = </span><span class="s1">value</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">column</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

        <span class="s4"># Need to do some analysis on the joins before this.</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">, </span><span class="s1">is_dict</span><span class="s2">, </span><span class="s1">join_type</span><span class="s2">) </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_to_dest</span><span class="s2">:</span>
            <span class="s1">instance </span><span class="s2">= </span><span class="s1">objects</span><span class="s2">[</span><span class="s1">src</span><span class="s2">]</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">joined_instance </span><span class="s2">= </span><span class="s1">objects</span><span class="s2">[</span><span class="s1">dest</span><span class="s2">]</span>
            <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
                <span class="s0">continue</span>

            <span class="s4"># If no fields were set on the destination instance then do not</span>
            <span class="s4"># assign an &quot;empty&quot; instance.</span>
            <span class="s0">if </span><span class="s1">instance </span><span class="s0">is None or </span><span class="s1">dest </span><span class="s0">is None or </span><span class="s1">\</span>
               <span class="s2">(</span><span class="s1">dest </span><span class="s0">not in </span><span class="s1">set_keys </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">src_is_dest</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">dest</span><span class="s2">)):</span>
                <span class="s0">continue</span>

            <span class="s4"># If no fields were set on either the source or the destination,</span>
            <span class="s4"># then we have nothing to do here.</span>
            <span class="s0">if </span><span class="s1">instance </span><span class="s0">not in </span><span class="s1">set_keys </span><span class="s0">and </span><span class="s1">dest </span><span class="s0">not in </span><span class="s1">set_keys \</span>
               <span class="s0">and </span><span class="s1">join_type</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s3">'OUTER JOIN'</span><span class="s2">):</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">is_dict</span><span class="s2">:</span>
                <span class="s1">instance</span><span class="s2">[</span><span class="s1">attr</span><span class="s2">] = </span><span class="s1">joined_instance</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">joined_instance</span><span class="s2">)</span>

        <span class="s4"># When instantiating models from a cursor, we clear the dirty fields.</span>
        <span class="s0">for </span><span class="s1">instance </span><span class="s0">in </span><span class="s1">object_list</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">Model</span><span class="s2">):</span>
                <span class="s1">instance</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s0">return </span><span class="s1">objects</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">model</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">PrefetchQuery</span><span class="s2">(</span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">'_PrefetchQuery'</span><span class="s2">, (</span>
    <span class="s3">'query'</span><span class="s2">, </span><span class="s3">'fields'</span><span class="s2">, </span><span class="s3">'is_backref'</span><span class="s2">, </span><span class="s3">'rel_models'</span><span class="s2">, </span><span class="s3">'field_to_name'</span><span class="s2">, </span><span class="s3">'model'</span><span class="s2">))):</span>
    <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">query</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">is_backref</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">rel_models</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                <span class="s1">field_to_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">model</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">is_backref</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">rel_models </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s1">rel_models </span><span class="s2">= [</span><span class="s1">field</span><span class="s2">.</span><span class="s1">model </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">]</span>
                <span class="s1">foreign_key_attrs </span><span class="s2">= [</span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">rel_models </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s1">rel_models </span><span class="s2">= [</span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_model </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">]</span>
                <span class="s1">foreign_key_attrs </span><span class="s2">= [</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">]</span>
            <span class="s1">field_to_name </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">fields</span><span class="s2">, </span><span class="s1">foreign_key_attrs</span><span class="s2">))</span>
        <span class="s1">model </span><span class="s2">= </span><span class="s1">query</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">(</span><span class="s1">PrefetchQuery</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">).</span><span class="s1">__new__</span><span class="s2">(</span>
            <span class="s1">cls</span><span class="s2">, </span><span class="s1">query</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">, </span><span class="s1">is_backref</span><span class="s2">, </span><span class="s1">rel_models</span><span class="s2">, </span><span class="s1">field_to_name</span><span class="s2">, </span><span class="s1">model</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">populate_instance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">id_map</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_backref</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
                <span class="s1">identifier </span><span class="s2">= </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                <span class="s1">key </span><span class="s2">= (</span><span class="s1">field</span><span class="s2">, </span><span class="s1">identifier</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">id_map</span><span class="s2">:</span>
                    <span class="s1">setattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">id_map</span><span class="s2">[</span><span class="s1">key</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">field</span><span class="s2">, </span><span class="s1">attname </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_to_name</span><span class="s2">:</span>
                <span class="s1">identifier </span><span class="s2">= </span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                <span class="s1">key </span><span class="s2">= (</span><span class="s1">field</span><span class="s2">, </span><span class="s1">identifier</span><span class="s2">)</span>
                <span class="s1">rel_instances </span><span class="s2">= </span><span class="s1">id_map</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, [])</span>
                <span class="s0">for </span><span class="s1">inst </span><span class="s0">in </span><span class="s1">rel_instances</span><span class="s2">:</span>
                    <span class="s1">setattr</span><span class="s2">(</span><span class="s1">inst</span><span class="s2">, </span><span class="s1">attname</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">)</span>
                    <span class="s1">inst</span><span class="s2">.</span><span class="s1">_dirty</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
                <span class="s1">setattr</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">backref</span><span class="s2">, </span><span class="s1">rel_instances</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">store_instance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">instance</span><span class="s2">, </span><span class="s1">id_map</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">field</span><span class="s2">, </span><span class="s1">attname </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">field_to_name</span><span class="s2">:</span>
            <span class="s1">identity </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">python_value</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">.</span><span class="s1">__data__</span><span class="s2">[</span><span class="s1">attname</span><span class="s2">])</span>
            <span class="s1">key </span><span class="s2">= (</span><span class="s1">field</span><span class="s2">, </span><span class="s1">identity</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_backref</span><span class="s2">:</span>
                <span class="s1">id_map</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">instance</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">id_map</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, [])</span>
                <span class="s1">id_map</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">prefetch_add_subquery</span><span class="s2">(</span><span class="s1">sq</span><span class="s2">, </span><span class="s1">subqueries</span><span class="s2">, </span><span class="s1">prefetch_type</span><span class="s2">):</span>
    <span class="s1">fixed_queries </span><span class="s2">= [</span><span class="s1">PrefetchQuery</span><span class="s2">(</span><span class="s1">sq</span><span class="s2">)]</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">subquery </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">subqueries</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
            <span class="s1">subquery</span><span class="s2">, </span><span class="s1">target_model </span><span class="s2">= </span><span class="s1">subquery</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">target_model </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">, </span><span class="s1">Query</span><span class="s2">) </span><span class="s0">and </span><span class="s1">is_model</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">) </span><span class="s0">or </span><span class="s1">\</span>
           <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">, </span><span class="s1">ModelAlias</span><span class="s2">):</span>
            <span class="s1">subquery </span><span class="s2">= </span><span class="s1">subquery</span><span class="s2">.</span><span class="s1">select</span><span class="s2">()</span>
        <span class="s1">subquery_model </span><span class="s2">= </span><span class="s1">subquery</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">)):</span>
            <span class="s1">fks </span><span class="s2">= </span><span class="s1">backrefs </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">fixed </span><span class="s2">= </span><span class="s1">fixed_queries</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
            <span class="s1">last_query </span><span class="s2">= </span><span class="s1">fixed</span><span class="s2">.</span><span class="s1">query</span>
            <span class="s1">last_model </span><span class="s2">= </span><span class="s1">last_obj </span><span class="s2">= </span><span class="s1">fixed</span><span class="s2">.</span><span class="s1">model</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">last_model</span><span class="s2">, </span><span class="s1">ModelAlias</span><span class="s2">):</span>
                <span class="s1">last_model </span><span class="s2">= </span><span class="s1">last_model</span><span class="s2">.</span><span class="s1">model</span>
            <span class="s1">rels </span><span class="s2">= </span><span class="s1">subquery_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model_refs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">last_model</span><span class="s2">, [])</span>
            <span class="s0">if </span><span class="s1">rels</span><span class="s2">:</span>
                <span class="s1">fks </span><span class="s2">= [</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">subquery_model</span><span class="s2">, </span><span class="s1">fk</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">fk </span><span class="s0">in </span><span class="s1">rels</span><span class="s2">]</span>
                <span class="s1">pks </span><span class="s2">= [</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">last_obj</span><span class="s2">, </span><span class="s1">fk</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) </span><span class="s0">for </span><span class="s1">fk </span><span class="s0">in </span><span class="s1">rels</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">backrefs </span><span class="s2">= </span><span class="s1">subquery_model</span><span class="s2">.</span><span class="s1">_meta</span><span class="s2">.</span><span class="s1">model_backrefs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">last_model</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">fks </span><span class="s0">or </span><span class="s1">backrefs</span><span class="s2">) </span><span class="s0">and </span><span class="s2">((</span><span class="s1">target_model </span><span class="s0">is </span><span class="s1">last_obj</span><span class="s2">) </span><span class="s0">or</span>
                                      <span class="s2">(</span><span class="s1">target_model </span><span class="s0">is None</span><span class="s2">)):</span>
                <span class="s0">break</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">tgt_err </span><span class="s2">= </span><span class="s3">' using %s' </span><span class="s2">% </span><span class="s1">target_model </span><span class="s0">if </span><span class="s1">target_model </span><span class="s0">else </span><span class="s3">''</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s3">'Error: unable to find foreign key for '</span>
                                 <span class="s3">'query: %s%s' </span><span class="s2">% (</span><span class="s1">subquery</span><span class="s2">, </span><span class="s1">tgt_err</span><span class="s2">))</span>

        <span class="s1">dest </span><span class="s2">= (</span><span class="s1">target_model</span><span class="s2">,) </span><span class="s0">if </span><span class="s1">target_model </span><span class="s0">else None</span>

        <span class="s0">if </span><span class="s1">fks</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">prefetch_type </span><span class="s2">== </span><span class="s1">PREFETCH_TYPE</span><span class="s2">.</span><span class="s1">WHERE</span><span class="s2">:</span>
                <span class="s1">expr </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">or_</span><span class="s2">, [</span>
                    <span class="s2">(</span><span class="s1">fk </span><span class="s2">&lt;&lt; </span><span class="s1">last_query</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s1">pk</span><span class="s2">))</span>
                    <span class="s0">for </span><span class="s2">(</span><span class="s1">fk</span><span class="s2">, </span><span class="s1">pk</span><span class="s2">) </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">fks</span><span class="s2">, </span><span class="s1">pks</span><span class="s2">)])</span>
                <span class="s1">subquery </span><span class="s2">= </span><span class="s1">subquery</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">expr</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">prefetch_type </span><span class="s2">== </span><span class="s1">PREFETCH_TYPE</span><span class="s2">.</span><span class="s1">JOIN</span><span class="s2">:</span>
                <span class="s1">expr </span><span class="s2">= []</span>
                <span class="s1">select_pks </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
                <span class="s0">for </span><span class="s1">fk</span><span class="s2">, </span><span class="s1">pk </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">fks</span><span class="s2">, </span><span class="s1">pks</span><span class="s2">):</span>
                    <span class="s1">expr</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">last_query</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">pk</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">) == </span><span class="s1">fk</span><span class="s2">)</span>
                    <span class="s1">select_pks</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">pk</span><span class="s2">)</span>
                <span class="s1">subquery </span><span class="s2">= </span><span class="s1">subquery</span><span class="s2">.</span><span class="s1">distinct</span><span class="s2">().</span><span class="s1">join</span><span class="s2">(</span>
                    <span class="s1">last_query</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(*</span><span class="s1">select_pks</span><span class="s2">),</span>
                    <span class="s1">on</span><span class="s2">=</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">or_</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">))</span>
            <span class="s1">fixed_queries</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">PrefetchQuery</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">, </span><span class="s1">fks</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">backrefs</span><span class="s2">:</span>
            <span class="s1">expr </span><span class="s2">= []</span>
            <span class="s1">fields </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">backref </span><span class="s0">in </span><span class="s1">backrefs</span><span class="s2">:</span>
                <span class="s1">rel_field </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">subquery_model</span><span class="s2">, </span><span class="s1">backref</span><span class="s2">.</span><span class="s1">rel_field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">fk_field </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">last_obj</span><span class="s2">, </span><span class="s1">backref</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s1">fields</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">fk_field</span><span class="s2">))</span>

            <span class="s0">if </span><span class="s1">prefetch_type </span><span class="s2">== </span><span class="s1">PREFETCH_TYPE</span><span class="s2">.</span><span class="s1">WHERE</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">fk_field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">:</span>
                    <span class="s1">expr</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">rel_field </span><span class="s2">&lt;&lt; </span><span class="s1">last_query</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s1">fk_field</span><span class="s2">))</span>
                <span class="s1">subquery </span><span class="s2">= </span><span class="s1">subquery</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">or_</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">))</span>
            <span class="s0">elif </span><span class="s1">prefetch_type </span><span class="s2">== </span><span class="s1">PREFETCH_TYPE</span><span class="s2">.</span><span class="s1">JOIN</span><span class="s2">:</span>
                <span class="s1">select_fks </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">rel_field</span><span class="s2">, </span><span class="s1">fk_field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">:</span>
                    <span class="s1">select_fks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">fk_field</span><span class="s2">)</span>
                    <span class="s1">target </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">last_query</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">fk_field</span><span class="s2">.</span><span class="s1">column_name</span><span class="s2">)</span>
                    <span class="s1">expr</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">rel_field </span><span class="s2">== </span><span class="s1">target</span><span class="s2">)</span>
                <span class="s1">subquery </span><span class="s2">= </span><span class="s1">subquery</span><span class="s2">.</span><span class="s1">distinct</span><span class="s2">().</span><span class="s1">join</span><span class="s2">(</span>
                    <span class="s1">last_query</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(*</span><span class="s1">select_fks</span><span class="s2">),</span>
                    <span class="s1">on</span><span class="s2">=</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">or_</span><span class="s2">, </span><span class="s1">expr</span><span class="s2">))</span>
            <span class="s1">fixed_queries</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">PrefetchQuery</span><span class="s2">(</span><span class="s1">subquery</span><span class="s2">, </span><span class="s1">backrefs</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">dest</span><span class="s2">))</span>

    <span class="s0">return </span><span class="s1">fixed_queries</span>


<span class="s0">def </span><span class="s1">prefetch</span><span class="s2">(</span><span class="s1">sq</span><span class="s2">, *</span><span class="s1">subqueries</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">subqueries</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">sq</span>
    <span class="s1">prefetch_type </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'prefetch_type'</span><span class="s2">, </span><span class="s1">PREFETCH_TYPE</span><span class="s2">.</span><span class="s1">WHERE</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'Unrecognized arguments: %s' </span><span class="s2">% </span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s1">fixed_queries </span><span class="s2">= </span><span class="s1">prefetch_add_subquery</span><span class="s2">(</span><span class="s1">sq</span><span class="s2">, </span><span class="s1">subqueries</span><span class="s2">, </span><span class="s1">prefetch_type</span><span class="s2">)</span>
    <span class="s1">deps </span><span class="s2">= {}</span>
    <span class="s1">rel_map </span><span class="s2">= {}</span>
    <span class="s0">for </span><span class="s1">pq </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">fixed_queries</span><span class="s2">):</span>
        <span class="s1">query_model </span><span class="s2">= </span><span class="s1">pq</span><span class="s2">.</span><span class="s1">model</span>
        <span class="s0">if </span><span class="s1">pq</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">rel_model </span><span class="s0">in </span><span class="s1">pq</span><span class="s2">.</span><span class="s1">rel_models</span><span class="s2">:</span>
                <span class="s1">rel_map</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">rel_model</span><span class="s2">, [])</span>
                <span class="s1">rel_map</span><span class="s2">[</span><span class="s1">rel_model</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pq</span><span class="s2">)</span>

        <span class="s1">deps</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">query_model</span><span class="s2">, {})</span>
        <span class="s1">id_map </span><span class="s2">= </span><span class="s1">deps</span><span class="s2">[</span><span class="s1">query_model</span><span class="s2">]</span>
        <span class="s1">has_relations </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">rel_map</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">query_model</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">instance </span><span class="s0">in </span><span class="s1">pq</span><span class="s2">.</span><span class="s1">query</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">pq</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">:</span>
                <span class="s1">pq</span><span class="s2">.</span><span class="s1">store_instance</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">id_map</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">has_relations</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">rel </span><span class="s0">in </span><span class="s1">rel_map</span><span class="s2">[</span><span class="s1">query_model</span><span class="s2">]:</span>
                    <span class="s1">rel</span><span class="s2">.</span><span class="s1">populate_instance</span><span class="s2">(</span><span class="s1">instance</span><span class="s2">, </span><span class="s1">deps</span><span class="s2">[</span><span class="s1">rel</span><span class="s2">.</span><span class="s1">model</span><span class="s2">])</span>

    <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">pq</span><span class="s2">.</span><span class="s1">query</span><span class="s2">)</span>
</pre>
</body>
</html>