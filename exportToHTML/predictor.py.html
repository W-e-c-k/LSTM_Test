<html>
<head>
<title>predictor.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
predictor.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">yfinance </span><span class="s0">as </span><span class="s1">yf</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">preprocessing</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">Pipeline</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">model_selection </span><span class="s0">import </span><span class="s1">GridSearchCV</span>
<span class="s0">import </span><span class="s1">keras</span>
<span class="s0">import </span><span class="s1">tensorflow </span><span class="s0">as </span><span class="s1">tf</span>
<span class="s0">from </span><span class="s1">tensorflow</span><span class="s2">.</span><span class="s1">keras</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">Model</span><span class="s2">, </span><span class="s1">Sequential</span><span class="s2">, </span><span class="s1">load_model</span>
<span class="s0">from </span><span class="s1">tensorflow</span><span class="s2">.</span><span class="s1">keras</span><span class="s2">.</span><span class="s1">layers </span><span class="s0">import </span><span class="s1">Dense</span><span class="s2">, </span><span class="s1">Dropout</span><span class="s2">, </span><span class="s1">LSTM</span><span class="s2">, </span><span class="s1">Input</span><span class="s2">, </span><span class="s1">Activation</span><span class="s2">, </span><span class="s1">concatenate</span>
<span class="s0">from </span><span class="s1">tensorflow</span><span class="s2">.</span><span class="s1">keras </span><span class="s0">import </span><span class="s1">optimizers</span>
<span class="s0">from </span><span class="s1">tensorflow</span><span class="s2">.</span><span class="s1">keras</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">plot_model</span>
<span class="s0">from </span><span class="s1">keras </span><span class="s0">import </span><span class="s1">optimizers</span>
<span class="s0">import </span><span class="s1">h5py</span>


<span class="s3"># Yahoo Finance Library for getting historical stock data from Yahoo finance</span>
<span class="s0">import </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">datetime</span>


<span class="s0">def </span><span class="s1">get_stock_data</span><span class="s2">(</span><span class="s1">stock_list</span><span class="s2">, </span><span class="s1">start_date</span><span class="s2">, </span><span class="s1">end_date</span><span class="s2">):</span>
    <span class="s4">''' 
        Download stock data from Yahoo Finance as listed in stock_list 
        starting from start date to end date and save to CSV file. 
        The default path is the same path as the running script. 
 
        Input: 
        - stock_list (String) : String of Yahoo Finance's ticker name separated by space. For example, stockA stockB stockC ... 
        - start_date (String) : String of start date in format DD/MM/YYYY. 
        - end_date (String) : String of end date in format DD/MM/YYYY. 
 
        Output: 
        - No return value 
        - The csv file will be written with the naming convention as ticker.csv 
 
    '''</span>
    <span class="s0">for </span><span class="s1">stock </span><span class="s0">in </span><span class="s1">stock_list</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">file </span><span class="s2">= </span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'.csv'</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">'Downloading data from Yahoo Finance...'</span><span class="s2">)</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">yf</span><span class="s2">.</span><span class="s1">download</span><span class="s2">(</span><span class="s1">stock</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s1">start_date</span><span class="s2">, </span><span class="s1">end</span><span class="s2">=</span><span class="s1">end_date</span><span class="s2">)</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">to_csv</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;exception &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) + </span><span class="s5">&quot;on &quot; </span><span class="s2">+ </span><span class="s1">stock</span><span class="s2">)</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;start date = &quot; </span><span class="s2">+ </span><span class="s1">start_date</span><span class="s2">)</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;end date = &quot; </span><span class="s2">+ </span><span class="s1">end_date</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">dataset_preparation</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">y_normaliser</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'file'</span><span class="s2">, </span><span class="s1">df</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s4">''' 
      This function will prepare data and make it ready for training and testing the model by receiving the CSV file path or dataframe 
      equivalent to Yahoo Finance's historical data with other parameters, normalize to 0-1 range value, separate into train and test and return the result. 
 
      Input: 
      - filename (String) : The file path for csv file containing historical stock data downloaded from Yahoo Finance. 
      - history_points (Number) : The number of day range for historical data to be used for training the model. 
      - predict_range (Number) : The range of day to forecast the price. 
      - y_normmalizer (preprocessing.MinMaxScaler Object) :  Preprocessor for normalize the price for forecast data to be 0-1. We need this so that we could use it again for scaling up the data back to normal value. 
      - df (DataFrame) : The dataframe input of the dataset. If the filename is passed and the mode is set to'file' it will be ignored. 
      - mode : If it is 'file' the function will ignore df otherwise it will assume that df will be provided for preparation. This is used in the case that the data is read from CSV and append with other data features. 
 
      Output: 
      - ohlcv_histories_normalised (Array) : Array of the data features. One row consist of [day-1-open,day-1-max,day-1-min,...day-history_point ]. 
      - next_day_adjclose_values_normalised (Array) : Array of normalised Adj Close values transformed in the format of [day1-adj close,day2-adj close....day-predict_range adj close]. 
      - next_day_adjclose_values (Array) : Array of actual Adj Close values transformed in the format of [day1-adj close,day2-adj close....day-predict_range adj close]. 
      - y_normaliser (preprocessing.MinMaxScaler Object) : After we fit the actual value, we return it back so that it can be used again to scale the normalized result. 
    '''</span>

    <span class="s3"># Prepare data per mode - file or dataframe input</span>
    <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s5">'file'</span><span class="s2">:</span>
        <span class="s3"># If it is file mode the function expect CSV file path to read the data</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

    <span class="s3"># For both mode, we will drop row with null value as we can't use it anyway</span>
    <span class="s1">df_na </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dropna</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s6">0</span><span class="s2">)</span>
    <span class="s3"># Drop Date as this is time series data, Date isn't used. Also drop Close as we will predict Adj Close.</span>
    <span class="s1">df_na </span><span class="s2">= </span><span class="s1">df_na</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">([</span><span class="s5">'Date'</span><span class="s2">, </span><span class="s5">'Close'</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s6">1</span><span class="s2">)</span>

    <span class="s3"># Normalise all data to the value range of 0-1 as neural network algorithm has better performance with this data range</span>
    <span class="s1">data_normaliser </span><span class="s2">= </span><span class="s1">preprocessing</span><span class="s2">.</span><span class="s1">MinMaxScaler</span><span class="s2">()</span>
    <span class="s1">data_normalised </span><span class="s2">= </span><span class="s1">data_normaliser</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">df_na</span><span class="s2">)</span>

    <span class="s3"># Prepare the data in the format of [day-1-open,day-1-max,day-1-min,...day-history_point ] as 1 row input for predict the 'predict_range' price for train and test</span>
    <span class="s1">ohlcv_histories_normalised </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">data_normalised</span><span class="s2">[</span><span class="s1">i</span><span class="s2">: </span><span class="s1">i </span><span class="s2">+ </span><span class="s1">history_points</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in</span>
                                           <span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">data_normalised</span><span class="s2">) - </span><span class="s1">history_points </span><span class="s2">- </span><span class="s1">predict_range </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)])</span>

    <span class="s3"># Get the actual price [day1-adj close,day2-adj close....day-predict_range adj close] for train and test</span>
    <span class="s1">next_day_adjclose_values_normalised </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">data_normalised</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s1">history_points</span><span class="s2">:</span><span class="s1">i </span><span class="s2">+ </span><span class="s1">history_points </span><span class="s2">+ </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s6">3</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in</span>
         <span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">data_normalised</span><span class="s2">) - </span><span class="s1">history_points </span><span class="s2">- </span><span class="s1">predict_range </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)])</span>

    <span class="s3"># Create the same array as the normalised adj close but with the actual value not the scaled down value. This is used to calculate the prediction accuracy</span>
    <span class="s1">next_day_adjclose_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">df_na</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s1">history_points</span><span class="s2">:</span><span class="s1">i </span><span class="s2">+ </span><span class="s1">history_points </span><span class="s2">+ </span><span class="s1">predict_range</span><span class="s2">][</span><span class="s5">'Adj Close'</span><span class="s2">].</span><span class="s1">values</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in</span>
         <span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">df_na</span><span class="s2">) - </span><span class="s1">history_points </span><span class="s2">- </span><span class="s1">predict_range </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)])</span>

    <span class="s3"># Use the passed normaliser to fit the actual value so that we can scale the predicted result back to actual value</span>
    <span class="s1">y_normaliser</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">next_day_adjclose_values</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">ohlcv_histories_normalised</span><span class="s2">, </span><span class="s1">next_day_adjclose_values_normalised</span><span class="s2">, </span><span class="s1">next_day_adjclose_values</span><span class="s2">, </span><span class="s1">y_normaliser</span>


<span class="s0">def </span><span class="s1">get_LSTM_Model</span><span class="s2">(</span><span class="s1">layer_num</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">features_num</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">optimizer</span><span class="s2">, </span><span class="s1">dropout_prob</span><span class="s2">):</span>
    <span class="s4">''' 
      This function will build LSTM model per provided parameters. 
      The model will be a simple one consist of one forget layer with configurable forget probability and configurable number of hidden layers. 
 
      Input: 
      - layer_num (Number) : The number of hidden layer. 
      - history_points (Number) : The number of data in the dataset. 
      - features_num (Number) : The number of features in the dataset. 
      - predict_range (Number) : The number of day to predict the stock price. 
      - optimizer (Number) : The optimizer's name e.g. adam. 
      - dropout_prob (Float) : Probability to forget the date on dropout layer. 
 
      Output: 
      - model (Object) : The compiled LSTM model per the provided parameters. 
 
    '''</span>

    <span class="s3"># Initialize LSTM using Keras library</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">Sequential</span><span class="s2">()</span>

    <span class="s1">model</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Input</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">features_num</span><span class="s2">)))</span>
    <span class="s3"># Defining hidden layer number and the shape of the input (number of data in the dataset and the number of feature)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">LSTM</span><span class="s2">(</span><span class="s1">units</span><span class="s2">=</span><span class="s1">layer_num</span><span class="s2">))</span>

    <span class="s3"># Add forget (dropout) layer with probability per argument</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Dropout</span><span class="s2">(</span><span class="s1">dropout_prob</span><span class="s2">))</span>

    <span class="s3"># End the network with hiddenlayer per the size of forecast day e.g. 1,5,10</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Dense</span><span class="s2">(</span><span class="s1">predict_range</span><span class="s2">))</span>

    <span class="s3"># Build and return the model per the selected optimizer</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'mean_squared_error'</span><span class="s2">, </span><span class="s1">optimizer</span><span class="s2">=</span><span class="s1">optimizer</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">model</span>


<span class="s0">def </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">ohlcv_histories</span><span class="s2">, </span><span class="s1">next_day_adj_close</span><span class="s2">, </span><span class="s1">unscaled_y</span><span class="s2">, </span><span class="s1">test_split</span><span class="s2">=</span><span class="s6">0.9</span><span class="s2">):</span>
    <span class="s4">''' 
        Split the dataset to train and test dataset per provideed ratio. 
 
        Input 
        - ohlcv_histories (Array) : The dataset in array. 
        - next_day_adj_close (Array) : The result of prediction using the dataset in array. 
        - unscaled_y (Array) : The same data as next_day_adj_close but not normalize to 0-1. 
        - test_split (Float) : The ratio of train per test. 
 
        Output 
        - ohlcv_train (Array) : The train dataset splitted per test_split ratio. 
        - ohlcv_test (Array) : The test dataset splitted per test_split ratio. 
        - y_test (Array) : The result of test dataset splitted per test_split ratio. 
        - y_train (Array) : The result of train dataset splitted per test_split ratio. 
        - unscaled_y_test (Array) : The unscaled y_test per test_split ratio. 
    '''</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">ohlcv_histories</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] * </span><span class="s1">test_split</span><span class="s2">)</span>

    <span class="s1">ohlcv_train </span><span class="s2">= </span><span class="s1">ohlcv_histories</span><span class="s2">[:</span><span class="s1">n</span><span class="s2">]</span>
    <span class="s1">y_train </span><span class="s2">= </span><span class="s1">next_day_adj_close</span><span class="s2">[:</span><span class="s1">n</span><span class="s2">]</span>

    <span class="s1">ohlcv_test </span><span class="s2">= </span><span class="s1">ohlcv_histories</span><span class="s2">[</span><span class="s1">n</span><span class="s2">:]</span>
    <span class="s1">y_test </span><span class="s2">= </span><span class="s1">next_day_adj_close</span><span class="s2">[</span><span class="s1">n</span><span class="s2">:]</span>

    <span class="s1">unscaled_y_test </span><span class="s2">= </span><span class="s1">unscaled_y</span><span class="s2">[</span><span class="s1">n</span><span class="s2">:]</span>

    <span class="s0">return </span><span class="s1">ohlcv_train</span><span class="s2">, </span><span class="s1">ohlcv_test</span><span class="s2">, </span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">unscaled_y_test</span>


<span class="s0">def </span><span class="s1">train_predictor</span><span class="s2">(</span><span class="s1">ohlcv_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">ohlcv_test</span><span class="s2">, </span><span class="s1">y_normaliser</span><span class="s2">, </span><span class="s1">unscaled_y_test</span><span class="s2">, </span><span class="s1">hidden_layer</span><span class="s2">, </span><span class="s1">batch_size</span><span class="s2">, </span><span class="s1">epoch</span><span class="s2">,</span>
                    <span class="s1">dropout_probability</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">features_num</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">):</span>
    <span class="s4">''' 
        Create LSTM model per provideded parameter, fit the train data and validate its accuracy using MSE. 
        Finally, retrun the result of MSE and the model object. 
 
        Input 
        - ohlcv_train (Array) : Train dataset in array. 
        - y_train (Array) : Train dataset result in array. 
        - ohlcv_test (Array) : Test dataset in array. 
        - y_normaliser (preprocessing.MinMaxScaler Object) : The normaliser instance that is used to scale down y_test. We will use it to scale up the result from test dataset. 
        - unscaled_y_test (Array) : The unscaled y_test using for validate the result. 
        - hidden_layer (Number) : LSTM parameter's number of hidden layer. 
        - batch_size (Number) : LSTM parameter's number of batch size. 
        - epoch (Number) : LSTM parameter's number of epoch. 
        - dropout_probability (Float) : LSTM parameter's dropout probability. 
        - history_points (Number) : LSTM parameter's the number of history data to train the model in each iteration. 
        - features_num (Number) : LSTM parameter's the number of features in the dataset. 
        - predict_range : LSTM parameter's the number of predict data to be predicted. 
 
        Output 
        - model (Object) : LSTM model which can be saved to h5 or use to predict the result with the new dataset. 
        - scaled_mse (Float) : Mean Squared Error of the model measured by using the unscaled result from test dataset minus the unscaled_y_test 
 
    '''</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">get_LSTM_Model</span><span class="s2">(</span><span class="s1">hidden_layer</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">features_num</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s5">'adam'</span><span class="s2">, </span><span class="s1">dropout_probability</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">ohlcv_train</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">batch_size</span><span class="s2">=</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s1">epochs</span><span class="s2">=</span><span class="s1">epoch</span><span class="s2">, </span><span class="s1">shuffle</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">validation_split</span><span class="s2">=</span><span class="s6">0.1</span><span class="s2">,</span>
              <span class="s1">verbose</span><span class="s2">=</span><span class="s6">0</span><span class="s2">)</span>

    <span class="s1">y_test_predicted </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">ohlcv_test</span><span class="s2">)</span>
    <span class="s1">y_test_predicted </span><span class="s2">= </span><span class="s1">y_normaliser</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">y_test_predicted</span><span class="s2">)</span>

    <span class="s1">real_mse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">square</span><span class="s2">(</span><span class="s1">unscaled_y_test </span><span class="s2">- </span><span class="s1">y_test_predicted</span><span class="s2">))</span>
    <span class="s1">scaled_mse </span><span class="s2">= </span><span class="s1">real_mse </span><span class="s2">/ (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">unscaled_y_test</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">unscaled_y_test</span><span class="s2">)) * </span><span class="s6">100</span>

    <span class="s0">return </span><span class="s1">model</span><span class="s2">, </span><span class="s1">scaled_mse</span><span class="s2">, </span><span class="s1">y_test_predicted</span>


<span class="s0">def </span><span class="s1">train_and_validate_stock_predictor</span><span class="s2">(</span><span class="s1">stock</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">hidden_layer</span><span class="s2">, </span><span class="s1">batch_size</span><span class="s2">, </span><span class="s1">epoch</span><span class="s2">,</span>
                                       <span class="s1">dropout_probability</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'file'</span><span class="s2">):</span>
    <span class="s4">''' 
        Encapsulate all activities to create LSTM model to predict the stock with parameters as provided. 
        There are 2 mode for this function. mode='file' will read data from csv file and not add additional features like macd and EMA 
        while other mode will read data from csv but also add macd and EMA as additional features. 
        Starting from transforming data, splitting to train/test, build and fit model, evaluate the model accuracy and return result. 
 
        Input 
        - stock (String) : Ticker per Yahoo Finance. 
        - history_points (Number) : LSTM parameter's the number of history data to train the model in each iteration. 
        - predict_range : LSTM parameter's the number of predict data to be predicted. 
        - hidden_layer (Number) : LSTM parameter's number of hidden layer. 
        - batch_size (Number) : LSTM parameter's number of batch size. 
        - epoch (Number) : LSTM parameter's number of epoch. 
        - dropout_probability (Float) : LSTM parameter's dropout probability. 
 
        Output 
        - model (Object) : LSTM model which can be saved to h5 or use to predict the result with the new dataset. 
        - scaled_mse (Float) : Mean Squared Error of the model measured by using the unscaled result from test dataset minus the unscaled_y_test 
    '''</span>
    <span class="s3"># Read data and add MACD and EMA</span>
    <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s5">'file'</span><span class="s2">:</span>
        <span class="s1">features_num </span><span class="s2">= </span><span class="s6">5</span>
        <span class="s1">ohlcv_histories</span><span class="s2">, </span><span class="s1">next_day_adj_close</span><span class="s2">, </span><span class="s1">unscaled_y</span><span class="s2">, </span><span class="s1">y_normaliser </span><span class="s2">= </span><span class="s1">dataset_preparation</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'.csv'</span><span class="s2">,</span>
                                                                                            <span class="s1">history_points</span><span class="s2">,</span>
                                                                                            <span class="s1">predict_range</span><span class="s2">,</span>
                                                                                            <span class="s1">preprocessing</span><span class="s2">.</span><span class="s1">MinMaxScaler</span><span class="s2">())</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">add_macd_ema</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'.csv'</span><span class="s2">))</span>
        <span class="s1">ohlcv_histories</span><span class="s2">, </span><span class="s1">next_day_adj_close</span><span class="s2">, </span><span class="s1">unscaled_y</span><span class="s2">, </span><span class="s1">y_normaliser </span><span class="s2">= </span><span class="s1">dataset_preparation</span><span class="s2">(</span><span class="s5">''</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">,</span>
                                                                                            <span class="s1">predict_range</span><span class="s2">,</span>
                                                                                            <span class="s1">preprocessing</span><span class="s2">.</span><span class="s1">MinMaxScaler</span><span class="s2">(),</span>
                                                                                            <span class="s1">mode</span><span class="s2">=</span><span class="s5">'df'</span><span class="s2">, </span><span class="s1">df</span><span class="s2">=</span><span class="s1">df</span><span class="s2">)</span>
        <span class="s1">features_num </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) - </span><span class="s6">2</span>

    <span class="s1">ohlcv_train</span><span class="s2">, </span><span class="s1">ohlcv_test</span><span class="s2">, </span><span class="s1">y_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">unscaled_y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">ohlcv_histories</span><span class="s2">, </span><span class="s1">next_day_adj_close</span><span class="s2">,</span>
                                                                                 <span class="s1">unscaled_y</span><span class="s2">)</span>

    <span class="s1">model</span><span class="s2">, </span><span class="s1">scaled_mse</span><span class="s2">, </span><span class="s1">y_test_predicted </span><span class="s2">= </span><span class="s1">train_predictor</span><span class="s2">(</span><span class="s1">ohlcv_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">ohlcv_test</span><span class="s2">, </span><span class="s1">y_normaliser</span><span class="s2">, </span><span class="s1">unscaled_y_test</span><span class="s2">, </span><span class="s1">hidden_layer</span><span class="s2">,</span>
                                        <span class="s1">batch_size</span><span class="s2">, </span><span class="s1">epoch</span><span class="s2">, </span><span class="s1">dropout_probability</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">features_num</span><span class="s2">,</span>
                                        <span class="s1">predict_range</span><span class="s2">)</span>

    <span class="s1">display_test_validation_graph</span><span class="s2">(</span><span class="s1">unscaled_y_test</span><span class="s2">, </span><span class="s1">y_test_predicted</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">model</span><span class="s2">, </span><span class="s1">scaled_mse</span>


<span class="s0">def </span><span class="s1">add_macd_ema</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">ema1</span><span class="s2">=</span><span class="s6">20</span><span class="s2">, </span><span class="s1">ema2</span><span class="s2">=</span><span class="s6">50</span><span class="s2">):</span>
    <span class="s4">''' 
        Compute stock technical analysis indicator - MACD and EMA and add back to the dataset 
 
        Input 
        - df (DataFrame) : The DataFrame of stock data as downloaded from Yahoo Finance 
        - ema1 (Number) : The first EMA period to add to the dataset 
        - ema2 (Number) : The second EMA period to add to the dataset 
 
        Output 
        - df (DataFrame) : The DataFrame with new columns added - MACD, ema1 and ema2 e.g. MACD, 20, 50 are the default column name that will be added 
    '''</span>
    <span class="s1">df_close </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[[</span><span class="s5">'Close'</span><span class="s2">]]</span>
    <span class="s1">df_close</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">level</span><span class="s2">=</span><span class="s6">0</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">df_close</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s5">'ds'</span><span class="s2">, </span><span class="s5">'y'</span><span class="s2">]</span>

    <span class="s1">exp1 </span><span class="s2">= </span><span class="s1">df_close</span><span class="s2">.</span><span class="s1">y</span><span class="s2">.</span><span class="s1">ewm</span><span class="s2">(</span><span class="s1">span</span><span class="s2">=</span><span class="s6">12</span><span class="s2">, </span><span class="s1">adjust</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s1">exp2 </span><span class="s2">= </span><span class="s1">df_close</span><span class="s2">.</span><span class="s1">y</span><span class="s2">.</span><span class="s1">ewm</span><span class="s2">(</span><span class="s1">span</span><span class="s2">=</span><span class="s6">26</span><span class="s2">, </span><span class="s1">adjust</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s1">macd </span><span class="s2">= </span><span class="s1">exp1 </span><span class="s2">- </span><span class="s1">exp2</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">merge</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">macd</span><span class="s2">, </span><span class="s1">how</span><span class="s2">=</span><span class="s5">'left'</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s5">'Date'</span><span class="s2">, </span><span class="s5">'Open'</span><span class="s2">, </span><span class="s5">'High'</span><span class="s2">, </span><span class="s5">'Low'</span><span class="s2">, </span><span class="s5">'Close'</span><span class="s2">, </span><span class="s5">'Adj Close'</span><span class="s2">, </span><span class="s5">'Volume'</span><span class="s2">, </span><span class="s5">'MACD'</span><span class="s2">]</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s1">ema1</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s5">'Close'</span><span class="s2">].</span><span class="s1">ewm</span><span class="s2">(</span><span class="s1">span</span><span class="s2">=</span><span class="s1">ema1</span><span class="s2">, </span><span class="s1">adjust</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s1">ema2</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s5">'Close'</span><span class="s2">].</span><span class="s1">ewm</span><span class="s2">(</span><span class="s1">span</span><span class="s2">=</span><span class="s1">ema2</span><span class="s2">, </span><span class="s1">adjust</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s0">return </span><span class="s1">df</span>


<span class="s0">def </span><span class="s1">display_test_validation_graph</span><span class="s2">(</span><span class="s1">unscaled_y_test</span><span class="s2">, </span><span class="s1">y_test_predicted</span><span class="s2">):</span>
    <span class="s4">''' 
        Display the plot of the stock price in test dataset and the predicted data. 
 
        Input 
        - unscaled_y_test (Array) : The array of stock price in test dataset. 
        - y_test_predicted (Array) : The array of stock price as predicted. 
 
        Output 
        - No return value. 
        - The plot will be displayed on the screen. 
    '''</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">().</span><span class="s1">set_size_inches</span><span class="s2">(</span><span class="s6">22</span><span class="s2">, </span><span class="s6">15</span><span class="s2">, </span><span class="s1">forward</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">start </span><span class="s2">= </span><span class="s6">0</span>
    <span class="s1">end </span><span class="s2">= -</span><span class="s6">1</span>

    <span class="s1">real </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">unscaled_y_test</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">end</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s5">'real'</span><span class="s2">)</span>
    <span class="s1">pred </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">y_test_predicted</span><span class="s2">[</span><span class="s1">start</span><span class="s2">:</span><span class="s1">end</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s5">'predicted'</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">([</span><span class="s5">'Real'</span><span class="s2">, </span><span class="s5">'Predicted'</span><span class="s2">])</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">show</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">train_model</span><span class="s2">(</span><span class="s1">stock_list</span><span class="s2">, </span><span class="s1">start_date</span><span class="s2">, </span><span class="s1">end_date</span><span class="s2">):</span>
    <span class="s4">''' 
        Initial function for the user to use by provide stock list, start and end date of data to train the prediction model. 
        The function will call other function to download data from Yahoo finance per specific start and end date. 
        Then, prepare the data and build LSTM model for stock price prediction of 1,5 and 10 day using the set of parameters 
        that has been tuned that it can get some good result for SET50 and written all 3 models (per stock) to h5 file along with list of MSE of each model on the same path of the script. 
 
        Input 
        - stock_list (String) : List of ticker in space delimited format e.g. tickerA tickerB tickerC. 
        - start_date (String) : The string of start date in format DD/MM/YYYY. 
        - end_date (String) : The string of end date in format DD/MM/YYYY. 
 
        Output 
        - No return value. 
        - Print the model training progress on the screen. 
    '''</span>

    <span class="s3"># Split the stock_list to array</span>
    <span class="s1">stock_list </span><span class="s2">= </span><span class="s1">stock_list</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">)</span>

    <span class="s3"># Convert string to datetime object</span>
    <span class="s1">start_date </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">(</span><span class="s1">start_date</span><span class="s2">, </span><span class="s5">&quot;%d/%m/%Y&quot;</span><span class="s2">)</span>
    <span class="s1">end_date </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">(</span><span class="s1">end_date</span><span class="s2">, </span><span class="s5">&quot;%d/%m/%Y&quot;</span><span class="s2">)</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">get_stock_data</span><span class="s2">(</span><span class="s1">stock_list</span><span class="s2">, </span><span class="s1">start_date</span><span class="s2">, </span><span class="s1">end_date</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;exception &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) + </span><span class="s5">&quot;on &quot; </span><span class="s2">+ </span><span class="s1">stock_list</span><span class="s2">)</span>

    <span class="s3"># Array for recording MSE from each round of training</span>
    <span class="s1">mse_list </span><span class="s2">= []</span>

    <span class="s3"># Train model to predict 1, 5 and 10 days using the best parameters from SET50 as found</span>
    <span class="s3"># Save the trained model to h5 format to be used by query price function</span>
    <span class="s0">for </span><span class="s1">stock </span><span class="s0">in </span><span class="s1">stock_list</span><span class="s2">:</span>

        <span class="s1">print</span><span class="s2">(</span><span class="s5">'start model training for stock = ' </span><span class="s2">+ </span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'. It may take at least 5 minutes...'</span><span class="s2">)</span>

        <span class="s3"># Train model for 1 day predict range by using parameters that we found from our study earlier</span>

        <span class="s3"># Set up parameters for the model</span>
        <span class="s1">predict_range </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">history_points </span><span class="s2">= </span><span class="s6">90</span>
        <span class="s1">hidden_layer </span><span class="s2">= </span><span class="s6">10</span>
        <span class="s1">batch_size </span><span class="s2">= </span><span class="s6">10</span>
        <span class="s1">epoch </span><span class="s2">= </span><span class="s6">90</span>
        <span class="s1">dropout_probability </span><span class="s2">= </span><span class="s6">0.2</span>
        <span class="s1">mode </span><span class="s2">= </span><span class="s5">'file'</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s3"># Train the model and get the MSE result</span>
            <span class="s1">model</span><span class="s2">, </span><span class="s1">scaled_mse </span><span class="s2">= </span><span class="s1">train_and_validate_stock_predictor</span><span class="s2">(</span><span class="s1">stock</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">hidden_layer</span><span class="s2">,</span>
                                                                   <span class="s1">batch_size</span><span class="s2">, </span><span class="s1">epoch</span><span class="s2">, </span><span class="s1">dropout_probability</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>
            <span class="s3"># Add stock, range of prediction and MSE result to the list</span>
            <span class="s1">mse_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">stock</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">scaled_mse</span><span class="s2">])</span>
            <span class="s3"># Save the trained model to the runtime</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'_' </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">predict_range</span><span class="s2">) + </span><span class="s5">'.h5'</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;exception &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) + </span><span class="s5">&quot;on &quot; </span><span class="s2">+ </span><span class="s1">stock</span><span class="s2">)</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">'predict rage'</span><span class="s2">, </span><span class="s5">'stock'</span><span class="s2">, </span><span class="s5">'exception'</span><span class="s2">], </span><span class="s1">data</span><span class="s2">=[[</span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">stock</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)]]).</span><span class="s1">to_csv</span><span class="s2">(</span>
                <span class="s5">'exception.csv'</span><span class="s2">)</span>
            <span class="s0">continue</span>

        <span class="s3"># Train model for 5 days predict range by using parameters that we found from our study earlier</span>

        <span class="s3"># Set up parameters for the model</span>
        <span class="s1">predict_range </span><span class="s2">= </span><span class="s6">5</span>
        <span class="s1">history_points </span><span class="s2">= </span><span class="s6">30</span>
        <span class="s1">hidden_layer </span><span class="s2">= </span><span class="s6">70</span>
        <span class="s1">batch_size </span><span class="s2">= </span><span class="s6">10</span>
        <span class="s1">epoch </span><span class="s2">= </span><span class="s6">60</span>
        <span class="s1">dropout_probability </span><span class="s2">= </span><span class="s6">0.2</span>
        <span class="s1">mode </span><span class="s2">= </span><span class="s5">'file'</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s3"># Train the model and get the MSE result</span>
            <span class="s1">model</span><span class="s2">, </span><span class="s1">scaled_mse </span><span class="s2">= </span><span class="s1">train_and_validate_stock_predictor</span><span class="s2">(</span><span class="s1">stock</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">hidden_layer</span><span class="s2">,</span>
                                                                   <span class="s1">batch_size</span><span class="s2">, </span><span class="s1">epoch</span><span class="s2">, </span><span class="s1">dropout_probability</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>
            <span class="s3"># Add stock, range of prediction and MSE result to the list</span>
            <span class="s1">mse_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">stock</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">scaled_mse</span><span class="s2">])</span>
            <span class="s3"># Save the trained model to the runtime</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'_' </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">predict_range</span><span class="s2">) + </span><span class="s5">'.keras'</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;exception &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) + </span><span class="s5">&quot;on &quot; </span><span class="s2">+ </span><span class="s1">stock</span><span class="s2">)</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">'predict rage'</span><span class="s2">, </span><span class="s5">'stock'</span><span class="s2">, </span><span class="s5">'exception'</span><span class="s2">], </span><span class="s1">data</span><span class="s2">=[[</span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">stock</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)]]).</span><span class="s1">to_csv</span><span class="s2">(</span>
                <span class="s5">'exception.csv'</span><span class="s2">)</span>
            <span class="s0">continue</span>

        <span class="s3"># Train model for 10 days predict range by using parameters that we found from our study earlier</span>
        <span class="s1">predict_range </span><span class="s2">= </span><span class="s6">10</span>
        <span class="s1">history_points </span><span class="s2">= </span><span class="s6">50</span>
        <span class="s1">hidden_layer </span><span class="s2">= </span><span class="s6">60</span>
        <span class="s1">batch_size </span><span class="s2">= </span><span class="s6">10</span>
        <span class="s1">epoch </span><span class="s2">= </span><span class="s6">80</span>
        <span class="s1">dropout_probability </span><span class="s2">= </span><span class="s6">0.2</span>
        <span class="s1">mode </span><span class="s2">= </span><span class="s5">'file'</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s3"># Train the model and get the MSE result</span>
            <span class="s1">model</span><span class="s2">, </span><span class="s1">scaled_mse </span><span class="s2">= </span><span class="s1">train_and_validate_stock_predictor</span><span class="s2">(</span><span class="s1">stock</span><span class="s2">, </span><span class="s1">history_points</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">hidden_layer</span><span class="s2">,</span>
                                                                   <span class="s1">batch_size</span><span class="s2">, </span><span class="s1">epoch</span><span class="s2">, </span><span class="s1">dropout_probability</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>
            <span class="s3"># Add stock, range of prediction and MSE result to the list</span>
            <span class="s1">mse_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">stock</span><span class="s2">, </span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">scaled_mse</span><span class="s2">])</span>
            <span class="s3"># Save the trained model to the runtime</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'_' </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">predict_range</span><span class="s2">) + </span><span class="s5">'.keras'</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;exception &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">) + </span><span class="s5">&quot;on &quot; </span><span class="s2">+ </span><span class="s1">stock</span><span class="s2">)</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">'predict rage'</span><span class="s2">, </span><span class="s5">'stock'</span><span class="s2">, </span><span class="s5">'exception'</span><span class="s2">], </span><span class="s1">data</span><span class="s2">=[[</span><span class="s1">predict_range</span><span class="s2">, </span><span class="s1">stock</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)]]).</span><span class="s1">to_csv</span><span class="s2">(</span>
                <span class="s5">'exception.csv'</span><span class="s2">)</span>
            <span class="s0">continue</span>

    <span class="s3"># Write the list of MSE from the loop to file for displaying later in query_price</span>
    <span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">mse_list</span><span class="s2">).</span><span class="s1">to_csv</span><span class="s2">(</span><span class="s5">'mse_list.csv'</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;Completed...&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">query_price</span><span class="s2">(</span><span class="s1">stock_list</span><span class="s2">, </span><span class="s1">date_range</span><span class="s2">):</span>
    <span class="s4">''' 
        Query the predicted price from the model of the stocks that were trained by providing the stock name and the date range of prediction from the end date of training data. 
        It supports only 1,5 and 10 date range. 
 
        Input 
        - stock_list (String) : List of ticker in space delimited format e.g. tickerA tickerB tickerC. 
        - date_range (Number) : The number of date range to predict the price - 1, 5 and 10 days from end date of the training data set. 
    '''</span>

    <span class="s3"># Split the stock list to array</span>
    <span class="s1">stock_list </span><span class="s2">= </span><span class="s1">stock_list</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">)</span>

    <span class="s3"># Read MSE of the trained model for each stock and each range of prediction</span>
    <span class="s1">df_mse </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s5">'mse_list.csv'</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">date_range </span><span class="s2">&lt;= </span><span class="s6">10</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">stock </span><span class="s0">in </span><span class="s1">stock_list</span><span class="s2">:</span>

            <span class="s0">try</span><span class="s2">:</span>

                <span class="s3"># Do prediction by using the same history_points value when the model is trained</span>
                <span class="s3"># The value that we use will depend on the date_range that the user select</span>
                <span class="s0">if </span><span class="s1">date_range </span><span class="s2">== </span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s1">predict_range </span><span class="s2">= </span><span class="s6">1</span>
                    <span class="s1">history_points </span><span class="s2">= </span><span class="s6">90</span>
                    <span class="s1">mode </span><span class="s2">= </span><span class="s5">'file'</span>
                <span class="s0">if </span><span class="s1">date_range </span><span class="s2">&gt; </span><span class="s6">1 </span><span class="s0">and </span><span class="s1">date_range </span><span class="s2">&lt;= </span><span class="s6">5</span><span class="s2">:</span>
                    <span class="s1">predict_range </span><span class="s2">= </span><span class="s6">5</span>
                    <span class="s1">history_points </span><span class="s2">= </span><span class="s6">30</span>
                    <span class="s1">mode </span><span class="s2">= </span><span class="s5">'file'</span>
                <span class="s0">if </span><span class="s1">date_range </span><span class="s2">&gt; </span><span class="s6">5 </span><span class="s0">and </span><span class="s1">date_range </span><span class="s2">&lt;= </span><span class="s6">10</span><span class="s2">:</span>
                    <span class="s1">predict_range </span><span class="s2">= </span><span class="s6">10</span>
                    <span class="s1">history_points </span><span class="s2">= </span><span class="s6">50</span>
                    <span class="s1">mode </span><span class="s2">= </span><span class="s5">'file'</span>

                <span class="s3"># Load the model</span>
                <span class="s1">model </span><span class="s2">= </span><span class="s1">load_model</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'_' </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">predict_range</span><span class="s2">) + </span><span class="s5">'.h5'</span><span class="s2">)</span>

                <span class="s3"># Read the data and also add MACD and EMA (in the case that mode = df, it will be used otherwise it will be skipped)</span>
                <span class="s1">df_stock </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'.csv'</span><span class="s2">)</span>
                <span class="s1">df_stock </span><span class="s2">= </span><span class="s1">add_macd_ema</span><span class="s2">(</span><span class="s1">df_stock</span><span class="s2">)</span>

                <span class="s3"># Prepare data to feed into the model to predict Adj Close</span>
                <span class="s1">ohlcv_histories</span><span class="s2">, </span><span class="s1">next_day_adj_close</span><span class="s2">, </span><span class="s1">unscaled_y</span><span class="s2">, </span><span class="s1">y_normaliser </span><span class="s2">= </span><span class="s1">dataset_preparation</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">'.csv'</span><span class="s2">,</span>
                                                                                                    <span class="s1">history_points</span><span class="s2">,</span>
                                                                                                    <span class="s1">predict_range</span><span class="s2">,</span>
                                                                                                    <span class="s1">preprocessing</span><span class="s2">.</span><span class="s1">MinMaxScaler</span><span class="s2">(),</span>
                                                                                                    <span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">,</span>
                                                                                                    <span class="s1">df</span><span class="s2">=</span><span class="s1">df_stock</span><span class="s2">)</span>

                <span class="s3"># Predict the price. The resut will be normalized (0-1)</span>
                <span class="s1">adj_predicted </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">ohlcv_histories</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ohlcv_histories</span><span class="s2">) - </span><span class="s6">1</span><span class="s2">:])</span>
                <span class="s3"># Scale up back to normal price</span>
                <span class="s1">adj_predicted </span><span class="s2">= </span><span class="s1">y_normaliser</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">adj_predicted</span><span class="s2">)</span>

                <span class="s3"># Print the result</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s1">stock </span><span class="s2">+ </span><span class="s5">' price prediction for ' </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">date_range</span><span class="s2">) + </span><span class="s5">' days : ' </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span>
                    <span class="s1">adj_predicted</span><span class="s2">[</span><span class="s6">0</span><span class="s2">][:</span><span class="s1">date_range</span><span class="s2">]))</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;Mean square error = &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span>
                    <span class="s1">df_mse</span><span class="s2">[(</span><span class="s1">df_mse</span><span class="s2">[</span><span class="s5">'0'</span><span class="s2">] == </span><span class="s1">stock</span><span class="s2">) &amp; (</span><span class="s1">df_mse</span><span class="s2">[</span><span class="s5">'1'</span><span class="s2">] == </span><span class="s1">predict_range</span><span class="s2">)][</span><span class="s5">'2'</span><span class="s2">].</span><span class="s1">values</span><span class="s2">) + </span><span class="s5">&quot; %&quot;</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;There was an error : &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">))</span>
                <span class="s0">continue</span>

    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;Support prediction from the end date of training data for 1 to 10 days only. Please try again.&quot;</span><span class="s2">)</span>



</pre>
</body>
</html>