<html>
<head>
<title>test_group.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #a5c261;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_group.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s0"># This file is part of h5py, a Python interface to the HDF5 library.</span>
<span class="s0">#</span>
<span class="s0"># http://www.h5py.org</span>
<span class="s0">#</span>
<span class="s0"># Copyright 2008-2013 Andrew Collette and contributors</span>
<span class="s0">#</span>
<span class="s0"># License:  Standard 3-clause BSD; see &quot;license.txt&quot; for full license terms</span>
<span class="s0">#           and contributor agreement.</span>

<span class="s2">&quot;&quot;&quot; 
    Group test module. 
 
    Tests all methods and properties of Group objects, with the following 
    exceptions: 
 
    1. Method create_dataset is tested in module test_dataset 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">from </span><span class="s1">tempfile </span><span class="s3">import </span><span class="s1">mkdtemp</span>

<span class="s3">from </span><span class="s1">collections</span><span class="s4">.</span><span class="s1">abc </span><span class="s3">import </span><span class="s1">MutableMapping</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">common </span><span class="s3">import </span><span class="s1">ut</span><span class="s4">, </span><span class="s1">TestCase</span>
<span class="s3">import </span><span class="s1">h5py</span>
<span class="s3">from </span><span class="s1">h5py </span><span class="s3">import </span><span class="s1">File</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">, </span><span class="s1">SoftLink</span><span class="s4">, </span><span class="s1">HardLink</span><span class="s4">, </span><span class="s1">ExternalLink</span>
<span class="s3">from </span><span class="s1">h5py </span><span class="s3">import </span><span class="s1">Dataset</span><span class="s4">, </span><span class="s1">Datatype</span>
<span class="s3">from </span><span class="s1">h5py </span><span class="s3">import </span><span class="s1">h5t</span>
<span class="s3">from </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">compat </span><span class="s3">import </span><span class="s1">filename_encode</span>

<span class="s0"># If we can't encode unicode filenames, there's not much point failing tests</span>
<span class="s0"># which must fail</span>
<span class="s3">try</span><span class="s4">:</span>
    <span class="s1">filename_encode</span><span class="s4">(</span><span class="s5">u&quot;Î±&quot;</span><span class="s4">)</span>
<span class="s3">except </span><span class="s1">UnicodeEncodeError</span><span class="s4">:</span>
    <span class="s1">NO_FS_UNICODE </span><span class="s4">= </span><span class="s3">True</span>
<span class="s3">else</span><span class="s4">:</span>
    <span class="s1">NO_FS_UNICODE </span><span class="s4">= </span><span class="s3">False</span>


<span class="s3">class </span><span class="s1">BaseGroup</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">tearDown</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

<span class="s3">class </span><span class="s1">TestCreate</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: New groups can be created via .create_group method 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Simple .create_group call &quot;&quot;&quot;</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>

        <span class="s1">grp2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s6">b'bar'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create_intermediate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Intermediate groups can be created automatically &quot;&quot;&quot;</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo/bar/baz'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'/foo/bar/baz'</span><span class="s4">)</span>

        <span class="s1">grp2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s6">b'boo/bar/baz'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp2</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'/boo/bar/baz'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create_exception</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Name conflict causes group creation to fail with ValueError &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_unicode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Unicode names are correctly stored &quot;&quot;&quot;</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s5">u&quot;/Name&quot; </span><span class="s4">+ </span><span class="s1">chr</span><span class="s4">(</span><span class="s7">0x4500</span><span class="s4">)</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">group</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">name</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">group</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">links</span><span class="s4">.</span><span class="s1">get_info</span><span class="s4">(</span><span class="s1">name</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">'utf8'</span><span class="s4">)).</span><span class="s1">cset</span><span class="s4">, </span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_UTF8</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_unicode_default</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Unicode names convertible to ASCII are stored as ASCII (issue 239) 
        &quot;&quot;&quot;</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s5">u&quot;/Hello, this is a name&quot;</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">group</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">name</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">group</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">links</span><span class="s4">.</span><span class="s1">get_info</span><span class="s4">(</span><span class="s1">name</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">'utf8'</span><span class="s4">)).</span><span class="s1">cset</span><span class="s4">, </span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Names should be strings or bytes &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s7">1.</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_appropriate_low_level_id</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot; Binding a group to a non-group identifier fails with ValueError &quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, [</span><span class="s7">1</span><span class="s4">])</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">Group</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">id</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestDatasetAssignment</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can be created by direct assignment of data 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_ndarray</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Dataset auto-creation by direct assignment &quot;&quot;&quot;</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s7">4</span><span class="s4">,</span><span class="s7">4</span><span class="s4">),</span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'a'</span><span class="s4">] = </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'a'</span><span class="s4">], </span><span class="s1">Dataset</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'a'</span><span class="s4">][...], </span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_name_bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s7">4</span><span class="s4">, </span><span class="s7">4</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s6">b'b'</span><span class="s4">] = </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s6">b'b'</span><span class="s4">], </span><span class="s1">Dataset</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestDtypeAssignment</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Named types can be created by direct assignment of dtypes 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_dtype</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Named type creation &quot;&quot;&quot;</span>
        <span class="s1">dtype </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'|S10'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'a'</span><span class="s4">] = </span><span class="s1">dtype</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'a'</span><span class="s4">], </span><span class="s1">Datatype</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'a'</span><span class="s4">].</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_name_bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Named type creation &quot;&quot;&quot;</span>
        <span class="s1">dtype </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'|S10'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s6">b'b'</span><span class="s4">] = </span><span class="s1">dtype</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s6">b'b'</span><span class="s4">], </span><span class="s1">Datatype</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestRequire</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Groups can be auto-created, or opened via .require_group 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_open_existing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Existing group is opened and returned &quot;&quot;&quot;</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">grp2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp2</span><span class="s4">, </span><span class="s1">grp</span><span class="s4">)</span>

        <span class="s1">grp3 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_group</span><span class="s4">(</span><span class="s6">b'foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp3</span><span class="s4">, </span><span class="s1">grp</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Group is created if it doesn't exist &quot;&quot;&quot;</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'/foo'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_require_exception</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening conflicting object results in TypeError &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s7">1</span><span class="s4">,), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_intermediate_create_dataset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Intermediate is created if it doesn't exist &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">&quot;foo/bar/baz&quot;</span><span class="s4">, (</span><span class="s7">1</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">group</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'foo/bar'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">group</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_intermediate_create_group</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_group</span><span class="s4">(</span><span class="s5">&quot;foo/bar/baz&quot;</span><span class="s4">)</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">group</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'foo/bar'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">group</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'foo/bar/baz'</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">group</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_require_shape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">&quot;foo/resizable&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s7">0</span><span class="s4">, </span><span class="s7">3</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s3">None</span><span class="s4">, </span><span class="s7">3</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">.</span><span class="s1">resize</span><span class="s4">(</span><span class="s7">20</span><span class="s4">, </span><span class="s1">axis</span><span class="s4">=</span><span class="s7">0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">&quot;foo/resizable&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s7">0</span><span class="s4">, </span><span class="s7">3</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s3">None</span><span class="s4">, </span><span class="s7">3</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">&quot;foo/resizable&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s7">20</span><span class="s4">, </span><span class="s7">3</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">&quot;foo/resizable&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s7">0</span><span class="s4">, </span><span class="s7">0</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s7">3</span><span class="s4">, </span><span class="s3">None</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">&quot;foo/resizable&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s7">0</span><span class="s4">, </span><span class="s7">0</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s3">None</span><span class="s4">, </span><span class="s7">5</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">&quot;foo/resizable&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s7">0</span><span class="s4">, </span><span class="s7">0</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s3">None</span><span class="s4">, </span><span class="s7">5</span><span class="s4">, </span><span class="s7">2</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">&quot;foo/resizable&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s7">10</span><span class="s4">, </span><span class="s7">3</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">int</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestDelete</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Objects can be unlinked via &quot;del&quot; operator 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_delete</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Object deletion via &quot;del&quot; &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_nonexisting</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Deleting non-existent object raises KeyError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">KeyError</span><span class="s4">):</span>
            <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">test_readonly_delete_exception</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Deleting object in readonly file raises KeyError &quot;&quot;&quot;</span>
        <span class="s0"># Note: it is impossible to restore the old behavior (ValueError)</span>
        <span class="s0"># without breaking the above test (non-existing objects)</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">hfile </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">hfile</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">hfile</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">hfile </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">KeyError</span><span class="s4">):</span>
                <span class="s3">del </span><span class="s1">hfile</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">hfile</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

<span class="s3">class </span><span class="s1">TestOpen</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Objects can be opened via indexing syntax obj[name] 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_open</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Simple obj[name] opening &quot;&quot;&quot;</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">grp2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s1">grp3 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'/foo'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">, </span><span class="s1">grp2</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">, </span><span class="s1">grp3</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_nonexistent</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening missing objects raises KeyError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">KeyError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">test_reference</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Objects can be opened by HDF5 object reference &quot;&quot;&quot;</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">grp2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s1">grp</span><span class="s4">.</span><span class="s1">ref</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp2</span><span class="s4">, </span><span class="s1">grp</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_reference_numpyobj</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Object can be opened by numpy.object_ containing object ref 
 
        Test for issue 181, issue 202. 
        &quot;&quot;&quot;</span>
        <span class="s1">g </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'test'</span><span class="s4">)</span>

        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s5">'i'</span><span class="s4">),(</span><span class="s5">'b'</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">ref_dtype</span><span class="s4">)])</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'test_dset'</span><span class="s4">, (</span><span class="s7">1</span><span class="s4">,), </span><span class="s1">dt</span><span class="s4">)</span>

        <span class="s1">dset</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] =(</span><span class="s7">42</span><span class="s4">,</span><span class="s1">g</span><span class="s4">.</span><span class="s1">ref</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">dset</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s1">data</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]], </span><span class="s1">g</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_invalid_ref</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Invalid region references should raise an exception &quot;&quot;&quot;</span>

        <span class="s1">ref </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5r</span><span class="s4">.</span><span class="s1">Reference</span><span class="s4">()</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s1">ref</span><span class="s4">]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">)</span>
        <span class="s1">ref </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">ref</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">]</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">Exception</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s1">ref</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">test_path_type_validation</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Access with non bytes or str types should raise an exception &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'group'</span><span class="s4">)</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[...]</span>

    <span class="s0"># TODO: check that regionrefs also work with __getitem__</span>

<span class="s3">class </span><span class="s1">TestRepr</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Opened and closed groups provide a useful __repr__ string&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_repr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opened and closed groups provide a useful __repr__ string &quot;&quot;&quot;</span>
        <span class="s1">g </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">g</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>
        <span class="s1">g</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">_close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">g</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>
        <span class="s1">g </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s0"># Closing the file shouldn't break it</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">g</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">BaseMapping</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Base class for mapping tests 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">groups </span><span class="s4">= (</span><span class="s5">'a'</span><span class="s4">, </span><span class="s5">'b'</span><span class="s4">, </span><span class="s5">'c'</span><span class="s4">, </span><span class="s5">'d'</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">] = </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'/mongoose'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">groups </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups </span><span class="s4">+ (</span><span class="s5">'x'</span><span class="s4">,)</span>

    <span class="s3">def </span><span class="s1">tearDown</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

<span class="s3">class </span><span class="s1">TestLen</span><span class="s4">(</span><span class="s1">BaseMapping</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: The Python len() function returns the number of groups 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; len() returns number of group members &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">), </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'e'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">), </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">)+</span><span class="s7">1</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestContains</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: The Python &quot;in&quot; builtin tests for membership 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_contains</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; &quot;in&quot; builtin works for membership (byte and Unicode) &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s6">b'a'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s6">b'/a'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'/a'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s6">b'mongoose'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s5">'mongoose'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_exc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; &quot;in&quot; on closed group returns False (see also issue 174) &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s6">b'a' </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s5">'a' </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_empty</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Empty strings work properly and aren't contained &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s5">''</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s6">b''</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dot</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Current group &quot;.&quot; is always contained &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s6">b'.'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_root</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Root group (by itself) is contained &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s6">b'/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_trailing_slash</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Trailing slashes are unconditionally ignored &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'group'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'dataset'</span><span class="s4">] = </span><span class="s7">42</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'/group/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'group/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'/dataset/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'dataset/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_softlinks</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Broken softlinks are contained, but their members are not &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'grp'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'/grp/soft'</span><span class="s4">] = </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'/mongoose'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'/grp/external'</span><span class="s4">] = </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s5">'mongoose.hdf5'</span><span class="s4">, </span><span class="s5">'/mongoose'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'/grp/soft'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s5">'/grp/soft/something'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'/grp/external'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s5">'/grp/external/something'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_oddball_paths</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Technically legitimate (but odd-looking) paths &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'x/y/z'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'dset'</span><span class="s4">] = </span><span class="s7">42</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'//'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'///'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'.///'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'././/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'.//x/y/z'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s5">'.//x/y/z'</span><span class="s4">, </span><span class="s1">grp</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'x///'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'./x///'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'dset///'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'/dset//'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestIter</span><span class="s4">(</span><span class="s1">BaseMapping</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: You can iterate over group members via &quot;for x in y&quot;, etc. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; &quot;for x in y&quot; iteration &quot;&quot;&quot;</span>
        <span class="s1">lst </span><span class="s4">= [</span><span class="s1">x </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">lst</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_iter_zero</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Iteration works properly for the case with no group members &quot;&quot;&quot;</span>
        <span class="s1">hfile </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">lst </span><span class="s4">= [</span><span class="s1">x </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">hfile</span><span class="s4">]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">lst</span><span class="s4">, [])</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">hfile</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

<span class="s3">class </span><span class="s1">TestTrackOrder</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">populate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">g</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s7">100</span><span class="s4">):</span>
            <span class="s0"># Mix group and dataset creation.</span>
            <span class="s3">if </span><span class="s1">i </span><span class="s4">% </span><span class="s7">10 </span><span class="s4">== </span><span class="s7">0</span><span class="s4">:</span>
                <span class="s1">g</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">i</span><span class="s4">))</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">g</span><span class="s4">[</span><span class="s1">str</span><span class="s4">(</span><span class="s1">i</span><span class="s4">)] = [</span><span class="s1">i</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">test_track_order</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">g </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'order'</span><span class="s4">, </span><span class="s1">track_order</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)  </span><span class="s0"># creation order</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">populate</span><span class="s4">(</span><span class="s1">g</span><span class="s4">)</span>

        <span class="s1">ref </span><span class="s4">= [</span><span class="s1">str</span><span class="s4">(</span><span class="s1">i</span><span class="s4">) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s7">100</span><span class="s4">)]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">g</span><span class="s4">), </span><span class="s1">ref</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">g</span><span class="s4">)), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">ref</span><span class="s4">)))</span>

    <span class="s3">def </span><span class="s1">test_no_track_order</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">g </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'order'</span><span class="s4">, </span><span class="s1">track_order</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)  </span><span class="s0"># name alphanumeric</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">populate</span><span class="s4">(</span><span class="s1">g</span><span class="s4">)</span>

        <span class="s1">ref </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">([</span><span class="s1">str</span><span class="s4">(</span><span class="s1">i</span><span class="s4">) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s7">100</span><span class="s4">)])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">g</span><span class="s4">), </span><span class="s1">ref</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">g</span><span class="s4">)), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">ref</span><span class="s4">)))</span>

<span class="s3">class </span><span class="s1">TestPy3Dict</span><span class="s4">(</span><span class="s1">BaseMapping</span><span class="s4">):</span>

    <span class="s3">def </span><span class="s1">test_keys</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; .keys provides a key view &quot;&quot;&quot;</span>
        <span class="s1">kv </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">, </span><span class="s5">'keys'</span><span class="s4">)()</span>
        <span class="s1">ref </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">kv</span><span class="s4">), </span><span class="s1">ref</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">kv</span><span class="s4">)), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">ref</span><span class="s4">)))</span>

        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">kv</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">kv</span><span class="s4">), </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_values</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; .values provides a value view &quot;&quot;&quot;</span>
        <span class="s1">vv </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">, </span><span class="s5">'values'</span><span class="s4">)()</span>
        <span class="s1">ref </span><span class="s4">= [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">x</span><span class="s4">) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">vv</span><span class="s4">), </span><span class="s1">ref</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">vv</span><span class="s4">)), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">ref</span><span class="s4">)))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">vv</span><span class="s4">), </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">))</span>
        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">x</span><span class="s4">), </span><span class="s1">vv</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_items</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; .items provides an item view &quot;&quot;&quot;</span>
        <span class="s1">iv </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">, </span><span class="s5">'items'</span><span class="s4">)()</span>
        <span class="s1">ref </span><span class="s4">= [(</span><span class="s1">x</span><span class="s4">,</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">iv</span><span class="s4">), </span><span class="s1">ref</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">iv</span><span class="s4">)), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">reversed</span><span class="s4">(</span><span class="s1">ref</span><span class="s4">)))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">iv</span><span class="s4">), </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">))</span>
        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">((</span><span class="s1">x</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)), </span><span class="s1">iv</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestAdditionalMappingFuncs</span><span class="s4">(</span><span class="s1">BaseMapping</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Feature: Other dict methods (pop, pop_item, clear, update, setdefault) are 
    available. 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s4">(</span><span class="s5">'/test/a'</span><span class="s4">, </span><span class="s5">'/test/b'</span><span class="s4">, </span><span class="s5">'/test/c'</span><span class="s4">, </span><span class="s5">'/test/d'</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">group </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">tearDown</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_pop_item</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.pop_item exists and removes item&quot;&quot;&quot;</span>
        <span class="s1">key</span><span class="s4">, </span><span class="s1">val </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">popitem</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_pop</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.pop exists and removes specified item&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIn</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_pop_default</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.pop falls back to default&quot;&quot;&quot;</span>
        <span class="s0"># e shouldn't exist as a group</span>
        <span class="s1">value </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">'e'</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_pop_raises</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.pop raises KeyError for non-existence&quot;&quot;&quot;</span>
        <span class="s0"># e shouldn't exist as a group</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">KeyError</span><span class="s4">):</span>
            <span class="s1">key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">'e'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_clear</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.clear removes groups&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">clear</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">), </span><span class="s7">0</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_update_dict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.update works with dict&quot;&quot;&quot;</span>
        <span class="s1">new_items </span><span class="s4">= {</span><span class="s5">'e'</span><span class="s4">: </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">42</span><span class="s4">])}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">new_items</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'e'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_update_iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.update works with list&quot;&quot;&quot;</span>
        <span class="s1">new_items </span><span class="s4">= [</span>
            <span class="s4">(</span><span class="s5">'e'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">42</span><span class="s4">])),</span>
            <span class="s4">(</span><span class="s5">'f'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">42</span><span class="s4">]))</span>
        <span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">new_items</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'e'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_update_kwargs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.update works with kwargs&quot;&quot;&quot;</span>
        <span class="s1">new_items </span><span class="s4">= {</span><span class="s5">'e'</span><span class="s4">: </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">42</span><span class="s4">])}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(**</span><span class="s1">new_items</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">'e'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_setdefault</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.setdefault gets group if it exists&quot;&quot;&quot;</span>
        <span class="s1">value </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_setdefault_with_default</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;.setdefault gets default if group doesn't exist&quot;&quot;&quot;</span>
        <span class="s0"># e shouldn't exist as a group</span>
        <span class="s0"># 42 used as groups should be strings</span>
        <span class="s1">value </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s5">'e'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">42</span><span class="s4">]))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s7">42</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_setdefault_no_default</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; 
        .setdefault gets None if group doesn't exist, but as None isn't defined 
        as data for a dataset, this should raise a TypeError. 
        &quot;&quot;&quot;</span>
        <span class="s0"># e shouldn't exist as a group</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">group</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s5">'e'</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestGet</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: The .get method allows access to objects and metadata 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_get_default</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Object is returned, or default if it doesn't exist &quot;&quot;&quot;</span>
        <span class="s1">default </span><span class="s4">= </span><span class="s1">object</span><span class="s4">()</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'mongoose'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIs</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">default</span><span class="s4">)</span>

        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">b'a'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">grp</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_get_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Object class is returned with getclass option &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">getclass</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, (</span><span class="s7">4</span><span class="s4">,))</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, </span><span class="s1">getclass</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">Dataset</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'|S10'</span><span class="s4">)</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'baz'</span><span class="s4">, </span><span class="s1">getclass</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">Datatype</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_get_link_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Get link classes &quot;&quot;&quot;</span>
        <span class="s1">default </span><span class="s4">= </span><span class="s1">object</span><span class="s4">()</span>

        <span class="s1">sl </span><span class="s4">= </span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'/mongoose'</span><span class="s4">)</span>
        <span class="s1">el </span><span class="s4">= </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s5">'somewhere.hdf5'</span><span class="s4">, </span><span class="s5">'mongoose'</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'hard'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'soft'</span><span class="s4">] = </span><span class="s1">sl</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'external'</span><span class="s4">] = </span><span class="s1">el</span>

        <span class="s1">out_hl </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'hard'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">, </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">getclass</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">out_sl </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'soft'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">, </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">getclass</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">out_el </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'external'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">, </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">getclass</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out_hl</span><span class="s4">, </span><span class="s1">HardLink</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out_sl</span><span class="s4">, </span><span class="s1">SoftLink</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out_el</span><span class="s4">, </span><span class="s1">ExternalLink</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_get_link</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Get link values &quot;&quot;&quot;</span>
        <span class="s1">sl </span><span class="s4">= </span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'/mongoose'</span><span class="s4">)</span>
        <span class="s1">el </span><span class="s4">= </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s5">'somewhere.hdf5'</span><span class="s4">, </span><span class="s5">'mongoose'</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'hard'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'soft'</span><span class="s4">] = </span><span class="s1">sl</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'external'</span><span class="s4">] = </span><span class="s1">el</span>

        <span class="s1">out_hl </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'hard'</span><span class="s4">, </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">out_sl </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'soft'</span><span class="s4">, </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">out_el </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'external'</span><span class="s4">, </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

        <span class="s0">#TODO: redo with SoftLink/ExternalLink built-in equality</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">out_hl</span><span class="s4">, </span><span class="s1">HardLink</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">out_sl</span><span class="s4">, </span><span class="s1">SoftLink</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out_sl</span><span class="s4">.</span><span class="s1">_path</span><span class="s4">, </span><span class="s1">sl</span><span class="s4">.</span><span class="s1">_path</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">out_el</span><span class="s4">, </span><span class="s1">ExternalLink</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out_el</span><span class="s4">.</span><span class="s1">_path</span><span class="s4">, </span><span class="s1">el</span><span class="s4">.</span><span class="s1">_path</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out_el</span><span class="s4">.</span><span class="s1">_filename</span><span class="s4">, </span><span class="s1">el</span><span class="s4">.</span><span class="s1">_filename</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestVisit</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: The .visit and .visititems methods allow iterative access to 
        group and subgroup members 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">groups </span><span class="s4">= [</span>
            <span class="s5">'grp1'</span><span class="s4">, </span><span class="s5">'grp1/sg1'</span><span class="s4">, </span><span class="s5">'grp1/sg2'</span><span class="s4">, </span><span class="s5">'grp2'</span><span class="s4">, </span><span class="s5">'grp2/sg1'</span><span class="s4">, </span><span class="s5">'grp2/sg1/ssg1'</span>
            <span class="s4">]</span>
        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">tearDown</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_visit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; All subgroups are visited &quot;&quot;&quot;</span>
        <span class="s1">l </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">l</span><span class="s4">.</span><span class="s1">append</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">l</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_visititems</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; All subgroups and contents are visited &quot;&quot;&quot;</span>
        <span class="s1">l </span><span class="s4">= []</span>
        <span class="s1">comp </span><span class="s4">= [(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s1">x</span><span class="s4">]) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">visititems</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">: </span><span class="s1">l</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">x</span><span class="s4">,</span><span class="s1">y</span><span class="s4">)))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">comp</span><span class="s4">, </span><span class="s1">l</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_bailout</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Returning a non-None value immediately aborts iteration &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: </span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">[</span><span class="s7">0</span><span class="s4">])</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">visititems</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">: (</span><span class="s1">x</span><span class="s4">,</span><span class="s1">y</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">[</span><span class="s7">0</span><span class="s4">], </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]]))</span>

<span class="s3">class </span><span class="s1">TestVisitLinks</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
        Feature: The .visit_links and .visititems_links methods allow iterative access to 
        links contained in the group and its subgroups. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">groups </span><span class="s4">= [</span>
            <span class="s5">'grp1'</span><span class="s4">, </span><span class="s5">'grp1/grp11'</span><span class="s4">, </span><span class="s5">'grp1/grp12'</span><span class="s4">, </span><span class="s5">'grp2'</span><span class="s4">, </span><span class="s5">'grp2/grp21'</span><span class="s4">, </span><span class="s5">'grp2/grp21/grp211'</span>
            <span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">links </span><span class="s4">= [</span>
            <span class="s5">'linkto_grp1'</span><span class="s4">, </span><span class="s5">'grp1/linkto_grp11'</span><span class="s4">, </span><span class="s5">'grp1/linkto_grp12'</span><span class="s4">, </span><span class="s5">'linkto_grp2'</span><span class="s4">, </span><span class="s5">'grp2/linkto_grp21'</span><span class="s4">, </span><span class="s5">'grp2/grp21/linkto_grp211'</span>
        <span class="s4">]</span>
        <span class="s3">for </span><span class="s1">g</span><span class="s4">, </span><span class="s1">l </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">links</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s1">g</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s1">l</span><span class="s4">] = </span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">f'/</span><span class="s3">{</span><span class="s1">g</span><span class="s3">}</span><span class="s5">'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">tearDown</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_visit_links</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; All subgroups and links are visited &quot;&quot;&quot;</span>
        <span class="s1">l </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">visit_links</span><span class="s4">(</span><span class="s1">l</span><span class="s4">.</span><span class="s1">append</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">l</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">links</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_visititems</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; All links are visited &quot;&quot;&quot;</span>
        <span class="s1">l </span><span class="s4">= []</span>
        <span class="s1">comp </span><span class="s4">= [(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">))) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">links</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">visititems_links</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">: </span><span class="s1">l</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">x</span><span class="s4">, </span><span class="s1">type</span><span class="s4">(</span><span class="s1">y</span><span class="s4">))))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertSameElements</span><span class="s4">(</span><span class="s1">comp</span><span class="s4">, </span><span class="s1">l</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_bailout</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Returning a non-None value immediately aborts iteration &quot;&quot;&quot;</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">visit_links</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: </span><span class="s1">x</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">[</span><span class="s7">0</span><span class="s4">])</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">visititems_links</span><span class="s4">(</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">: (</span><span class="s1">x</span><span class="s4">,</span><span class="s1">type</span><span class="s4">(</span><span class="s1">y</span><span class="s4">)))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">[</span><span class="s7">0</span><span class="s4">], </span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">[</span><span class="s7">0</span><span class="s4">], </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">))))</span>


<span class="s3">class </span><span class="s1">TestSoftLinks</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Create and manage soft links with the high-level interface 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_spath</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; SoftLink path attribute &quot;&quot;&quot;</span>
        <span class="s1">sl </span><span class="s4">= </span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'/foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">sl</span><span class="s4">.</span><span class="s1">path</span><span class="s4">, </span><span class="s5">'/foo'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_srepr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; SoftLink path repr &quot;&quot;&quot;</span>
        <span class="s1">sl </span><span class="s4">= </span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'/foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">sl</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create new soft link by assignment &quot;&quot;&quot;</span>
        <span class="s1">g </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'new'</span><span class="s4">)</span>
        <span class="s1">sl </span><span class="s4">= </span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'/new'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'alias'</span><span class="s4">] = </span><span class="s1">sl</span>
        <span class="s1">g2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'alias'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">g</span><span class="s4">, </span><span class="s1">g2</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_exc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Opening dangling soft link results in KeyError &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'alias'</span><span class="s4">] = </span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'new'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">KeyError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'alias'</span><span class="s4">]</span>

<span class="s3">class </span><span class="s1">TestExternalLinks</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Create and manage external links 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ename </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ef </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ename</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ef</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'external'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ef</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">tearDown</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ef</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">ef</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_epath</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; External link paths attributes &quot;&quot;&quot;</span>
        <span class="s1">el </span><span class="s4">= </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s5">'foo.hdf5'</span><span class="s4">, </span><span class="s5">'/foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">el</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'foo.hdf5'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">el</span><span class="s4">.</span><span class="s1">path</span><span class="s4">, </span><span class="s5">'/foo'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_erepr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; External link repr &quot;&quot;&quot;</span>
        <span class="s1">el </span><span class="s4">= </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s5">'foo.hdf5'</span><span class="s4">,</span><span class="s5">'/foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">el</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Creating external links &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ename</span><span class="s4">, </span><span class="s5">'/external'</span><span class="s4">)</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ef </span><span class="s4">= </span><span class="s1">grp</span><span class="s4">.</span><span class="s1">file</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ef</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s5">'/external'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_exc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; KeyError raised when attempting to open broken link &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ename</span><span class="s4">, </span><span class="s5">'/missing'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">KeyError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">]</span>

    <span class="s0"># I would prefer OSError but there's no way to fix this as the exception</span>
    <span class="s0"># class is determined by HDF5.</span>
    <span class="s3">def </span><span class="s1">test_exc_missingfile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; KeyError raised when attempting to open missing file &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s5">'mongoose.hdf5'</span><span class="s4">,</span><span class="s5">'/foo'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">KeyError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">test_close_file</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Files opened by accessing external links can be closed 
 
        Issue 189. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ename</span><span class="s4">, </span><span class="s5">'/'</span><span class="s4">)</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">]</span>
        <span class="s1">f2 </span><span class="s4">= </span><span class="s1">grp</span><span class="s4">.</span><span class="s1">file</span>
        <span class="s1">f2</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">f2</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s1">NO_FS_UNICODE</span><span class="s4">, </span><span class="s5">&quot;No unicode filename support&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_unicode_encode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; 
        Check that external links encode unicode filenames properly 
        Testing issue #732 
        &quot;&quot;&quot;</span>
        <span class="s1">ext_filename </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">mkdtemp</span><span class="s4">(), </span><span class="s5">u&quot;Î±.hdf5&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">ext_filename</span><span class="s4">, </span><span class="s5">&quot;w&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">ext_file</span><span class="s4">:</span>
            <span class="s1">ext_file</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'external'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">ext_filename</span><span class="s4">, </span><span class="s5">'/external'</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s1">NO_FS_UNICODE</span><span class="s4">, </span><span class="s5">&quot;No unicode filename support&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_unicode_decode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; 
        Check that external links decode unicode filenames properly 
        Testing issue #732 
        &quot;&quot;&quot;</span>
        <span class="s1">ext_filename </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">mkdtemp</span><span class="s4">(), </span><span class="s5">u&quot;Î±.hdf5&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">ext_filename</span><span class="s4">, </span><span class="s5">&quot;w&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">ext_file</span><span class="s4">:</span>
            <span class="s1">ext_file</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'external'</span><span class="s4">)</span>
            <span class="s1">ext_file</span><span class="s4">[</span><span class="s5">&quot;external&quot;</span><span class="s4">].</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">&quot;ext_attr&quot;</span><span class="s4">] = </span><span class="s5">&quot;test&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">ext_filename</span><span class="s4">, </span><span class="s5">'/external'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">&quot;ext&quot;</span><span class="s4">].</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">&quot;ext_attr&quot;</span><span class="s4">], </span><span class="s5">&quot;test&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_unicode_hdf5_path</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; 
        Check that external links handle unicode hdf5 paths properly 
        Testing issue #333 
        &quot;&quot;&quot;</span>
        <span class="s1">ext_filename </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">mkdtemp</span><span class="s4">(), </span><span class="s5">&quot;external.hdf5&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">ext_filename</span><span class="s4">, </span><span class="s5">&quot;w&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">ext_file</span><span class="s4">:</span>
            <span class="s1">ext_file</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'Î±'</span><span class="s4">)</span>
            <span class="s1">ext_file</span><span class="s4">[</span><span class="s5">&quot;Î±&quot;</span><span class="s4">].</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">&quot;ext_attr&quot;</span><span class="s4">] = </span><span class="s5">&quot;test&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'ext'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">ext_filename</span><span class="s4">, </span><span class="s5">'/Î±'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">&quot;ext&quot;</span><span class="s4">].</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">&quot;ext_attr&quot;</span><span class="s4">], </span><span class="s5">&quot;test&quot;</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestExtLinkBugs</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Bugs: Specific regressions for external links 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_issue_212</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Issue 212 
 
        Fails with: 
 
        AttributeError: 'SharedConfig' object has no attribute 'lapl' 
        &quot;&quot;&quot;</span>
        <span class="s3">def </span><span class="s1">closer</span><span class="s4">(</span><span class="s1">x</span><span class="s4">):</span>
            <span class="s3">def </span><span class="s1">w</span><span class="s4">():</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">x</span><span class="s4">:</span>
                        <span class="s1">x</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
                <span class="s3">except </span><span class="s1">OSError</span><span class="s4">:</span>
                    <span class="s3">pass</span>
            <span class="s3">return </span><span class="s1">w</span>
        <span class="s1">orig_name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">new_name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">orig_name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">addCleanup</span><span class="s4">(</span><span class="s1">closer</span><span class="s4">(</span><span class="s1">f</span><span class="s4">))</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">g </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">new_name</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">addCleanup</span><span class="s4">(</span><span class="s1">closer</span><span class="s4">(</span><span class="s1">g</span><span class="s4">))</span>
        <span class="s1">g</span><span class="s4">[</span><span class="s5">'link'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">orig_name</span><span class="s4">, </span><span class="s5">'/'</span><span class="s4">)  </span><span class="s0"># note root group</span>
        <span class="s1">g</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

        <span class="s1">h </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">new_name</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">addCleanup</span><span class="s4">(</span><span class="s1">closer</span><span class="s4">(</span><span class="s1">h</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">h</span><span class="s4">[</span><span class="s5">'link'</span><span class="s4">][</span><span class="s5">'a'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestCopy</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>

    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1 </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f2 </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">tearDown</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_copy_path_to_path</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">foo</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">)</span>
        <span class="s1">baz </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

    <span class="s3">def </span><span class="s1">test_copy_path_to_group</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">foo</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>
        <span class="s1">baz </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'baz'</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">baz</span><span class="s4">)</span>
        <span class="s1">baz </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">[</span><span class="s5">'foo/bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'/'</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'/foo'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo/bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

    <span class="s3">def </span><span class="s1">test_copy_group_to_path</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>

        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">foo</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">)</span>
        <span class="s1">baz </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'/foo'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo/bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

    <span class="s3">def </span><span class="s1">test_copy_group_to_group</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>

        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">foo</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>
        <span class="s1">baz </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'baz'</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s1">baz</span><span class="s4">)</span>
        <span class="s1">baz </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">[</span><span class="s5">'foo/bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'/'</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'/foo'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo/bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

    <span class="s3">def </span><span class="s1">test_copy_dataset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>
        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;grp&quot;</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'bar'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s1">grp</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'/grp/foo'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">], </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">, </span><span class="s5">'bar'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

    <span class="s3">def </span><span class="s1">test_copy_shallow</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>

        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">bar </span><span class="s4">= </span><span class="s1">foo</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">)</span>
        <span class="s1">foo</span><span class="s4">[</span><span class="s5">'qux'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>
        <span class="s1">bar</span><span class="s4">[</span><span class="s5">'quux'</span><span class="s4">] = [</span><span class="s7">4</span><span class="s4">,</span><span class="s7">5</span><span class="s4">,</span><span class="s7">6</span><span class="s4">]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">, </span><span class="s1">shallow</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">baz </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">]), </span><span class="s7">0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">baz</span><span class="s4">[</span><span class="s5">'qux'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shallow</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'/foo'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo/bar'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo/bar'</span><span class="s4">]), </span><span class="s7">0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo/qux'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

    <span class="s3">def </span><span class="s1">test_copy_without_attributes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>
        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s1">foo</span><span class="s4">.</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = [</span><span class="s7">4</span><span class="s4">,</span><span class="s7">5</span><span class="s4">,</span><span class="s7">6</span><span class="s4">]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">, </span><span class="s1">without_attrs</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>
        <span class="s3">assert </span><span class="s5">'bar' </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">].</span><span class="s1">attrs</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">, </span><span class="s1">without_attrs</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>
        <span class="s3">assert </span><span class="s5">'bar' </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">].</span><span class="s1">attrs</span>

    <span class="s3">def </span><span class="s1">test_copy_soft_links</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s7">3</span><span class="s4">]</span>
        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">foo</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">] = </span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">'/bar'</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'qux'</span><span class="s4">, </span><span class="s1">expand_soft</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">expand_soft</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'qux'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'qux/baz'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'/foo'</span><span class="s4">], </span><span class="s1">Group</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'foo/baz'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s7">3</span><span class="s4">]))</span>

    <span class="s3">def </span><span class="s1">test_copy_external_links</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>

        <span class="s1">filename </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = </span><span class="s1">ExternalLink</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1 </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">, </span><span class="s1">expand_external</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">os</span><span class="s4">.</span><span class="s1">unlink</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>

    <span class="s3">def </span><span class="s1">test_copy_refs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">] = [</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = [</span><span class="s7">4</span><span class="s4">,</span><span class="s7">5</span><span class="s4">,</span><span class="s7">6</span><span class="s4">]</span>
        <span class="s1">foo </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">]</span>
        <span class="s1">bar </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">]</span>
        <span class="s1">foo</span><span class="s4">.</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">] = </span><span class="s1">bar</span><span class="s4">.</span><span class="s1">ref</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">, </span><span class="s1">expand_refs</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>
        <span class="s1">baz_bar </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">].</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s1">baz_bar</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">4</span><span class="s4">,</span><span class="s7">5</span><span class="s4">,</span><span class="s7">6</span><span class="s4">]))</span>
        <span class="s0"># The reference points to a copy of bar, not to bar itself.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">[</span><span class="s1">baz_bar</span><span class="s4">].</span><span class="s1">name</span><span class="s4">, </span><span class="s1">bar</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">, </span><span class="s5">'baz'</span><span class="s4">, </span><span class="s1">expand_refs</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>
        <span class="s1">baz_bar </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'baz'</span><span class="s4">].</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s1">baz_bar</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">4</span><span class="s4">,</span><span class="s7">5</span><span class="s4">,</span><span class="s7">6</span><span class="s4">]))</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f1</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s5">'/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">, </span><span class="s5">'root'</span><span class="s4">, </span><span class="s1">expand_refs</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'root/foo'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">1</span><span class="s4">,</span><span class="s7">2</span><span class="s4">,</span><span class="s7">3</span><span class="s4">]))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'root/bar'</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">4</span><span class="s4">,</span><span class="s7">5</span><span class="s4">,</span><span class="s7">6</span><span class="s4">]))</span>
        <span class="s1">foo_bar </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'root/foo'</span><span class="s4">].</span><span class="s1">attrs</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s1">foo_bar</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">4</span><span class="s4">,</span><span class="s7">5</span><span class="s4">,</span><span class="s7">6</span><span class="s4">]))</span>
        <span class="s0"># There's only one copy of bar, which the reference points to.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s1">foo_bar</span><span class="s4">], </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f2</span><span class="s4">[</span><span class="s5">'root/bar'</span><span class="s4">])</span>


<span class="s3">class </span><span class="s1">TestMove</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Group.move moves links in a file 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_move_hardlink</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Moving an object &quot;&quot;&quot;</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;X&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">move</span><span class="s4">(</span><span class="s5">&quot;X&quot;</span><span class="s4">, </span><span class="s5">&quot;Y&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">&quot;Y&quot;</span><span class="s4">], </span><span class="s1">grp</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">move</span><span class="s4">(</span><span class="s5">&quot;Y&quot;</span><span class="s4">, </span><span class="s5">&quot;new/nested/path&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'new/nested/path'</span><span class="s4">], </span><span class="s1">grp</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_move_softlink</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Moving a soft link &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'soft'</span><span class="s4">] = </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">SoftLink</span><span class="s4">(</span><span class="s5">&quot;relative/path&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">move</span><span class="s4">(</span><span class="s5">'soft'</span><span class="s4">, </span><span class="s5">'new_soft'</span><span class="s4">)</span>
        <span class="s1">lnk </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">'new_soft'</span><span class="s4">, </span><span class="s1">getlink</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">lnk</span><span class="s4">.</span><span class="s1">path</span><span class="s4">, </span><span class="s5">&quot;relative/path&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_move_conflict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Move conflict raises ValueError &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;X&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;Y&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">move</span><span class="s4">(</span><span class="s5">&quot;X&quot;</span><span class="s4">, </span><span class="s5">&quot;Y&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_short_circuit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">''' Test that a null-move works '''</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;X&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">move</span><span class="s4">(</span><span class="s5">&quot;X&quot;</span><span class="s4">, </span><span class="s5">&quot;X&quot;</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestMutableMapping</span><span class="s4">(</span><span class="s1">BaseGroup</span><span class="s4">):</span>
    <span class="s2">'''Tests if the registration of Group as a MutableMapping 
    behaves as expected 
    '''</span>
    <span class="s3">def </span><span class="s1">test_resolution</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">issubclass</span><span class="s4">(</span><span class="s1">Group</span><span class="s4">, </span><span class="s1">MutableMapping</span><span class="s4">)</span>
        <span class="s1">grp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">&quot;K&quot;</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">grp</span><span class="s4">, </span><span class="s1">MutableMapping</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_validity</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">''' 
        Test that the required functions are implemented. 
        '''</span>
        <span class="s1">Group</span><span class="s4">.</span><span class="s1">__getitem__</span>
        <span class="s1">Group</span><span class="s4">.</span><span class="s1">__setitem__</span>
        <span class="s1">Group</span><span class="s4">.</span><span class="s1">__delitem__</span>
        <span class="s1">Group</span><span class="s4">.</span><span class="s1">__iter__</span>
        <span class="s1">Group</span><span class="s4">.</span><span class="s1">__len__</span>
</pre>
</body>
</html>