<html>
<head>
<title>mobilenet_v3.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
mobilenet_v3.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src </span><span class="s0">import </span><span class="s1">backend</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src </span><span class="s0">import </span><span class="s1">layers</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">api_export </span><span class="s0">import </span><span class="s1">keras_export</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">applications </span><span class="s0">import </span><span class="s1">imagenet_utils</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">Functional</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">ops </span><span class="s0">import </span><span class="s1">operation_utils</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">file_utils</span>

<span class="s1">BASE_WEIGHT_PATH </span><span class="s2">= (</span>
    <span class="s3">&quot;https://storage.googleapis.com/tensorflow/keras-applications/mobilenet_v3/&quot;</span>
<span class="s2">)</span>
<span class="s1">WEIGHTS_HASHES </span><span class="s2">= {</span>
    <span class="s3">&quot;large_224_0.75_float&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;765b44a33ad4005b3ac83185abf1d0eb&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;40af19a13ebea4e2ee0c676887f69a2e&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;large_224_1.0_float&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;59e551e166be033d707958cf9e29a6a7&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;07fb09a5933dd0c8eaafa16978110389&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;large_minimalistic_224_1.0_float&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;675e7b876c45c57e9e63e6d90a36599c&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;ec5221f64a2f6d1ef965a614bdae7973&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;small_224_0.75_float&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;cb65d4e5be93758266aa0a7f2c6708b7&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;ebdb5cc8e0b497cd13a7c275d475c819&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;small_224_1.0_float&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;8768d4c2e7dee89b9d02b2d03d65d862&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;d3e8ec802a04aa4fc771ee12a9a9b836&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;small_minimalistic_224_1.0_float&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;99cd97fb2fcdad2bf028eb838de69e37&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;cde8136e733e811080d9fcd8a252f7e4&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
<span class="s2">}</span>


<span class="s1">BASE_DOCSTRING </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;Instantiates the {name} architecture. 
 
Reference: 
- [Searching for MobileNetV3]( 
    https://arxiv.org/pdf/1905.02244.pdf) (ICCV 2019) 
 
The following table describes the performance of MobileNets v3: 
------------------------------------------------------------------------ 
MACs stands for Multiply Adds 
 
|Classification Checkpoint|MACs(M)|Parameters(M)|Top1 Accuracy|Pixel1 CPU(ms)| 
|---|---|---|---|---| 
| mobilenet_v3_large_1.0_224              | 217 | 5.4 |   75.6   |   51.2  | 
| mobilenet_v3_large_0.75_224             | 155 | 4.0 |   73.3   |   39.8  | 
| mobilenet_v3_large_minimalistic_1.0_224 | 209 | 3.9 |   72.3   |   44.1  | 
| mobilenet_v3_small_1.0_224              | 66  | 2.9 |   68.1   |   15.8  | 
| mobilenet_v3_small_0.75_224             | 44  | 2.4 |   65.4   |   12.8  | 
| mobilenet_v3_small_minimalistic_1.0_224 | 65  | 2.0 |   61.9   |   12.2  | 
 
For image classification use cases, see 
[this page for detailed examples]( 
https://keras.io/api/applications/#usage-examples-for-image-classification-models). 
 
For transfer learning use cases, make sure to read the 
[guide to transfer learning &amp; fine-tuning]( 
https://keras.io/guides/transfer_learning/). 
 
Note: each Keras Application expects a specific kind of input preprocessing. 
For MobileNetV3, by default input preprocessing is included as a part of the 
model (as a `Rescaling` layer), and thus 
`keras.applications.mobilenet_v3.preprocess_input` is actually a 
pass-through function. In this use case, MobileNetV3 models expect their 
inputs to be float tensors of pixels with values in the `[0-255]` range. 
At the same time, preprocessing as a part of the model (i.e. `Rescaling` 
layer) can be disabled by setting `include_preprocessing` argument to `False`. 
With preprocessing disabled MobileNetV3 models expect their inputs to be float 
tensors of pixels with values in the `[-1, 1]` range. 
 
Args: 
    input_shape: Optional shape tuple, to be specified if you would 
        like to use a model with an input image resolution that is not 
        `(224, 224, 3)`. 
        It should have exactly 3 inputs channels. 
        You can also omit this option if you would like 
        to infer input_shape from an input_tensor. 
        If you choose to include both input_tensor and input_shape then 
        input_shape will be used if they match, if the shapes 
        do not match then we will throw an error. 
        E.g. `(160, 160, 3)` would be one valid value. 
    alpha: controls the width of the network. This is known as the 
        depth multiplier in the MobileNetV3 paper, but the name is kept for 
        consistency with MobileNetV1 in Keras. 
        - If `alpha &lt; 1.0`, proportionally decreases the number 
            of filters in each layer. 
        - If `alpha &gt; 1.0`, proportionally increases the number 
            of filters in each layer. 
        - If `alpha == 1`, default number of filters from the paper 
            are used at each layer. 
    minimalistic: In addition to large and small models this module also 
        contains so-called minimalistic models, these models have the same 
        per-layer dimensions characteristic as MobilenetV3 however, they don't 
        utilize any of the advanced blocks (squeeze-and-excite units, 
        hard-swish, and 5x5 convolutions). 
        While these models are less efficient on CPU, they 
        are much more performant on GPU/DSP. 
    include_top: Boolean, whether to include the fully-connected 
        layer at the top of the network. Defaults to `True`. 
    weights: String, one of `None` (random initialization), 
        `&quot;imagenet&quot;` (pre-training on ImageNet), 
        or the path to the weights file to be loaded. 
    input_tensor: Optional Keras tensor (i.e. output of 
        `layers.Input()`) 
        to use as image input for the model. 
    pooling: String, optional pooling mode for feature extraction 
        when `include_top` is `False`. 
        - `None` means that the output of the model 
            will be the 4D tensor output of the 
            last convolutional block. 
        - `avg` means that global average pooling 
            will be applied to the output of the 
            last convolutional block, and thus 
            the output of the model will be a 
            2D tensor. 
        - `max` means that global max pooling will 
            be applied. 
    classes: Integer, optional number of classes to classify images 
        into, only to be specified if `include_top` is `True`, and 
        if no `weights` argument is specified. 
    dropout_rate: fraction of the input units to drop on the last layer. 
    classifier_activation: A `str` or callable. The activation function to use 
        on the &quot;top&quot; layer. Ignored unless `include_top=True`. Set 
        `classifier_activation=None` to return the logits of the &quot;top&quot; layer. 
        When loading pretrained weights, `classifier_activation` can only 
        be `None` or `&quot;softmax&quot;`. 
    include_preprocessing: Boolean, whether to include the preprocessing 
        layer (`Rescaling`) at the bottom of the network. Defaults to `True`. 
    name: String, the name of the model. 
 
Call arguments: 
    inputs: A floating point `numpy.array` or backend-native tensor, 
        4D with 3 color channels, with values in the range `[0, 255]` 
        if `include_preprocessing` is `True` and in the range `[-1, 1]` 
        otherwise. 
 
Returns: 
    A model instance. 
&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">MobileNetV3</span><span class="s2">(</span>
    <span class="s1">stack_fn</span><span class="s2">,</span>
    <span class="s1">last_point_ch</span><span class="s2">,</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">alpha</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">,</span>
    <span class="s1">model_type</span><span class="s2">=</span><span class="s3">&quot;large&quot;</span><span class="s2">,</span>
    <span class="s1">minimalistic</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">dropout_rate</span><span class="s2">=</span><span class="s4">0.2</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">if not </span><span class="s2">(</span><span class="s1">weights </span><span class="s0">in </span><span class="s2">{</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">} </span><span class="s0">or </span><span class="s1">file_utils</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">)):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s3">&quot;The `weights` argument should be either &quot;</span>
            <span class="s3">&quot;`None` (random initialization), `imagenet` &quot;</span>
            <span class="s3">&quot;(pre-training on ImageNet), &quot;</span>
            <span class="s3">&quot;or the path to the weights file to be loaded.  &quot;</span>
            <span class="s3">f&quot;Received weights=</span><span class="s0">{</span><span class="s1">weights</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">weights </span><span class="s2">== </span><span class="s3">&quot;imagenet&quot; </span><span class="s0">and </span><span class="s1">include_top </span><span class="s0">and </span><span class="s1">classes </span><span class="s2">!= </span><span class="s4">1000</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s3">'If using `weights=&quot;imagenet&quot;` with `include_top` '</span>
            <span class="s3">&quot;as true, `classes` should be 1000.  &quot;</span>
            <span class="s3">f&quot;Received classes=</span><span class="s0">{</span><span class="s1">classes</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s2">)</span>

    <span class="s5"># Determine proper input shape and default size.</span>
    <span class="s5"># If both input_shape and input_tensor are used, they should match</span>
    <span class="s0">if </span><span class="s1">input_shape </span><span class="s0">is not None and </span><span class="s1">input_tensor </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">is_input_t_tensor </span><span class="s2">= </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">is_keras_tensor</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">is_input_t_tensor </span><span class="s2">= </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">is_keras_tensor</span><span class="s2">(</span>
                    <span class="s1">operation_utils</span><span class="s2">.</span><span class="s1">get_source_inputs</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">)</span>
                <span class="s2">)</span>
            <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                    <span class="s3">&quot;input_tensor: &quot;</span><span class="s2">,</span>
                    <span class="s1">input_tensor</span><span class="s2">,</span>
                    <span class="s3">&quot;is not type input_tensor.  &quot;</span>
                    <span class="s3">f&quot;Received type(input_tensor)=</span><span class="s0">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">)</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_input_t_tensor</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">() == </span><span class="s3">&quot;channels_first&quot;</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">input_tensor</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] != </span><span class="s1">input_shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                        <span class="s3">&quot;When backend.image_data_format()=channels_first, &quot;</span>
                        <span class="s3">&quot;input_shape[1] must equal &quot;</span>
                        <span class="s3">&quot;input_tensor.shape[1].  Received &quot;</span>
                        <span class="s3">f&quot;input_shape=</span><span class="s0">{</span><span class="s1">input_shape</span><span class="s0">}</span><span class="s3">, &quot;</span>
                        <span class="s3">&quot;input_tensor.shape=&quot;</span>
                        <span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">input_tensor</span><span class="s2">.</span><span class="s1">shape</span><span class="s0">}</span><span class="s3">&quot;</span>
                    <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">input_tensor</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">2</span><span class="s2">] != </span><span class="s1">input_shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]:</span>
                    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                        <span class="s3">&quot;input_shape[1] must equal &quot;</span>
                        <span class="s3">&quot;input_tensor.shape[2].  Received &quot;</span>
                        <span class="s3">f&quot;input_shape=</span><span class="s0">{</span><span class="s1">input_shape</span><span class="s0">}</span><span class="s3">, &quot;</span>
                        <span class="s3">&quot;input_tensor.shape=&quot;</span>
                        <span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">input_tensor</span><span class="s2">.</span><span class="s1">shape</span><span class="s0">}</span><span class="s3">&quot;</span>
                    <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s3">&quot;input_tensor specified: &quot;</span><span class="s2">,</span>
                <span class="s1">input_tensor</span><span class="s2">,</span>
                <span class="s3">&quot;is not a keras tensor&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>

    <span class="s5"># If input_shape is None, infer shape from input_tensor</span>
    <span class="s0">if </span><span class="s1">input_shape </span><span class="s0">is None and </span><span class="s1">input_tensor </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">backend</span><span class="s2">.</span><span class="s1">is_keras_tensor</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s3">&quot;input_tensor: &quot;</span><span class="s2">,</span>
                <span class="s1">input_tensor</span><span class="s2">,</span>
                <span class="s3">&quot;is type: &quot;</span><span class="s2">,</span>
                <span class="s1">type</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">),</span>
                <span class="s3">&quot;which is not a valid type&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">is_keras_tensor</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">() == </span><span class="s3">&quot;channels_first&quot;</span><span class="s2">:</span>
                <span class="s1">rows </span><span class="s2">= </span><span class="s1">input_tensor</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]</span>
                <span class="s1">cols </span><span class="s2">= </span><span class="s1">input_tensor</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">3</span><span class="s2">]</span>
                <span class="s1">input_shape </span><span class="s2">= (</span><span class="s4">3</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">rows </span><span class="s2">= </span><span class="s1">input_tensor</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>
                <span class="s1">cols </span><span class="s2">= </span><span class="s1">input_tensor</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]</span>
                <span class="s1">input_shape </span><span class="s2">= (</span><span class="s1">cols</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s5"># If input_shape is None and input_tensor is None using standard shape</span>
    <span class="s0">if </span><span class="s1">input_shape </span><span class="s0">is None and </span><span class="s1">input_tensor </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">() == </span><span class="s3">&quot;channels_last&quot;</span><span class="s2">:</span>
            <span class="s1">input_shape </span><span class="s2">= (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">input_shape </span><span class="s2">= (</span><span class="s4">3</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">() == </span><span class="s3">&quot;channels_last&quot;</span><span class="s2">:</span>
        <span class="s1">row_axis</span><span class="s2">, </span><span class="s1">col_axis </span><span class="s2">= (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">row_axis</span><span class="s2">, </span><span class="s1">col_axis </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">rows </span><span class="s2">= </span><span class="s1">input_shape</span><span class="s2">[</span><span class="s1">row_axis</span><span class="s2">]</span>
    <span class="s1">cols </span><span class="s2">= </span><span class="s1">input_shape</span><span class="s2">[</span><span class="s1">col_axis</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">rows </span><span class="s0">and </span><span class="s1">cols </span><span class="s0">and </span><span class="s2">(</span><span class="s1">rows </span><span class="s2">&lt; </span><span class="s4">32 </span><span class="s0">or </span><span class="s1">cols </span><span class="s2">&lt; </span><span class="s4">32</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s3">&quot;Input size must be at least 32x32; Received `input_shape=&quot;</span>
            <span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">input_shape</span><span class="s0">}</span><span class="s3">`&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">weights </span><span class="s2">== </span><span class="s3">&quot;imagenet&quot;</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s0">not </span><span class="s1">minimalistic</span>
            <span class="s0">and </span><span class="s1">alpha </span><span class="s0">not in </span><span class="s2">[</span><span class="s4">0.75</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]</span>
            <span class="s0">or </span><span class="s1">minimalistic</span>
            <span class="s0">and </span><span class="s1">alpha </span><span class="s2">!= </span><span class="s4">1.0</span>
        <span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s3">&quot;If imagenet weights are being loaded, &quot;</span>
                <span class="s3">&quot;alpha can be one of `0.75`, `1.0` for non minimalistic &quot;</span>
                <span class="s3">&quot;or `1.0` for minimalistic only.&quot;</span>
            <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">rows </span><span class="s2">!= </span><span class="s1">cols </span><span class="s0">or </span><span class="s1">rows </span><span class="s2">!= </span><span class="s4">224</span><span class="s2">:</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
                <span class="s3">&quot;`input_shape` is undefined or non-square, &quot;</span>
                <span class="s3">&quot;or `rows` is not 224. &quot;</span>
                <span class="s3">&quot;Weights for input shape (224, 224) will be &quot;</span>
                <span class="s3">&quot;loaded as the default.&quot;</span><span class="s2">,</span>
                <span class="s1">stacklevel</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
            <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">input_tensor </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">img_input </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Input</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">is_keras_tensor</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">):</span>
            <span class="s1">img_input </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Input</span><span class="s2">(</span><span class="s1">tensor</span><span class="s2">=</span><span class="s1">input_tensor</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">img_input </span><span class="s2">= </span><span class="s1">input_tensor</span>

    <span class="s1">channel_axis </span><span class="s2">= </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">() == </span><span class="s3">&quot;channels_first&quot; </span><span class="s0">else </span><span class="s2">-</span><span class="s4">1</span>

    <span class="s0">if </span><span class="s1">minimalistic</span><span class="s2">:</span>
        <span class="s1">kernel </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">activation </span><span class="s2">= </span><span class="s1">relu</span>
        <span class="s1">se_ratio </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">kernel </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">activation </span><span class="s2">= </span><span class="s1">hard_swish</span>
        <span class="s1">se_ratio </span><span class="s2">= </span><span class="s4">0.25</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">img_input</span>
    <span class="s0">if </span><span class="s1">include_preprocessing</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Rescaling</span><span class="s2">(</span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1.0 </span><span class="s2">/ </span><span class="s4">127.5</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=-</span><span class="s4">1.0</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
        <span class="s4">16</span><span class="s2">,</span>
        <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">strides</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">),</span>
        <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">,</span>
        <span class="s1">use_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;conv&quot;</span><span class="s2">,</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">BatchNormalization</span><span class="s2">(</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s1">channel_axis</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">, </span><span class="s1">momentum</span><span class="s2">=</span><span class="s4">0.999</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;conv_bn&quot;</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">activation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">stack_fn</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">)</span>

    <span class="s1">last_conv_ch </span><span class="s2">= </span><span class="s1">_depth</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s1">channel_axis</span><span class="s2">] * </span><span class="s4">6</span><span class="s2">)</span>

    <span class="s5"># if the width multiplier is greater than 1 we</span>
    <span class="s5"># increase the number of output channels</span>
    <span class="s0">if </span><span class="s1">alpha </span><span class="s2">&gt; </span><span class="s4">1.0</span><span class="s2">:</span>
        <span class="s1">last_point_ch </span><span class="s2">= </span><span class="s1">_depth</span><span class="s2">(</span><span class="s1">last_point_ch </span><span class="s2">* </span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
        <span class="s1">last_conv_ch</span><span class="s2">,</span>
        <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">,</span>
        <span class="s1">use_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;conv_1&quot;</span><span class="s2">,</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">BatchNormalization</span><span class="s2">(</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s1">channel_axis</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">, </span><span class="s1">momentum</span><span class="s2">=</span><span class="s4">0.999</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;conv_1_bn&quot;</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">activation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">include_top</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">GlobalAveragePooling2D</span><span class="s2">(</span><span class="s1">keepdims</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
            <span class="s1">last_point_ch</span><span class="s2">,</span>
            <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
            <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">,</span>
            <span class="s1">use_bias</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;conv_2&quot;</span><span class="s2">,</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">activation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">dropout_rate </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Dropout</span><span class="s2">(</span><span class="s1">dropout_rate</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
            <span class="s1">classes</span><span class="s2">, </span><span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;logits&quot;</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Flatten</span><span class="s2">()(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">imagenet_utils</span><span class="s2">.</span><span class="s1">validate_activation</span><span class="s2">(</span><span class="s1">classifier_activation</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Activation</span><span class="s2">(</span>
            <span class="s1">activation</span><span class="s2">=</span><span class="s1">classifier_activation</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;predictions&quot;</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">pooling </span><span class="s2">== </span><span class="s3">&quot;avg&quot;</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">GlobalAveragePooling2D</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;avg_pool&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">pooling </span><span class="s2">== </span><span class="s3">&quot;max&quot;</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">GlobalMaxPooling2D</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;max_pool&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s5"># Ensure that the model takes into account</span>
    <span class="s5"># any potential predecessors of `input_tensor`.</span>
    <span class="s0">if </span><span class="s1">input_tensor </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">inputs </span><span class="s2">= </span><span class="s1">operation_utils</span><span class="s2">.</span><span class="s1">get_source_inputs</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">inputs </span><span class="s2">= </span><span class="s1">img_input</span>

    <span class="s5"># Create model.</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">Functional</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s5"># Load weights.</span>
    <span class="s0">if </span><span class="s1">weights </span><span class="s2">== </span><span class="s3">&quot;imagenet&quot;</span><span class="s2">:</span>
        <span class="s1">model_name </span><span class="s2">= </span><span class="s3">&quot;{}{}_224_{}_float&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
            <span class="s1">model_type</span><span class="s2">, </span><span class="s3">&quot;_minimalistic&quot; </span><span class="s0">if </span><span class="s1">minimalistic </span><span class="s0">else </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">include_top</span><span class="s2">:</span>
            <span class="s1">file_name </span><span class="s2">= </span><span class="s3">&quot;weights_mobilenet_v3_&quot; </span><span class="s2">+ </span><span class="s1">model_name </span><span class="s2">+ </span><span class="s3">&quot;.h5&quot;</span>
            <span class="s1">file_hash </span><span class="s2">= </span><span class="s1">WEIGHTS_HASHES</span><span class="s2">[</span><span class="s1">model_name</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">file_name </span><span class="s2">= </span><span class="s3">&quot;weights_mobilenet_v3_&quot; </span><span class="s2">+ </span><span class="s1">model_name </span><span class="s2">+ </span><span class="s3">&quot;_no_top_v2.h5&quot;</span>
            <span class="s1">file_hash </span><span class="s2">= </span><span class="s1">WEIGHTS_HASHES</span><span class="s2">[</span><span class="s1">model_name</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">weights_path </span><span class="s2">= </span><span class="s1">file_utils</span><span class="s2">.</span><span class="s1">get_file</span><span class="s2">(</span>
            <span class="s1">file_name</span><span class="s2">,</span>
            <span class="s1">BASE_WEIGHT_PATH </span><span class="s2">+ </span><span class="s1">file_name</span><span class="s2">,</span>
            <span class="s1">cache_subdir</span><span class="s2">=</span><span class="s3">&quot;models&quot;</span><span class="s2">,</span>
            <span class="s1">file_hash</span><span class="s2">=</span><span class="s1">file_hash</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">load_weights</span><span class="s2">(</span><span class="s1">weights_path</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">weights </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">load_weights</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">model</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span><span class="s3">&quot;keras.applications.MobileNetV3Small&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">MobileNetV3Small</span><span class="s2">(</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">alpha</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">,</span>
    <span class="s1">minimalistic</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">dropout_rate</span><span class="s2">=</span><span class="s4">0.2</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;MobileNetV3Small&quot;</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">def </span><span class="s1">stack_fn</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">depth</span><span class="s2">(</span><span class="s1">d</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">_depth</span><span class="s2">(</span><span class="s1">d </span><span class="s2">* </span><span class="s1">alpha</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">72.0 </span><span class="s2">/ </span><span class="s4">16</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">24</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">88.0 </span><span class="s2">/ </span><span class="s4">24</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">24</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">40</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">3</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">40</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">4</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">40</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">5</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">48</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">6</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">48</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">7</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">96</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">8</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">96</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">9</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">96</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">10</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s0">return </span><span class="s1">MobileNetV3</span><span class="s2">(</span>
        <span class="s1">stack_fn</span><span class="s2">,</span>
        <span class="s4">1024</span><span class="s2">,</span>
        <span class="s1">input_shape</span><span class="s2">,</span>
        <span class="s1">alpha</span><span class="s2">,</span>
        <span class="s3">&quot;small&quot;</span><span class="s2">,</span>
        <span class="s1">minimalistic</span><span class="s2">,</span>
        <span class="s1">include_top</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">input_tensor</span><span class="s2">,</span>
        <span class="s1">classes</span><span class="s2">,</span>
        <span class="s1">pooling</span><span class="s2">,</span>
        <span class="s1">dropout_rate</span><span class="s2">,</span>
        <span class="s1">classifier_activation</span><span class="s2">,</span>
        <span class="s1">include_preprocessing</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span><span class="s3">&quot;keras.applications.MobileNetV3Large&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">MobileNetV3Large</span><span class="s2">(</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">alpha</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">,</span>
    <span class="s1">minimalistic</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">dropout_rate</span><span class="s2">=</span><span class="s4">0.2</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;MobileNetV3Large&quot;</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">def </span><span class="s1">stack_fn</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">depth</span><span class="s2">(</span><span class="s1">d</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">_depth</span><span class="s2">(</span><span class="s1">d </span><span class="s2">* </span><span class="s1">alpha</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">16</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">24</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">24</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">40</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">40</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">40</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">relu</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">80</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">80</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">7</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">80</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">8</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">80</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">9</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">112</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">10</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">112</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">11</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">160</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">12</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">160</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">13</span>
        <span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">(</span><span class="s4">160</span><span class="s2">), </span><span class="s1">kernel</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s4">14</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s0">return </span><span class="s1">MobileNetV3</span><span class="s2">(</span>
        <span class="s1">stack_fn</span><span class="s2">,</span>
        <span class="s4">1280</span><span class="s2">,</span>
        <span class="s1">input_shape</span><span class="s2">,</span>
        <span class="s1">alpha</span><span class="s2">,</span>
        <span class="s3">&quot;large&quot;</span><span class="s2">,</span>
        <span class="s1">minimalistic</span><span class="s2">,</span>
        <span class="s1">include_top</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">input_tensor</span><span class="s2">,</span>
        <span class="s1">classes</span><span class="s2">,</span>
        <span class="s1">pooling</span><span class="s2">,</span>
        <span class="s1">dropout_rate</span><span class="s2">,</span>
        <span class="s1">classifier_activation</span><span class="s2">,</span>
        <span class="s1">include_preprocessing</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s1">MobileNetV3Small</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">BASE_DOCSTRING</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;MobileNetV3Small&quot;</span><span class="s2">)</span>
<span class="s1">MobileNetV3Large</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">BASE_DOCSTRING</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;MobileNetV3Large&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">relu</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">ReLU</span><span class="s2">()(</span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">hard_sigmoid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">ReLU</span><span class="s2">(</span><span class="s4">6.0</span><span class="s2">)(</span><span class="s1">x </span><span class="s2">+ </span><span class="s4">3.0</span><span class="s2">) * (</span><span class="s4">1.0 </span><span class="s2">/ </span><span class="s4">6.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">hard_swish</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Activation</span><span class="s2">(</span><span class="s3">&quot;hard_swish&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>


<span class="s5"># This function is taken from the original tf repo.</span>
<span class="s5"># It ensures that all layers have a channel number that is divisible by 8</span>
<span class="s5"># It can be seen here:</span>
<span class="s5"># https://github.com/tensorflow/models/blob/master/research/</span>
<span class="s5"># slim/nets/mobilenet/mobilenet.py</span>


<span class="s0">def </span><span class="s1">_depth</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">divisor</span><span class="s2">=</span><span class="s4">8</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">min_value </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">min_value </span><span class="s2">= </span><span class="s1">divisor</span>
    <span class="s1">new_v </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">min_value</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">v </span><span class="s2">+ </span><span class="s1">divisor </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">) // </span><span class="s1">divisor </span><span class="s2">* </span><span class="s1">divisor</span><span class="s2">)</span>
    <span class="s5"># Make sure that round down does not go down by more than 10%.</span>
    <span class="s0">if </span><span class="s1">new_v </span><span class="s2">&lt; </span><span class="s4">0.9 </span><span class="s2">* </span><span class="s1">v</span><span class="s2">:</span>
        <span class="s1">new_v </span><span class="s2">+= </span><span class="s1">divisor</span>
    <span class="s0">return </span><span class="s1">new_v</span>


<span class="s0">def </span><span class="s1">_se_block</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">filters</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">GlobalAveragePooling2D</span><span class="s2">(</span>
        <span class="s1">keepdims</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;squeeze_excite_avg_pool&quot;</span>
    <span class="s2">)(</span><span class="s1">inputs</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
        <span class="s1">_depth</span><span class="s2">(</span><span class="s1">filters </span><span class="s2">* </span><span class="s1">se_ratio</span><span class="s2">),</span>
        <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;squeeze_excite_conv&quot;</span><span class="s2">,</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">ReLU</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;squeeze_excite_relu&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
        <span class="s1">filters</span><span class="s2">,</span>
        <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;squeeze_excite_conv_1&quot;</span><span class="s2">,</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">hard_sigmoid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Multiply</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;squeeze_excite_mul&quot;</span><span class="s2">)([</span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">x</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">x</span>


<span class="s0">def </span><span class="s1">_inverted_res_block</span><span class="s2">(</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">expansion</span><span class="s2">, </span><span class="s1">filters</span><span class="s2">, </span><span class="s1">kernel_size</span><span class="s2">, </span><span class="s1">stride</span><span class="s2">, </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">activation</span><span class="s2">, </span><span class="s1">block_id</span>
<span class="s2">):</span>
    <span class="s1">channel_axis </span><span class="s2">= </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">() == </span><span class="s3">&quot;channels_first&quot; </span><span class="s0">else </span><span class="s2">-</span><span class="s4">1</span>
    <span class="s1">shortcut </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">prefix </span><span class="s2">= </span><span class="s3">&quot;expanded_conv_&quot;</span>
    <span class="s1">infilters </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s1">channel_axis</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">block_id</span><span class="s2">:</span>
        <span class="s5"># Expand</span>
        <span class="s1">prefix </span><span class="s2">= </span><span class="s3">f&quot;expanded_conv_</span><span class="s0">{</span><span class="s1">block_id</span><span class="s0">}</span><span class="s3">_&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
            <span class="s1">_depth</span><span class="s2">(</span><span class="s1">infilters </span><span class="s2">* </span><span class="s1">expansion</span><span class="s2">),</span>
            <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
            <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">,</span>
            <span class="s1">use_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;expand&quot;</span><span class="s2">,</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">BatchNormalization</span><span class="s2">(</span>
            <span class="s1">axis</span><span class="s2">=</span><span class="s1">channel_axis</span><span class="s2">,</span>
            <span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">,</span>
            <span class="s1">momentum</span><span class="s2">=</span><span class="s4">0.999</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;expand_bn&quot;</span><span class="s2">,</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">activation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">stride </span><span class="s2">== </span><span class="s4">2</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">ZeroPadding2D</span><span class="s2">(</span>
            <span class="s1">padding</span><span class="s2">=</span><span class="s1">imagenet_utils</span><span class="s2">.</span><span class="s1">correct_pad</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">kernel_size</span><span class="s2">),</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;depthwise_pad&quot;</span><span class="s2">,</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">DepthwiseConv2D</span><span class="s2">(</span>
        <span class="s1">kernel_size</span><span class="s2">,</span>
        <span class="s1">strides</span><span class="s2">=</span><span class="s1">stride</span><span class="s2">,</span>
        <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot; </span><span class="s0">if </span><span class="s1">stride </span><span class="s2">== </span><span class="s4">1 </span><span class="s0">else </span><span class="s3">&quot;valid&quot;</span><span class="s2">,</span>
        <span class="s1">use_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;depthwise&quot;</span><span class="s2">,</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">BatchNormalization</span><span class="s2">(</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s1">channel_axis</span><span class="s2">,</span>
        <span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">,</span>
        <span class="s1">momentum</span><span class="s2">=</span><span class="s4">0.999</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;depthwise_bn&quot;</span><span class="s2">,</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">activation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">se_ratio</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">_se_block</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">_depth</span><span class="s2">(</span><span class="s1">infilters </span><span class="s2">* </span><span class="s1">expansion</span><span class="s2">), </span><span class="s1">se_ratio</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
        <span class="s1">filters</span><span class="s2">,</span>
        <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">,</span>
        <span class="s1">use_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;project&quot;</span><span class="s2">,</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">BatchNormalization</span><span class="s2">(</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s1">channel_axis</span><span class="s2">,</span>
        <span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">,</span>
        <span class="s1">momentum</span><span class="s2">=</span><span class="s4">0.999</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;project_bn&quot;</span><span class="s2">,</span>
    <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">stride </span><span class="s2">== </span><span class="s4">1 </span><span class="s0">and </span><span class="s1">infilters </span><span class="s2">== </span><span class="s1">filters</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Add</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">prefix </span><span class="s2">+ </span><span class="s3">&quot;add&quot;</span><span class="s2">)([</span><span class="s1">shortcut</span><span class="s2">, </span><span class="s1">x</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">x</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span><span class="s3">&quot;keras.applications.mobilenet_v3.preprocess_input&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">preprocess_input</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">data_format</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;A placeholder method for backward compatibility. 
 
    The preprocessing logic has been included in the mobilenet_v3 model 
    implementation. Users are no longer required to call this method to 
    normalize the input data. This method does nothing and only kept as a 
    placeholder to align the API surface between old and new version of model. 
 
    Args: 
        x: A floating point `numpy.array` or a tensor. 
        data_format: Optional data format of the image tensor/array. 
            `None` means the global setting 
            `keras.config.image_data_format()` is used 
            (unless you changed it, it uses `&quot;channels_last&quot;`). 
            Defaults to `None`. 
 
    Returns: 
        Unchanged `numpy.array` or tensor. 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">x</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span><span class="s3">&quot;keras.applications.mobilenet_v3.decode_predictions&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">decode_predictions</span><span class="s2">(</span><span class="s1">preds</span><span class="s2">, </span><span class="s1">top</span><span class="s2">=</span><span class="s4">5</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">imagenet_utils</span><span class="s2">.</span><span class="s1">decode_predictions</span><span class="s2">(</span><span class="s1">preds</span><span class="s2">, </span><span class="s1">top</span><span class="s2">=</span><span class="s1">top</span><span class="s2">)</span>


<span class="s1">decode_predictions</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">imagenet_utils</span><span class="s2">.</span><span class="s1">decode_predictions</span><span class="s2">.</span><span class="s1">__doc__</span>
</pre>
</body>
</html>