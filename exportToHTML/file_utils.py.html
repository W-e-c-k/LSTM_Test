<html>
<head>
<title>file_utils.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
file_utils.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">hashlib</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">pathlib</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">tarfile</span>
<span class="s0">import </span><span class="s1">urllib</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">import </span><span class="s1">zipfile</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">request </span><span class="s0">import </span><span class="s1">urlretrieve</span>

<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">api_export </span><span class="s0">import </span><span class="s1">keras_export</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">backend </span><span class="s0">import </span><span class="s1">config</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">io_utils</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">module_utils </span><span class="s0">import </span><span class="s1">gfile</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">progbar </span><span class="s0">import </span><span class="s1">Progbar</span>


<span class="s0">def </span><span class="s1">path_to_string</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Convert `PathLike` objects to their string representation. 
 
    If given a non-string typed path object, converts it to its string 
    representation. 
 
    If the object passed to `path` is not among the above, then it is 
    returned unchanged. This allows e.g. passthrough of file objects 
    through this function. 
 
    Args: 
        path: `PathLike` object that represents a path 
 
    Returns: 
        A string representation of the path argument, if Python support exists. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">PathLike</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">fspath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">path</span>


<span class="s0">def </span><span class="s1">resolve_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">realpath</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">is_path_in_dir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">base_dir</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">resolve_path</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">base_dir</span><span class="s2">, </span><span class="s1">path</span><span class="s2">)).</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">base_dir</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">is_link_in_dir</span><span class="s2">(</span><span class="s1">info</span><span class="s2">, </span><span class="s1">base</span><span class="s2">):</span>
    <span class="s1">tip </span><span class="s2">= </span><span class="s1">resolve_path</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">base</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">info</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)))</span>
    <span class="s0">return </span><span class="s1">is_path_in_dir</span><span class="s2">(</span><span class="s1">info</span><span class="s2">.</span><span class="s1">linkname</span><span class="s2">, </span><span class="s1">base_dir</span><span class="s2">=</span><span class="s1">tip</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">filter_safe_paths</span><span class="s2">(</span><span class="s1">members</span><span class="s2">):</span>
    <span class="s1">base_dir </span><span class="s2">= </span><span class="s1">resolve_path</span><span class="s2">(</span><span class="s4">&quot;.&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">finfo </span><span class="s0">in </span><span class="s1">members</span><span class="s2">:</span>
        <span class="s1">valid_path </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">if </span><span class="s1">is_path_in_dir</span><span class="s2">(</span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">base_dir</span><span class="s2">):</span>
            <span class="s1">valid_path </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">yield </span><span class="s1">finfo</span>
        <span class="s0">elif </span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">issym</span><span class="s2">() </span><span class="s0">or </span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">islnk</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">is_link_in_dir</span><span class="s2">(</span><span class="s1">finfo</span><span class="s2">, </span><span class="s1">base_dir</span><span class="s2">):</span>
                <span class="s1">valid_path </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">yield </span><span class="s1">finfo</span>
        <span class="s0">if not </span><span class="s1">valid_path</span><span class="s2">:</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
                <span class="s4">&quot;Skipping invalid path during archive extraction: &quot;</span>
                <span class="s4">f&quot;'</span><span class="s0">{</span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">name</span><span class="s0">}</span><span class="s4">'.&quot;</span><span class="s2">,</span>
                <span class="s1">stacklevel</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
            <span class="s2">)</span>


<span class="s0">def </span><span class="s1">extract_archive</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">, </span><span class="s1">path</span><span class="s2">=</span><span class="s4">&quot;.&quot;</span><span class="s2">, </span><span class="s1">archive_format</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Extracts an archive if it matches a support format. 
 
    Supports `.tar`, `.tar.gz`, `.tar.bz`, and `.zip` formats. 
 
    Args: 
        file_path: Path to the archive file. 
        path: Where to extract the archive file. 
        archive_format: Archive format to try for extracting the file. 
            Options are `&quot;auto&quot;`, `&quot;tar&quot;`, `&quot;zip&quot;`, and `None`. 
            `&quot;tar&quot;` includes `.tar`, `.tar.gz`, and `.tar.bz` files. 
            The default `&quot;auto&quot;` uses `[&quot;tar&quot;, &quot;zip&quot;]`. 
            `None` or an empty list will return no matches found. 
 
    Returns: 
        `True` if a match was found and an archive extraction was completed, 
        `False` otherwise. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">archive_format </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">return False</span>
    <span class="s0">if </span><span class="s1">archive_format </span><span class="s2">== </span><span class="s4">&quot;auto&quot;</span><span class="s2">:</span>
        <span class="s1">archive_format </span><span class="s2">= [</span><span class="s4">&quot;tar&quot;</span><span class="s2">, </span><span class="s4">&quot;zip&quot;</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">archive_format</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s1">archive_format </span><span class="s2">= [</span><span class="s1">archive_format</span><span class="s2">]</span>

    <span class="s1">file_path </span><span class="s2">= </span><span class="s1">path_to_string</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">)</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">path_to_string</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">archive_type </span><span class="s0">in </span><span class="s1">archive_format</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">archive_type </span><span class="s2">== </span><span class="s4">&quot;tar&quot;</span><span class="s2">:</span>
            <span class="s1">open_fn </span><span class="s2">= </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span>
            <span class="s1">is_match_fn </span><span class="s2">= </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">is_tarfile</span>
        <span class="s0">if </span><span class="s1">archive_type </span><span class="s2">== </span><span class="s4">&quot;zip&quot;</span><span class="s2">:</span>
            <span class="s1">open_fn </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipFile</span>
            <span class="s1">is_match_fn </span><span class="s2">= </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">is_zipfile</span>

        <span class="s0">if </span><span class="s1">is_match_fn</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">open_fn</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">archive</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">is_zipfile</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">):</span>
                        <span class="s6"># Zip archive.</span>
                        <span class="s1">archive</span><span class="s2">.</span><span class="s1">extractall</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s6"># Tar archive, perhaps unsafe. Filter paths.</span>
                        <span class="s1">archive</span><span class="s2">.</span><span class="s1">extractall</span><span class="s2">(</span>
                            <span class="s1">path</span><span class="s2">, </span><span class="s1">members</span><span class="s2">=</span><span class="s1">filter_safe_paths</span><span class="s2">(</span><span class="s1">archive</span><span class="s2">)</span>
                        <span class="s2">)</span>
                <span class="s0">except </span><span class="s2">(</span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">TarError</span><span class="s2">, </span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">KeyboardInterrupt</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
                        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
                            <span class="s1">os</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">shutil</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                    <span class="s0">raise</span>
            <span class="s0">return True</span>
    <span class="s0">return False</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span><span class="s4">&quot;keras.utils.get_file&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">get_file</span><span class="s2">(</span>
    <span class="s1">fname</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">origin</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">untar</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">md5_hash</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">file_hash</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">cache_subdir</span><span class="s2">=</span><span class="s4">&quot;datasets&quot;</span><span class="s2">,</span>
    <span class="s1">hash_algorithm</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">,</span>
    <span class="s1">extract</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">archive_format</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">,</span>
    <span class="s1">cache_dir</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">force_download</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Downloads a file from a URL if it not already in the cache. 
 
    By default the file at the url `origin` is downloaded to the 
    cache_dir `~/.keras`, placed in the cache_subdir `datasets`, 
    and given the filename `fname`. The final location of a file 
    `example.txt` would therefore be `~/.keras/datasets/example.txt`. 
    Files in `.tar`, `.tar.gz`, `.tar.bz`, and `.zip` formats can 
    also be extracted. 
 
    Passing a hash will verify the file after download. The command line 
    programs `shasum` and `sha256sum` can compute the hash. 
 
    Example: 
 
    ```python 
    path_to_downloaded_file = get_file( 
        origin=&quot;https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz&quot;, 
        extract=True, 
    ) 
    ``` 
 
    Args: 
        fname: Name of the file. If an absolute path, e.g. `&quot;/path/to/file.txt&quot;` 
            is specified, the file will be saved at that location. 
            If `None`, the name of the file at `origin` will be used. 
        origin: Original URL of the file. 
        untar: Deprecated in favor of `extract` argument. 
            boolean, whether the file should be decompressed 
        md5_hash: Deprecated in favor of `file_hash` argument. 
            md5 hash of the file for verification 
        file_hash: The expected hash string of the file after download. 
            The sha256 and md5 hash algorithms are both supported. 
        cache_subdir: Subdirectory under the Keras cache dir where the file is 
            saved. If an absolute path, e.g. `&quot;/path/to/folder&quot;` is 
            specified, the file will be saved at that location. 
        hash_algorithm: Select the hash algorithm to verify the file. 
            options are `&quot;md5'`, `&quot;sha256'`, and `&quot;auto'`. 
            The default 'auto' detects the hash algorithm in use. 
        extract: True tries extracting the file as an Archive, like tar or zip. 
        archive_format: Archive format to try for extracting the file. 
            Options are `&quot;auto'`, `&quot;tar'`, `&quot;zip'`, and `None`. 
            `&quot;tar&quot;` includes tar, tar.gz, and tar.bz files. 
            The default `&quot;auto&quot;` corresponds to `[&quot;tar&quot;, &quot;zip&quot;]`. 
            None or an empty list will return no matches found. 
        cache_dir: Location to store cached files, when None it 
            defaults ether `$KERAS_HOME` if the `KERAS_HOME` environment 
            variable is set or `~/.keras/`. 
        force_download: If `True`, the file will always be re-downloaded 
            regardless of the cache state. 
 
    Returns: 
        Path to the downloaded file. 
 
    **⚠️ Warning on malicious downloads ⚠️** 
 
    Downloading something from the Internet carries a risk. 
    NEVER download a file/archive if you do not trust the source. 
    We recommend that you specify the `file_hash` argument 
    (if the hash of the source file is known) to make sure that the file you 
    are getting is the one you expect. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">origin </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s4">'Please specify the &quot;origin&quot; argument (URL of the file '</span>
            <span class="s4">&quot;to download).&quot;</span>
        <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">cache_dir </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">cache_dir </span><span class="s2">= </span><span class="s1">config</span><span class="s2">.</span><span class="s1">keras_home</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">md5_hash </span><span class="s0">is not None and </span><span class="s1">file_hash </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">file_hash </span><span class="s2">= </span><span class="s1">md5_hash</span>
        <span class="s1">hash_algorithm </span><span class="s2">= </span><span class="s4">&quot;md5&quot;</span>
    <span class="s1">datadir_base </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">expanduser</span><span class="s2">(</span><span class="s1">cache_dir</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">access</span><span class="s2">(</span><span class="s1">datadir_base</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">W_OK</span><span class="s2">):</span>
        <span class="s1">datadir_base </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">&quot;/tmp&quot;</span><span class="s2">, </span><span class="s4">&quot;.keras&quot;</span><span class="s2">)</span>
    <span class="s1">datadir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">datadir_base</span><span class="s2">, </span><span class="s1">cache_subdir</span><span class="s2">)</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">datadir</span><span class="s2">, </span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">fname </span><span class="s2">= </span><span class="s1">path_to_string</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">fname</span><span class="s2">:</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">.</span><span class="s1">urlsplit</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">).</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">fname</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s4">&quot;Can't parse the file name from the origin provided: &quot;</span>
                <span class="s4">f&quot;'</span><span class="s0">{</span><span class="s1">origin</span><span class="s0">}</span><span class="s4">'.&quot;</span>
                <span class="s4">&quot;Please specify the `fname` as the input param.&quot;</span>
            <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">untar</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">fname</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;.tar.gz&quot;</span><span class="s2">):</span>
            <span class="s1">fname </span><span class="s2">= </span><span class="s1">pathlib</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">)</span>
            <span class="s6"># The 2 `.with_suffix()` are because of `.tar.gz` as pathlib</span>
            <span class="s6"># considers it as 2 suffixes.</span>
            <span class="s1">fname </span><span class="s2">= </span><span class="s1">fname</span><span class="s2">.</span><span class="s1">with_suffix</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">).</span><span class="s1">with_suffix</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">fname </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s1">untar_fpath </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">datadir</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
        <span class="s1">fpath </span><span class="s2">= </span><span class="s1">untar_fpath </span><span class="s2">+ </span><span class="s4">&quot;.tar.gz&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">fpath </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">datadir</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">force_download</span><span class="s2">:</span>
        <span class="s1">download </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s0">elif </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">):</span>
        <span class="s6"># File found in cache.</span>
        <span class="s1">download </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s6"># Verify integrity if a hash was provided.</span>
        <span class="s0">if </span><span class="s1">file_hash </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">validate_file</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s1">file_hash</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">hash_algorithm</span><span class="s2">):</span>
                <span class="s1">io_utils</span><span class="s2">.</span><span class="s1">print_msg</span><span class="s2">(</span>
                    <span class="s4">&quot;A local file was found, but it seems to be &quot;</span>
                    <span class="s4">f&quot;incomplete or outdated because the </span><span class="s0">{</span><span class="s1">hash_algorithm</span><span class="s0">} </span><span class="s4">&quot;</span>
                    <span class="s4">&quot;file hash does not match the original value of &quot;</span>
                    <span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">file_hash</span><span class="s0">} </span><span class="s4">so we will re-download the data.&quot;</span>
                <span class="s2">)</span>
                <span class="s1">download </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">download </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">if </span><span class="s1">download</span><span class="s2">:</span>
        <span class="s1">io_utils</span><span class="s2">.</span><span class="s1">print_msg</span><span class="s2">(</span><span class="s4">f&quot;Downloading data from </span><span class="s0">{</span><span class="s1">origin</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

        <span class="s0">class </span><span class="s1">DLProgbar</span><span class="s2">:</span>
            <span class="s3">&quot;&quot;&quot;Manage progress bar state for use in urlretrieve.&quot;&quot;&quot;</span>

            <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">progbar </span><span class="s2">= </span><span class="s0">None</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">finished </span><span class="s2">= </span><span class="s0">False</span>

            <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">block_num</span><span class="s2">, </span><span class="s1">block_size</span><span class="s2">, </span><span class="s1">total_size</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">total_size </span><span class="s2">== -</span><span class="s5">1</span><span class="s2">:</span>
                    <span class="s1">total_size </span><span class="s2">= </span><span class="s0">None</span>
                <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">progbar</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">progbar </span><span class="s2">= </span><span class="s1">Progbar</span><span class="s2">(</span><span class="s1">total_size</span><span class="s2">)</span>
                <span class="s1">current </span><span class="s2">= </span><span class="s1">block_num </span><span class="s2">* </span><span class="s1">block_size</span>

                <span class="s0">if </span><span class="s1">total_size </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">progbar</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">current</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">current </span><span class="s2">&lt; </span><span class="s1">total_size</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">progbar</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">current</span><span class="s2">)</span>
                    <span class="s0">elif not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">finished</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">progbar</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">progbar</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">finished </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s1">error_msg </span><span class="s2">= </span><span class="s4">&quot;URL fetch failure on {}: {} -- {}&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">urlretrieve</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">fpath</span><span class="s2">, </span><span class="s1">DLProgbar</span><span class="s2">())</span>
            <span class="s0">except </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">error</span><span class="s2">.</span><span class="s1">HTTPError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s1">error_msg</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">msg</span><span class="s2">))</span>
            <span class="s0">except </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">error</span><span class="s2">.</span><span class="s1">URLError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s1">error_msg</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">origin</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">errno</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">reason</span><span class="s2">))</span>
        <span class="s0">except </span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">, </span><span class="s1">KeyboardInterrupt</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">):</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">)</span>
            <span class="s0">raise</span>

        <span class="s6"># Validate download if succeeded and user provided an expected hash</span>
        <span class="s6"># Security conscious users would get the hash of the file from a</span>
        <span class="s6"># separate channel and pass it to this API to prevent MITM / corruption:</span>
        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">) </span><span class="s0">and </span><span class="s1">file_hash </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">validate_file</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s1">file_hash</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">hash_algorithm</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                    <span class="s4">&quot;Incomplete or corrupted file detected. &quot;</span>
                    <span class="s4">f&quot;The </span><span class="s0">{</span><span class="s1">hash_algorithm</span><span class="s0">} </span><span class="s4">&quot;</span>
                    <span class="s4">&quot;file hash does not match the provided value &quot;</span>
                    <span class="s4">f&quot;of </span><span class="s0">{</span><span class="s1">file_hash</span><span class="s0">}</span><span class="s4">.&quot;</span>
                <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">untar</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">untar_fpath</span><span class="s2">):</span>
            <span class="s1">status </span><span class="s2">= </span><span class="s1">extract_archive</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s1">datadir</span><span class="s2">, </span><span class="s1">archive_format</span><span class="s2">=</span><span class="s4">&quot;tar&quot;</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">status</span><span class="s2">:</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s4">&quot;Could not extract archive.&quot;</span><span class="s2">, </span><span class="s1">stacklevel</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">untar_fpath</span>

    <span class="s0">if </span><span class="s1">extract</span><span class="s2">:</span>
        <span class="s1">status </span><span class="s2">= </span><span class="s1">extract_archive</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s1">datadir</span><span class="s2">, </span><span class="s1">archive_format</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">status</span><span class="s2">:</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s4">&quot;Could not extract archive.&quot;</span><span class="s2">, </span><span class="s1">stacklevel</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s6"># TODO: return extracted fpath if we extracted an archive,</span>
    <span class="s6"># rather than the archive path.</span>
    <span class="s0">return </span><span class="s1">fpath</span>


<span class="s0">def </span><span class="s1">resolve_hasher</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">file_hash</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Returns hash algorithm as hashlib function.&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">algorithm </span><span class="s2">== </span><span class="s4">&quot;sha256&quot;</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">hashlib</span><span class="s2">.</span><span class="s1">sha256</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">algorithm </span><span class="s2">== </span><span class="s4">&quot;auto&quot; </span><span class="s0">and </span><span class="s1">file_hash </span><span class="s0">is not None and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">file_hash</span><span class="s2">) == </span><span class="s5">64</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">hashlib</span><span class="s2">.</span><span class="s1">sha256</span><span class="s2">()</span>

    <span class="s6"># This is used only for legacy purposes.</span>
    <span class="s0">return </span><span class="s1">hashlib</span><span class="s2">.</span><span class="s1">md5</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">hash_file</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s4">&quot;sha256&quot;</span><span class="s2">, </span><span class="s1">chunk_size</span><span class="s2">=</span><span class="s5">65535</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Calculates a file sha256 or md5 hash. 
 
    Example: 
 
    &gt;&gt;&gt; hash_file('/path/to/file.zip') 
    'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855' 
 
    Args: 
        fpath: Path to the file being validated. 
        algorithm: Hash algorithm, one of `&quot;auto&quot;`, `&quot;sha256&quot;`, or `&quot;md5&quot;`. 
            The default `&quot;auto&quot;` detects the hash algorithm in use. 
        chunk_size: Bytes to read at a time, important for large files. 
 
    Returns: 
        The file hash. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s1">hasher </span><span class="s2">= </span><span class="s1">resolve_hasher</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">hasher </span><span class="s2">= </span><span class="s1">algorithm</span>

    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s4">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fpath_file</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">iter</span><span class="s2">(</span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">fpath_file</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">chunk_size</span><span class="s2">), </span><span class="s7">b&quot;&quot;</span><span class="s2">):</span>
            <span class="s1">hasher</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">hasher</span><span class="s2">.</span><span class="s1">hexdigest</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">validate_file</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s1">file_hash</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">chunk_size</span><span class="s2">=</span><span class="s5">65535</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Validates a file against a sha256 or md5 hash. 
 
    Args: 
        fpath: path to the file being validated 
        file_hash:  The expected hash string of the file. 
            The sha256 and md5 hash algorithms are both supported. 
        algorithm: Hash algorithm, one of `&quot;auto&quot;`, `&quot;sha256&quot;`, or `&quot;md5&quot;`. 
            The default `&quot;auto&quot;` detects the hash algorithm in use. 
        chunk_size: Bytes to read at a time, important for large files. 
 
    Returns: 
        Boolean, whether the file is valid. 
    &quot;&quot;&quot;</span>
    <span class="s1">hasher </span><span class="s2">= </span><span class="s1">resolve_hasher</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">file_hash</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">str</span><span class="s2">(</span><span class="s1">hash_file</span><span class="s2">(</span><span class="s1">fpath</span><span class="s2">, </span><span class="s1">hasher</span><span class="s2">, </span><span class="s1">chunk_size</span><span class="s2">)) == </span><span class="s1">str</span><span class="s2">(</span><span class="s1">file_hash</span><span class="s2">):</span>
        <span class="s0">return True</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return False</span>


<span class="s0">def </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">filepath</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Determines if a given filepath indicates a remote location. 
 
    This function checks if the filepath represents a known remote pattern 
    such as GCS (`/gcs`), CNS (`/cns`), CFS (`/cfs`), HDFS (`/hdfs`) 
 
    Args: 
        filepath (str): The path to be checked. 
 
    Returns: 
        bool: True if the filepath is a recognized remote path, otherwise False 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">re</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s4">r&quot;^(/cns|/cfs|/gcs|/hdfs|.*://).*$&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">filepath</span><span class="s2">)):</span>
        <span class="s0">return True</span>
    <span class="s0">return False</span>


<span class="s6"># Below are gfile-replacement utils.</span>


<span class="s0">def </span><span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
        <span class="s4">&quot;Handling remote paths requires installing TensorFlow &quot;</span>
        <span class="s4">f&quot;(in order to use gfile). Received path: </span><span class="s0">{</span><span class="s1">path</span><span class="s0">}</span><span class="s4">&quot;</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">exists</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">available</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">File</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">available</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">GFile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, *</span><span class="s1">paths</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">available</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, *</span><span class="s1">paths</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, *</span><span class="s1">paths</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">available</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">available</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">shutil</span><span class="s2">.</span><span class="s1">rmtree</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">available</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">listdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">copy</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">dst</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">src</span><span class="s2">) </span><span class="s0">or </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">dst</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">available</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">dst</span><span class="s2">, </span><span class="s1">overwrite</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s4">f&quot;src=</span><span class="s0">{</span><span class="s1">src</span><span class="s0">} </span><span class="s4">dst=</span><span class="s0">{</span><span class="s1">dst</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">shutil</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">src</span><span class="s2">, </span><span class="s1">dst</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">is_remote_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">available</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">gfile</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">_raise_if_no_gfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
</pre>
</body>
</html>