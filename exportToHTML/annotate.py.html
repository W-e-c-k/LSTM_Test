<html>
<head>
<title>annotate.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
annotate.py</font>
</center></td></tr></table>
<pre><span class="s0"># coding=utf-8</span>
<span class="s2">&quot;&quot;&quot;Annotate python syntax trees with formatting from the source file.&quot;&quot;&quot;</span>
<span class="s0"># Copyright 2017 Google LLC</span>
<span class="s0">#</span>
<span class="s0"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0"># you may not use this file except in compliance with the License.</span>
<span class="s0"># You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0"># Unless required by applicable law or agreed to in writing, software</span>
<span class="s0"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0"># See the License for the specific language governing permissions and</span>
<span class="s0"># limitations under the License.</span>

<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">absolute_import</span>
<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">division</span>
<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">print_function</span>

<span class="s3">import </span><span class="s1">abc</span>
<span class="s3">import </span><span class="s1">ast</span>
<span class="s3">import </span><span class="s1">contextlib</span>
<span class="s3">import </span><span class="s1">functools</span>
<span class="s3">import </span><span class="s1">itertools</span>
<span class="s3">import </span><span class="s1">six</span>
<span class="s3">from </span><span class="s1">six</span><span class="s4">.</span><span class="s1">moves </span><span class="s3">import </span><span class="s1">zip</span>
<span class="s3">import </span><span class="s1">sys</span>

<span class="s3">from </span><span class="s1">pasta</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">ast_constants</span>
<span class="s3">from </span><span class="s1">pasta</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">ast_utils</span>
<span class="s3">from </span><span class="s1">pasta</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">formatting </span><span class="s3">as </span><span class="s1">fmt</span>
<span class="s3">from </span><span class="s1">pasta</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">token_generator</span>


<span class="s0"># ==============================================================================</span>
<span class="s0"># == Helper functions for decorating nodes with prefix + suffix               ==</span>
<span class="s0"># ==============================================================================</span>

<span class="s3">def </span><span class="s1">_gen_wrapper</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">suffix</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">max_suffix_lines</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
                 <span class="s1">semicolon</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">statement</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
  <span class="s4">@</span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">wraps</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
  <span class="s3">def </span><span class="s1">wrapped</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
    <span class="s3">with </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">scope</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">trailing_comma</span><span class="s4">=</span><span class="s3">False</span><span class="s4">) </span><span class="s3">if </span><span class="s1">scope </span><span class="s3">else </span><span class="s1">_noop_context</span><span class="s4">()):</span>
      <span class="s3">if </span><span class="s1">prefix</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">prefix</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent </span><span class="s3">if </span><span class="s1">statement </span><span class="s3">else </span><span class="s5">''</span><span class="s4">)</span>
      <span class="s1">f</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">suffix</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">suffix</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">max_lines</span><span class="s4">=</span><span class="s1">max_suffix_lines</span><span class="s4">, </span><span class="s1">semicolon</span><span class="s4">=</span><span class="s1">semicolon</span><span class="s4">,</span>
                    <span class="s1">comment</span><span class="s4">=</span><span class="s1">comment</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">' </span><span class="s3">if </span><span class="s1">statement </span><span class="s3">else </span><span class="s5">''</span><span class="s4">)</span>
  <span class="s3">return </span><span class="s1">wrapped</span>


<span class="s4">@</span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">contextmanager</span>
<span class="s3">def </span><span class="s1">_noop_context</span><span class="s4">():</span>
  <span class="s3">yield</span>


<span class="s3">def </span><span class="s1">expression</span><span class="s4">(</span><span class="s1">f</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Decorates a function where the node is an expression.&quot;&quot;&quot;</span>
  <span class="s3">return </span><span class="s1">_gen_wrapper</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">max_suffix_lines</span><span class="s4">=</span><span class="s6">0</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">fstring_expression</span><span class="s4">(</span><span class="s1">f</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Decorates a function where the node is a FormattedValue in an fstring.&quot;&quot;&quot;</span>
  <span class="s3">return </span><span class="s1">_gen_wrapper</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">space_around</span><span class="s4">(</span><span class="s1">f</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Decorates a function where the node has whitespace prefix and suffix.&quot;&quot;&quot;</span>
  <span class="s3">return </span><span class="s1">_gen_wrapper</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">space_left</span><span class="s4">(</span><span class="s1">f</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Decorates a function where the node has whitespace prefix.&quot;&quot;&quot;</span>
  <span class="s3">return </span><span class="s1">_gen_wrapper</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">suffix</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">statement</span><span class="s4">(</span><span class="s1">f</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Decorates a function where the node is a statement.&quot;&quot;&quot;</span>
  <span class="s3">return </span><span class="s1">_gen_wrapper</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">max_suffix_lines</span><span class="s4">=</span><span class="s6">1</span><span class="s4">, </span><span class="s1">semicolon</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                      <span class="s1">comment</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">statement</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">module</span><span class="s4">(</span><span class="s1">f</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Special decorator for the module node.&quot;&quot;&quot;</span>
  <span class="s3">return </span><span class="s1">_gen_wrapper</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">block_statement</span><span class="s4">(</span><span class="s1">f</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Decorates a function where the node is a statement with children.&quot;&quot;&quot;</span>
  <span class="s4">@</span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">wraps</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
  <span class="s3">def </span><span class="s1">wrapped</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">prefix</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent</span><span class="s4">)</span>
    <span class="s1">f</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s5">'block_suffix'</span><span class="s4">):</span>
      <span class="s1">last_child </span><span class="s4">= </span><span class="s1">ast_utils</span><span class="s4">.</span><span class="s1">get_last_child</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>
      <span class="s0"># Workaround for ast.Module which does not have a lineno</span>
      <span class="s3">if </span><span class="s1">last_child </span><span class="s3">and </span><span class="s1">last_child</span><span class="s4">.</span><span class="s1">lineno </span><span class="s4">!= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'lineno'</span><span class="s4">, </span><span class="s6">0</span><span class="s4">):</span>
        <span class="s1">indent </span><span class="s4">= (</span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">last_child</span><span class="s4">, </span><span class="s5">'prefix'</span><span class="s4">) </span><span class="s3">or </span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">).</span><span class="s1">splitlines</span><span class="s4">()[-</span><span class="s6">1</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">block_suffix</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">indent</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">suffix</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
  <span class="s3">return </span><span class="s1">wrapped</span>


<span class="s0"># ==============================================================================</span>
<span class="s0"># == NodeVisitors for annotating an AST                                       ==</span>
<span class="s0"># ==============================================================================</span>

<span class="s3">class </span><span class="s1">BaseVisitor</span><span class="s4">(</span><span class="s1">ast</span><span class="s4">.</span><span class="s1">NodeVisitor</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Walks a syntax tree in the order it appears in code. 
 
  This class has a dual-purpose. It is implemented (in this file) for annotating 
  an AST with formatting information needed to reconstruct the source code, but 
  it also is implemented in pasta.base.codegen to reconstruct the source code. 
 
  Each visit method in this class specifies the order in which both child nodes 
  and syntax tokens appear, plus where to account for whitespace, commas, 
  parentheses, etc. 
  &quot;&quot;&quot;</span>

  <span class="s1">__metaclass__ </span><span class="s4">= </span><span class="s1">abc</span><span class="s4">.</span><span class="s1">ABCMeta</span>

  <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_stack </span><span class="s4">= []</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent </span><span class="s4">= </span><span class="s5">''</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff </span><span class="s4">= </span><span class="s5">''</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_default_indent_diff </span><span class="s4">= </span><span class="s5">'  '</span>

  <span class="s3">def </span><span class="s1">visit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_stack</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>
    <span class="s1">super</span><span class="s4">(</span><span class="s1">BaseVisitor</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">node </span><span class="s3">is </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stack</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">()</span>

  <span class="s3">def </span><span class="s1">prefix</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s5">''</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for some amount of whitespace as the prefix to a node.&quot;&quot;&quot;</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'prefix'</span><span class="s4">, [</span><span class="s3">lambda</span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">(</span><span class="s1">comment</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)], </span><span class="s1">default</span><span class="s4">=</span><span class="s1">default</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">suffix</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">max_lines</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">semicolon</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
             <span class="s1">default</span><span class="s4">=</span><span class="s5">''</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for some amount of whitespace as the suffix to a node.&quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">_ws</span><span class="s4">():</span>
      <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">(</span><span class="s1">max_lines</span><span class="s4">=</span><span class="s1">max_lines</span><span class="s4">, </span><span class="s1">semicolon</span><span class="s4">=</span><span class="s1">semicolon</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">=</span><span class="s1">comment</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'suffix'</span><span class="s4">, [</span><span class="s1">_ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s1">default</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">indented</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">children_attr</span><span class="s4">):</span>
    <span class="s1">children </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">children_attr</span><span class="s4">)</span>
    <span class="s1">prev_indent </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent</span>
    <span class="s1">prev_indent_diff </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff</span>
    <span class="s1">new_diff </span><span class="s4">= </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">children</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s5">'indent_diff'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">new_diff </span><span class="s3">is None</span><span class="s4">:</span>
      <span class="s1">new_diff </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_default_indent_diff</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff </span><span class="s4">= </span><span class="s1">new_diff</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent </span><span class="s4">= </span><span class="s1">prev_indent </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff</span>
    <span class="s3">for </span><span class="s1">child </span><span class="s3">in </span><span class="s1">children</span><span class="s4">:</span>
      <span class="s3">yield </span><span class="s1">child</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'block_suffix_%s' </span><span class="s4">% </span><span class="s1">children_attr</span><span class="s4">, [])</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent </span><span class="s4">= </span><span class="s1">prev_indent</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff </span><span class="s4">= </span><span class="s1">prev_indent_diff</span>

  <span class="s3">def </span><span class="s1">set_default_indent_diff</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">indent</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_default_indent_diff </span><span class="s4">= </span><span class="s1">indent</span>

  <span class="s4">@</span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">contextmanager</span>
  <span class="s3">def </span><span class="s1">scope</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">trailing_comma</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">default_parens</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Context manager to handle a parenthesized scope. 
 
    Arguments: 
      node: (ast.AST) Node to store the scope prefix and suffix on. 
      attr: (string, optional) Attribute of the node contained in the scope, if 
        any. For example, as `None`, the scope would wrap the entire node, but 
        as 'bases', the scope might wrap only the bases of a class. 
      trailing_comma: (boolean) If True, allow a trailing comma at the end. 
      default_parens: (boolean) If True and no formatting information is 
        present, the scope would be assumed to be parenthesized. 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">attr</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr </span><span class="s4">+ </span><span class="s5">'_prefix'</span><span class="s4">, [],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'(' </span><span class="s3">if </span><span class="s1">default_parens </span><span class="s3">else </span><span class="s5">''</span><span class="s4">)</span>
    <span class="s3">yield</span>
    <span class="s3">if </span><span class="s1">attr</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr </span><span class="s4">+ </span><span class="s5">'_suffix'</span><span class="s4">, [],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">')' </span><span class="s3">if </span><span class="s1">default_parens </span><span class="s3">else </span><span class="s5">''</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">token</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">token_val</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for a specific token.&quot;&quot;&quot;</span>

  <span class="s3">def </span><span class="s1">attr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">attr_vals</span><span class="s4">, </span><span class="s1">deps</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Handles an attribute on the given node.&quot;&quot;&quot;</span>

  <span class="s3">def </span><span class="s1">ws</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">max_lines</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">semicolon</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for some amount of whitespace. 
 
    Arguments: 
      max_lines: (int) Maximum number of newlines to consider. 
      semicolon: (boolean) If True, parse up to the next semicolon (if present). 
      comment: (boolean) If True, look for a trailing comment even when not in 
        a parenthesized scope. 
    &quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s5">''</span>

  <span class="s3">def </span><span class="s1">dots</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">num_dots</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for a number of dots.&quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s5">'.' </span><span class="s4">* </span><span class="s1">num_dots</span>

  <span class="s3">def </span><span class="s1">ws_oneline</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for up to one line of whitespace.&quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">(</span><span class="s1">max_lines</span><span class="s4">=</span><span class="s6">1</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">token_val</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for a suffix that may or may not occur.&quot;&quot;&quot;</span>

  <span class="s3">def </span><span class="s1">one_of_symbols</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">symbols</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for one of the given symbols.&quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s1">symbols</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

  <span class="s0"># ============================================================================</span>
  <span class="s0"># == BLOCK STATEMENTS: Statements that contain a list of statements         ==</span>
  <span class="s0"># ============================================================================</span>

  <span class="s0"># Keeps the entire suffix, so @block_statement is not useful here.</span>
  <span class="s4">@</span><span class="s1">module</span>
  <span class="s3">def </span><span class="s1">visit_Module</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">generic_visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_If</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">tok </span><span class="s4">= </span><span class="s5">'elif' </span><span class="s3">if </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'is_elif'</span><span class="s4">) </span><span class="s3">else </span><span class="s5">'if'</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_if'</span><span class="s4">, [</span><span class="s1">tok</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s1">tok </span><span class="s4">+ </span><span class="s5">' '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">test</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_block'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">:</span>
      <span class="s3">if </span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">) == </span><span class="s6">1 </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">If</span><span class="s4">) </span><span class="s3">and</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">check_is_elif</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])):</span>
        <span class="s1">fmt</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s5">'is_elif'</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'elseprefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'else'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_else'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'orelse'</span><span class="s4">):</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">abc</span><span class="s4">.</span><span class="s1">abstractmethod</span>
  <span class="s3">def </span><span class="s1">check_is_elif</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Return True if the node continues a previous `if` statement as `elif`. 
 
    In python 2.x, `elif` statments get parsed as If nodes. E.g, the following 
    two syntax forms are indistinguishable in the ast in python 2. 
 
    if a: 
      do_something() 
    elif b: 
      do_something_else() 
 
    if a: 
      do_something() 
    else: 
      if b: 
        do_something_else() 
 
    This method should return True for the 'if b' node if it has the first form. 
    &quot;&quot;&quot;</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_While</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'while_keyword'</span><span class="s4">, [</span><span class="s5">'while'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'while '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">test</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_block'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent </span><span class="s4">+ </span><span class="s5">'else:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
      <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'orelse'</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_For</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">ast</span><span class="s4">, </span><span class="s5">'AsyncFor'</span><span class="s4">) </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">AsyncFor</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'for_keyword'</span><span class="s4">, [</span><span class="s5">'async'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'for'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'async for '</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'for_keyword'</span><span class="s4">, [</span><span class="s5">'for'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'for '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'for_in'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'in'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' in '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">iter</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_block'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent </span><span class="s4">+ </span><span class="s5">'else:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>

      <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'orelse'</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_AsyncFor</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">visit_For</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_With</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'items'</span><span class="s4">):</span>
      <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">visit_With_3</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>
    <span class="s3">if not </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'is_continued'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'with'</span><span class="s4">, [</span><span class="s5">'with'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'with '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">context_expr</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">optional_vars</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'with_as'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'as'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' as '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">optional_vars</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">) == </span><span class="s6">1 </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">check_is_continued_with</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]):</span>
      <span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">is_continued </span><span class="s4">= </span><span class="s3">True</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'with_comma'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_block'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_AsyncWith</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">visit_With</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">abc</span><span class="s4">.</span><span class="s1">abstractmethod</span>
  <span class="s3">def </span><span class="s1">check_is_continued_try</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">pass</span>

  <span class="s4">@</span><span class="s1">abc</span><span class="s4">.</span><span class="s1">abstractmethod</span>
  <span class="s3">def </span><span class="s1">check_is_continued_with</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Return True if the node continues a previous `with` statement. 
 
    In python 2.x, `with` statments with many context expressions get parsed as 
    a tree of With nodes. E.g, the following two syntax forms are 
    indistinguishable in the ast in python 2. 
 
    with a, b, c: 
      do_something() 
 
    with a: 
      with b: 
        with c: 
          do_something() 
 
    This method should return True for the `with b` and `with c` nodes. 
    &quot;&quot;&quot;</span>

  <span class="s3">def </span><span class="s1">visit_With_3</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">ast</span><span class="s4">, </span><span class="s5">'AsyncWith'</span><span class="s4">) </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">AsyncWith</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'with'</span><span class="s4">, [</span><span class="s5">'async'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'with'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'async with '</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'with'</span><span class="s4">, [</span><span class="s5">'with'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'with '</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">withitem </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">items</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">withitem</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">i </span><span class="s4">!= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">items</span><span class="s4">) - </span><span class="s6">1</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">','</span><span class="s4">)</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'with_body_open'</span><span class="s4">, [</span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">space_around</span>
  <span class="s3">def </span><span class="s1">visit_withitem</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">context_expr</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">optional_vars</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'as'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'as'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' as '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">optional_vars</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_ClassDef</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">decorator </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">decorator_list</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'decorator_prefix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'@'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'@'</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">decorator</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'decorator_suffix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">' </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'class_def'</span><span class="s4">, [</span><span class="s5">'class'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">'class %s' </span><span class="s4">% </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">deps</span><span class="s4">=(</span><span class="s5">'name'</span><span class="s4">,))</span>
    <span class="s1">class_args </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'bases'</span><span class="s4">, []) + </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'keywords'</span><span class="s4">, [])</span>
    <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scope</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'bases'</span><span class="s4">, </span><span class="s1">trailing_comma</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">(</span><span class="s1">class_args</span><span class="s4">),</span>
                    <span class="s1">default_parens</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
      <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">base </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">bases</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">base</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'base_suffix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span>
        <span class="s3">if </span><span class="s1">base </span><span class="s4">!= </span><span class="s1">class_args</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'base_sep_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'keywords'</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">keyword </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">keywords</span><span class="s4">):</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">keyword</span><span class="s4">)</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'keyword_suffix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span>
          <span class="s3">if </span><span class="s1">keyword </span><span class="s4">!= </span><span class="s1">node</span><span class="s4">.</span><span class="s1">keywords</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'keyword_sep_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_block'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_FunctionDef</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">decorator </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">decorator_list</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'decorator_symbol_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'@'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'@'</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">decorator</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'decorator_suffix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">' </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s4">(</span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">ast</span><span class="s4">, </span><span class="s5">'AsyncFunctionDef'</span><span class="s4">) </span><span class="s3">and</span>
        <span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">AsyncFunctionDef</span><span class="s4">)):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'function_def'</span><span class="s4">,</span>
                <span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'async'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'def'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">deps</span><span class="s4">=(</span><span class="s5">'name'</span><span class="s4">,), </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'async def %s' </span><span class="s4">% </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'function_def'</span><span class="s4">,</span>
                <span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'def'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">deps</span><span class="s4">=(</span><span class="s5">'name'</span><span class="s4">,), </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'def %s' </span><span class="s4">% </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s0"># In Python 3, there can be extra args in kwonlyargs</span>
    <span class="s1">kwonlyargs </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span><span class="s4">, </span><span class="s5">'kwonlyargs'</span><span class="s4">, [])</span>
    <span class="s1">args_count </span><span class="s4">= </span><span class="s1">sum</span><span class="s4">((</span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span><span class="s4">.</span><span class="s1">args </span><span class="s4">+ </span><span class="s1">kwonlyargs</span><span class="s4">),</span>
                      <span class="s6">1 </span><span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span><span class="s4">.</span><span class="s1">vararg </span><span class="s3">else </span><span class="s6">0</span><span class="s4">,</span>
                      <span class="s6">1 </span><span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span><span class="s4">.</span><span class="s1">kwarg </span><span class="s3">else </span><span class="s6">0</span><span class="s4">))</span>
    <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scope</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'args'</span><span class="s4">, </span><span class="s1">trailing_comma</span><span class="s4">=</span><span class="s1">args_count </span><span class="s4">&gt; </span><span class="s6">0</span><span class="s4">,</span>
                    <span class="s1">default_parens</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'returns'</span><span class="s4">, </span><span class="s3">None</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'returns_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'-&gt;'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">deps</span><span class="s4">=(</span><span class="s5">'returns'</span><span class="s4">,), </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' -&gt; '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">returns</span><span class="s4">)</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_block'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_AsyncFunctionDef</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">visit_FunctionDef</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_TryFinally</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s0"># Try with except and finally is a TryFinally with the first statement as a</span>
    <span class="s0"># TryExcept in Python2</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_try'</span><span class="s4">, [</span><span class="s5">'try'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">'try:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s0"># TODO(soupytwist): Find a cleaner solution for differentiating this.</span>
    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">) == </span><span class="s6">1 </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">check_is_continued_try</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]):</span>
      <span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">is_continued </span><span class="s4">= </span><span class="s3">True</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_finally'</span><span class="s4">,</span>
              <span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'finally'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">'finally:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'finalbody'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_TryExcept</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if not </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'is_continued'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_try'</span><span class="s4">, [</span><span class="s5">'try'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'try:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">handler </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">handlers</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">handler</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_else'</span><span class="s4">,</span>
                <span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'else:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
      <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'orelse'</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_Try</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s0"># Python 3</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_try'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'try'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">'try:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">handler </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">handlers</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">handler</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_else'</span><span class="s4">,</span>
                <span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'else:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
      <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'orelse'</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">finalbody</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_finally'</span><span class="s4">,</span>
                <span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'finally'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'finally:</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
      <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'finalbody'</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">block_statement</span>
  <span class="s3">def </span><span class="s1">visit_ExceptHandler</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'except'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">type</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">type</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">type </span><span class="s3">and </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'as'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">one_of_symbols</span><span class="s4">(</span><span class="s5">&quot;as&quot;</span><span class="s4">, </span><span class="s5">&quot;,&quot;</span><span class="s4">), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">' as '</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">:</span>
      <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">AST</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_block'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws_oneline</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">':</span><span class="s3">\n</span><span class="s5">'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">stmt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">indented</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Raise</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'cause'</span><span class="s4">):</span>
      <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">visit_Raise_3</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'raise'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">type</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'type_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">type</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">inst</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'inst_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">inst</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">tback</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'tback_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">tback</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_Raise_3</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">exc</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_raise'</span><span class="s4">, [</span><span class="s5">'raise'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'raise '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">exc</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">cause</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'cause_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'from'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">' from '</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">cause</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'raise'</span><span class="s4">)</span>

  <span class="s0"># ============================================================================</span>
  <span class="s0"># == STATEMENTS: Instructions without a return value                        ==</span>
  <span class="s0"># ============================================================================</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Assert</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'assert_open'</span><span class="s4">, [</span><span class="s5">'assert'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'assert '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">test</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">msg</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'msg_prefix'</span><span class="s4">, [</span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">msg</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Assign</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">target </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">targets</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">target</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'equal_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'='</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' = '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_AugAssign</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">op_token </span><span class="s4">= </span><span class="s5">'%s=' </span><span class="s4">% </span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">op</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'operator'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">op_token</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">' %s ' </span><span class="s4">% </span><span class="s1">op_token</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_AnnAssign</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s0"># TODO: Check default formatting for different values of &quot;simple&quot;</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'colon'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">': '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">annotation</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'equal'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'='</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' = '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Await</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'await'</span><span class="s4">, [</span><span class="s5">'await'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'await '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Break</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'break'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Continue</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'continue'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Delete</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'del'</span><span class="s4">, [</span><span class="s5">'del'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'del '</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">target </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">targets</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">target</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">target </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">targets</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Exec</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s0"># If no formatting info is present, will use parenthesized style</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'exec'</span><span class="s4">, [</span><span class="s5">'exec'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'exec'</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scope</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'body'</span><span class="s4">, </span><span class="s1">trailing_comma</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">default_parens</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">globals</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'in_globals'</span><span class="s4">,</span>
                  <span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">one_of_symbols</span><span class="s4">(</span><span class="s5">'in'</span><span class="s4">, </span><span class="s5">','</span><span class="s4">), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">globals</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">locals</span><span class="s4">:</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'in_locals'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">locals</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Expr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Global</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'global'</span><span class="s4">)</span>
    <span class="s1">identifiers </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">ident </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">names</span><span class="s4">:</span>
      <span class="s3">if </span><span class="s1">ident </span><span class="s4">!= </span><span class="s1">node</span><span class="s4">.</span><span class="s1">names</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
        <span class="s1">identifiers</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">([</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">])</span>
      <span class="s1">identifiers</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">([</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">ident</span><span class="s4">])</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'names'</span><span class="s4">, </span><span class="s1">identifiers</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Import</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'import'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">alias </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">names</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'alias_prefix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">alias</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">alias </span><span class="s4">!= </span><span class="s1">node</span><span class="s4">.</span><span class="s1">names</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'alias_sep_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">','</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_ImportFrom</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'from'</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'module_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>

    <span class="s1">module_pattern </span><span class="s4">= []</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">level </span><span class="s4">&gt; </span><span class="s6">0</span><span class="s4">:</span>
      <span class="s1">module_pattern</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">([</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dots</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">level</span><span class="s4">), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">module</span><span class="s4">:</span>
      <span class="s1">parts </span><span class="s4">= </span><span class="s1">node</span><span class="s4">.</span><span class="s1">module</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">)</span>
      <span class="s3">for </span><span class="s1">part </span><span class="s3">in </span><span class="s1">parts</span><span class="s4">[:-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">module_pattern </span><span class="s4">+= [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">part</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'.'</span><span class="s4">]</span>
      <span class="s1">module_pattern </span><span class="s4">+= [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">parts</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]]</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'module'</span><span class="s4">, </span><span class="s1">module_pattern</span><span class="s4">,</span>
              <span class="s1">deps</span><span class="s4">=(</span><span class="s5">'level'</span><span class="s4">, </span><span class="s5">'module'</span><span class="s4">),</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">'.' </span><span class="s4">* </span><span class="s1">node</span><span class="s4">.</span><span class="s1">level </span><span class="s4">+ (</span><span class="s1">node</span><span class="s4">.</span><span class="s1">module </span><span class="s3">or </span><span class="s5">''</span><span class="s4">))</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'module_suffix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'import'</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scope</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'names'</span><span class="s4">, </span><span class="s1">trailing_comma</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
      <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">alias </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">names</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'alias_prefix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">alias</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">alias </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">names</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'alias_sep_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">','</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_NamedExpr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'equal' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':='</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' := '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Nonlocal</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'nonlocal'</span><span class="s4">)</span>
    <span class="s1">identifiers </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">ident </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">names</span><span class="s4">:</span>
      <span class="s3">if </span><span class="s1">ident </span><span class="s4">!= </span><span class="s1">node</span><span class="s4">.</span><span class="s1">names</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
        <span class="s1">identifiers</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">([</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">])</span>
      <span class="s1">identifiers</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">([</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">ident</span><span class="s4">])</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'names'</span><span class="s4">, </span><span class="s1">identifiers</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Pass</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'pass'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Print</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'print_open'</span><span class="s4">, [</span><span class="s5">'print'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'print '</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">dest</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'redirection'</span><span class="s4">, [</span><span class="s5">'&gt;&gt;'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'&gt;&gt;'</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">dest</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">values</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'values_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
      <span class="s3">elif not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">nl</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'trailing_comma'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">','</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">values</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">value </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">values</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
      <span class="s3">elif not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">nl</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'trailing_comma'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">','</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">statement</span>
  <span class="s3">def </span><span class="s1">visit_Return</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'return'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'return_value_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Yield</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'yield'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'yield_value_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_YieldFrom</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'yield_from'</span><span class="s4">, [</span><span class="s5">'yield'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'from'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">'yield from '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s0"># ============================================================================</span>
  <span class="s0"># == EXPRESSIONS: Anything that evaluates and can be in parens              ==</span>
  <span class="s0"># ============================================================================</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Attribute</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'dot'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'.'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'.'</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_BinOp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">op_symbol </span><span class="s4">= </span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">op</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">left</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'op'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">op_symbol</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s5">' %s ' </span><span class="s4">% </span><span class="s1">op_symbol</span><span class="s4">, </span><span class="s1">deps</span><span class="s4">=(</span><span class="s5">'op'</span><span class="s4">,))</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">right</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_BoolOp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">op_symbol </span><span class="s4">= </span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">op</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">values</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">value </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">values</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'op_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">op_symbol</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">' %s ' </span><span class="s4">% </span><span class="s1">op_symbol</span><span class="s4">, </span><span class="s1">deps</span><span class="s4">=(</span><span class="s5">'op'</span><span class="s4">,))</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Call</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">func</span><span class="s4">)</span>

    <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scope</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'arguments'</span><span class="s4">, </span><span class="s1">default_parens</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
      <span class="s0"># python &lt;3.5: starargs and kwargs are in separate fields</span>
      <span class="s0"># python 3.5+: starargs args included as a Starred nodes in the arguments</span>
      <span class="s0">#              and kwargs are included as keywords with no argument name.</span>
      <span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">version_info</span><span class="s4">[:</span><span class="s6">2</span><span class="s4">] &gt;= (</span><span class="s6">3</span><span class="s4">, </span><span class="s6">5</span><span class="s4">):</span>
        <span class="s1">any_args </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">visit_Call_arguments35</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">any_args </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">visit_Call_arguments</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">any_args</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'trailing_comma'</span><span class="s4">, </span><span class="s5">','</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_Call_arguments</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">arg_location</span><span class="s4">(</span><span class="s1">tup</span><span class="s4">):</span>
      <span class="s1">arg </span><span class="s4">= </span><span class="s1">tup</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
      <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">keyword</span><span class="s4">):</span>
        <span class="s1">arg </span><span class="s4">= </span><span class="s1">arg</span><span class="s4">.</span><span class="s1">value</span>
      <span class="s3">return </span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">, </span><span class="s5">&quot;lineno&quot;</span><span class="s4">, </span><span class="s6">0</span><span class="s4">), </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">, </span><span class="s5">&quot;col_offset&quot;</span><span class="s4">, </span><span class="s6">0</span><span class="s4">))</span>

    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">starargs</span><span class="s4">:</span>
      <span class="s1">sorted_keywords </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span>
          <span class="s4">[(</span><span class="s3">None</span><span class="s4">, </span><span class="s1">kw</span><span class="s4">) </span><span class="s3">for </span><span class="s1">kw </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">keywords</span><span class="s4">] + [(</span><span class="s5">'*'</span><span class="s4">, </span><span class="s1">node</span><span class="s4">.</span><span class="s1">starargs</span><span class="s4">)],</span>
          <span class="s1">key</span><span class="s4">=</span><span class="s1">arg_location</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">sorted_keywords </span><span class="s4">= [(</span><span class="s3">None</span><span class="s4">, </span><span class="s1">kw</span><span class="s4">) </span><span class="s3">for </span><span class="s1">kw </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">keywords</span><span class="s4">]</span>
    <span class="s1">all_args </span><span class="s4">= [(</span><span class="s3">None</span><span class="s4">, </span><span class="s1">n</span><span class="s4">) </span><span class="s3">for </span><span class="s1">n </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span><span class="s4">] + </span><span class="s1">sorted_keywords</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">:</span>
      <span class="s1">all_args</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s5">'**'</span><span class="s4">, </span><span class="s1">node</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">))</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, (</span><span class="s1">prefix</span><span class="s4">, </span><span class="s1">arg</span><span class="s4">) </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">all_args</span><span class="s4">):</span>
      <span class="s3">if </span><span class="s1">prefix </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'%s_prefix' </span><span class="s4">% </span><span class="s1">prefix</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s1">prefix</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">arg </span><span class="s3">is not </span><span class="s1">all_args</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">][</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">all_args</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_Call_arguments35</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">arg_compare</span><span class="s4">(</span><span class="s1">a1</span><span class="s4">, </span><span class="s1">a2</span><span class="s4">):</span>
      <span class="s2">&quot;&quot;&quot;Old-style comparator for sorting args.&quot;&quot;&quot;</span>
      <span class="s3">def </span><span class="s1">is_arg</span><span class="s4">(</span><span class="s1">a</span><span class="s4">):</span>
        <span class="s3">return not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">a</span><span class="s4">, (</span><span class="s1">ast</span><span class="s4">.</span><span class="s1">keyword</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">Starred</span><span class="s4">))</span>

      <span class="s0"># No kwarg can come before a regular arg (but Starred can be wherever)</span>
      <span class="s3">if </span><span class="s1">is_arg</span><span class="s4">(</span><span class="s1">a1</span><span class="s4">) </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">a2</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">keyword</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">-</span><span class="s6">1</span>
      <span class="s3">elif </span><span class="s1">is_arg</span><span class="s4">(</span><span class="s1">a2</span><span class="s4">) </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">a1</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">keyword</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s6">1</span>

      <span class="s0"># If no lineno or col_offset on one of the args, they compare as equal</span>
      <span class="s0"># (since sorting is stable, this should leave them mostly where they</span>
      <span class="s0"># were in the initial list).</span>
      <span class="s3">def </span><span class="s1">get_pos</span><span class="s4">(</span><span class="s1">a</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">a</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">keyword</span><span class="s4">):</span>
          <span class="s1">a </span><span class="s4">= </span><span class="s1">a</span><span class="s4">.</span><span class="s1">value</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">a</span><span class="s4">, </span><span class="s5">'lineno'</span><span class="s4">, </span><span class="s3">None</span><span class="s4">), </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">a</span><span class="s4">, </span><span class="s5">'col_offset'</span><span class="s4">, </span><span class="s3">None</span><span class="s4">))</span>

      <span class="s1">pos1 </span><span class="s4">= </span><span class="s1">get_pos</span><span class="s4">(</span><span class="s1">a1</span><span class="s4">)</span>
      <span class="s1">pos2 </span><span class="s4">= </span><span class="s1">get_pos</span><span class="s4">(</span><span class="s1">a2</span><span class="s4">)</span>

      <span class="s3">if None in </span><span class="s1">pos1 </span><span class="s3">or None in </span><span class="s1">pos2</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s6">0</span>

      <span class="s0"># If both have lineno/col_offset set, use that to sort them</span>
      <span class="s3">return </span><span class="s4">-</span><span class="s6">1 </span><span class="s3">if </span><span class="s1">pos1 </span><span class="s4">&lt; </span><span class="s1">pos2 </span><span class="s3">else </span><span class="s6">0 </span><span class="s3">if </span><span class="s1">pos1 </span><span class="s4">== </span><span class="s1">pos2 </span><span class="s3">else </span><span class="s6">1</span>

    <span class="s0"># Note that this always sorts keywords identically to just sorting by</span>
    <span class="s0"># lineno/col_offset, except in cases where that ordering would have been</span>
    <span class="s0"># a syntax error (named arg before unnamed arg).</span>
    <span class="s1">all_args </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">args </span><span class="s4">+ </span><span class="s1">node</span><span class="s4">.</span><span class="s1">keywords</span><span class="s4">,</span>
                      <span class="s1">key</span><span class="s4">=</span><span class="s1">functools</span><span class="s4">.</span><span class="s1">cmp_to_key</span><span class="s4">(</span><span class="s1">arg_compare</span><span class="s4">))</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">all_args</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">arg </span><span class="s3">is not </span><span class="s1">all_args</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">all_args</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_Starred</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'star'</span><span class="s4">, [</span><span class="s5">'*'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'*'</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Compare</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">left</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, (</span><span class="s1">op</span><span class="s4">, </span><span class="s1">comparator</span><span class="s4">) </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">ops</span><span class="s4">, </span><span class="s1">node</span><span class="s4">.</span><span class="s1">comparators</span><span class="s4">)):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'op_prefix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">op</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'op_suffix_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">comparator</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Dict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'{'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">)), </span><span class="s1">node</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">, </span><span class="s1">node</span><span class="s4">.</span><span class="s1">values</span><span class="s4">):</span>
      <span class="s3">if </span><span class="s1">key </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s0"># Handle Python 3.5+ dict unpacking syntax (PEP-448)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'starstar_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'**'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'**'</span><span class="s4">)</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'key_val_sep_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">': '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">value </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">values</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'extracomma'</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">allow_whitespace_prefix</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'close_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'}'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'}'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_DictComp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_dict'</span><span class="s4">, [</span><span class="s5">'{'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'{'</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">key</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'key_val_sep'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">': '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">comp </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">generators</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">comp</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'close_dict'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'}'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'}'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_GeneratorExp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_comp_exp</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_IfExp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'if'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'if'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' if '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">test</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'else'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' else '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">orelse</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Lambda</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'lambda_def'</span><span class="s4">, [</span><span class="s5">'lambda'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'lambda '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'open_lambda'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">': '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">body</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_List</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'list_open'</span><span class="s4">, [</span><span class="s5">'['</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'['</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">elt </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">elts</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">elt</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">elt </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">elts</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">elts</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'extracomma'</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">allow_whitespace_prefix</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'list_close'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">']'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">']'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_ListComp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_comp_exp</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">open_brace</span><span class="s4">=</span><span class="s5">'['</span><span class="s4">, </span><span class="s1">close_brace</span><span class="s4">=</span><span class="s5">']'</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">_comp_exp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">open_brace</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">close_brace</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">open_brace</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'compexp_open'</span><span class="s4">, [</span><span class="s1">open_brace</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s1">open_brace</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">elt</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">comp </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">generators</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">comp</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">close_brace</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'compexp_close'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">close_brace</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s1">close_brace</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Name</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">id</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_NameConstant</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">))</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Repr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'repr_open'</span><span class="s4">, [</span><span class="s5">'`'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'`'</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'repr_close'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'`'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'`'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Set</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'set_open'</span><span class="s4">, [</span><span class="s5">'{'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'{'</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">elt </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">elts</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">elt</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">elt </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">elts</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'extracomma'</span><span class="s4">, </span><span class="s5">','</span><span class="s4">,</span>
                            <span class="s1">allow_whitespace_prefix</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'set_close'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'}'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'}'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_SetComp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_comp_exp</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">open_brace</span><span class="s4">=</span><span class="s5">'{'</span><span class="s4">, </span><span class="s1">close_brace</span><span class="s4">=</span><span class="s5">'}'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Subscript</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'slice_open'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'['</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'['</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">slice</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'slice_close'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">']'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">']'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Tuple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scope</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'elts'</span><span class="s4">, </span><span class="s1">default_parens</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
      <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">elt </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">elts</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">elt</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">elt </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">elts</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                    <span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
          <span class="s1">self</span><span class="s4">.</span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'extracomma'</span><span class="s4">, </span><span class="s5">','</span><span class="s4">,</span>
                              <span class="s1">allow_whitespace_prefix</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                              <span class="s1">default</span><span class="s4">=</span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">elts</span><span class="s4">) == </span><span class="s6">1</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_UnaryOp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">op_symbol </span><span class="s4">= </span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">op</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'op'</span><span class="s4">, [</span><span class="s1">op_symbol</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s1">op_symbol</span><span class="s4">, </span><span class="s1">deps</span><span class="s4">=(</span><span class="s5">'op'</span><span class="s4">,))</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">operand</span><span class="s4">)</span>

  <span class="s0"># ============================================================================</span>
  <span class="s0"># == OPERATORS AND TOKENS: Anything that's just whitespace and tokens       ==</span>
  <span class="s0"># ============================================================================</span>

  <span class="s4">@</span><span class="s1">space_around</span>
  <span class="s3">def </span><span class="s1">visit_Ellipsis</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'...'</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_Add</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Sub</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Mult</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Div</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Mod</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Pow</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_LShift</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_RShift</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_BitAnd</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_BitOr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_BitXor</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_FloorDiv</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Invert</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Not</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_UAdd</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_USub</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Eq</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_NotEq</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'operator'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">one_of_symbols</span><span class="s4">(</span><span class="s5">'!='</span><span class="s4">, </span><span class="s5">'&lt;&gt;'</span><span class="s4">)])</span>

  <span class="s3">def </span><span class="s1">visit_Lt</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_LtE</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Gt</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_GtE</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_Is</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_IsNot</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'content'</span><span class="s4">, [</span><span class="s5">'is'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'not'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'is not'</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit_In</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">ast_constants</span><span class="s4">.</span><span class="s1">NODE_TYPE_TO_TOKENS</span><span class="s4">[</span><span class="s1">type</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)][</span><span class="s6">0</span><span class="s4">])</span>

  <span class="s3">def </span><span class="s1">visit_NotIn</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'content'</span><span class="s4">, [</span><span class="s5">'not'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'in'</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'not in'</span><span class="s4">)</span>

  <span class="s0"># ============================================================================</span>
  <span class="s0"># == MISC NODES: Nodes which are neither statements nor expressions         ==</span>
  <span class="s0"># ============================================================================</span>

  <span class="s3">def </span><span class="s1">visit_alias</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">name_pattern </span><span class="s4">= []</span>
    <span class="s1">parts </span><span class="s4">= </span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">part </span><span class="s3">in </span><span class="s1">parts</span><span class="s4">[:-</span><span class="s6">1</span><span class="s4">]:</span>
      <span class="s1">name_pattern </span><span class="s4">+= [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">part</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'.'</span><span class="s4">]</span>
    <span class="s1">name_pattern </span><span class="s4">+= [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s1">parts</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]]</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'name'</span><span class="s4">, </span><span class="s1">name_pattern</span><span class="s4">,</span>
              <span class="s1">deps</span><span class="s4">=(</span><span class="s5">'name'</span><span class="s4">,),</span>
              <span class="s1">default</span><span class="s4">=</span><span class="s1">node</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">asname </span><span class="s3">is not None</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'asname'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'as'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' as '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">asname</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">space_around</span>
  <span class="s3">def </span><span class="s1">visit_arg</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">arg</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">annotation </span><span class="s3">is not None</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'annotation_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">': '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">annotation</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">space_around</span>
  <span class="s3">def </span><span class="s1">visit_arguments</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s0"># In Python 3, args appearing after *args must be kwargs</span>
    <span class="s1">kwonlyargs </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'kwonlyargs'</span><span class="s4">, [])</span>
    <span class="s1">kw_defaults </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'kw_defaults'</span><span class="s4">, [])</span>
    <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">kwonlyargs</span><span class="s4">) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">kw_defaults</span><span class="s4">)</span>

    <span class="s1">total_args </span><span class="s4">= </span><span class="s1">sum</span><span class="s4">((</span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">args </span><span class="s4">+ </span><span class="s1">kwonlyargs</span><span class="s4">),</span>
                      <span class="s1">len</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'posonlyargs'</span><span class="s4">, [])),</span>
                      <span class="s6">1 </span><span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">vararg </span><span class="s3">else </span><span class="s6">0</span><span class="s4">,</span>
                      <span class="s6">1 </span><span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">kwarg </span><span class="s3">else </span><span class="s6">0</span><span class="s4">))</span>
    <span class="s1">arg_i </span><span class="s4">= </span><span class="s6">0</span>

    <span class="s1">pos_args </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'posonlyargs'</span><span class="s4">, []) + </span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span>
    <span class="s1">positional </span><span class="s4">= </span><span class="s1">pos_args</span><span class="s4">[:-</span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">defaults</span><span class="s4">)] </span><span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">defaults </span><span class="s3">else </span><span class="s1">pos_args</span>
    <span class="s1">keyword </span><span class="s4">= </span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span><span class="s4">[-</span><span class="s1">len</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">defaults</span><span class="s4">):] </span><span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">defaults </span><span class="s3">else </span><span class="s1">node</span><span class="s4">.</span><span class="s1">args</span>

    <span class="s3">for </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">positional</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">)</span>
      <span class="s1">arg_i </span><span class="s4">+= </span><span class="s6">1</span>
      <span class="s3">if </span><span class="s1">arg_i </span><span class="s4">&lt; </span><span class="s1">total_args</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">arg_i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">arg_i </span><span class="s4">== </span><span class="s1">len</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'posonlyargs'</span><span class="s4">, [])):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'posonly_sep'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'/'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">'/, '</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, (</span><span class="s1">arg</span><span class="s4">, </span><span class="s1">default</span><span class="s4">) </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">keyword</span><span class="s4">, </span><span class="s1">node</span><span class="s4">.</span><span class="s1">defaults</span><span class="s4">)):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'default_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'='</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'='</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">default</span><span class="s4">)</span>
      <span class="s1">arg_i </span><span class="s4">+= </span><span class="s6">1</span>
      <span class="s3">if </span><span class="s1">arg_i </span><span class="s4">&lt; </span><span class="s1">total_args</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">arg_i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">vararg</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'vararg_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'*'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'*'</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">vararg</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">AST</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">vararg</span><span class="s4">)</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">vararg</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'vararg_suffix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span>
      <span class="s1">arg_i </span><span class="s4">+= </span><span class="s6">1</span>
      <span class="s3">if </span><span class="s1">arg_i </span><span class="s4">&lt; </span><span class="s1">total_args</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">','</span><span class="s4">)</span>
    <span class="s3">elif </span><span class="s1">kwonlyargs</span><span class="s4">:</span>
      <span class="s0"># If no vararg, but we have kwonlyargs, insert a naked *, which will</span>
      <span class="s0"># definitely not be the last arg.</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'kwonly_sep'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'*'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span><span class="s1">;</span>

    <span class="s3">for </span><span class="s1">i</span><span class="s4">, (</span><span class="s1">arg</span><span class="s4">, </span><span class="s1">default</span><span class="s4">) </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">kwonlyargs</span><span class="s4">, </span><span class="s1">kw_defaults</span><span class="s4">)):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">default </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'kw_default_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'='</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">'='</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">default</span><span class="s4">)</span>
      <span class="s1">arg_i </span><span class="s4">+= </span><span class="s6">1</span>
      <span class="s3">if </span><span class="s1">arg_i </span><span class="s4">&lt; </span><span class="s1">total_args</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'comma_%d' </span><span class="s4">% </span><span class="s1">arg_i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                  <span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">kwarg</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'kwarg_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'**'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'**'</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">kwarg</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">AST</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">kwarg</span><span class="s4">)</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">kwarg</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'kwarg_suffix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span>

  <span class="s4">@</span><span class="s1">space_around</span>
  <span class="s3">def </span><span class="s1">visit_comprehension</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'is_async'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'for'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'async'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'for'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">' async for '</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'for'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'for'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' for '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'in'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'in'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' in '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">iter</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">if_expr </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">ifs</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'if_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'if'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">' if '</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">if_expr</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">space_around</span>
  <span class="s3">def </span><span class="s1">visit_keyword</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">arg </span><span class="s3">is None</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'stars'</span><span class="s4">, [</span><span class="s5">'**'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'**'</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">arg</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'eq'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'='</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">'='</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">space_left</span>
  <span class="s3">def </span><span class="s1">visit_Index</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">space_left</span>
  <span class="s3">def </span><span class="s1">visit_ExtSlice</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">dim </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">dims</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">dim</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">dim </span><span class="s3">is not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">dims</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'dim_sep_%d' </span><span class="s4">% </span><span class="s1">i</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">', '</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'trailing_comma'</span><span class="s4">, </span><span class="s5">','</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">space_left</span>
  <span class="s3">def </span><span class="s1">visit_Slice</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'lowerspace'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s5">':'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">upper</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">upper</span><span class="s4">)</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'stepspace1'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'step_colon'</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'stepspace2'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">])</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">step </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">check_slice_includes_step</span><span class="s4">(</span><span class="s1">node</span><span class="s4">):</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'step_colon_2'</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
      <span class="s1">node</span><span class="s4">.</span><span class="s1">step</span><span class="s4">.</span><span class="s1">is_explicit_step </span><span class="s4">= </span><span class="s3">True</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">step</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">check_slice_includes_step</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Helper function for Slice node to determine whether to visit its step.&quot;&quot;&quot;</span>
    <span class="s0"># This is needed because of a bug in the 2.7 parser which treats</span>
    <span class="s0"># a[::] as Slice(lower=None, upper=None, step=Name(id='None'))</span>
    <span class="s0"># but also treats a[::None] exactly the same.</span>
    <span class="s3">if not </span><span class="s1">node</span><span class="s4">.</span><span class="s1">step</span><span class="s4">:</span>
      <span class="s3">return False</span>
    <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">step</span><span class="s4">, </span><span class="s5">'is_explicit_step'</span><span class="s4">, </span><span class="s3">False</span><span class="s4">):</span>
      <span class="s3">return True</span>
    <span class="s3">return not </span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">step</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">) </span><span class="s3">and </span><span class="s1">node</span><span class="s4">.</span><span class="s1">step</span><span class="s4">.</span><span class="s1">id </span><span class="s4">== </span><span class="s5">'None'</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">fstring_expression</span>
  <span class="s3">def </span><span class="s1">visit_FormattedValue</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">conversion </span><span class="s4">!= -</span><span class="s6">1</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'conversion'</span><span class="s4">,</span>
                <span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">'!'</span><span class="s4">, </span><span class="s1">chr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">conversion</span><span class="s4">)], </span><span class="s1">deps</span><span class="s4">=(</span><span class="s5">'conversion'</span><span class="s4">,),</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">'!%c' </span><span class="s4">% </span><span class="s1">node</span><span class="s4">.</span><span class="s1">conversion</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">format_spec</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'format_spec_prefix'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">, </span><span class="s5">':'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">],</span>
                <span class="s1">default</span><span class="s4">=</span><span class="s5">':'</span><span class="s4">)</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">format_spec</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">AnnotationError</span><span class="s4">(</span><span class="s1">Exception</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;An exception for when we failed to annotate the tree.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">AstAnnotator</span><span class="s4">(</span><span class="s1">BaseVisitor</span><span class="s4">):</span>

  <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">source</span><span class="s4">):</span>
    <span class="s1">super</span><span class="s4">(</span><span class="s1">AstAnnotator</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">__init__</span><span class="s4">()</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens </span><span class="s4">= </span><span class="s1">token_generator</span><span class="s4">.</span><span class="s1">TokenGenerator</span><span class="s4">(</span><span class="s1">source</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">visit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s3">try</span><span class="s4">:</span>
      <span class="s1">fmt</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'indent'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent</span><span class="s4">)</span>
      <span class="s1">fmt</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'indent_diff'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff</span><span class="s4">)</span>
      <span class="s1">super</span><span class="s4">(</span><span class="s1">AstAnnotator</span><span class="s4">, </span><span class="s1">self</span><span class="s4">).</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">node</span><span class="s4">)</span>
    <span class="s3">except </span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">IndexError</span><span class="s4">, </span><span class="s1">KeyError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
      <span class="s3">raise </span><span class="s1">AnnotationError</span><span class="s4">(</span><span class="s1">e</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">indented</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">children_attr</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Generator which annotates child nodes with their indentation level.&quot;&quot;&quot;</span>
    <span class="s1">children </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">children_attr</span><span class="s4">)</span>
    <span class="s1">cur_loc </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">_loc</span>
    <span class="s1">next_loc </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek_non_whitespace</span><span class="s4">().</span><span class="s1">start</span>
    <span class="s0"># Special case: if the children are on the same line, then there is no</span>
    <span class="s0"># indentation level to track.</span>
    <span class="s3">if </span><span class="s1">cur_loc</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s1">next_loc</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
      <span class="s1">indent_diff </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff </span><span class="s4">= </span><span class="s3">None</span>
      <span class="s3">for </span><span class="s1">child </span><span class="s3">in </span><span class="s1">children</span><span class="s4">:</span>
        <span class="s3">yield </span><span class="s1">child</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff </span><span class="s4">= </span><span class="s1">indent_diff</span>
      <span class="s3">return</span>

    <span class="s1">prev_indent </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent</span>
    <span class="s1">prev_indent_diff </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff</span>

    <span class="s0"># Find the indent level of the first child</span>
    <span class="s1">indent_token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek_conditional</span><span class="s4">(</span>
        <span class="s3">lambda </span><span class="s1">t</span><span class="s4">: </span><span class="s1">t</span><span class="s4">.</span><span class="s1">type </span><span class="s4">== </span><span class="s1">token_generator</span><span class="s4">.</span><span class="s1">TOKENS</span><span class="s4">.</span><span class="s1">INDENT</span><span class="s4">)</span>
    <span class="s1">new_indent </span><span class="s4">= </span><span class="s1">indent_token</span><span class="s4">.</span><span class="s1">src</span>
    <span class="s1">new_diff </span><span class="s4">= </span><span class="s1">_get_indent_diff</span><span class="s4">(</span><span class="s1">prev_indent</span><span class="s4">, </span><span class="s1">new_indent</span><span class="s4">)</span>
    <span class="s3">if not </span><span class="s1">new_diff</span><span class="s4">:</span>
      <span class="s1">new_diff </span><span class="s4">= </span><span class="s5">' ' </span><span class="s4">* </span><span class="s6">4  </span><span class="s0"># Sensible default</span>
      <span class="s1">print</span><span class="s4">(</span><span class="s5">'Indent detection failed (line %d); inner indentation level is not '</span>
            <span class="s5">'more than the outer indentation.' </span><span class="s4">% </span><span class="s1">cur_loc</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">file</span><span class="s4">=</span><span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span><span class="s4">)</span>

    <span class="s0"># Set the indent level to the child's indent and iterate over the children</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent </span><span class="s4">= </span><span class="s1">new_indent</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff </span><span class="s4">= </span><span class="s1">new_diff</span>
    <span class="s3">for </span><span class="s1">child </span><span class="s3">in </span><span class="s1">children</span><span class="s4">:</span>
      <span class="s3">yield </span><span class="s1">child</span>
    <span class="s0"># Store the suffix at this indentation level, which could be many lines</span>
    <span class="s1">fmt</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'block_suffix_%s' </span><span class="s4">% </span><span class="s1">children_attr</span><span class="s4">,</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">block_whitespace</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_indent</span><span class="s4">))</span>

    <span class="s0"># Dedent back to the previous level</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent </span><span class="s4">= </span><span class="s1">prev_indent</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">_indent_diff </span><span class="s4">= </span><span class="s1">prev_indent_diff</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Num</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Annotate a Num node with the exact number format.&quot;&quot;&quot;</span>
    <span class="s1">token_number_type </span><span class="s4">= </span><span class="s1">token_generator</span><span class="s4">.</span><span class="s1">TOKENS</span><span class="s4">.</span><span class="s1">NUMBER</span>
    <span class="s1">contentargs </span><span class="s4">= [</span><span class="s3">lambda</span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">next_of_type</span><span class="s4">(</span><span class="s1">token_number_type</span><span class="s4">).</span><span class="s1">src</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek</span><span class="s4">().</span><span class="s1">src </span><span class="s4">== </span><span class="s5">'-'</span><span class="s4">:</span>
      <span class="s1">contentargs</span><span class="s4">.</span><span class="s1">insert</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s5">'-'</span><span class="s4">)</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'content'</span><span class="s4">, </span><span class="s1">contentargs</span><span class="s4">, </span><span class="s1">deps</span><span class="s4">=(</span><span class="s5">'n'</span><span class="s4">,), </span><span class="s1">default</span><span class="s4">=</span><span class="s1">str</span><span class="s4">(</span><span class="s1">node</span><span class="s4">.</span><span class="s1">n</span><span class="s4">))</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Annotate a Str node with the exact string format.&quot;&quot;&quot;</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'content'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">str</span><span class="s4">], </span><span class="s1">deps</span><span class="s4">=(</span><span class="s5">'s'</span><span class="s4">,), </span><span class="s1">default</span><span class="s4">=</span><span class="s1">node</span><span class="s4">.</span><span class="s1">s</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_JoinedStr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Annotate a JoinedStr node with the fstr formatting metadata.&quot;&quot;&quot;</span>
    <span class="s1">fstr_iter </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">fstr</span><span class="s4">()()</span>
    <span class="s1">res </span><span class="s4">= </span><span class="s5">''</span>
    <span class="s1">values </span><span class="s4">= (</span><span class="s1">v </span><span class="s3">for </span><span class="s1">v </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">values </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">v</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">FormattedValue</span><span class="s4">))</span>
    <span class="s3">while True</span><span class="s4">:</span>
      <span class="s1">res_part</span><span class="s4">, </span><span class="s1">tg </span><span class="s4">= </span><span class="s1">next</span><span class="s4">(</span><span class="s1">fstr_iter</span><span class="s4">)</span>
      <span class="s1">res </span><span class="s4">+= </span><span class="s1">res_part</span>
      <span class="s3">if </span><span class="s1">tg </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">break</span>
      <span class="s1">prev_tokens </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens </span><span class="s4">= </span><span class="s1">tg</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">visit</span><span class="s4">(</span><span class="s1">next</span><span class="s4">(</span><span class="s1">values</span><span class="s4">))</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens </span><span class="s4">= </span><span class="s1">prev_tokens</span>

    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'content'</span><span class="s4">, [</span><span class="s3">lambda</span><span class="s4">: </span><span class="s1">res</span><span class="s4">], </span><span class="s1">default</span><span class="s4">=</span><span class="s1">res</span><span class="s4">)</span>

  <span class="s4">@</span><span class="s1">expression</span>
  <span class="s3">def </span><span class="s1">visit_Bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Annotate a Bytes node with the exact string format.&quot;&quot;&quot;</span>
    <span class="s1">self</span><span class="s4">.</span><span class="s1">attr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'content'</span><span class="s4">, [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">str</span><span class="s4">], </span><span class="s1">deps</span><span class="s4">=(</span><span class="s5">'s'</span><span class="s4">,), </span><span class="s1">default</span><span class="s4">=</span><span class="s1">node</span><span class="s4">.</span><span class="s1">s</span><span class="s4">)</span>
    
  <span class="s4">@</span><span class="s1">space_around</span>
  <span class="s3">def </span><span class="s1">visit_Ellipsis</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s0"># Ellipsis is sometimes split into 3 tokens and other times a single token</span>
    <span class="s0"># Account for both forms when parsing the input.</span>
    <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek</span><span class="s4">().</span><span class="s1">src </span><span class="s4">== </span><span class="s5">'...'</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'...'</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s6">3</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">check_is_elif</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Return True iff the If node is an `elif` in the source.&quot;&quot;&quot;</span>
    <span class="s1">next_tok </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">next_name</span><span class="s4">()</span>
    <span class="s3">return </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">If</span><span class="s4">) </span><span class="s3">and </span><span class="s1">next_tok</span><span class="s4">.</span><span class="s1">src </span><span class="s4">== </span><span class="s5">'elif'</span>

  <span class="s3">def </span><span class="s1">check_is_continued_try</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Return True iff the TryExcept node is a continued `try` in the source.&quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">TryExcept</span><span class="s4">) </span><span class="s3">and</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek_non_whitespace</span><span class="s4">().</span><span class="s1">src </span><span class="s4">!= </span><span class="s5">'try'</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">check_is_continued_with</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Return True iff the With node is a continued `with` in the source.&quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">ast</span><span class="s4">.</span><span class="s1">With</span><span class="s4">) </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek</span><span class="s4">().</span><span class="s1">src </span><span class="s4">== </span><span class="s5">','</span>

  <span class="s3">def </span><span class="s1">check_slice_includes_step</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Helper function for Slice node to determine whether to visit its step.&quot;&quot;&quot;</span>
    <span class="s0"># This is needed because of a bug in the 2.7 parser which treats</span>
    <span class="s0"># a[::] as Slice(lower=None, upper=None, step=Name(id='None'))</span>
    <span class="s0"># but also treats a[::None] exactly the same.</span>
    <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek_non_whitespace</span><span class="s4">().</span><span class="s1">src </span><span class="s3">not in </span><span class="s5">'],'</span>

  <span class="s3">def </span><span class="s1">ws</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">max_lines</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">semicolon</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Parse some whitespace from the source tokens and return it.&quot;&quot;&quot;</span>
    <span class="s1">next_token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek</span><span class="s4">()</span>
    <span class="s3">if </span><span class="s1">semicolon </span><span class="s3">and </span><span class="s1">next_token </span><span class="s3">and </span><span class="s1">next_token</span><span class="s4">.</span><span class="s1">src </span><span class="s4">== </span><span class="s5">';'</span><span class="s4">:</span>
      <span class="s1">result </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">whitespace</span><span class="s4">() + </span><span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s5">';'</span><span class="s4">)</span>
      <span class="s1">next_token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek</span><span class="s4">()</span>
      <span class="s3">if </span><span class="s1">next_token</span><span class="s4">.</span><span class="s1">type </span><span class="s3">in </span><span class="s4">(</span><span class="s1">token_generator</span><span class="s4">.</span><span class="s1">TOKENS</span><span class="s4">.</span><span class="s1">NL</span><span class="s4">,</span>
                             <span class="s1">token_generator</span><span class="s4">.</span><span class="s1">TOKENS</span><span class="s4">.</span><span class="s1">NEWLINE</span><span class="s4">):</span>
        <span class="s1">result </span><span class="s4">+= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">whitespace</span><span class="s4">(</span><span class="s1">max_lines</span><span class="s4">=</span><span class="s6">1</span><span class="s4">)</span>
      <span class="s3">return </span><span class="s1">result</span>
    <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">whitespace</span><span class="s4">(</span><span class="s1">max_lines</span><span class="s4">=</span><span class="s1">max_lines</span><span class="s4">, </span><span class="s1">comment</span><span class="s4">=</span><span class="s1">comment</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">dots</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">num_dots</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Parse a number of dots.&quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">_parse_dots</span><span class="s4">():</span>
      <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">dots</span><span class="s4">(</span><span class="s1">num_dots</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">_parse_dots</span>

  <span class="s3">def </span><span class="s1">block_suffix</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">indent_level</span><span class="s4">):</span>
    <span class="s1">fmt</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s5">'suffix'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">block_whitespace</span><span class="s4">(</span><span class="s1">indent_level</span><span class="s4">))</span>

  <span class="s3">def </span><span class="s1">token</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">token_val</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Parse a single token with exactly the given value.&quot;&quot;&quot;</span>
    <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">next</span><span class="s4">()</span>
    <span class="s3">if </span><span class="s1">token</span><span class="s4">.</span><span class="s1">src </span><span class="s4">!= </span><span class="s1">token_val</span><span class="s4">:</span>
      <span class="s3">raise </span><span class="s1">AnnotationError</span><span class="s4">(</span><span class="s5">&quot;Expected %r but found %r</span><span class="s3">\n</span><span class="s5">line %d: %s&quot; </span><span class="s4">% (</span>
          <span class="s1">token_val</span><span class="s4">, </span><span class="s1">token</span><span class="s4">.</span><span class="s1">src</span><span class="s4">, </span><span class="s1">token</span><span class="s4">.</span><span class="s1">start</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">token</span><span class="s4">.</span><span class="s1">line</span><span class="s4">))</span>

    <span class="s0"># If the token opens or closes a parentheses scope, keep track of it</span>
    <span class="s3">if </span><span class="s1">token</span><span class="s4">.</span><span class="s1">src </span><span class="s3">in </span><span class="s5">'({['</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">hint_open</span><span class="s4">()</span>
    <span class="s3">elif </span><span class="s1">token</span><span class="s4">.</span><span class="s1">src </span><span class="s3">in </span><span class="s5">')}]'</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">hint_closed</span><span class="s4">()</span>

    <span class="s3">return </span><span class="s1">token</span><span class="s4">.</span><span class="s1">src</span>

  <span class="s3">def </span><span class="s1">optional_token</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">token_val</span><span class="s4">,</span>
                     <span class="s1">allow_whitespace_prefix</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Try to parse a token and attach it to the node.&quot;&quot;&quot;</span>
    <span class="s3">del </span><span class="s1">default</span>
    <span class="s1">fmt</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s5">''</span><span class="s4">)</span>
    <span class="s1">token </span><span class="s4">= (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek_non_whitespace</span><span class="s4">()</span>
             <span class="s3">if </span><span class="s1">allow_whitespace_prefix </span><span class="s3">else </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek</span><span class="s4">())</span>
    <span class="s3">if </span><span class="s1">token </span><span class="s3">and </span><span class="s1">token</span><span class="s4">.</span><span class="s1">src </span><span class="s4">== </span><span class="s1">token_val</span><span class="s4">:</span>
      <span class="s1">parsed </span><span class="s4">= </span><span class="s5">''</span>
      <span class="s3">if </span><span class="s1">allow_whitespace_prefix</span><span class="s4">:</span>
        <span class="s1">parsed </span><span class="s4">+= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">()</span>
      <span class="s1">fmt</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">,</span>
                           <span class="s1">parsed </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">next</span><span class="s4">().</span><span class="s1">src </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">())</span>

  <span class="s3">def </span><span class="s1">one_of_symbols</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">symbols</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Account for one of the given symbols.&quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">_one_of_symbols</span><span class="s4">():</span>
      <span class="s1">next_token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">next</span><span class="s4">()</span>
      <span class="s1">found </span><span class="s4">= </span><span class="s1">next</span><span class="s4">((</span><span class="s1">s </span><span class="s3">for </span><span class="s1">s </span><span class="s3">in </span><span class="s1">symbols </span><span class="s3">if </span><span class="s1">s </span><span class="s4">== </span><span class="s1">next_token</span><span class="s4">.</span><span class="s1">src</span><span class="s4">), </span><span class="s3">None</span><span class="s4">)</span>
      <span class="s3">if </span><span class="s1">found </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">AnnotationError</span><span class="s4">(</span>
            <span class="s5">'Expected one of: %r, but found: %r' </span><span class="s4">% (</span><span class="s1">symbols</span><span class="s4">, </span><span class="s1">next_token</span><span class="s4">.</span><span class="s1">src</span><span class="s4">))</span>
      <span class="s3">return </span><span class="s1">found</span>
    <span class="s3">return </span><span class="s1">_one_of_symbols</span>

  <span class="s3">def </span><span class="s1">attr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">attr_vals</span><span class="s4">, </span><span class="s1">deps</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Parses some source and sets an attribute on the given node. 
 
    Stores some arbitrary formatting information on the node. This takes a list 
    attr_vals which tell what parts of the source to parse. The result of each 
    function is concatenated onto the formatting data, and strings in this list 
    are a shorthand to look for an exactly matching token. 
 
    For example: 
      self.attr(node, 'foo', ['(', self.ws, 'Hello, world!', self.ws, ')'], 
                deps=('s',), default=node.s) 
 
    is a rudimentary way to parse a parenthesized string. After running this, 
    the matching source code for this node will be stored in its formatting 
    dict under the key 'foo'. The result might be `(\n  'Hello, world!'\n)`. 
 
    This also keeps track of the current value of each of the dependencies. 
    In the above example, we would have looked for the string 'Hello, world!' 
    because that's the value of node.s, however, when we print this back, we 
    want to know if the value of node.s has changed since this time. If any of 
    the dependent values has changed, the default would be used instead. 
 
    Arguments: 
      node: (ast.AST) An AST node to attach formatting information to. 
      attr_name: (string) Name to store the formatting information under. 
      attr_vals: (list of functions/strings) Each item is either a function 
        that parses some source and return a string OR a string to match 
        exactly (as a token). 
      deps: (optional, set of strings) Attributes of the node which attr_vals 
        depends on. 
      default: (string) Unused here. 
    &quot;&quot;&quot;</span>
    <span class="s3">del </span><span class="s1">default  </span><span class="s0"># unused</span>
    <span class="s3">if </span><span class="s1">deps</span><span class="s4">:</span>
      <span class="s3">for </span><span class="s1">dep </span><span class="s3">in </span><span class="s1">deps</span><span class="s4">:</span>
        <span class="s1">fmt</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">dep </span><span class="s4">+ </span><span class="s5">'__src'</span><span class="s4">, </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">dep</span><span class="s4">, </span><span class="s3">None</span><span class="s4">))</span>
    <span class="s1">attr_parts </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">attr_val </span><span class="s3">in </span><span class="s1">attr_vals</span><span class="s4">:</span>
      <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">attr_val</span><span class="s4">, </span><span class="s1">six</span><span class="s4">.</span><span class="s1">string_types</span><span class="s4">):</span>
        <span class="s1">attr_parts</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">token</span><span class="s4">(</span><span class="s1">attr_val</span><span class="s4">))</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">attr_parts</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">attr_val</span><span class="s4">())</span>
    <span class="s1">fmt</span><span class="s4">.</span><span class="s1">set</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s5">''</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">attr_parts</span><span class="s4">))</span>

  <span class="s3">def </span><span class="s1">scope</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">trailing_comma</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">default_parens</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Return a context manager to handle a parenthesized scope. 
 
    Arguments: 
      node: (ast.AST) Node to store the scope prefix and suffix on. 
      attr: (string, optional) Attribute of the node contained in the scope, if 
        any. For example, as `None`, the scope would wrap the entire node, but 
        as 'bases', the scope might wrap only the bases of a class. 
      trailing_comma: (boolean) If True, allow a trailing comma at the end. 
      default_parens: (boolean) If True and no formatting information is 
        present, the scope would be assumed to be parenthesized. 
    &quot;&quot;&quot;</span>
    <span class="s3">del </span><span class="s1">default_parens</span>
    <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">scope</span><span class="s4">(</span><span class="s1">node</span><span class="s4">, </span><span class="s1">attr</span><span class="s4">=</span><span class="s1">attr</span><span class="s4">, </span><span class="s1">trailing_comma</span><span class="s4">=</span><span class="s1">trailing_comma</span><span class="s4">)</span>

  <span class="s3">def </span><span class="s1">_optional_token</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">token_type</span><span class="s4">, </span><span class="s1">token_val</span><span class="s4">):</span>
    <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">peek</span><span class="s4">()</span>
    <span class="s3">if not </span><span class="s1">token </span><span class="s3">or </span><span class="s1">token</span><span class="s4">.</span><span class="s1">type </span><span class="s4">!= </span><span class="s1">token_type </span><span class="s3">or </span><span class="s1">token</span><span class="s4">.</span><span class="s1">src </span><span class="s4">!= </span><span class="s1">token_val</span><span class="s4">:</span>
      <span class="s3">return </span><span class="s5">''</span>
    <span class="s3">else</span><span class="s4">:</span>
      <span class="s1">self</span><span class="s4">.</span><span class="s1">tokens</span><span class="s4">.</span><span class="s1">next</span><span class="s4">()</span>
      <span class="s3">return </span><span class="s1">token</span><span class="s4">.</span><span class="s1">src </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ws</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">_get_indent_width</span><span class="s4">(</span><span class="s1">indent</span><span class="s4">):</span>
  <span class="s1">width </span><span class="s4">= </span><span class="s6">0</span>
  <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">indent</span><span class="s4">:</span>
    <span class="s3">if </span><span class="s1">c </span><span class="s4">== </span><span class="s5">' '</span><span class="s4">:</span>
      <span class="s1">width </span><span class="s4">+= </span><span class="s6">1</span>
    <span class="s3">elif </span><span class="s1">c </span><span class="s4">== </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">'</span><span class="s4">:</span>
      <span class="s1">width </span><span class="s4">+= </span><span class="s6">8 </span><span class="s4">- (</span><span class="s1">width </span><span class="s4">% </span><span class="s6">8</span><span class="s4">)</span>
  <span class="s3">return </span><span class="s1">width</span>


<span class="s3">def </span><span class="s1">_ltrim_indent</span><span class="s4">(</span><span class="s1">indent</span><span class="s4">, </span><span class="s1">remove_width</span><span class="s4">):</span>
  <span class="s1">width </span><span class="s4">= </span><span class="s6">0</span>
  <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">c </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">indent</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">width </span><span class="s4">== </span><span class="s1">remove_width</span><span class="s4">:</span>
      <span class="s3">break</span>
    <span class="s3">if </span><span class="s1">c </span><span class="s4">== </span><span class="s5">' '</span><span class="s4">:</span>
      <span class="s1">width </span><span class="s4">+= </span><span class="s6">1</span>
    <span class="s3">elif </span><span class="s1">c </span><span class="s4">== </span><span class="s5">'</span><span class="s3">\t</span><span class="s5">'</span><span class="s4">:</span>
      <span class="s3">if </span><span class="s1">width </span><span class="s4">+ </span><span class="s6">8 </span><span class="s4">- (</span><span class="s1">width </span><span class="s4">% </span><span class="s6">8</span><span class="s4">) &lt;= </span><span class="s1">remove_width</span><span class="s4">:</span>
        <span class="s1">width </span><span class="s4">+= </span><span class="s6">8 </span><span class="s4">- (</span><span class="s1">width </span><span class="s4">% </span><span class="s6">8</span><span class="s4">)</span>
      <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">' ' </span><span class="s4">* (</span><span class="s1">width </span><span class="s4">+ </span><span class="s6">8 </span><span class="s4">- </span><span class="s1">remove_width</span><span class="s4">) + </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">:]</span>
  <span class="s3">return </span><span class="s1">indent</span><span class="s4">[</span><span class="s1">i</span><span class="s4">:]</span>


<span class="s3">def </span><span class="s1">_get_indent_diff</span><span class="s4">(</span><span class="s1">outer</span><span class="s4">, </span><span class="s1">inner</span><span class="s4">):</span>
  <span class="s2">&quot;&quot;&quot;Computes the whitespace added to an indented block. 
 
  Finds the portion of an indent prefix that is added onto the outer indent. In 
  most cases, the inner indent starts with the outer indent, but this is not 
  necessarily true. For example, the outer block could be indented to four 
  spaces and its body indented with one tab (effectively 8 spaces). 
 
  Arguments: 
    outer: (string) Indentation of the outer block. 
    inner: (string) Indentation of the inner block. 
  Returns: 
    The string whitespace which is added to the indentation level when moving 
    from outer to inner. 
  &quot;&quot;&quot;</span>
  <span class="s1">outer_w </span><span class="s4">= </span><span class="s1">_get_indent_width</span><span class="s4">(</span><span class="s1">outer</span><span class="s4">)</span>
  <span class="s1">inner_w </span><span class="s4">= </span><span class="s1">_get_indent_width</span><span class="s4">(</span><span class="s1">inner</span><span class="s4">)</span>
  <span class="s1">diff_w </span><span class="s4">= </span><span class="s1">inner_w </span><span class="s4">- </span><span class="s1">outer_w</span>

  <span class="s3">if </span><span class="s1">diff_w </span><span class="s4">&lt;= </span><span class="s6">0</span><span class="s4">:</span>
    <span class="s3">return None</span>

  <span class="s3">return </span><span class="s1">_ltrim_indent</span><span class="s4">(</span><span class="s1">inner</span><span class="s4">, </span><span class="s1">inner_w </span><span class="s4">- </span><span class="s1">diff_w</span><span class="s4">)</span>
</pre>
</body>
</html>