<html>
<head>
<title>_interceptor.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_interceptor.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright 2019 gRPC authors.</span>
<span class="s0">#</span>
<span class="s0"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0"># you may not use this file except in compliance with the License.</span>
<span class="s0"># You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0"># Unless required by applicable law or agreed to in writing, software</span>
<span class="s0"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0"># See the License for the specific language governing permissions and</span>
<span class="s0"># limitations under the License.</span>
<span class="s2">&quot;&quot;&quot;Interceptors implementation of gRPC Asyncio Python.&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">abc </span><span class="s3">import </span><span class="s1">ABCMeta</span>
<span class="s3">from </span><span class="s1">abc </span><span class="s3">import </span><span class="s1">abstractmethod</span>
<span class="s3">import </span><span class="s1">asyncio</span>
<span class="s3">import </span><span class="s1">collections</span>
<span class="s3">import </span><span class="s1">functools</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">AsyncIterable</span><span class="s4">,</span>
    <span class="s1">Awaitable</span><span class="s4">,</span>
    <span class="s1">Callable</span><span class="s4">,</span>
    <span class="s1">Iterator</span><span class="s4">,</span>
    <span class="s1">List</span><span class="s4">,</span>
    <span class="s1">Optional</span><span class="s4">,</span>
    <span class="s1">Sequence</span><span class="s4">,</span>
    <span class="s1">Union</span><span class="s4">,</span>
<span class="s4">)</span>

<span class="s3">import </span><span class="s1">grpc</span>
<span class="s3">from </span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">_cython </span><span class="s3">import </span><span class="s1">cygrpc</span>

<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">_base_call</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_call </span><span class="s3">import </span><span class="s1">AioRpcError</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_call </span><span class="s3">import </span><span class="s1">StreamStreamCall</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_call </span><span class="s3">import </span><span class="s1">StreamUnaryCall</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_call </span><span class="s3">import </span><span class="s1">UnaryStreamCall</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_call </span><span class="s3">import </span><span class="s1">UnaryUnaryCall</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_call </span><span class="s3">import </span><span class="s1">_API_STYLE_ERROR</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_call </span><span class="s3">import </span><span class="s1">_RPC_ALREADY_FINISHED_DETAILS</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_call </span><span class="s3">import </span><span class="s1">_RPC_HALF_CLOSED_DETAILS</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_metadata </span><span class="s3">import </span><span class="s1">Metadata</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">DeserializingFunction</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">DoneCallbackType</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">EOFType</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">RequestIterableType</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">RequestType</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">ResponseIterableType</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">ResponseType</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_typing </span><span class="s3">import </span><span class="s1">SerializingFunction</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">_utils </span><span class="s3">import </span><span class="s1">_timeout_to_deadline</span>

<span class="s1">_LOCAL_CANCELLATION_DETAILS </span><span class="s4">= </span><span class="s5">&quot;Locally cancelled by application!&quot;</span>


<span class="s3">class </span><span class="s1">ServerInterceptor</span><span class="s4">(</span><span class="s1">metaclass</span><span class="s4">=</span><span class="s1">ABCMeta</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Affords intercepting incoming RPCs on the service-side. 
 
    This is an EXPERIMENTAL API. 
    &quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">async def </span><span class="s1">intercept_service</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">continuation</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[</span>
            <span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">HandlerCallDetails</span><span class="s4">], </span><span class="s1">Awaitable</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">RpcMethodHandler</span><span class="s4">]</span>
        <span class="s4">],</span>
        <span class="s1">handler_call_details</span><span class="s4">: </span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">HandlerCallDetails</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; grpc</span><span class="s4">.</span><span class="s1">RpcMethodHandler</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Intercepts incoming RPCs before handing them over to a handler. 
 
        State can be passed from an interceptor to downstream interceptors 
        via contextvars. The first interceptor is called from an empty 
        contextvars.Context, and the same Context is used for downstream 
        interceptors and for the final handler call. Note that there are no 
        guarantees that interceptors and handlers will be called from the 
        same thread. 
 
        Args: 
            continuation: A function that takes a HandlerCallDetails and 
                proceeds to invoke the next interceptor in the chain, if any, 
                or the RPC handler lookup logic, with the call details passed 
                as an argument, and returns an RpcMethodHandler instance if 
                the RPC is considered serviced, or None otherwise. 
            handler_call_details: A HandlerCallDetails describing the RPC. 
 
        Returns: 
            An RpcMethodHandler with which the RPC may be serviced if the 
            interceptor chooses to service this RPC, or None otherwise. 
        &quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">ClientCallDetails</span><span class="s4">(</span>
    <span class="s1">collections</span><span class="s4">.</span><span class="s1">namedtuple</span><span class="s4">(</span>
        <span class="s5">&quot;ClientCallDetails&quot;</span><span class="s4">,</span>
        <span class="s4">(</span><span class="s5">&quot;method&quot;</span><span class="s4">, </span><span class="s5">&quot;timeout&quot;</span><span class="s4">, </span><span class="s5">&quot;metadata&quot;</span><span class="s4">, </span><span class="s5">&quot;credentials&quot;</span><span class="s4">, </span><span class="s5">&quot;wait_for_ready&quot;</span><span class="s4">),</span>
    <span class="s4">),</span>
    <span class="s1">grpc</span><span class="s4">.</span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
<span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Describes an RPC to be invoked. 
 
    This is an EXPERIMENTAL API. 
 
    Args: 
        method: The method name of the RPC. 
        timeout: An optional duration of time in seconds to allow for the RPC. 
        metadata: Optional metadata to be transmitted to the service-side of 
          the RPC. 
        credentials: An optional CallCredentials for the RPC. 
        wait_for_ready: An optional flag to enable :term:`wait_for_ready` mechanism. 
    &quot;&quot;&quot;</span>

    <span class="s1">method</span><span class="s4">: </span><span class="s1">str</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]</span>
    <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">]</span>
    <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">]</span>
    <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">ClientInterceptor</span><span class="s4">(</span><span class="s1">metaclass</span><span class="s4">=</span><span class="s1">ABCMeta</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Base class used for all Aio Client Interceptor classes&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">UnaryUnaryClientInterceptor</span><span class="s4">(</span><span class="s1">ClientInterceptor</span><span class="s4">, </span><span class="s1">metaclass</span><span class="s4">=</span><span class="s1">ABCMeta</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Affords intercepting unary-unary invocations.&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">async def </span><span class="s1">intercept_unary_unary</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">continuation</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[</span>
            <span class="s4">[</span><span class="s1">ClientCallDetails</span><span class="s4">, </span><span class="s1">RequestType</span><span class="s4">], </span><span class="s1">UnaryUnaryCall</span>
        <span class="s4">],</span>
        <span class="s1">client_call_details</span><span class="s4">: </span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
        <span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">UnaryUnaryCall</span><span class="s4">, </span><span class="s1">ResponseType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Intercepts a unary-unary invocation asynchronously. 
 
        Args: 
          continuation: A coroutine that proceeds with the invocation by 
            executing the next interceptor in the chain or invoking the 
            actual RPC on the underlying Channel. It is the interceptor's 
            responsibility to call it if it decides to move the RPC forward. 
            The interceptor can use 
            `call = await continuation(client_call_details, request)` 
            to continue with the RPC. `continuation` returns the call to the 
            RPC. 
          client_call_details: A ClientCallDetails object describing the 
            outgoing RPC. 
          request: The request value for the RPC. 
 
        Returns: 
          An object with the RPC response. 
 
        Raises: 
          AioRpcError: Indicating that the RPC terminated with non-OK status. 
          asyncio.CancelledError: Indicating that the RPC was canceled. 
        &quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">UnaryStreamClientInterceptor</span><span class="s4">(</span><span class="s1">ClientInterceptor</span><span class="s4">, </span><span class="s1">metaclass</span><span class="s4">=</span><span class="s1">ABCMeta</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Affords intercepting unary-stream invocations.&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">async def </span><span class="s1">intercept_unary_stream</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">continuation</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[</span>
            <span class="s4">[</span><span class="s1">ClientCallDetails</span><span class="s4">, </span><span class="s1">RequestType</span><span class="s4">], </span><span class="s1">UnaryStreamCall</span>
        <span class="s4">],</span>
        <span class="s1">client_call_details</span><span class="s4">: </span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
        <span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">ResponseIterableType</span><span class="s4">, </span><span class="s1">UnaryStreamCall</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Intercepts a unary-stream invocation asynchronously. 
 
        The function could return the call object or an asynchronous 
        iterator, in case of being an asyncrhonous iterator this will 
        become the source of the reads done by the caller. 
 
        Args: 
          continuation: A coroutine that proceeds with the invocation by 
            executing the next interceptor in the chain or invoking the 
            actual RPC on the underlying Channel. It is the interceptor's 
            responsibility to call it if it decides to move the RPC forward. 
            The interceptor can use 
            `call = await continuation(client_call_details, request)` 
            to continue with the RPC. `continuation` returns the call to the 
            RPC. 
          client_call_details: A ClientCallDetails object describing the 
            outgoing RPC. 
          request: The request value for the RPC. 
 
        Returns: 
          The RPC Call or an asynchronous iterator. 
 
        Raises: 
          AioRpcError: Indicating that the RPC terminated with non-OK status. 
          asyncio.CancelledError: Indicating that the RPC was canceled. 
        &quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">StreamUnaryClientInterceptor</span><span class="s4">(</span><span class="s1">ClientInterceptor</span><span class="s4">, </span><span class="s1">metaclass</span><span class="s4">=</span><span class="s1">ABCMeta</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Affords intercepting stream-unary invocations.&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">async def </span><span class="s1">intercept_stream_unary</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">continuation</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[</span>
            <span class="s4">[</span><span class="s1">ClientCallDetails</span><span class="s4">, </span><span class="s1">RequestType</span><span class="s4">], </span><span class="s1">StreamUnaryCall</span>
        <span class="s4">],</span>
        <span class="s1">client_call_details</span><span class="s4">: </span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
        <span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">RequestIterableType</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; StreamUnaryCall</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Intercepts a stream-unary invocation asynchronously. 
 
        Within the interceptor the usage of the call methods like `write` or 
        even awaiting the call should be done carefully, since the caller 
        could be expecting an untouched call, for example for start writing 
        messages to it. 
 
        Args: 
          continuation: A coroutine that proceeds with the invocation by 
            executing the next interceptor in the chain or invoking the 
            actual RPC on the underlying Channel. It is the interceptor's 
            responsibility to call it if it decides to move the RPC forward. 
            The interceptor can use 
            `call = await continuation(client_call_details, request_iterator)` 
            to continue with the RPC. `continuation` returns the call to the 
            RPC. 
          client_call_details: A ClientCallDetails object describing the 
            outgoing RPC. 
          request_iterator: The request iterator that will produce requests 
            for the RPC. 
 
        Returns: 
          The RPC Call. 
 
        Raises: 
          AioRpcError: Indicating that the RPC terminated with non-OK status. 
          asyncio.CancelledError: Indicating that the RPC was canceled. 
        &quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">StreamStreamClientInterceptor</span><span class="s4">(</span><span class="s1">ClientInterceptor</span><span class="s4">, </span><span class="s1">metaclass</span><span class="s4">=</span><span class="s1">ABCMeta</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Affords intercepting stream-stream invocations.&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">async def </span><span class="s1">intercept_stream_stream</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">continuation</span><span class="s4">: </span><span class="s1">Callable</span><span class="s4">[</span>
            <span class="s4">[</span><span class="s1">ClientCallDetails</span><span class="s4">, </span><span class="s1">RequestType</span><span class="s4">], </span><span class="s1">StreamStreamCall</span>
        <span class="s4">],</span>
        <span class="s1">client_call_details</span><span class="s4">: </span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
        <span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">RequestIterableType</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">ResponseIterableType</span><span class="s4">, </span><span class="s1">StreamStreamCall</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Intercepts a stream-stream invocation asynchronously. 
 
        Within the interceptor the usage of the call methods like `write` or 
        even awaiting the call should be done carefully, since the caller 
        could be expecting an untouched call, for example for start writing 
        messages to it. 
 
        The function could return the call object or an asynchronous 
        iterator, in case of being an asyncrhonous iterator this will 
        become the source of the reads done by the caller. 
 
        Args: 
          continuation: A coroutine that proceeds with the invocation by 
            executing the next interceptor in the chain or invoking the 
            actual RPC on the underlying Channel. It is the interceptor's 
            responsibility to call it if it decides to move the RPC forward. 
            The interceptor can use 
            `call = await continuation(client_call_details, request_iterator)` 
            to continue with the RPC. `continuation` returns the call to the 
            RPC. 
          client_call_details: A ClientCallDetails object describing the 
            outgoing RPC. 
          request_iterator: The request iterator that will produce requests 
            for the RPC. 
 
        Returns: 
          The RPC Call or an asynchronous iterator. 
 
        Raises: 
          AioRpcError: Indicating that the RPC terminated with non-OK status. 
          asyncio.CancelledError: Indicating that the RPC was canceled. 
        &quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">InterceptedCall</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Base implementation for all intercepted call arities. 
 
    Interceptors might have some work to do before the RPC invocation with 
    the capacity of changing the invocation parameters, and some work to do 
    after the RPC invocation with the capacity for accessing to the wrapped 
    `UnaryUnaryCall`. 
 
    It handles also early and later cancellations, when the RPC has not even 
    started and the execution is still held by the interceptors or when the 
    RPC has finished but again the execution is still held by the interceptors. 
 
    Once the RPC is finally executed, all methods are finally done against the 
    intercepted call, being at the same time the same call returned to the 
    interceptors. 
 
    As a base class for all of the interceptors implements the logic around 
    final status, metadata and cancellation. 
    &quot;&quot;&quot;</span>

    <span class="s1">_interceptors_task</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">Task</span>
    <span class="s1">_pending_add_done_callbacks</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">DoneCallbackType</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">interceptors_task</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">Task</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task </span><span class="s4">= </span><span class="s1">interceptors_task</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_pending_add_done_callbacks </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">add_done_callback</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_fire_or_add_pending_done_callbacks</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__del__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">cancel</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_fire_or_add_pending_done_callbacks</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">interceptors_task</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">Task</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pending_add_done_callbacks</span><span class="s4">:</span>
            <span class="s3">return</span>

        <span class="s1">call_completed </span><span class="s4">= </span><span class="s3">False</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s1">interceptors_task</span><span class="s4">.</span><span class="s1">result</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">call</span><span class="s4">.</span><span class="s1">done</span><span class="s4">():</span>
                <span class="s1">call_completed </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">AioRpcError</span><span class="s4">, </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">):</span>
            <span class="s1">call_completed </span><span class="s4">= </span><span class="s3">True</span>

        <span class="s3">if </span><span class="s1">call_completed</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">callback </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pending_add_done_callbacks</span><span class="s4">:</span>
                <span class="s1">callback</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">callback </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_pending_add_done_callbacks</span><span class="s4">:</span>
                <span class="s1">callback </span><span class="s4">= </span><span class="s1">functools</span><span class="s4">.</span><span class="s1">partial</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_wrap_add_done_callback</span><span class="s4">, </span><span class="s1">callback</span>
                <span class="s4">)</span>
                <span class="s1">call</span><span class="s4">.</span><span class="s1">add_done_callback</span><span class="s4">(</span><span class="s1">callback</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_pending_add_done_callbacks </span><span class="s4">= []</span>

    <span class="s3">def </span><span class="s1">_wrap_add_done_callback</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">callback</span><span class="s4">: </span><span class="s1">DoneCallbackType</span><span class="s4">, </span><span class="s1">unused_call</span><span class="s4">: </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">Call</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">callback</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">cancel</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">done</span><span class="s4">():</span>
            <span class="s0"># There is no yet the intercepted call available,</span>
            <span class="s0"># Trying to cancel it by using the generic Asyncio</span>
            <span class="s0"># cancellation method.</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">cancel</span><span class="s4">()</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">result</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">AioRpcError</span><span class="s4">:</span>
            <span class="s3">return False</span>
        <span class="s3">except </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">:</span>
            <span class="s3">return False</span>

        <span class="s3">return </span><span class="s1">call</span><span class="s4">.</span><span class="s1">cancel</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">cancelled</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">done</span><span class="s4">():</span>
            <span class="s3">return False</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">result</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">AioRpcError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">err</span><span class="s4">.</span><span class="s1">code</span><span class="s4">() == </span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">StatusCode</span><span class="s4">.</span><span class="s1">CANCELLED</span>
        <span class="s3">except </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">:</span>
            <span class="s3">return True</span>

        <span class="s3">return </span><span class="s1">call</span><span class="s4">.</span><span class="s1">cancelled</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">done</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">done</span><span class="s4">():</span>
            <span class="s3">return False</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">result</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">AioRpcError</span><span class="s4">, </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">):</span>
            <span class="s3">return True</span>

        <span class="s3">return </span><span class="s1">call</span><span class="s4">.</span><span class="s1">done</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">add_done_callback</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">callback</span><span class="s4">: </span><span class="s1">DoneCallbackType</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">done</span><span class="s4">():</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_pending_add_done_callbacks</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">callback</span><span class="s4">)</span>
            <span class="s3">return</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">result</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">AioRpcError</span><span class="s4">, </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">):</span>
            <span class="s1">callback</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
            <span class="s3">return</span>

        <span class="s3">if </span><span class="s1">call</span><span class="s4">.</span><span class="s1">done</span><span class="s4">():</span>
            <span class="s1">callback</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">callback </span><span class="s4">= </span><span class="s1">functools</span><span class="s4">.</span><span class="s1">partial</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_wrap_add_done_callback</span><span class="s4">, </span><span class="s1">callback</span><span class="s4">)</span>
            <span class="s1">call</span><span class="s4">.</span><span class="s1">add_done_callback</span><span class="s4">(</span><span class="s1">callback</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">time_remaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">initial_metadata</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">]:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">except </span><span class="s1">AioRpcError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">err</span><span class="s4">.</span><span class="s1">initial_metadata</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s3">return await </span><span class="s1">call</span><span class="s4">.</span><span class="s1">initial_metadata</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">trailing_metadata</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">]:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">except </span><span class="s1">AioRpcError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">err</span><span class="s4">.</span><span class="s1">trailing_metadata</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s3">return await </span><span class="s1">call</span><span class="s4">.</span><span class="s1">trailing_metadata</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">code</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; grpc</span><span class="s4">.</span><span class="s1">StatusCode</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">except </span><span class="s1">AioRpcError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">err</span><span class="s4">.</span><span class="s1">code</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">StatusCode</span><span class="s4">.</span><span class="s1">CANCELLED</span>

        <span class="s3">return await </span><span class="s1">call</span><span class="s4">.</span><span class="s1">code</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">details</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">except </span><span class="s1">AioRpcError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">err</span><span class="s4">.</span><span class="s1">details</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">_LOCAL_CANCELLATION_DETAILS</span>

        <span class="s3">return await </span><span class="s1">call</span><span class="s4">.</span><span class="s1">details</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">debug_error_string</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">except </span><span class="s1">AioRpcError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">err</span><span class="s4">.</span><span class="s1">debug_error_string</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s5">&quot;&quot;</span>

        <span class="s3">return await </span><span class="s1">call</span><span class="s4">.</span><span class="s1">debug_error_string</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">wait_for_connection</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">return await </span><span class="s1">call</span><span class="s4">.</span><span class="s1">wait_for_connection</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">_InterceptedUnaryResponseMixin</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">__await__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">call </span><span class="s4">= </span><span class="s3">yield from </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span><span class="s4">.</span><span class="s1">__await__</span><span class="s4">()</span>
        <span class="s1">response </span><span class="s4">= </span><span class="s3">yield from </span><span class="s1">call</span><span class="s4">.</span><span class="s1">__await__</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">response</span>


<span class="s3">class </span><span class="s1">_InterceptedStreamResponseMixin</span><span class="s4">:</span>
    <span class="s1">_response_aiter</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">AsyncIterable</span><span class="s4">[</span><span class="s1">ResponseType</span><span class="s4">]]</span>

    <span class="s3">def </span><span class="s1">_init_stream_response_mixin</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s0"># Is initalized later, otherwise if the iterator is not finally</span>
        <span class="s0"># consumed a logging warning is emmited by Asyncio.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_response_aiter </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s3">async def </span><span class="s1">_wait_for_interceptor_task_response_iterator</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; ResponseType</span><span class="s4">:</span>
        <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">async for </span><span class="s1">response </span><span class="s3">in </span><span class="s1">call</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">response</span>

    <span class="s3">def </span><span class="s1">__aiter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; AsyncIterable</span><span class="s4">[</span><span class="s1">ResponseType</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_response_aiter </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_response_aiter </span><span class="s4">= (</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_wait_for_interceptor_task_response_iterator</span><span class="s4">()</span>
            <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_response_aiter</span>

    <span class="s3">async def </span><span class="s1">read</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">EOFType</span><span class="s4">, </span><span class="s1">ResponseType</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_response_aiter </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_response_aiter </span><span class="s4">= (</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_wait_for_interceptor_task_response_iterator</span><span class="s4">()</span>
            <span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_response_aiter</span><span class="s4">.</span><span class="s1">asend</span><span class="s4">(</span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">StopAsyncIteration</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">EOF</span>


<span class="s3">class </span><span class="s1">_InterceptedStreamRequestMixin</span><span class="s4">:</span>
    <span class="s1">_write_to_iterator_async_gen</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">AsyncIterable</span><span class="s4">[</span><span class="s1">RequestType</span><span class="s4">]]</span>
    <span class="s1">_write_to_iterator_queue</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">Queue</span><span class="s4">]</span>
    <span class="s1">_status_code_task</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">Task</span><span class="s4">]</span>

    <span class="s1">_FINISH_ITERATOR_SENTINEL </span><span class="s4">= </span><span class="s1">object</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_init_stream_request_mixin</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">RequestIterableType</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; RequestIterableType</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">request_iterator </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s0"># We provide our own request iterator which is a proxy</span>
            <span class="s0"># of the futures writes that will be done by the caller.</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_queue </span><span class="s4">= </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">Queue</span><span class="s4">(</span><span class="s1">maxsize</span><span class="s4">=</span><span class="s6">1</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_async_gen </span><span class="s4">= (</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_proxy_writes_as_request_iterator</span><span class="s4">()</span>
            <span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_status_code_task </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">request_iterator </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_async_gen</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_queue </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s3">return </span><span class="s1">request_iterator</span>

    <span class="s3">async def </span><span class="s1">_proxy_writes_as_request_iterator</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>

        <span class="s3">while True</span><span class="s4">:</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_queue</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s4">(</span>
                <span class="s1">value</span>
                <span class="s3">is </span><span class="s1">_InterceptedStreamRequestMixin</span><span class="s4">.</span><span class="s1">_FINISH_ITERATOR_SENTINEL</span>
            <span class="s4">):</span>
                <span class="s3">break</span>
            <span class="s3">yield </span><span class="s1">value</span>

    <span class="s3">async def </span><span class="s1">_write_to_iterator_queue_interruptible</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">, </span><span class="s1">call</span><span class="s4">: </span><span class="s1">InterceptedCall</span>
    <span class="s4">):</span>
        <span class="s0"># Write the specified 'request' to the request iterator queue using the</span>
        <span class="s0"># specified 'call' to allow for interruption of the write in the case</span>
        <span class="s0"># of abrupt termination of the call.</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_status_code_task </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_status_code_task </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_loop</span><span class="s4">.</span><span class="s1">create_task</span><span class="s4">(</span><span class="s1">call</span><span class="s4">.</span><span class="s1">code</span><span class="s4">())</span>

        <span class="s3">await </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">wait</span><span class="s4">(</span>
            <span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop</span><span class="s4">.</span><span class="s1">create_task</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_queue</span><span class="s4">.</span><span class="s1">put</span><span class="s4">(</span><span class="s1">request</span><span class="s4">)</span>
                <span class="s4">),</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_status_code_task</span><span class="s4">,</span>
            <span class="s4">),</span>
            <span class="s1">return_when</span><span class="s4">=</span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">FIRST_COMPLETED</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s3">async def </span><span class="s1">write</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s0"># If no queue was created it means that requests</span>
        <span class="s0"># should be expected through an iterators provided</span>
        <span class="s0"># by the caller.</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_queue </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">UsageError</span><span class="s4">(</span><span class="s1">_API_STYLE_ERROR</span><span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">, </span><span class="s1">AioRpcError</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">InvalidStateError</span><span class="s4">(</span><span class="s1">_RPC_ALREADY_FINISHED_DETAILS</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">call</span><span class="s4">.</span><span class="s1">done</span><span class="s4">():</span>
            <span class="s3">raise </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">InvalidStateError</span><span class="s4">(</span><span class="s1">_RPC_ALREADY_FINISHED_DETAILS</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">call</span><span class="s4">.</span><span class="s1">_done_writing_flag</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">InvalidStateError</span><span class="s4">(</span><span class="s1">_RPC_HALF_CLOSED_DETAILS</span><span class="s4">)</span>

        <span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_queue_interruptible</span><span class="s4">(</span><span class="s1">request</span><span class="s4">, </span><span class="s1">call</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">call</span><span class="s4">.</span><span class="s1">done</span><span class="s4">():</span>
            <span class="s3">raise </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">InvalidStateError</span><span class="s4">(</span><span class="s1">_RPC_ALREADY_FINISHED_DETAILS</span><span class="s4">)</span>

    <span class="s3">async def </span><span class="s1">done_writing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Signal peer that client is done writing. 
 
        This method is idempotent. 
        &quot;&quot;&quot;</span>
        <span class="s0"># If no queue was created it means that requests</span>
        <span class="s0"># should be expected through an iterators provided</span>
        <span class="s0"># by the caller.</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_queue </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">UsageError</span><span class="s4">(</span><span class="s1">_API_STYLE_ERROR</span><span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">call </span><span class="s4">= </span><span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_interceptors_task</span>
        <span class="s3">except </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">CancelledError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">InvalidStateError</span><span class="s4">(</span><span class="s1">_RPC_ALREADY_FINISHED_DETAILS</span><span class="s4">)</span>

        <span class="s3">await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_write_to_iterator_queue_interruptible</span><span class="s4">(</span>
            <span class="s1">_InterceptedStreamRequestMixin</span><span class="s4">.</span><span class="s1">_FINISH_ITERATOR_SENTINEL</span><span class="s4">, </span><span class="s1">call</span>
        <span class="s4">)</span>


<span class="s3">class </span><span class="s1">InterceptedUnaryUnaryCall</span><span class="s4">(</span>
    <span class="s1">_InterceptedUnaryResponseMixin</span><span class="s4">, </span><span class="s1">InterceptedCall</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryUnaryCall</span>
<span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Used for running a `UnaryUnaryCall` wrapped by interceptors. 
 
    For the `__await__` method is it is proxied to the intercepted call only when 
    the interceptor task is finished. 
    &quot;&quot;&quot;</span>

    <span class="s1">_loop</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">AbstractEventLoop</span>
    <span class="s1">_channel</span><span class="s4">: </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">AioChannel</span>

    <span class="s0"># pylint: disable=too-many-arguments</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">UnaryUnaryClientInterceptor</span><span class="s4">],</span>
        <span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">,</span>
        <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
        <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Metadata</span><span class="s4">,</span>
        <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">],</span>
        <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
        <span class="s1">channel</span><span class="s4">: </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">AioChannel</span><span class="s4">,</span>
        <span class="s1">method</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s1">request_serializer</span><span class="s4">: </span><span class="s1">SerializingFunction</span><span class="s4">,</span>
        <span class="s1">response_deserializer</span><span class="s4">: </span><span class="s1">DeserializingFunction</span><span class="s4">,</span>
        <span class="s1">loop</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">AbstractEventLoop</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop </span><span class="s4">= </span><span class="s1">loop</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_channel </span><span class="s4">= </span><span class="s1">channel</span>
        <span class="s1">interceptors_task </span><span class="s4">= </span><span class="s1">loop</span><span class="s4">.</span><span class="s1">create_task</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_invoke</span><span class="s4">(</span>
                <span class="s1">interceptors</span><span class="s4">,</span>
                <span class="s1">method</span><span class="s4">,</span>
                <span class="s1">timeout</span><span class="s4">,</span>
                <span class="s1">metadata</span><span class="s4">,</span>
                <span class="s1">credentials</span><span class="s4">,</span>
                <span class="s1">wait_for_ready</span><span class="s4">,</span>
                <span class="s1">request</span><span class="s4">,</span>
                <span class="s1">request_serializer</span><span class="s4">,</span>
                <span class="s1">response_deserializer</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">interceptors_task</span><span class="s4">)</span>

    <span class="s0"># pylint: disable=too-many-arguments</span>
    <span class="s3">async def </span><span class="s1">_invoke</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">UnaryUnaryClientInterceptor</span><span class="s4">],</span>
        <span class="s1">method</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
        <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">],</span>
        <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">],</span>
        <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
        <span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">,</span>
        <span class="s1">request_serializer</span><span class="s4">: </span><span class="s1">SerializingFunction</span><span class="s4">,</span>
        <span class="s1">response_deserializer</span><span class="s4">: </span><span class="s1">DeserializingFunction</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; UnaryUnaryCall</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Run the RPC call wrapped in interceptors&quot;&quot;&quot;</span>

        <span class="s3">async def </span><span class="s1">_run_interceptor</span><span class="s4">(</span>
            <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">UnaryUnaryClientInterceptor</span><span class="s4">],</span>
            <span class="s1">client_call_details</span><span class="s4">: </span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
            <span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">,</span>
        <span class="s4">) </span><span class="s1">-&gt; _base_call</span><span class="s4">.</span><span class="s1">UnaryUnaryCall</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">interceptors</span><span class="s4">:</span>
                <span class="s1">continuation </span><span class="s4">= </span><span class="s1">functools</span><span class="s4">.</span><span class="s1">partial</span><span class="s4">(</span>
                    <span class="s1">_run_interceptor</span><span class="s4">, </span><span class="s1">interceptors</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]</span>
                <span class="s4">)</span>
                <span class="s1">call_or_response </span><span class="s4">= </span><span class="s3">await </span><span class="s1">interceptors</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">intercept_unary_unary</span><span class="s4">(</span>
                    <span class="s1">continuation</span><span class="s4">, </span><span class="s1">client_call_details</span><span class="s4">, </span><span class="s1">request</span>
                <span class="s4">)</span>

                <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">call_or_response</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryUnaryCall</span><span class="s4">):</span>
                    <span class="s3">return </span><span class="s1">call_or_response</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s3">return </span><span class="s1">UnaryUnaryCallResponse</span><span class="s4">(</span><span class="s1">call_or_response</span><span class="s4">)</span>

            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">UnaryUnaryCall</span><span class="s4">(</span>
                    <span class="s1">request</span><span class="s4">,</span>
                    <span class="s1">_timeout_to_deadline</span><span class="s4">(</span><span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">timeout</span><span class="s4">),</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">credentials</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">wait_for_ready</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_channel</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">method</span><span class="s4">,</span>
                    <span class="s1">request_serializer</span><span class="s4">,</span>
                    <span class="s1">response_deserializer</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop</span><span class="s4">,</span>
                <span class="s4">)</span>

        <span class="s1">client_call_details </span><span class="s4">= </span><span class="s1">ClientCallDetails</span><span class="s4">(</span>
            <span class="s1">method</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">credentials</span><span class="s4">, </span><span class="s1">wait_for_ready</span>
        <span class="s4">)</span>
        <span class="s3">return await </span><span class="s1">_run_interceptor</span><span class="s4">(</span>
            <span class="s1">list</span><span class="s4">(</span><span class="s1">interceptors</span><span class="s4">), </span><span class="s1">client_call_details</span><span class="s4">, </span><span class="s1">request</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">time_remaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">InterceptedUnaryStreamCall</span><span class="s4">(</span>
    <span class="s1">_InterceptedStreamResponseMixin</span><span class="s4">, </span><span class="s1">InterceptedCall</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryStreamCall</span>
<span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Used for running a `UnaryStreamCall` wrapped by interceptors.&quot;&quot;&quot;</span>

    <span class="s1">_loop</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">AbstractEventLoop</span>
    <span class="s1">_channel</span><span class="s4">: </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">AioChannel</span>
    <span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryStreamCall</span><span class="s4">]</span>

    <span class="s0"># pylint: disable=too-many-arguments</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">UnaryStreamClientInterceptor</span><span class="s4">],</span>
        <span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">,</span>
        <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
        <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Metadata</span><span class="s4">,</span>
        <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">],</span>
        <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
        <span class="s1">channel</span><span class="s4">: </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">AioChannel</span><span class="s4">,</span>
        <span class="s1">method</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s1">request_serializer</span><span class="s4">: </span><span class="s1">SerializingFunction</span><span class="s4">,</span>
        <span class="s1">response_deserializer</span><span class="s4">: </span><span class="s1">DeserializingFunction</span><span class="s4">,</span>
        <span class="s1">loop</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">AbstractEventLoop</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop </span><span class="s4">= </span><span class="s1">loop</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_channel </span><span class="s4">= </span><span class="s1">channel</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_init_stream_response_mixin</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">interceptors_task </span><span class="s4">= </span><span class="s1">loop</span><span class="s4">.</span><span class="s1">create_task</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_invoke</span><span class="s4">(</span>
                <span class="s1">interceptors</span><span class="s4">,</span>
                <span class="s1">method</span><span class="s4">,</span>
                <span class="s1">timeout</span><span class="s4">,</span>
                <span class="s1">metadata</span><span class="s4">,</span>
                <span class="s1">credentials</span><span class="s4">,</span>
                <span class="s1">wait_for_ready</span><span class="s4">,</span>
                <span class="s1">request</span><span class="s4">,</span>
                <span class="s1">request_serializer</span><span class="s4">,</span>
                <span class="s1">response_deserializer</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">interceptors_task</span><span class="s4">)</span>

    <span class="s0"># pylint: disable=too-many-arguments</span>
    <span class="s3">async def </span><span class="s1">_invoke</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">UnaryStreamClientInterceptor</span><span class="s4">],</span>
        <span class="s1">method</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
        <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">],</span>
        <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">],</span>
        <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
        <span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">,</span>
        <span class="s1">request_serializer</span><span class="s4">: </span><span class="s1">SerializingFunction</span><span class="s4">,</span>
        <span class="s1">response_deserializer</span><span class="s4">: </span><span class="s1">DeserializingFunction</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; UnaryStreamCall</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Run the RPC call wrapped in interceptors&quot;&quot;&quot;</span>

        <span class="s3">async def </span><span class="s1">_run_interceptor</span><span class="s4">(</span>
            <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">UnaryStreamClientInterceptor</span><span class="s4">],</span>
            <span class="s1">client_call_details</span><span class="s4">: </span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
            <span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">,</span>
        <span class="s4">) </span><span class="s1">-&gt; _base_call</span><span class="s4">.</span><span class="s1">UnaryStreamCall</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">interceptors</span><span class="s4">:</span>
                <span class="s1">continuation </span><span class="s4">= </span><span class="s1">functools</span><span class="s4">.</span><span class="s1">partial</span><span class="s4">(</span>
                    <span class="s1">_run_interceptor</span><span class="s4">, </span><span class="s1">interceptors</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]</span>
                <span class="s4">)</span>

                <span class="s1">call_or_response_iterator </span><span class="s4">= </span><span class="s3">await </span><span class="s1">interceptors</span><span class="s4">[</span>
                    <span class="s6">0</span>
                <span class="s4">].</span><span class="s1">intercept_unary_stream</span><span class="s4">(</span>
                    <span class="s1">continuation</span><span class="s4">, </span><span class="s1">client_call_details</span><span class="s4">, </span><span class="s1">request</span>
                <span class="s4">)</span>

                <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span>
                    <span class="s1">call_or_response_iterator</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryStreamCall</span>
                <span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= (</span>
                        <span class="s1">call_or_response_iterator</span>
                    <span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= (</span>
                        <span class="s1">UnaryStreamCallResponseIterator</span><span class="s4">(</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors</span><span class="s4">,</span>
                            <span class="s1">call_or_response_iterator</span><span class="s4">,</span>
                        <span class="s4">)</span>
                    <span class="s4">)</span>
                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= </span><span class="s1">UnaryStreamCall</span><span class="s4">(</span>
                    <span class="s1">request</span><span class="s4">,</span>
                    <span class="s1">_timeout_to_deadline</span><span class="s4">(</span><span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">timeout</span><span class="s4">),</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">credentials</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">wait_for_ready</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_channel</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">method</span><span class="s4">,</span>
                    <span class="s1">request_serializer</span><span class="s4">,</span>
                    <span class="s1">response_deserializer</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop</span><span class="s4">,</span>
                <span class="s4">)</span>

                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors</span>

        <span class="s1">client_call_details </span><span class="s4">= </span><span class="s1">ClientCallDetails</span><span class="s4">(</span>
            <span class="s1">method</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">credentials</span><span class="s4">, </span><span class="s1">wait_for_ready</span>
        <span class="s4">)</span>
        <span class="s3">return await </span><span class="s1">_run_interceptor</span><span class="s4">(</span>
            <span class="s1">list</span><span class="s4">(</span><span class="s1">interceptors</span><span class="s4">), </span><span class="s1">client_call_details</span><span class="s4">, </span><span class="s1">request</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">time_remaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">InterceptedStreamUnaryCall</span><span class="s4">(</span>
    <span class="s1">_InterceptedUnaryResponseMixin</span><span class="s4">,</span>
    <span class="s1">_InterceptedStreamRequestMixin</span><span class="s4">,</span>
    <span class="s1">InterceptedCall</span><span class="s4">,</span>
    <span class="s1">_base_call</span><span class="s4">.</span><span class="s1">StreamUnaryCall</span><span class="s4">,</span>
<span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Used for running a `StreamUnaryCall` wrapped by interceptors. 
 
    For the `__await__` method is it is proxied to the intercepted call only when 
    the interceptor task is finished. 
    &quot;&quot;&quot;</span>

    <span class="s1">_loop</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">AbstractEventLoop</span>
    <span class="s1">_channel</span><span class="s4">: </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">AioChannel</span>

    <span class="s0"># pylint: disable=too-many-arguments</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">StreamUnaryClientInterceptor</span><span class="s4">],</span>
        <span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">RequestIterableType</span><span class="s4">],</span>
        <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
        <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Metadata</span><span class="s4">,</span>
        <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">],</span>
        <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
        <span class="s1">channel</span><span class="s4">: </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">AioChannel</span><span class="s4">,</span>
        <span class="s1">method</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s1">request_serializer</span><span class="s4">: </span><span class="s1">SerializingFunction</span><span class="s4">,</span>
        <span class="s1">response_deserializer</span><span class="s4">: </span><span class="s1">DeserializingFunction</span><span class="s4">,</span>
        <span class="s1">loop</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">AbstractEventLoop</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop </span><span class="s4">= </span><span class="s1">loop</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_channel </span><span class="s4">= </span><span class="s1">channel</span>
        <span class="s1">request_iterator </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_init_stream_request_mixin</span><span class="s4">(</span><span class="s1">request_iterator</span><span class="s4">)</span>
        <span class="s1">interceptors_task </span><span class="s4">= </span><span class="s1">loop</span><span class="s4">.</span><span class="s1">create_task</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_invoke</span><span class="s4">(</span>
                <span class="s1">interceptors</span><span class="s4">,</span>
                <span class="s1">method</span><span class="s4">,</span>
                <span class="s1">timeout</span><span class="s4">,</span>
                <span class="s1">metadata</span><span class="s4">,</span>
                <span class="s1">credentials</span><span class="s4">,</span>
                <span class="s1">wait_for_ready</span><span class="s4">,</span>
                <span class="s1">request_iterator</span><span class="s4">,</span>
                <span class="s1">request_serializer</span><span class="s4">,</span>
                <span class="s1">response_deserializer</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">interceptors_task</span><span class="s4">)</span>

    <span class="s0"># pylint: disable=too-many-arguments</span>
    <span class="s3">async def </span><span class="s1">_invoke</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">StreamUnaryClientInterceptor</span><span class="s4">],</span>
        <span class="s1">method</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
        <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">],</span>
        <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">],</span>
        <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
        <span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">RequestIterableType</span><span class="s4">,</span>
        <span class="s1">request_serializer</span><span class="s4">: </span><span class="s1">SerializingFunction</span><span class="s4">,</span>
        <span class="s1">response_deserializer</span><span class="s4">: </span><span class="s1">DeserializingFunction</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; StreamUnaryCall</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Run the RPC call wrapped in interceptors&quot;&quot;&quot;</span>

        <span class="s3">async def </span><span class="s1">_run_interceptor</span><span class="s4">(</span>
            <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Iterator</span><span class="s4">[</span><span class="s1">StreamUnaryClientInterceptor</span><span class="s4">],</span>
            <span class="s1">client_call_details</span><span class="s4">: </span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
            <span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">RequestIterableType</span><span class="s4">,</span>
        <span class="s4">) </span><span class="s1">-&gt; _base_call</span><span class="s4">.</span><span class="s1">StreamUnaryCall</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">interceptors</span><span class="s4">:</span>
                <span class="s1">continuation </span><span class="s4">= </span><span class="s1">functools</span><span class="s4">.</span><span class="s1">partial</span><span class="s4">(</span>
                    <span class="s1">_run_interceptor</span><span class="s4">, </span><span class="s1">interceptors</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]</span>
                <span class="s4">)</span>

                <span class="s3">return await </span><span class="s1">interceptors</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">intercept_stream_unary</span><span class="s4">(</span>
                    <span class="s1">continuation</span><span class="s4">, </span><span class="s1">client_call_details</span><span class="s4">, </span><span class="s1">request_iterator</span>
                <span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">StreamUnaryCall</span><span class="s4">(</span>
                    <span class="s1">request_iterator</span><span class="s4">,</span>
                    <span class="s1">_timeout_to_deadline</span><span class="s4">(</span><span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">timeout</span><span class="s4">),</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">credentials</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">wait_for_ready</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_channel</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">method</span><span class="s4">,</span>
                    <span class="s1">request_serializer</span><span class="s4">,</span>
                    <span class="s1">response_deserializer</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop</span><span class="s4">,</span>
                <span class="s4">)</span>

        <span class="s1">client_call_details </span><span class="s4">= </span><span class="s1">ClientCallDetails</span><span class="s4">(</span>
            <span class="s1">method</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">credentials</span><span class="s4">, </span><span class="s1">wait_for_ready</span>
        <span class="s4">)</span>
        <span class="s3">return await </span><span class="s1">_run_interceptor</span><span class="s4">(</span>
            <span class="s1">list</span><span class="s4">(</span><span class="s1">interceptors</span><span class="s4">), </span><span class="s1">client_call_details</span><span class="s4">, </span><span class="s1">request_iterator</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">time_remaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">InterceptedStreamStreamCall</span><span class="s4">(</span>
    <span class="s1">_InterceptedStreamResponseMixin</span><span class="s4">,</span>
    <span class="s1">_InterceptedStreamRequestMixin</span><span class="s4">,</span>
    <span class="s1">InterceptedCall</span><span class="s4">,</span>
    <span class="s1">_base_call</span><span class="s4">.</span><span class="s1">StreamStreamCall</span><span class="s4">,</span>
<span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Used for running a `StreamStreamCall` wrapped by interceptors.&quot;&quot;&quot;</span>

    <span class="s1">_loop</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">AbstractEventLoop</span>
    <span class="s1">_channel</span><span class="s4">: </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">AioChannel</span>
    <span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= </span><span class="s1">Optional</span><span class="s4">[</span>
        <span class="s1">_base_call</span><span class="s4">.</span><span class="s1">StreamStreamCall</span>
    <span class="s4">]</span>

    <span class="s0"># pylint: disable=too-many-arguments</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">StreamStreamClientInterceptor</span><span class="s4">],</span>
        <span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">RequestIterableType</span><span class="s4">],</span>
        <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
        <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Metadata</span><span class="s4">,</span>
        <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">],</span>
        <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
        <span class="s1">channel</span><span class="s4">: </span><span class="s1">cygrpc</span><span class="s4">.</span><span class="s1">AioChannel</span><span class="s4">,</span>
        <span class="s1">method</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s1">request_serializer</span><span class="s4">: </span><span class="s1">SerializingFunction</span><span class="s4">,</span>
        <span class="s1">response_deserializer</span><span class="s4">: </span><span class="s1">DeserializingFunction</span><span class="s4">,</span>
        <span class="s1">loop</span><span class="s4">: </span><span class="s1">asyncio</span><span class="s4">.</span><span class="s1">AbstractEventLoop</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop </span><span class="s4">= </span><span class="s1">loop</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_channel </span><span class="s4">= </span><span class="s1">channel</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_init_stream_response_mixin</span><span class="s4">()</span>
        <span class="s1">request_iterator </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_init_stream_request_mixin</span><span class="s4">(</span><span class="s1">request_iterator</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">interceptors_task </span><span class="s4">= </span><span class="s1">loop</span><span class="s4">.</span><span class="s1">create_task</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_invoke</span><span class="s4">(</span>
                <span class="s1">interceptors</span><span class="s4">,</span>
                <span class="s1">method</span><span class="s4">,</span>
                <span class="s1">timeout</span><span class="s4">,</span>
                <span class="s1">metadata</span><span class="s4">,</span>
                <span class="s1">credentials</span><span class="s4">,</span>
                <span class="s1">wait_for_ready</span><span class="s4">,</span>
                <span class="s1">request_iterator</span><span class="s4">,</span>
                <span class="s1">request_serializer</span><span class="s4">,</span>
                <span class="s1">response_deserializer</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">interceptors_task</span><span class="s4">)</span>

    <span class="s0"># pylint: disable=too-many-arguments</span>
    <span class="s3">async def </span><span class="s1">_invoke</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">StreamStreamClientInterceptor</span><span class="s4">],</span>
        <span class="s1">method</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
        <span class="s1">metadata</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">],</span>
        <span class="s1">credentials</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">CallCredentials</span><span class="s4">],</span>
        <span class="s1">wait_for_ready</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
        <span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">RequestIterableType</span><span class="s4">,</span>
        <span class="s1">request_serializer</span><span class="s4">: </span><span class="s1">SerializingFunction</span><span class="s4">,</span>
        <span class="s1">response_deserializer</span><span class="s4">: </span><span class="s1">DeserializingFunction</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; StreamStreamCall</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Run the RPC call wrapped in interceptors&quot;&quot;&quot;</span>

        <span class="s3">async def </span><span class="s1">_run_interceptor</span><span class="s4">(</span>
            <span class="s1">interceptors</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">StreamStreamClientInterceptor</span><span class="s4">],</span>
            <span class="s1">client_call_details</span><span class="s4">: </span><span class="s1">ClientCallDetails</span><span class="s4">,</span>
            <span class="s1">request_iterator</span><span class="s4">: </span><span class="s1">RequestIterableType</span><span class="s4">,</span>
        <span class="s4">) </span><span class="s1">-&gt; _base_call</span><span class="s4">.</span><span class="s1">StreamStreamCall</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">interceptors</span><span class="s4">:</span>
                <span class="s1">continuation </span><span class="s4">= </span><span class="s1">functools</span><span class="s4">.</span><span class="s1">partial</span><span class="s4">(</span>
                    <span class="s1">_run_interceptor</span><span class="s4">, </span><span class="s1">interceptors</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]</span>
                <span class="s4">)</span>

                <span class="s1">call_or_response_iterator </span><span class="s4">= </span><span class="s3">await </span><span class="s1">interceptors</span><span class="s4">[</span>
                    <span class="s6">0</span>
                <span class="s4">].</span><span class="s1">intercept_stream_stream</span><span class="s4">(</span>
                    <span class="s1">continuation</span><span class="s4">, </span><span class="s1">client_call_details</span><span class="s4">, </span><span class="s1">request_iterator</span>
                <span class="s4">)</span>

                <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span>
                    <span class="s1">call_or_response_iterator</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">StreamStreamCall</span>
                <span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= (</span>
                        <span class="s1">call_or_response_iterator</span>
                    <span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= (</span>
                        <span class="s1">StreamStreamCallResponseIterator</span><span class="s4">(</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors</span><span class="s4">,</span>
                            <span class="s1">call_or_response_iterator</span><span class="s4">,</span>
                        <span class="s4">)</span>
                    <span class="s4">)</span>
                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors </span><span class="s4">= </span><span class="s1">StreamStreamCall</span><span class="s4">(</span>
                    <span class="s1">request_iterator</span><span class="s4">,</span>
                    <span class="s1">_timeout_to_deadline</span><span class="s4">(</span><span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">timeout</span><span class="s4">),</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">metadata</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">credentials</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">wait_for_ready</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_channel</span><span class="s4">,</span>
                    <span class="s1">client_call_details</span><span class="s4">.</span><span class="s1">method</span><span class="s4">,</span>
                    <span class="s1">request_serializer</span><span class="s4">,</span>
                    <span class="s1">response_deserializer</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_loop</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_last_returned_call_from_interceptors</span>

        <span class="s1">client_call_details </span><span class="s4">= </span><span class="s1">ClientCallDetails</span><span class="s4">(</span>
            <span class="s1">method</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">, </span><span class="s1">credentials</span><span class="s4">, </span><span class="s1">wait_for_ready</span>
        <span class="s4">)</span>
        <span class="s3">return await </span><span class="s1">_run_interceptor</span><span class="s4">(</span>
            <span class="s1">list</span><span class="s4">(</span><span class="s1">interceptors</span><span class="s4">), </span><span class="s1">client_call_details</span><span class="s4">, </span><span class="s1">request_iterator</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">time_remaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">UnaryUnaryCallResponse</span><span class="s4">(</span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryUnaryCall</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Final UnaryUnaryCall class finished with a response.&quot;&quot;&quot;</span>

    <span class="s1">_response</span><span class="s4">: </span><span class="s1">ResponseType</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">response</span><span class="s4">: </span><span class="s1">ResponseType</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_response </span><span class="s4">= </span><span class="s1">response</span>

    <span class="s3">def </span><span class="s1">cancel</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">cancelled</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">done</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">add_done_callback</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">unused_callback</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">time_remaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">initial_metadata</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">]:</span>
        <span class="s3">return None</span>

    <span class="s3">async def </span><span class="s1">trailing_metadata</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">]:</span>
        <span class="s3">return None</span>

    <span class="s3">async def </span><span class="s1">code</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; grpc</span><span class="s4">.</span><span class="s1">StatusCode</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">grpc</span><span class="s4">.</span><span class="s1">StatusCode</span><span class="s4">.</span><span class="s1">OK</span>

    <span class="s3">async def </span><span class="s1">details</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s5">&quot;&quot;</span>

    <span class="s3">async def </span><span class="s1">debug_error_string</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">__await__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if False</span><span class="s4">:  </span><span class="s0"># pylint: disable=using-constant-test</span>
            <span class="s0"># This code path is never used, but a yield statement is needed</span>
            <span class="s0"># for telling the interpreter that __await__ is a generator.</span>
            <span class="s3">yield None</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_response</span>

    <span class="s3">async def </span><span class="s1">wait_for_connection</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">pass</span>


<span class="s3">class </span><span class="s1">_StreamCallResponseIterator</span><span class="s4">:</span>
    <span class="s1">_call</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryStreamCall</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">StreamStreamCall</span><span class="s4">]</span>
    <span class="s1">_response_iterator</span><span class="s4">: </span><span class="s1">AsyncIterable</span><span class="s4">[</span><span class="s1">ResponseType</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">call</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryStreamCall</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">StreamStreamCall</span><span class="s4">],</span>
        <span class="s1">response_iterator</span><span class="s4">: </span><span class="s1">AsyncIterable</span><span class="s4">[</span><span class="s1">ResponseType</span><span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_response_iterator </span><span class="s4">= </span><span class="s1">response_iterator</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_call </span><span class="s4">= </span><span class="s1">call</span>

    <span class="s3">def </span><span class="s1">cancel</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">cancel</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">cancelled</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">cancelled</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">done</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">done</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">add_done_callback</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">callback</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">add_done_callback</span><span class="s4">(</span><span class="s1">callback</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">time_remaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">time_remaining</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">initial_metadata</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">]:</span>
        <span class="s3">return await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">initial_metadata</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">trailing_metadata</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Metadata</span><span class="s4">]:</span>
        <span class="s3">return await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">trailing_metadata</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">code</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; grpc</span><span class="s4">.</span><span class="s1">StatusCode</span><span class="s4">:</span>
        <span class="s3">return await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">code</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">details</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s3">return await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">details</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">debug_error_string</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s3">return await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">debug_error_string</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">__aiter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_response_iterator</span><span class="s4">.</span><span class="s1">__aiter__</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">wait_for_connection</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">return await </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">wait_for_connection</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">UnaryStreamCallResponseIterator</span><span class="s4">(</span>
    <span class="s1">_StreamCallResponseIterator</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">UnaryStreamCall</span>
<span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;UnaryStreamCall class wich uses an alternative response iterator.&quot;&quot;&quot;</span>

    <span class="s3">async def </span><span class="s1">read</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">EOFType</span><span class="s4">, </span><span class="s1">ResponseType</span><span class="s4">]:</span>
        <span class="s0"># Behind the scenes everyting goes through the</span>
        <span class="s0"># async iterator. So this path should not be reached.</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">StreamStreamCallResponseIterator</span><span class="s4">(</span>
    <span class="s1">_StreamCallResponseIterator</span><span class="s4">, </span><span class="s1">_base_call</span><span class="s4">.</span><span class="s1">StreamStreamCall</span>
<span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;StreamStreamCall class wich uses an alternative response iterator.&quot;&quot;&quot;</span>

    <span class="s3">async def </span><span class="s1">read</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">EOFType</span><span class="s4">, </span><span class="s1">ResponseType</span><span class="s4">]:</span>
        <span class="s0"># Behind the scenes everyting goes through the</span>
        <span class="s0"># async iterator. So this path should not be reached.</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">write</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">request</span><span class="s4">: </span><span class="s1">RequestType</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s0"># Behind the scenes everyting goes through the</span>
        <span class="s0"># async iterator provided by the InterceptedStreamStreamCall.</span>
        <span class="s0"># So this path should not be reached.</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>

    <span class="s3">async def </span><span class="s1">done_writing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s0"># Behind the scenes everyting goes through the</span>
        <span class="s0"># async iterator provided by the InterceptedStreamStreamCall.</span>
        <span class="s0"># So this path should not be reached.</span>
        <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">_done_writing_flag</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_call</span><span class="s4">.</span><span class="s1">_done_writing_flag</span>
</pre>
</body>
</html>