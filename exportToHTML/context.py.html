<html>
<head>
<title>context.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
context.py</font>
</center></td></tr></table>
<pre><span class="s0">###############################################################################</span>
<span class="s0"># Basic context management with LokyContext</span>
<span class="s0">#</span>
<span class="s0"># author: Thomas Moreau and Olivier Grisel</span>
<span class="s0">#</span>
<span class="s0"># adapted from multiprocessing/context.py</span>
<span class="s0">#  * Create a context ensuring loky uses only objects that are compatible</span>
<span class="s0">#  * Add LokyContext to the list of context of multiprocessing so loky can be</span>
<span class="s0">#    used with multiprocessing.set_start_method</span>
<span class="s0">#  * Implement a CFS-aware amd physical-core aware cpu_count function.</span>
<span class="s0">#</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">math</span>
<span class="s2">import </span><span class="s1">subprocess</span>
<span class="s2">import </span><span class="s1">traceback</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">import </span><span class="s1">multiprocessing </span><span class="s2">as </span><span class="s1">mp</span>
<span class="s2">from </span><span class="s1">multiprocessing </span><span class="s2">import </span><span class="s1">get_context </span><span class="s2">as </span><span class="s1">mp_get_context</span>
<span class="s2">from </span><span class="s1">multiprocessing</span><span class="s3">.</span><span class="s1">context </span><span class="s2">import </span><span class="s1">BaseContext</span>


<span class="s2">from </span><span class="s3">.</span><span class="s1">process </span><span class="s2">import </span><span class="s1">LokyProcess</span><span class="s3">, </span><span class="s1">LokyInitMainProcess</span>

<span class="s0"># Apparently, on older Python versions, loky cannot work 61 workers on Windows</span>
<span class="s0"># but instead 60: ¯\_(ツ)_/¯</span>
<span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">8</span><span class="s3">):</span>
    <span class="s2">from </span><span class="s1">concurrent</span><span class="s3">.</span><span class="s1">futures</span><span class="s3">.</span><span class="s1">process </span><span class="s2">import </span><span class="s1">_MAX_WINDOWS_WORKERS</span>

    <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&lt; (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">):</span>
        <span class="s1">_MAX_WINDOWS_WORKERS </span><span class="s3">= </span><span class="s1">_MAX_WINDOWS_WORKERS </span><span class="s3">- </span><span class="s4">1</span>
<span class="s2">else</span><span class="s3">:</span>
    <span class="s0"># compat for versions before 3.8 which do not define this.</span>
    <span class="s1">_MAX_WINDOWS_WORKERS </span><span class="s3">= </span><span class="s4">60</span>

<span class="s1">START_METHODS </span><span class="s3">= [</span><span class="s5">&quot;loky&quot;</span><span class="s3">, </span><span class="s5">&quot;loky_init_main&quot;</span><span class="s3">, </span><span class="s5">&quot;spawn&quot;</span><span class="s3">]</span>
<span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">!= </span><span class="s5">&quot;win32&quot;</span><span class="s3">:</span>
    <span class="s1">START_METHODS </span><span class="s3">+= [</span><span class="s5">&quot;fork&quot;</span><span class="s3">, </span><span class="s5">&quot;forkserver&quot;</span><span class="s3">]</span>

<span class="s1">_DEFAULT_START_METHOD </span><span class="s3">= </span><span class="s2">None</span>

<span class="s0"># Cache for the number of physical cores to avoid repeating subprocess calls.</span>
<span class="s0"># It should not change during the lifetime of the program.</span>
<span class="s1">physical_cores_cache </span><span class="s3">= </span><span class="s2">None</span>


<span class="s2">def </span><span class="s1">get_context</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0"># Try to overload the default context</span>
    <span class="s1">method </span><span class="s3">= </span><span class="s1">method </span><span class="s2">or </span><span class="s1">_DEFAULT_START_METHOD </span><span class="s2">or </span><span class="s5">&quot;loky&quot;</span>
    <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s5">&quot;fork&quot;</span><span class="s3">:</span>
        <span class="s0"># If 'fork' is explicitly requested, warn user about potential issues.</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
            <span class="s5">&quot;`fork` start method should not be used with &quot;</span>
            <span class="s5">&quot;`loky` as it does not respect POSIX. Try using &quot;</span>
            <span class="s5">&quot;`spawn` or `loky` instead.&quot;</span><span class="s3">,</span>
            <span class="s1">UserWarning</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">mp_get_context</span><span class="s3">(</span><span class="s1">method</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s5">f&quot;Unknown context '</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s5">'. Value should be in &quot;</span>
            <span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">START_METHODS</span><span class="s2">}</span><span class="s5">.&quot;</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">set_start_method</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">force</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
    <span class="s2">global </span><span class="s1">_DEFAULT_START_METHOD</span>
    <span class="s2">if </span><span class="s1">_DEFAULT_START_METHOD </span><span class="s2">is not None and not </span><span class="s1">force</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s5">&quot;context has already been set&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">method </span><span class="s2">is None or </span><span class="s1">method </span><span class="s2">in </span><span class="s1">START_METHODS</span><span class="s3">, (</span>
        <span class="s5">f&quot;'</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s5">' is not a valid start_method. It should be in &quot;</span>
        <span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">START_METHODS</span><span class="s2">}</span><span class="s5">&quot;</span>
    <span class="s3">)</span>

    <span class="s1">_DEFAULT_START_METHOD </span><span class="s3">= </span><span class="s1">method</span>


<span class="s2">def </span><span class="s1">get_start_method</span><span class="s3">():</span>
    <span class="s2">return </span><span class="s1">_DEFAULT_START_METHOD</span>


<span class="s2">def </span><span class="s1">cpu_count</span><span class="s3">(</span><span class="s1">only_physical_cores</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Return the number of CPUs the current process can use. 
 
    The returned number of CPUs accounts for: 
     * the number of CPUs in the system, as given by 
       ``multiprocessing.cpu_count``; 
     * the CPU affinity settings of the current process 
       (available on some Unix systems); 
     * Cgroup CPU bandwidth limit (available on Linux only, typically 
       set by docker and similar container orchestration systems); 
     * the value of the LOKY_MAX_CPU_COUNT environment variable if defined. 
    and is given as the minimum of these constraints. 
 
    If ``only_physical_cores`` is True, return the number of physical cores 
    instead of the number of logical cores (hyperthreading / SMT). Note that 
    this option is not enforced if the number of usable cores is controlled in 
    any other way such as: process affinity, Cgroup restricted CPU bandwidth 
    or the LOKY_MAX_CPU_COUNT environment variable. If the number of physical 
    cores is not found, return the number of logical cores. 
 
    Note that on Windows, the returned number of CPUs cannot exceed 61 (or 60 for 
    Python &lt; 3.10), see: 
    https://bugs.python.org/issue26903. 
 
    It is also always larger or equal to 1. 
    &quot;&quot;&quot;</span>
    <span class="s0"># Note: os.cpu_count() is allowed to return None in its docstring</span>
    <span class="s1">os_cpu_count </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">cpu_count</span><span class="s3">() </span><span class="s2">or </span><span class="s4">1</span>
    <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">&quot;win32&quot;</span><span class="s3">:</span>
        <span class="s0"># On Windows, attempting to use more than 61 CPUs would result in a</span>
        <span class="s0"># OS-level error. See https://bugs.python.org/issue26903. According to</span>
        <span class="s0"># https://learn.microsoft.com/en-us/windows/win32/procthread/processor-groups</span>
        <span class="s0"># it might be possible to go beyond with a lot of extra work but this</span>
        <span class="s0"># does not look easy.</span>
        <span class="s1">os_cpu_count </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">os_cpu_count</span><span class="s3">, </span><span class="s1">_MAX_WINDOWS_WORKERS</span><span class="s3">)</span>

    <span class="s1">cpu_count_user </span><span class="s3">= </span><span class="s1">_cpu_count_user</span><span class="s3">(</span><span class="s1">os_cpu_count</span><span class="s3">)</span>
    <span class="s1">aggregate_cpu_count </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">min</span><span class="s3">(</span><span class="s1">os_cpu_count</span><span class="s3">, </span><span class="s1">cpu_count_user</span><span class="s3">), </span><span class="s4">1</span><span class="s3">)</span>

    <span class="s2">if not </span><span class="s1">only_physical_cores</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">aggregate_cpu_count</span>

    <span class="s2">if </span><span class="s1">cpu_count_user </span><span class="s3">&lt; </span><span class="s1">os_cpu_count</span><span class="s3">:</span>
        <span class="s0"># Respect user setting</span>
        <span class="s2">return </span><span class="s1">max</span><span class="s3">(</span><span class="s1">cpu_count_user</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>

    <span class="s1">cpu_count_physical</span><span class="s3">, </span><span class="s1">exception </span><span class="s3">= </span><span class="s1">_count_physical_cores</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">cpu_count_physical </span><span class="s3">!= </span><span class="s5">&quot;not found&quot;</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">cpu_count_physical</span>

    <span class="s0"># Fallback to default behavior</span>
    <span class="s2">if </span><span class="s1">exception </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s0"># warns only the first time</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
            <span class="s5">&quot;Could not find the number of physical cores for the &quot;</span>
            <span class="s5">f&quot;following reason:</span><span class="s2">\n{</span><span class="s1">exception</span><span class="s2">}\n</span><span class="s5">&quot;</span>
            <span class="s5">&quot;Returning the number of logical cores instead. You can &quot;</span>
            <span class="s5">&quot;silence this warning by setting LOKY_MAX_CPU_COUNT to &quot;</span>
            <span class="s5">&quot;the number of cores you want to use.&quot;</span>
        <span class="s3">)</span>
        <span class="s1">traceback</span><span class="s3">.</span><span class="s1">print_tb</span><span class="s3">(</span><span class="s1">exception</span><span class="s3">.</span><span class="s1">__traceback__</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">aggregate_cpu_count</span>


<span class="s2">def </span><span class="s1">_cpu_count_cgroup</span><span class="s3">(</span><span class="s1">os_cpu_count</span><span class="s3">):</span>
    <span class="s0"># Cgroup CPU bandwidth limit available in Linux since 2.6 kernel</span>
    <span class="s1">cpu_max_fname </span><span class="s3">= </span><span class="s5">&quot;/sys/fs/cgroup/cpu.max&quot;</span>
    <span class="s1">cfs_quota_fname </span><span class="s3">= </span><span class="s5">&quot;/sys/fs/cgroup/cpu/cpu.cfs_quota_us&quot;</span>
    <span class="s1">cfs_period_fname </span><span class="s3">= </span><span class="s5">&quot;/sys/fs/cgroup/cpu/cpu.cfs_period_us&quot;</span>
    <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">cpu_max_fname</span><span class="s3">):</span>
        <span class="s0"># cgroup v2</span>
        <span class="s0"># https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">cpu_max_fname</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fh</span><span class="s3">:</span>
            <span class="s1">cpu_quota_us</span><span class="s3">, </span><span class="s1">cpu_period_us </span><span class="s3">= </span><span class="s1">fh</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">split</span><span class="s3">()</span>
    <span class="s2">elif </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">cfs_quota_fname</span><span class="s3">) </span><span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">cfs_period_fname</span><span class="s3">):</span>
        <span class="s0"># cgroup v1</span>
        <span class="s0"># https://www.kernel.org/doc/html/latest/scheduler/sched-bwc.html#management</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">cfs_quota_fname</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fh</span><span class="s3">:</span>
            <span class="s1">cpu_quota_us </span><span class="s3">= </span><span class="s1">fh</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">cfs_period_fname</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fh</span><span class="s3">:</span>
            <span class="s1">cpu_period_us </span><span class="s3">= </span><span class="s1">fh</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">strip</span><span class="s3">()</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s0"># No Cgroup CPU bandwidth limit (e.g. non-Linux platform)</span>
        <span class="s1">cpu_quota_us </span><span class="s3">= </span><span class="s5">&quot;max&quot;</span>
        <span class="s1">cpu_period_us </span><span class="s3">= </span><span class="s4">100_000  </span><span class="s0"># unused, for consistency with default values</span>

    <span class="s2">if </span><span class="s1">cpu_quota_us </span><span class="s3">== </span><span class="s5">&quot;max&quot;</span><span class="s3">:</span>
        <span class="s0"># No active Cgroup quota on a Cgroup-capable platform</span>
        <span class="s2">return </span><span class="s1">os_cpu_count</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">cpu_quota_us </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">cpu_quota_us</span><span class="s3">)</span>
        <span class="s1">cpu_period_us </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">cpu_period_us</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">cpu_quota_us </span><span class="s3">&gt; </span><span class="s4">0 </span><span class="s2">and </span><span class="s1">cpu_period_us </span><span class="s3">&gt; </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">math</span><span class="s3">.</span><span class="s1">ceil</span><span class="s3">(</span><span class="s1">cpu_quota_us </span><span class="s3">/ </span><span class="s1">cpu_period_us</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s0"># Setting a negative cpu_quota_us value is a valid way to disable</span>
            <span class="s0"># cgroup CPU bandwith limits</span>
            <span class="s2">return </span><span class="s1">os_cpu_count</span>


<span class="s2">def </span><span class="s1">_cpu_count_affinity</span><span class="s3">(</span><span class="s1">os_cpu_count</span><span class="s3">):</span>
    <span class="s0"># Number of available CPUs given affinity settings</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">, </span><span class="s5">&quot;sched_getaffinity&quot;</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">sched_getaffinity</span><span class="s3">(</span><span class="s4">0</span><span class="s3">))</span>
        <span class="s2">except </span><span class="s1">NotImplementedError</span><span class="s3">:</span>
            <span class="s2">pass</span>

    <span class="s0"># On PyPy and possibly other platforms, os.sched_getaffinity does not exist</span>
    <span class="s0"># or raises NotImplementedError, let's try with the psutil if installed.</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">import </span><span class="s1">psutil</span>

        <span class="s1">p </span><span class="s3">= </span><span class="s1">psutil</span><span class="s3">.</span><span class="s1">Process</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s5">&quot;cpu_affinity&quot;</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">p</span><span class="s3">.</span><span class="s1">cpu_affinity</span><span class="s3">())</span>

    <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">&quot;linux&quot;</span>
            <span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;LOKY_MAX_CPU_COUNT&quot;</span><span class="s3">) </span><span class="s2">is None</span>
        <span class="s3">):</span>
            <span class="s0"># PyPy does not implement os.sched_getaffinity on Linux which</span>
            <span class="s0"># can cause severe oversubscription problems. Better warn the</span>
            <span class="s0"># user in this particularly pathological case which can wreck</span>
            <span class="s0"># havoc, typically on CI workers.</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                <span class="s5">&quot;Failed to inspect CPU affinity constraints on this system. &quot;</span>
                <span class="s5">&quot;Please install psutil or explictly set LOKY_MAX_CPU_COUNT.&quot;</span>
            <span class="s3">)</span>

    <span class="s0"># This can happen for platforms that do not implement any kind of CPU</span>
    <span class="s0"># infinity such as macOS-based platforms.</span>
    <span class="s2">return </span><span class="s1">os_cpu_count</span>


<span class="s2">def </span><span class="s1">_cpu_count_user</span><span class="s3">(</span><span class="s1">os_cpu_count</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Number of user defined available CPUs&quot;&quot;&quot;</span>
    <span class="s1">cpu_count_affinity </span><span class="s3">= </span><span class="s1">_cpu_count_affinity</span><span class="s3">(</span><span class="s1">os_cpu_count</span><span class="s3">)</span>

    <span class="s1">cpu_count_cgroup </span><span class="s3">= </span><span class="s1">_cpu_count_cgroup</span><span class="s3">(</span><span class="s1">os_cpu_count</span><span class="s3">)</span>

    <span class="s0"># User defined soft-limit passed as a loky specific environment variable.</span>
    <span class="s1">cpu_count_loky </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;LOKY_MAX_CPU_COUNT&quot;</span><span class="s3">, </span><span class="s1">os_cpu_count</span><span class="s3">))</span>

    <span class="s2">return </span><span class="s1">min</span><span class="s3">(</span><span class="s1">cpu_count_affinity</span><span class="s3">, </span><span class="s1">cpu_count_cgroup</span><span class="s3">, </span><span class="s1">cpu_count_loky</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_count_physical_cores</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot;Return a tuple (number of physical cores, exception) 
 
    If the number of physical cores is found, exception is set to None. 
    If it has not been found, return (&quot;not found&quot;, exception). 
 
    The number of physical cores is cached to avoid repeating subprocess calls. 
    &quot;&quot;&quot;</span>
    <span class="s1">exception </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s0"># First check if the value is cached</span>
    <span class="s2">global </span><span class="s1">physical_cores_cache</span>
    <span class="s2">if </span><span class="s1">physical_cores_cache </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">physical_cores_cache</span><span class="s3">, </span><span class="s1">exception</span>

    <span class="s0"># Not cached yet, find it</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">&quot;linux&quot;</span><span class="s3">:</span>
            <span class="s1">cpu_info </span><span class="s3">= </span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">run</span><span class="s3">(</span>
                <span class="s5">&quot;lscpu --parse=core&quot;</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(), </span><span class="s1">capture_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">text</span><span class="s3">=</span><span class="s2">True</span>
            <span class="s3">)</span>
            <span class="s1">cpu_info </span><span class="s3">= </span><span class="s1">cpu_info</span><span class="s3">.</span><span class="s1">stdout</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">()</span>
            <span class="s1">cpu_info </span><span class="s3">= {</span><span class="s1">line </span><span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">cpu_info </span><span class="s2">if not </span><span class="s1">line</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;#&quot;</span><span class="s3">)}</span>
            <span class="s1">cpu_count_physical </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">cpu_info</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">&quot;win32&quot;</span><span class="s3">:</span>
            <span class="s1">cpu_info </span><span class="s3">= </span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">run</span><span class="s3">(</span>
                <span class="s5">&quot;wmic CPU Get NumberOfCores /Format:csv&quot;</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(),</span>
                <span class="s1">capture_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s1">text</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">cpu_info </span><span class="s3">= </span><span class="s1">cpu_info</span><span class="s3">.</span><span class="s1">stdout</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">()</span>
            <span class="s1">cpu_info </span><span class="s3">= [</span>
                <span class="s1">l</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;,&quot;</span><span class="s3">)[</span><span class="s4">1</span><span class="s3">]</span>
                <span class="s2">for </span><span class="s1">l </span><span class="s2">in </span><span class="s1">cpu_info</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">l </span><span class="s2">and </span><span class="s1">l </span><span class="s3">!= </span><span class="s5">&quot;Node,NumberOfCores&quot;</span><span class="s3">)</span>
            <span class="s3">]</span>
            <span class="s1">cpu_count_physical </span><span class="s3">= </span><span class="s1">sum</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">int</span><span class="s3">, </span><span class="s1">cpu_info</span><span class="s3">))</span>
        <span class="s2">elif </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">&quot;darwin&quot;</span><span class="s3">:</span>
            <span class="s1">cpu_info </span><span class="s3">= </span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">run</span><span class="s3">(</span>
                <span class="s5">&quot;sysctl -n hw.physicalcpu&quot;</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(),</span>
                <span class="s1">capture_output</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s1">text</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">cpu_info </span><span class="s3">= </span><span class="s1">cpu_info</span><span class="s3">.</span><span class="s1">stdout</span>
            <span class="s1">cpu_count_physical </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">cpu_info</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s5">f&quot;unsupported platform: </span><span class="s2">{</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>

        <span class="s0"># if cpu_count_physical &lt; 1, we did not find a valid value</span>
        <span class="s2">if </span><span class="s1">cpu_count_physical </span><span class="s3">&lt; </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">f&quot;found </span><span class="s2">{</span><span class="s1">cpu_count_physical</span><span class="s2">} </span><span class="s5">physical cores &lt; 1&quot;</span><span class="s3">)</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">exception </span><span class="s3">= </span><span class="s1">e</span>
        <span class="s1">cpu_count_physical </span><span class="s3">= </span><span class="s5">&quot;not found&quot;</span>

    <span class="s0"># Put the result in cache</span>
    <span class="s1">physical_cores_cache </span><span class="s3">= </span><span class="s1">cpu_count_physical</span>

    <span class="s2">return </span><span class="s1">cpu_count_physical</span><span class="s3">, </span><span class="s1">exception</span>


<span class="s2">class </span><span class="s1">LokyContext</span><span class="s3">(</span><span class="s1">BaseContext</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Context relying on the LokyProcess.&quot;&quot;&quot;</span>

    <span class="s1">_name </span><span class="s3">= </span><span class="s5">&quot;loky&quot;</span>
    <span class="s1">Process </span><span class="s3">= </span><span class="s1">LokyProcess</span>
    <span class="s1">cpu_count </span><span class="s3">= </span><span class="s1">staticmethod</span><span class="s3">(</span><span class="s1">cpu_count</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">Queue</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">maxsize</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">reducers</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Returns a queue object&quot;&quot;&quot;</span>
        <span class="s2">from </span><span class="s3">.</span><span class="s1">queues </span><span class="s2">import </span><span class="s1">Queue</span>

        <span class="s2">return </span><span class="s1">Queue</span><span class="s3">(</span><span class="s1">maxsize</span><span class="s3">, </span><span class="s1">reducers</span><span class="s3">=</span><span class="s1">reducers</span><span class="s3">, </span><span class="s1">ctx</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_context</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">SimpleQueue</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">reducers</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Returns a queue object&quot;&quot;&quot;</span>
        <span class="s2">from </span><span class="s3">.</span><span class="s1">queues </span><span class="s2">import </span><span class="s1">SimpleQueue</span>

        <span class="s2">return </span><span class="s1">SimpleQueue</span><span class="s3">(</span><span class="s1">reducers</span><span class="s3">=</span><span class="s1">reducers</span><span class="s3">, </span><span class="s1">ctx</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_context</span><span class="s3">())</span>

    <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">!= </span><span class="s5">&quot;win32&quot;</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;For Unix platform, use our custom implementation of synchronize 
        ensuring that we use the loky.backend.resource_tracker to clean-up 
        the semaphores in case of a worker crash. 
        &quot;&quot;&quot;</span>

        <span class="s2">def </span><span class="s1">Semaphore</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">=</span><span class="s4">1</span><span class="s3">):</span>
            <span class="s6">&quot;&quot;&quot;Returns a semaphore object&quot;&quot;&quot;</span>
            <span class="s2">from </span><span class="s3">.</span><span class="s1">synchronize </span><span class="s2">import </span><span class="s1">Semaphore</span>

            <span class="s2">return </span><span class="s1">Semaphore</span><span class="s3">(</span><span class="s1">value</span><span class="s3">=</span><span class="s1">value</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">BoundedSemaphore</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
            <span class="s6">&quot;&quot;&quot;Returns a bounded semaphore object&quot;&quot;&quot;</span>
            <span class="s2">from </span><span class="s3">.</span><span class="s1">synchronize </span><span class="s2">import </span><span class="s1">BoundedSemaphore</span>

            <span class="s2">return </span><span class="s1">BoundedSemaphore</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">Lock</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s6">&quot;&quot;&quot;Returns a lock object&quot;&quot;&quot;</span>
            <span class="s2">from </span><span class="s3">.</span><span class="s1">synchronize </span><span class="s2">import </span><span class="s1">Lock</span>

            <span class="s2">return </span><span class="s1">Lock</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">RLock</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s6">&quot;&quot;&quot;Returns a recurrent lock object&quot;&quot;&quot;</span>
            <span class="s2">from </span><span class="s3">.</span><span class="s1">synchronize </span><span class="s2">import </span><span class="s1">RLock</span>

            <span class="s2">return </span><span class="s1">RLock</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">Condition</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">lock</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s6">&quot;&quot;&quot;Returns a condition object&quot;&quot;&quot;</span>
            <span class="s2">from </span><span class="s3">.</span><span class="s1">synchronize </span><span class="s2">import </span><span class="s1">Condition</span>

            <span class="s2">return </span><span class="s1">Condition</span><span class="s3">(</span><span class="s1">lock</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">Event</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s6">&quot;&quot;&quot;Returns an event object&quot;&quot;&quot;</span>
            <span class="s2">from </span><span class="s3">.</span><span class="s1">synchronize </span><span class="s2">import </span><span class="s1">Event</span>

            <span class="s2">return </span><span class="s1">Event</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">LokyInitMainContext</span><span class="s3">(</span><span class="s1">LokyContext</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Extra context with LokyProcess, which does load the main module 
 
    This context is used for compatibility in the case ``cloudpickle`` is not 
    present on the running system. This permits to load functions defined in 
    the ``main`` module, using proper safeguards. The declaration of the 
    ``executor`` should be protected by ``if __name__ == &quot;__main__&quot;:`` and the 
    functions and variable used from main should be out of this block. 
 
    This mimics the default behavior of multiprocessing under Windows and the 
    behavior of the ``spawn`` start method on a posix system. 
    For more details, see the end of the following section of python doc 
    https://docs.python.org/3/library/multiprocessing.html#multiprocessing-programming 
    &quot;&quot;&quot;</span>

    <span class="s1">_name </span><span class="s3">= </span><span class="s5">&quot;loky_init_main&quot;</span>
    <span class="s1">Process </span><span class="s3">= </span><span class="s1">LokyInitMainProcess</span>


<span class="s0"># Register loky context so it works with multiprocessing.get_context</span>
<span class="s1">ctx_loky </span><span class="s3">= </span><span class="s1">LokyContext</span><span class="s3">()</span>
<span class="s1">mp</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">_concrete_contexts</span><span class="s3">[</span><span class="s5">&quot;loky&quot;</span><span class="s3">] = </span><span class="s1">ctx_loky</span>
<span class="s1">mp</span><span class="s3">.</span><span class="s1">context</span><span class="s3">.</span><span class="s1">_concrete_contexts</span><span class="s3">[</span><span class="s5">&quot;loky_init_main&quot;</span><span class="s3">] = </span><span class="s1">LokyInitMainContext</span><span class="s3">()</span>
</pre>
</body>
</html>