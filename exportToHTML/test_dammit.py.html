<html>
<head>
<title>test_dammit.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
.s6 { color: #a5c261;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_dammit.py</font>
</center></td></tr></table>
<pre><span class="s0"># encoding: utf-8</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">bs4</span>
<span class="s2">from </span><span class="s1">bs4 </span><span class="s2">import </span><span class="s1">BeautifulSoup</span>
<span class="s2">from </span><span class="s1">bs4</span><span class="s3">.</span><span class="s1">dammit </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">EntitySubstitution</span><span class="s3">,</span>
    <span class="s1">EncodingDetector</span><span class="s3">,</span>
    <span class="s1">UnicodeDammit</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">class </span><span class="s1">TestUnicodeDammit</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot;Standalone tests of UnicodeDammit.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">test_unicode_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">markup </span><span class="s3">= </span><span class="s5">&quot;I'm already Unicode! </span><span class="s2">\N{SNOWMAN}</span><span class="s5">&quot;</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">markup</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">unicode_markup </span><span class="s3">== </span><span class="s1">markup</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s5">&quot;smart_quotes_to,expect_converted&quot;</span><span class="s3">,</span>
        <span class="s3">[(</span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;</span><span class="s2">\u2018\u2019\u201c\u201d</span><span class="s5">&quot;</span><span class="s3">),</span>
         <span class="s3">(</span><span class="s5">&quot;xml&quot;</span><span class="s3">, </span><span class="s5">&quot;&amp;#x2018;&amp;#x2019;&amp;#x201C;&amp;#x201D;&quot;</span><span class="s3">),</span>
         <span class="s3">(</span><span class="s5">&quot;html&quot;</span><span class="s3">, </span><span class="s5">&quot;&amp;lsquo;&amp;rsquo;&amp;ldquo;&amp;rdquo;&quot;</span><span class="s3">),</span>
         <span class="s3">(</span><span class="s5">&quot;ascii&quot;</span><span class="s3">, </span><span class="s5">&quot;''&quot; </span><span class="s3">+ </span><span class="s5">'&quot;&quot;'</span><span class="s3">),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_smart_quotes_to</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">smart_quotes_to</span><span class="s3">, </span><span class="s1">expect_converted</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;Verify the functionality of the smart_quotes_to argument 
        to the UnicodeDammit constructor.&quot;&quot;&quot;</span>
        <span class="s1">markup </span><span class="s3">= </span><span class="s6">b&quot;&lt;foo&gt;</span><span class="s2">\x91\x92\x93\x94</span><span class="s6">&lt;/foo&gt;&quot;</span>
        <span class="s1">converted </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span>
            <span class="s1">markup</span><span class="s3">, </span><span class="s1">known_definite_encodings</span><span class="s3">=[</span><span class="s5">&quot;windows-1252&quot;</span><span class="s3">],</span>
            <span class="s1">smart_quotes_to</span><span class="s3">=</span><span class="s1">smart_quotes_to</span>
        <span class="s3">).</span><span class="s1">unicode_markup</span>
        <span class="s2">assert </span><span class="s1">converted </span><span class="s3">== </span><span class="s5">&quot;&lt;foo&gt;{}&lt;/foo&gt;&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">expect_converted</span><span class="s3">)</span>
        
    <span class="s2">def </span><span class="s1">test_detect_utf8</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">utf8 </span><span class="s3">= </span><span class="s6">b&quot;Sacr</span><span class="s2">\xc3\xa9 </span><span class="s6">bleu! </span><span class="s2">\xe2\x98\x83</span><span class="s6">&quot;</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">utf8</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s5">'utf-8'</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">unicode_markup </span><span class="s3">== </span><span class="s5">'Sacr</span><span class="s2">\xe9 </span><span class="s5">bleu! </span><span class="s2">\N{SNOWMAN}</span><span class="s5">'</span>

    <span class="s2">def </span><span class="s1">test_convert_hebrew</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">hebrew </span><span class="s3">= </span><span class="s6">b&quot;</span><span class="s2">\xed\xe5\xec\xf9</span><span class="s6">&quot;</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">hebrew</span><span class="s3">, [</span><span class="s5">&quot;iso-8859-8&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s5">'iso-8859-8'</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">unicode_markup </span><span class="s3">== </span><span class="s5">'</span><span class="s2">\u05dd\u05d5\u05dc\u05e9</span><span class="s5">'</span>

    <span class="s2">def </span><span class="s1">test_dont_see_smart_quotes_where_there_are_none</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">utf_8 </span><span class="s3">= </span><span class="s6">b&quot;</span><span class="s2">\343\202\261\343\203\274\343\202\277\343\202\244 </span><span class="s6">Watch&quot;</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">utf_8</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s5">'utf-8'</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">unicode_markup</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">) == </span><span class="s1">utf_8</span>

    <span class="s2">def </span><span class="s1">test_ignore_inappropriate_codecs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">utf8_data </span><span class="s3">= </span><span class="s5">&quot;Räksmörgås&quot;</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">)</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">utf8_data</span><span class="s3">, [</span><span class="s5">&quot;iso-8859-8&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s5">'utf-8'</span>

    <span class="s2">def </span><span class="s1">test_ignore_invalid_codecs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">utf8_data </span><span class="s3">= </span><span class="s5">&quot;Räksmörgås&quot;</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">bad_encoding </span><span class="s2">in </span><span class="s3">[</span><span class="s5">'.utf8'</span><span class="s3">, </span><span class="s5">'...'</span><span class="s3">, </span><span class="s5">'utF---16.!'</span><span class="s3">]:</span>
            <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">utf8_data</span><span class="s3">, [</span><span class="s1">bad_encoding</span><span class="s3">])</span>
            <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s5">'utf-8'</span>

    <span class="s2">def </span><span class="s1">test_exclude_encodings</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># This is UTF-8.</span>
        <span class="s1">utf8_data </span><span class="s3">= </span><span class="s5">&quot;Räksmörgås&quot;</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">)</span>

        <span class="s0"># But if we exclude UTF-8 from consideration, the guess is</span>
        <span class="s0"># Windows-1252.</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">utf8_data</span><span class="s3">, </span><span class="s1">exclude_encodings</span><span class="s3">=[</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s5">'windows-1252'</span>

        <span class="s0"># And if we exclude that, there is no valid guess at all.</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span>
            <span class="s1">utf8_data</span><span class="s3">, </span><span class="s1">exclude_encodings</span><span class="s3">=[</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s5">&quot;windows-1252&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding </span><span class="s3">== </span><span class="s2">None</span>

<span class="s2">class </span><span class="s1">TestEncodingDetector</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
        
    <span class="s2">def </span><span class="s1">test_encoding_detector_replaces_junk_in_encoding_name_with_replacement_character</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">detected </span><span class="s3">= </span><span class="s1">EncodingDetector</span><span class="s3">(</span>
            <span class="s6">b'&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-</span><span class="s2">\xdb</span><span class="s6">&quot; ?&gt;'</span><span class="s3">)</span>
        <span class="s1">encodings </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">detected</span><span class="s3">.</span><span class="s1">encodings</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s5">'utf-</span><span class="s2">\N{REPLACEMENT CHARACTER}</span><span class="s5">' </span><span class="s2">in </span><span class="s1">encodings</span>

    <span class="s2">def </span><span class="s1">test_detect_html5_style_meta_tag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s2">for </span><span class="s1">data </span><span class="s2">in </span><span class="s3">(</span>
            <span class="s6">b'&lt;html&gt;&lt;meta charset=&quot;euc-jp&quot; /&gt;&lt;/html&gt;'</span><span class="s3">,</span>
            <span class="s6">b&quot;&lt;html&gt;&lt;meta charset='euc-jp' /&gt;&lt;/html&gt;&quot;</span><span class="s3">,</span>
            <span class="s6">b&quot;&lt;html&gt;&lt;meta charset=euc-jp /&gt;&lt;/html&gt;&quot;</span><span class="s3">,</span>
            <span class="s6">b&quot;&lt;html&gt;&lt;meta charset=euc-jp/&gt;&lt;/html&gt;&quot;</span><span class="s3">):</span>
            <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">is_html</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s5">&quot;euc-jp&quot; </span><span class="s3">== </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span>

    <span class="s2">def </span><span class="s1">test_last_ditch_entity_replacement</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># This is a UTF-8 document that contains bytestrings</span>
        <span class="s0"># completely incompatible with UTF-8 (ie. encoded with some other</span>
        <span class="s0"># encoding).</span>
        <span class="s0">#</span>
        <span class="s0"># Since there is no consistent encoding for the document,</span>
        <span class="s0"># Unicode, Dammit will eventually encode the document as UTF-8</span>
        <span class="s0"># and encode the incompatible characters as REPLACEMENT</span>
        <span class="s0"># CHARACTER.</span>
        <span class="s0">#</span>
        <span class="s0"># If chardet is installed, it will detect that the document</span>
        <span class="s0"># can be converted into ISO-8859-1 without errors. This happens</span>
        <span class="s0"># to be the wrong encoding, but it is a consistent encoding, so the</span>
        <span class="s0"># code we're testing here won't run.</span>
        <span class="s0">#</span>
        <span class="s0"># So we temporarily disable chardet if it's present.</span>
        <span class="s1">doc </span><span class="s3">= </span><span class="s6">b&quot;&quot;&quot;</span><span class="s2">\357\273\277</span><span class="s6">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; 
&lt;html&gt;&lt;b&gt;</span><span class="s2">\330\250\330\252\330\261</span><span class="s6">&lt;/b&gt; 
&lt;i&gt;</span><span class="s2">\310\322\321\220\312\321\355\344</span><span class="s6">&lt;/i&gt;&lt;/html&gt;&quot;&quot;&quot;</span>
        <span class="s1">chardet </span><span class="s3">= </span><span class="s1">bs4</span><span class="s3">.</span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">chardet_dammit</span>
        <span class="s1">logging</span><span class="s3">.</span><span class="s1">disable</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">WARNING</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">def </span><span class="s1">noop</span><span class="s3">(</span><span class="s1">str</span><span class="s3">):</span>
                <span class="s2">return None</span>
            <span class="s1">bs4</span><span class="s3">.</span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">chardet_dammit </span><span class="s3">= </span><span class="s1">noop</span>
            <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">)</span>
            <span class="s2">assert True </span><span class="s3">== </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">contains_replacement_characters</span>
            <span class="s2">assert </span><span class="s5">&quot;</span><span class="s2">\ufffd</span><span class="s5">&quot; </span><span class="s2">in </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">unicode_markup</span>

            <span class="s1">soup </span><span class="s3">= </span><span class="s1">BeautifulSoup</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">, </span><span class="s5">&quot;html.parser&quot;</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">soup</span><span class="s3">.</span><span class="s1">contains_replacement_characters</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">logging</span><span class="s3">.</span><span class="s1">disable</span><span class="s3">(</span><span class="s1">logging</span><span class="s3">.</span><span class="s1">NOTSET</span><span class="s3">)</span>
            <span class="s1">bs4</span><span class="s3">.</span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">chardet_dammit </span><span class="s3">= </span><span class="s1">chardet</span>

    <span class="s2">def </span><span class="s1">test_byte_order_mark_removed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># A document written in UTF-16LE will have its byte order marker stripped.</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s6">b'</span><span class="s2">\xff\xfe</span><span class="s6">&lt;</span><span class="s2">\x00</span><span class="s6">a</span><span class="s2">\x00</span><span class="s6">&gt;</span><span class="s2">\x00\xe1\x00\xe9\x00</span><span class="s6">&lt;</span><span class="s2">\x00</span><span class="s6">/</span><span class="s2">\x00</span><span class="s6">a</span><span class="s2">\x00</span><span class="s6">&gt;</span><span class="s2">\x00</span><span class="s6">'</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s5">&quot;&lt;a&gt;áé&lt;/a&gt;&quot; </span><span class="s3">== </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">unicode_markup</span>
        <span class="s2">assert </span><span class="s5">&quot;utf-16le&quot; </span><span class="s3">== </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span>
       
    <span class="s2">def </span><span class="s1">test_known_definite_versus_user_encodings</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># The known_definite_encodings are used before sniffing the</span>
        <span class="s0"># byte-order mark; the user_encodings are used afterwards.</span>

        <span class="s0"># Here's a document in UTF-16LE.</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s6">b'</span><span class="s2">\xff\xfe</span><span class="s6">&lt;</span><span class="s2">\x00</span><span class="s6">a</span><span class="s2">\x00</span><span class="s6">&gt;</span><span class="s2">\x00\xe1\x00\xe9\x00</span><span class="s6">&lt;</span><span class="s2">\x00</span><span class="s6">/</span><span class="s2">\x00</span><span class="s6">a</span><span class="s2">\x00</span><span class="s6">&gt;</span><span class="s2">\x00</span><span class="s6">'</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

        <span class="s0"># We can process it as UTF-16 by passing it in as a known</span>
        <span class="s0"># definite encoding.</span>
        <span class="s1">before </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">known_definite_encodings</span><span class="s3">=[</span><span class="s5">&quot;utf-16&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s5">&quot;utf-16&quot; </span><span class="s3">== </span><span class="s1">before</span><span class="s3">.</span><span class="s1">original_encoding</span>
        
        <span class="s0"># If we pass UTF-18 as a user encoding, it's not even</span>
        <span class="s0"># tried--the encoding sniffed from the byte-order mark takes</span>
        <span class="s0"># precedence.</span>
        <span class="s1">after </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">user_encodings</span><span class="s3">=[</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s5">&quot;utf-16le&quot; </span><span class="s3">== </span><span class="s1">after</span><span class="s3">.</span><span class="s1">original_encoding</span>
        <span class="s2">assert </span><span class="s3">[</span><span class="s5">&quot;utf-16le&quot;</span><span class="s3">] == [</span><span class="s1">x</span><span class="s3">[</span><span class="s7">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">tried_encodings</span><span class="s3">]</span>
        
        <span class="s0"># Here's a document in ISO-8859-8.</span>
        <span class="s1">hebrew </span><span class="s3">= </span><span class="s6">b&quot;</span><span class="s2">\xed\xe5\xec\xf9</span><span class="s6">&quot;</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span><span class="s1">hebrew</span><span class="s3">, </span><span class="s1">known_definite_encodings</span><span class="s3">=[</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">],</span>
                               <span class="s1">user_encodings</span><span class="s3">=[</span><span class="s5">&quot;iso-8859-8&quot;</span><span class="s3">])</span>
        
        <span class="s0"># The known_definite_encodings don't work, BOM sniffing does</span>
        <span class="s0"># nothing (it only works for a few UTF encodings), but one of</span>
        <span class="s0"># the user_encodings does work.</span>
        <span class="s2">assert </span><span class="s5">&quot;iso-8859-8&quot; </span><span class="s3">== </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span>
        <span class="s2">assert </span><span class="s3">[</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s5">&quot;iso-8859-8&quot;</span><span class="s3">] == [</span><span class="s1">x</span><span class="s3">[</span><span class="s7">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">tried_encodings</span><span class="s3">]</span>
        
    <span class="s2">def </span><span class="s1">test_deprecated_override_encodings</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># override_encodings is a deprecated alias for</span>
        <span class="s0"># known_definite_encodings.</span>
        <span class="s1">hebrew </span><span class="s3">= </span><span class="s6">b&quot;</span><span class="s2">\xed\xe5\xec\xf9</span><span class="s6">&quot;</span>
        <span class="s1">dammit </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">(</span>
            <span class="s1">hebrew</span><span class="s3">,</span>
            <span class="s1">known_definite_encodings</span><span class="s3">=[</span><span class="s5">&quot;shift-jis&quot;</span><span class="s3">],</span>
            <span class="s1">override_encodings</span><span class="s3">=[</span><span class="s5">&quot;utf-8&quot;</span><span class="s3">],</span>
            <span class="s1">user_encodings</span><span class="s3">=[</span><span class="s5">&quot;iso-8859-8&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s5">&quot;iso-8859-8&quot; </span><span class="s3">== </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">original_encoding</span>

        <span class="s0"># known_definite_encodings and override_encodings were tried</span>
        <span class="s0"># before user_encodings.</span>
        <span class="s2">assert </span><span class="s3">[</span><span class="s5">&quot;shift-jis&quot;</span><span class="s3">, </span><span class="s5">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s5">&quot;iso-8859-8&quot;</span><span class="s3">] == (</span>
            <span class="s3">[</span><span class="s1">x</span><span class="s3">[</span><span class="s7">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">dammit</span><span class="s3">.</span><span class="s1">tried_encodings</span><span class="s3">]</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_detwingle</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Here's a UTF8 document.</span>
        <span class="s1">utf8 </span><span class="s3">= (</span><span class="s5">&quot;</span><span class="s2">\N{SNOWMAN}</span><span class="s5">&quot; </span><span class="s3">* </span><span class="s7">3</span><span class="s3">).</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;utf8&quot;</span><span class="s3">)</span>

        <span class="s0"># Here's a Windows-1252 document.</span>
        <span class="s1">windows_1252 </span><span class="s3">= (</span>
            <span class="s5">&quot;</span><span class="s2">\N{LEFT DOUBLE QUOTATION MARK}</span><span class="s5">Hi, I like Windows!&quot;</span>
            <span class="s5">&quot;</span><span class="s2">\N{RIGHT DOUBLE QUOTATION MARK}</span><span class="s5">&quot;</span><span class="s3">).</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;windows_1252&quot;</span><span class="s3">)</span>

        <span class="s0"># Through some unholy alchemy, they've been stuck together.</span>
        <span class="s1">doc </span><span class="s3">= </span><span class="s1">utf8 </span><span class="s3">+ </span><span class="s1">windows_1252 </span><span class="s3">+ </span><span class="s1">utf8</span>

        <span class="s0"># The document can't be turned into UTF-8:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">UnicodeDecodeError</span><span class="s3">):</span>
            <span class="s1">doc</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s5">&quot;utf8&quot;</span><span class="s3">)</span>

        <span class="s0"># Unicode, Dammit thinks the whole document is Windows-1252,</span>
        <span class="s0"># and decodes it into &quot;â˜ƒâ˜ƒâ˜ƒ“Hi, I like Windows!”â˜ƒâ˜ƒâ˜ƒ&quot;</span>

        <span class="s0"># But if we run it through fix_embedded_windows_1252, it's fixed:</span>
        <span class="s1">fixed </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">.</span><span class="s1">detwingle</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s5">&quot;☃☃☃“Hi, I like Windows!”☃☃☃&quot; </span><span class="s3">== </span><span class="s1">fixed</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s5">&quot;utf8&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_detwingle_ignores_multibyte_characters</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Each of these characters has a UTF-8 representation ending</span>
        <span class="s0"># in \x93. \x93 is a smart quote if interpreted as</span>
        <span class="s0"># Windows-1252. But our code knows to skip over multibyte</span>
        <span class="s0"># UTF-8 characters, so they'll survive the process unscathed.</span>
        <span class="s2">for </span><span class="s1">tricky_unicode_char </span><span class="s2">in </span><span class="s3">(</span>
            <span class="s5">&quot;</span><span class="s2">\N{LATIN SMALL LIGATURE OE}</span><span class="s5">&quot;</span><span class="s3">, </span><span class="s0"># 2-byte char '\xc5\x93'</span>
            <span class="s5">&quot;</span><span class="s2">\N{LATIN SUBSCRIPT SMALL LETTER X}</span><span class="s5">&quot;</span><span class="s3">, </span><span class="s0"># 3-byte char '\xe2\x82\x93'</span>
            <span class="s5">&quot;</span><span class="s2">\xf0\x90\x90\x93</span><span class="s5">&quot;</span><span class="s3">, </span><span class="s0"># This is a CJK character, not sure which one.</span>
            <span class="s3">):</span>
            <span class="s1">input </span><span class="s3">= </span><span class="s1">tricky_unicode_char</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;utf8&quot;</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">input</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s6">b'</span><span class="s2">\x93</span><span class="s6">'</span><span class="s3">)</span>
            <span class="s1">output </span><span class="s3">= </span><span class="s1">UnicodeDammit</span><span class="s3">.</span><span class="s1">detwingle</span><span class="s3">(</span><span class="s1">input</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">output </span><span class="s3">== </span><span class="s1">input</span>

    <span class="s2">def </span><span class="s1">test_find_declared_encoding</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test our ability to find a declared encoding inside an</span>
        <span class="s0"># XML or HTML document.</span>
        <span class="s0">#</span>
        <span class="s0"># Even if the document comes in as Unicode, it may be</span>
        <span class="s0"># interesting to know what encoding was claimed</span>
        <span class="s0"># originally.</span>

        <span class="s1">html_unicode </span><span class="s3">= </span><span class="s5">'&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;/head&gt;&lt;/html&gt;'</span>
        <span class="s1">html_bytes </span><span class="s3">= </span><span class="s1">html_unicode</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;ascii&quot;</span><span class="s3">)</span>

        <span class="s1">xml_unicode</span><span class="s3">= </span><span class="s5">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot; ?&gt;'</span>
        <span class="s1">xml_bytes </span><span class="s3">= </span><span class="s1">xml_unicode</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;ascii&quot;</span><span class="s3">)</span>

        <span class="s1">m </span><span class="s3">= </span><span class="s1">EncodingDetector</span><span class="s3">.</span><span class="s1">find_declared_encoding</span>
        <span class="s2">assert </span><span class="s1">m</span><span class="s3">(</span><span class="s1">html_unicode</span><span class="s3">, </span><span class="s1">is_html</span><span class="s3">=</span><span class="s2">False</span><span class="s3">) </span><span class="s2">is None</span>
        <span class="s2">assert </span><span class="s5">&quot;utf-8&quot; </span><span class="s3">== </span><span class="s1">m</span><span class="s3">(</span><span class="s1">html_unicode</span><span class="s3">, </span><span class="s1">is_html</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s5">&quot;utf-8&quot; </span><span class="s3">== </span><span class="s1">m</span><span class="s3">(</span><span class="s1">html_bytes</span><span class="s3">, </span><span class="s1">is_html</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s5">&quot;iso-8859-1&quot; </span><span class="s3">== </span><span class="s1">m</span><span class="s3">(</span><span class="s1">xml_unicode</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s5">&quot;iso-8859-1&quot; </span><span class="s3">== </span><span class="s1">m</span><span class="s3">(</span><span class="s1">xml_bytes</span><span class="s3">)</span>

        <span class="s0"># Normally, only the first few kilobytes of a document are checked for</span>
        <span class="s0"># an encoding.</span>
        <span class="s1">spacer </span><span class="s3">= </span><span class="s6">b' ' </span><span class="s3">* </span><span class="s7">5000</span>
        <span class="s2">assert </span><span class="s1">m</span><span class="s3">(</span><span class="s1">spacer </span><span class="s3">+ </span><span class="s1">html_bytes</span><span class="s3">) </span><span class="s2">is None</span>
        <span class="s2">assert </span><span class="s1">m</span><span class="s3">(</span><span class="s1">spacer </span><span class="s3">+ </span><span class="s1">xml_bytes</span><span class="s3">) </span><span class="s2">is None</span>

        <span class="s0"># But you can tell find_declared_encoding to search an entire</span>
        <span class="s0"># HTML document.</span>
        <span class="s2">assert </span><span class="s3">(</span>
            <span class="s1">m</span><span class="s3">(</span><span class="s1">spacer </span><span class="s3">+ </span><span class="s1">html_bytes</span><span class="s3">, </span><span class="s1">is_html</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">search_entire_document</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s3">== </span><span class="s5">&quot;utf-8&quot;</span>
        <span class="s3">)</span>

        <span class="s0"># The XML encoding declaration has to be the very first thing</span>
        <span class="s0"># in the document. We'll allow whitespace before the document</span>
        <span class="s0"># starts, but nothing else.</span>
        <span class="s2">assert </span><span class="s1">m</span><span class="s3">(</span><span class="s1">xml_bytes</span><span class="s3">, </span><span class="s1">search_entire_document</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) == </span><span class="s5">&quot;iso-8859-1&quot;</span>
        <span class="s2">assert </span><span class="s1">m</span><span class="s3">(</span><span class="s6">b' ' </span><span class="s3">+ </span><span class="s1">xml_bytes</span><span class="s3">, </span><span class="s1">search_entire_document</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) == </span><span class="s5">&quot;iso-8859-1&quot;</span>
        <span class="s2">assert </span><span class="s1">m</span><span class="s3">(</span><span class="s6">b'a' </span><span class="s3">+ </span><span class="s1">xml_bytes</span><span class="s3">, </span><span class="s1">search_entire_document</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">is None</span>


<span class="s2">class </span><span class="s1">TestEntitySubstitution</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
    <span class="s4">&quot;&quot;&quot;Standalone tests of the EntitySubstitution class.&quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sub </span><span class="s3">= </span><span class="s1">EntitySubstitution</span>


    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s5">&quot;original,substituted&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s0"># Basic case. Unicode characters corresponding to named</span>
            <span class="s0"># HTML entites are substituted; others are not.</span>
            <span class="s3">(</span><span class="s5">&quot;foo</span><span class="s2">\u2200\N{SNOWMAN}\u00f5</span><span class="s5">bar&quot;</span><span class="s3">,</span>
             <span class="s5">&quot;foo&amp;forall;</span><span class="s2">\N{SNOWMAN}</span><span class="s5">&amp;otilde;bar&quot;</span><span class="s3">),</span>

            <span class="s0"># MS smart quotes are a common source of frustration, so we</span>
            <span class="s0"># give them a special test.</span>
            <span class="s3">(</span><span class="s5">'‘’foo“”'</span><span class="s3">, </span><span class="s5">&quot;&amp;lsquo;&amp;rsquo;foo&amp;ldquo;&amp;rdquo;&quot;</span><span class="s3">),           </span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_substitute_html</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">original</span><span class="s3">, </span><span class="s1">substituted</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_html</span><span class="s3">(</span><span class="s1">original</span><span class="s3">) == </span><span class="s1">substituted</span>
        
    <span class="s2">def </span><span class="s1">test_html5_entity</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">entity</span><span class="s3">, </span><span class="s1">u </span><span class="s2">in </span><span class="s3">(</span>
            <span class="s0"># A few spot checks of our ability to recognize</span>
            <span class="s0"># special character sequences and convert them</span>
            <span class="s0"># to named entities.</span>
            <span class="s3">(</span><span class="s5">'&amp;models;'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\u22a7</span><span class="s5">'</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">'&amp;Nfr;'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\U0001d511</span><span class="s5">'</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">'&amp;ngeqq;'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\u2267\u0338</span><span class="s5">'</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">'&amp;not;'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\xac</span><span class="s5">'</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">'&amp;Not;'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\u2aec</span><span class="s5">'</span><span class="s3">),</span>
                
            <span class="s0"># We _could_ convert | to &amp;verbarr;, but we don't, because</span>
            <span class="s0"># | is an ASCII character.</span>
            <span class="s3">(</span><span class="s5">'|' '|'</span><span class="s3">),</span>

            <span class="s0"># Similarly for the fj ligature, which we could convert to</span>
            <span class="s0"># &amp;fjlig;, but we don't.</span>
            <span class="s3">(</span><span class="s5">&quot;fj&quot;</span><span class="s3">, </span><span class="s5">&quot;fj&quot;</span><span class="s3">),</span>

            <span class="s0"># We do convert _these_ ASCII characters to HTML entities,</span>
            <span class="s0"># because that's required to generate valid HTML.</span>
            <span class="s3">(</span><span class="s5">'&amp;gt;'</span><span class="s3">, </span><span class="s5">'&gt;'</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">'&amp;lt;'</span><span class="s3">, </span><span class="s5">'&lt;'</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">'&amp;amp;'</span><span class="s3">, </span><span class="s5">'&amp;'</span><span class="s3">),</span>
        <span class="s3">):</span>
            <span class="s1">template </span><span class="s3">= </span><span class="s5">'3 %s 4'</span>
            <span class="s1">raw </span><span class="s3">= </span><span class="s1">template </span><span class="s3">% </span><span class="s1">u</span>
            <span class="s1">with_entities </span><span class="s3">= </span><span class="s1">template </span><span class="s3">% </span><span class="s1">entity</span>
            <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_html</span><span class="s3">(</span><span class="s1">raw</span><span class="s3">) == </span><span class="s1">with_entities</span>
            
    <span class="s2">def </span><span class="s1">test_html5_entity_with_variation_selector</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Some HTML5 entities correspond either to a single-character</span>
        <span class="s0"># Unicode sequence _or_ to the same character plus U+FE00,</span>
        <span class="s0"># VARIATION SELECTOR 1. We can handle this.</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s5">&quot;fjords </span><span class="s2">\u2294 </span><span class="s5">penguins&quot;</span>
        <span class="s1">markup </span><span class="s3">= </span><span class="s5">&quot;fjords &amp;sqcup; penguins&quot;</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_html</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) == </span><span class="s1">markup</span>

        <span class="s1">data </span><span class="s3">= </span><span class="s5">&quot;fjords </span><span class="s2">\u2294\ufe00 </span><span class="s5">penguins&quot;</span>
        <span class="s1">markup </span><span class="s3">= </span><span class="s5">&quot;fjords &amp;sqcups; penguins&quot;</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_html</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) == </span><span class="s1">markup</span>
        
    <span class="s2">def </span><span class="s1">test_xml_converstion_includes_no_quotes_if_make_quoted_attribute_is_false</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s5">'Welcome to &quot;my bar&quot;'</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s2">False</span><span class="s3">) == </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">test_xml_attribute_quoting_normally_uses_double_quotes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s5">&quot;Welcome&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">) == </span><span class="s5">'&quot;Welcome&quot;'</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s5">&quot;Bob's Bar&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">) == </span><span class="s5">'&quot;Bob</span><span class="s2">\'</span><span class="s5">s Bar&quot;'</span>

    <span class="s2">def </span><span class="s1">test_xml_attribute_quoting_uses_single_quotes_when_value_contains_double_quotes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s5">'Welcome to &quot;my bar&quot;'</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s2">True</span><span class="s3">) == </span><span class="s5">&quot;'Welcome to </span><span class="s2">\&quot;</span><span class="s5">my bar</span><span class="s2">\&quot;</span><span class="s5">'&quot;</span>

    <span class="s2">def </span><span class="s1">test_xml_attribute_quoting_escapes_single_quotes_when_value_contains_both_single_and_double_quotes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s5">'Welcome to &quot;Bob</span><span class="s2">\'</span><span class="s5">s Bar&quot;'</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s2">True</span><span class="s3">) == </span><span class="s5">'&quot;Welcome to &amp;quot;Bob</span><span class="s2">\'</span><span class="s5">s Bar&amp;quot;&quot;'</span>

    <span class="s2">def </span><span class="s1">test_xml_quotes_arent_escaped_when_value_is_not_being_quoted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">quoted </span><span class="s3">= </span><span class="s5">'Welcome to &quot;Bob</span><span class="s2">\'</span><span class="s5">s Bar&quot;'</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s1">quoted</span><span class="s3">) == </span><span class="s1">quoted</span>

    <span class="s2">def </span><span class="s1">test_xml_quoting_handles_angle_brackets</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s5">&quot;foo&lt;bar&gt;&quot;</span><span class="s3">) == </span><span class="s5">&quot;foo&amp;lt;bar&amp;gt;&quot;</span>

    <span class="s2">def </span><span class="s1">test_xml_quoting_handles_ampersands</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s5">&quot;AT&amp;T&quot;</span><span class="s3">) == </span><span class="s5">&quot;AT&amp;amp;T&quot;</span>

    <span class="s2">def </span><span class="s1">test_xml_quoting_including_ampersands_when_they_are_part_of_an_entity</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml</span><span class="s3">(</span><span class="s5">&quot;&amp;Aacute;T&amp;T&quot;</span><span class="s3">) == </span><span class="s5">&quot;&amp;amp;Aacute;T&amp;amp;T&quot;</span>

    <span class="s2">def </span><span class="s1">test_xml_quoting_ignoring_ampersands_when_they_are_part_of_an_entity</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_xml_containing_entities</span><span class="s3">(</span><span class="s5">&quot;&amp;Aacute;T&amp;T&quot;</span><span class="s3">) == </span><span class="s5">&quot;&amp;Aacute;T&amp;amp;T&quot;</span>
       
    <span class="s2">def </span><span class="s1">test_quotes_not_html_substituted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4">&quot;&quot;&quot;There's no need to do this except inside attribute values.&quot;&quot;&quot;</span>
        <span class="s1">text </span><span class="s3">= </span><span class="s5">'Bob</span><span class="s2">\'</span><span class="s5">s &quot;bar&quot;'</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">.</span><span class="s1">substitute_html</span><span class="s3">(</span><span class="s1">text</span><span class="s3">) == </span><span class="s1">text</span>
</pre>
</body>
</html>