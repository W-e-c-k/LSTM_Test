<html>
<head>
<title>convnext.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
convnext.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src </span><span class="s0">import </span><span class="s1">backend</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src </span><span class="s0">import </span><span class="s1">initializers</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src </span><span class="s0">import </span><span class="s1">layers</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src </span><span class="s0">import </span><span class="s1">ops</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src </span><span class="s0">import </span><span class="s1">random</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">api_export </span><span class="s0">import </span><span class="s1">keras_export</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">applications </span><span class="s0">import </span><span class="s1">imagenet_utils</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">layers</span><span class="s2">.</span><span class="s1">layer </span><span class="s0">import </span><span class="s1">Layer</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">Functional</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">Sequential</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">ops </span><span class="s0">import </span><span class="s1">operation_utils</span>
<span class="s0">from </span><span class="s1">keras</span><span class="s2">.</span><span class="s1">src</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">file_utils</span>

<span class="s1">BASE_WEIGHTS_PATH </span><span class="s2">= (</span>
    <span class="s3">&quot;https://storage.googleapis.com/tensorflow/keras-applications/convnext/&quot;</span>
<span class="s2">)</span>

<span class="s1">WEIGHTS_HASHES </span><span class="s2">= {</span>
    <span class="s3">&quot;convnext_tiny&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;8ae6e78ce2933352b1ef4008e6dd2f17bc40771563877d156bc6426c7cf503ff&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;d547c096cabd03329d7be5562c5e14798aa39ed24b474157cef5e85ab9e49ef1&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;convnext_small&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;ce1277d8f1ee5a0ef0e171469089c18f5233860ceaf9b168049cb9263fd7483c&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;6fc8009faa2f00c1c1dfce59feea9b0745eb260a7dd11bee65c8e20843da6eab&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;convnext_base&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;52cbb006d3dadd03f6e095a8ca1aca47aecdd75acb4bc74bce1f5c695d0086e6&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;40a20c5548a5e9202f69735ecc06c990e6b7c9d2de39f0361e27baeb24cb7c45&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;convnext_large&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;070c5ed9ed289581e477741d3b34beffa920db8cf590899d6d2c67fba2a198a6&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;96f02b6f0753d4f543261bc9d09bed650f24dd6bc02ddde3066135b63d23a1cd&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s3">&quot;convnext_xlarge&quot;</span><span class="s2">: (</span>
        <span class="s3">&quot;c1f5ccab661354fc3a79a10fa99af82f0fbf10ec65cb894a3ae0815f17a889ee&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;de3f8a54174130e0cecdc71583354753d557fcf1f4487331558e2a16ba0cfe05&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
<span class="s2">}</span>


<span class="s1">MODEL_CONFIGS </span><span class="s2">= {</span>
    <span class="s3">&quot;tiny&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;depths&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s3">&quot;projection_dims&quot;</span><span class="s2">: [</span><span class="s4">96</span><span class="s2">, </span><span class="s4">192</span><span class="s2">, </span><span class="s4">384</span><span class="s2">, </span><span class="s4">768</span><span class="s2">],</span>
        <span class="s3">&quot;default_size&quot;</span><span class="s2">: </span><span class="s4">224</span><span class="s2">,</span>
    <span class="s2">},</span>
    <span class="s3">&quot;small&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;depths&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">27</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s3">&quot;projection_dims&quot;</span><span class="s2">: [</span><span class="s4">96</span><span class="s2">, </span><span class="s4">192</span><span class="s2">, </span><span class="s4">384</span><span class="s2">, </span><span class="s4">768</span><span class="s2">],</span>
        <span class="s3">&quot;default_size&quot;</span><span class="s2">: </span><span class="s4">224</span><span class="s2">,</span>
    <span class="s2">},</span>
    <span class="s3">&quot;base&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;depths&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">27</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s3">&quot;projection_dims&quot;</span><span class="s2">: [</span><span class="s4">128</span><span class="s2">, </span><span class="s4">256</span><span class="s2">, </span><span class="s4">512</span><span class="s2">, </span><span class="s4">1024</span><span class="s2">],</span>
        <span class="s3">&quot;default_size&quot;</span><span class="s2">: </span><span class="s4">224</span><span class="s2">,</span>
    <span class="s2">},</span>
    <span class="s3">&quot;large&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;depths&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">27</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s3">&quot;projection_dims&quot;</span><span class="s2">: [</span><span class="s4">192</span><span class="s2">, </span><span class="s4">384</span><span class="s2">, </span><span class="s4">768</span><span class="s2">, </span><span class="s4">1536</span><span class="s2">],</span>
        <span class="s3">&quot;default_size&quot;</span><span class="s2">: </span><span class="s4">224</span><span class="s2">,</span>
    <span class="s2">},</span>
    <span class="s3">&quot;xlarge&quot;</span><span class="s2">: {</span>
        <span class="s3">&quot;depths&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">27</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s3">&quot;projection_dims&quot;</span><span class="s2">: [</span><span class="s4">256</span><span class="s2">, </span><span class="s4">512</span><span class="s2">, </span><span class="s4">1024</span><span class="s2">, </span><span class="s4">2048</span><span class="s2">],</span>
        <span class="s3">&quot;default_size&quot;</span><span class="s2">: </span><span class="s4">224</span><span class="s2">,</span>
    <span class="s2">},</span>
<span class="s2">}</span>

<span class="s1">BASE_DOCSTRING </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;Instantiates the {name} architecture. 
 
References: 
- [A ConvNet for the 2020s](https://arxiv.org/abs/2201.03545) 
(CVPR 2022) 
 
For image classification use cases, see 
[this page for detailed examples]( 
https://keras.io/api/applications/#usage-examples-for-image-classification-models). 
For transfer learning use cases, make sure to read the 
[guide to transfer learning &amp; fine-tuning]( 
https://keras.io/guides/transfer_learning/). 
 
The `base`, `large`, and `xlarge` models were first pre-trained on the 
ImageNet-21k dataset and then fine-tuned on the ImageNet-1k dataset. The 
pre-trained parameters of the models were assembled from the 
[official repository](https://github.com/facebookresearch/ConvNeXt). To get a 
sense of how these parameters were converted to Keras compatible parameters, 
please refer to 
[this repository](https://github.com/sayakpaul/keras-convnext-conversion). 
 
Note: Each Keras Application expects a specific kind of input preprocessing. 
For ConvNeXt, preprocessing is included in the model using a `Normalization` 
layer.  ConvNeXt models expect their inputs to be float or uint8 tensors of 
pixels with values in the [0-255] range. 
 
When calling the `summary()` method after instantiating a ConvNeXt model, 
prefer setting the `expand_nested` argument `summary()` to `True` to better 
investigate the instantiated model. 
 
Args: 
    include_top: Whether to include the fully-connected 
        layer at the top of the network. Defaults to `True`. 
    weights: One of `None` (random initialization), 
        `&quot;imagenet&quot;` (pre-training on ImageNet-1k), or the path to the weights 
        file to be loaded. Defaults to `&quot;imagenet&quot;`. 
    input_tensor: Optional Keras tensor 
        (i.e. output of `layers.Input()`) 
        to use as image input for the model. 
    input_shape: Optional shape tuple, only to be specified 
        if `include_top` is `False`. 
        It should have exactly 3 inputs channels. 
    pooling: Optional pooling mode for feature extraction 
        when `include_top` is `False`. Defaults to None. 
        - `None` means that the output of the model will be 
        the 4D tensor output of the last convolutional layer. 
        - `avg` means that global average pooling 
        will be applied to the output of the 
        last convolutional layer, and thus 
        the output of the model will be a 2D tensor. 
        - `max` means that global max pooling will 
        be applied. 
    classes: Optional number of classes to classify images 
        into, only to be specified if `include_top` is `True`, and 
        if no `weights` argument is specified. Defaults to 1000 (number of 
        ImageNet classes). 
    classifier_activation: A `str` or callable. The activation function to use 
        on the &quot;top&quot; layer. Ignored unless `include_top=True`. Set 
        `classifier_activation=None` to return the logits of the &quot;top&quot; layer. 
        Defaults to `&quot;softmax&quot;`. 
        When loading pretrained weights, `classifier_activation` can only 
        be `None` or `&quot;softmax&quot;`. 
    name: The name of the model (string). 
 
Returns: 
    A model instance. 
&quot;&quot;&quot;</span>


<span class="s0">class </span><span class="s1">StochasticDepth</span><span class="s2">(</span><span class="s1">Layer</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Stochastic Depth module. 
 
    It performs batch-wise dropping rather than sample-wise. In libraries like 
    `timm`, it's similar to `DropPath` layers that drops residual paths 
    sample-wise. 
 
    References: 
    - https://github.com/rwightman/pytorch-image-models 
 
    Args: 
      drop_path_rate (float): Probability of dropping paths. Should be within 
        [0, 1]. 
 
    Returns: 
      Tensor either with the residual path dropped or kept. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">drop_path_rate</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">drop_path_rate </span><span class="s2">= </span><span class="s1">drop_path_rate</span>

    <span class="s0">def </span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">training</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">training</span><span class="s2">:</span>
            <span class="s1">keep_prob </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">drop_path_rate</span>
            <span class="s1">shape </span><span class="s2">= (</span><span class="s1">ops</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">],) + (</span><span class="s4">1</span><span class="s2">,) * (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)) - </span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">random_tensor </span><span class="s2">= </span><span class="s1">keep_prob </span><span class="s2">+ </span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">random_tensor </span><span class="s2">= </span><span class="s1">ops</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">random_tensor</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">x </span><span class="s2">/ </span><span class="s1">keep_prob</span><span class="s2">) * </span><span class="s1">random_tensor</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s0">def </span><span class="s1">get_config</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">get_config</span><span class="s2">()</span>
        <span class="s1">config</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span><span class="s3">&quot;drop_path_rate&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">drop_path_rate</span><span class="s2">})</span>
        <span class="s0">return </span><span class="s1">config</span>


<span class="s0">class </span><span class="s1">LayerScale</span><span class="s2">(</span><span class="s1">Layer</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Layer scale module. 
 
    References: 
 
    - https://arxiv.org/abs/2103.17239 
 
    Args: 
        init_values (float): Initial value for layer scale. Should be within 
            [0, 1]. 
        projection_dim (int): Projection dimensionality. 
 
    Returns: 
        Tensor multiplied to the scale. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">init_values</span><span class="s2">, </span><span class="s1">projection_dim</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">init_values </span><span class="s2">= </span><span class="s1">init_values</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">projection_dim </span><span class="s2">= </span><span class="s1">projection_dim</span>

    <span class="s0">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">gamma </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">add_weight</span><span class="s2">(</span>
            <span class="s1">shape</span><span class="s2">=(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">projection_dim</span><span class="s2">,),</span>
            <span class="s1">initializer</span><span class="s2">=</span><span class="s1">initializers</span><span class="s2">.</span><span class="s1">Constant</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">init_values</span><span class="s2">),</span>
            <span class="s1">trainable</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">gamma</span>

    <span class="s0">def </span><span class="s1">get_config</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">config </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">get_config</span><span class="s2">()</span>
        <span class="s1">config</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;init_values&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">init_values</span><span class="s2">,</span>
                <span class="s3">&quot;projection_dim&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">projection_dim</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">config</span>


<span class="s0">def </span><span class="s1">ConvNeXtBlock</span><span class="s2">(</span>
    <span class="s1">projection_dim</span><span class="s2">, </span><span class="s1">drop_path_rate</span><span class="s2">=</span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">layer_scale_init_value</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;ConvNeXt block. 
 
    References: 
    - https://arxiv.org/abs/2201.03545 
    - https://github.com/facebookresearch/ConvNeXt/blob/main/models/convnext.py 
 
    Notes: 
        In the original ConvNeXt implementation (linked above), the authors use 
        `Dense` layers for pointwise convolutions for increased efficiency. 
        Following that, this implementation also uses the same. 
 
    Args: 
        projection_dim (int): Number of filters for convolution layers. In the 
            ConvNeXt paper, this is referred to as projection dimension. 
        drop_path_rate (float): Probability of dropping paths. Should be within 
            [0, 1]. 
        layer_scale_init_value (float): Layer scale value. 
            Should be a small float number. 
        name: name to path to the keras layer. 
 
    Returns: 
        A function representing a ConvNeXtBlock block. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">name </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;prestem&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">.</span><span class="s1">get_uid</span><span class="s2">(</span><span class="s3">&quot;prestem&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">apply</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">inputs</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
            <span class="s1">filters</span><span class="s2">=</span><span class="s1">projection_dim</span><span class="s2">,</span>
            <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">7</span><span class="s2">,</span>
            <span class="s1">padding</span><span class="s2">=</span><span class="s3">&quot;same&quot;</span><span class="s2">,</span>
            <span class="s1">groups</span><span class="s2">=</span><span class="s1">projection_dim</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_depthwise_conv&quot;</span><span class="s2">,</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">LayerNormalization</span><span class="s2">(</span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_layernorm&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Dense</span><span class="s2">(</span><span class="s4">4 </span><span class="s2">* </span><span class="s1">projection_dim</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_pointwise_conv_1&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Activation</span><span class="s2">(</span><span class="s3">&quot;gelu&quot;</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_gelu&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Dense</span><span class="s2">(</span><span class="s1">projection_dim</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_pointwise_conv_2&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">layer_scale_init_value </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">LayerScale</span><span class="s2">(</span>
                <span class="s1">layer_scale_init_value</span><span class="s2">,</span>
                <span class="s1">projection_dim</span><span class="s2">,</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_layer_scale&quot;</span><span class="s2">,</span>
            <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">drop_path_rate</span><span class="s2">:</span>
            <span class="s1">layer </span><span class="s2">= </span><span class="s1">StochasticDepth</span><span class="s2">(</span>
                <span class="s1">drop_path_rate</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_stochastic_depth&quot;</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">layer </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Activation</span><span class="s2">(</span><span class="s3">&quot;linear&quot;</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_identity&quot;</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">inputs </span><span class="s2">+ </span><span class="s1">layer</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">apply</span>


<span class="s0">def </span><span class="s1">PreStem</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Normalizes inputs with ImageNet-1k mean and std.&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">name </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;prestem&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">.</span><span class="s1">get_uid</span><span class="s2">(</span><span class="s3">&quot;prestem&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">apply</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Normalization</span><span class="s2">(</span>
            <span class="s1">mean</span><span class="s2">=[</span><span class="s4">0.485 </span><span class="s2">* </span><span class="s4">255</span><span class="s2">, </span><span class="s4">0.456 </span><span class="s2">* </span><span class="s4">255</span><span class="s2">, </span><span class="s4">0.406 </span><span class="s2">* </span><span class="s4">255</span><span class="s2">],</span>
            <span class="s1">variance</span><span class="s2">=[</span>
                <span class="s2">(</span><span class="s4">0.229 </span><span class="s2">* </span><span class="s4">255</span><span class="s2">) ** </span><span class="s4">2</span><span class="s2">,</span>
                <span class="s2">(</span><span class="s4">0.224 </span><span class="s2">* </span><span class="s4">255</span><span class="s2">) ** </span><span class="s4">2</span><span class="s2">,</span>
                <span class="s2">(</span><span class="s4">0.225 </span><span class="s2">* </span><span class="s4">255</span><span class="s2">) ** </span><span class="s4">2</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_prestem_normalization&quot;</span><span class="s2">,</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s0">return </span><span class="s1">apply</span>


<span class="s0">def </span><span class="s1">Head</span><span class="s2">(</span><span class="s1">num_classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">, </span><span class="s1">classifier_activation</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Implementation of classification head of ConvNeXt. 
 
    Args: 
        num_classes: number of classes for Dense layer 
        classifier_activation: activation function for the Dense layer 
        name: name prefix 
 
    Returns: 
        Classification head function. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">name </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">.</span><span class="s1">get_uid</span><span class="s2">(</span><span class="s3">&quot;head&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">apply</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">GlobalAveragePooling2D</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_head_gap&quot;</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">LayerNormalization</span><span class="s2">(</span>
            <span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_head_layernorm&quot;</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Dense</span><span class="s2">(</span>
            <span class="s1">num_classes</span><span class="s2">,</span>
            <span class="s1">activation</span><span class="s2">=</span><span class="s1">classifier_activation</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_head_dense&quot;</span><span class="s2">,</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s0">return </span><span class="s1">apply</span>


<span class="s0">def </span><span class="s1">ConvNeXt</span><span class="s2">(</span>
    <span class="s1">depths</span><span class="s2">,</span>
    <span class="s1">projection_dims</span><span class="s2">,</span>
    <span class="s1">drop_path_rate</span><span class="s2">=</span><span class="s4">0.0</span><span class="s2">,</span>
    <span class="s1">layer_scale_init_value</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">,</span>
    <span class="s1">default_size</span><span class="s2">=</span><span class="s4">224</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;convnext&quot;</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">weights_name</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Instantiates ConvNeXt architecture given specific configuration. 
 
    Args: 
        depths: An iterable containing depths for each individual stages. 
        projection_dims: An iterable containing output number of channels of 
        each individual stages. 
        drop_path_rate: Stochastic depth probability. If 0.0, then stochastic 
            depth won't be used. 
        layer_scale_init_value: Layer scale coefficient. If 0.0, layer scaling 
            won't be used. 
        default_size: Default input image size. 
        name: An optional name for the model. 
        include_preprocessing: boolean denoting whther to 
            include preprocessing in the model. 
            When `weights=&quot;imagenet&quot;` this should always be `True`. 
            But for other models (e.g., randomly initialized) you should set it 
            to `False` and apply preprocessing to data accordingly. 
        include_top: Boolean denoting whether to include classification 
            head to the model. 
        weights: one of `None` (random initialization), `&quot;imagenet&quot;` 
            (pre-training on ImageNet-1k), 
            or the path to the weights file to be loaded. 
        input_tensor: optional Keras tensor (i.e. output of `layers.Input()`) to 
            use as image input for the model. 
        input_shape: optional shape tuple, only to be specified if `include_top` 
            is `False`. It should have exactly 3 inputs channels. 
        pooling: optional pooling mode for feature extraction when `include_top` 
            is `False`. 
            - `None` means that the output of the model will be 
                the 4D tensor output of the last convolutional layer. 
            - `avg` means that global average pooling will be applied 
                to the output of the last convolutional layer, 
                and thus the output of the model will be a 2D tensor. 
            - `max` means that global max pooling will be applied. 
        classes: optional number of classes to classify images into, 
            only to be specified if `include_top` is `True`, 
            and if no `weights` argument is specified. 
        classifier_activation: A `str` or callable. 
            The activation function to use 
            on the &quot;top&quot; layer. Ignored unless `include_top=True`. 
            Set `classifier_activation=None` to return the logits 
            of the &quot;top&quot; layer. 
 
    Returns: 
        A model instance. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">() == </span><span class="s3">&quot;channels_first&quot;</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s3">&quot;ConvNeXt does not support the `channels_first` image data &quot;</span>
            <span class="s3">&quot;format. Switch to `channels_last` by editing your local &quot;</span>
            <span class="s3">&quot;config file at ~/.keras/keras.json&quot;</span>
        <span class="s2">)</span>
    <span class="s0">if not </span><span class="s2">(</span><span class="s1">weights </span><span class="s0">in </span><span class="s2">{</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">} </span><span class="s0">or </span><span class="s1">file_utils</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">)):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s3">&quot;The `weights` argument should be either &quot;</span>
            <span class="s3">&quot;`None` (random initialization), `imagenet` &quot;</span>
            <span class="s3">&quot;(pre-training on ImageNet), &quot;</span>
            <span class="s3">&quot;or the path to the weights file to be loaded.&quot;</span>
        <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">weights </span><span class="s2">== </span><span class="s3">&quot;imagenet&quot; </span><span class="s0">and </span><span class="s1">include_top </span><span class="s0">and </span><span class="s1">classes </span><span class="s2">!= </span><span class="s4">1000</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s3">'If using `weights=&quot;imagenet&quot;` with `include_top=True`, '</span>
            <span class="s3">&quot;`classes` should be 1000. &quot;</span>
            <span class="s3">f&quot;Received classes=</span><span class="s0">{</span><span class="s1">classes</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s2">)</span>

    <span class="s6"># Determine proper input shape.</span>
    <span class="s1">input_shape </span><span class="s2">= </span><span class="s1">imagenet_utils</span><span class="s2">.</span><span class="s1">obtain_input_shape</span><span class="s2">(</span>
        <span class="s1">input_shape</span><span class="s2">,</span>
        <span class="s1">default_size</span><span class="s2">=</span><span class="s1">default_size</span><span class="s2">,</span>
        <span class="s1">min_size</span><span class="s2">=</span><span class="s4">32</span><span class="s2">,</span>
        <span class="s1">data_format</span><span class="s2">=</span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">(),</span>
        <span class="s1">require_flatten</span><span class="s2">=</span><span class="s1">include_top</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">input_tensor </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">img_input </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Input</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">is_keras_tensor</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">):</span>
            <span class="s1">img_input </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">Input</span><span class="s2">(</span><span class="s1">tensor</span><span class="s2">=</span><span class="s1">input_tensor</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">img_input </span><span class="s2">= </span><span class="s1">input_tensor</span>

    <span class="s0">if </span><span class="s1">input_tensor </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">inputs </span><span class="s2">= </span><span class="s1">operation_utils</span><span class="s2">.</span><span class="s1">get_source_inputs</span><span class="s2">(</span><span class="s1">input_tensor</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">inputs </span><span class="s2">= </span><span class="s1">img_input</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">inputs</span>
    <span class="s0">if </span><span class="s1">include_preprocessing</span><span class="s2">:</span>
        <span class="s1">channel_axis </span><span class="s2">= (</span>
            <span class="s4">3 </span><span class="s0">if </span><span class="s1">backend</span><span class="s2">.</span><span class="s1">image_data_format</span><span class="s2">() == </span><span class="s3">&quot;channels_last&quot; </span><span class="s0">else </span><span class="s4">1</span>
        <span class="s2">)</span>
        <span class="s1">num_channels </span><span class="s2">= </span><span class="s1">input_shape</span><span class="s2">[</span><span class="s1">channel_axis </span><span class="s2">- </span><span class="s4">1</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">num_channels </span><span class="s2">== </span><span class="s4">3</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">PreStem</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s6"># Stem block.</span>
    <span class="s1">stem </span><span class="s2">= </span><span class="s1">Sequential</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
                <span class="s1">projection_dims</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],</span>
                <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">4</span><span class="s2">,</span>
                <span class="s1">strides</span><span class="s2">=</span><span class="s4">4</span><span class="s2">,</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_stem_conv&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
            <span class="s1">layers</span><span class="s2">.</span><span class="s1">LayerNormalization</span><span class="s2">(</span>
                <span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_stem_layernorm&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_stem&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s6"># Downsampling blocks.</span>
    <span class="s1">downsample_layers </span><span class="s2">= []</span>
    <span class="s1">downsample_layers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stem</span><span class="s2">)</span>

    <span class="s1">num_downsample_layers </span><span class="s2">= </span><span class="s4">3</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num_downsample_layers</span><span class="s2">):</span>
        <span class="s1">downsample_layer </span><span class="s2">= </span><span class="s1">Sequential</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">layers</span><span class="s2">.</span><span class="s1">LayerNormalization</span><span class="s2">(</span>
                    <span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">,</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_downsampling_layernorm_&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                <span class="s2">),</span>
                <span class="s1">layers</span><span class="s2">.</span><span class="s1">Conv2D</span><span class="s2">(</span>
                    <span class="s1">projection_dims</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">],</span>
                    <span class="s1">kernel_size</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
                    <span class="s1">strides</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_downsampling_conv_&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                <span class="s2">),</span>
            <span class="s2">],</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">&quot;_downsampling_block_&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">downsample_layers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">downsample_layer</span><span class="s2">)</span>

    <span class="s6"># Stochastic depth schedule.</span>
    <span class="s6"># This is referred from the original ConvNeXt codebase:</span>
    <span class="s6"># https://github.com/facebookresearch/ConvNeXt/blob/main/models/convnext.py#L86</span>
    <span class="s1">depth_drop_rates </span><span class="s2">= [</span>
        <span class="s1">float</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">drop_path_rate</span><span class="s2">, </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">depths</span><span class="s2">))</span>
    <span class="s2">]</span>

    <span class="s6"># First apply downsampling blocks and then apply ConvNeXt stages.</span>
    <span class="s1">cur </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s1">num_convnext_blocks </span><span class="s2">= </span><span class="s4">4</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num_convnext_blocks</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">downsample_layers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">](</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">depths</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">ConvNeXtBlock</span><span class="s2">(</span>
                <span class="s1">projection_dim</span><span class="s2">=</span><span class="s1">projection_dims</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
                <span class="s1">drop_path_rate</span><span class="s2">=</span><span class="s1">depth_drop_rates</span><span class="s2">[</span><span class="s1">cur </span><span class="s2">+ </span><span class="s1">j</span><span class="s2">],</span>
                <span class="s1">layer_scale_init_value</span><span class="s2">=</span><span class="s1">layer_scale_init_value</span><span class="s2">,</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s1">name </span><span class="s2">+ </span><span class="s3">f&quot;_stage_</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">_block_</span><span class="s0">{</span><span class="s1">j</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">,</span>
            <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">cur </span><span class="s2">+= </span><span class="s1">depths</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

    <span class="s0">if </span><span class="s1">include_top</span><span class="s2">:</span>
        <span class="s1">imagenet_utils</span><span class="s2">.</span><span class="s1">validate_activation</span><span class="s2">(</span><span class="s1">classifier_activation</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">Head</span><span class="s2">(</span>
            <span class="s1">num_classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">,</span>
            <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s1">classifier_activation</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
        <span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">pooling </span><span class="s2">== </span><span class="s3">&quot;avg&quot;</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">GlobalAveragePooling2D</span><span class="s2">()(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">pooling </span><span class="s2">== </span><span class="s3">&quot;max&quot;</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">GlobalMaxPooling2D</span><span class="s2">()(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">LayerNormalization</span><span class="s2">(</span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">Functional</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">=</span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">outputs</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s6"># Load weights.</span>
    <span class="s0">if </span><span class="s1">weights </span><span class="s2">== </span><span class="s3">&quot;imagenet&quot;</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">include_top</span><span class="s2">:</span>
            <span class="s1">file_suffix </span><span class="s2">= </span><span class="s3">&quot;.h5&quot;</span>
            <span class="s1">file_hash </span><span class="s2">= </span><span class="s1">WEIGHTS_HASHES</span><span class="s2">[</span><span class="s1">weights_name</span><span class="s2">][</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">file_suffix </span><span class="s2">= </span><span class="s3">&quot;_notop.h5&quot;</span>
            <span class="s1">file_hash </span><span class="s2">= </span><span class="s1">WEIGHTS_HASHES</span><span class="s2">[</span><span class="s1">weights_name</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">file_name </span><span class="s2">= </span><span class="s1">name </span><span class="s2">+ </span><span class="s1">file_suffix</span>
        <span class="s1">weights_path </span><span class="s2">= </span><span class="s1">file_utils</span><span class="s2">.</span><span class="s1">get_file</span><span class="s2">(</span>
            <span class="s1">file_name</span><span class="s2">,</span>
            <span class="s1">BASE_WEIGHTS_PATH </span><span class="s2">+ </span><span class="s1">file_name</span><span class="s2">,</span>
            <span class="s1">cache_subdir</span><span class="s2">=</span><span class="s3">&quot;models&quot;</span><span class="s2">,</span>
            <span class="s1">file_hash</span><span class="s2">=</span><span class="s1">file_hash</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">load_weights</span><span class="s2">(</span><span class="s1">weights_path</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">weights </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">load_weights</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">model</span>


<span class="s6">## Instantiating variants ##</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span>
    <span class="s2">[</span>
        <span class="s3">&quot;keras.applications.convnext.ConvNeXtTiny&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;keras.applications.ConvNeXtTiny&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">ConvNeXtTiny</span><span class="s2">(</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;convnext_tiny&quot;</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">return </span><span class="s1">ConvNeXt</span><span class="s2">(</span>
        <span class="s1">weights_name</span><span class="s2">=</span><span class="s3">&quot;convnext_tiny&quot;</span><span class="s2">,</span>
        <span class="s1">depths</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;tiny&quot;</span><span class="s2">][</span><span class="s3">&quot;depths&quot;</span><span class="s2">],</span>
        <span class="s1">projection_dims</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;tiny&quot;</span><span class="s2">][</span><span class="s3">&quot;projection_dims&quot;</span><span class="s2">],</span>
        <span class="s1">drop_path_rate</span><span class="s2">=</span><span class="s4">0.0</span><span class="s2">,</span>
        <span class="s1">layer_scale_init_value</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">,</span>
        <span class="s1">default_size</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;tiny&quot;</span><span class="s2">][</span><span class="s3">&quot;default_size&quot;</span><span class="s2">],</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
        <span class="s1">include_top</span><span class="s2">=</span><span class="s1">include_top</span><span class="s2">,</span>
        <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s1">include_preprocessing</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">input_tensor</span><span class="s2">=</span><span class="s1">input_tensor</span><span class="s2">,</span>
        <span class="s1">input_shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">,</span>
        <span class="s1">pooling</span><span class="s2">=</span><span class="s1">pooling</span><span class="s2">,</span>
        <span class="s1">classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">,</span>
        <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s1">classifier_activation</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span>
    <span class="s2">[</span>
        <span class="s3">&quot;keras.applications.convnext.ConvNeXtSmall&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;keras.applications.ConvNeXtSmall&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">ConvNeXtSmall</span><span class="s2">(</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;convnext_small&quot;</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">return </span><span class="s1">ConvNeXt</span><span class="s2">(</span>
        <span class="s1">weights_name</span><span class="s2">=</span><span class="s3">&quot;convnext_small&quot;</span><span class="s2">,</span>
        <span class="s1">depths</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;small&quot;</span><span class="s2">][</span><span class="s3">&quot;depths&quot;</span><span class="s2">],</span>
        <span class="s1">projection_dims</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;small&quot;</span><span class="s2">][</span><span class="s3">&quot;projection_dims&quot;</span><span class="s2">],</span>
        <span class="s1">drop_path_rate</span><span class="s2">=</span><span class="s4">0.0</span><span class="s2">,</span>
        <span class="s1">layer_scale_init_value</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">,</span>
        <span class="s1">default_size</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;small&quot;</span><span class="s2">][</span><span class="s3">&quot;default_size&quot;</span><span class="s2">],</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
        <span class="s1">include_top</span><span class="s2">=</span><span class="s1">include_top</span><span class="s2">,</span>
        <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s1">include_preprocessing</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">input_tensor</span><span class="s2">=</span><span class="s1">input_tensor</span><span class="s2">,</span>
        <span class="s1">input_shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">,</span>
        <span class="s1">pooling</span><span class="s2">=</span><span class="s1">pooling</span><span class="s2">,</span>
        <span class="s1">classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">,</span>
        <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s1">classifier_activation</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span>
    <span class="s2">[</span>
        <span class="s3">&quot;keras.applications.convnext.ConvNeXtBase&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;keras.applications.ConvNeXtBase&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">ConvNeXtBase</span><span class="s2">(</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;convnext_base&quot;</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">return </span><span class="s1">ConvNeXt</span><span class="s2">(</span>
        <span class="s1">weights_name</span><span class="s2">=</span><span class="s3">&quot;convnext_base&quot;</span><span class="s2">,</span>
        <span class="s1">depths</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;base&quot;</span><span class="s2">][</span><span class="s3">&quot;depths&quot;</span><span class="s2">],</span>
        <span class="s1">projection_dims</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;base&quot;</span><span class="s2">][</span><span class="s3">&quot;projection_dims&quot;</span><span class="s2">],</span>
        <span class="s1">drop_path_rate</span><span class="s2">=</span><span class="s4">0.0</span><span class="s2">,</span>
        <span class="s1">layer_scale_init_value</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">,</span>
        <span class="s1">default_size</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;base&quot;</span><span class="s2">][</span><span class="s3">&quot;default_size&quot;</span><span class="s2">],</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
        <span class="s1">include_top</span><span class="s2">=</span><span class="s1">include_top</span><span class="s2">,</span>
        <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s1">include_preprocessing</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">input_tensor</span><span class="s2">=</span><span class="s1">input_tensor</span><span class="s2">,</span>
        <span class="s1">input_shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">,</span>
        <span class="s1">pooling</span><span class="s2">=</span><span class="s1">pooling</span><span class="s2">,</span>
        <span class="s1">classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">,</span>
        <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s1">classifier_activation</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span>
    <span class="s2">[</span>
        <span class="s3">&quot;keras.applications.convnext.ConvNeXtLarge&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;keras.applications.ConvNeXtLarge&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">ConvNeXtLarge</span><span class="s2">(</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;convnext_large&quot;</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">return </span><span class="s1">ConvNeXt</span><span class="s2">(</span>
        <span class="s1">weights_name</span><span class="s2">=</span><span class="s3">&quot;convnext_large&quot;</span><span class="s2">,</span>
        <span class="s1">depths</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;large&quot;</span><span class="s2">][</span><span class="s3">&quot;depths&quot;</span><span class="s2">],</span>
        <span class="s1">projection_dims</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;large&quot;</span><span class="s2">][</span><span class="s3">&quot;projection_dims&quot;</span><span class="s2">],</span>
        <span class="s1">drop_path_rate</span><span class="s2">=</span><span class="s4">0.0</span><span class="s2">,</span>
        <span class="s1">layer_scale_init_value</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">,</span>
        <span class="s1">default_size</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;large&quot;</span><span class="s2">][</span><span class="s3">&quot;default_size&quot;</span><span class="s2">],</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
        <span class="s1">include_top</span><span class="s2">=</span><span class="s1">include_top</span><span class="s2">,</span>
        <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s1">include_preprocessing</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">input_tensor</span><span class="s2">=</span><span class="s1">input_tensor</span><span class="s2">,</span>
        <span class="s1">input_shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">,</span>
        <span class="s1">pooling</span><span class="s2">=</span><span class="s1">pooling</span><span class="s2">,</span>
        <span class="s1">classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">,</span>
        <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s1">classifier_activation</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span>
    <span class="s2">[</span>
        <span class="s3">&quot;keras.applications.convnext.ConvNeXtXLarge&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;keras.applications.ConvNeXtXLarge&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">ConvNeXtXLarge</span><span class="s2">(</span>
    <span class="s1">include_top</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s1">input_tensor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">input_shape</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">pooling</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">classes</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
    <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">,</span>
    <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;convnext_xlarge&quot;</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">return </span><span class="s1">ConvNeXt</span><span class="s2">(</span>
        <span class="s1">weights_name</span><span class="s2">=</span><span class="s3">&quot;convnext_xlarge&quot;</span><span class="s2">,</span>
        <span class="s1">depths</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;xlarge&quot;</span><span class="s2">][</span><span class="s3">&quot;depths&quot;</span><span class="s2">],</span>
        <span class="s1">projection_dims</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;xlarge&quot;</span><span class="s2">][</span><span class="s3">&quot;projection_dims&quot;</span><span class="s2">],</span>
        <span class="s1">drop_path_rate</span><span class="s2">=</span><span class="s4">0.0</span><span class="s2">,</span>
        <span class="s1">layer_scale_init_value</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">,</span>
        <span class="s1">default_size</span><span class="s2">=</span><span class="s1">MODEL_CONFIGS</span><span class="s2">[</span><span class="s3">&quot;xlarge&quot;</span><span class="s2">][</span><span class="s3">&quot;default_size&quot;</span><span class="s2">],</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
        <span class="s1">include_top</span><span class="s2">=</span><span class="s1">include_top</span><span class="s2">,</span>
        <span class="s1">include_preprocessing</span><span class="s2">=</span><span class="s1">include_preprocessing</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">input_tensor</span><span class="s2">=</span><span class="s1">input_tensor</span><span class="s2">,</span>
        <span class="s1">input_shape</span><span class="s2">=</span><span class="s1">input_shape</span><span class="s2">,</span>
        <span class="s1">pooling</span><span class="s2">=</span><span class="s1">pooling</span><span class="s2">,</span>
        <span class="s1">classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">,</span>
        <span class="s1">classifier_activation</span><span class="s2">=</span><span class="s1">classifier_activation</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s1">ConvNeXtTiny</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">BASE_DOCSTRING</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;ConvNeXtTiny&quot;</span><span class="s2">)</span>
<span class="s1">ConvNeXtSmall</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">BASE_DOCSTRING</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;ConvNeXtSmall&quot;</span><span class="s2">)</span>
<span class="s1">ConvNeXtBase</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">BASE_DOCSTRING</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;ConvNeXtBase&quot;</span><span class="s2">)</span>
<span class="s1">ConvNeXtLarge</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">BASE_DOCSTRING</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;ConvNeXtLarge&quot;</span><span class="s2">)</span>
<span class="s1">ConvNeXtXLarge</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">BASE_DOCSTRING</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;ConvNeXtXLarge&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span><span class="s3">&quot;keras.applications.convnext.preprocess_input&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">preprocess_input</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">data_format</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;A placeholder method for backward compatibility. 
 
    The preprocessing logic has been included in the convnext model 
    implementation. Users are no longer required to call this method to 
    normalize the input data. This method does nothing and only kept as a 
    placeholder to align the API surface between old and new version of model. 
 
    Args: 
        x: A floating point `numpy.array` or a tensor. 
        data_format: Optional data format of the image tensor/array. Defaults to 
            None, in which case the global setting 
            `keras.backend.image_data_format()` is used 
            (unless you changed it, it defaults to `&quot;channels_last&quot;`).{mode} 
 
    Returns: 
        Unchanged `numpy.array` or tensor. 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">x</span>


<span class="s2">@</span><span class="s1">keras_export</span><span class="s2">(</span><span class="s3">&quot;keras.applications.convnext.decode_predictions&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">decode_predictions</span><span class="s2">(</span><span class="s1">preds</span><span class="s2">, </span><span class="s1">top</span><span class="s2">=</span><span class="s4">5</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">imagenet_utils</span><span class="s2">.</span><span class="s1">decode_predictions</span><span class="s2">(</span><span class="s1">preds</span><span class="s2">, </span><span class="s1">top</span><span class="s2">=</span><span class="s1">top</span><span class="s2">)</span>


<span class="s1">decode_predictions</span><span class="s2">.</span><span class="s1">__doc__ </span><span class="s2">= </span><span class="s1">imagenet_utils</span><span class="s2">.</span><span class="s1">decode_predictions</span><span class="s2">.</span><span class="s1">__doc__</span>
</pre>
</body>
</html>