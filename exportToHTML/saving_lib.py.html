<html>
<head>
<title>saving_lib.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
saving_lib.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Python-based idempotent model-saving functionality.&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">datetime</span>
<span class="s2">import </span><span class="s1">io</span>
<span class="s2">import </span><span class="s1">json</span>
<span class="s2">import </span><span class="s1">pathlib</span>
<span class="s2">import </span><span class="s1">tempfile</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">import </span><span class="s1">zipfile</span>

<span class="s2">import </span><span class="s1">ml_dtypes</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>

<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src </span><span class="s2">import </span><span class="s1">backend</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">backend</span><span class="s3">.</span><span class="s1">common </span><span class="s2">import </span><span class="s1">global_state</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">.</span><span class="s1">layer </span><span class="s2">import </span><span class="s1">Layer</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">losses</span><span class="s3">.</span><span class="s1">loss </span><span class="s2">import </span><span class="s1">Loss</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">metric </span><span class="s2">import </span><span class="s1">Metric</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">optimizers</span><span class="s3">.</span><span class="s1">optimizer </span><span class="s2">import </span><span class="s1">Optimizer</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">saving</span><span class="s3">.</span><span class="s1">serialization_lib </span><span class="s2">import </span><span class="s1">ObjectSharingScope</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">saving</span><span class="s3">.</span><span class="s1">serialization_lib </span><span class="s2">import </span><span class="s1">deserialize_keras_object</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">saving</span><span class="s3">.</span><span class="s1">serialization_lib </span><span class="s2">import </span><span class="s1">serialize_keras_object</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">trainers</span><span class="s3">.</span><span class="s1">compile_utils </span><span class="s2">import </span><span class="s1">CompileMetrics</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">file_utils</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">io_utils</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">naming</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">plot_model</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">model_visualization </span><span class="s2">import </span><span class="s1">check_pydot</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">summary_utils </span><span class="s2">import </span><span class="s1">weight_memory_size</span>
<span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">version </span><span class="s2">import </span><span class="s1">__version__ </span><span class="s2">as </span><span class="s1">keras_version</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">h5py</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s1">h5py </span><span class="s3">= </span><span class="s2">None</span>
<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">psutil</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s1">psutil </span><span class="s3">= </span><span class="s2">None</span>
<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">huggingface_hub</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s1">huggingface_hub </span><span class="s3">= </span><span class="s2">None</span>


<span class="s1">_CONFIG_FILENAME </span><span class="s3">= </span><span class="s4">&quot;config.json&quot;</span>
<span class="s1">_METADATA_FILENAME </span><span class="s3">= </span><span class="s4">&quot;metadata.json&quot;</span>
<span class="s1">_VARS_FNAME </span><span class="s3">= </span><span class="s4">&quot;model.weights&quot;  </span><span class="s5"># Will become e.g. &quot;model.weights.h5&quot;</span>
<span class="s1">_VARS_FNAME_H5 </span><span class="s3">= </span><span class="s1">_VARS_FNAME </span><span class="s3">+ </span><span class="s4">&quot;.h5&quot;</span>
<span class="s1">_VARS_FNAME_NPZ </span><span class="s3">= </span><span class="s1">_VARS_FNAME </span><span class="s3">+ </span><span class="s4">&quot;.npz&quot;</span>
<span class="s1">_ASSETS_DIRNAME </span><span class="s3">= </span><span class="s4">&quot;assets&quot;</span>
<span class="s1">_MEMORY_UPPER_BOUND </span><span class="s3">= </span><span class="s6">0.5  </span><span class="s5"># 50%</span>


<span class="s1">_MODEL_CARD_TEMPLATE </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
--- 
library_name: keras 
--- 
 
This model has been uploaded using the Keras library and can be used with JAX, 
TensorFlow, and PyTorch backends. 
 
This model card has been generated automatically and should be completed by the 
model author. 
See [Model Cards documentation](https://huggingface.co/docs/hub/model-cards) for 
more information. 
 
For more details about the model architecture, check out 
[config.json](./config.json).&quot;&quot;&quot;</span>


<span class="s2">def </span><span class="s1">save_model</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">=</span><span class="s4">&quot;h5&quot;</span><span class="s3">, </span><span class="s1">zipped</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Save a zip-archive representing a Keras model to the given file or path. 
 
    The zip-based archive contains the following structure: 
 
    - JSON-based configuration file (config.json): Records of model, layer, and 
        other saveables' configuration. 
    - H5-based saveable state files, found in respective directories, such as 
        model/states.npz, model/dense_layer/states.npz, etc. 
    - Metadata file. 
 
    The states of Keras saveables (layers, optimizers, loss, and metrics) are 
    automatically saved as long as they can be discovered through the attributes 
    returned by `dir(Model)`. Typically, the state includes the variables 
    associated with the saveable, but some specially purposed layers may 
    contain more such as the vocabularies stored in the hashmaps. The saveables 
    define how their states are saved by exposing `save_state()` and 
    `load_state()` APIs. 
 
    For the case of layer states, the variables will be visited as long as 
    they are either 1) referenced via layer attributes, or 2) referenced via a 
    container (list, tuple, or dict), and the container is referenced via a 
    layer attribute. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">weights_format </span><span class="s3">== </span><span class="s4">&quot;h5&quot; </span><span class="s2">and </span><span class="s1">h5py </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ImportError</span><span class="s3">(</span><span class="s4">&quot;h5py must be installed in order to save a model.&quot;</span><span class="s3">)</span>

    <span class="s2">if not </span><span class="s1">model</span><span class="s3">.</span><span class="s1">built</span><span class="s3">:</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
            <span class="s4">&quot;You are saving a model that has not yet been built. &quot;</span>
            <span class="s4">&quot;It might not contain any weights yet. &quot;</span>
            <span class="s4">&quot;Consider building the model first by calling it &quot;</span>
            <span class="s4">&quot;on some data.&quot;</span><span class="s3">,</span>
            <span class="s1">stacklevel</span><span class="s3">=</span><span class="s6">2</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">io</span><span class="s3">.</span><span class="s1">IOBase</span><span class="s3">):</span>
        <span class="s1">_save_model_to_fileobj</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">)</span>
        <span class="s2">return</span>

    <span class="s1">filepath </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">)</span>
    <span class="s1">is_hf </span><span class="s3">= </span><span class="s1">filepath</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;hf://&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">zipped </span><span class="s2">and not </span><span class="s1">filepath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;.keras&quot;</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">&quot;Invalid `filepath` argument: expected a `.keras` extension. &quot;</span>
            <span class="s4">f&quot;Received: filepath=</span><span class="s2">{</span><span class="s1">filepath</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">zipped </span><span class="s2">and </span><span class="s1">filepath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;.keras&quot;</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">&quot;When using `zipped=False`, the `filepath` argument should not &quot;</span>
            <span class="s4">f&quot;end in `.keras`. Received: filepath=</span><span class="s2">{</span><span class="s1">filepath</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">zipped </span><span class="s2">and </span><span class="s1">is_hf</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">&quot;When saving to the Hugging Face Hub, you should not save the &quot;</span>
            <span class="s4">f&quot;model as zipped. Received: filepath=</span><span class="s2">{</span><span class="s1">filepath</span><span class="s2">}</span><span class="s4">, zipped=</span><span class="s2">{</span><span class="s1">zipped</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">is_hf</span><span class="s3">:</span>
        <span class="s1">_upload_model_to_hf</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">)</span>
    <span class="s2">elif not </span><span class="s1">zipped</span><span class="s3">:</span>
        <span class="s1">_save_model_to_dir</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">is_remote_path</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">):</span>
            <span class="s5"># Remote path. Zip to local memory byte io and copy to remote</span>
            <span class="s1">zip_filepath </span><span class="s3">= </span><span class="s1">io</span><span class="s3">.</span><span class="s1">BytesIO</span><span class="s3">()</span>
            <span class="s1">_save_model_to_fileobj</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">zip_filepath</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">File</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s4">&quot;wb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">zip_filepath</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">())</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s4">&quot;wb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">_save_model_to_fileobj</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_serialize_model_as_json</span><span class="s3">(</span><span class="s1">model</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">ObjectSharingScope</span><span class="s3">():</span>
        <span class="s1">serialized_model_dict </span><span class="s3">= </span><span class="s1">serialize_keras_object</span><span class="s3">(</span><span class="s1">model</span><span class="s3">)</span>
    <span class="s1">config_json </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">dumps</span><span class="s3">(</span><span class="s1">serialized_model_dict</span><span class="s3">)</span>
    <span class="s1">metadata_json </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">dumps</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s4">&quot;keras_version&quot;</span><span class="s3">: </span><span class="s1">keras_version</span><span class="s3">,</span>
            <span class="s4">&quot;date_saved&quot;</span><span class="s3">: </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">().</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">&quot;%Y-%m-%d@%H:%M:%S&quot;</span><span class="s3">),</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s2">return </span><span class="s1">config_json</span><span class="s3">, </span><span class="s1">metadata_json</span>


<span class="s2">def </span><span class="s1">_save_model_to_dir</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">):</span>
        <span class="s1">file_utils</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">)</span>
    <span class="s1">config_json</span><span class="s3">, </span><span class="s1">metadata_json </span><span class="s3">= </span><span class="s1">_serialize_model_as_json</span><span class="s3">(</span><span class="s1">model</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">_METADATA_FILENAME</span><span class="s3">), </span><span class="s4">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">metadata_json</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">_CONFIG_FILENAME</span><span class="s3">), </span><span class="s4">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">config_json</span><span class="s3">)</span>
    <span class="s1">weights_filepath </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">_VARS_FNAME_H5</span><span class="s3">)</span>
    <span class="s1">assert_dirpath </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">_ASSETS_DIRNAME</span><span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">weights_format </span><span class="s3">== </span><span class="s4">&quot;h5&quot;</span><span class="s3">:</span>
            <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span><span class="s1">weights_filepath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">weights_format </span><span class="s3">== </span><span class="s4">&quot;npz&quot;</span><span class="s3">:</span>
            <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">NpzIOStore</span><span class="s3">(</span><span class="s1">weights_filepath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s4">&quot;Unknown `weights_format` argument. &quot;</span>
                <span class="s4">&quot;Expected 'h5' or 'npz'. &quot;</span>
                <span class="s4">f&quot;Received: weights_format=</span><span class="s2">{</span><span class="s1">weights_format</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s3">)</span>
        <span class="s1">asset_store </span><span class="s3">= </span><span class="s1">DiskIOStore</span><span class="s3">(</span><span class="s1">assert_dirpath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span><span class="s3">)</span>
        <span class="s1">_save_state</span><span class="s3">(</span>
            <span class="s1">model</span><span class="s3">,</span>
            <span class="s1">weights_store</span><span class="s3">=</span><span class="s1">weights_store</span><span class="s3">,</span>
            <span class="s1">assets_store</span><span class="s3">=</span><span class="s1">asset_store</span><span class="s3">,</span>
            <span class="s1">inner_path</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
            <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">set</span><span class="s3">(),</span>
        <span class="s3">)</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s1">weights_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">asset_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">_save_model_to_fileobj</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">fileobj</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">):</span>
    <span class="s1">config_json</span><span class="s3">, </span><span class="s1">metadata_json </span><span class="s3">= </span><span class="s1">_serialize_model_as_json</span><span class="s3">(</span><span class="s1">model</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">zipfile</span><span class="s3">.</span><span class="s1">ZipFile</span><span class="s3">(</span><span class="s1">fileobj</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">zf</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">zf</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">_METADATA_FILENAME</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">metadata_json</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">())</span>
        <span class="s2">with </span><span class="s1">zf</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">_CONFIG_FILENAME</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">config_json</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">())</span>

        <span class="s1">weights_file_path </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">weights_store </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">asset_store </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">write_zf </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">weights_format </span><span class="s3">== </span><span class="s4">&quot;h5&quot;</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">is_memory_sufficient</span><span class="s3">(</span><span class="s1">model</span><span class="s3">):</span>
                        <span class="s5"># Load the model weights into memory before writing</span>
                        <span class="s5"># .keras if the system memory is sufficient.</span>
                        <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span>
                            <span class="s1">_VARS_FNAME_H5</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s1">zf</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span>
                        <span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s5"># Try opening the .h5 file, then writing it to `zf` at</span>
                        <span class="s5"># the end of the function call. This is more memory</span>
                        <span class="s5"># efficient than writing the weights into memory first.</span>
                        <span class="s1">working_dir </span><span class="s3">= </span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">fileobj</span><span class="s3">.</span><span class="s1">name</span><span class="s3">).</span><span class="s1">parent</span>
                        <span class="s1">weights_file_path </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">NamedTemporaryFile</span><span class="s3">(</span>
                            <span class="s1">dir</span><span class="s3">=</span><span class="s1">working_dir</span>
                        <span class="s3">)</span>
                        <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span>
                            <span class="s1">weights_file_path</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span>
                        <span class="s3">)</span>
                        <span class="s1">write_zf </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s2">except</span><span class="s3">:</span>
                    <span class="s5"># If we can't use the local disk for any reason, write the</span>
                    <span class="s5"># weights into memory first, which consumes more memory.</span>
                    <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span>
                        <span class="s1">_VARS_FNAME_H5</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s1">zf</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span>
                    <span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">weights_format </span><span class="s3">== </span><span class="s4">&quot;npz&quot;</span><span class="s3">:</span>
                <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">NpzIOStore</span><span class="s3">(</span>
                    <span class="s1">_VARS_FNAME_NPZ</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s1">zf</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span>
                <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                    <span class="s4">&quot;Unknown `weights_format` argument. &quot;</span>
                    <span class="s4">&quot;Expected 'h5' or 'npz'. &quot;</span>
                    <span class="s4">f&quot;Received: weights_format=</span><span class="s2">{</span><span class="s1">weights_format</span><span class="s2">}</span><span class="s4">&quot;</span>
                <span class="s3">)</span>

            <span class="s1">asset_store </span><span class="s3">= </span><span class="s1">DiskIOStore</span><span class="s3">(</span><span class="s1">_ASSETS_DIRNAME</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s1">zf</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span><span class="s3">)</span>

            <span class="s1">_save_state</span><span class="s3">(</span>
                <span class="s1">model</span><span class="s3">,</span>
                <span class="s1">weights_store</span><span class="s3">=</span><span class="s1">weights_store</span><span class="s3">,</span>
                <span class="s1">assets_store</span><span class="s3">=</span><span class="s1">asset_store</span><span class="s3">,</span>
                <span class="s1">inner_path</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
                <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">set</span><span class="s3">(),</span>
            <span class="s3">)</span>
        <span class="s2">except</span><span class="s3">:</span>
            <span class="s5"># Skip the final `zf.write` if any exception is raised</span>
            <span class="s1">write_zf </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">if </span><span class="s1">weights_store</span><span class="s3">:</span>
                <span class="s1">weights_store</span><span class="s3">.</span><span class="s1">archive </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s2">raise</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">weights_store</span><span class="s3">:</span>
                <span class="s1">weights_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">asset_store</span><span class="s3">:</span>
                <span class="s1">asset_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">write_zf </span><span class="s2">and </span><span class="s1">weights_file_path</span><span class="s3">:</span>
                <span class="s1">zf</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">weights_file_path</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">_VARS_FNAME_H5</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">weights_file_path</span><span class="s3">:</span>
                <span class="s1">weights_file_path</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">_upload_model_to_hf</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">hf_path</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">huggingface_hub </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ImportError</span><span class="s3">(</span>
            <span class="s4">&quot;To save models to the Hugging Face Hub, &quot;</span>
            <span class="s4">&quot;you must install the `huggingface_hub` package.&quot;</span>
        <span class="s3">)</span>

    <span class="s1">original_hf_path </span><span class="s3">= </span><span class="s1">hf_path</span>
    <span class="s2">if </span><span class="s1">hf_path</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;hf://&quot;</span><span class="s3">):</span>
        <span class="s1">hf_path </span><span class="s3">= </span><span class="s1">hf_path</span><span class="s3">[</span><span class="s6">5</span><span class="s3">:]</span>
    <span class="s2">if </span><span class="s1">hf_path</span><span class="s3">.</span><span class="s1">count</span><span class="s3">(</span><span class="s4">&quot;/&quot;</span><span class="s3">) &gt; </span><span class="s6">1</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">&quot;Invalid `hf_path` argument: expected `namespace/model_name`&quot;</span>
            <span class="s4">f&quot; format. Received: hf_path=</span><span class="s2">{</span><span class="s1">original_hf_path</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s3">)</span>

    <span class="s1">api </span><span class="s3">= </span><span class="s1">huggingface_hub</span><span class="s3">.</span><span class="s1">HfApi</span><span class="s3">(</span>
        <span class="s1">library_name</span><span class="s3">=</span><span class="s4">&quot;keras&quot;</span><span class="s3">, </span><span class="s1">library_version</span><span class="s3">=</span><span class="s1">keras_version</span>
    <span class="s3">)</span>
    <span class="s1">repo_url </span><span class="s3">= </span><span class="s1">api</span><span class="s3">.</span><span class="s1">create_repo</span><span class="s3">(</span><span class="s1">hf_path</span><span class="s3">, </span><span class="s1">exist_ok</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">repo_id </span><span class="s3">= </span><span class="s1">repo_url</span><span class="s3">.</span><span class="s1">repo_id</span>

    <span class="s2">with </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">TemporaryDirectory</span><span class="s3">() </span><span class="s2">as </span><span class="s1">tmp_dir</span><span class="s3">:</span>
        <span class="s1">_save_model_to_dir</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">tmp_dir</span><span class="s3">, </span><span class="s1">weights_format</span><span class="s3">)</span>

        <span class="s1">model_card </span><span class="s3">= </span><span class="s1">_MODEL_CARD_TEMPLATE</span>

        <span class="s2">if </span><span class="s1">check_pydot</span><span class="s3">():</span>
            <span class="s1">plot_path </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tmp_dir</span><span class="s3">, </span><span class="s4">&quot;assets&quot;</span><span class="s3">, </span><span class="s4">&quot;summary_plot.png&quot;</span><span class="s3">)</span>
            <span class="s1">plot_model</span><span class="s3">(</span>
                <span class="s1">model</span><span class="s3">,</span>
                <span class="s1">to_file</span><span class="s3">=</span><span class="s1">plot_path</span><span class="s3">,</span>
                <span class="s1">show_layer_names</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s1">show_shapes</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s1">show_dtype</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">layers</span><span class="s3">) &lt;= </span><span class="s6">10</span><span class="s3">:</span>
                <span class="s1">model_card </span><span class="s3">+= </span><span class="s4">&quot;</span><span class="s2">\n\n</span><span class="s4">![](./assets/summary_plot.png)&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">model_card </span><span class="s3">+= (</span>
                    <span class="s4">&quot;A plot of the model can be found &quot;</span>
                    <span class="s4">&quot;[here](./assets/summary_plot.png).&quot;</span>
                <span class="s3">)</span>

        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tmp_dir</span><span class="s3">, </span><span class="s4">&quot;README.md&quot;</span><span class="s3">), </span><span class="s4">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">model_card</span><span class="s3">)</span>

        <span class="s1">api</span><span class="s3">.</span><span class="s1">upload_folder</span><span class="s3">(</span>
            <span class="s1">repo_id</span><span class="s3">=</span><span class="s1">repo_id</span><span class="s3">,</span>
            <span class="s1">folder_path</span><span class="s3">=</span><span class="s1">tmp_dir</span><span class="s3">,</span>
            <span class="s1">commit_message</span><span class="s3">=</span><span class="s4">&quot;Save model using Keras.&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">io_utils</span><span class="s3">.</span><span class="s1">print_msg</span><span class="s3">(</span>
            <span class="s4">f&quot;Model saved to the Hugging Face Hub: </span><span class="s2">{</span><span class="s1">repo_url</span><span class="s2">}\n</span><span class="s4">&quot;</span>
            <span class="s4">&quot;To load back the model, use &quot;</span>
            <span class="s4">f&quot;`keras.saving.load_model('hf://</span><span class="s2">{</span><span class="s1">repo_id</span><span class="s2">}</span><span class="s4">')`&quot;</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">load_model</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">safe_mode</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Load a zip archive representing a Keras model.&quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">io</span><span class="s3">.</span><span class="s1">IOBase</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">_load_model_from_fileobj</span><span class="s3">(</span>
            <span class="s1">filepath</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span>
        <span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">str</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">).</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;hf://&quot;</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">huggingface_hub </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ImportError</span><span class="s3">(</span>
                <span class="s4">&quot;To load models from the Hugging Face Hub, &quot;</span>
                <span class="s4">&quot;you must install the `huggingface_hub` package.&quot;</span>
            <span class="s3">)</span>

        <span class="s1">repo_id </span><span class="s3">= </span><span class="s1">filepath</span><span class="s3">[</span><span class="s6">5</span><span class="s3">:]</span>
        <span class="s1">folder_path </span><span class="s3">= </span><span class="s1">huggingface_hub</span><span class="s3">.</span><span class="s1">snapshot_download</span><span class="s3">(</span>
            <span class="s1">repo_id</span><span class="s3">=</span><span class="s1">repo_id</span><span class="s3">,</span>
            <span class="s1">library_name</span><span class="s3">=</span><span class="s4">&quot;keras&quot;</span><span class="s3">,</span>
            <span class="s1">library_version</span><span class="s3">=</span><span class="s1">keras_version</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">_load_model_from_dir</span><span class="s3">(</span>
            <span class="s1">folder_path</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span>
        <span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">filepath </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">filepath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;.keras&quot;</span><span class="s3">):</span>
            <span class="s1">is_keras_dir </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">) </span><span class="s2">and </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span>
                <span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s4">&quot;config.json&quot;</span><span class="s3">)</span>
            <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">is_keras_dir</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">_load_model_from_dir</span><span class="s3">(</span>
                    <span class="s1">filepath</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span>
                <span class="s3">)</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s4">&quot;Invalid filename: expected a `.keras` extension. &quot;</span>
                <span class="s4">f&quot;Received: filepath=</span><span class="s2">{</span><span class="s1">filepath</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s3">)</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">_load_model_from_fileobj</span><span class="s3">(</span>
                <span class="s1">f</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">_load_model_from_dir</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;Directory doesn't exist: </span><span class="s2">{</span><span class="s1">dirpath</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;Path isn't a directory: </span><span class="s2">{</span><span class="s1">dirpath</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">_CONFIG_FILENAME</span><span class="s3">), </span><span class="s4">&quot;r&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">config_json </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
    <span class="s1">model </span><span class="s3">= </span><span class="s1">_model_from_config</span><span class="s3">(</span><span class="s1">config_json</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span><span class="s3">)</span>

    <span class="s1">all_filenames </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">_VARS_FNAME_H5 </span><span class="s2">in </span><span class="s1">all_filenames</span><span class="s3">:</span>
            <span class="s1">weights_file_path </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">_VARS_FNAME_H5</span><span class="s3">)</span>
            <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span><span class="s1">weights_file_path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">_VARS_FNAME_NPZ </span><span class="s2">in </span><span class="s1">all_filenames</span><span class="s3">:</span>
            <span class="s1">weights_file_path </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">_VARS_FNAME_NPZ</span><span class="s3">)</span>
            <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">NpzIOStore</span><span class="s3">(</span><span class="s1">weights_file_path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s4">f&quot;Expected a </span><span class="s2">{</span><span class="s1">_VARS_FNAME_H5</span><span class="s2">} </span><span class="s4">or </span><span class="s2">{</span><span class="s1">_VARS_FNAME_NPZ</span><span class="s2">} </span><span class="s4">file.&quot;</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">all_filenames</span><span class="s3">) &gt; </span><span class="s6">3</span><span class="s3">:</span>
            <span class="s1">asset_store </span><span class="s3">= </span><span class="s1">DiskIOStore</span><span class="s3">(</span>
                <span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirpath</span><span class="s3">, </span><span class="s1">_ASSETS_DIRNAME</span><span class="s3">), </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span>
            <span class="s3">)</span>

        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">asset_store </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">failed_saveables </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">error_msgs </span><span class="s3">= {}</span>
        <span class="s1">_load_state</span><span class="s3">(</span>
            <span class="s1">model</span><span class="s3">,</span>
            <span class="s1">weights_store</span><span class="s3">=</span><span class="s1">weights_store</span><span class="s3">,</span>
            <span class="s1">assets_store</span><span class="s3">=</span><span class="s1">asset_store</span><span class="s3">,</span>
            <span class="s1">inner_path</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
            <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">set</span><span class="s3">(),</span>
            <span class="s1">failed_saveables</span><span class="s3">=</span><span class="s1">failed_saveables</span><span class="s3">,</span>
            <span class="s1">error_msgs</span><span class="s3">=</span><span class="s1">error_msgs</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s1">weights_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">asset_store</span><span class="s3">:</span>
            <span class="s1">asset_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">failed_saveables</span><span class="s3">:</span>
        <span class="s1">_raise_loading_failure</span><span class="s3">(</span><span class="s1">error_msgs</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">model</span>


<span class="s2">def </span><span class="s1">_model_from_config</span><span class="s3">(</span><span class="s1">config_json</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span><span class="s3">):</span>
    <span class="s5"># Note: we should NOT use a custom JSON decoder. Anything that</span>
    <span class="s5"># needs custom decoding must be handled in deserialize_keras_object.</span>
    <span class="s1">config_dict </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">loads</span><span class="s3">(</span><span class="s1">config_json</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">compile</span><span class="s3">:</span>
        <span class="s5"># Disable compilation</span>
        <span class="s1">config_dict</span><span class="s3">[</span><span class="s4">&quot;compile_config&quot;</span><span class="s3">] = </span><span class="s2">None</span>
    <span class="s5"># Construct the model from the configuration file in the archive.</span>
    <span class="s2">with </span><span class="s1">ObjectSharingScope</span><span class="s3">():</span>
        <span class="s1">model </span><span class="s3">= </span><span class="s1">deserialize_keras_object</span><span class="s3">(</span>
            <span class="s1">config_dict</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">safe_mode</span><span class="s3">=</span><span class="s1">safe_mode</span>
        <span class="s3">)</span>
    <span class="s2">return </span><span class="s1">model</span>


<span class="s2">def </span><span class="s1">_load_model_from_fileobj</span><span class="s3">(</span><span class="s1">fileobj</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">zipfile</span><span class="s3">.</span><span class="s1">ZipFile</span><span class="s3">(</span><span class="s1">fileobj</span><span class="s3">, </span><span class="s4">&quot;r&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">zf</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">zf</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">_CONFIG_FILENAME</span><span class="s3">, </span><span class="s4">&quot;r&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">config_json </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

        <span class="s1">model </span><span class="s3">= </span><span class="s1">_model_from_config</span><span class="s3">(</span>
            <span class="s1">config_json</span><span class="s3">, </span><span class="s1">custom_objects</span><span class="s3">, </span><span class="s1">compile</span><span class="s3">, </span><span class="s1">safe_mode</span>
        <span class="s3">)</span>

        <span class="s1">all_filenames </span><span class="s3">= </span><span class="s1">zf</span><span class="s3">.</span><span class="s1">namelist</span><span class="s3">()</span>
        <span class="s1">extract_dir </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">weights_store </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">asset_store </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">_VARS_FNAME_H5 </span><span class="s2">in </span><span class="s1">all_filenames</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">is_memory_sufficient</span><span class="s3">(</span><span class="s1">model</span><span class="s3">):</span>
                        <span class="s5"># Load the entire file into memory if the system memory</span>
                        <span class="s5"># is sufficient.</span>
                        <span class="s1">io_file </span><span class="s3">= </span><span class="s1">io</span><span class="s3">.</span><span class="s1">BytesIO</span><span class="s3">(</span>
                            <span class="s1">zf</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">_VARS_FNAME_H5</span><span class="s3">, </span><span class="s4">&quot;r&quot;</span><span class="s3">).</span><span class="s1">read</span><span class="s3">()</span>
                        <span class="s3">)</span>
                        <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span><span class="s1">io_file</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s5"># Try extracting the model.weights.h5 file, and then</span>
                        <span class="s5"># loading it using using h5py. This is significantly</span>
                        <span class="s5"># faster than reading from the zip archive on the fly.</span>
                        <span class="s1">extract_dir </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">TemporaryDirectory</span><span class="s3">(</span>
                            <span class="s1">dir</span><span class="s3">=</span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">fileobj</span><span class="s3">.</span><span class="s1">name</span><span class="s3">).</span><span class="s1">parent</span>
                        <span class="s3">)</span>
                        <span class="s1">zf</span><span class="s3">.</span><span class="s1">extract</span><span class="s3">(</span><span class="s1">_VARS_FNAME_H5</span><span class="s3">, </span><span class="s1">extract_dir</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
                        <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span>
                            <span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">extract_dir</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">_VARS_FNAME_H5</span><span class="s3">),</span>
                            <span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">,</span>
                        <span class="s3">)</span>
                <span class="s2">except</span><span class="s3">:</span>
                    <span class="s5"># If we can't use the local disk for any reason, read the</span>
                    <span class="s5"># weights from the zip archive on the fly, which is less</span>
                    <span class="s5"># efficient.</span>
                    <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span><span class="s1">_VARS_FNAME_H5</span><span class="s3">, </span><span class="s1">zf</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">_VARS_FNAME_NPZ </span><span class="s2">in </span><span class="s1">all_filenames</span><span class="s3">:</span>
                <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">NpzIOStore</span><span class="s3">(</span><span class="s1">_VARS_FNAME_NPZ</span><span class="s3">, </span><span class="s1">zf</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                    <span class="s4">f&quot;Expected a </span><span class="s2">{</span><span class="s1">_VARS_FNAME_H5</span><span class="s2">} </span><span class="s4">or </span><span class="s2">{</span><span class="s1">_VARS_FNAME_NPZ</span><span class="s2">} </span><span class="s4">file.&quot;</span>
                <span class="s3">)</span>

            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">all_filenames</span><span class="s3">) &gt; </span><span class="s6">3</span><span class="s3">:</span>
                <span class="s1">asset_store </span><span class="s3">= </span><span class="s1">DiskIOStore</span><span class="s3">(</span><span class="s1">_ASSETS_DIRNAME</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s1">zf</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>

            <span class="s1">failed_saveables </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
            <span class="s1">error_msgs </span><span class="s3">= {}</span>
            <span class="s1">_load_state</span><span class="s3">(</span>
                <span class="s1">model</span><span class="s3">,</span>
                <span class="s1">weights_store</span><span class="s3">=</span><span class="s1">weights_store</span><span class="s3">,</span>
                <span class="s1">assets_store</span><span class="s3">=</span><span class="s1">asset_store</span><span class="s3">,</span>
                <span class="s1">inner_path</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
                <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">set</span><span class="s3">(),</span>
                <span class="s1">failed_saveables</span><span class="s3">=</span><span class="s1">failed_saveables</span><span class="s3">,</span>
                <span class="s1">error_msgs</span><span class="s3">=</span><span class="s1">error_msgs</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">weights_store</span><span class="s3">:</span>
                <span class="s1">weights_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">asset_store</span><span class="s3">:</span>
                <span class="s1">asset_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">extract_dir</span><span class="s3">:</span>
                <span class="s1">extract_dir</span><span class="s3">.</span><span class="s1">cleanup</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">failed_saveables</span><span class="s3">:</span>
            <span class="s1">_raise_loading_failure</span><span class="s3">(</span><span class="s1">error_msgs</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">model</span>


<span class="s2">def </span><span class="s1">save_weights_only</span><span class="s3">(</span><span class="s1">model</span><span class="s3">, </span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">objects_to_skip</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Save only the weights of a model to a target filepath (.weights.h5). 
 
    Note: only supports h5 for now. 
    &quot;&quot;&quot;</span>
    <span class="s5"># TODO: if h5 filepath is remote, create the file in a temporary directory</span>
    <span class="s5"># then upload it</span>
    <span class="s1">filepath </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">filepath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;.weights.h5&quot;</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">&quot;Invalid `filepath` argument: expected a `.weights.h5` extension. &quot;</span>
            <span class="s4">f&quot;Received: filepath=</span><span class="s2">{</span><span class="s1">filepath</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s3">)</span>
    <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">objects_to_skip </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">visited_saveables </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">o</span><span class="s3">) </span><span class="s2">for </span><span class="s1">o </span><span class="s2">in </span><span class="s1">objects_to_skip</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">visited_saveables </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
    <span class="s1">_save_state</span><span class="s3">(</span>
        <span class="s1">model</span><span class="s3">,</span>
        <span class="s1">weights_store</span><span class="s3">=</span><span class="s1">weights_store</span><span class="s3">,</span>
        <span class="s1">assets_store</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">inner_path</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">visited_saveables</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">weights_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">load_weights_only</span><span class="s3">(</span>
    <span class="s1">model</span><span class="s3">, </span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">skip_mismatch</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">objects_to_skip</span><span class="s3">=</span><span class="s2">None</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Load the weights of a model from a filepath (.keras or .weights.h5). 
 
    Note: only supports h5 for now. 
    &quot;&quot;&quot;</span>
    <span class="s1">archive </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">filepath </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">filepath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;.weights.h5&quot;</span><span class="s3">):</span>
        <span class="s5"># TODO: download file if h5 filepath is remote</span>
        <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">filepath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;.keras&quot;</span><span class="s3">):</span>
        <span class="s1">archive </span><span class="s3">= </span><span class="s1">zipfile</span><span class="s3">.</span><span class="s1">ZipFile</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
        <span class="s1">weights_store </span><span class="s3">= </span><span class="s1">H5IOStore</span><span class="s3">(</span><span class="s1">_VARS_FNAME_H5</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s1">archive</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>

    <span class="s1">failed_saveables </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">objects_to_skip </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">visited_saveables </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">o</span><span class="s3">) </span><span class="s2">for </span><span class="s1">o </span><span class="s2">in </span><span class="s1">objects_to_skip</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">visited_saveables </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
    <span class="s1">error_msgs </span><span class="s3">= {}</span>
    <span class="s1">_load_state</span><span class="s3">(</span>
        <span class="s1">model</span><span class="s3">,</span>
        <span class="s1">weights_store</span><span class="s3">=</span><span class="s1">weights_store</span><span class="s3">,</span>
        <span class="s1">assets_store</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">inner_path</span><span class="s3">=</span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">skip_mismatch</span><span class="s3">=</span><span class="s1">skip_mismatch</span><span class="s3">,</span>
        <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">visited_saveables</span><span class="s3">,</span>
        <span class="s1">failed_saveables</span><span class="s3">=</span><span class="s1">failed_saveables</span><span class="s3">,</span>
        <span class="s1">error_msgs</span><span class="s3">=</span><span class="s1">error_msgs</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">weights_store</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">archive</span><span class="s3">:</span>
        <span class="s1">archive</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">failed_saveables</span><span class="s3">:</span>
        <span class="s1">_raise_loading_failure</span><span class="s3">(</span><span class="s1">error_msgs</span><span class="s3">, </span><span class="s1">warn_only</span><span class="s3">=</span><span class="s1">skip_mismatch</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_raise_loading_failure</span><span class="s3">(</span><span class="s1">error_msgs</span><span class="s3">, </span><span class="s1">warn_only</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
    <span class="s1">first_key </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">error_msgs</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())[</span><span class="s6">0</span><span class="s3">]</span>
    <span class="s1">ex_saveable</span><span class="s3">, </span><span class="s1">ex_error </span><span class="s3">= </span><span class="s1">error_msgs</span><span class="s3">[</span><span class="s1">first_key</span><span class="s3">]</span>
    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s4">f&quot;A total of </span><span class="s2">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">error_msgs</span><span class="s3">)</span><span class="s2">} </span><span class="s4">objects could not &quot;</span>
        <span class="s4">&quot;be loaded. Example error message for &quot;</span>
        <span class="s4">f&quot;object </span><span class="s2">{</span><span class="s1">ex_saveable</span><span class="s2">}</span><span class="s4">:</span><span class="s2">\n\n</span><span class="s4">&quot;</span>
        <span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">ex_error</span><span class="s2">}\n\n</span><span class="s4">&quot;</span>
        <span class="s4">&quot;List of objects that could not be loaded:</span><span class="s2">\n</span><span class="s4">&quot;</span>
        <span class="s4">f&quot;</span><span class="s2">{</span><span class="s3">[</span><span class="s1">x</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">error_msgs</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()]</span><span class="s2">}</span><span class="s4">&quot;</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">warn_only</span><span class="s3">:</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_write_to_zip_recursively</span><span class="s3">(</span><span class="s1">zipfile_to_save</span><span class="s3">, </span><span class="s1">system_path</span><span class="s3">, </span><span class="s1">zip_path</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">system_path</span><span class="s3">):</span>
        <span class="s1">zipfile_to_save</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">system_path</span><span class="s3">, </span><span class="s1">zip_path</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">file_name </span><span class="s2">in </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">system_path</span><span class="s3">):</span>
            <span class="s1">system_file_path </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">system_path</span><span class="s3">, </span><span class="s1">file_name</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span>
                <span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span>
            <span class="s3">)</span>
            <span class="s1">zip_file_path </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">zip_path</span><span class="s3">, </span><span class="s1">file_name</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span>
                <span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span>
            <span class="s3">)</span>
            <span class="s1">_write_to_zip_recursively</span><span class="s3">(</span>
                <span class="s1">zipfile_to_save</span><span class="s3">, </span><span class="s1">system_file_path</span><span class="s3">, </span><span class="s1">zip_file_path</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">_name_key</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Make sure that private attributes are visited last.&quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">name</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;_&quot;</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">&quot;~&quot; </span><span class="s3">+ </span><span class="s1">name</span>
    <span class="s2">return </span><span class="s1">name</span>


<span class="s2">def </span><span class="s1">_walk_saveable</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">):</span>
    <span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">saving</span><span class="s3">.</span><span class="s1">keras_saveable </span><span class="s2">import </span><span class="s1">KerasSaveable</span>

    <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">, </span><span class="s1">KerasSaveable</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">&quot;Expected object to be an &quot;</span>
            <span class="s4">&quot;instance of `KerasSaveable`, but &quot;</span>
            <span class="s4">f&quot;got </span><span class="s2">{</span><span class="s1">saveable</span><span class="s2">} </span><span class="s4">of type </span><span class="s2">{</span><span class="s1">type</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s3">)</span>

    <span class="s1">obj_type </span><span class="s3">= </span><span class="s1">saveable</span><span class="s3">.</span><span class="s1">_obj_type</span><span class="s3">()</span>
    <span class="s1">attr_skiplist </span><span class="s3">= </span><span class="s1">get_attr_skiplist</span><span class="s3">(</span><span class="s1">obj_type</span><span class="s3">)</span>

    <span class="s5"># Save all layers directly tracked by Sequential and Functional first.</span>
    <span class="s5"># This helps avoid ordering concerns for subclassed Sequential or Functional</span>
    <span class="s5"># models with extra attributes--the internal Keras state take precedence.</span>
    <span class="s2">if </span><span class="s1">obj_type </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;Sequential&quot;</span><span class="s3">, </span><span class="s4">&quot;Functional&quot;</span><span class="s3">):</span>
        <span class="s2">yield </span><span class="s4">&quot;layers&quot;</span><span class="s3">, </span><span class="s1">saveable</span><span class="s3">.</span><span class="s1">layers</span>

    <span class="s2">for </span><span class="s1">child_attr </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">_name_key</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)):</span>
        <span class="s2">if </span><span class="s1">child_attr</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;__&quot;</span><span class="s3">) </span><span class="s2">or </span><span class="s1">child_attr </span><span class="s2">in </span><span class="s1">attr_skiplist</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">child_obj </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">, </span><span class="s1">child_attr</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s5"># Avoid raising the exception when visiting the attributes.</span>
            <span class="s2">continue</span>
        <span class="s2">yield </span><span class="s1">child_attr</span><span class="s3">, </span><span class="s1">child_obj</span>


<span class="s2">def </span><span class="s1">_save_state</span><span class="s3">(</span>
    <span class="s1">saveable</span><span class="s3">,</span>
    <span class="s1">weights_store</span><span class="s3">,</span>
    <span class="s1">assets_store</span><span class="s3">,</span>
    <span class="s1">inner_path</span><span class="s3">,</span>
    <span class="s1">visited_saveables</span><span class="s3">,</span>
<span class="s3">):</span>
    <span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">saving</span><span class="s3">.</span><span class="s1">keras_saveable </span><span class="s2">import </span><span class="s1">KerasSaveable</span>

    <span class="s5"># If the saveable has already been saved, skip it.</span>
    <span class="s2">if </span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">) </span><span class="s2">in </span><span class="s1">visited_saveables</span><span class="s3">:</span>
        <span class="s2">return</span>

    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">, </span><span class="s4">&quot;save_own_variables&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">weights_store</span><span class="s3">:</span>
        <span class="s1">saveable</span><span class="s3">.</span><span class="s1">save_own_variables</span><span class="s3">(</span><span class="s1">weights_store</span><span class="s3">.</span><span class="s1">make</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">))</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">, </span><span class="s4">&quot;save_assets&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">assets_store</span><span class="s3">:</span>
        <span class="s1">saveable</span><span class="s3">.</span><span class="s1">save_assets</span><span class="s3">(</span><span class="s1">assets_store</span><span class="s3">.</span><span class="s1">make</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">))</span>

    <span class="s1">visited_saveables</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">))</span>

    <span class="s5"># Recursively save state of children saveables (layers, optimizers, etc.)</span>
    <span class="s2">for </span><span class="s1">child_attr</span><span class="s3">, </span><span class="s1">child_obj </span><span class="s2">in </span><span class="s1">_walk_saveable</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">child_obj</span><span class="s3">, </span><span class="s1">KerasSaveable</span><span class="s3">):</span>
            <span class="s1">_save_state</span><span class="s3">(</span>
                <span class="s1">child_obj</span><span class="s3">,</span>
                <span class="s1">weights_store</span><span class="s3">,</span>
                <span class="s1">assets_store</span><span class="s3">,</span>
                <span class="s1">inner_path</span><span class="s3">=</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">, </span><span class="s1">child_attr</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span>
                    <span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span>
                <span class="s3">),</span>
                <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">visited_saveables</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">child_obj</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">, </span><span class="s1">set</span><span class="s3">)):</span>
            <span class="s1">_save_container_state</span><span class="s3">(</span>
                <span class="s1">child_obj</span><span class="s3">,</span>
                <span class="s1">weights_store</span><span class="s3">,</span>
                <span class="s1">assets_store</span><span class="s3">,</span>
                <span class="s1">inner_path</span><span class="s3">=</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">, </span><span class="s1">child_attr</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span>
                    <span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span>
                <span class="s3">),</span>
                <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">visited_saveables</span><span class="s3">,</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">_load_state</span><span class="s3">(</span>
    <span class="s1">saveable</span><span class="s3">,</span>
    <span class="s1">weights_store</span><span class="s3">,</span>
    <span class="s1">assets_store</span><span class="s3">,</span>
    <span class="s1">inner_path</span><span class="s3">,</span>
    <span class="s1">skip_mismatch</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">failed_saveables</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">error_msgs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
<span class="s3">):</span>
    <span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">saving</span><span class="s3">.</span><span class="s1">keras_saveable </span><span class="s2">import </span><span class="s1">KerasSaveable</span>

    <span class="s2">if </span><span class="s1">visited_saveables </span><span class="s2">and </span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">) </span><span class="s2">in </span><span class="s1">visited_saveables</span><span class="s3">:</span>
        <span class="s2">return</span>

    <span class="s1">failure </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">, </span><span class="s4">&quot;load_own_variables&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">weights_store</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">skip_mismatch </span><span class="s2">or </span><span class="s1">failed_saveables </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">saveable</span><span class="s3">.</span><span class="s1">load_own_variables</span><span class="s3">(</span><span class="s1">weights_store</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">))</span>
            <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">failed_saveables</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">))</span>
                <span class="s1">error_msgs</span><span class="s3">[</span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">)] = </span><span class="s1">saveable</span><span class="s3">, </span><span class="s1">e</span>
                <span class="s1">failure </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">saveable</span><span class="s3">.</span><span class="s1">load_own_variables</span><span class="s3">(</span><span class="s1">weights_store</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">))</span>

    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">, </span><span class="s4">&quot;load_assets&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">assets_store</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">skip_mismatch </span><span class="s2">or </span><span class="s1">failed_saveables </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">saveable</span><span class="s3">.</span><span class="s1">load_assets</span><span class="s3">(</span><span class="s1">assets_store</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">))</span>
            <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">failed_saveables</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">))</span>
                <span class="s1">error_msgs</span><span class="s3">[</span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">)] = </span><span class="s1">saveable</span><span class="s3">, </span><span class="s1">e</span>
                <span class="s1">failure </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">saveable</span><span class="s3">.</span><span class="s1">load_assets</span><span class="s3">(</span><span class="s1">assets_store</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">))</span>

    <span class="s2">if </span><span class="s1">failed_saveables </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">currently_failed </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">failed_saveables</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">currently_failed </span><span class="s3">= </span><span class="s6">0</span>

    <span class="s5"># Recursively load states for Keras saveables such as layers/optimizers.</span>
    <span class="s2">for </span><span class="s1">child_attr</span><span class="s3">, </span><span class="s1">child_obj </span><span class="s2">in </span><span class="s1">_walk_saveable</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">child_obj</span><span class="s3">, </span><span class="s1">KerasSaveable</span><span class="s3">):</span>
            <span class="s1">_load_state</span><span class="s3">(</span>
                <span class="s1">child_obj</span><span class="s3">,</span>
                <span class="s1">weights_store</span><span class="s3">,</span>
                <span class="s1">assets_store</span><span class="s3">,</span>
                <span class="s1">inner_path</span><span class="s3">=</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">, </span><span class="s1">child_attr</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span>
                    <span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span>
                <span class="s3">),</span>
                <span class="s1">skip_mismatch</span><span class="s3">=</span><span class="s1">skip_mismatch</span><span class="s3">,</span>
                <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">visited_saveables</span><span class="s3">,</span>
                <span class="s1">failed_saveables</span><span class="s3">=</span><span class="s1">failed_saveables</span><span class="s3">,</span>
                <span class="s1">error_msgs</span><span class="s3">=</span><span class="s1">error_msgs</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">child_obj</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">, </span><span class="s1">set</span><span class="s3">)):</span>
            <span class="s1">_load_container_state</span><span class="s3">(</span>
                <span class="s1">child_obj</span><span class="s3">,</span>
                <span class="s1">weights_store</span><span class="s3">,</span>
                <span class="s1">assets_store</span><span class="s3">,</span>
                <span class="s1">inner_path</span><span class="s3">=</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">, </span><span class="s1">child_attr</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span>
                    <span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span>
                <span class="s3">),</span>
                <span class="s1">skip_mismatch</span><span class="s3">=</span><span class="s1">skip_mismatch</span><span class="s3">,</span>
                <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">visited_saveables</span><span class="s3">,</span>
                <span class="s1">failed_saveables</span><span class="s3">=</span><span class="s1">failed_saveables</span><span class="s3">,</span>
                <span class="s1">error_msgs</span><span class="s3">=</span><span class="s1">error_msgs</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">failed_saveables </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">newly_failed </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">failed_saveables</span><span class="s3">) - </span><span class="s1">currently_failed</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">newly_failed </span><span class="s3">= </span><span class="s6">0</span>

    <span class="s2">if not </span><span class="s1">failure</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">visited_saveables </span><span class="s2">is not None and </span><span class="s1">newly_failed </span><span class="s3">&lt;= </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">visited_saveables</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">) </span><span class="s2">in </span><span class="s1">failed_saveables</span><span class="s3">:</span>
            <span class="s1">failed_saveables</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">))</span>
            <span class="s1">error_msgs</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">_save_container_state</span><span class="s3">(</span>
    <span class="s1">container</span><span class="s3">, </span><span class="s1">weights_store</span><span class="s3">, </span><span class="s1">assets_store</span><span class="s3">, </span><span class="s1">inner_path</span><span class="s3">, </span><span class="s1">visited_saveables</span>
<span class="s3">):</span>
    <span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">saving</span><span class="s3">.</span><span class="s1">keras_saveable </span><span class="s2">import </span><span class="s1">KerasSaveable</span>

    <span class="s1">used_names </span><span class="s3">= {}</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">container</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
        <span class="s1">container </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">container</span><span class="s3">.</span><span class="s1">values</span><span class="s3">())</span>

    <span class="s2">for </span><span class="s1">saveable </span><span class="s2">in </span><span class="s1">container</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">, </span><span class="s1">KerasSaveable</span><span class="s3">):</span>
            <span class="s5"># Do NOT address the saveable via `saveable.name`, since</span>
            <span class="s5"># names are usually autogenerated and thus not reproducible</span>
            <span class="s5"># (i.e. they may vary across two instances of the same model).</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">naming</span><span class="s3">.</span><span class="s1">to_snake_case</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">used_names</span><span class="s3">:</span>
                <span class="s1">used_names</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] += </span><span class="s6">1</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s4">_</span><span class="s2">{</span><span class="s1">used_names</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">used_names</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s6">0</span>
            <span class="s1">_save_state</span><span class="s3">(</span>
                <span class="s1">saveable</span><span class="s3">,</span>
                <span class="s1">weights_store</span><span class="s3">,</span>
                <span class="s1">assets_store</span><span class="s3">,</span>
                <span class="s1">inner_path</span><span class="s3">=</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">, </span><span class="s1">name</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span><span class="s3">),</span>
                <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">visited_saveables</span><span class="s3">,</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">_load_container_state</span><span class="s3">(</span>
    <span class="s1">container</span><span class="s3">,</span>
    <span class="s1">weights_store</span><span class="s3">,</span>
    <span class="s1">assets_store</span><span class="s3">,</span>
    <span class="s1">inner_path</span><span class="s3">,</span>
    <span class="s1">skip_mismatch</span><span class="s3">,</span>
    <span class="s1">visited_saveables</span><span class="s3">,</span>
    <span class="s1">failed_saveables</span><span class="s3">,</span>
    <span class="s1">error_msgs</span><span class="s3">,</span>
<span class="s3">):</span>
    <span class="s2">from </span><span class="s1">keras</span><span class="s3">.</span><span class="s1">src</span><span class="s3">.</span><span class="s1">saving</span><span class="s3">.</span><span class="s1">keras_saveable </span><span class="s2">import </span><span class="s1">KerasSaveable</span>

    <span class="s1">used_names </span><span class="s3">= {}</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">container</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
        <span class="s1">container </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">container</span><span class="s3">.</span><span class="s1">values</span><span class="s3">())</span>

    <span class="s2">for </span><span class="s1">saveable </span><span class="s2">in </span><span class="s1">container</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">, </span><span class="s1">KerasSaveable</span><span class="s3">):</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">naming</span><span class="s3">.</span><span class="s1">to_snake_case</span><span class="s3">(</span><span class="s1">saveable</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">used_names</span><span class="s3">:</span>
                <span class="s1">used_names</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] += </span><span class="s6">1</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s4">_</span><span class="s2">{</span><span class="s1">used_names</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">used_names</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s6">0</span>
            <span class="s1">_load_state</span><span class="s3">(</span>
                <span class="s1">saveable</span><span class="s3">,</span>
                <span class="s1">weights_store</span><span class="s3">,</span>
                <span class="s1">assets_store</span><span class="s3">,</span>
                <span class="s1">inner_path</span><span class="s3">=</span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">inner_path</span><span class="s3">, </span><span class="s1">name</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span><span class="s3">),</span>
                <span class="s1">skip_mismatch</span><span class="s3">=</span><span class="s1">skip_mismatch</span><span class="s3">,</span>
                <span class="s1">visited_saveables</span><span class="s3">=</span><span class="s1">visited_saveables</span><span class="s3">,</span>
                <span class="s1">failed_saveables</span><span class="s3">=</span><span class="s1">failed_saveables</span><span class="s3">,</span>
                <span class="s1">error_msgs</span><span class="s3">=</span><span class="s1">error_msgs</span><span class="s3">,</span>
            <span class="s3">)</span>


<span class="s2">class </span><span class="s1">DiskIOStore</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Asset store backed by disk storage. 
 
    If `archive` is specified, then `root_path` refers to the filename 
    inside the archive. 
 
    If `archive` is not specified, then `root_path` refers to the full path of 
    the target directory. 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">mode</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">root_path </span><span class="s3">= </span><span class="s1">root_path</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">archive </span><span class="s3">= </span><span class="s1">archive</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir </span><span class="s3">= </span><span class="s1">get_temp_dir</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;r&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">.</span><span class="s1">extractall</span><span class="s3">(</span><span class="s1">path</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">root_path</span>
            <span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;w&quot;</span><span class="s3">:</span>
                <span class="s1">file_utils</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;r&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir </span><span class="s3">= </span><span class="s1">root_path</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir </span><span class="s3">= </span><span class="s1">get_temp_dir</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">root_path</span>
                <span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span><span class="s3">)</span>
                <span class="s1">file_utils</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">make</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir</span><span class="s3">, </span><span class="s1">path</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s1">file_utils</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">path</span>

    <span class="s2">def </span><span class="s1">get</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir</span><span class="s3">, </span><span class="s1">path</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;/&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">path</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;w&quot; </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">:</span>
            <span class="s1">_write_to_zip_recursively</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">working_dir</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">root_path</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir </span><span class="s2">and </span><span class="s1">file_utils</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir</span><span class="s3">):</span>
            <span class="s1">file_utils</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tmp_dir</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">H5IOStore</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Numerical variable store backed by HDF5. 
 
        If `archive` is specified, then `root_path` refers to the filename 
        inside the archive. 
 
        If `archive` is not specified, then `root_path` refers to the path of 
        the h5 file on disk. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">root_path </span><span class="s3">= </span><span class="s1">root_path</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">mode</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">archive </span><span class="s3">= </span><span class="s1">archive</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">io_file </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;w&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">io_file </span><span class="s3">= </span><span class="s1">io</span><span class="s3">.</span><span class="s1">BytesIO</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">io_file </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">root_path</span><span class="s3">, </span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file </span><span class="s3">= </span><span class="s1">h5py</span><span class="s3">.</span><span class="s1">File</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">io_file</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file </span><span class="s3">= </span><span class="s1">h5py</span><span class="s3">.</span><span class="s1">File</span><span class="s3">(</span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">make</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">H5Entry</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">H5Entry</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;w&quot; </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">.</span><span class="s1">writestr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">io_file</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">())</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">io_file</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">io_file</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">H5Entry</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Leaf entry in a H5IOStore.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">h5_file</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file </span><span class="s3">= </span><span class="s1">h5_file</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">path</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">mode</span>

        <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;w&quot;</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">path</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">group </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">.</span><span class="s1">create_group</span><span class="s3">(</span><span class="s4">&quot;vars&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">group </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">.</span><span class="s1">create_group</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">).</span><span class="s1">create_group</span><span class="s3">(</span>
                    <span class="s4">&quot;vars&quot;</span>
                <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">found </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">if not </span><span class="s1">path</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">group </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">[</span><span class="s4">&quot;vars&quot;</span><span class="s3">]</span>
                <span class="s1">found </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">elif </span><span class="s1">path </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file </span><span class="s2">and </span><span class="s4">&quot;vars&quot; </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">[</span><span class="s1">path</span><span class="s3">]:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">group </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">[</span><span class="s1">path</span><span class="s3">][</span><span class="s4">&quot;vars&quot;</span><span class="s3">]</span>
                <span class="s1">found </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s5"># No hit.</span>
                <span class="s5"># Fix for 2.13 compatibility</span>
                <span class="s2">if </span><span class="s4">&quot;_layer_checkpoint_dependencies&quot; </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">:</span>
                    <span class="s1">path </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span>
                        <span class="s4">&quot;layers&quot;</span><span class="s3">, </span><span class="s4">&quot;_layer_checkpoint_dependencies&quot;</span>
                    <span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">path</span>
                    <span class="s2">if </span><span class="s1">path </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file </span><span class="s2">and </span><span class="s4">&quot;vars&quot; </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">[</span><span class="s1">path</span><span class="s3">]:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">group </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">h5_file</span><span class="s3">[</span><span class="s1">path</span><span class="s3">][</span><span class="s4">&quot;vars&quot;</span><span class="s3">]</span>
                        <span class="s1">found </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">if not </span><span class="s1">found</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">group </span><span class="s3">= {}</span>

    <span class="s2">def </span><span class="s1">__len__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">group</span><span class="s3">.</span><span class="s1">__len__</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">group</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">items</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">group</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">group</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">__setitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">!= </span><span class="s4">&quot;w&quot;</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Setting a value is only allowed in write mode.&quot;</span><span class="s3">)</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">backend</span><span class="s3">.</span><span class="s1">convert_to_numpy</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">backend</span><span class="s3">.</span><span class="s1">standardize_dtype</span><span class="s3">(</span><span class="s1">value</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">) == </span><span class="s4">&quot;bfloat16&quot;</span><span class="s3">:</span>
            <span class="s1">ds </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">group</span><span class="s3">.</span><span class="s1">create_dataset</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">data</span><span class="s3">=</span><span class="s1">value</span><span class="s3">)</span>
            <span class="s1">ds</span><span class="s3">.</span><span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;dtype&quot;</span><span class="s3">] = </span><span class="s4">&quot;bfloat16&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">group</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] = </span><span class="s1">value</span>

    <span class="s2">def </span><span class="s1">__getitem__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">value </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">group</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s4">&quot;dtype&quot; </span><span class="s2">in </span><span class="s1">value</span><span class="s3">.</span><span class="s1">attrs </span><span class="s2">and </span><span class="s1">value</span><span class="s3">.</span><span class="s1">attrs</span><span class="s3">[</span><span class="s4">&quot;dtype&quot;</span><span class="s3">] == </span><span class="s4">&quot;bfloat16&quot;</span><span class="s3">:</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">ml_dtypes</span><span class="s3">.</span><span class="s1">bfloat16</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">value</span>


<span class="s2">class </span><span class="s1">NpzIOStore</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">archive</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Numerical variable store backed by NumPy.savez/load. 
 
         If `archive` is specified, then `root_path` refers to the filename 
        inside the archive. 
 
        If `archive` is not specified, then `root_path` refers to the path of 
        the npz file on disk. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">root_path </span><span class="s3">= </span><span class="s1">root_path</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">mode</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">archive </span><span class="s3">= </span><span class="s1">archive</span>
        <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;w&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">contents </span><span class="s3">= {}</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">f </span><span class="s3">= </span><span class="s1">archive</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;r&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">f </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;rb&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">contents </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">load</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">f</span><span class="s3">, </span><span class="s1">allow_pickle</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">make</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">[</span><span class="s4">&quot;__root__&quot;</span><span class="s3">] = {}</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">[</span><span class="s4">&quot;__root__&quot;</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">[</span><span class="s1">path</span><span class="s3">] = {}</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">[</span><span class="s1">path</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">get</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s4">&quot;__root__&quot; </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">[</span><span class="s4">&quot;__root__&quot;</span><span class="s3">])</span>
            <span class="s2">return </span><span class="s3">{}</span>
        <span class="s2">if </span><span class="s1">path </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">[</span><span class="s1">path</span><span class="s3">].</span><span class="s1">tolist</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s3">{}</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;w&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">archive</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w&quot;</span><span class="s3">, </span><span class="s1">force_zip64</span><span class="s3">=</span><span class="s2">True</span>
                <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">f </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">root_path</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;wb&quot;</span><span class="s3">)</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">savez</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">f</span><span class="s3">, **</span><span class="s1">self</span><span class="s3">.</span><span class="s1">contents</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">get_temp_dir</span><span class="s3">():</span>
    <span class="s1">temp_dir </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">mkdtemp</span><span class="s3">()</span>
    <span class="s1">testfile </span><span class="s3">= </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">TemporaryFile</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s1">temp_dir</span><span class="s3">)</span>
    <span class="s1">testfile</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
    <span class="s2">return </span><span class="s1">temp_dir</span>


<span class="s2">def </span><span class="s1">get_attr_skiplist</span><span class="s3">(</span><span class="s1">obj_type</span><span class="s3">):</span>
    <span class="s1">skiplist </span><span class="s3">= </span><span class="s1">global_state</span><span class="s3">.</span><span class="s1">get_global_attribute</span><span class="s3">(</span>
        <span class="s4">f&quot;saving_attr_skiplist_</span><span class="s2">{</span><span class="s1">obj_type</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s2">None</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">skiplist </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">skiplist</span>

    <span class="s1">skiplist </span><span class="s3">= [</span>
        <span class="s4">&quot;_self_unconditional_dependency_names&quot;</span><span class="s3">,</span>
    <span class="s3">]</span>
    <span class="s2">if </span><span class="s1">obj_type </span><span class="s3">== </span><span class="s4">&quot;Layer&quot;</span><span class="s3">:</span>
        <span class="s1">ref_obj </span><span class="s3">= </span><span class="s1">Layer</span><span class="s3">()</span>
        <span class="s1">skiplist </span><span class="s3">+= </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">ref_obj</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">obj_type </span><span class="s3">== </span><span class="s4">&quot;Functional&quot;</span><span class="s3">:</span>
        <span class="s1">ref_obj </span><span class="s3">= </span><span class="s1">Layer</span><span class="s3">()</span>
        <span class="s1">skiplist </span><span class="s3">+= </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">ref_obj</span><span class="s3">) + [</span><span class="s4">&quot;operations&quot;</span><span class="s3">, </span><span class="s4">&quot;_operations&quot;</span><span class="s3">]</span>
    <span class="s2">elif </span><span class="s1">obj_type </span><span class="s3">== </span><span class="s4">&quot;Sequential&quot;</span><span class="s3">:</span>
        <span class="s1">ref_obj </span><span class="s3">= </span><span class="s1">Layer</span><span class="s3">()</span>
        <span class="s1">skiplist </span><span class="s3">+= </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">ref_obj</span><span class="s3">) + [</span><span class="s4">&quot;_functional&quot;</span><span class="s3">]</span>
    <span class="s2">elif </span><span class="s1">obj_type </span><span class="s3">== </span><span class="s4">&quot;Metric&quot;</span><span class="s3">:</span>
        <span class="s1">ref_obj_a </span><span class="s3">= </span><span class="s1">Metric</span><span class="s3">()</span>
        <span class="s1">ref_obj_b </span><span class="s3">= </span><span class="s1">CompileMetrics</span><span class="s3">([], [])</span>
        <span class="s1">skiplist </span><span class="s3">+= </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">ref_obj_a</span><span class="s3">) + </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">ref_obj_b</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">obj_type </span><span class="s3">== </span><span class="s4">&quot;Optimizer&quot;</span><span class="s3">:</span>
        <span class="s1">ref_obj </span><span class="s3">= </span><span class="s1">Optimizer</span><span class="s3">(</span><span class="s6">1.0</span><span class="s3">)</span>
        <span class="s1">skiplist </span><span class="s3">+= </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">ref_obj</span><span class="s3">)</span>
        <span class="s1">skiplist</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s4">&quot;variables&quot;</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">obj_type </span><span class="s3">== </span><span class="s4">&quot;Loss&quot;</span><span class="s3">:</span>
        <span class="s1">ref_obj </span><span class="s3">= </span><span class="s1">Loss</span><span class="s3">()</span>
        <span class="s1">skiplist </span><span class="s3">+= </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">ref_obj</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">f&quot;get_attr_skiplist got invalid </span><span class="s2">{</span><span class="s1">obj_type</span><span class="s3">=</span><span class="s2">}</span><span class="s4">. &quot;</span>
            <span class="s4">&quot;Accepted values for `obj_type` are &quot;</span>
            <span class="s4">&quot;['Layer', 'Functional', 'Sequential', 'Metric', &quot;</span>
            <span class="s4">&quot;'Optimizer', 'Loss']&quot;</span>
        <span class="s3">)</span>

    <span class="s1">global_state</span><span class="s3">.</span><span class="s1">set_global_attribute</span><span class="s3">(</span>
        <span class="s4">f&quot;saving_attr_skiplist_</span><span class="s2">{</span><span class="s1">obj_type</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">skiplist</span>
    <span class="s3">)</span>
    <span class="s2">return </span><span class="s1">skiplist</span>


<span class="s2">def </span><span class="s1">is_memory_sufficient</span><span class="s3">(</span><span class="s1">model</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check if there is sufficient memory to load the model into memory. 
 
    If psutil is installed, we can use it to determine whether the memory is 
    sufficient. Otherwise, we use a predefined value of 1 GB for available 
    memory. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">psutil </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">available_memory </span><span class="s3">= </span><span class="s6">1024 </span><span class="s3">* </span><span class="s6">1024 </span><span class="s3">* </span><span class="s6">1024  </span><span class="s5"># 1 GB in bytes</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">available_memory </span><span class="s3">= </span><span class="s1">psutil</span><span class="s3">.</span><span class="s1">virtual_memory</span><span class="s3">().</span><span class="s1">available  </span><span class="s5"># In bytes</span>
    <span class="s2">return </span><span class="s3">(</span>
        <span class="s1">weight_memory_size</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">variables</span><span class="s3">)</span>
        <span class="s3">&lt; </span><span class="s1">available_memory </span><span class="s3">* </span><span class="s1">_MEMORY_UPPER_BOUND</span>
    <span class="s3">)</span>
</pre>
</body>
</html>