<html>
<head>
<title>test_dataset.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_dataset.py</font>
</center></td></tr></table>
<pre><span class="s0"># This file is part of h5py, a Python interface to the HDF5 library.</span>
<span class="s0">#</span>
<span class="s0"># http://www.h5py.org</span>
<span class="s0">#</span>
<span class="s0"># Copyright 2008-2013 Andrew Collette and contributors</span>
<span class="s0">#</span>
<span class="s0"># License:  Standard 3-clause BSD; see &quot;license.txt&quot; for full license terms</span>
<span class="s0">#           and contributor agreement.</span>

<span class="s2">&quot;&quot;&quot; 
    Dataset testing operations. 
 
    Tests all dataset operations, including creation, with the exception of: 
 
    1. Slicing operations for read and write, handled by module test_slicing 
    2. Type conversion for read and write (currently untested) 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">pathlib</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">platform</span>
<span class="s3">import </span><span class="s1">pytest</span>
<span class="s3">import </span><span class="s1">warnings</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">common </span><span class="s3">import </span><span class="s1">ut</span><span class="s4">, </span><span class="s1">TestCase</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">data_files </span><span class="s3">import </span><span class="s1">get_data_file_path</span>
<span class="s3">from </span><span class="s1">h5py </span><span class="s3">import </span><span class="s1">File</span><span class="s4">, </span><span class="s1">Group</span><span class="s4">, </span><span class="s1">Dataset</span>
<span class="s3">from </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">is_empty_dataspace</span><span class="s4">, </span><span class="s1">product</span>
<span class="s3">from </span><span class="s1">h5py </span><span class="s3">import </span><span class="s1">h5f</span><span class="s4">, </span><span class="s1">h5t</span>
<span class="s3">from </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5py_warnings </span><span class="s3">import </span><span class="s1">H5pyDeprecationWarning</span>
<span class="s3">from </span><span class="s1">h5py </span><span class="s3">import </span><span class="s1">version</span>
<span class="s3">import </span><span class="s1">h5py</span>
<span class="s3">import </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">selections </span><span class="s3">as </span><span class="s1">sel</span>


<span class="s3">class </span><span class="s1">BaseDataset</span><span class="s4">(</span><span class="s1">TestCase</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">File</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">(), </span><span class="s5">'w'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">tearDown</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestRepr</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
        Feature: repr(Dataset) behaves sensibly 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_repr_open</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; repr() works on live and dead datasets &quot;&quot;&quot;</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">4</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">), </span><span class="s1">str</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestCreateShape</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can be created from a shape only 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create_scalar</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create a scalar dataset &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, ())</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, ())</span>

    <span class="s3">def </span><span class="s1">test_create_simple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create a size-1 dataset &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_create_integer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create a size-1 dataset with integer shape&quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_create_extended</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create an extended dataset &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">63</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">63</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">size</span><span class="s4">, </span><span class="s6">63</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">10</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">10</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">size</span><span class="s4">, (</span><span class="s6">60</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_create_integer_extended</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create an extended dataset &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s6">63</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">63</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">size</span><span class="s4">, </span><span class="s6">63</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">10</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">10</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">size</span><span class="s4">, (</span><span class="s6">60</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_default_dtype</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Confirm that the default dtype is float &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">63</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'=f4'</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_missing_shape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Missing shape raises TypeError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_long_double</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Confirm that the default dtype is float &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">63</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">longdouble</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">machine</span><span class="s4">() </span><span class="s3">in </span><span class="s4">[</span><span class="s5">'ppc64le'</span><span class="s4">]:</span>
            <span class="s1">pytest</span><span class="s4">.</span><span class="s1">xfail</span><span class="s4">(</span><span class="s5">&quot;Storage of long double deactivated on %s&quot; </span><span class="s4">% </span><span class="s1">platform</span><span class="s4">.</span><span class="s1">machine</span><span class="s4">())</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">longdouble</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s3">not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">np</span><span class="s4">, </span><span class="s5">&quot;complex256&quot;</span><span class="s4">), </span><span class="s5">&quot;No support for complex256&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_complex256</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Confirm that the default dtype is float &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">63</span><span class="s4">,),</span>
                                     <span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'complex256'</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'complex256'</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_name_bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s7">b'foo'</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,))</span>

        <span class="s1">dset2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s7">b'bar/baz'</span><span class="s4">, (</span><span class="s6">2</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset2</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">2</span><span class="s4">,))</span>

<span class="s3">class </span><span class="s1">TestCreateData</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can be created from existing data 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create_scalar</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create a scalar dataset from existing array &quot;&quot;&quot;</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">data</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">data</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create_extended</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create an extended dataset from existing data &quot;&quot;&quot;</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">63</span><span class="s4">,), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">data</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">data</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dataset_intermediate_group</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create dataset with missing intermediate groups &quot;&quot;&quot;</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;/foo/bar/baz&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'&lt;i4'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">Dataset</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s5">&quot;/foo/bar/baz&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_reshape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create from existing data, and make it fit a new shape &quot;&quot;&quot;</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">30</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s1">data</span><span class="s4">=</span><span class="s1">data</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[...], </span><span class="s1">data</span><span class="s4">.</span><span class="s1">reshape</span><span class="s4">((</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">)))</span>

    <span class="s3">def </span><span class="s1">test_appropriate_low_level_id</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot; Binding Dataset to a non-DatasetID identifier fails with ValueError &quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">Dataset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'/'</span><span class="s4">].</span><span class="s1">id</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">check_h5_string</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dset</span><span class="s4">, </span><span class="s1">cset</span><span class="s4">, </span><span class="s1">length</span><span class="s4">):</span>
        <span class="s1">tid </span><span class="s4">= </span><span class="s1">dset</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">()</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">, </span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">TypeStringID</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">tid</span><span class="s4">.</span><span class="s1">get_cset</span><span class="s4">() == </span><span class="s1">cset</span>
        <span class="s3">if </span><span class="s1">length </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">tid</span><span class="s4">.</span><span class="s1">is_variable_str</span><span class="s4">()</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert not </span><span class="s1">tid</span><span class="s4">.</span><span class="s1">is_variable_str</span><span class="s4">()</span>
            <span class="s3">assert </span><span class="s1">tid</span><span class="s4">.</span><span class="s1">get_size</span><span class="s4">() == </span><span class="s1">length</span>

    <span class="s3">def </span><span class="s1">test_create_bytestring</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Creating dataset with byte string yields vlen ASCII dataset &quot;&quot;&quot;</span>
        <span class="s3">def </span><span class="s1">check_vlen_ascii</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">check_h5_string</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">, </span><span class="s1">length</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">check_vlen_ascii</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s7">b'abc'</span><span class="s4">))</span>
        <span class="s1">check_vlen_ascii</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'b'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=[</span><span class="s7">b'abc'</span><span class="s4">, </span><span class="s7">b'def'</span><span class="s4">]))</span>
        <span class="s1">check_vlen_ascii</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'c'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=[[</span><span class="s7">b'abc'</span><span class="s4">], [</span><span class="s7">b'def'</span><span class="s4">]]))</span>
        <span class="s1">check_vlen_ascii</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span>
            <span class="s5">'d'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">b'abc'</span><span class="s4">, </span><span class="s7">b'def'</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_create_np_s</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">b'abc'</span><span class="s4">, </span><span class="s7">b'def'</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'S3'</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">check_h5_string</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">, </span><span class="s1">length</span><span class="s4">=</span><span class="s6">3</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create_strings</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">def </span><span class="s1">check_vlen_utf8</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">check_h5_string</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_UTF8</span><span class="s4">, </span><span class="s1">length</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">check_vlen_utf8</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s5">'abc'</span><span class="s4">))</span>
        <span class="s1">check_vlen_utf8</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'b'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=[</span><span class="s5">'abc'</span><span class="s4">, </span><span class="s5">'def'</span><span class="s4">]))</span>
        <span class="s1">check_vlen_utf8</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'c'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=[[</span><span class="s5">'abc'</span><span class="s4">], [</span><span class="s5">'def'</span><span class="s4">]]))</span>
        <span class="s1">check_vlen_utf8</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span>
            <span class="s5">'d'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s5">'abc'</span><span class="s4">, </span><span class="s5">'def'</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_create_np_u</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">b'abc'</span><span class="s4">, </span><span class="s7">b'def'</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'U3'</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_empty_create_via_None_shape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">is_empty_dataspace</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">].</span><span class="s1">id</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_empty_create_via_Empty_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">Empty</span><span class="s4">(</span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'f'</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">is_empty_dataspace</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">].</span><span class="s1">id</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_create_incompatible_data</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0"># Shape tuple is incompatible with data</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=</span><span class="s6">4</span><span class="s4">, </span><span class="s1">data</span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestReadDirectly</span><span class="s4">:</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Read data directly from Dataset into a Numpy array 
    &quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
        <span class="s5">'source_shape,dest_shape,source_sel,dest_sel'</span><span class="s4">,</span>
        <span class="s4">[</span>
            <span class="s4">((</span><span class="s6">100</span><span class="s4">,), (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">10</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">50</span><span class="s4">:</span><span class="s6">60</span><span class="s4">]),</span>
            <span class="s4">((</span><span class="s6">70</span><span class="s4">,), (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">50</span><span class="s4">:</span><span class="s6">60</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">90</span><span class="s4">:]),</span>
            <span class="s4">((</span><span class="s6">30</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">20</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[:</span><span class="s6">20</span><span class="s4">, :], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[:, :</span><span class="s6">10</span><span class="s4">]),</span>
            <span class="s4">((</span><span class="s6">5</span><span class="s4">, </span><span class="s6">7</span><span class="s4">, </span><span class="s6">9</span><span class="s4">), (</span><span class="s6">6</span><span class="s4">,), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">2</span><span class="s4">, :</span><span class="s6">6</span><span class="s4">, </span><span class="s6">3</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[:]),</span>
        <span class="s4">])</span>
    <span class="s3">def </span><span class="s1">test_read_direct</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">, </span><span class="s1">source_shape</span><span class="s4">, </span><span class="s1">dest_shape</span><span class="s4">, </span><span class="s1">source_sel</span><span class="s4">, </span><span class="s1">dest_sel</span><span class="s4">):</span>
        <span class="s1">source_values </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s1">product</span><span class="s4">(</span><span class="s1">source_shape</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">&quot;int64&quot;</span><span class="s4">).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s1">source_shape</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;dset&quot;</span><span class="s4">, </span><span class="s1">source_shape</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">source_values</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">full</span><span class="s4">(</span><span class="s1">dest_shape</span><span class="s4">, -</span><span class="s6">1</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">&quot;int64&quot;</span><span class="s4">)</span>
        <span class="s1">expected </span><span class="s4">= </span><span class="s1">arr</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">expected</span><span class="s4">[</span><span class="s1">dest_sel</span><span class="s4">] = </span><span class="s1">source_values</span><span class="s4">[</span><span class="s1">source_sel</span><span class="s4">]</span>

        <span class="s1">dset</span><span class="s4">.</span><span class="s1">read_direct</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">, </span><span class="s1">source_sel</span><span class="s4">, </span><span class="s1">dest_sel</span><span class="s4">)</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">, </span><span class="s1">expected</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_no_sel</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;dset&quot;</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">10</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">&quot;int64&quot;</span><span class="s4">))</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">&quot;int64&quot;</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">.</span><span class="s1">read_direct</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">)</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">10</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">&quot;int64&quot;</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_empty</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">):</span>
        <span class="s1">empty_dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;edset&quot;</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int64'</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">100</span><span class="s4">,), </span><span class="s5">'int64'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">empty_dset</span><span class="s4">.</span><span class="s1">read_direct</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">10</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">50</span><span class="s4">:</span><span class="s6">60</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_wrong_shape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;dset&quot;</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int64'</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">200</span><span class="s4">,))</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">dset</span><span class="s4">.</span><span class="s1">read_direct</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_not_c_contiguous</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;dset&quot;</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int64'</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), </span><span class="s1">order</span><span class="s4">=</span><span class="s5">'F'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">dset</span><span class="s4">.</span><span class="s1">read_direct</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestWriteDirectly</span><span class="s4">:</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Write Numpy array directly into Dataset 
    &quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
        <span class="s5">'source_shape,dest_shape,source_sel,dest_sel'</span><span class="s4">,</span>
        <span class="s4">[</span>
            <span class="s4">((</span><span class="s6">100</span><span class="s4">,), (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">10</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">50</span><span class="s4">:</span><span class="s6">60</span><span class="s4">]),</span>
            <span class="s4">((</span><span class="s6">70</span><span class="s4">,), (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">50</span><span class="s4">:</span><span class="s6">60</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">90</span><span class="s4">:]),</span>
            <span class="s4">((</span><span class="s6">30</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">20</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[:</span><span class="s6">20</span><span class="s4">, :], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[:, :</span><span class="s6">10</span><span class="s4">]),</span>
            <span class="s4">((</span><span class="s6">5</span><span class="s4">, </span><span class="s6">7</span><span class="s4">, </span><span class="s6">9</span><span class="s4">), (</span><span class="s6">6</span><span class="s4">,), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">2</span><span class="s4">, :</span><span class="s6">6</span><span class="s4">, </span><span class="s6">3</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[:]),</span>
        <span class="s4">])</span>
    <span class="s3">def </span><span class="s1">test_write_direct</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">, </span><span class="s1">source_shape</span><span class="s4">, </span><span class="s1">dest_shape</span><span class="s4">, </span><span class="s1">source_sel</span><span class="s4">, </span><span class="s1">dest_sel</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'dset'</span><span class="s4">, </span><span class="s1">dest_shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int32'</span><span class="s4">, </span><span class="s1">fillvalue</span><span class="s4">=-</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s1">product</span><span class="s4">(</span><span class="s1">source_shape</span><span class="s4">)).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s1">source_shape</span><span class="s4">)</span>
        <span class="s1">expected </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">full</span><span class="s4">(</span><span class="s1">dest_shape</span><span class="s4">, -</span><span class="s6">1</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int32'</span><span class="s4">)</span>
        <span class="s1">expected</span><span class="s4">[</span><span class="s1">dest_sel</span><span class="s4">] = </span><span class="s1">arr</span><span class="s4">[</span><span class="s1">source_sel</span><span class="s4">]</span>
        <span class="s1">dset</span><span class="s4">.</span><span class="s1">write_direct</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">, </span><span class="s1">source_sel</span><span class="s4">, </span><span class="s1">dest_sel</span><span class="s4">)</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[:], </span><span class="s1">expected</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_empty</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">):</span>
        <span class="s1">empty_dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;edset&quot;</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int64'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">empty_dset</span><span class="s4">.</span><span class="s1">write_direct</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">100</span><span class="s4">,)), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">10</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">50</span><span class="s4">:</span><span class="s6">60</span><span class="s4">])</span>

    <span class="s3">def </span><span class="s1">test_wrong_shape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;dset&quot;</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int64'</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">200</span><span class="s4">,))</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">dset</span><span class="s4">.</span><span class="s1">write_direct</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_not_c_contiguous</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;dset&quot;</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int64'</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), </span><span class="s1">order</span><span class="s4">=</span><span class="s5">'F'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">dset</span><span class="s4">.</span><span class="s1">write_direct</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestCreateRequire</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can be created only if they don't exist in the file 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create new dataset with no conflicts &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">Dataset</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_create_existing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; require_dataset yields existing dataset &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">dset2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">dset2</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create_1D</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; require_dataset with integer shape yields existing dataset&quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s6">10</span><span class="s4">, </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">dset2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s6">10</span><span class="s4">, </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">dset2</span><span class="s4">)</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">dset2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, </span><span class="s6">10</span><span class="s4">, </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">dset2</span><span class="s4">)</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'baz'</span><span class="s4">, </span><span class="s6">10</span><span class="s4">, </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">dset2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s7">b'baz'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">dset2</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_shape_conflict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; require_dataset with shape conflict yields TypeError &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">4</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_type_conflict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; require_dataset with object type conflict yields TypeError &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_group</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dtype_conflict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; require_dataset with dtype conflict (strict mode) yields TypeError 
        &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'S10'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dtype_exact</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; require_dataset with exactly dtype match &quot;&quot;&quot;</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">)</span>
        <span class="s1">dset2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">, </span><span class="s1">exact</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">dset2</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_dtype_close</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; require_dataset with convertible type succeeds (non-strict mode) 
        &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'i4'</span><span class="s4">)</span>
        <span class="s1">dset2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'i2'</span><span class="s4">, </span><span class="s1">exact</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">dset2</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset2</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'i4'</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestCreateChunked</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can be created by manually specifying chunks 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create_chunks</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create via chunks tuple &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">chunks</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_create_chunks_integer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create via chunks integer &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">chunks</span><span class="s4">=</span><span class="s6">10</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">chunks</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_chunks_mismatch</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Illegal chunk size raises ValueError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">200</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_chunks_false</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Chunked format required for given storage options &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">maxshape</span><span class="s4">=</span><span class="s6">100</span><span class="s4">, </span><span class="s1">chunks</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_chunks_scalar</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Attempting to create chunked scalar dataset raises TypeError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">50</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_auto_chunks</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Auto-chunking of datasets &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">20</span><span class="s4">, </span><span class="s6">100</span><span class="s4">), </span><span class="s1">chunks</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">chunks</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">chunks</span><span class="s4">), </span><span class="s6">2</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_auto_chunks_abuse</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Auto-chunking with pathologically large element sizes &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">3</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'S100000000'</span><span class="s4">, </span><span class="s1">chunks</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">chunks</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_scalar_assignment</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Test scalar assignment of chunked dataset &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">50</span><span class="s4">, </span><span class="s6">50</span><span class="s4">),</span>
                                     <span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">, </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">1</span><span class="s4">, </span><span class="s6">50</span><span class="s4">, </span><span class="s6">50</span><span class="s4">))</span>
        <span class="s0"># test assignment of selection smaller than chunk size</span>
        <span class="s1">dset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">, :, </span><span class="s6">40</span><span class="s4">] = </span><span class="s6">10</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">, :, </span><span class="s6">40</span><span class="s4">] == </span><span class="s6">10</span><span class="s4">))</span>

        <span class="s0"># test assignment of selection equal to chunk size</span>
        <span class="s1">dset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s6">11</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] == </span><span class="s6">11</span><span class="s4">))</span>

        <span class="s0"># test assignment of selection bigger than chunk size</span>
        <span class="s1">dset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">2</span><span class="s4">] = </span><span class="s6">12</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">2</span><span class="s4">] == </span><span class="s6">12</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_auto_chunks_no_shape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Auto-chunking of empty datasets not allowed&quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s5">'Empty'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'S100'</span><span class="s4">, </span><span class="s1">chunks</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s5">'Empty'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'S100'</span><span class="s4">, </span><span class="s1">maxshape</span><span class="s4">=</span><span class="s6">20</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestCreateFillvalue</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can be created with fill value 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create_fillval</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Fill value is reflected in dataset contents &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">fillvalue</span><span class="s4">=</span><span class="s6">4.0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s6">4.0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[</span><span class="s6">7</span><span class="s4">], </span><span class="s6">4.0</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_property</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Fill value is recoverable via property &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">fillvalue</span><span class="s4">=</span><span class="s6">3.0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">fillvalue</span><span class="s4">, </span><span class="s6">3.0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotIsInstance</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">fillvalue</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_property_none</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; .fillvalue property works correctly if not set &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">fillvalue</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_compound</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Fill value works with compound types &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s5">'f4'</span><span class="s4">), (</span><span class="s5">'b'</span><span class="s4">, </span><span class="s5">'i8'</span><span class="s4">)])</span>
        <span class="s1">v </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">1</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">, </span><span class="s1">fillvalue</span><span class="s4">=</span><span class="s1">v</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">fillvalue</span><span class="s4">, </span><span class="s1">v</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertAlmostEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[</span><span class="s6">4</span><span class="s4">], </span><span class="s1">v</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_exc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Bogus fill value raises ValueError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,),</span>
                    <span class="s1">dtype</span><span class="s4">=[(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s5">'i'</span><span class="s4">), (</span><span class="s5">'b'</span><span class="s4">, </span><span class="s5">'f'</span><span class="s4">)], </span><span class="s1">fillvalue</span><span class="s4">=</span><span class="s6">42</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s5">'dt,expected'</span><span class="s4">, [</span>
    <span class="s4">(</span><span class="s1">int</span><span class="s4">, </span><span class="s6">0</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">, </span><span class="s6">0</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">, </span><span class="s6">0</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">float</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float32</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'utf-8'</span><span class="s4">, </span><span class="s1">length</span><span class="s4">=</span><span class="s6">5</span><span class="s4">), </span><span class="s7">b''</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'ascii'</span><span class="s4">, </span><span class="s1">length</span><span class="s4">=</span><span class="s6">5</span><span class="s4">), </span><span class="s7">b''</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'utf-8'</span><span class="s4">), </span><span class="s7">b''</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'ascii'</span><span class="s4">), </span><span class="s7">b''</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(), </span><span class="s7">b''</span><span class="s4">),</span>

<span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_get_unset_fill_value</span><span class="s4">(</span><span class="s1">dt</span><span class="s4">, </span><span class="s1">expected</span><span class="s4">, </span><span class="s1">writable_file</span><span class="s4">):</span>
    <span class="s1">dset </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">dset</span><span class="s4">.</span><span class="s1">fillvalue </span><span class="s4">== </span><span class="s1">expected</span>


<span class="s3">class </span><span class="s1">TestCreateNamedType</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets created from an existing named type 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_named</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Named type object works and links the dataset to type &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'type'</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'f8'</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'type'</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'f8'</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">(), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'type'</span><span class="s4">].</span><span class="s1">id</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">().</span><span class="s1">committed</span><span class="s4">())</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s5">'gzip' </span><span class="s3">not in </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">filters</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">, </span><span class="s5">&quot;DEFLATE is not installed&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestCreateGzip</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets created with gzip compression 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_gzip</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create with explicit gzip options &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s5">'gzip'</span><span class="s4">,</span>
                                     <span class="s1">compression_opts</span><span class="s4">=</span><span class="s6">9</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression</span><span class="s4">, </span><span class="s5">'gzip'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression_opts</span><span class="s4">, </span><span class="s6">9</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_gzip_implicit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create with implicit gzip level (level 4) &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s5">'gzip'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression</span><span class="s4">, </span><span class="s5">'gzip'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression_opts</span><span class="s4">, </span><span class="s6">4</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_gzip_number</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create with gzip level by specifying integer &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s6">7</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression</span><span class="s4">, </span><span class="s5">'gzip'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression_opts</span><span class="s4">, </span><span class="s6">7</span><span class="s4">)</span>

        <span class="s1">original_compression_vals </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">()</span>
            <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
                <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s6">7</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS </span><span class="s4">= </span><span class="s1">original_compression_vals</span>

    <span class="s3">def </span><span class="s1">test_gzip_exc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Illegal gzip level (explicit or implicit) raises ValueError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">((</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">RuntimeError</span><span class="s4">)):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s6">14</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=-</span><span class="s6">4</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s5">'gzip'</span><span class="s4">,</span>
                                  <span class="s1">compression_opts</span><span class="s4">=</span><span class="s6">14</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s5">'gzip' </span><span class="s3">not in </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">filters</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">, </span><span class="s5">&quot;DEFLATE is not installed&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestCreateCompressionNumber</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets created with a compression code 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_compression_number</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create with compression number of gzip (h5py.h5z.FILTER_DEFLATE) and a compression level of 7&quot;&quot;&quot;</span>
        <span class="s1">original_compression_vals </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">()</span>
            <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5z</span><span class="s4">.</span><span class="s1">FILTER_DEFLATE</span><span class="s4">, </span><span class="s1">compression_opts</span><span class="s4">=(</span><span class="s6">7</span><span class="s4">,))</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS </span><span class="s4">= </span><span class="s1">original_compression_vals</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression</span><span class="s4">, </span><span class="s5">'gzip'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression_opts</span><span class="s4">, </span><span class="s6">7</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_compression_number_invalid</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create with invalid compression numbers  &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=-</span><span class="s6">999</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">&quot;Invalid filter&quot;</span><span class="s4">, </span><span class="s1">str</span><span class="s4">(</span><span class="s1">e</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">))</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s6">100</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIn</span><span class="s4">(</span><span class="s5">&quot;Unknown compression&quot;</span><span class="s4">, </span><span class="s1">str</span><span class="s4">(</span><span class="s1">e</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">))</span>

        <span class="s1">original_compression_vals </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">()</span>

            <span class="s0"># Using gzip compression requires a compression level specified in compression_opts</span>
            <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">IndexError</span><span class="s4">):</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5z</span><span class="s4">.</span><span class="s1">FILTER_DEFLATE</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">h5py</span><span class="s4">.</span><span class="s1">_hl</span><span class="s4">.</span><span class="s1">dataset</span><span class="s4">.</span><span class="s1">_LEGACY_GZIP_COMPRESSION_VALS </span><span class="s4">= </span><span class="s1">original_compression_vals</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s5">'lzf' </span><span class="s3">not in </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">filters</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">, </span><span class="s5">&quot;LZF is not installed&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestCreateLZF</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets created with LZF compression 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_lzf</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create with explicit lzf &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s5">'lzf'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression</span><span class="s4">, </span><span class="s5">'lzf'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression_opts</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">100</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">testdata</span><span class="s4">, </span><span class="s1">compression</span><span class="s4">=</span><span class="s5">'lzf'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression</span><span class="s4">, </span><span class="s5">'lzf'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">compression_opts</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">flush</span><span class="s4">()  </span><span class="s0"># Actually write to file</span>

        <span class="s1">readdata </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'bar'</span><span class="s4">][()]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">readdata</span><span class="s4">, </span><span class="s1">testdata</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_lzf_exc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Giving lzf options raises ValueError &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s5">'lzf'</span><span class="s4">,</span>
                                  <span class="s1">compression_opts</span><span class="s4">=</span><span class="s6">4</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s5">'szip' </span><span class="s3">not in </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">filters</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">, </span><span class="s5">&quot;SZIP is not installed&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestCreateSZIP</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets created with LZF compression 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_szip</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create with explicit szip &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">compression</span><span class="s4">=</span><span class="s5">'szip'</span><span class="s4">,</span>
                                     <span class="s1">compression_opts</span><span class="s4">=(</span><span class="s5">'ec'</span><span class="s4">, </span><span class="s6">16</span><span class="s4">))</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s5">'shuffle' </span><span class="s3">not in </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">filters</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">, </span><span class="s5">&quot;SHUFFLE is not installed&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestCreateShuffle</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can use shuffling filter 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_shuffle</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Enable shuffle filter &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">shuffle</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shuffle</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s5">'fletcher32' </span><span class="s3">not in </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">filters</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">, </span><span class="s5">&quot;FLETCHER32 is not installed&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestCreateFletcher32</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can use the fletcher32 filter 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_fletcher32</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Enable fletcher32 filter &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">fletcher32</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">fletcher32</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipIf</span><span class="s4">(</span><span class="s5">'scaleoffset' </span><span class="s3">not in </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">filters</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">, </span><span class="s5">&quot;SCALEOFFSET is not installed&quot;</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">TestCreateScaleOffset</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets can use the scale/offset filter 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_float_fails_without_options</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Ensure that a scale factor is required for scaleoffset compression of floating point data &quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">scaleoffset</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_non_integer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Check when scaleoffset is negetive&quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">, </span><span class="s1">scaleoffset</span><span class="s4">=-</span><span class="s6">0.1</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_unsupport_dtype</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Check when dtype is unsupported type&quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">, </span><span class="s1">scaleoffset</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_float</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Scaleoffset filter works for floating point data &quot;&quot;&quot;</span>

        <span class="s1">scalefac </span><span class="s4">= </span><span class="s6">4</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">100</span><span class="s4">, </span><span class="s6">300</span><span class="s4">)</span>
        <span class="s1">range </span><span class="s4">= </span><span class="s6">20 </span><span class="s4">* </span><span class="s6">10 </span><span class="s4">** </span><span class="s1">scalefac</span>
        <span class="s1">testdata </span><span class="s4">= (</span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(*</span><span class="s1">shape</span><span class="s4">) - </span><span class="s6">0.5</span><span class="s4">) * </span><span class="s1">range</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">, </span><span class="s1">scaleoffset</span><span class="s4">=</span><span class="s1">scalefac</span><span class="s4">)</span>

        <span class="s0"># Dataset reports that scaleoffset is in use</span>
        <span class="s3">assert </span><span class="s1">dset</span><span class="s4">.</span><span class="s1">scaleoffset </span><span class="s3">is not None</span>

        <span class="s0"># Dataset round-trips</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">testdata</span>
        <span class="s1">filename </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s1">readdata </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">][...]</span>

        <span class="s0"># Test that data round-trips to requested precision</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">readdata</span><span class="s4">, </span><span class="s1">testdata</span><span class="s4">, </span><span class="s1">precision</span><span class="s4">=</span><span class="s6">10 </span><span class="s4">** (-</span><span class="s1">scalefac</span><span class="s4">))</span>

        <span class="s0"># Test that the filter is actually active (i.e. compression is lossy)</span>
        <span class="s3">assert not </span><span class="s4">(</span><span class="s1">readdata </span><span class="s4">== </span><span class="s1">testdata</span><span class="s4">).</span><span class="s1">all</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_int</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Scaleoffset filter works for integer data with default precision &quot;&quot;&quot;</span>

        <span class="s1">nbits </span><span class="s4">= </span><span class="s6">12</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">100</span><span class="s4">, </span><span class="s6">300</span><span class="s4">)</span>
        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">2 </span><span class="s4">** </span><span class="s1">nbits </span><span class="s4">- </span><span class="s6">1</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">)</span>

        <span class="s0"># Create dataset; note omission of nbits (for library-determined precision)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">, </span><span class="s1">scaleoffset</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

        <span class="s0"># Dataset reports scaleoffset enabled</span>
        <span class="s3">assert </span><span class="s1">dset</span><span class="s4">.</span><span class="s1">scaleoffset </span><span class="s3">is not None</span>

        <span class="s0"># Data round-trips correctly and identically</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">testdata</span>
        <span class="s1">filename </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s1">readdata </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">][...]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">readdata</span><span class="s4">, </span><span class="s1">testdata</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_int_with_minbits</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Scaleoffset filter works for integer data with specified precision &quot;&quot;&quot;</span>

        <span class="s1">nbits </span><span class="s4">= </span><span class="s6">12</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">100</span><span class="s4">, </span><span class="s6">300</span><span class="s4">)</span>
        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">2 </span><span class="s4">** </span><span class="s1">nbits</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">)</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">, </span><span class="s1">scaleoffset</span><span class="s4">=</span><span class="s1">nbits</span><span class="s4">)</span>

        <span class="s0"># Dataset reports scaleoffset enabled with correct precision</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">scaleoffset </span><span class="s4">== </span><span class="s6">12</span><span class="s4">)</span>

        <span class="s0"># Data round-trips correctly</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">testdata</span>
        <span class="s1">filename </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s1">readdata </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">][...]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">readdata</span><span class="s4">, </span><span class="s1">testdata</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_int_with_minbits_lossy</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Scaleoffset filter works for integer data with specified precision &quot;&quot;&quot;</span>

        <span class="s1">nbits </span><span class="s4">= </span><span class="s6">12</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">100</span><span class="s4">, </span><span class="s6">300</span><span class="s4">)</span>
        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">2 </span><span class="s4">** (</span><span class="s1">nbits </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">) - </span><span class="s6">1</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">)</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">, </span><span class="s1">scaleoffset</span><span class="s4">=</span><span class="s1">nbits</span><span class="s4">)</span>

        <span class="s0"># Dataset reports scaleoffset enabled with correct precision</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">scaleoffset </span><span class="s4">== </span><span class="s6">12</span><span class="s4">)</span>

        <span class="s0"># Data can be written and read</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">testdata</span>
        <span class="s1">filename </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">)</span>
        <span class="s1">readdata </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'foo'</span><span class="s4">][...]</span>

        <span class="s0"># Compression is lossy</span>
        <span class="s3">assert not </span><span class="s4">(</span><span class="s1">readdata </span><span class="s4">== </span><span class="s1">testdata</span><span class="s4">).</span><span class="s1">all</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">TestExternal</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets with the external storage property 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">test_contents</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create and access an external dataset &quot;&quot;&quot;</span>

        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">100</span><span class="s4">)</span>
        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">random</span><span class="s4">(</span><span class="s1">shape</span><span class="s4">)</span>

        <span class="s0"># create a dataset in an external file and set it</span>
        <span class="s1">ext_file </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">external </span><span class="s4">= [(</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">h5f</span><span class="s4">.</span><span class="s1">UNLIMITED</span><span class="s4">)]</span>
        <span class="s0"># ${ORIGIN} should be replaced by the parent dir of the HDF5 file</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">testdata</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">external</span><span class="s4">=</span><span class="s1">external</span><span class="s4">, </span><span class="s1">efile_prefix</span><span class="s4">=</span><span class="s5">&quot;${ORIGIN}&quot;</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">testdata</span>

        <span class="s3">assert </span><span class="s1">dset</span><span class="s4">.</span><span class="s1">external </span><span class="s3">is not None</span>

        <span class="s0"># verify file's existence, size, and contents</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s5">'rb'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fid</span><span class="s4">:</span>
            <span class="s1">contents </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">read</span><span class="s4">()</span>
        <span class="s3">assert </span><span class="s1">contents </span><span class="s4">== </span><span class="s1">testdata</span><span class="s4">.</span><span class="s1">tobytes</span><span class="s4">()</span>

        <span class="s1">efile_prefix </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_efile_prefix</span><span class="s4">().</span><span class="s1">decode</span><span class="s4">()).</span><span class="s1">as_posix</span><span class="s4">()</span>
        <span class="s1">parent </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">filename</span><span class="s4">).</span><span class="s1">parent</span><span class="s4">.</span><span class="s1">as_posix</span><span class="s4">()</span>
        <span class="s3">assert </span><span class="s1">efile_prefix </span><span class="s4">== </span><span class="s1">parent</span>

    <span class="s3">def </span><span class="s1">test_contents_efile_prefix</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create and access an external dataset using an efile_prefix&quot;&quot;&quot;</span>

        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">100</span><span class="s4">)</span>
        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">random</span><span class="s4">(</span><span class="s1">shape</span><span class="s4">)</span>

        <span class="s0"># create a dataset in an external file and set it</span>
        <span class="s1">ext_file </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s0"># set only the basename, let the efile_prefix do the rest</span>
        <span class="s1">external </span><span class="s4">= [(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">basename</span><span class="s4">(</span><span class="s1">ext_file</span><span class="s4">), </span><span class="s6">0</span><span class="s4">, </span><span class="s1">h5f</span><span class="s4">.</span><span class="s1">UNLIMITED</span><span class="s4">)]</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">testdata</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">external</span><span class="s4">=</span><span class="s1">external</span><span class="s4">, </span><span class="s1">efile_prefix</span><span class="s4">=</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">dirname</span><span class="s4">(</span><span class="s1">ext_file</span><span class="s4">))</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">testdata</span>

        <span class="s3">assert </span><span class="s1">dset</span><span class="s4">.</span><span class="s1">external </span><span class="s3">is not None</span>

        <span class="s0"># verify file's existence, size, and contents</span>
        <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s5">'rb'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fid</span><span class="s4">:</span>
            <span class="s1">contents </span><span class="s4">= </span><span class="s1">fid</span><span class="s4">.</span><span class="s1">read</span><span class="s4">()</span>
        <span class="s3">assert </span><span class="s1">contents </span><span class="s4">== </span><span class="s1">testdata</span><span class="s4">.</span><span class="s1">tobytes</span><span class="s4">()</span>

        <span class="s0"># check efile_prefix, only for 1.10.0 due to HDFFV-9716</span>
        <span class="s3">if </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&gt;= (</span><span class="s6">1</span><span class="s4">,</span><span class="s6">10</span><span class="s4">,</span><span class="s6">0</span><span class="s4">):</span>
            <span class="s1">efile_prefix </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_efile_prefix</span><span class="s4">().</span><span class="s1">decode</span><span class="s4">()).</span><span class="s1">as_posix</span><span class="s4">()</span>
            <span class="s1">parent </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">ext_file</span><span class="s4">).</span><span class="s1">parent</span><span class="s4">.</span><span class="s1">as_posix</span><span class="s4">()</span>
            <span class="s3">assert </span><span class="s1">efile_prefix </span><span class="s4">== </span><span class="s1">parent</span>

        <span class="s1">dset2 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">testdata</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">efile_prefix</span><span class="s4">=</span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">dirname</span><span class="s4">(</span><span class="s1">ext_file</span><span class="s4">))</span>
        <span class="s3">assert </span><span class="s1">dset2</span><span class="s4">.</span><span class="s1">external </span><span class="s3">is not None</span>
        <span class="s1">dset2</span><span class="s4">[()] == </span><span class="s1">testdata</span>

    <span class="s3">def </span><span class="s1">test_name_str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; External argument may be a file name str only &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">100</span><span class="s4">), </span><span class="s1">external</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">())</span>

    <span class="s3">def </span><span class="s1">test_name_path</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; External argument may be a file name path only &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">100</span><span class="s4">),</span>
                              <span class="s1">external</span><span class="s4">=</span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()))</span>

    <span class="s3">def </span><span class="s1">test_iter_multi</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; External argument may be an iterable of multiple tuples &quot;&quot;&quot;</span>

        <span class="s1">ext_file </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">N </span><span class="s4">= </span><span class="s6">100</span>
        <span class="s1">external </span><span class="s4">= </span><span class="s1">iter</span><span class="s4">((</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s1">x </span><span class="s4">* </span><span class="s6">1000</span><span class="s4">, </span><span class="s6">1000</span><span class="s4">) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">N</span><span class="s4">))</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'poo'</span><span class="s4">, (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">100</span><span class="s4">), </span><span class="s1">external</span><span class="s4">=</span><span class="s1">external</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">external</span><span class="s4">) == </span><span class="s1">N</span>

    <span class="s3">def </span><span class="s1">test_invalid</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Test with invalid external lists &quot;&quot;&quot;</span>

        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">6</span><span class="s4">, </span><span class="s6">100</span><span class="s4">)</span>
        <span class="s1">ext_file </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>

        <span class="s3">for </span><span class="s1">exc_type</span><span class="s4">, </span><span class="s1">external </span><span class="s3">in </span><span class="s4">[</span>
            <span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, [</span><span class="s1">ext_file</span><span class="s4">]),</span>
            <span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, [</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s6">0</span><span class="s4">]),</span>
            <span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, [</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">h5f</span><span class="s4">.</span><span class="s1">UNLIMITED</span><span class="s4">]),</span>
            <span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, [(</span><span class="s1">ext_file</span><span class="s4">,)]),</span>
            <span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, [(</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)]),</span>
            <span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, [(</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">h5f</span><span class="s4">.</span><span class="s1">UNLIMITED</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)]),</span>
            <span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, [(</span><span class="s1">ext_file</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s5">&quot;h5f.UNLIMITED&quot;</span><span class="s4">)]),</span>
        <span class="s4">]:</span>
            <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">exc_type</span><span class="s4">):</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">external</span><span class="s4">=</span><span class="s1">external</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_create_expandable</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create expandable external dataset &quot;&quot;&quot;</span>

        <span class="s1">ext_file </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mktemp</span><span class="s4">()</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">128</span><span class="s4">, </span><span class="s6">64</span><span class="s4">)</span>
        <span class="s1">maxshape </span><span class="s4">= (</span><span class="s3">None</span><span class="s4">, </span><span class="s6">64</span><span class="s4">)</span>
        <span class="s1">exp_dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">maxshape</span><span class="s4">=</span><span class="s1">maxshape</span><span class="s4">,</span>
                                         <span class="s1">external</span><span class="s4">=</span><span class="s1">ext_file</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">exp_dset</span><span class="s4">.</span><span class="s1">chunks </span><span class="s3">is None</span>
        <span class="s3">assert </span><span class="s1">exp_dset</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== </span><span class="s1">shape</span>
        <span class="s3">assert </span><span class="s1">exp_dset</span><span class="s4">.</span><span class="s1">maxshape </span><span class="s4">== </span><span class="s1">maxshape</span>


<span class="s3">class </span><span class="s1">TestAutoCreate</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets auto-created from data produce the correct types 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">assert_string_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">ds</span><span class="s4">, </span><span class="s1">cset</span><span class="s4">, </span><span class="s1">variable</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
        <span class="s1">tid </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">), </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">TypeStringID</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">.</span><span class="s1">get_cset</span><span class="s4">(), </span><span class="s1">cset</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">variable</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">tid</span><span class="s4">.</span><span class="s1">is_variable_str</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_vlen_bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Assigning byte strings produces a vlen string ASCII dataset &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">] = </span><span class="s7">b&quot;Hello there&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assert_string_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">], </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'y'</span><span class="s4">] = [</span><span class="s7">b&quot;a&quot;</span><span class="s4">, </span><span class="s7">b&quot;bc&quot;</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assert_string_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'y'</span><span class="s4">], </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'z'</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s7">b&quot;a&quot;</span><span class="s4">, </span><span class="s7">b&quot;bc&quot;</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">object_</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assert_string_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'z'</span><span class="s4">], </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_vlen_unicode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Assigning unicode strings produces a vlen string UTF-8 dataset &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">] = </span><span class="s5">&quot;Hello there&quot; </span><span class="s4">+ </span><span class="s1">chr</span><span class="s4">(</span><span class="s6">0x2034</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assert_string_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">], </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_UTF8</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'y'</span><span class="s4">] = [</span><span class="s5">&quot;a&quot;</span><span class="s4">, </span><span class="s5">&quot;bc&quot;</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assert_string_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'y'</span><span class="s4">], </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_UTF8</span><span class="s4">)</span>

        <span class="s0"># 2D array; this only works with an array, not nested lists</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'z'</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([[</span><span class="s5">&quot;a&quot;</span><span class="s4">, </span><span class="s5">&quot;bc&quot;</span><span class="s4">]], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">object_</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assert_string_type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'z'</span><span class="s4">], </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_UTF8</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_string_fixed</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Assignment of fixed-length byte string produces a fixed-length 
        ascii dataset &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">bytes_</span><span class="s4">(</span><span class="s5">&quot;Hello there&quot;</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assert_string_type</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">, </span><span class="s1">variable</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">().</span><span class="s1">get_size</span><span class="s4">(), </span><span class="s6">11</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestCreateLike</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">test_no_chunks</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'lol'</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">25</span><span class="s4">).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s6">5</span><span class="s4">, </span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset_like</span><span class="s4">(</span><span class="s5">'like_lol'</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'lol'</span><span class="s4">])</span>
        <span class="s1">dslike </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'like_lol'</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dslike</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">5</span><span class="s4">, </span><span class="s6">5</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIs</span><span class="s4">(</span><span class="s1">dslike</span><span class="s4">.</span><span class="s1">chunks</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_track_times</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">orig </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'honda'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">12</span><span class="s4">),</span>
                                     <span class="s1">track_times</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotEqual</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5g</span><span class="s4">.</span><span class="s1">get_objinfo</span><span class="s4">(</span><span class="s1">orig</span><span class="s4">.</span><span class="s1">_id</span><span class="s4">).</span><span class="s1">mtime</span><span class="s4">)</span>
        <span class="s1">similar </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset_like</span><span class="s4">(</span><span class="s5">'hyundai'</span><span class="s4">, </span><span class="s1">orig</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotEqual</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5g</span><span class="s4">.</span><span class="s1">get_objinfo</span><span class="s4">(</span><span class="s1">similar</span><span class="s4">.</span><span class="s1">_id</span><span class="s4">).</span><span class="s1">mtime</span><span class="s4">)</span>

        <span class="s1">orig </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'ibm'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">12</span><span class="s4">),</span>
                                     <span class="s1">track_times</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5g</span><span class="s4">.</span><span class="s1">get_objinfo</span><span class="s4">(</span><span class="s1">orig</span><span class="s4">.</span><span class="s1">_id</span><span class="s4">).</span><span class="s1">mtime</span><span class="s4">)</span>
        <span class="s1">similar </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset_like</span><span class="s4">(</span><span class="s5">'lenovo'</span><span class="s4">, </span><span class="s1">orig</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5g</span><span class="s4">.</span><span class="s1">get_objinfo</span><span class="s4">(</span><span class="s1">similar</span><span class="s4">.</span><span class="s1">_id</span><span class="s4">).</span><span class="s1">mtime</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_maxshape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Test when other.maxshape != other.shape &quot;&quot;&quot;</span>

        <span class="s1">other </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'other'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">maxshape</span><span class="s4">=</span><span class="s6">20</span><span class="s4">)</span>
        <span class="s1">similar </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset_like</span><span class="s4">(</span><span class="s5">'sim'</span><span class="s4">, </span><span class="s1">other</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">similar</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">similar</span><span class="s4">.</span><span class="s1">maxshape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">,))</span>

<span class="s3">class </span><span class="s1">TestChunkIterator</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">test_no_chunks</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;foo&quot;</span><span class="s4">, ())</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">dset</span><span class="s4">.</span><span class="s1">iter_chunks</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_1d</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;foo&quot;</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">32</span><span class="s4">,))</span>
        <span class="s1">expected </span><span class="s4">= ((</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">0</span><span class="s4">,</span><span class="s6">32</span><span class="s4">,</span><span class="s6">1</span><span class="s4">),), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">32</span><span class="s4">,</span><span class="s6">64</span><span class="s4">,</span><span class="s6">1</span><span class="s4">),), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">64</span><span class="s4">,</span><span class="s6">96</span><span class="s4">,</span><span class="s6">1</span><span class="s4">),),</span>
            <span class="s4">(</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">96</span><span class="s4">,</span><span class="s6">100</span><span class="s4">,</span><span class="s6">1</span><span class="s4">),))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">iter_chunks</span><span class="s4">()), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">expected</span><span class="s4">))</span>
        <span class="s1">expected </span><span class="s4">= ((</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">50</span><span class="s4">,</span><span class="s6">64</span><span class="s4">,</span><span class="s6">1</span><span class="s4">),), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">64</span><span class="s4">,</span><span class="s6">96</span><span class="s4">,</span><span class="s6">1</span><span class="s4">),), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">96</span><span class="s4">,</span><span class="s6">97</span><span class="s4">,</span><span class="s6">1</span><span class="s4">),))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">iter_chunks</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">50</span><span class="s4">:</span><span class="s6">97</span><span class="s4">])), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">expected</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_2d</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;foo&quot;</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,</span><span class="s6">100</span><span class="s4">), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">32</span><span class="s4">,</span><span class="s6">64</span><span class="s4">))</span>
        <span class="s1">expected </span><span class="s4">= ((</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">32</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">64</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">32</span><span class="s4">, </span><span class="s6">1</span><span class="s4">),</span>
        <span class="s1">slice</span><span class="s4">(</span><span class="s6">64</span><span class="s4">, </span><span class="s6">100</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">32</span><span class="s4">, </span><span class="s6">64</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">64</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)),</span>
        <span class="s4">(</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">32</span><span class="s4">, </span><span class="s6">64</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">64</span><span class="s4">, </span><span class="s6">100</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">64</span><span class="s4">, </span><span class="s6">96</span><span class="s4">, </span><span class="s6">1</span><span class="s4">),</span>
        <span class="s1">slice</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">64</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">64</span><span class="s4">, </span><span class="s6">96</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">64</span><span class="s4">, </span><span class="s6">100</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)),</span>
        <span class="s4">(</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">96</span><span class="s4">, </span><span class="s6">100</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">64</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)), (</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">96</span><span class="s4">, </span><span class="s6">100</span><span class="s4">, </span><span class="s6">1</span><span class="s4">),</span>
        <span class="s1">slice</span><span class="s4">(</span><span class="s6">64</span><span class="s4">, </span><span class="s6">100</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">iter_chunks</span><span class="s4">()), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">expected</span><span class="s4">))</span>

        <span class="s1">expected </span><span class="s4">= ((</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">48</span><span class="s4">, </span><span class="s6">52</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">40</span><span class="s4">, </span><span class="s6">50</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)),)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">iter_chunks</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">48</span><span class="s4">:</span><span class="s6">52</span><span class="s4">,</span><span class="s6">40</span><span class="s4">:</span><span class="s6">50</span><span class="s4">])), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">expected</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_2d_partial_slice</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;foo&quot;</span><span class="s4">, (</span><span class="s6">5</span><span class="s4">,</span><span class="s6">5</span><span class="s4">), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">2</span><span class="s4">,</span><span class="s6">2</span><span class="s4">))</span>
        <span class="s1">expected </span><span class="s4">= ((</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">4</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">4</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)),</span>
                   <span class="s4">(</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">4</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">4</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)),</span>
                   <span class="s4">(</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">4</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">4</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)),</span>
                   <span class="s4">(</span><span class="s1">slice</span><span class="s4">(</span><span class="s6">4</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, </span><span class="s6">1</span><span class="s4">), </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">4</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)))</span>
        <span class="s1">sel </span><span class="s4">= </span><span class="s1">slice</span><span class="s4">(</span><span class="s6">3</span><span class="s4">,</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">iter_chunks</span><span class="s4">((</span><span class="s1">sel</span><span class="s4">, </span><span class="s1">sel</span><span class="s4">))), </span><span class="s1">list</span><span class="s4">(</span><span class="s1">expected</span><span class="s4">))</span>



<span class="s3">class </span><span class="s1">TestResize</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets created with &quot;maxshape&quot; may be resized 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create dataset with &quot;maxshape&quot; &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsNot</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">chunks</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">maxshape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_create_1D</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Create dataset with &quot;maxshape&quot; using integer maxshape&quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">,), </span><span class="s1">maxshape</span><span class="s4">=</span><span class="s6">20</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsNot</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">chunks</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">maxshape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">,))</span>

        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'bar'</span><span class="s4">, </span><span class="s6">20</span><span class="s4">, </span><span class="s1">maxshape</span><span class="s4">=</span><span class="s6">20</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">maxshape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_resize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Datasets may be resized up to maxshape &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">))</span>
        <span class="s1">dset</span><span class="s4">.</span><span class="s1">resize</span><span class="s4">((</span><span class="s6">20</span><span class="s4">, </span><span class="s6">50</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">50</span><span class="s4">))</span>
        <span class="s1">dset</span><span class="s4">.</span><span class="s1">resize</span><span class="s4">((</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_resize_1D</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Datasets may be resized up to maxshape using integer maxshape&quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s6">20</span><span class="s4">, </span><span class="s1">maxshape</span><span class="s4">=</span><span class="s6">40</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">,))</span>
        <span class="s1">dset</span><span class="s4">.</span><span class="s1">resize</span><span class="s4">((</span><span class="s6">30</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">30</span><span class="s4">,))</span>

    <span class="s3">def </span><span class="s1">test_resize_over</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Resizing past maxshape triggers an exception &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">Exception</span><span class="s4">):</span>
            <span class="s1">dset</span><span class="s4">.</span><span class="s1">resize</span><span class="s4">((</span><span class="s6">20</span><span class="s4">, </span><span class="s6">70</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_resize_nonchunked</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Resizing non-chunked dataset raises TypeError &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;foo&quot;</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">))</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">dset</span><span class="s4">.</span><span class="s1">resize</span><span class="s4">((</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_resize_axis</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Resize specified axis &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>
        <span class="s1">dset</span><span class="s4">.</span><span class="s1">resize</span><span class="s4">(</span><span class="s6">50</span><span class="s4">, </span><span class="s1">axis</span><span class="s4">=</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">50</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_axis_exc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Illegal axis raises ValueError &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">20</span><span class="s4">, </span><span class="s6">30</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s6">20</span><span class="s4">, </span><span class="s6">60</span><span class="s4">))</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">dset</span><span class="s4">.</span><span class="s1">resize</span><span class="s4">(</span><span class="s6">50</span><span class="s4">, </span><span class="s1">axis</span><span class="s4">=</span><span class="s6">2</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_zero_dim</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Allow zero-length initial dims for unlimited axes (issue 111) &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">15</span><span class="s4">, </span><span class="s6">0</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s6">15</span><span class="s4">, </span><span class="s3">None</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">15</span><span class="s4">, </span><span class="s6">0</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">maxshape</span><span class="s4">, (</span><span class="s6">15</span><span class="s4">, </span><span class="s3">None</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestDtype</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Dataset dtype is available as .dtype property 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_dtype</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Retrieve dtype from dataset &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">5</span><span class="s4">,), </span><span class="s5">'|S10'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'|S10'</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_dtype_complex32</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Retrieve dtype from complex float16 dataset (gh-2156) &quot;&quot;&quot;</span>
        <span class="s0"># No native support in numpy as of v1.23.3, so expect compound type.</span>
        <span class="s1">complex32 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([(</span><span class="s5">'r'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float16</span><span class="s4">), (</span><span class="s5">'i'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float16</span><span class="s4">)])</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">5</span><span class="s4">,), </span><span class="s1">complex32</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">complex32</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestLen</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Size of first axis is available via Python's len 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Python len() (under 32 bits) &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">312</span><span class="s4">, </span><span class="s6">15</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">), </span><span class="s6">312</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_len_big</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Python len() vs Dataset.len() &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">2 </span><span class="s4">** </span><span class="s6">33</span><span class="s4">, </span><span class="s6">15</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">2 </span><span class="s4">** </span><span class="s6">33</span><span class="s4">, </span><span class="s6">15</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">maxsize </span><span class="s4">== </span><span class="s6">2 </span><span class="s4">** </span><span class="s6">31 </span><span class="s4">- </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">OverflowError</span><span class="s4">):</span>
                <span class="s1">len</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">), </span><span class="s6">2 </span><span class="s4">** </span><span class="s6">33</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">len</span><span class="s4">(), </span><span class="s6">2 </span><span class="s4">** </span><span class="s6">33</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestIter</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Iterating over a dataset yields rows 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Iterating over a dataset yields rows &quot;&quot;&quot;</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">30</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'f'</span><span class="s4">).</span><span class="s1">reshape</span><span class="s4">((</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">))</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">data</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">data</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">x</span><span class="s4">), </span><span class="s6">3</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_iter_scalar</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Iterating over scalar dataset raises TypeError &quot;&quot;&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=())</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s4">[</span><span class="s1">x </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">dset</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">TestStrings</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Datasets created with vlen and fixed datatypes correctly 
        translate to and from HDF5 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_vlen_bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Vlen bytes dataset maps to vlen ascii in the file &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'ascii'</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">tid </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">), </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">TypeStringID</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">.</span><span class="s1">get_cset</span><span class="s4">(), </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">)</span>
        <span class="s1">string_info </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">check_string_dtype</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">string_info</span><span class="s4">.</span><span class="s1">encoding</span><span class="s4">, </span><span class="s5">'ascii'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_vlen_bytes_fillvalue</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Vlen bytes dataset handles fillvalue &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'ascii'</span><span class="s4">)</span>
        <span class="s1">fill_value </span><span class="s4">= </span><span class="s7">b'bar'</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">, </span><span class="s1">fillvalue</span><span class="s4">=</span><span class="s1">fill_value</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">], </span><span class="s1">fill_value</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">asstr</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">fill_value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">())</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">fillvalue</span><span class="s4">, </span><span class="s1">fill_value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_vlen_unicode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Vlen unicode dataset maps to vlen utf-8 in the file &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">()</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">tid </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">), </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">TypeStringID</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">.</span><span class="s1">get_cset</span><span class="s4">(), </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_UTF8</span><span class="s4">)</span>
        <span class="s1">string_info </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">check_string_dtype</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">string_info</span><span class="s4">.</span><span class="s1">encoding</span><span class="s4">, </span><span class="s5">'utf-8'</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_vlen_unicode_fillvalue</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Vlen unicode dataset handles fillvalue &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">()</span>
        <span class="s1">fill_value </span><span class="s4">= </span><span class="s5">'bár'</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">, </span><span class="s1">fillvalue</span><span class="s4">=</span><span class="s1">fill_value</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">], </span><span class="s1">fill_value</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">asstr</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">fill_value</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">fillvalue</span><span class="s4">, </span><span class="s1">fill_value</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_fixed_ascii</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Fixed-length bytes dataset maps to fixed-length ascii in the file 
        &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">&quot;|S10&quot;</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">tid </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">), </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">TypeStringID</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertFalse</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">.</span><span class="s1">is_variable_str</span><span class="s4">())</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">.</span><span class="s1">get_size</span><span class="s4">(), </span><span class="s6">10</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">.</span><span class="s1">get_cset</span><span class="s4">(), </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_ASCII</span><span class="s4">)</span>
        <span class="s1">string_info </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">check_string_dtype</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">string_info</span><span class="s4">.</span><span class="s1">encoding</span><span class="s4">, </span><span class="s5">'ascii'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">string_info</span><span class="s4">.</span><span class="s1">length</span><span class="s4">, </span><span class="s6">10</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_fixed_bytes_fillvalue</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Vlen bytes dataset handles fillvalue &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'ascii'</span><span class="s4">, </span><span class="s1">length</span><span class="s4">=</span><span class="s6">10</span><span class="s4">)</span>
        <span class="s1">fill_value </span><span class="s4">= </span><span class="s7">b'bar'</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">, </span><span class="s1">fillvalue</span><span class="s4">=</span><span class="s1">fill_value</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">], </span><span class="s1">fill_value</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">asstr</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">fill_value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">())</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">fillvalue</span><span class="s4">, </span><span class="s1">fill_value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_fixed_utf8</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'utf-8'</span><span class="s4">, </span><span class="s1">length</span><span class="s4">=</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">tid </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_type</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">tid</span><span class="s4">.</span><span class="s1">get_cset</span><span class="s4">(), </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">CSET_UTF8</span><span class="s4">)</span>
        <span class="s1">s </span><span class="s4">= </span><span class="s5">'cù'</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">s</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">'utf-8'</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s1">s</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:</span><span class="s6">4</span><span class="s4">] = [</span><span class="s1">s</span><span class="s4">, </span><span class="s1">s</span><span class="s4">]</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">4</span><span class="s4">:</span><span class="s6">6</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">s</span><span class="s4">, </span><span class="s1">s</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">6</span><span class="s4">:</span><span class="s6">8</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">s</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">'utf-8'</span><span class="s4">)] * </span><span class="s6">2</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">ds</span><span class="s4">[</span><span class="s6">8</span><span class="s4">:</span><span class="s6">10</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">s</span><span class="s4">, </span><span class="s1">s</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'U'</span><span class="s4">)</span>

        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[:</span><span class="s6">8</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">s</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">'utf-8'</span><span class="s4">)] * </span><span class="s6">8</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'S'</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_fixed_utf_8_fillvalue</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Vlen unicode dataset handles fillvalue &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'utf-8'</span><span class="s4">, </span><span class="s1">length</span><span class="s4">=</span><span class="s6">10</span><span class="s4">)</span>
        <span class="s1">fill_value </span><span class="s4">= </span><span class="s5">'bár'</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">, </span><span class="s1">fillvalue</span><span class="s4">=</span><span class="s1">fill_value</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">], </span><span class="s1">fill_value</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">asstr</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">fill_value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">].</span><span class="s1">fillvalue</span><span class="s4">, </span><span class="s1">fill_value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_fixed_unicode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Fixed-length unicode datasets are unsupported (raise TypeError) &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">&quot;|U10&quot;</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_roundtrip_vlen_bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; writing and reading to vlen bytes dataset preserves type and content 
        &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">encoding</span><span class="s4">=</span><span class="s5">'ascii'</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s7">b&quot;Hello</span><span class="s3">\xef</span><span class="s7">&quot;</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">data</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">out</span><span class="s4">), </span><span class="s1">bytes</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_roundtrip_fixed_bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Writing to and reading from fixed-length bytes dataset preserves 
        type and content &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">&quot;|S10&quot;</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s7">b&quot;Hello</span><span class="s3">\xef</span><span class="s7">&quot;</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">data</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">out</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">bytes_</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_retrieve_vlen_unicode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">()</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s5">&quot;fàilte&quot;</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">bytes</span><span class="s4">)</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">str</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_asstr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">())</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s5">&quot;fàilte&quot;</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">data</span>

        <span class="s1">strwrap1 </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">(</span><span class="s5">'ascii'</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">UnicodeDecodeError</span><span class="s4">):</span>
            <span class="s1">out </span><span class="s4">= </span><span class="s1">strwrap1</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

        <span class="s0"># Different errors parameter</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">(</span><span class="s5">'ascii'</span><span class="s4">, </span><span class="s5">'ignore'</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">], </span><span class="s5">'filte'</span><span class="s4">)</span>

        <span class="s0"># latin-1 will decode it but give the wrong text</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">(</span><span class="s5">'latin-1'</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">data</span><span class="s4">)</span>

        <span class="s0"># len of ds</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s6">10</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">()))</span>

        <span class="s0"># Array output</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span>
            <span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">()[:</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">data</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s4">)</span>

        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span>
            <span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">())[:</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">data</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_asstr_fixed</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s1">length</span><span class="s4">=</span><span class="s6">5</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s5">'cù'</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">data</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">'utf-8'</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">bytes_</span><span class="s4">)</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">str</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>

        <span class="s0"># Different errors parameter</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">(</span><span class="s5">'ascii'</span><span class="s4">, </span><span class="s5">'ignore'</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">], </span><span class="s5">'c'</span><span class="s4">)</span>

        <span class="s0"># latin-1 will decode it but give the wrong text</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertNotEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">(</span><span class="s5">'latin-1'</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">data</span><span class="s4">)</span>

        <span class="s0"># Array output</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span>
            <span class="s1">ds</span><span class="s4">.</span><span class="s1">asstr</span><span class="s4">()[:</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">data</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_unicode_write_error</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Encoding error when writing a non-ASCII string to an ASCII vlen dataset&quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s5">'ascii'</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s5">&quot;fàilte&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">UnicodeEncodeError</span><span class="s4">):</span>
            <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">data</span>

    <span class="s3">def </span><span class="s1">test_unicode_write_bytes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Writing valid utf-8 byte strings to a unicode vlen dataset is OK 
        &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">()</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= (</span><span class="s5">u&quot;Hello there&quot; </span><span class="s4">+ </span><span class="s1">chr</span><span class="s4">(</span><span class="s6">0x2034</span><span class="s4">)).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">'utf8'</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">data</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">out</span><span class="s4">), </span><span class="s1">bytes</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_vlen_bytes_write_ascii_str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Writing an ascii str to ascii vlen dataset is OK 
        &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">string_dtype</span><span class="s4">(</span><span class="s5">'ascii'</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s5">&quot;ASCII string&quot;</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">data</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">type</span><span class="s4">(</span><span class="s1">out</span><span class="s4">), </span><span class="s1">bytes</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">data</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">'ascii'</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestCompound</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Compound types correctly round-trip 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_rt</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Compound types are read back in correct order (issue 236)&quot;&quot;&quot;</span>

        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([ (</span><span class="s5">'weight'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">),</span>
                             <span class="s4">(</span><span class="s5">'cputime'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">),</span>
                             <span class="s4">(</span><span class="s5">'walltime'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">),</span>
                             <span class="s4">(</span><span class="s5">'parents_offset'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint32</span><span class="s4">),</span>
                             <span class="s4">(</span><span class="s5">'n_parents'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint32</span><span class="s4">),</span>
                             <span class="s4">(</span><span class="s5">'status'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint8</span><span class="s4">),</span>
                             <span class="s4">(</span><span class="s5">'endpoint_type'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint8</span><span class="s4">), ])</span>

        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">((</span><span class="s6">16</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">dt</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">:</span>
            <span class="s1">testdata</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">random</span><span class="s4">((</span><span class="s6">16</span><span class="s4">,)) * </span><span class="s6">100</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">] = </span><span class="s1">testdata</span>
        <span class="s1">outdata </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">][...]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">(</span><span class="s1">outdata </span><span class="s4">== </span><span class="s1">testdata</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">outdata</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">testdata</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_assign</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([ (</span><span class="s5">'weight'</span><span class="s4">, (</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">, </span><span class="s6">3</span><span class="s4">)),</span>
                         <span class="s4">(</span><span class="s5">'endpoint_type'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint8</span><span class="s4">), ])</span>

        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">((</span><span class="s6">16</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">dt</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">:</span>
            <span class="s1">testdata</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">random</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">testdata</span><span class="s4">[</span><span class="s1">key</span><span class="s4">].</span><span class="s1">shape</span><span class="s4">) * </span><span class="s6">100</span>

        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'test'</span><span class="s4">, (</span><span class="s6">16</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">dt</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">:</span>
            <span class="s1">ds</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">testdata</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>

        <span class="s1">outdata </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">][...]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertTrue</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">(</span><span class="s1">outdata </span><span class="s4">== </span><span class="s1">testdata</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">outdata</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">testdata</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_fields</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([</span>
            <span class="s4">(</span><span class="s5">'x'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">'y'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">'z'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">),</span>
        <span class="s4">])</span>

        <span class="s1">testdata </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">((</span><span class="s6">16</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">dt</span><span class="s4">.</span><span class="s1">fields</span><span class="s4">:</span>
            <span class="s1">testdata</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">random</span><span class="s4">((</span><span class="s6">16</span><span class="s4">,)) * </span><span class="s6">100</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">] = </span><span class="s1">testdata</span>

        <span class="s0"># Extract multiple fields</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">].</span><span class="s1">fields</span><span class="s4">([</span><span class="s5">'x'</span><span class="s4">, </span><span class="s5">'y'</span><span class="s4">])[:], </span><span class="s1">testdata</span><span class="s4">[[</span><span class="s5">'x'</span><span class="s4">, </span><span class="s5">'y'</span><span class="s4">]]</span>
        <span class="s4">)</span>
        <span class="s0"># Extract single field</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">].</span><span class="s1">fields</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">)[:], </span><span class="s1">testdata</span><span class="s4">[</span><span class="s5">'x'</span><span class="s4">]</span>
        <span class="s4">)</span>
        <span class="s0"># Check __array__() method of fields wrapper</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span>
            <span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">].</span><span class="s1">fields</span><span class="s4">([</span><span class="s5">'x'</span><span class="s4">, </span><span class="s5">'y'</span><span class="s4">])), </span><span class="s1">testdata</span><span class="s4">[[</span><span class="s5">'x'</span><span class="s4">, </span><span class="s5">'y'</span><span class="s4">]]</span>
        <span class="s4">)</span>
        <span class="s0"># Check type conversion of __array__() method</span>
        <span class="s1">dt_int </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([(</span><span class="s5">'x'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">)])</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span>
            <span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">].</span><span class="s1">fields</span><span class="s4">([</span><span class="s5">'x'</span><span class="s4">]), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt_int</span><span class="s4">),</span>
            <span class="s1">testdata</span><span class="s4">[[</span><span class="s5">'x'</span><span class="s4">]].</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">dt_int</span><span class="s4">)</span>
        <span class="s4">)</span>

        <span class="s0"># Check len() on fields wrapper</span>
        <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">].</span><span class="s1">fields</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">)) == </span><span class="s6">16</span>

    <span class="s3">def </span><span class="s1">test_nested_compound_vlen</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt_inner </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">)),</span>
                            <span class="s4">(</span><span class="s5">'b'</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">))])</span>

        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([(</span><span class="s5">'f1'</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">dt_inner</span><span class="s4">)),</span>
                       <span class="s4">(</span><span class="s5">'f2'</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">)])</span>

        <span class="s1">inner1 </span><span class="s4">= (</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s6">1</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">),</span>
                  <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s6">6</span><span class="s4">, </span><span class="s6">9</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">))</span>

        <span class="s1">inner2 </span><span class="s4">= (</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s6">10</span><span class="s4">, </span><span class="s6">14</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">),</span>
                  <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s6">16</span><span class="s4">, </span><span class="s6">21</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span><span class="s4">))</span>

        <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">inner1</span><span class="s4">, </span><span class="s1">inner2</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt_inner</span><span class="s4">), </span><span class="s6">2</span><span class="s4">),</span>
                        <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">inner1</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt_inner</span><span class="s4">), </span><span class="s6">3</span><span class="s4">)],</span>
                        <span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">&quot;ds&quot;</span><span class="s4">] = </span><span class="s1">data</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">&quot;ds&quot;</span><span class="s4">]</span>

        <span class="s0"># Specifying check_alignment=False because vlen fields have 8 bytes of padding</span>
        <span class="s0"># because the vlen datatype in hdf5 occupies 16 bytes</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">check_alignment</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestSubarray</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">test_write_list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;a&quot;</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">&quot;3int8&quot;</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = [</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">]</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[:], [[</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">]])</span>

        <span class="s1">ds</span><span class="s4">[:] = [[</span><span class="s6">4</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, </span><span class="s6">6</span><span class="s4">]]</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[:], [[</span><span class="s6">4</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, </span><span class="s6">6</span><span class="s4">]])</span>

    <span class="s3">def </span><span class="s1">test_write_array</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;a&quot;</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">&quot;3int8&quot;</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">])</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[:], [[</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">]])</span>

        <span class="s1">ds</span><span class="s4">[:] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([[</span><span class="s6">4</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, </span><span class="s6">6</span><span class="s4">]])</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[:], [[</span><span class="s6">4</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, </span><span class="s6">6</span><span class="s4">]])</span>


<span class="s3">class </span><span class="s1">TestEnum</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: Enum datatype info is preserved, read/write as integer 
    &quot;&quot;&quot;</span>

    <span class="s1">EDICT </span><span class="s4">= {</span><span class="s5">'RED'</span><span class="s4">: </span><span class="s6">0</span><span class="s4">, </span><span class="s5">'GREEN'</span><span class="s4">: </span><span class="s6">1</span><span class="s4">, </span><span class="s5">'BLUE'</span><span class="s4">: </span><span class="s6">42</span><span class="s4">}</span>

    <span class="s3">def </span><span class="s1">test_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Enum datasets can be created and type correctly round-trips &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">enum_dtype</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">EDICT</span><span class="s4">, </span><span class="s1">basetype</span><span class="s4">=</span><span class="s5">'i'</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">, </span><span class="s6">100</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">dt2 </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">dtype</span>
        <span class="s1">dict2 </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">check_enum_dtype</span><span class="s4">(</span><span class="s1">dt2</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dict2</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">EDICT</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_readwrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Enum datasets can be read/written as integers &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">enum_dtype</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">EDICT</span><span class="s4">, </span><span class="s1">basetype</span><span class="s4">=</span><span class="s5">'i4'</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">, </span><span class="s6">100</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">35</span><span class="s4">, </span><span class="s6">37</span><span class="s4">] = </span><span class="s6">42</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">, :] = </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">35</span><span class="s4">, </span><span class="s6">37</span><span class="s4">], </span><span class="s6">42</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">, :], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">((</span><span class="s6">1</span><span class="s4">,) * </span><span class="s6">100</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i4'</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestFloats</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Test support for mini and extended-precision floats 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">_exectest</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dt</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[...], </span><span class="s1">data</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipUnless</span><span class="s4">(</span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">np</span><span class="s4">, </span><span class="s5">'float16'</span><span class="s4">), </span><span class="s5">&quot;NumPy float16 support required&quot;</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">test_mini</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Mini-floats round trip &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_exectest</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'float16'</span><span class="s4">))</span>

    <span class="s0"># TODO: move these tests to test_h5t</span>
    <span class="s3">def </span><span class="s1">test_mini_mapping</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Test mapping for float16 &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">np</span><span class="s4">, </span><span class="s5">'float16'</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">IEEE_F16LE</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'&lt;f2'</span><span class="s4">))</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">h5t</span><span class="s4">.</span><span class="s1">IEEE_F16LE</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'&lt;f4'</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestTrackTimes</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Feature: track_times 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_disable_track_times</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; check that when track_times=False, the time stamp=0 (Jan 1, 1970) &quot;&quot;&quot;</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">4</span><span class="s4">,), </span><span class="s1">track_times</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">ds_mtime </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5g</span><span class="s4">.</span><span class="s1">get_objinfo</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">_id</span><span class="s4">).</span><span class="s1">mtime</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">ds_mtime</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_invalid_track_times</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; check that when give track_times an invalid value &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">assertRaises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">4</span><span class="s4">,), </span><span class="s1">track_times</span><span class="s4">=</span><span class="s5">'null'</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestZeroShape</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Features of datasets with (0,)-shape axes 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_array_conversion</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Empty datasets can be converted to NumPy arrays &quot;&quot;&quot;</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">maxshape</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">).</span><span class="s1">shape</span><span class="s4">)</span>

        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'y'</span><span class="s4">, (</span><span class="s6">0</span><span class="s4">,), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s3">None</span><span class="s4">,))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">).</span><span class="s1">shape</span><span class="s4">)</span>

        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'z'</span><span class="s4">, (</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">), </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">).</span><span class="s1">shape</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_reading</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Slicing into empty datasets works correctly &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= [(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s5">'f'</span><span class="s4">), (</span><span class="s5">'b'</span><span class="s4">, </span><span class="s5">'i'</span><span class="s4">)]</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">0</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">, </span><span class="s1">maxshape</span><span class="s4">=(</span><span class="s3">None</span><span class="s4">,))</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">empty</span><span class="s4">((</span><span class="s6">0</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[...].</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[...].</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[()].</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[()].</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">arr</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">)</span>

<span class="s0"># https://github.com/h5py/h5py/issues/1492</span>
<span class="s1">empty_regionref_xfail </span><span class="s4">= </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">xfail</span><span class="s4">(</span>
    <span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">== (</span><span class="s6">1</span><span class="s4">, </span><span class="s6">10</span><span class="s4">, </span><span class="s6">6</span><span class="s4">),</span>
    <span class="s1">reason</span><span class="s4">=</span><span class="s5">&quot;Issue with empty region refs in HDF5 1.10.6&quot;</span><span class="s4">,</span>
<span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestRegionRefs</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Various features of region references 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">BaseDataset</span><span class="s4">.</span><span class="s1">setUp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">100 </span><span class="s4">* </span><span class="s6">100</span><span class="s4">).</span><span class="s1">reshape</span><span class="s4">((</span><span class="s6">100</span><span class="s4">, </span><span class="s6">100</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span>

    <span class="s3">def </span><span class="s1">test_create_ref</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Region references can be used as slicing arguments &quot;&quot;&quot;</span>
        <span class="s1">slic </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">25</span><span class="s4">:</span><span class="s6">35</span><span class="s4">, </span><span class="s6">10</span><span class="s4">:</span><span class="s6">100</span><span class="s4">:</span><span class="s6">5</span><span class="s4">]</span>
        <span class="s1">ref </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">regionref</span><span class="s4">[</span><span class="s1">slic</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">[</span><span class="s1">ref</span><span class="s4">], </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">slic</span><span class="s4">])</span>

    <span class="s4">@</span><span class="s1">empty_regionref_xfail</span>
    <span class="s3">def </span><span class="s1">test_empty_region</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">ref </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">regionref</span><span class="s4">[:</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">[</span><span class="s1">ref</span><span class="s4">]</span>
        <span class="s3">assert </span><span class="s1">out</span><span class="s4">.</span><span class="s1">size </span><span class="s4">== </span><span class="s6">0</span>
        <span class="s0"># Ideally we should preserve shape (0, 100), but it seems this is lost.</span>

    <span class="s4">@</span><span class="s1">empty_regionref_xfail</span>
    <span class="s3">def </span><span class="s1">test_scalar_dataset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;scalar&quot;</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s6">1.0</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'f4'</span><span class="s4">)</span>
        <span class="s1">sid </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5s</span><span class="s4">.</span><span class="s1">create</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5s</span><span class="s4">.</span><span class="s1">SCALAR</span><span class="s4">)</span>

        <span class="s0"># Deselected</span>
        <span class="s1">sid</span><span class="s4">.</span><span class="s1">select_none</span><span class="s4">()</span>
        <span class="s1">ref </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5r</span><span class="s4">.</span><span class="s1">create</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">, </span><span class="s7">b'.'</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5r</span><span class="s4">.</span><span class="s1">DATASET_REGION</span><span class="s4">, </span><span class="s1">sid</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">ds</span><span class="s4">[</span><span class="s1">ref</span><span class="s4">] == </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">Empty</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'f4'</span><span class="s4">))</span>

        <span class="s0"># Selected</span>
        <span class="s1">sid</span><span class="s4">.</span><span class="s1">select_all</span><span class="s4">()</span>
        <span class="s1">ref </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5r</span><span class="s4">.</span><span class="s1">create</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">, </span><span class="s7">b'.'</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5r</span><span class="s4">.</span><span class="s1">DATASET_REGION</span><span class="s4">, </span><span class="s1">sid</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">ds</span><span class="s4">[</span><span class="s1">ref</span><span class="s4">] == </span><span class="s1">ds</span><span class="s4">[()]</span>

    <span class="s3">def </span><span class="s1">test_ref_shape</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Region reference shape and selection shape &quot;&quot;&quot;</span>
        <span class="s1">slic </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">s_</span><span class="s4">[</span><span class="s6">25</span><span class="s4">:</span><span class="s6">35</span><span class="s4">, </span><span class="s6">10</span><span class="s4">:</span><span class="s6">100</span><span class="s4">:</span><span class="s6">5</span><span class="s4">]</span>
        <span class="s1">ref </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">regionref</span><span class="s4">[</span><span class="s1">slic</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">regionref</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">(</span><span class="s1">ref</span><span class="s4">), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">regionref</span><span class="s4">.</span><span class="s1">selection</span><span class="s4">(</span><span class="s1">ref</span><span class="s4">), (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">18</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestAstype</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;.astype() wrapper &amp; context manager 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">test_astype_wrapper</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i2'</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">100</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">dset</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s5">'f4'</span><span class="s4">)[:]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">100</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'f4'</span><span class="s4">))</span>


    <span class="s3">def </span><span class="s1">test_astype_wrapper_len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i2'</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">100</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s6">100</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s5">'f4'</span><span class="s4">)))</span>

    <span class="s3">def </span><span class="s1">test_astype_wrapper_asarray</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i2'</span><span class="s4">)</span>
        <span class="s1">dset</span><span class="s4">[...] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">100</span><span class="s4">)</span>
        <span class="s1">arr </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s5">'f4'</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i2'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">arr</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">100</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i2'</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestScalarCompound</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s2">&quot;&quot;&quot; 
        Retrieval of a single field from a scalar compound dataset should 
        strip the field info 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">test_scalar_compound</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>

        <span class="s1">dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">([(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s5">'i'</span><span class="s4">)])</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[</span><span class="s5">'a'</span><span class="s4">].</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'i'</span><span class="s4">))</span>


<span class="s3">class </span><span class="s1">TestVlen</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">test_int</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'vlen'</span><span class="s4">, (</span><span class="s6">4</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">2</span><span class="s4">] = [</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">]</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">3</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">0</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">2</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">]))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">0</span><span class="s4">))</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">2</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">4</span><span class="s4">)], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">4</span><span class="s4">))</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">2</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">)])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_reuse_from_other</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'vlen'</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'vlen2'</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,), </span><span class="s1">ds</span><span class="s4">[()].</span><span class="s1">dtype</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_reuse_struct_from_other</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= [(</span><span class="s5">'a'</span><span class="s4">, </span><span class="s1">int</span><span class="s4">), (</span><span class="s5">'b'</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">int</span><span class="s4">))]</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'vlen'</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">fname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s5">'a'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'vlen2'</span><span class="s4">, (</span><span class="s6">1</span><span class="s4">,), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'vlen'</span><span class="s4">][</span><span class="s5">'b'</span><span class="s4">][()].</span><span class="s1">dtype</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_convert</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'vlen'</span><span class="s4">, (</span><span class="s6">3</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1.4</span><span class="s4">, </span><span class="s6">1.2</span><span class="s4">])</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1.2</span><span class="s4">])</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">2</span><span class="s4">] = [</span><span class="s6">1.2</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">1</span><span class="s4">]))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">]))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">2</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">3</span><span class="s4">]))</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">2</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([[</span><span class="s6">0.1</span><span class="s4">, </span><span class="s6">1.1</span><span class="s4">, </span><span class="s6">2.1</span><span class="s4">, </span><span class="s6">3.1</span><span class="s4">, </span><span class="s6">4</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">4</span><span class="s4">)], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">5</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">4</span><span class="s4">))</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">:</span><span class="s6">2</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">0.1</span><span class="s4">, </span><span class="s6">1.2</span><span class="s4">, </span><span class="s6">2.2</span><span class="s4">]),</span>
                            <span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">0.2</span><span class="s4">, </span><span class="s6">1.2</span><span class="s4">, </span><span class="s6">2.2</span><span class="s4">])])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_multidim</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">int</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'vlen'</span><span class="s4">, (</span><span class="s6">2</span><span class="s4">, </span><span class="s6">2</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[:, :] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([[</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">3</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)],</span>
                            <span class="s4">[</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">1</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)]], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">object</span><span class="s4">)</span>
        <span class="s1">ds</span><span class="s4">[:, :] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([[</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">2</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)],</span>
                             <span class="s4">[</span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">2</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">arange</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)]])</span>

    <span class="s3">def </span><span class="s1">_help_float_testing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">np_dt</span><span class="s4">, </span><span class="s1">dataset_name</span><span class="s4">=</span><span class="s5">'vlen'</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; 
        Helper for testing various vlen numpy data types. 
        :param np_dt: Numpy datatype to test 
        :param dataset_name: String name of the dataset to create for testing. 
        &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s1">np_dt</span><span class="s4">)</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s1">dataset_name</span><span class="s4">, (</span><span class="s6">5</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dt</span><span class="s4">)</span>

        <span class="s0"># Create some arrays, and assign them to the dataset</span>
        <span class="s1">array_0 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1.</span><span class="s4">, </span><span class="s6">2.</span><span class="s4">, </span><span class="s6">30.</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np_dt</span><span class="s4">)</span>
        <span class="s1">array_1 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">100.3</span><span class="s4">, </span><span class="s6">200.4</span><span class="s4">, </span><span class="s6">98.1</span><span class="s4">, -</span><span class="s6">10.5</span><span class="s4">, -</span><span class="s6">300.0</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np_dt</span><span class="s4">)</span>

        <span class="s0"># Test that a numpy array of different type gets cast correctly</span>
        <span class="s1">array_2 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">8</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'int32'</span><span class="s4">))</span>
        <span class="s1">casted_array_2 </span><span class="s4">= </span><span class="s1">array_2</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">np_dt</span><span class="s4">)</span>

        <span class="s0"># Test that we can set a list of floats.</span>
        <span class="s1">list_3 </span><span class="s4">= [</span><span class="s6">1.</span><span class="s4">, </span><span class="s6">2.</span><span class="s4">, </span><span class="s6">900.</span><span class="s4">, </span><span class="s6">0.</span><span class="s4">, -</span><span class="s6">0.5</span><span class="s4">]</span>
        <span class="s1">list_array_3 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">list_3</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np_dt</span><span class="s4">)</span>

        <span class="s0"># Test that a list of integers gets casted correctly</span>
        <span class="s1">list_4 </span><span class="s4">= [-</span><span class="s6">1</span><span class="s4">, -</span><span class="s6">100</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s6">9999</span><span class="s4">, </span><span class="s6">70</span><span class="s4">]</span>
        <span class="s1">list_array_4 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">list_4</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np_dt</span><span class="s4">)</span>

        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">array_0</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s1">array_1</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">2</span><span class="s4">] = </span><span class="s1">array_2</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">3</span><span class="s4">] = </span><span class="s1">list_3</span>
        <span class="s1">ds</span><span class="s4">[</span><span class="s6">4</span><span class="s4">] = </span><span class="s1">list_4</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">array_0</span><span class="s4">, </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">array_1</span><span class="s4">, </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">1</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">casted_array_2</span><span class="s4">, </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">2</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">list_array_3</span><span class="s4">, </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">3</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">list_array_4</span><span class="s4">, </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">4</span><span class="s4">])</span>

        <span class="s0"># Test that we can reassign arrays in the dataset</span>
        <span class="s1">list_array_3 </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">0.3</span><span class="s4">, </span><span class="s6">2.2</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np_dt</span><span class="s4">)</span>

        <span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">list_array_3</span><span class="s4">[:]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertArrayEqual</span><span class="s4">(</span><span class="s1">list_array_3</span><span class="s4">, </span><span class="s1">ds</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>

        <span class="s0"># Make sure we can close the file.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">flush</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_numpy_float16</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">np_dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'float16'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_help_float_testing</span><span class="s4">(</span><span class="s1">np_dt</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_numpy_float32</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">np_dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'float32'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_help_float_testing</span><span class="s4">(</span><span class="s1">np_dt</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_numpy_float64_from_dtype</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">np_dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s5">'float64'</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_help_float_testing</span><span class="s4">(</span><span class="s1">np_dt</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_numpy_float64_2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">np_dt </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_help_float_testing</span><span class="s4">(</span><span class="s1">np_dt</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">test_non_contiguous_arrays</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Test that non-contiguous arrays are stored correctly&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'nc'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s5">'bool'</span><span class="s4">))</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'nc'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">x</span><span class="s4">[::</span><span class="s6">2</span><span class="s4">]</span>

        <span class="s3">assert </span><span class="s1">all</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'nc'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] == </span><span class="s1">x</span><span class="s4">[::</span><span class="s6">2</span><span class="s4">]), </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'nc'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span><span class="s3">} </span><span class="s5">!= </span><span class="s3">{</span><span class="s1">x</span><span class="s4">[::</span><span class="s6">2</span><span class="s4">]</span><span class="s3">}</span><span class="s5">&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'nc2'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">,), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">vlen_dtype</span><span class="s4">(</span><span class="s5">'int8'</span><span class="s4">))</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">2</span><span class="s4">, </span><span class="s6">4</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s6">5</span><span class="s4">, -</span><span class="s6">1</span><span class="s4">, </span><span class="s6">3</span><span class="s4">, </span><span class="s6">7</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'nc2'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">y</span><span class="s4">[::</span><span class="s6">2</span><span class="s4">]</span>

        <span class="s3">assert </span><span class="s1">all</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'nc2'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] == </span><span class="s1">y</span><span class="s4">[::</span><span class="s6">2</span><span class="s4">]), </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">[</span><span class="s5">'nc2'</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span><span class="s3">} </span><span class="s5">!= </span><span class="s3">{</span><span class="s1">y</span><span class="s4">[::</span><span class="s6">2</span><span class="s4">]</span><span class="s3">}</span><span class="s5">&quot;</span>


<span class="s3">class </span><span class="s1">TestLowOpen</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>

    <span class="s3">def </span><span class="s1">test_get_access_list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Test H5Dget_access_plist &quot;&quot;&quot;</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">4</span><span class="s4">,))</span>
        <span class="s1">p_list </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">test_dapl</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot; Test the dapl keyword to h5d.open &quot;&quot;&quot;</span>
        <span class="s1">dapl </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5p</span><span class="s4">.</span><span class="s1">create</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5p</span><span class="s4">.</span><span class="s1">DATASET_ACCESS</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, (</span><span class="s6">100</span><span class="s4">,))</span>
        <span class="s3">del </span><span class="s1">dset</span>
        <span class="s1">dsid </span><span class="s4">= </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5d</span><span class="s4">.</span><span class="s1">open</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">id</span><span class="s4">, </span><span class="s7">b'x'</span><span class="s4">, </span><span class="s1">dapl</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">dsid</span><span class="s4">, </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">h5d</span><span class="s4">.</span><span class="s1">DatasetID</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipUnless</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&gt;= (</span><span class="s6">1</span><span class="s4">, </span><span class="s6">10</span><span class="s4">, </span><span class="s6">5</span><span class="s4">),</span>
               <span class="s5">&quot;chunk info requires  HDF5 &gt;= 1.10.5&quot;</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_get_chunk_details</span><span class="s4">():</span>
    <span class="s3">from </span><span class="s1">io </span><span class="s3">import </span><span class="s1">BytesIO</span>
    <span class="s1">buf </span><span class="s4">= </span><span class="s1">BytesIO</span><span class="s4">()</span>
    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fout</span><span class="s4">:</span>
        <span class="s1">fout</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'test'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">100</span><span class="s4">, </span><span class="s6">100</span><span class="s4">), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i4'</span><span class="s4">)</span>
        <span class="s1">fout</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">][:] = </span><span class="s6">1</span>

    <span class="s1">buf</span><span class="s4">.</span><span class="s1">seek</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fin</span><span class="s4">:</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">fin</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">].</span><span class="s1">id</span>

        <span class="s3">assert </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">get_num_chunks</span><span class="s4">() == </span><span class="s6">100</span>
        <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s6">100</span><span class="s4">):</span>
            <span class="s1">offset </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">unravel_index</span><span class="s4">(</span><span class="s1">j</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">))) * </span><span class="s6">10</span><span class="s4">)</span>

            <span class="s1">si </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">get_chunk_info</span><span class="s4">(</span><span class="s1">j</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">si</span><span class="s4">.</span><span class="s1">chunk_offset </span><span class="s4">== </span><span class="s1">offset</span>
            <span class="s3">assert </span><span class="s1">si</span><span class="s4">.</span><span class="s1">filter_mask </span><span class="s4">== </span><span class="s6">0</span>
            <span class="s3">assert </span><span class="s1">si</span><span class="s4">.</span><span class="s1">byte_offset </span><span class="s3">is not None</span>
            <span class="s3">assert </span><span class="s1">si</span><span class="s4">.</span><span class="s1">size </span><span class="s4">&gt; </span><span class="s6">0</span>

        <span class="s1">si </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">get_chunk_info_by_coord</span><span class="s4">((</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">))</span>
        <span class="s3">assert </span><span class="s1">si</span><span class="s4">.</span><span class="s1">chunk_offset </span><span class="s4">== (</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">si</span><span class="s4">.</span><span class="s1">filter_mask </span><span class="s4">== </span><span class="s6">0</span>
        <span class="s3">assert </span><span class="s1">si</span><span class="s4">.</span><span class="s1">byte_offset </span><span class="s3">is not None</span>
        <span class="s3">assert </span><span class="s1">si</span><span class="s4">.</span><span class="s1">size </span><span class="s4">&gt; </span><span class="s6">0</span>


<span class="s4">@</span><span class="s1">ut</span><span class="s4">.</span><span class="s1">skipUnless</span><span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&gt;= (</span><span class="s6">1</span><span class="s4">, </span><span class="s6">12</span><span class="s4">, </span><span class="s6">3</span><span class="s4">) </span><span class="s3">or</span>
               <span class="s4">(</span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&gt;= (</span><span class="s6">1</span><span class="s4">, </span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">) </span><span class="s3">and </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">version</span><span class="s4">.</span><span class="s1">hdf5_version_tuple </span><span class="s4">&lt; (</span><span class="s6">1</span><span class="s4">, </span><span class="s6">10</span><span class="s4">, </span><span class="s6">99</span><span class="s4">)),</span>
               <span class="s5">&quot;chunk iteration requires  HDF5 1.10.10 and later 1.10, or 1.12.3 and later&quot;</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_chunk_iter</span><span class="s4">():</span>
    <span class="s2">&quot;&quot;&quot;H5Dchunk_iter() for chunk information&quot;&quot;&quot;</span>
    <span class="s3">from </span><span class="s1">io </span><span class="s3">import </span><span class="s1">BytesIO</span>
    <span class="s1">buf </span><span class="s4">= </span><span class="s1">BytesIO</span><span class="s4">()</span>
    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
        <span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'test'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">100</span><span class="s4">, </span><span class="s6">100</span><span class="s4">), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i4'</span><span class="s4">)</span>
        <span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">][:] = </span><span class="s6">1</span>

    <span class="s1">buf</span><span class="s4">.</span><span class="s1">seek</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
        <span class="s1">dsid </span><span class="s4">= </span><span class="s1">f</span><span class="s4">[</span><span class="s5">'test'</span><span class="s4">].</span><span class="s1">id</span>

        <span class="s1">num_chunks </span><span class="s4">= </span><span class="s1">dsid</span><span class="s4">.</span><span class="s1">get_num_chunks</span><span class="s4">()</span>
        <span class="s3">assert </span><span class="s1">num_chunks </span><span class="s4">== </span><span class="s6">100</span>
        <span class="s1">ci </span><span class="s4">= {}</span>
        <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">num_chunks</span><span class="s4">):</span>
            <span class="s1">si </span><span class="s4">= </span><span class="s1">dsid</span><span class="s4">.</span><span class="s1">get_chunk_info</span><span class="s4">(</span><span class="s1">j</span><span class="s4">)</span>
            <span class="s1">ci</span><span class="s4">[</span><span class="s1">si</span><span class="s4">.</span><span class="s1">chunk_offset</span><span class="s4">] = </span><span class="s1">si</span>

        <span class="s3">def </span><span class="s1">callback</span><span class="s4">(</span><span class="s1">chunk_info</span><span class="s4">):</span>
            <span class="s1">known </span><span class="s4">= </span><span class="s1">ci</span><span class="s4">[</span><span class="s1">chunk_info</span><span class="s4">.</span><span class="s1">chunk_offset</span><span class="s4">]</span>
            <span class="s3">assert </span><span class="s1">chunk_info</span><span class="s4">.</span><span class="s1">chunk_offset </span><span class="s4">== </span><span class="s1">known</span><span class="s4">.</span><span class="s1">chunk_offset</span>
            <span class="s3">assert </span><span class="s1">chunk_info</span><span class="s4">.</span><span class="s1">filter_mask </span><span class="s4">== </span><span class="s1">known</span><span class="s4">.</span><span class="s1">filter_mask</span>
            <span class="s3">assert </span><span class="s1">chunk_info</span><span class="s4">.</span><span class="s1">byte_offset </span><span class="s4">== </span><span class="s1">known</span><span class="s4">.</span><span class="s1">byte_offset</span>
            <span class="s3">assert </span><span class="s1">chunk_info</span><span class="s4">.</span><span class="s1">size </span><span class="s4">== </span><span class="s1">known</span><span class="s4">.</span><span class="s1">size</span>

        <span class="s1">dsid</span><span class="s4">.</span><span class="s1">chunk_iter</span><span class="s4">(</span><span class="s1">callback</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_empty_shape</span><span class="s4">(</span><span class="s1">writable_file</span><span class="s4">):</span>
    <span class="s1">ds </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'empty'</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'int32'</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">shape </span><span class="s3">is None</span>
    <span class="s3">assert </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">maxshape </span><span class="s3">is None</span>


<span class="s3">def </span><span class="s1">test_zero_storage_size</span><span class="s4">():</span>
    <span class="s0"># https://github.com/h5py/h5py/issues/1475</span>
    <span class="s3">from </span><span class="s1">io </span><span class="s3">import </span><span class="s1">BytesIO</span>
    <span class="s1">buf </span><span class="s4">= </span><span class="s1">BytesIO</span><span class="s4">()</span>
    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fout</span><span class="s4">:</span>
        <span class="s1">fout</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'empty'</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'uint8'</span><span class="s4">)</span>

    <span class="s1">buf</span><span class="s4">.</span><span class="s1">seek</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fin</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">fin</span><span class="s4">[</span><span class="s5">'empty'</span><span class="s4">].</span><span class="s1">chunks </span><span class="s3">is None</span>
        <span class="s3">assert </span><span class="s1">fin</span><span class="s4">[</span><span class="s5">'empty'</span><span class="s4">].</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_offset</span><span class="s4">() </span><span class="s3">is None</span>
        <span class="s3">assert </span><span class="s1">fin</span><span class="s4">[</span><span class="s5">'empty'</span><span class="s4">].</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_storage_size</span><span class="s4">() == </span><span class="s6">0</span>


<span class="s3">def </span><span class="s1">test_python_int_uint64</span><span class="s4">(</span><span class="s1">writable_file</span><span class="s4">):</span>
    <span class="s0"># https://github.com/h5py/h5py/issues/1547</span>
    <span class="s1">data </span><span class="s4">= [</span><span class="s1">np</span><span class="s4">.</span><span class="s1">iinfo</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">).</span><span class="s1">max</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">iinfo</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">int64</span><span class="s4">).</span><span class="s1">max </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">]</span>

    <span class="s0"># Check creating a new dataset</span>
    <span class="s1">ds </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'x'</span><span class="s4">, </span><span class="s1">data</span><span class="s4">=</span><span class="s1">data</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint64</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">dtype </span><span class="s4">== </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint64</span><span class="s4">)</span>
    <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[:], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint64</span><span class="s4">))</span>

    <span class="s0"># Check writing to an existing dataset</span>
    <span class="s1">ds</span><span class="s4">[:] = </span><span class="s1">data</span>
    <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">ds</span><span class="s4">[:], </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint64</span><span class="s4">))</span>


<span class="s3">def </span><span class="s1">test_setitem_fancy_indexing</span><span class="s4">(</span><span class="s1">writable_file</span><span class="s4">):</span>
    <span class="s0"># https://github.com/h5py/h5py/issues/1593</span>
    <span class="s1">arr </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">'data'</span><span class="s4">, (</span><span class="s6">5</span><span class="s4">, </span><span class="s6">1000</span><span class="s4">, </span><span class="s6">2</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint8</span><span class="s4">)</span>
    <span class="s1">block </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s6">255</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=(</span><span class="s6">5</span><span class="s4">, </span><span class="s6">3</span><span class="s4">, </span><span class="s6">2</span><span class="s4">))</span>
    <span class="s1">arr</span><span class="s4">[:, [</span><span class="s6">0</span><span class="s4">, </span><span class="s6">2</span><span class="s4">, </span><span class="s6">4</span><span class="s4">], ...] = </span><span class="s1">block</span>


<span class="s3">def </span><span class="s1">test_vlen_spacepad</span><span class="s4">():</span>
    <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">get_data_file_path</span><span class="s4">(</span><span class="s5">&quot;vlen_string_dset.h5&quot;</span><span class="s4">)) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">f</span><span class="s4">[</span><span class="s5">&quot;DS1&quot;</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] == </span><span class="s7">b&quot;Parting&quot;</span>


<span class="s3">def </span><span class="s1">test_vlen_nullterm</span><span class="s4">():</span>
    <span class="s3">with </span><span class="s1">File</span><span class="s4">(</span><span class="s1">get_data_file_path</span><span class="s4">(</span><span class="s5">&quot;vlen_string_dset_utc.h5&quot;</span><span class="s4">)) </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">f</span><span class="s4">[</span><span class="s5">&quot;ds1&quot;</span><span class="s4">][</span><span class="s6">0</span><span class="s4">] == </span><span class="s7">b&quot;2009-12-20T10:16:18.662409Z&quot;</span>


<span class="s3">def </span><span class="s1">test_allow_unknown_filter</span><span class="s4">(</span><span class="s1">writable_file</span><span class="s4">):</span>
    <span class="s0"># apparently 256-511 are reserved for testing purposes</span>
    <span class="s1">fake_filter_id </span><span class="s4">= </span><span class="s6">256</span>
    <span class="s1">ds </span><span class="s4">= </span><span class="s1">writable_file</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span>
        <span class="s5">'data'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">, </span><span class="s6">10</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">uint8</span><span class="s4">, </span><span class="s1">compression</span><span class="s4">=</span><span class="s1">fake_filter_id</span><span class="s4">,</span>
        <span class="s1">allow_unknown_filter</span><span class="s4">=</span><span class="s3">True</span>
    <span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">fake_filter_id</span><span class="s4">) </span><span class="s3">in </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">_filters</span>


<span class="s3">def </span><span class="s1">test_dset_chunk_cache</span><span class="s4">():</span>
    <span class="s2">&quot;&quot;&quot;Chunk cache configuration for individual datasets.&quot;&quot;&quot;</span>
    <span class="s3">from </span><span class="s1">io </span><span class="s3">import </span><span class="s1">BytesIO</span>
    <span class="s1">buf </span><span class="s4">= </span><span class="s1">BytesIO</span><span class="s4">()</span>
    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s5">'w'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fout</span><span class="s4">:</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">fout</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span>
            <span class="s5">'x'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">, </span><span class="s6">20</span><span class="s4">), </span><span class="s1">chunks</span><span class="s4">=(</span><span class="s6">5</span><span class="s4">, </span><span class="s6">4</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i4'</span><span class="s4">,</span>
            <span class="s1">rdcc_nbytes</span><span class="s4">=</span><span class="s6">2 </span><span class="s4">* </span><span class="s6">1024 </span><span class="s4">* </span><span class="s6">1024</span><span class="s4">, </span><span class="s1">rdcc_w0</span><span class="s4">=</span><span class="s6">0.2</span><span class="s4">, </span><span class="s1">rdcc_nslots</span><span class="s4">=</span><span class="s6">997</span><span class="s4">)</span>
        <span class="s1">ds_chunk_cache </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_chunk_cache</span><span class="s4">()</span>
        <span class="s3">assert </span><span class="s1">fout</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_cache</span><span class="s4">()[</span><span class="s6">1</span><span class="s4">:] != </span><span class="s1">ds_chunk_cache</span>
        <span class="s3">assert </span><span class="s1">ds_chunk_cache </span><span class="s4">== (</span><span class="s6">997</span><span class="s4">, </span><span class="s6">2 </span><span class="s4">* </span><span class="s6">1024 </span><span class="s4">* </span><span class="s6">1024</span><span class="s4">, </span><span class="s6">0.2</span><span class="s4">)</span>

    <span class="s1">buf</span><span class="s4">.</span><span class="s1">seek</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">h5py</span><span class="s4">.</span><span class="s1">File</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s5">'r'</span><span class="s4">) </span><span class="s3">as </span><span class="s1">fin</span><span class="s4">:</span>
        <span class="s1">ds </span><span class="s4">= </span><span class="s1">fin</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span>
            <span class="s5">'x'</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">=(</span><span class="s6">10</span><span class="s4">, </span><span class="s6">20</span><span class="s4">), </span><span class="s1">dtype</span><span class="s4">=</span><span class="s5">'i4'</span><span class="s4">,</span>
            <span class="s1">rdcc_nbytes</span><span class="s4">=</span><span class="s6">3 </span><span class="s4">* </span><span class="s6">1024 </span><span class="s4">* </span><span class="s6">1024</span><span class="s4">, </span><span class="s1">rdcc_w0</span><span class="s4">=</span><span class="s6">0.67</span><span class="s4">, </span><span class="s1">rdcc_nslots</span><span class="s4">=</span><span class="s6">709</span><span class="s4">)</span>
        <span class="s1">ds_chunk_cache </span><span class="s4">= </span><span class="s1">ds</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_chunk_cache</span><span class="s4">()</span>
        <span class="s3">assert </span><span class="s1">fin</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_cache</span><span class="s4">()[</span><span class="s6">1</span><span class="s4">:] != </span><span class="s1">ds_chunk_cache</span>
        <span class="s3">assert </span><span class="s1">ds_chunk_cache </span><span class="s4">== (</span><span class="s6">709</span><span class="s4">, </span><span class="s6">3 </span><span class="s4">* </span><span class="s6">1024 </span><span class="s4">* </span><span class="s6">1024</span><span class="s4">, </span><span class="s6">0.67</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">TestCommutative</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Test the symmetry of operators, at least with the numpy types. 
    Issue: https://github.com/h5py/h5py/issues/1947 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">test_numpy_commutative</span><span class="s4">(</span><span class="s1">self</span><span class="s4">,):</span>
        <span class="s2">&quot;&quot;&quot; 
        Create a h5py dataset, extract one element convert to numpy 
        Check that it returns symmetric response to == and != 
        &quot;&quot;&quot;</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">100</span><span class="s4">,</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;test&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">,</span>
                                     <span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(*</span><span class="s1">shape</span><span class="s4">))</span>

        <span class="s0"># grab a value from the elements, ie dset[0, 0]</span>
        <span class="s0"># check that mask arrays are commutative wrt ==, !=</span>
        <span class="s1">val </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">])</span>

        <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">((</span><span class="s1">val </span><span class="s4">== </span><span class="s1">dset</span><span class="s4">) == (</span><span class="s1">dset </span><span class="s4">== </span><span class="s1">val</span><span class="s4">))</span>
        <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">((</span><span class="s1">val </span><span class="s4">!= </span><span class="s1">dset</span><span class="s4">) == (</span><span class="s1">dset </span><span class="s4">!= </span><span class="s1">val</span><span class="s4">))</span>

        <span class="s0"># generate sample not in the dset, ie max(dset)+delta</span>
        <span class="s0"># check that mask arrays are commutative wrt ==, !=</span>
        <span class="s1">delta </span><span class="s4">= </span><span class="s6">0.001</span>
        <span class="s1">nval </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">nanmax</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">)+</span><span class="s1">delta</span>

        <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">((</span><span class="s1">nval </span><span class="s4">== </span><span class="s1">dset</span><span class="s4">) == (</span><span class="s1">dset </span><span class="s4">== </span><span class="s1">nval</span><span class="s4">))</span>
        <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">((</span><span class="s1">nval </span><span class="s4">!= </span><span class="s1">dset</span><span class="s4">) == (</span><span class="s1">dset </span><span class="s4">!= </span><span class="s1">nval</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">test_basetype_commutative</span><span class="s4">(</span><span class="s1">self</span><span class="s4">,):</span>
        <span class="s2">&quot;&quot;&quot; 
        Create a h5py dataset and check basetype compatibility. 
        Check that operation is symmetric, even if it is potentially 
        not meaningful. 
        &quot;&quot;&quot;</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">100</span><span class="s4">,</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;test&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">,</span>
                                     <span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(*</span><span class="s1">shape</span><span class="s4">))</span>

        <span class="s0"># generate float type, sample float(0.)</span>
        <span class="s0"># check that operation is symmetric (but potentially meaningless)</span>
        <span class="s1">val </span><span class="s4">= </span><span class="s1">float</span><span class="s4">(</span><span class="s6">0.</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s4">(</span><span class="s1">val </span><span class="s4">== </span><span class="s1">dset</span><span class="s4">) == (</span><span class="s1">dset </span><span class="s4">== </span><span class="s1">val</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s4">(</span><span class="s1">val </span><span class="s4">!= </span><span class="s1">dset</span><span class="s4">) == (</span><span class="s1">dset </span><span class="s4">!= </span><span class="s1">val</span><span class="s4">)</span>

<span class="s3">class </span><span class="s1">TestVirtualPrefix</span><span class="s4">(</span><span class="s1">BaseDataset</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Test setting virtual prefix 
    &quot;&quot;&quot;</span>
    <span class="s3">def </span><span class="s1">test_virtual_prefix_create</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">shape </span><span class="s4">= (</span><span class="s6">100</span><span class="s4">,</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">virtual_prefix </span><span class="s4">= </span><span class="s5">&quot;/path/to/virtual&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">create_dataset</span><span class="s4">(</span><span class="s5">&quot;test&quot;</span><span class="s4">, </span><span class="s1">shape</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">float</span><span class="s4">,</span>
                                     <span class="s1">data</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(*</span><span class="s1">shape</span><span class="s4">),</span>
                                     <span class="s1">virtual_prefix </span><span class="s4">= </span><span class="s1">virtual_prefix</span><span class="s4">)</span>

        <span class="s1">virtual_prefix_readback </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_virtual_prefix</span><span class="s4">().</span><span class="s1">decode</span><span class="s4">()).</span><span class="s1">as_posix</span><span class="s4">()</span>
        <span class="s3">assert </span><span class="s1">virtual_prefix_readback </span><span class="s4">== </span><span class="s1">virtual_prefix</span>

    <span class="s3">def </span><span class="s1">test_virtual_prefix_require</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">virtual_prefix </span><span class="s4">= </span><span class="s5">&quot;/path/to/virtual&quot;</span>
        <span class="s1">dset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">f</span><span class="s4">.</span><span class="s1">require_dataset</span><span class="s4">(</span><span class="s5">'foo'</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">), </span><span class="s5">'f'</span><span class="s4">, </span><span class="s1">virtual_prefix </span><span class="s4">= </span><span class="s1">virtual_prefix</span><span class="s4">)</span>
        <span class="s1">virtual_prefix_readback </span><span class="s4">= </span><span class="s1">pathlib</span><span class="s4">.</span><span class="s1">Path</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">id</span><span class="s4">.</span><span class="s1">get_access_plist</span><span class="s4">().</span><span class="s1">get_virtual_prefix</span><span class="s4">().</span><span class="s1">decode</span><span class="s4">()).</span><span class="s1">as_posix</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">virtual_prefix</span><span class="s4">, </span><span class="s1">virtual_prefix_readback</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertIsInstance</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">, </span><span class="s1">Dataset</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">assertEqual</span><span class="s4">(</span><span class="s1">dset</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, (</span><span class="s6">10</span><span class="s4">, </span><span class="s6">3</span><span class="s4">))</span>
</pre>
</body>
</html>