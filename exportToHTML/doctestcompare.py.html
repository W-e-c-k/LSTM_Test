<html>
<head>
<title>doctestcompare.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
doctestcompare.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
lxml-based doctest output comparison. 
 
Note: normally, you should just import the `lxml.usedoctest` and 
`lxml.html.usedoctest` modules from within a doctest, instead of this 
one:: 
 
    &gt;&gt;&gt; import lxml.usedoctest # for XML output 
 
    &gt;&gt;&gt; import lxml.html.usedoctest # for HTML output 
 
To use this module directly, you must call ``lxmldoctest.install()``, 
which will cause doctest to use this in all subsequent calls. 
 
This changes the way output is checked and comparisons are made for 
XML or HTML-like content. 
 
XML or HTML content is noticed because the example starts with ``&lt;`` 
(it's HTML if it starts with ``&lt;html``).  You can also use the 
``PARSE_HTML`` and ``PARSE_XML`` flags to force parsing. 
 
Some rough wildcard-like things are allowed.  Whitespace is generally 
ignored (except in attributes).  In text (attributes and text in the 
body) you can use ``...`` as a wildcard.  In an example it also 
matches any trailing tags in the element, though it does not match 
leading tags.  You may create a tag ``&lt;any&gt;`` or include an ``any`` 
attribute in the tag.  An ``any`` tag matches any tag, while the 
attribute matches any and all attributes. 
 
When a match fails, the reformatted example and gotten text is 
displayed (indented), and a rough diff-like output is given.  Anything 
marked with ``+`` is in the output but wasn't supposed to be, and 
similarly ``-`` means its in the example but wasn't in the output. 
 
You can disable parsing on one line with ``# doctest:+NOPARSE_MARKUP`` 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">lxml </span><span class="s2">import </span><span class="s1">etree</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">doctest</span>
<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">html </span><span class="s2">import </span><span class="s1">escape </span><span class="s2">as </span><span class="s1">html_escape</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">cgi </span><span class="s2">import </span><span class="s1">escape </span><span class="s2">as </span><span class="s1">html_escape</span>

<span class="s1">__all__ </span><span class="s3">= [</span><span class="s4">'PARSE_HTML'</span><span class="s3">, </span><span class="s4">'PARSE_XML'</span><span class="s3">, </span><span class="s4">'NOPARSE_MARKUP'</span><span class="s3">, </span><span class="s4">'LXMLOutputChecker'</span><span class="s3">,</span>
           <span class="s4">'LHTMLOutputChecker'</span><span class="s3">, </span><span class="s4">'install'</span><span class="s3">, </span><span class="s4">'temp_install'</span><span class="s3">]</span>

<span class="s1">PARSE_HTML </span><span class="s3">= </span><span class="s1">doctest</span><span class="s3">.</span><span class="s1">register_optionflag</span><span class="s3">(</span><span class="s4">'PARSE_HTML'</span><span class="s3">)</span>
<span class="s1">PARSE_XML </span><span class="s3">= </span><span class="s1">doctest</span><span class="s3">.</span><span class="s1">register_optionflag</span><span class="s3">(</span><span class="s4">'PARSE_XML'</span><span class="s3">)</span>
<span class="s1">NOPARSE_MARKUP </span><span class="s3">= </span><span class="s1">doctest</span><span class="s3">.</span><span class="s1">register_optionflag</span><span class="s3">(</span><span class="s4">'NOPARSE_MARKUP'</span><span class="s3">)</span>

<span class="s1">OutputChecker </span><span class="s3">= </span><span class="s1">doctest</span><span class="s3">.</span><span class="s1">OutputChecker</span>

<span class="s2">def </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">v</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">v </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">return None</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">v</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>

<span class="s2">def </span><span class="s1">norm_whitespace</span><span class="s3">(</span><span class="s1">v</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">_norm_whitespace_re</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">, </span><span class="s1">v</span><span class="s3">)</span>

<span class="s1">_html_parser </span><span class="s3">= </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">HTMLParser</span><span class="s3">(</span><span class="s1">recover</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">remove_blank_text</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">html_fromstring</span><span class="s3">(</span><span class="s1">html</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">fromstring</span><span class="s3">(</span><span class="s1">html</span><span class="s3">, </span><span class="s1">_html_parser</span><span class="s3">)</span>

<span class="s5"># We use this to distinguish repr()s from elements:</span>
<span class="s1">_repr_re </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r'^&lt;[^&gt;]+ (at|object) '</span><span class="s3">)</span>
<span class="s1">_norm_whitespace_re </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r'[ \t\n][ \t\n]+'</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">LXMLOutputChecker</span><span class="s3">(</span><span class="s1">OutputChecker</span><span class="s3">):</span>

    <span class="s1">empty_tags </span><span class="s3">= (</span>
        <span class="s4">'param'</span><span class="s3">, </span><span class="s4">'img'</span><span class="s3">, </span><span class="s4">'area'</span><span class="s3">, </span><span class="s4">'br'</span><span class="s3">, </span><span class="s4">'basefont'</span><span class="s3">, </span><span class="s4">'input'</span><span class="s3">,</span>
        <span class="s4">'base'</span><span class="s3">, </span><span class="s4">'meta'</span><span class="s3">, </span><span class="s4">'link'</span><span class="s3">, </span><span class="s4">'col'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_default_parser</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">XML</span>

    <span class="s2">def </span><span class="s1">check_output</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">optionflags</span><span class="s3">):</span>
        <span class="s1">alt_self </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s4">'_temp_override_self'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">alt_self </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">super_method </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_temp_call_super_check_output</span>
            <span class="s1">self </span><span class="s3">= </span><span class="s1">alt_self</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">super_method </span><span class="s3">= </span><span class="s1">OutputChecker</span><span class="s3">.</span><span class="s1">check_output</span>
        <span class="s1">parser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_parser</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">optionflags</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">parser</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">super_method</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">optionflags</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">want_doc </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">(</span><span class="s1">want</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">XMLSyntaxError</span><span class="s3">:</span>
            <span class="s2">return False</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">got_doc </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">(</span><span class="s1">got</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">XMLSyntaxError</span><span class="s3">:</span>
            <span class="s2">return False</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">compare_docs</span><span class="s3">(</span><span class="s1">want_doc</span><span class="s3">, </span><span class="s1">got_doc</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_parser</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">optionflags</span><span class="s3">):</span>
        <span class="s1">parser </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">NOPARSE_MARKUP </span><span class="s3">&amp; </span><span class="s1">optionflags</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">if </span><span class="s1">PARSE_HTML </span><span class="s3">&amp; </span><span class="s1">optionflags</span><span class="s3">:</span>
            <span class="s1">parser </span><span class="s3">= </span><span class="s1">html_fromstring</span>
        <span class="s2">elif </span><span class="s1">PARSE_XML </span><span class="s3">&amp; </span><span class="s1">optionflags</span><span class="s3">:</span>
            <span class="s1">parser </span><span class="s3">= </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">XML</span>
        <span class="s2">elif </span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'&lt;html'</span><span class="s3">)</span>
              <span class="s2">and </span><span class="s1">got</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'&lt;html'</span><span class="s3">)):</span>
            <span class="s1">parser </span><span class="s3">= </span><span class="s1">html_fromstring</span>
        <span class="s2">elif </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_looks_like_markup</span><span class="s3">(</span><span class="s1">want</span><span class="s3">)</span>
              <span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_looks_like_markup</span><span class="s3">(</span><span class="s1">got</span><span class="s3">)):</span>
            <span class="s1">parser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_default_parser</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">parser</span>

    <span class="s2">def </span><span class="s1">_looks_like_markup</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">s</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'&lt;'</span><span class="s3">)</span>
                <span class="s2">and not </span><span class="s1">_repr_re</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s1">s</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">compare_docs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tag_compare</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text_compare</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">text</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">text</span><span class="s3">, </span><span class="s2">True</span><span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text_compare</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s2">True</span><span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s2">if </span><span class="s4">'any' </span><span class="s2">not in </span><span class="s1">want</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">:</span>
            <span class="s1">want_keys </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())</span>
            <span class="s1">got_keys </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">got</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())</span>
            <span class="s2">if </span><span class="s1">want_keys </span><span class="s3">!= </span><span class="s1">got_keys</span><span class="s3">:</span>
                <span class="s2">return False</span>
            <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">want_keys</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text_compare</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">[</span><span class="s1">key</span><span class="s3">], </span><span class="s1">got</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">[</span><span class="s1">key</span><span class="s3">], </span><span class="s2">False</span><span class="s3">):</span>
                    <span class="s2">return False</span>
        <span class="s2">if </span><span class="s1">want</span><span class="s3">.</span><span class="s1">text </span><span class="s3">!= </span><span class="s4">'...' </span><span class="s2">or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">want</span><span class="s3">):</span>
            <span class="s1">want_children </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">want</span><span class="s3">)</span>
            <span class="s1">got_children </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">got</span><span class="s3">)</span>
            <span class="s2">while </span><span class="s1">want_children </span><span class="s2">or </span><span class="s1">got_children</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">want_children </span><span class="s2">or not </span><span class="s1">got_children</span><span class="s3">:</span>
                    <span class="s2">return False</span>
                <span class="s1">want_first </span><span class="s3">= </span><span class="s1">want_children</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
                <span class="s1">got_first </span><span class="s3">= </span><span class="s1">got_children</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">compare_docs</span><span class="s3">(</span><span class="s1">want_first</span><span class="s3">, </span><span class="s1">got_first</span><span class="s3">):</span>
                    <span class="s2">return False</span>
                <span class="s2">if not </span><span class="s1">got_children </span><span class="s2">and </span><span class="s1">want_first</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">== </span><span class="s4">'...'</span><span class="s3">:</span>
                    <span class="s2">break</span>
        <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">text_compare</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">strip</span><span class="s3">):</span>
        <span class="s1">want </span><span class="s3">= </span><span class="s1">want </span><span class="s2">or </span><span class="s4">''</span>
        <span class="s1">got </span><span class="s3">= </span><span class="s1">got </span><span class="s2">or </span><span class="s4">''</span>
        <span class="s2">if </span><span class="s1">strip</span><span class="s3">:</span>
            <span class="s1">want </span><span class="s3">= </span><span class="s1">norm_whitespace</span><span class="s3">(</span><span class="s1">want</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
            <span class="s1">got </span><span class="s3">= </span><span class="s1">norm_whitespace</span><span class="s3">(</span><span class="s1">got</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s1">want </span><span class="s3">= </span><span class="s4">'^%s$' </span><span class="s3">% </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s1">want</span><span class="s3">)</span>
        <span class="s1">want </span><span class="s3">= </span><span class="s1">want</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">r'\.\.\.'</span><span class="s3">, </span><span class="s4">'.*'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">re</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">):</span>
            <span class="s2">return True</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return False</span>

    <span class="s2">def </span><span class="s1">tag_compare</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">want </span><span class="s3">== </span><span class="s4">'any'</span><span class="s3">:</span>
            <span class="s2">return True</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s2">not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, (</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">))</span>
                <span class="s2">or not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">got</span><span class="s3">, (</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">))):</span>
            <span class="s2">return </span><span class="s1">want </span><span class="s3">== </span><span class="s1">got</span>
        <span class="s1">want </span><span class="s3">= </span><span class="s1">want </span><span class="s2">or </span><span class="s4">''</span>
        <span class="s1">got </span><span class="s3">= </span><span class="s1">got </span><span class="s2">or </span><span class="s4">''</span>
        <span class="s2">if </span><span class="s1">want</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'{...}'</span><span class="s3">):</span>
            <span class="s5"># Ellipsis on the namespace</span>
            <span class="s2">return </span><span class="s1">want</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'}'</span><span class="s3">)[-</span><span class="s6">1</span><span class="s3">] == </span><span class="s1">got</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'}'</span><span class="s3">)[-</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">want </span><span class="s3">== </span><span class="s1">got</span>

    <span class="s2">def </span><span class="s1">output_difference</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">example</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">optionflags</span><span class="s3">):</span>
        <span class="s1">want </span><span class="s3">= </span><span class="s1">example</span><span class="s3">.</span><span class="s1">want</span>
        <span class="s1">parser </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_parser</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">optionflags</span><span class="s3">)</span>
        <span class="s1">errors </span><span class="s3">= []</span>
        <span class="s2">if </span><span class="s1">parser </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">want_doc </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">(</span><span class="s1">want</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">XMLSyntaxError</span><span class="s3">:</span>
                <span class="s1">e </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">exc_info</span><span class="s3">()[</span><span class="s6">1</span><span class="s3">]</span>
                <span class="s1">errors</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'In example: %s' </span><span class="s3">% </span><span class="s1">e</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">got_doc </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">(</span><span class="s1">got</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">XMLSyntaxError</span><span class="s3">:</span>
                <span class="s1">e </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">exc_info</span><span class="s3">()[</span><span class="s6">1</span><span class="s3">]</span>
                <span class="s1">errors</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'In actual output: %s' </span><span class="s3">% </span><span class="s1">e</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">parser </span><span class="s2">is None or </span><span class="s1">errors</span><span class="s3">:</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">OutputChecker</span><span class="s3">.</span><span class="s1">output_difference</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">, </span><span class="s1">example</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">optionflags</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">errors</span><span class="s3">:</span>
                <span class="s1">errors</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">errors</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">value</span>
        <span class="s1">html </span><span class="s3">= </span><span class="s1">parser </span><span class="s2">is </span><span class="s1">html_fromstring</span>
        <span class="s1">diff_parts </span><span class="s3">= [</span><span class="s4">'Expected:'</span><span class="s3">,</span>
                      <span class="s1">self</span><span class="s3">.</span><span class="s1">format_doc</span><span class="s3">(</span><span class="s1">want_doc</span><span class="s3">, </span><span class="s1">html</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
                      <span class="s4">'Got:'</span><span class="s3">,</span>
                      <span class="s1">self</span><span class="s3">.</span><span class="s1">format_doc</span><span class="s3">(</span><span class="s1">got_doc</span><span class="s3">, </span><span class="s1">html</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
                      <span class="s4">'Diff:'</span><span class="s3">,</span>
                      <span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff</span><span class="s3">(</span><span class="s1">want_doc</span><span class="s3">, </span><span class="s1">got_doc</span><span class="s3">, </span><span class="s1">html</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)]</span>
        <span class="s2">return </span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">diff_parts</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">html_empty_tag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">el</span><span class="s3">, </span><span class="s1">html</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">html</span><span class="s3">:</span>
            <span class="s2">return False</span>
        <span class="s2">if </span><span class="s1">el</span><span class="s3">.</span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">empty_tags</span><span class="s3">:</span>
            <span class="s2">return False</span>
        <span class="s2">if </span><span class="s1">el</span><span class="s3">.</span><span class="s1">text </span><span class="s2">or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">el</span><span class="s3">):</span>
            <span class="s5"># This shouldn't happen (contents in an empty tag)</span>
            <span class="s2">return False</span>
        <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">format_doc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">doc</span><span class="s3">, </span><span class="s1">html</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">, </span><span class="s1">prefix</span><span class="s3">=</span><span class="s4">''</span><span class="s3">):</span>
        <span class="s1">parts </span><span class="s3">= []</span>
        <span class="s2">if not </span><span class="s1">len</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">):</span>
            <span class="s5"># No children...</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">)</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_tag</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">))</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">html_empty_tag</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">, </span><span class="s1">html</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">text</span><span class="s3">):</span>
                    <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">text</span><span class="s3">))</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_end_tag</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">):</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s4">''</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">)</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_tag</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">))</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">html_empty_tag</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">, </span><span class="s1">html</span><span class="s3">):</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">text</span><span class="s3">):</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">text</span><span class="s3">))</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">el </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">:</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_doc</span><span class="s3">(</span><span class="s1">el</span><span class="s3">, </span><span class="s1">html</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">+</span><span class="s6">2</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_end_tag</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">):</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s4">''</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">strip</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">text </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s4">''</span>
        <span class="s2">if </span><span class="s1">strip</span><span class="s3">:</span>
            <span class="s1">text </span><span class="s3">= </span><span class="s1">text</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">html_escape</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">format_tag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">el</span><span class="s3">):</span>
        <span class="s1">attrs </span><span class="s3">= []</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">el</span><span class="s3">, </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">CommentBase</span><span class="s3">):</span>
            <span class="s5"># FIXME: probably PIs should be handled specially too?</span>
            <span class="s2">return </span><span class="s4">'&lt;!--'</span>
        <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">el</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()):</span>
            <span class="s1">attrs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'%s=&quot;%s&quot;' </span><span class="s3">% (</span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)))</span>
        <span class="s2">if not </span><span class="s1">attrs</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s4">'&lt;%s&gt;' </span><span class="s3">% </span><span class="s1">el</span><span class="s3">.</span><span class="s1">tag</span>
        <span class="s2">return </span><span class="s4">'&lt;%s %s&gt;' </span><span class="s3">% (</span><span class="s1">el</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">, </span><span class="s4">' '</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">attrs</span><span class="s3">))</span>
    
    <span class="s2">def </span><span class="s1">format_end_tag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">el</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">el</span><span class="s3">, </span><span class="s1">etree</span><span class="s3">.</span><span class="s1">CommentBase</span><span class="s3">):</span>
            <span class="s5"># FIXME: probably PIs should be handled specially too?</span>
            <span class="s2">return </span><span class="s4">'--&gt;'</span>
        <span class="s2">return </span><span class="s4">'&lt;/%s&gt;' </span><span class="s3">% </span><span class="s1">el</span><span class="s3">.</span><span class="s1">tag</span>

    <span class="s2">def </span><span class="s1">collect_diff</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">html</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">):</span>
        <span class="s1">parts </span><span class="s3">= []</span>
        <span class="s2">if not </span><span class="s1">len</span><span class="s3">(</span><span class="s1">want</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">len</span><span class="s3">(</span><span class="s1">got</span><span class="s3">):</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_tag</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">))</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">html_empty_tag</span><span class="s3">(</span><span class="s1">got</span><span class="s3">, </span><span class="s1">html</span><span class="s3">):</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_text</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">text</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">text</span><span class="s3">))</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_end_tag</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_text</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s4">''</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_tag</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">))</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">text</span><span class="s3">) </span><span class="s2">or </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">got</span><span class="s3">.</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_text</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">text</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">text</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s1">want_children </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">want</span><span class="s3">)</span>
        <span class="s1">got_children </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">got</span><span class="s3">)</span>
        <span class="s2">while </span><span class="s1">want_children </span><span class="s2">or </span><span class="s1">got_children</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">want_children</span><span class="s3">:</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_doc</span><span class="s3">(</span><span class="s1">got_children</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s6">0</span><span class="s3">), </span><span class="s1">html</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">+</span><span class="s6">2</span><span class="s3">, </span><span class="s4">'+'</span><span class="s3">))</span>
                <span class="s2">continue</span>
            <span class="s2">if not </span><span class="s1">got_children</span><span class="s3">:</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_doc</span><span class="s3">(</span><span class="s1">want_children</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s6">0</span><span class="s3">), </span><span class="s1">html</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">+</span><span class="s6">2</span><span class="s3">, </span><span class="s4">'-'</span><span class="s3">))</span>
                <span class="s2">continue</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff</span><span class="s3">(</span>
                <span class="s1">want_children</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s6">0</span><span class="s3">), </span><span class="s1">got_children</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s6">0</span><span class="s3">), </span><span class="s1">html</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">+</span><span class="s6">2</span><span class="s3">))</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_end_tag</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">))</span>
        <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">) </span><span class="s2">or </span><span class="s1">strip</span><span class="s3">(</span><span class="s1">got</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">):</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">*</span><span class="s1">indent</span><span class="s3">)</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_text</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">))</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s4">''</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">collect_diff_tag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tag_compare</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">):</span>
            <span class="s1">tag </span><span class="s3">= </span><span class="s4">'%s (got: %s)' </span><span class="s3">% (</span><span class="s1">want</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tag </span><span class="s3">= </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tag</span>
        <span class="s1">attrs </span><span class="s3">= []</span>
        <span class="s1">any </span><span class="s3">= </span><span class="s1">want</span><span class="s3">.</span><span class="s1">tag </span><span class="s3">== </span><span class="s4">'any' </span><span class="s2">or </span><span class="s4">'any' </span><span class="s2">in </span><span class="s1">want</span><span class="s3">.</span><span class="s1">attrib</span>
        <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">got</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()):</span>
            <span class="s2">if </span><span class="s1">name </span><span class="s2">not in </span><span class="s1">want</span><span class="s3">.</span><span class="s1">attrib </span><span class="s2">and not </span><span class="s1">any</span><span class="s3">:</span>
                <span class="s1">attrs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'+%s=&quot;%s&quot;' </span><span class="s3">% (</span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">want</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">:</span>
                    <span class="s1">text </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">collect_diff_text</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">[</span><span class="s1">name</span><span class="s3">], </span><span class="s1">value</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">text </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
                <span class="s1">attrs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'%s=&quot;%s&quot;' </span><span class="s3">% (</span><span class="s1">name</span><span class="s3">, </span><span class="s1">text</span><span class="s3">))</span>
        <span class="s2">if not </span><span class="s1">any</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">want</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()):</span>
                <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">got</span><span class="s3">.</span><span class="s1">attrib</span><span class="s3">:</span>
                    <span class="s2">continue</span>
                <span class="s1">attrs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'-%s=&quot;%s&quot;' </span><span class="s3">% (</span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)))</span>
        <span class="s2">if </span><span class="s1">attrs</span><span class="s3">:</span>
            <span class="s1">tag </span><span class="s3">= </span><span class="s4">'&lt;%s %s&gt;' </span><span class="s3">% (</span><span class="s1">tag</span><span class="s3">, </span><span class="s4">' '</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">attrs</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tag </span><span class="s3">= </span><span class="s4">'&lt;%s&gt;' </span><span class="s3">% </span><span class="s1">tag</span>
        <span class="s2">return </span><span class="s1">tag</span>

    <span class="s2">def </span><span class="s1">collect_diff_end_tag</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">want</span><span class="s3">.</span><span class="s1">tag </span><span class="s3">!= </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">:</span>
            <span class="s1">tag </span><span class="s3">= </span><span class="s4">'%s (got: %s)' </span><span class="s3">% (</span><span class="s1">want</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">, </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tag </span><span class="s3">= </span><span class="s1">got</span><span class="s3">.</span><span class="s1">tag</span>
        <span class="s2">return </span><span class="s4">'&lt;/%s&gt;' </span><span class="s3">% </span><span class="s1">tag</span>

    <span class="s2">def </span><span class="s1">collect_diff_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">strip</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text_compare</span><span class="s3">(</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">, </span><span class="s1">strip</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">got</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s4">''</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">got</span><span class="s3">, </span><span class="s1">strip</span><span class="s3">)</span>
        <span class="s1">text </span><span class="s3">= </span><span class="s4">'%s (got: %s)' </span><span class="s3">% (</span><span class="s1">want</span><span class="s3">, </span><span class="s1">got</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">format_text</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">strip</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">LHTMLOutputChecker</span><span class="s3">(</span><span class="s1">LXMLOutputChecker</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">get_default_parser</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">html_fromstring</span>
    
<span class="s2">def </span><span class="s1">install</span><span class="s3">(</span><span class="s1">html</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Install doctestcompare for all future doctests. 
 
    If html is true, then by default the HTML parser will be used; 
    otherwise the XML parser is used. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">html</span><span class="s3">:</span>
        <span class="s1">doctest</span><span class="s3">.</span><span class="s1">OutputChecker </span><span class="s3">= </span><span class="s1">LHTMLOutputChecker</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">doctest</span><span class="s3">.</span><span class="s1">OutputChecker </span><span class="s3">= </span><span class="s1">LXMLOutputChecker</span>

<span class="s2">def </span><span class="s1">temp_install</span><span class="s3">(</span><span class="s1">html</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">del_module</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Use this *inside* a doctest to enable this checker for this 
    doctest only. 
 
    If html is true, then by default the HTML parser will be used; 
    otherwise the XML parser is used. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">html</span><span class="s3">:</span>
        <span class="s1">Checker </span><span class="s3">= </span><span class="s1">LHTMLOutputChecker</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">Checker </span><span class="s3">= </span><span class="s1">LXMLOutputChecker</span>
    <span class="s1">frame </span><span class="s3">= </span><span class="s1">_find_doctest_frame</span><span class="s3">()</span>
    <span class="s1">dt_self </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">f_locals</span><span class="s3">[</span><span class="s4">'self'</span><span class="s3">]</span>
    <span class="s1">checker </span><span class="s3">= </span><span class="s1">Checker</span><span class="s3">()</span>
    <span class="s1">old_checker </span><span class="s3">= </span><span class="s1">dt_self</span><span class="s3">.</span><span class="s1">_checker</span>
    <span class="s1">dt_self</span><span class="s3">.</span><span class="s1">_checker </span><span class="s3">= </span><span class="s1">checker</span>
    <span class="s5"># The unfortunate thing is that there is a local variable 'check'</span>
    <span class="s5"># in the function that runs the doctests, that is a bound method</span>
    <span class="s5"># into the output checker.  We have to update that.  We can't</span>
    <span class="s5"># modify the frame, so we have to modify the object in place.  The</span>
    <span class="s5"># only way to do this is to actually change the func_code</span>
    <span class="s5"># attribute of the method.  We change it, and then wait for</span>
    <span class="s5"># __record_outcome to be run, which signals the end of the __run</span>
    <span class="s5"># method, at which point we restore the previous check_output</span>
    <span class="s5"># implementation.</span>
    <span class="s1">check_func </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">f_locals</span><span class="s3">[</span><span class="s4">'check'</span><span class="s3">].</span><span class="s1">__func__</span>
    <span class="s1">checker_check_func </span><span class="s3">= </span><span class="s1">checker</span><span class="s3">.</span><span class="s1">check_output</span><span class="s3">.</span><span class="s1">__func__</span>
    <span class="s5"># Because we can't patch up func_globals, this is the only global</span>
    <span class="s5"># in check_output that we care about:</span>
    <span class="s1">doctest</span><span class="s3">.</span><span class="s1">etree </span><span class="s3">= </span><span class="s1">etree</span>
    <span class="s1">_RestoreChecker</span><span class="s3">(</span><span class="s1">dt_self</span><span class="s3">, </span><span class="s1">old_checker</span><span class="s3">, </span><span class="s1">checker</span><span class="s3">,</span>
                    <span class="s1">check_func</span><span class="s3">, </span><span class="s1">checker_check_func</span><span class="s3">,</span>
                    <span class="s1">del_module</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">_RestoreChecker</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dt_self</span><span class="s3">, </span><span class="s1">old_checker</span><span class="s3">, </span><span class="s1">new_checker</span><span class="s3">, </span><span class="s1">check_func</span><span class="s3">, </span><span class="s1">clone_func</span><span class="s3">,</span>
                 <span class="s1">del_module</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dt_self </span><span class="s3">= </span><span class="s1">dt_self</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">checker </span><span class="s3">= </span><span class="s1">old_checker</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">checker</span><span class="s3">.</span><span class="s1">_temp_call_super_check_output </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">call_super</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">checker</span><span class="s3">.</span><span class="s1">_temp_override_self </span><span class="s3">= </span><span class="s1">new_checker</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_func </span><span class="s3">= </span><span class="s1">check_func</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">clone_func </span><span class="s3">= </span><span class="s1">clone_func</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">del_module </span><span class="s3">= </span><span class="s1">del_module</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">install_clone</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">install_dt_self</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">install_clone</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">func_code </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_func</span><span class="s3">.</span><span class="s1">__code__</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">func_globals </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_func</span><span class="s3">.</span><span class="s1">__globals__</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_func</span><span class="s3">.</span><span class="s1">__code__ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">clone_func</span><span class="s3">.</span><span class="s1">__code__</span>
    <span class="s2">def </span><span class="s1">uninstall_clone</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_func</span><span class="s3">.</span><span class="s1">__code__ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">func_code</span>
    <span class="s2">def </span><span class="s1">install_dt_self</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">prev_func </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dt_self</span><span class="s3">.</span><span class="s1">_DocTestRunner__record_outcome</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dt_self</span><span class="s3">.</span><span class="s1">_DocTestRunner__record_outcome </span><span class="s3">= </span><span class="s1">self</span>
    <span class="s2">def </span><span class="s1">uninstall_dt_self</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dt_self</span><span class="s3">.</span><span class="s1">_DocTestRunner__record_outcome </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">prev_func</span>
    <span class="s2">def </span><span class="s1">uninstall_module</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">del_module</span><span class="s3">:</span>
            <span class="s2">import </span><span class="s1">sys</span>
            <span class="s2">del </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">del_module</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s4">'.' </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">del_module</span><span class="s3">:</span>
                <span class="s1">package</span><span class="s3">, </span><span class="s1">module </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">del_module</span><span class="s3">.</span><span class="s1">rsplit</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
                <span class="s1">package_mod </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">[</span><span class="s1">package</span><span class="s3">]</span>
                <span class="s1">delattr</span><span class="s3">(</span><span class="s1">package_mod</span><span class="s3">, </span><span class="s1">module</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">uninstall_clone</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">uninstall_dt_self</span><span class="s3">()</span>
        <span class="s2">del </span><span class="s1">self</span><span class="s3">.</span><span class="s1">checker</span><span class="s3">.</span><span class="s1">_temp_override_self</span>
        <span class="s2">del </span><span class="s1">self</span><span class="s3">.</span><span class="s1">checker</span><span class="s3">.</span><span class="s1">_temp_call_super_check_output</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">prev_func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">uninstall_module</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">result</span>
    <span class="s2">def </span><span class="s1">call_super</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">uninstall_clone</span><span class="s3">()</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">install_clone</span><span class="s3">()</span>
            
<span class="s2">def </span><span class="s1">_find_doctest_frame</span><span class="s3">():</span>
    <span class="s2">import </span><span class="s1">sys</span>
    <span class="s1">frame </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">_getframe</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s2">while </span><span class="s1">frame</span><span class="s3">:</span>
        <span class="s1">l </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">f_locals</span>
        <span class="s2">if </span><span class="s4">'BOOM' </span><span class="s2">in </span><span class="s1">l</span><span class="s3">:</span>
            <span class="s5"># Sign of doctest</span>
            <span class="s2">return </span><span class="s1">frame</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">f_back</span>
    <span class="s2">raise </span><span class="s1">LookupError</span><span class="s3">(</span>
        <span class="s4">&quot;Could not find doctest (only use this function *inside* a doctest)&quot;</span><span class="s3">)</span>
    
<span class="s1">__test__ </span><span class="s3">= {</span>
    <span class="s4">'basic'</span><span class="s3">: </span><span class="s4">''' 
    &gt;&gt;&gt; temp_install() 
    &gt;&gt;&gt; print &quot;&quot;&quot;&lt;xml a=&quot;1&quot; b=&quot;2&quot;&gt;stuff&lt;/xml&gt;&quot;&quot;&quot; 
    &lt;xml b=&quot;2&quot; a=&quot;1&quot;&gt;...&lt;/xml&gt; 
    &gt;&gt;&gt; print &quot;&quot;&quot;&lt;xml xmlns=&quot;http://example.com&quot;&gt;&lt;tag   attr=&quot;bar&quot;   /&gt;&lt;/xml&gt;&quot;&quot;&quot; 
    &lt;xml xmlns=&quot;...&quot;&gt; 
      &lt;tag attr=&quot;...&quot; /&gt; 
    &lt;/xml&gt; 
    &gt;&gt;&gt; print &quot;&quot;&quot;&lt;xml&gt;blahblahblah&lt;foo /&gt;&lt;/xml&gt;&quot;&quot;&quot; # doctest: +NOPARSE_MARKUP, +ELLIPSIS 
    &lt;xml&gt;...foo /&gt;&lt;/xml&gt; 
    '''</span><span class="s3">}</span>

<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s4">'__main__'</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">doctest</span>
    <span class="s1">doctest</span><span class="s3">.</span><span class="s1">testmod</span><span class="s3">()</span>
    
    
</pre>
</body>
</html>