<html>
<head>
<title>test_testing.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_testing.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">atexit</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">unittest</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">sparse</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">discriminant_analysis </span><span class="s0">import </span><span class="s1">LinearDiscriminantAnalysis</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">tree </span><span class="s0">import </span><span class="s1">DecisionTreeClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">TempMemmap</span><span class="s2">,</span>
    <span class="s1">_convert_container</span><span class="s2">,</span>
    <span class="s1">_delete_folder</span><span class="s2">,</span>
    <span class="s1">_get_warnings_filters_info_list</span><span class="s2">,</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">,</span>
    <span class="s1">assert_no_warnings</span><span class="s2">,</span>
    <span class="s1">assert_raise_message</span><span class="s2">,</span>
    <span class="s1">assert_raises</span><span class="s2">,</span>
    <span class="s1">assert_raises_regex</span><span class="s2">,</span>
    <span class="s1">assert_run_python_script_without_output</span><span class="s2">,</span>
    <span class="s1">check_docstring_parameters</span><span class="s2">,</span>
    <span class="s1">create_memmap_backed_data</span><span class="s2">,</span>
    <span class="s1">ignore_warnings</span><span class="s2">,</span>
    <span class="s1">raises</span><span class="s2">,</span>
    <span class="s1">set_random_state</span><span class="s2">,</span>
    <span class="s1">turn_warnings_into_errors</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">deprecation </span><span class="s0">import </span><span class="s1">deprecated</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_IS_WASM</span><span class="s2">,</span>
    <span class="s1">CSC_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">CSR_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">parse_version</span><span class="s2">,</span>
    <span class="s1">sp_version</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">metaestimators </span><span class="s0">import </span><span class="s1">available_if</span>


<span class="s0">def </span><span class="s1">test_set_random_state</span><span class="s2">():</span>
    <span class="s1">lda </span><span class="s2">= </span><span class="s1">LinearDiscriminantAnalysis</span><span class="s2">()</span>
    <span class="s1">tree </span><span class="s2">= </span><span class="s1">DecisionTreeClassifier</span><span class="s2">()</span>
    <span class="s3"># Linear Discriminant Analysis doesn't have random state: smoke test</span>
    <span class="s1">set_random_state</span><span class="s2">(</span><span class="s1">lda</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">set_random_state</span><span class="s2">(</span><span class="s1">tree</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tree</span><span class="s2">.</span><span class="s1">random_state </span><span class="s2">== </span><span class="s4">3</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Not equal to tolerance &quot;</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">X </span><span class="s0">in </span><span class="s2">[</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]:</span>
        <span class="s3"># basic compare</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X </span><span class="s2">* </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Can only compare two sparse&quot;</span><span class="s2">):</span>
        <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">diags</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s1">offsets</span><span class="s2">=</span><span class="s4">0</span><span class="s2">).</span><span class="s1">tocsr</span><span class="s2">()</span>
    <span class="s1">B </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Arrays are not equal&quot;</span><span class="s2">):</span>
        <span class="s1">assert_allclose_dense_sparse</span><span class="s2">(</span><span class="s1">B</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_assert_raises_msg</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s5">&quot;Hello world&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">=</span><span class="s5">&quot;Hello world&quot;</span><span class="s2">):</span>
            <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_assert_raise_message</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">_raise_ValueError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_no_raise</span><span class="s2">():</span>
        <span class="s0">pass</span>

    <span class="s1">assert_raise_message</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s5">&quot;test&quot;</span><span class="s2">, </span><span class="s1">_raise_ValueError</span><span class="s2">, </span><span class="s5">&quot;test&quot;</span><span class="s2">)</span>

    <span class="s1">assert_raises</span><span class="s2">(</span>
        <span class="s1">AssertionError</span><span class="s2">,</span>
        <span class="s1">assert_raise_message</span><span class="s2">,</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s5">&quot;something else&quot;</span><span class="s2">,</span>
        <span class="s1">_raise_ValueError</span><span class="s2">,</span>
        <span class="s5">&quot;test&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">assert_raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">assert_raise_message</span><span class="s2">,</span>
        <span class="s1">TypeError</span><span class="s2">,</span>
        <span class="s5">&quot;something else&quot;</span><span class="s2">,</span>
        <span class="s1">_raise_ValueError</span><span class="s2">,</span>
        <span class="s5">&quot;test&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">assert_raise_message</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s5">&quot;test&quot;</span><span class="s2">, </span><span class="s1">_no_raise</span><span class="s2">)</span>

    <span class="s3"># multiple exceptions in a tuple</span>
    <span class="s1">assert_raises</span><span class="s2">(</span>
        <span class="s1">AssertionError</span><span class="s2">,</span>
        <span class="s1">assert_raise_message</span><span class="s2">,</span>
        <span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">AttributeError</span><span class="s2">),</span>
        <span class="s5">&quot;test&quot;</span><span class="s2">,</span>
        <span class="s1">_no_raise</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ignore_warning</span><span class="s2">():</span>
    <span class="s3"># This check that ignore_warning decorator and context manager are working</span>
    <span class="s3"># as expected</span>
    <span class="s0">def </span><span class="s1">_warning_function</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s5">&quot;deprecation warning&quot;</span><span class="s2">, </span><span class="s1">DeprecationWarning</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_multiple_warning_function</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s5">&quot;deprecation warning&quot;</span><span class="s2">, </span><span class="s1">DeprecationWarning</span><span class="s2">)</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s5">&quot;deprecation warning&quot;</span><span class="s2">)</span>

    <span class="s3"># Check the function directly</span>
    <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">_warning_function</span><span class="s2">))</span>
    <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">_warning_function</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">DeprecationWarning</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
        <span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">_warning_function</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">() </span><span class="s0">as </span><span class="s1">record</span><span class="s2">:</span>
        <span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">_multiple_warning_function</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">FutureWarning</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">record</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">record</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">, </span><span class="s1">DeprecationWarning</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">record</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">message</span><span class="s2">, </span><span class="s1">UserWarning</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">() </span><span class="s0">as </span><span class="s1">record</span><span class="s2">:</span>
        <span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">_multiple_warning_function</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">record</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">record</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">, </span><span class="s1">DeprecationWarning</span><span class="s2">)</span>

    <span class="s1">assert_no_warnings</span><span class="s2">(</span>
        <span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">_warning_function</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">UserWarning</span><span class="s2">))</span>
    <span class="s2">)</span>

    <span class="s3"># Check the decorator</span>
    <span class="s2">@</span><span class="s1">ignore_warnings</span>
    <span class="s0">def </span><span class="s1">decorator_no_warning</span><span class="s2">():</span>
        <span class="s1">_warning_function</span><span class="s2">()</span>
        <span class="s1">_multiple_warning_function</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">UserWarning</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">decorator_no_warning_multiple</span><span class="s2">():</span>
        <span class="s1">_multiple_warning_function</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">DeprecationWarning</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">decorator_no_deprecation_warning</span><span class="s2">():</span>
        <span class="s1">_warning_function</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">decorator_no_user_warning</span><span class="s2">():</span>
        <span class="s1">_warning_function</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">DeprecationWarning</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">decorator_no_deprecation_multiple_warning</span><span class="s2">():</span>
        <span class="s1">_multiple_warning_function</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">decorator_no_user_multiple_warning</span><span class="s2">():</span>
        <span class="s1">_multiple_warning_function</span><span class="s2">()</span>

    <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">decorator_no_warning</span><span class="s2">)</span>
    <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">decorator_no_warning_multiple</span><span class="s2">)</span>
    <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">decorator_no_deprecation_warning</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
        <span class="s1">decorator_no_user_warning</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
        <span class="s1">decorator_no_deprecation_multiple_warning</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
        <span class="s1">decorator_no_user_multiple_warning</span><span class="s2">()</span>

    <span class="s3"># Check the context manager</span>
    <span class="s0">def </span><span class="s1">context_manager_no_warning</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">ignore_warnings</span><span class="s2">():</span>
            <span class="s1">_warning_function</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">context_manager_no_warning_multiple</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=(</span><span class="s1">DeprecationWarning</span><span class="s2">, </span><span class="s1">UserWarning</span><span class="s2">)):</span>
            <span class="s1">_multiple_warning_function</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">context_manager_no_deprecation_warning</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
            <span class="s1">_warning_function</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">context_manager_no_user_warning</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">):</span>
            <span class="s1">_warning_function</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">context_manager_no_deprecation_multiple_warning</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
            <span class="s1">_multiple_warning_function</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">context_manager_no_user_multiple_warning</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">):</span>
            <span class="s1">_multiple_warning_function</span><span class="s2">()</span>

    <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">context_manager_no_warning</span><span class="s2">)</span>
    <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">context_manager_no_warning_multiple</span><span class="s2">)</span>
    <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">context_manager_no_deprecation_warning</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
        <span class="s1">context_manager_no_user_warning</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
        <span class="s1">context_manager_no_deprecation_multiple_warning</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
        <span class="s1">context_manager_no_user_multiple_warning</span><span class="s2">()</span>

    <span class="s3"># Check that passing warning class as first positional argument</span>
    <span class="s1">warning_class </span><span class="s2">= </span><span class="s1">UserWarning</span>
    <span class="s1">match </span><span class="s2">= </span><span class="s5">&quot;'obj' should be a callable.+you should use 'category=UserWarning'&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
        <span class="s1">silence_warnings_func </span><span class="s2">= </span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">warning_class</span><span class="s2">)(</span><span class="s1">_warning_function</span><span class="s2">)</span>
        <span class="s1">silence_warnings_func</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>

        <span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">warning_class</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">test</span><span class="s2">():</span>
            <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">TestWarns</span><span class="s2">(</span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">TestCase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_warn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">():</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s5">&quot;yo&quot;</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s4">3</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
            <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s4">1</span><span class="s2">) == </span><span class="s4">1</span>


<span class="s3"># Tests for docstrings:</span>


<span class="s0">def </span><span class="s1">f_ok</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Function f 
 
    Parameters 
    ---------- 
    a : int 
        Parameter a 
    b : float 
        Parameter b 
 
    Returns 
    ------- 
    c : list 
        Parameter c 
    &quot;&quot;&quot;</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>
    <span class="s0">return </span><span class="s1">c</span>


<span class="s0">def </span><span class="s1">f_bad_sections</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Function f 
 
    Parameters 
    ---------- 
    a : int 
        Parameter a 
    b : float 
        Parameter b 
 
    Results 
    ------- 
    c : list 
        Parameter c 
    &quot;&quot;&quot;</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>
    <span class="s0">return </span><span class="s1">c</span>


<span class="s0">def </span><span class="s1">f_bad_order</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Function f 
 
    Parameters 
    ---------- 
    a : int 
        Parameter a 
    b : float 
        Parameter b 
 
    Returns 
    ------- 
    c : list 
        Parameter c 
    &quot;&quot;&quot;</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>
    <span class="s0">return </span><span class="s1">c</span>


<span class="s0">def </span><span class="s1">f_too_many_param_docstring</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Function f 
 
    Parameters 
    ---------- 
    a : int 
        Parameter a 
    b : int 
        Parameter b 
    c : int 
        Parameter c 
 
    Returns 
    ------- 
    d : list 
        Parameter c 
    &quot;&quot;&quot;</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>
    <span class="s0">return </span><span class="s1">d</span>


<span class="s0">def </span><span class="s1">f_missing</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Function f 
 
    Parameters 
    ---------- 
    a : int 
        Parameter a 
 
    Returns 
    ------- 
    c : list 
        Parameter c 
    &quot;&quot;&quot;</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>
    <span class="s0">return </span><span class="s1">c</span>


<span class="s0">def </span><span class="s1">f_check_param_definition</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">e</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Function f 
 
    Parameters 
    ---------- 
    a: int 
        Parameter a 
    b: 
        Parameter b 
    c : 
        This is parsed correctly in numpydoc 1.2 
    d:int 
        Parameter d 
    e 
        No typespec is allowed without colon 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b </span><span class="s2">+ </span><span class="s1">c </span><span class="s2">+ </span><span class="s1">d</span>


<span class="s0">class </span><span class="s1">Klass</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">f_missing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">f_bad_sections</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Function f 
 
        Parameter 
        --------- 
        a : int 
            Parameter a 
        b : float 
            Parameter b 
 
        Results 
        ------- 
        c : list 
            Parameter c 
        &quot;&quot;&quot;</span>
        <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">MockEst</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;MockEstimator&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">X</span>

    <span class="s0">def </span><span class="s1">predict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">X</span>

    <span class="s0">def </span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">X</span>

    <span class="s0">def </span><span class="s1">score</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s4">1.0</span>


<span class="s0">class </span><span class="s1">MockMetaEstimator</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">delegate</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;MetaEstimator to check if doctest on delegated methods work. 
 
        Parameters 
        --------- 
        delegate : estimator 
            Delegated estimator. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">delegate </span><span class="s2">= </span><span class="s1">delegate</span>

    <span class="s2">@</span><span class="s1">available_if</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">delegate</span><span class="s2">, </span><span class="s5">&quot;predict&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">predict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;This is available only if delegate has predict. 
 
        Parameters 
        ---------- 
        y : ndarray 
            Parameter y 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">delegate</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">available_if</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">delegate</span><span class="s2">, </span><span class="s5">&quot;score&quot;</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">deprecated</span><span class="s2">(</span><span class="s5">&quot;Testing a deprecated delegated method&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">score</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;This is available only if delegate has score. 
 
        Parameters 
        --------- 
        y : ndarray 
            Parameter y 
        &quot;&quot;&quot;</span>

    <span class="s2">@</span><span class="s1">available_if</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">self</span><span class="s2">: </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">delegate</span><span class="s2">, </span><span class="s5">&quot;predict_proba&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;This is available only if delegate has predict_proba. 
 
        Parameters 
        --------- 
        X : ndarray 
            Parameter X 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">X</span>

    <span class="s2">@</span><span class="s1">deprecated</span><span class="s2">(</span><span class="s5">&quot;Testing deprecated function with wrong params&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Incorrect docstring but should not be tested&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_check_docstring_parameters</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span>
        <span class="s5">&quot;numpydoc&quot;</span><span class="s2">,</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numpydoc is required to test the docstrings&quot;</span><span class="s2">,</span>
        <span class="s1">minversion</span><span class="s2">=</span><span class="s5">&quot;1.2.0&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">incorrect </span><span class="s2">= </span><span class="s1">check_docstring_parameters</span><span class="s2">(</span><span class="s1">f_ok</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">incorrect </span><span class="s2">== []</span>
    <span class="s1">incorrect </span><span class="s2">= </span><span class="s1">check_docstring_parameters</span><span class="s2">(</span><span class="s1">f_ok</span><span class="s2">, </span><span class="s1">ignore</span><span class="s2">=[</span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">incorrect </span><span class="s2">== []</span>
    <span class="s1">incorrect </span><span class="s2">= </span><span class="s1">check_docstring_parameters</span><span class="s2">(</span><span class="s1">f_missing</span><span class="s2">, </span><span class="s1">ignore</span><span class="s2">=[</span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">incorrect </span><span class="s2">== []</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Unknown section Results&quot;</span><span class="s2">):</span>
        <span class="s1">check_docstring_parameters</span><span class="s2">(</span><span class="s1">f_bad_sections</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Unknown section Parameter&quot;</span><span class="s2">):</span>
        <span class="s1">check_docstring_parameters</span><span class="s2">(</span><span class="s1">Klass</span><span class="s2">.</span><span class="s1">f_bad_sections</span><span class="s2">)</span>

    <span class="s1">incorrect </span><span class="s2">= </span><span class="s1">check_docstring_parameters</span><span class="s2">(</span><span class="s1">f_check_param_definition</span><span class="s2">)</span>
    <span class="s1">mock_meta </span><span class="s2">= </span><span class="s1">MockMetaEstimator</span><span class="s2">(</span><span class="s1">delegate</span><span class="s2">=</span><span class="s1">MockEst</span><span class="s2">())</span>
    <span class="s1">mock_meta_name </span><span class="s2">= </span><span class="s1">mock_meta</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
    <span class="s0">assert </span><span class="s1">incorrect </span><span class="s2">== [</span>
        <span class="s2">(</span>
            <span class="s5">&quot;sklearn.utils.tests.test_testing.f_check_param_definition There &quot;</span>
            <span class="s5">&quot;was no space between the param name and colon ('a: int')&quot;</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s5">&quot;sklearn.utils.tests.test_testing.f_check_param_definition There &quot;</span>
            <span class="s5">&quot;was no space between the param name and colon ('b:')&quot;</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s5">&quot;sklearn.utils.tests.test_testing.f_check_param_definition There &quot;</span>
            <span class="s5">&quot;was no space between the param name and colon ('d:int')&quot;</span>
        <span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s1">messages </span><span class="s2">= [</span>
        <span class="s2">[</span>
            <span class="s5">&quot;In function: sklearn.utils.tests.test_testing.f_bad_order&quot;</span><span class="s2">,</span>
            <span class="s2">(</span>
                <span class="s5">&quot;There's a parameter name mismatch in function docstring w.r.t.&quot;</span>
                <span class="s5">&quot; function signature, at index 0 diff: 'b' != 'a'&quot;</span>
            <span class="s2">),</span>
            <span class="s5">&quot;Full diff:&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;- ['b', 'a']&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;+ ['a', 'b']&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s2">[</span>
            <span class="s5">&quot;In function: &quot;</span>
            <span class="s2">+ </span><span class="s5">&quot;sklearn.utils.tests.test_testing.f_too_many_param_docstring&quot;</span><span class="s2">,</span>
            <span class="s2">(</span>
                <span class="s5">&quot;Parameters in function docstring have more items w.r.t. function&quot;</span>
                <span class="s5">&quot; signature, first extra item: c&quot;</span>
            <span class="s2">),</span>
            <span class="s5">&quot;Full diff:&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;- ['a', 'b']&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;+ ['a', 'b', 'c']&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;?          +++++&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s2">[</span>
            <span class="s5">&quot;In function: sklearn.utils.tests.test_testing.f_missing&quot;</span><span class="s2">,</span>
            <span class="s2">(</span>
                <span class="s5">&quot;Parameters in function docstring have less items w.r.t. function&quot;</span>
                <span class="s5">&quot; signature, first missing item: b&quot;</span>
            <span class="s2">),</span>
            <span class="s5">&quot;Full diff:&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;- ['a', 'b']&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;+ ['a']&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s2">[</span>
            <span class="s5">&quot;In function: sklearn.utils.tests.test_testing.Klass.f_missing&quot;</span><span class="s2">,</span>
            <span class="s2">(</span>
                <span class="s5">&quot;Parameters in function docstring have less items w.r.t. function&quot;</span>
                <span class="s5">&quot; signature, first missing item: X&quot;</span>
            <span class="s2">),</span>
            <span class="s5">&quot;Full diff:&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;- ['X', 'y']&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;+ []&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s2">[</span>
            <span class="s5">&quot;In function: &quot;</span>
            <span class="s2">+ </span><span class="s5">f&quot;sklearn.utils.tests.test_testing.</span><span class="s0">{</span><span class="s1">mock_meta_name</span><span class="s0">}</span><span class="s5">.predict&quot;</span><span class="s2">,</span>
            <span class="s2">(</span>
                <span class="s5">&quot;There's a parameter name mismatch in function docstring w.r.t.&quot;</span>
                <span class="s5">&quot; function signature, at index 0 diff: 'X' != 'y'&quot;</span>
            <span class="s2">),</span>
            <span class="s5">&quot;Full diff:&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;- ['X']&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;?   ^&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;+ ['y']&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;?   ^&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s2">[</span>
            <span class="s5">&quot;In function: &quot;</span>
            <span class="s2">+ </span><span class="s5">f&quot;sklearn.utils.tests.test_testing.</span><span class="s0">{</span><span class="s1">mock_meta_name</span><span class="s0">}</span><span class="s5">.&quot;</span>
            <span class="s2">+ </span><span class="s5">&quot;predict_proba&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;potentially wrong underline length... &quot;</span><span class="s2">,</span>
            <span class="s5">&quot;Parameters &quot;</span><span class="s2">,</span>
            <span class="s5">&quot;--------- in &quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s2">[</span>
            <span class="s5">&quot;In function: &quot;</span>
            <span class="s2">+ </span><span class="s5">f&quot;sklearn.utils.tests.test_testing.</span><span class="s0">{</span><span class="s1">mock_meta_name</span><span class="s0">}</span><span class="s5">.score&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;potentially wrong underline length... &quot;</span><span class="s2">,</span>
            <span class="s5">&quot;Parameters &quot;</span><span class="s2">,</span>
            <span class="s5">&quot;--------- in &quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s2">[</span>
            <span class="s5">&quot;In function: &quot; </span><span class="s2">+ </span><span class="s5">f&quot;sklearn.utils.tests.test_testing.</span><span class="s0">{</span><span class="s1">mock_meta_name</span><span class="s0">}</span><span class="s5">.fit&quot;</span><span class="s2">,</span>
            <span class="s2">(</span>
                <span class="s5">&quot;Parameters in function docstring have less items w.r.t. function&quot;</span>
                <span class="s5">&quot; signature, first missing item: X&quot;</span>
            <span class="s2">),</span>
            <span class="s5">&quot;Full diff:&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;- ['X', 'y']&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;+ []&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">]</span>

    <span class="s0">for </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">f </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span>
        <span class="s1">messages</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s1">f_bad_order</span><span class="s2">,</span>
            <span class="s1">f_too_many_param_docstring</span><span class="s2">,</span>
            <span class="s1">f_missing</span><span class="s2">,</span>
            <span class="s1">Klass</span><span class="s2">.</span><span class="s1">f_missing</span><span class="s2">,</span>
            <span class="s1">mock_meta</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">,</span>
            <span class="s1">mock_meta</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">,</span>
            <span class="s1">mock_meta</span><span class="s2">.</span><span class="s1">score</span><span class="s2">,</span>
            <span class="s1">mock_meta</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">):</span>
        <span class="s1">incorrect </span><span class="s2">= </span><span class="s1">check_docstring_parameters</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">msg </span><span class="s2">== </span><span class="s1">incorrect</span><span class="s2">, </span><span class="s5">'</span><span class="s0">\n</span><span class="s5">&quot;%s&quot;</span><span class="s0">\n </span><span class="s5">not in </span><span class="s0">\n</span><span class="s5">&quot;%s&quot;' </span><span class="s2">% (</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">incorrect</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">RegistrationCounter</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nb_calls </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">to_register_func</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nb_calls </span><span class="s2">+= </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">to_register_func</span><span class="s2">.</span><span class="s1">func </span><span class="s0">is </span><span class="s1">_delete_folder</span>


<span class="s0">def </span><span class="s1">check_memmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">mmap_data</span><span class="s2">, </span><span class="s1">mmap_mode</span><span class="s2">=</span><span class="s5">&quot;r&quot;</span><span class="s2">):</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">mmap_data</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">memmap</span><span class="s2">)</span>
    <span class="s1">writeable </span><span class="s2">= </span><span class="s1">mmap_mode </span><span class="s2">!= </span><span class="s5">&quot;r&quot;</span>
    <span class="s0">assert </span><span class="s1">mmap_data</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s0">is </span><span class="s1">writeable</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">mmap_data</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_tempmemmap</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">registration_counter </span><span class="s2">= </span><span class="s1">RegistrationCounter</span><span class="s2">()</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">atexit</span><span class="s2">, </span><span class="s5">&quot;register&quot;</span><span class="s2">, </span><span class="s1">registration_counter</span><span class="s2">)</span>

    <span class="s1">input_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">TempMemmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">) </span><span class="s0">as </span><span class="s1">data</span><span class="s2">:</span>
        <span class="s1">check_memmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">temp_folder </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">!= </span><span class="s5">&quot;nt&quot;</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">temp_folder</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">registration_counter</span><span class="s2">.</span><span class="s1">nb_calls </span><span class="s2">== </span><span class="s4">1</span>

    <span class="s1">mmap_mode </span><span class="s2">= </span><span class="s5">&quot;r+&quot;</span>
    <span class="s0">with </span><span class="s1">TempMemmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">mmap_mode</span><span class="s2">=</span><span class="s1">mmap_mode</span><span class="s2">) </span><span class="s0">as </span><span class="s1">data</span><span class="s2">:</span>
        <span class="s1">check_memmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">mmap_mode</span><span class="s2">=</span><span class="s1">mmap_mode</span><span class="s2">)</span>
        <span class="s1">temp_folder </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">!= </span><span class="s5">&quot;nt&quot;</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">temp_folder</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">registration_counter</span><span class="s2">.</span><span class="s1">nb_calls </span><span class="s2">== </span><span class="s4">2</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">_IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;memmap not fully supported&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_create_memmap_backed_data</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">registration_counter </span><span class="s2">= </span><span class="s1">RegistrationCounter</span><span class="s2">()</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">atexit</span><span class="s2">, </span><span class="s5">&quot;register&quot;</span><span class="s2">, </span><span class="s1">registration_counter</span><span class="s2">)</span>

    <span class="s1">input_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">create_memmap_backed_data</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">)</span>
    <span class="s1">check_memmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">registration_counter</span><span class="s2">.</span><span class="s1">nb_calls </span><span class="s2">== </span><span class="s4">1</span>

    <span class="s1">data</span><span class="s2">, </span><span class="s1">folder </span><span class="s2">= </span><span class="s1">create_memmap_backed_data</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">return_folder</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">check_memmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">folder </span><span class="s2">== </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">registration_counter</span><span class="s2">.</span><span class="s1">nb_calls </span><span class="s2">== </span><span class="s4">2</span>

    <span class="s1">mmap_mode </span><span class="s2">= </span><span class="s5">&quot;r+&quot;</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">create_memmap_backed_data</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">mmap_mode</span><span class="s2">=</span><span class="s1">mmap_mode</span><span class="s2">)</span>
    <span class="s1">check_memmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">mmap_mode</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">registration_counter</span><span class="s2">.</span><span class="s1">nb_calls </span><span class="s2">== </span><span class="s4">3</span>

    <span class="s1">input_list </span><span class="s2">= [</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">input_array </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">, </span><span class="s1">input_array </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s1">mmap_data_list </span><span class="s2">= </span><span class="s1">create_memmap_backed_data</span><span class="s2">(</span><span class="s1">input_list</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">data </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">input_list</span><span class="s2">, </span><span class="s1">mmap_data_list</span><span class="s2">):</span>
        <span class="s1">check_memmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">registration_counter</span><span class="s2">.</span><span class="s1">nb_calls </span><span class="s2">== </span><span class="s4">4</span>

    <span class="s1">output_data</span><span class="s2">, </span><span class="s1">other </span><span class="s2">= </span><span class="s1">create_memmap_backed_data</span><span class="s2">([</span><span class="s1">input_array</span><span class="s2">, </span><span class="s5">&quot;not-an-array&quot;</span><span class="s2">])</span>
    <span class="s1">check_memmap</span><span class="s2">(</span><span class="s1">input_array</span><span class="s2">, </span><span class="s1">output_data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">other </span><span class="s2">== </span><span class="s5">&quot;not-an-array&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;constructor_name, container_type&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">&quot;list&quot;</span><span class="s2">, </span><span class="s1">list</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;tuple&quot;</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;array&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;sparse&quot;</span><span class="s2">, </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">csr_matrix</span><span class="s2">),</span>
        <span class="s3"># using `zip` will only keep the available sparse containers</span>
        <span class="s3"># depending of the installed SciPy version</span>
        <span class="s2">*</span><span class="s1">zip</span><span class="s2">([</span><span class="s5">&quot;sparse_csr&quot;</span><span class="s2">, </span><span class="s5">&quot;sparse_csr_array&quot;</span><span class="s2">], </span><span class="s1">CSR_CONTAINERS</span><span class="s2">),</span>
        <span class="s2">*</span><span class="s1">zip</span><span class="s2">([</span><span class="s5">&quot;sparse_csc&quot;</span><span class="s2">, </span><span class="s5">&quot;sparse_csc_array&quot;</span><span class="s2">], </span><span class="s1">CSC_CONTAINERS</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">).</span><span class="s1">DataFrame</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;series&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">).</span><span class="s1">Series</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;index&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">).</span><span class="s1">Index</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;slice&quot;</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;dtype, superdtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_convert_container</span><span class="s2">(</span>
    <span class="s1">constructor_name</span><span class="s2">,</span>
    <span class="s1">container_type</span><span class="s2">,</span>
    <span class="s1">dtype</span><span class="s2">,</span>
    <span class="s1">superdtype</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we convert the container to the right type of array with the 
    right data type.&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">constructor_name </span><span class="s0">in </span><span class="s2">(</span><span class="s5">&quot;dataframe&quot;</span><span class="s2">, </span><span class="s5">&quot;polars&quot;</span><span class="s2">, </span><span class="s5">&quot;series&quot;</span><span class="s2">, </span><span class="s5">&quot;polars_series&quot;</span><span class="s2">, </span><span class="s5">&quot;index&quot;</span><span class="s2">):</span>
        <span class="s3"># delay the import of pandas/polars within the function to only skip this test</span>
        <span class="s3"># instead of the whole file</span>
        <span class="s1">container_type </span><span class="s2">= </span><span class="s1">container_type</span><span class="s2">()</span>
    <span class="s1">container </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>

    <span class="s1">container_converted </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span>
        <span class="s1">container</span><span class="s2">,</span>
        <span class="s1">constructor_name</span><span class="s2">,</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">container_converted</span><span class="s2">, </span><span class="s1">container_type</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">constructor_name </span><span class="s0">in </span><span class="s2">(</span><span class="s5">&quot;list&quot;</span><span class="s2">, </span><span class="s5">&quot;tuple&quot;</span><span class="s2">, </span><span class="s5">&quot;index&quot;</span><span class="s2">):</span>
        <span class="s3"># list and tuple will use Python class dtype: int, float</span>
        <span class="s3"># pandas index will always use high precision: np.int64 and np.float64</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">container_converted</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">superdtype</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">container_converted</span><span class="s2">, </span><span class="s5">&quot;dtype&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">container_converted</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>
    <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">container_converted</span><span class="s2">, </span><span class="s5">&quot;dtypes&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">container_converted</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">dtype</span>


<span class="s0">def </span><span class="s1">test_convert_container_categories_pandas</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;x&quot;</span><span class="s2">]], </span><span class="s5">&quot;dataframe&quot;</span><span class="s2">, [</span><span class="s5">&quot;A&quot;</span><span class="s2">], </span><span class="s1">categorical_feature_names</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s5">&quot;category&quot;</span>


<span class="s0">def </span><span class="s1">test_convert_container_categories_polars</span><span class="s2">():</span>
    <span class="s1">pl </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;polars&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([[</span><span class="s5">&quot;x&quot;</span><span class="s2">]], </span><span class="s5">&quot;polars&quot;</span><span class="s2">, [</span><span class="s5">&quot;A&quot;</span><span class="s2">], </span><span class="s1">categorical_feature_names</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">[</span><span class="s5">&quot;A&quot;</span><span class="s2">] == </span><span class="s1">pl</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_convert_container_categories_pyarrow</span><span class="s2">():</span>
    <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([[</span><span class="s5">&quot;x&quot;</span><span class="s2">]], </span><span class="s5">&quot;pyarrow&quot;</span><span class="s2">, [</span><span class="s5">&quot;A&quot;</span><span class="s2">], </span><span class="s1">categorical_feature_names</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">type</span><span class="s2">) </span><span class="s0">is </span><span class="s1">pa</span><span class="s2">.</span><span class="s1">DictionaryType</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sp_version </span><span class="s2">&gt;= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">&quot;1.8&quot;</span><span class="s2">),</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;sparse arrays are available as of scipy 1.8.0&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;constructor_name&quot;</span><span class="s2">, [</span><span class="s5">&quot;sparse_csr_array&quot;</span><span class="s2">, </span><span class="s5">&quot;sparse_csc_array&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_convert_container_raise_when_sparray_not_available</span><span class="s2">(</span><span class="s1">constructor_name</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that if we convert to sparse array but sparse array are not supported 
    (scipy&lt;1.8.0), we should raise an explicit error.&quot;&quot;&quot;</span>
    <span class="s1">container </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s5">f&quot;only available with scipy&gt;=1.8.0, got </span><span class="s0">{</span><span class="s1">sp_version</span><span class="s0">}</span><span class="s5">&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">container</span><span class="s2">, </span><span class="s1">constructor_name</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_raises</span><span class="s2">():</span>
    <span class="s3"># Tests for the raises context manager</span>

    <span class="s3"># Proper type, no match</span>
    <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">()</span>

    <span class="s3"># Proper type, proper match</span>
    <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;how are you&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s5">&quot;hello how are you&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># Proper type, proper match with multiple patterns</span>
    <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=[</span><span class="s5">&quot;not this one&quot;</span><span class="s2">, </span><span class="s5">&quot;how are you&quot;</span><span class="s2">]) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s5">&quot;hello how are you&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># bad type, no match</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;this will be raised&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s5">&quot;this will be raised&quot;</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># Bad type, no match, with a err_msg</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;the failure message&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s5">&quot;the failure message&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># bad type, with match (is ignored anyway)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;this will be raised&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;this is ignored&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s5">&quot;this will be raised&quot;</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># proper type but bad match</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;should contain one of the following patterns&quot;</span>
    <span class="s2">):</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;hello&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s5">&quot;Bad message&quot;</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># proper type but bad match, with err_msg</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;the failure message&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;hello&quot;</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s5">&quot;the failure message&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s5">&quot;Bad message&quot;</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># no raise with default may_pass=False</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Did not raise&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
            <span class="s0">pass</span>
    <span class="s0">assert not </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># no raise with may_pass=True</span>
    <span class="s0">with </span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;hello&quot;</span><span class="s2">, </span><span class="s1">may_pass</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">cm</span><span class="s2">:</span>
        <span class="s0">pass  </span><span class="s3"># still OK</span>
    <span class="s0">assert not </span><span class="s1">cm</span><span class="s2">.</span><span class="s1">raised_and_matched</span>

    <span class="s3"># Multiple exception types:</span>
    <span class="s0">with </span><span class="s1">raises</span><span class="s2">((</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">)):</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">raises</span><span class="s2">((</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">)):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">raises</span><span class="s2">((</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">)):</span>
            <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_float32_aware_assert_allclose</span><span class="s2">():</span>
    <span class="s3"># The relative tolerance for float32 inputs is 1e-4</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.0 </span><span class="s2">+ </span><span class="s4">2e-5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s4">1.0</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.0 </span><span class="s2">+ </span><span class="s4">2e-4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s4">1.0</span><span class="s2">)</span>

    <span class="s3"># The relative tolerance for other inputs is left to 1e-7 as in</span>
    <span class="s3"># the original numpy version.</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.0 </span><span class="s2">+ </span><span class="s4">2e-8</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">), </span><span class="s4">1.0</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.0 </span><span class="s2">+ </span><span class="s4">2e-7</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">), </span><span class="s4">1.0</span><span class="s2">)</span>

    <span class="s3"># atol is left to 0.0 by default, even for float32</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1e-5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s4">0.0</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1e-5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">2e-5</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">_IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;cannot start subprocess&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_assert_run_python_script_without_output</span><span class="s2">():</span>
    <span class="s1">code </span><span class="s2">= </span><span class="s5">&quot;x = 1&quot;</span>
    <span class="s1">assert_run_python_script_without_output</span><span class="s2">(</span><span class="s1">code</span><span class="s2">)</span>

    <span class="s1">code </span><span class="s2">= </span><span class="s5">&quot;print('something to stdout')&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Expected no output&quot;</span><span class="s2">):</span>
        <span class="s1">assert_run_python_script_without_output</span><span class="s2">(</span><span class="s1">code</span><span class="s2">)</span>

    <span class="s1">code </span><span class="s2">= </span><span class="s5">&quot;print('something to stdout')&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">AssertionError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;output was not supposed to match.+got.+something to stdout&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">assert_run_python_script_without_output</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">=</span><span class="s5">&quot;to.+stdout&quot;</span><span class="s2">)</span>

    <span class="s1">code </span><span class="s2">= </span><span class="s5">&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s5">&quot;import sys&quot;</span><span class="s2">, </span><span class="s5">&quot;print('something to stderr', file=sys.stderr)&quot;</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">AssertionError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;output was not supposed to match.+got.+something to stderr&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">assert_run_python_script_without_output</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">=</span><span class="s5">&quot;to.+stderr&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;constructor_name&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s5">&quot;sparse_csr&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;sparse_csc&quot;</span><span class="s2">,</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span>
            <span class="s5">&quot;sparse_csr_array&quot;</span><span class="s2">,</span>
            <span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
                <span class="s1">sp_version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">&quot;1.8&quot;</span><span class="s2">),</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;sparse arrays are available as of scipy 1.8.0&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span>
            <span class="s5">&quot;sparse_csc_array&quot;</span><span class="s2">,</span>
            <span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
                <span class="s1">sp_version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">&quot;1.8&quot;</span><span class="s2">),</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;sparse arrays are available as of scipy 1.8.0&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_convert_container_sparse_to_sparse</span><span class="s2">(</span><span class="s1">constructor_name</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Non-regression test to check that we can still convert a sparse container 
    from a given format to another format. 
    &quot;&quot;&quot;</span>
    <span class="s1">X_sparse </span><span class="s2">= </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s1">density</span><span class="s2">=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s5">&quot;csr&quot;</span><span class="s2">)</span>
    <span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">X_sparse</span><span class="s2">, </span><span class="s1">constructor_name</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_warnings_as_errors</span><span class="s2">(</span><span class="s1">warning_info</span><span class="s2">, </span><span class="s1">warnings_as_errors</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">action </span><span class="s2">== </span><span class="s5">&quot;error&quot; </span><span class="s0">and </span><span class="s1">warnings_as_errors</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">category</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
                <span class="s1">message</span><span class="s2">=</span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">message</span><span class="s2">,</span>
                <span class="s1">category</span><span class="s2">=</span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">category</span><span class="s2">,</span>
            <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">action </span><span class="s2">== </span><span class="s5">&quot;ignore&quot;</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">(</span><span class="s1">record</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">record</span><span class="s2">:</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">message</span>
            <span class="s3"># Special treatment when regex is used</span>
            <span class="s0">if </span><span class="s5">&quot;Pyarrow&quot; </span><span class="s0">in </span><span class="s1">message</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s5">&quot;</span><span class="s0">\n</span><span class="s5">Pyarrow will become a required dependency&quot;</span>

            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
                <span class="s1">message</span><span class="s2">=</span><span class="s1">message</span><span class="s2">,</span>
                <span class="s1">category</span><span class="s2">=</span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">category</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">record</span><span class="s2">) == </span><span class="s4">0 </span><span class="s0">if </span><span class="s1">warnings_as_errors </span><span class="s0">else </span><span class="s4">1</span>
            <span class="s0">if </span><span class="s1">record</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">record</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">) == </span><span class="s1">message</span>
                <span class="s0">assert </span><span class="s1">record</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">category </span><span class="s2">== </span><span class="s1">warning_info</span><span class="s2">.</span><span class="s1">category</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;warning_info&quot;</span><span class="s2">, </span><span class="s1">_get_warnings_filters_info_list</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_sklearn_warnings_as_errors</span><span class="s2">(</span><span class="s1">warning_info</span><span class="s2">):</span>
    <span class="s1">warnings_as_errors </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">&quot;SKLEARN_WARNINGS_AS_ERRORS&quot;</span><span class="s2">, </span><span class="s5">&quot;0&quot;</span><span class="s2">) != </span><span class="s5">&quot;0&quot;</span>
    <span class="s1">check_warnings_as_errors</span><span class="s2">(</span><span class="s1">warning_info</span><span class="s2">, </span><span class="s1">warnings_as_errors</span><span class="s2">=</span><span class="s1">warnings_as_errors</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;warning_info&quot;</span><span class="s2">, </span><span class="s1">_get_warnings_filters_info_list</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_turn_warnings_into_errors</span><span class="s2">(</span><span class="s1">warning_info</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">turn_warnings_into_errors</span><span class="s2">()</span>
        <span class="s1">check_warnings_as_errors</span><span class="s2">(</span><span class="s1">warning_info</span><span class="s2">, </span><span class="s1">warnings_as_errors</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
</pre>
</body>
</html>